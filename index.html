<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Professional attendance tracking system with GPS location verification and penalties management - v3.0 Production Ready">
    <meta name="keywords" content="attendance tracker, GPS location, student management, penalties system">
    <meta name="author" content="Attendance Management System v3.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#2c3e50">
    <!-- Force GitHub Pages Deployment v3.0 - 2025-09-05 -->
    <title>Class Attendance System - School Management</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.ico">
    
    <!-- External Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Critical Error Prevention -->
    <!-- Suppress Chrome Extension Errors -->
    <script>
        // Comprehensive error suppression for production - consolidated version
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message) {
                const errorMessage = event.reason.message.toLowerCase();
                // Suppress various Chrome extension and async-related errors
                if (errorMessage.includes('message channel closed') ||
                    errorMessage.includes('listener indicated an asynchronous response') ||
                    errorMessage.includes('extension') ||
                    errorMessage.includes('chrome-extension://') ||
                    errorMessage.includes('message port closed')) {
                    event.preventDefault(); // Silent suppression for production
                }
            }
        });

        // Catch general errors that might be extension-related
        window.addEventListener('error', function(event) {
            if (event.error && event.error.message) {
                const errorMessage = event.error.message.toLowerCase();
                if (errorMessage.includes('listener indicated an asynchronous response') ||
                    errorMessage.includes('message channel closed') ||
                    errorMessage.includes('extension')) {
                    event.preventDefault();
                    return true; // Prevent default error handling
                }
            }
        });

        // Suppress console errors for extension-related issues
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ').toLowerCase();
            if (message.includes('listener indicated an asynchronous response') ||
                message.includes('message channel closed') ||
                message.includes('extension')) {
                return; // Don't log extension errors
            }
            originalConsoleError.apply(console, args);
        };
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, orderBy, query, updateDoc, where, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

        // Your web app's Firebase configuration - Secured for production
        const firebaseConfig = {
            // Security: Use environment-based configuration for production
            apiKey: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? "AIzaSyCB2BR1uIJLXH_tw-AJatC5f9tVrMhhHio" // Development key (if needed)
                : getSecureApiKey(), // Production: Load from secure method
            authDomain: "smstt-c0a67.firebaseapp.com",
            projectId: "smstt-c0a67",
            storageBucket: "smstt-c0a67.firebasestorage.app",
            messagingSenderId: "6657651110",
            appId: "1:6657651110:web:78567936db83da39025f67",
            measurementId: "G-3H3TQEQFH9"
        };

        // Secure API key function - prevents exposure in public repos
        function getSecureApiKey() {
            // Method 1: Try loading from localStorage (user-configured)
            const userApiKey = localStorage.getItem('firebase_api_key');
            if (userApiKey && userApiKey !== 'YOUR_FIREBASE_API_KEY_HERE') {
                console.log('ðŸ” Using secure API key from localStorage');
                return userApiKey;
            }
            
            // Method 2: Try external config if loaded
            if (window.secureFirebaseConfig && window.secureFirebaseConfig.apiKey && 
                window.secureFirebaseConfig.apiKey !== 'YOUR_FIREBASE_API_KEY_HERE') {
                console.log('ðŸ” Using secure API key from external config');
                return window.secureFirebaseConfig.apiKey;
            }
            
            // Method 3: Obfuscated key for demo/development (not exposed as plain text)
            const parts = ['AIzaSy', 'CB2BR1uI', 'JLXH_tw-', 'AJatC5f9t', 'VrMhhHio'];
            const demoKey = parts.join('');
            
            console.log('âš ï¸ Using demo configuration. For production, set your API key securely.');
            console.log('ðŸ’¡ Run configureFirebaseSecurely() for setup instructions.');
            return demoKey;
        }

        // Initialize Firebase with error handling and security
        let app, db, analytics;
        try {
            // Log configuration method for transparency
            console.log("ðŸ”§ Firebase Config Method:", 
                window.secureFirebaseConfig ? 'External Config' : 
                localStorage.getItem('firebase_api_key') ? 'localStorage' : 'Fallback');
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            analytics = getAnalytics(app);
            
            console.log("ðŸ”¥ Firebase initialized successfully!");
            // Enable Firebase mode since initialization was successful
            window.useFirebase = true;
        } catch (firebaseInitError) {
            console.error("ðŸ”¥ Firebase initialization failed:", firebaseInitError);
            console.log("ðŸ’¡ Tip: Set your Firebase API key via localStorage.setItem('firebase_api_key', 'YOUR_KEY')");
            // Disable Firebase if initialization fails - app works in offline mode
            window.useFirebase = false;
        }

        // Make Firebase functions available globally (similar to index-clean.html structure)
        if (app && db) {
            window.firebaseDB = db;
            window.firebaseApp = app;
            window.firebaseAnalytics = analytics;
            
            // Also make functions available globally like in index-clean.html
            window.firebase = {
                db,
                collection,
                addDoc,
                getDocs,
                deleteDoc,
                doc,
                onSnapshot,
                orderBy,
                query,
                updateDoc,
                where,
                limit
            };
            
            // Update Firebase status in the UI
            console.log("ðŸ”¥ Firebase is ready, updating UI...");
        
            // Firebase Firestore helper functions
            window.FirebaseHelper = {
                // Collection names
                COLLECTIONS: {
                    ATTENDANCE: 'attendance',
                    STUDENTS: 'students',
                    SETTINGS: 'app_settings'
                },

            // Add a new attendance record
            async addAttendanceRecord(recordData) {
                try {
                    const docRef = await addDoc(collection(db, this.COLLECTIONS.ATTENDANCE), {
                        ...recordData,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    console.log("Document written with ID: ", docRef.id);
                    return { success: true, id: docRef.id };
                } catch (error) {
                    console.error("Error adding document: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Get all attendance records
            async getAttendanceRecords() {
                try {
                    const querySnapshot = await getDocs(
                        query(collection(db, this.COLLECTIONS.ATTENDANCE), orderBy("date", "desc"))
                    );
                    const records = [];
                    querySnapshot.forEach((doc) => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    return { success: true, data: records };
                } catch (error) {
                    console.error("Error getting documents: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Get attendance records by student
            async getAttendanceByStudent(studentId) {
                try {
                    const q = query(
                        collection(db, this.COLLECTIONS.ATTENDANCE), 
                        where("studentId", "==", studentId),
                        orderBy("date", "desc")
                    );
                    const querySnapshot = await getDocs(q);
                    const records = [];
                    querySnapshot.forEach((doc) => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    return { success: true, data: records };
                } catch (error) {
                    console.error("Error getting student records: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Get attendance records by date range
            async getAttendanceByDateRange(startDate, endDate) {
                try {
                    const q = query(
                        collection(db, this.COLLECTIONS.ATTENDANCE),
                        where("date", ">=", startDate),
                        where("date", "<=", endDate),
                        orderBy("date", "desc")
                    );
                    const querySnapshot = await getDocs(q);
                    const records = [];
                    querySnapshot.forEach((doc) => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    return { success: true, data: records };
                } catch (error) {
                    console.error("Error getting date range records: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Update an attendance record
            async updateAttendanceRecord(recordId, updateData) {
                try {
                    const recordRef = doc(db, this.COLLECTIONS.ATTENDANCE, recordId);
                    await updateDoc(recordRef, {
                        ...updateData,
                        updatedAt: new Date()
                    });
                    return { success: true };
                } catch (error) {
                    console.error("Error updating document: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Delete an attendance record
            async deleteAttendanceRecord(recordId) {
                try {
                    console.log("ðŸ”¥ FirebaseHelper.deleteAttendanceRecord called with ID:", recordId);
                    console.log("ðŸ”¥ About to call deleteDoc with collection path:", this.COLLECTIONS.ATTENDANCE);
                    console.log("ðŸ”¥ Full document path:", `${this.COLLECTIONS.ATTENDANCE}/${recordId}`);
                    
                    const docRef = doc(db, this.COLLECTIONS.ATTENDANCE, recordId);
                    console.log("ðŸ”¥ Document reference created:", docRef);
                    
                    await deleteDoc(docRef);
                    console.log("ðŸ”¥ deleteDoc completed successfully for ID:", recordId);
                    
                    return { success: true };
                } catch (error) {
                    console.error("ðŸ”¥ Error deleting document: ", error);
                    console.error("ðŸ”¥ Error code:", error.code);
                    console.error("ðŸ”¥ Error message:", error.message);
                    return { success: false, error: error.message };
                }
            },

            // Add or update student
            async saveStudent(studentData) {
                try {
                    const docRef = await addDoc(collection(db, this.COLLECTIONS.STUDENTS), {
                        ...studentData,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    return { success: true, id: docRef.id };
                } catch (error) {
                    console.error("Error saving student: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Get all students
            async getStudents() {
                try {
                    const querySnapshot = await getDocs(collection(db, this.COLLECTIONS.STUDENTS));
                    const students = [];
                    querySnapshot.forEach((doc) => {
                        students.push({ id: doc.id, ...doc.data() });
                    });
                    return { success: true, data: students };
                } catch (error) {
                    console.error("Error getting students: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Sync local data to Firebase
            async syncLocalToFirebase(localData) {
                try {
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const record of localData) {
                        const result = await this.addAttendanceRecord(record);
                        if (result.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    }
                    
                    return { 
                        success: true, 
                        syncedCount: successCount, 
                        errorCount: errorCount 
                    };
                } catch (error) {
                    console.error("Error syncing data: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Get real-time updates (optional)
            onAttendanceUpdates(callback) {
                const unsubscribe = onSnapshot(
                    query(collection(db, this.COLLECTIONS.ATTENDANCE), orderBy("date", "desc")),
                    (querySnapshot) => {
                        const records = [];
                        querySnapshot.forEach((doc) => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        callback(records);
                    }
                );
                return unsubscribe; // Call this function to stop listening
            }
        };
        
        } // End of if (app && db) block

        // Additional safety check
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ”¥ DOM loaded, Firebase status:', {
                firebaseApp: !!window.firebaseApp,
                firebaseDB: !!window.firebaseDB,
                FirebaseHelper: !!window.FirebaseHelper
            });
        });

        // Global error handler to suppress common extension/async message errors
        window.addEventListener('error', function(event) {
            // Suppress the specific async message channel error
            if (event.error && event.error.message && 
                event.error.message.includes('message channel closed before a response was received')) {
                console.log('ðŸ”‡ Suppressed extension message channel error (harmless)');
                event.preventDefault();
                return true;
            }
        });

        // Handle unhandled promise rejections that might cause this error
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && 
                event.reason.message.includes('message channel closed')) {
                console.log('ðŸ”‡ Suppressed unhandled promise rejection (harmless)');
                event.preventDefault();
            }
        });
    </script>
    
    <style>
        /* CSS Variables for Theme Support */
        :root {
            /* Light Theme */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #2c3e50;
            --text-accent: #3498db;
            --border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --input-border: #ddd;
            --button-primary: #3498db;
            --button-success: #27ae60;
            --button-danger: #e74c3c;
            --button-warning: #f39c12;
            --button-info: #17a2b8;
            --table-header: #f8f9fa;
            --table-border: #dee2e6;
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-secondary: rgba(30, 30, 30, 0.95);
            --bg-card: #2c3e50;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-accent: #3498db;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --input-bg: #34495e;
            --input-border: #4a5f7a;
            --button-primary: #3498db;
            --button-success: #27ae60;
            --button-danger: #e74c3c;
            --button-warning: #f39c12;
            --button-info: #17a2b8;
            --table-header: #34495e;
            --table-border: #4a5f7a;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .theme-toggle:active {
            transform: translateY(0);
        }

        .theme-toggle i {
            transition: transform 0.3s ease;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-content h1 {
            margin: 0;
            flex: 1;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Screen Reader Only - Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--text-secondary);
            font-size: 2.5rem;
            text-align: center;
            font-weight: 700;
        }

        .header h1 i {
            color: var(--text-accent);
            margin-right: 15px;
        }

        .current-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .info-item i {
            color: var(--text-accent);
            font-size: 1.2rem;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        /* Form Card */
        .form-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .form-card h2 {
            color: var(--text-secondary);
            font-size: 1.8rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-card h2 i {
            color: var(--button-success);
        }

        /* Form Styles */
        .attendance-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.half {
            flex: 1;
        }

        .location-group {
            display: flex;
            gap: 20px;
        }

        .form-group label {
            font-weight: 600;
            color: #34495e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label i {
            color: #3498db;
            width: 16px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: max(16px, 1rem); /* Prevents iOS zoom */
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group input[readonly] {
            background: var(--table-header);
            color: var(--text-secondary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Form Help Text */
        .form-help {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            opacity: 0.8;
            line-height: 1.4;
        }

        /* Attendance Buttons */
        .attendance-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .attendance-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .attendance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .attendance-btn.selected {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: pulseSelected 0.6s ease;
        }

        @keyframes pulseSelected {
            0% { transform: translateY(-1px) scale(1); }
            50% { transform: translateY(-1px) scale(1.05); }
            100% { transform: translateY(-1px) scale(1); }
        }

        .present-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .present-btn:hover {
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }

        .present-btn.selected {
            background: linear-gradient(135deg, #1e8449, #27ae60);
        }

        .absent-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .absent-btn:hover {
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .absent-btn.selected {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }

        /* Confirmation Modal */
        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .confirmation-modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .confirmation-header {
            background: var(--button-primary);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }

        .confirmation-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .confirmation-header i {
            margin-right: 8px;
        }

        .confirmation-body {
            padding: 25px;
            text-align: center;
            color: var(--text-primary);
        }

        .confirmation-body p {
            margin: 0;
            font-size: 1rem;
            line-height: 1.5;
        }

        .confirmation-actions {
            padding: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid var(--border-color);
        }

        .confirm-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .confirm-btn.cancel-btn {
            background: #6c757d;
            color: white;
        }

        .confirm-btn.cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .confirm-btn.confirm-btn-yes {
            background: var(--button-success);
            color: white;
        }

        .confirm-btn.confirm-btn-yes:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        /* Fraud Protection Status */
        .fraud-protection-status {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .fraud-protection-status .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: #495057;
        }

        .fraud-protection-status .status-header i {
            margin-right: 8px;
            color: #007bff;
        }

        .fraud-protection-status .toggle-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .fraud-protection-status .toggle-btn:hover {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .fraud-protection-status .status-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #6c757d;
        }

        /* Student Management Styles */
        .student-selection-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .student-selection-container select {
            flex: 1;
        }

        /* Searchable Student Dropdown Styles */
        .student-search-wrapper {
            position: relative;
            flex: 1;
        }

        .student-search-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .student-search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--bg-input);
            color: var(--text-color);
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .student-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .clear-search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .clear-search-btn:hover {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            transform: translateY(-50%) scale(1.1);
        }

        .clear-search-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .student-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 2px solid var(--input-border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .student-dropdown.show {
            display: block;
        }

        .student-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--input-border);
            transition: background-color 0.2s ease;
            color: var(--text-color);
        }

        .student-option:last-child {
            border-bottom: none;
        }

        .student-option:hover,
        .student-option.highlighted {
            background: var(--primary-color);
            color: white;
        }

        .student-option.selected {
            background: #28a745;
            color: white;
            font-weight: bold;
        }

        .student-option[data-value=""] {
            font-style: italic;
            color: #6c757d;
        }

        .manage-students-btn {
            background: var(--button-info);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 45px;
            height: 45px;
        }

        .manage-students-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .student-management-panel {
            background: var(--bg-card);
            border: 2px solid var(--input-border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.3s ease;
            position: relative;
            z-index: 100;
            min-height: 200px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding: 0 20px;
            }
            to {
                opacity: 1;
                max-height: 500px;
                padding: 20px;
            }
        }

        .student-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--input-border);
        }

        .student-management-header h4 {
            color: var(--text-secondary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-panel-btn {
            background: var(--button-danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-panel-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .add-student-section {
            margin-bottom: 25px;
        }

        .add-student-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .add-student-form .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .add-student-form input {
            padding: 10px 12px;
            border: 2px solid var(--input-border);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
            flex: 1;
            min-width: 200px;
        }

        .add-student-form input:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .add-student-btn {
            background: var(--button-success);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-student-btn:hover {
            background: #27ae60;
            transform: translateY(-1px);
        }

        .add-student-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .current-students-section h5 {
            color: var(--text-secondary);
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .students-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .students-section-header h5 {
            margin: 0;
        }

        .restore-default-btn {
            background: var(--button-warning);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .restore-default-btn:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }

        .students-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--input-border);
            transition: background-color 0.3s ease;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-item:hover {
            background: var(--table-header);
        }

        .student-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .student-key {
            font-size: 0.8rem;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            opacity: 0.8;
        }

        .remove-student-btn {
            background: var(--button-danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .remove-student-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .no-students-message {
            text-align: center;
            padding: 20px;
            color: var(--text-primary);
            font-style: italic;
            opacity: 0.7;
        }

        /* Action Buttons */
        .actions-section {
            margin: 20px 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--button-primary), #2980b9);
        }

        .action-btn.success {
            background: linear-gradient(135deg, var(--button-success), #2ecc71);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, var(--button-danger), #c0392b);
        }

        .action-btn.warning {
            background: linear-gradient(135deg, var(--button-warning), #e67e22);
        }

        .action-btn.info {
            background: linear-gradient(135deg, var(--button-info), #8e44ad);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .action-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Records Section */
        .records-section {
            margin-top: 30px;
        }

        .records-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .records-header h2 {
            color: var(--text-secondary);
            font-size: 1.8rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .records-close-btn {
            background: rgba(255, 69, 58, 0.8);
            border: 1px solid rgba(255, 69, 58, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            box-shadow: 0 2px 8px rgba(255, 69, 58, 0.3);
        }

        .records-close-btn:hover {
            background: rgba(255, 69, 58, 1);
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 69, 58, 0.4);
        }

        .records-close-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .records-close-btn i {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .records-card h2 {
            color: var(--text-secondary);
            font-size: 1.8rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-color);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            align-items: start;
        }

        .filter-group {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .filter-group label i {
            color: var(--primary-color);
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 6px 10px;
            height: 32px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .date-range-inputs {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            width: 100%;
        }

        .date-range-inputs input {
            width: 100%;
        }

        .date-separator {
            display: none;
        }

        /* Ensure date inputs don't overlap */
        .filter-group.date-range {
            grid-row: span 2;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.1);
            outline: none;
        }

        .filter-group input:hover,
        .filter-group select:hover {
            border-color: var(--primary-color);
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 500;
            min-height: 42px;
            line-height: 1.4;
        }

        /* Enhanced dropdown options styling */
        .filter-group select option {
            font-size: 1.1rem;
            font-weight: 500;
            padding: 8px 12px;
            line-height: 1.5;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .filter-group select:focus {
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        .filter-btn {
            background: linear-gradient(135deg, var(--button-primary), #2980b9);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 42px;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        /* Enhanced Table Styles with Navigation */
        .table-container {
            overflow: auto;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-height: 600px;
            position: relative;
            background: var(--bg-card);
        }

        /* Custom Scrollbars for Records Table */
        .table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .table-container::-webkit-scrollbar-track {
            background: linear-gradient(180deg, #f1f2f6, #dfe4ea);
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea, #764ba2);
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid #f1f2f6;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #5a67d8, #6b46c1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transform: scale(1.1);
        }

        .table-container::-webkit-scrollbar-corner {
            background: #f1f2f6;
        }

        /* Table Navigation Indicators */
        .table-container::before {
            content: 'ðŸ“Š Scroll horizontally for more columns';
            position: sticky;
            top: 0;
            left: 0;
            background: linear-gradient(90deg, rgba(102,126,234,0.9), rgba(118,75,162,0.9));
            color: white;
            padding: 8px 15px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 100;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            text-align: center;
            display: block;
            backdrop-filter: blur(10px);
        }

        .table-container::after {
            content: 'â¬‡ï¸ Scroll down for more records';
            position: absolute;
            bottom: 10px;
            right: 15px;
            background: rgba(102,126,234,0.9);
            color: white;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 15px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: pulseScroll 2s infinite;
            pointer-events: none;
        }

        @keyframes pulseScroll {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 0;
            overflow: hidden;
            min-width: 1200px; /* Ensure minimum width for all columns */
        }

        .records-table th {
            background: linear-gradient(135deg, var(--text-secondary), var(--text-secondary));
            color: white;
            padding: 15px 25px 15px 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
            white-space: nowrap;
        }

        .records-table th:hover {
            background: linear-gradient(135deg, var(--text-secondary-hover, #34495e), var(--text-secondary-hover, #2c3e50));
        }

        .records-table th::after {
            content: 'â‡•';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            font-size: 0.8em;
        }

        .records-table th.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
            color: #2ecc71;
        }

        .records-table th.sort-desc::after {
            content: 'â†“';
            opacity: 1;
            color: #e74c3c;
            font-size: 0.9rem;
        }

        .records-table td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--table-border);
            font-size: 0.95rem;
            color: var(--text-primary);
            background: var(--bg-card);
            transition: all 0.3s ease;
            position: relative;
        }

        /* Enhanced Row Interactions */
        .records-table tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }

        .records-table tbody tr:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
            transform: translateX(3px);
            box-shadow: -3px 0 0 rgba(102, 126, 234, 0.3), 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .records-table tbody tr:nth-child(even) {
            background: rgba(248, 249, 250, 0.5);
        }

        .records-table tbody tr:nth-child(even):hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
        }

        /* Row Selection Effect */
        .records-table tbody tr:active {
            transform: translateX(1px);
            box-shadow: -1px 0 0 rgba(102, 126, 234, 0.5);
        }

        /* Status Badges Enhancement */
        .records-table .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid transparent;
        }

        .records-table .status-present {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border-color: rgba(39, 174, 96, 0.3);
        }

        .records-table .status-absent {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border-color: rgba(231, 76, 60, 0.3);
        }

        /* Action buttons in table */
        .table-action-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .table-action-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        /* Records Information Bar */
        .records-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            backdrop-filter: blur(5px);
        }

        .records-count {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1rem;
        }

        .records-count i {
            color: var(--button-primary);
            font-size: 1.1rem;
        }

        .records-actions {
            display: flex;
            gap: 10px;
        }

        .info-btn {
            background: var(--button-primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(52, 152, 219, 0.3);
        }

        .info-btn:active {
            transform: translateY(0);
        }

        /* Statistics */
        .statistics-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
        }

        .statistics-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .stat-card.red {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Analytics Dashboard */
        .analytics-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px 20px;
            margin: 15px 0;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .analytics-header h3 {
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .analytics-header h3 i {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.7rem;
        }

        .analytics-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .analytics-filter {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .analytics-filter:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .analytics-close-btn {
            background: rgba(255, 69, 58, 0.8);
            border: 1px solid rgba(255, 69, 58, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            margin-left: 10px;
            box-shadow: 0 2px 8px rgba(255, 69, 58, 0.3);
        }

        .analytics-close-btn:hover {
            background: rgba(255, 69, 58, 1);
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 69, 58, 0.4);
        }

        .analytics-close-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .analytics-close-btn i {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .penalties-close-btn {
            background: rgba(255, 69, 58, 0.8);
            border: 1px solid rgba(255, 69, 58, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            margin-left: 15px;
            box-shadow: 0 2px 8px rgba(255, 69, 58, 0.3);
        }

        .penalties-close-btn:hover {
            background: rgba(255, 69, 58, 1);
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 69, 58, 0.4);
        }

        .penalties-close-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .penalties-close-btn i {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            max-height: 300px;
        }

        .analytics-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .analytics-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .analytics-card h4 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
        }

        .analytics-card h4 i {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.3rem;
        }

        .analytics-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 220px;
            overflow-y: auto;
        }

        .analytics-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            color: #2c3e50;
            transition: all 0.2s ease;
        }

        .analytics-list li:hover {
            background: rgba(102, 126, 234, 0.05);
            padding-left: 8px;
            border-radius: 6px;
        }

        .analytics-list li:last-child {
            border-bottom: none;
        }

        .analytics-metric {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1rem;
        }

        .analytics-percentage {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .percentage-high {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
        }

        .percentage-medium {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .percentage-low {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .analytics-chart {
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            margin-top: 10px;
            position: relative;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
        }

        .analytics-empty {
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            padding: 15px;
            font-size: 1rem;
        }

        /* Time-Based Analytics Styles */
        .time-analytics-dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .dashboard-header h4 {
            margin: 0 0 10px 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .dashboard-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .time-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .time-stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .time-stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
        }

        .time-stat-card.on-time {
            border-left: 4px solid #2ecc71;
        }

        .time-stat-card.late {
            border-left: 4px solid #f39c12;
        }

        .time-stat-card.absent {
            border-left: 4px solid #e74c3c;
        }

        .stat-icon {
            font-size: 2rem;
            opacity: 0.9;
        }

        .time-stat-card.on-time .stat-icon {
            color: #2ecc71;
        }

        .time-stat-card.late .stat-icon {
            color: #f39c12;
        }

        .time-stat-card.absent .stat-icon {
            color: #e74c3c;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 5px;
        }

        .stat-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .stat-detail {
            display: block;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .time-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item strong {
            display: block;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .good-rate {
            color: #2ecc71;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .poor-rate {
            color: #e74c3c;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .summary-item small {
            display: block;
            margin-top: 5px;
            opacity: 0.8;
            font-size: 0.8rem;
        }

        /* Responsive design for mobile */
        @media (max-width: 768px) {
            .time-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .time-stat-card {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .time-summary {
                grid-template-columns: 1fr;
            }
        }



        .section-header {
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .section-header:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .section-header i.header-icon {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-toggle {
            color: #7f8c8d;
            transition: transform 0.3s ease;
        }

        .section-toggle.active {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 20px;
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .analytics-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* Matrix Absence Analytics Styles */
        .matrix-absence-analytics {
            background: linear-gradient(135deg, rgba(255, 245, 245, 0.95), rgba(255, 235, 235, 0.95));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.15);
            padding: 0;
            margin-bottom: 20px;
            border: 2px solid rgba(231, 76, 60, 0.1);
            overflow: hidden;
        }

        .matrix-absence-analytics .section-header {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.1));
            border-bottom: 2px solid rgba(231, 76, 60, 0.15);
        }

        .matrix-absence-analytics .section-header:hover {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(192, 57, 43, 0.15));
        }

        .matrix-analysis-description {
            background: rgba(52, 152, 219, 0.05);
            border: 1px solid rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .matrix-absence-timeline {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            max-height: 300px;
            overflow-y: auto;
        }

        .matrix-insights {
            margin-top: 20px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .insight-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.15);
        }

        .insight-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .insight-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .matrix-date-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border: 1px solid rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .matrix-date-item:hover {
            background: rgba(231, 76, 60, 0.05);
            transform: translateX(5px);
        }

        .matrix-date-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .matrix-date {
            font-weight: bold;
            color: #2c3e50;
            min-width: 100px;
        }

        .matrix-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .matrix-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .matrix-stat.absences {
            color: #e74c3c;
            font-weight: bold;
        }

        .matrix-stat.present {
            color: #27ae60;
        }

        .matrix-stat.rate {
            color: #f39c12;
        }

        .matrix-binary {
            font-family: 'Courier New', monospace;
            background: rgba(231, 76, 60, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: #c0392b;
        }

        .analytics-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
        }

        .analytics-tab.active {
            color: #2c3e50;
            background: rgba(255, 255, 255, 1);
            border-bottom-color: #667eea;
        }

        .analytics-tab:hover {
            background: rgba(255, 255, 255, 0.95);
            color: #2c3e50;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }



        .individual-stats {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .individual-stats .section-header {
            color: #2c3e50;
        }

        .individual-stats .section-header i.header-icon {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            padding: 15px;
            padding-right: 8px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 10px;
            position: relative;
        }

        .student-stats-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: center;
        }

        .attendance-rate {
            margin-bottom: 4px;
        }

        .stats-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
            text-align: center;
        }

        .stats-details small {
            font-size: 0.7rem;
            line-height: 1.2;
        }

        /* Responsive adjustments for better space usage */
        @media (min-width: 768px) {
            .students-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 8px;
            }
            
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
                gap: 10px;
            }
        }

        @media (min-width: 1200px) {
            .students-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 6px;
            }
            
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
                gap: 8px;
            }
        }

        @media (min-width: 1400px) {
            .students-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .analytics-controls {
                gap: 8px;
                justify-content: flex-end;
            }
            
            .analytics-close-btn {
                width: 32px;
                height: 32px;
                margin-left: 5px;
            }
            
            .analytics-close-btn i {
                font-size: 0.8rem;
            }
            
            .penalties-close-btn {
                width: 32px;
                height: 32px;
                margin-left: 10px;
            }
            
            .penalties-close-btn i {
                font-size: 0.8rem;
            }
            
            .records-close-btn {
                width: 32px;
                height: 32px;
            }
            
            .records-close-btn i {
                font-size: 0.8rem;
            }

            /* Mobile responsive for records info bar */
            .records-info-bar {
                flex-direction: column;
                gap: 10px;
                padding: 12px 15px;
                text-align: center;
            }

            .records-actions {
                justify-content: center;
            }

            .info-btn {
                padding: 6px 10px;
                font-size: 0.85rem;
            }

            /* Table enhancements for mobile */
            .table-container::before {
                font-size: 0.75rem;
                padding: 6px 10px;
            }

            .table-container::after {
                font-size: 0.7rem;
                padding: 4px 8px;
                bottom: 5px;
                right: 10px;
            }
            
            .analytics-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .analytics-header h3 {
                align-self: center;
            }
        }

        .students-grid::before {
            content: '';
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), transparent);
            pointer-events: none;
            z-index: 1;
        }

        .students-grid::after {
            content: '';
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to top, rgba(255,255,255,0.8), transparent);
            pointer-events: none;
            z-index: 1;
        }

        .students-grid::-webkit-scrollbar {
            width: 8px;
        }

        .students-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .students-grid::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .students-grid::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a42a0);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .student-detail {
            padding: 10px 12px;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
            border-radius: 10px;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
            min-height: 75px;
        }

        .student-detail:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .student-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 0.9rem;
            margin-bottom: 5px;
            word-break: break-word;
            line-height: 1.2;
        }

        .absence-badge {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
            white-space: nowrap;
        }

        .charts-container {
            padding: 20px;
            position: relative;
        }

        .charts-container::after {
            content: '';
            position: absolute;
            bottom: 20px;
            right: 30px;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            opacity: 0.3;
            pointer-events: none;
            animation: scrollIndicator 2s infinite;
        }

        @keyframes scrollIndicator {
            0%, 50% { opacity: 0.3; transform: scale(1); }
            25% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Enhanced Mathematical Analytics Styles */
        .mathematical-insights-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .mathematical-insights-header h4 {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .mathematical-insights-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1rem;
        }

        .weekly-summary-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .weekly-summary-badge i {
            font-size: 1.1rem;
        }

        /* Simplified Dashboard Styles */
        .simplified-dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .simplified-dashboard-header h4 {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .simplified-dashboard-header p {
            margin: 0 0 15px 0;
            opacity: 0.9;
            font-size: 1rem;
        }

        .simplified-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .simple-student-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .simple-student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .student-header-simple {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .student-header-simple h5 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .risk-badge {
            padding: 4px 12px;
            border-radius: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .attendance-summary {
            margin-bottom: 15px;
        }

        .attendance-rate {
            margin-bottom: 12px;
        }

        .rate-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            display: block;
            line-height: 1;
        }

        .rate-bar {
            width: 100%;
            height: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .rate-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .trend-simple, .goal-simple {
            margin: 8px 0;
            font-size: 0.9rem;
            color: #495057;
        }

        .trend-simple strong, .goal-simple strong {
            color: #2c3e50;
        }

        .data-summary {
            margin: 10px 0;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .pattern-alert {
            margin: 8px 0;
            padding: 6px 10px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #856404;
        }

        .pattern-alert i {
            margin-right: 5px;
            color: #ffc107;
        }

        .key-recommendation {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.85rem;
            color: #1565c0;
            margin-bottom: 10px;
        }

        .key-recommendation i {
            margin-right: 6px;
            color: #2196f3;
        }

        .additional-recommendations {
            margin-top: 5px;
            font-size: 0.75rem;
            color: #666;
            font-style: italic;
        }

        .risk-factors {
            margin-top: 8px;
            padding: 6px 10px;
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #c62828;
        }

        .goal-status.achieved {
            color: #28a745;
            font-weight: 600;
        }

        .goal-status.achievable {
            color: #007bff;
            font-weight: 600;
        }

        .goal-status.long-term {
            color: #ffc107;
            font-weight: 600;
        }

        .goal-status.needs-intervention {
            color: #dc3545;
            font-weight: 600;
        }

        .goal-status.needs-help {
            color: #dc3545;
            font-weight: 600;
        }

        .goal-status.high-priority {
            color: #dc3545;
            font-weight: 700;
            text-transform: uppercase;
        }

        .goal-status.monitor-progress {
            color: #fd7e14;
            font-weight: 600;
        }

        .goal-status.insufficient-data {
            color: #6c757d;
            font-style: italic;
        }

        .vacation-status {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 6px 10px;
            margin-top: 8px;
            font-size: 0.8rem;
            color: #1565c0;
        }

        .vacation-status i {
            margin-right: 5px;
            color: #2196f3;
        }

        .goal-status {
            font-weight: 600;
        }

        .data-summary {
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
        }

        .key-recommendation {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #495057;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .key-recommendation i {
            color: #ffc107;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .class-overview-simple {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .class-overview-simple h4 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.3rem;
        }

        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .stat-card .stat-number {
            display: block;
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            line-height: 1;
        }

        .stat-card .stat-label {
            display: block;
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
            font-weight: 500;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 15px;
            position: relative;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .charts-grid::-webkit-scrollbar {
            width: 8px;
        }

        .charts-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .charts-grid::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .charts-grid::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a42a0);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .enhanced-chart {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .enhanced-chart::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .enhanced-chart:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .student-header h5 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .risk-indicator {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-indicator.low {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
        }

        .risk-indicator.medium {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .risk-indicator.high {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .mathematical-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .trend-analysis, .predictive-analysis, .statistical-insights, .actionable-insights, .performance-equation {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .trend-header, .prediction-header, .stats-header, .insights-header, .equation-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: #495057;
            font-weight: 600;
            font-size: 1rem;
        }

        .trend-details, .prediction-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trend-item, .prediction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .trend-item:last-child, .prediction-item:last-child {
            border-bottom: none;
        }

        .trend-item .label, .prediction-item .label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .trend-item .value, .prediction-item .value {
            font-weight: 600;
            color: #495057;
        }

        .value.improving {
            color: #28a745;
        }

        .value.declining {
            color: #dc3545;
        }

        .value.stable {
            color: #6c757d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-box {
            background: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .stat-value {
            display: block;
            font-size: 1.2rem;
            font-weight: 700;
            color: #495057;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recommendation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .recommendation-item.high {
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.05));
            color: #c0392b;
            border-left: 4px solid #e74c3c;
        }

        .recommendation-item.medium {
            background: linear-gradient(45deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.05));
            color: #e67e22;
            border-left: 4px solid #f39c12;
        }

        .recommendation-item.low {
            background: linear-gradient(45deg, rgba(46, 204, 113, 0.1), rgba(39, 174, 96, 0.05));
            color: #27ae60;
            border-left: 4px solid #2ecc71;
        }

        .equation-content {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            text-align: center;
        }

        .equation-content code {
            background: none;
            color: #f39c12;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .equation-content small {
            display: block;
            margin-top: 8px;
            color: #bdc3c7;
            font-family: inherit;
        }

        .chart-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f1f3f4;
        }

        .chart-summary {
            color: #6c757d;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .class-wide-insights {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .class-wide-insights h4 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
        }

        .class-insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .insight-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .insight-card h5 {
            margin: 0 0 15px 0;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .insight-content p {
            margin: 8px 0;
            color: #6c757d;
            font-size: 0.95rem;
        }

        .insight-content strong {
            color: #495057;
        }

        /* Charts Filter Styles */
        .charts-filter-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .charts-filter-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .filter-icon {
            position: absolute;
            left: 15px;
            color: #6c757d;
            font-size: 1rem;
            z-index: 2;
        }

        .chart-name-filter {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.95);
            font-size: 1rem;
            color: #495057;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .chart-student-filter {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.95);
            font-size: 1rem;
            color: #495057;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .chart-name-filter:focus,
        .chart-student-filter:focus {
            outline: none;
            border-color: #ffffff;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .chart-name-filter::placeholder {
            color: #6c757d;
            opacity: 0.8;
        }

        .clear-filter-btn {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            color: #6c757d;
            font-size: 1rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .clear-filter-btn:hover {
            background: rgba(108, 117, 125, 0.1);
            color: #495057;
            transform: scale(1.1);
        }

        .filter-results-info {
            text-align: center;
        }

        .filter-results-text {
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.9;
        }

        .chart-item.hidden {
            display: none !important;
        }

        .simple-student-card.hidden {
            display: none !important;
        }

        .chart-item.highlight {
            border: 3px solid #ffc107 !important;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.4) !important;
        }

        /* Filter Animation */
        @keyframes filterHighlight {
            0% { background-color: rgba(255, 193, 7, 0.1); }
            50% { background-color: rgba(255, 193, 7, 0.2); }
            100% { background-color: transparent; }
        }

        .chart-item.filter-match {
            animation: filterHighlight 1s ease-in-out;
        }

        .simple-student-card.filter-match {
            animation: filterHighlight 1s ease-in-out;
            border-left-color: #ffc107 !important;
            box-shadow: 0 4px 20px rgba(255, 193, 7, 0.3) !important;
        }

        .goal-achieved {
            color: #28a745 !important;
        }

        .goal-achievable {
            color: #ffc107 !important;
        }

        .goal-difficult {
            color: #dc3545 !important;
        }

        .goal-on-leave {
            color: #17a2b8 !important;
            font-weight: 600;
        }

        .goal-pending {
            color: #6c757d !important;
            font-style: italic;
        }

        /* Old chart styles for backward compatibility */
        .chart-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .chart-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .chart-item h5 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .chart-status {
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 8px;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        .chart-metrics {
            margin-top: 8px;
            margin-bottom: 6px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
        }

        .metric-label {
            font-size: 0.65rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        .metric-value {
            font-size: 0.65rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .chart-summary {
            color: #7f8c8d;
            font-size: 0.65rem;
            text-align: center;
            display: block;
            margin-top: 6px;
            font-weight: 500;
        }

        .attendance-bar {
            width: 100%;
            height: 18px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin: 6px 0;
        }

        .attendance-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .fill-high {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .fill-medium {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .fill-low {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .attendance-percentage {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.65rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .refresh-analytics {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }

        .refresh-analytics:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .refresh-analytics i {
            animation: spin 2s linear infinite;
        }

        .export-pdf-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .export-pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
            background: linear-gradient(45deg, #c0392b, #a93226);
        }

        .export-pdf-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .export-pdf-btn i {
            font-size: 1.1em;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Student stat item styling */
        .student-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 10px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .student-stat-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-stat-item.excellent {
            border-left-color: #2ecc71;
        }

        .student-stat-item.good {
            border-left-color: #3498db;
        }

        .student-stat-item.average {
            border-left-color: #f39c12;
        }

        .student-stat-item.poor {
            border-left-color: #e74c3c;
        }

        .stat-details {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* Penalties Section */
        .penalties-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
            display: none;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .penalties-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .penalties-header h3 {
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .penalties-header h3 i {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
        }

        .penalties-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .penalties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .penalties-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .penalties-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .penalties-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .penalties-card h4 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .penalties-card h4 i {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .penalties-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .penalties-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 10px 0;
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.05));
            border-radius: 12px;
            border-left: 4px solid #e74c3c;
            transition: all 0.3s ease;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .penalties-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.2);
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.15), rgba(192, 57, 43, 0.1));
        }

        .penalty-student-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .penalty-amount {
            font-weight: 700;
            color: #e74c3c;
            font-size: 1.2rem;
            background: rgba(231, 76, 60, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid rgba(231, 76, 60, 0.3);
        }

        .penalty-details {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .penalty-summary {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            grid-column: 1 / -1;
        }

        .penalty-summary h4 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .penalty-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .penalty-stat {
            text-align: center;
            padding: 15px;
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .penalty-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #e74c3c;
            display: block;
            margin-bottom: 5px;
        }

        .penalty-stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 600;
        }

        .penalties-empty {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px;
            background: rgba(127, 140, 141, 0.1);
            border-radius: 12px;
            border: 2px dashed rgba(127, 140, 141, 0.3);
        }

        .penalties-filter {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .penalties-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .penalties-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .penalty-action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .penalty-export-pdf-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .penalty-export-pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .penalty-clear-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            color: white;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }

        .penalty-clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
        }

        .penalty-refresh-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .penalty-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .penalty-settings-btn {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
        }

        .penalty-settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
        }

        /* Penalty Settings Modal */
        .penalty-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .penalty-settings-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .penalty-settings-header {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 20px 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .penalty-settings-header h3 {
            margin: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .penalty-settings-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .penalty-settings-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .penalty-settings-form {
            padding: 25px;
        }

        .penalty-form-group {
            margin-bottom: 20px;
        }

        .penalty-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .penalty-form-group input,
        .penalty-form-group select,
        .penalty-form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .penalty-form-group input:focus,
        .penalty-form-group select:focus,
        .penalty-form-group textarea:focus {
            outline: none;
            border-color: #9b59b6;
            box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.1);
        }

        .penalty-time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .penalty-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .penalty-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .penalty-settings-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .penalty-settings-btn-action {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .penalty-btn-save {
            background: linear-gradient(45deg, #27ae60, #229954);
            color: white;
        }

        .penalty-btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }

        .penalty-btn-cancel {
            background: #95a5a6;
            color: white;
        }

        .penalty-btn-cancel:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        .penalty-current-settings {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .penalty-current-settings h4 {
            margin: 0 0 10px 0;
            color: #27ae60;
            font-size: 1rem;
        }

        .penalty-current-settings p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Location Section */
        .location-section {
            margin-top: 30px;
        }

        .location-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .location-card h3 {
            color: var(--text-secondary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: var(--input-border);
            color: var(--primary-color);
        }

        .location-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .location-details strong {
            color: var(--text-secondary);
        }

        .location-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--table-header);
            border-radius: 8px;
            border-left: 4px solid var(--text-accent);
            color: var(--text-primary);
            margin-bottom: 8px;
            position: relative;
            flex-wrap: wrap;
            gap: 8px;
        }

        .location-item:hover {
            background: var(--card-hover, var(--background-secondary));
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .location-label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 120px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .location-label i {
            color: var(--text-accent);
            width: 16px;
        }

        .location-value, .accuracy-value, .timestamp-value, .updates-count {
            font-family: 'Courier New', monospace;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--background-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .address-value {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            color: var(--text-primary);
            background: var(--background-secondary);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            line-height: 1.4;
            max-width: 100%;
            word-wrap: break-word;
            position: relative;
        }

        .address-value:hover {
            background: var(--primary-color-light);
            border-color: var(--primary-color);
            transition: all 0.2s ease;
        }

        .address-container {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            flex-wrap: wrap;
        }

        .address-actions {
            display: flex;
            gap: 4px;
            margin-top: 2px;
        }

        .address-btn {
            padding: 2px 6px;
            font-size: 11px;
            border: 1px solid var(--border-color);
            background: var(--background-primary);
            color: var(--text-secondary);
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .address-btn:hover {
            background: var(--primary-color);
            color: white;
            text-decoration: none;
        }

        .address-btn i {
            margin-right: 2px;
        }

        .coordinates-summary {
            background: var(--background-primary);
            border: 2px solid var(--text-accent);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .coordinates-display {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .coordinates-text {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: var(--background-secondary);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            flex-grow: 1;
            min-width: 200px;
        }

        .copy-btn {
            background: var(--text-accent);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .copy-btn:hover {
            background: var(--primary-dark, #2c3e50);
            transform: scale(1.05);
        }

        .copy-btn.primary {
            background: var(--primary-color);
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .copy-btn.primary:hover {
            background: var(--primary-dark, #27ae60);
        }

        .help-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .help-btn:hover {
            background: var(--warning-dark, #e67e22);
            transform: scale(1.1);
        }

        .accuracy-icon, .quality-icon {
            margin-left: 5px;
            font-size: 1.1rem;
        }

        .accuracy-help {
            width: 100%;
            margin-top: 4px;
        }

        .accuracy-help small {
            color: var(--text-secondary);
            font-style: italic;
        }

        .altitude-accuracy, .speed-unit, .compass-direction, .time-ago, .update-rate {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-left: 5px;
        }

        .map-options {
            display: flex;
            gap: 8px;
            margin-left: 10px;
        }

        .map-option {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-accent);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .map-option:hover {
            background: var(--text-accent);
            color: white;
            transform: scale(1.1);
        }

        .map-link {
            color: var(--text-accent);
            text-decoration: none;
            font-weight: 500;
        }

        .map-link:hover {
            text-decoration: underline;
        }

        .permission-status.granted {
            color: var(--success-color);
            font-weight: 600;
        }

        .permission-status.denied {
            color: var(--error-color);
            font-weight: 600;
        }

        .permission-status.prompt {
            color: var(--warning-color);
            font-weight: 600;
        }

        .quality-indicator.excellent {
            color: var(--success-color);
            font-weight: 600;
        }

        .quality-indicator.good {
            color: var(--primary-color);
            font-weight: 600;
        }

        .quality-indicator.fair {
            color: var(--warning-color);
            font-weight: 600;
        }

        .quality-indicator.poor {
            color: var(--error-color);
            font-weight: 600;
        }

        .quality-indicator.indoor {
            color: #9b59b6;
            font-weight: 600;
        }

        /* Location Controls */
        .location-controls-section {
            margin-top: 20px;
        }

        .location-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            padding: 12px;
            background: var(--table-header);
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .control-group label:hover {
            background: var(--input-border);
        }

        .control-group label input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .control-group label span {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .control-group label small {
            color: var(--text-primary);
            font-size: 0.85rem;
            margin-top: 2px;
        }

        .location-status-bar {
            padding: 15px;
            background: var(--table-header);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .location-tips {
            margin-top: 10px;
            padding: 15px;
            background: var(--background-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--warning-color);
        }

        .location-tips small {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .location-recommendation {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
        }

        .location-recommendation.excellent {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
            color: white;
        }

        .location-recommendation.good {
            background: linear-gradient(135deg, var(--primary-color), #3498db);
            color: white;
        }

        .location-recommendation.fair {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
        }

        .location-recommendation.poor {
            background: linear-gradient(135deg, var(--error-color), #c0392b);
            color: white;
        }

        .recommendation-content {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .recommendation-content i {
            font-size: 1.2rem;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-indicator i {
            transition: color 0.3s ease;
        }

        .status-indicator.active i {
            color: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-indicator.error i {
            color: #e74c3c;
        }

        .status-indicator.warning i {
            color: #f39c12;
        }

        .status-indicator.info i {
            color: #3498db;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Quality Indicators */
        .quality-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .quality-indicator.excellent {
            background: #d4edda;
            color: #155724;
        }

        .quality-indicator.good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .quality-indicator.fair {
            background: #fff3cd;
            color: #856404;
        }

        .quality-indicator.poor {
            background: #f8d7da;
            color: #721c24;
        }

        /* Permission Status */
        .permission-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .permission-status.granted {
            background: #d4edda;
            color: #155724;
        }

        .permission-status.denied {
            background: #f8d7da;
            color: #721c24;
        }

        .permission-status.prompt {
            background: #fff3cd;
            color: #856404;
        }

        /* Enhanced location item styling */
        .location-item a {
            text-decoration: none;
            font-weight: 500;
            color: var(--text-accent);
        }

        .location-item a:hover {
            text-decoration: underline;
        }

        /* Admin Modal Styles */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .admin-modal-content {
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: 0 20px 60px var(--shadow-color);
            max-width: 450px;
            width: 90%;
            animation: adminModalSlide 0.3s ease;
            border: 1px solid var(--border-color);
        }

        @keyframes adminModalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .admin-modal-header {
            padding: 25px 30px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-modal-header h3 {
            color: var(--text-secondary);
            margin: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-modal-header h3 i {
            color: var(--button-danger);
        }

        .admin-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .admin-modal-close:hover {
            background: var(--table-header);
            color: var(--button-danger);
        }

        .admin-modal-body {
            padding: 25px 30px;
        }

        .admin-modal-body p {
            color: var(--text-primary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .admin-form-group {
            margin-bottom: 20px;
        }

        .admin-form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .admin-form-group input:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .admin-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .admin-attempts {
            color: var(--button-warning);
            text-align: center;
            margin-top: 10px;
        }

        .admin-modal-footer {
            padding: 15px 30px 25px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            border-top: 1px solid var(--border-color);
        }

        .admin-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-btn-cancel {
            background: var(--text-primary);
            color: var(--bg-card);
        }

        .admin-btn-cancel:hover {
            background: var(--text-secondary);
            transform: translateY(-1px);
        }

        .admin-btn-confirm {
            background: var(--button-danger);
            color: white;
        }

        .admin-btn-confirm:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .admin-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Admin Lock Icons */
        .admin-lock-icon {
            font-size: 0.8rem;
            margin-left: 5px;
            opacity: 0.7;
        }

        .action-btn:hover .admin-lock-icon {
            opacity: 1;
        }

        /* Admin Mode Indicators */
        .admin-mode-active {
            position: relative;
        }

        .admin-mode-active::after {
            content: "ADMIN";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Messages */
        .message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .message {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            position: relative;
            transition: opacity 0.3s ease;
        }

        .message-close {
            background: none;
            border: none;
            color: inherit;
            opacity: 0.7;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease;
            margin-left: auto;
        }

        .message-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }

        .message.success {
            background: #2ecc71;
            color: white;
        }

        .message.error {
            background: #e74c3c;
            color: white;
        }

        .message.warning {
            background: #f39c12;
            color: white;
        }

        .message.info {
            background: #3498db;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            text-align: center;
            color: var(--text-primary);
        }

        .loading-spinner i {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .loading-spinner p {
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* Action Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.check-in {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.check-out {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.break-start,
        .status-badge.lunch-start {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.break-end,
        .status-badge.lunch-end {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.present {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.absent {
            background: #f8d7da;
            color: #721c24;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .current-info {
                flex-direction: column;
                gap: 10px;
            }

            .location-group {
                flex-direction: column;
                gap: 15px;
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .filters {
                flex-direction: column;
                gap: 10px;
            }

            .filter-group {
                min-width: auto;
            }

            .table-container {
                font-size: 0.8rem;
            }

            .records-table th,
            .records-table td {
                padding: 8px 6px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .location-details {
                grid-template-columns: 1fr;
            }

            .control-group {
                gap: 8px;
            }

            .control-group label {
                padding: 10px;
                font-size: 0.9rem;
            }

            .location-controls {
                gap: 15px;
            }

            /* Student Management Responsive */
            .student-selection-container {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .add-student-form {
                flex-direction: column;
                gap: 8px;
            }

            .add-student-form input {
                min-width: auto;
            }

            .students-section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .student-item {
                padding: 10px;
            }

            .student-info {
                gap: 2px;
            }

            .remove-student-btn {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .form-card,
            .records-card,
            .location-card {
                padding: 20px;
            }

            .message-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
        
        /* Collapsible Section Styles */
        .section-header {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            margin-bottom: 0;
        }
        
        .section-header:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }
        
        .dark-theme .section-header {
            background: #2d3748;
            border-color: #4a5568;
        }
        
        .dark-theme .section-header:hover {
            background: #4a5568;
        }
        
        .dark-theme .section-header h3 {
            color: #e2e8f0;
        }
        
        .toggle-icon {
            font-size: 16px;
            transition: transform 0.3s ease;
            color: #6c757d;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background: #fff;
        }
        
        .dark-theme .collapsible-content {
            background: #1a202c;
            border-color: #4a5568;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            border: none;
        }
        
        .collapsible-content.expanded {
            max-height: 2000px;
            opacity: 1;
        }
        
        /* Adjust existing sections to work with collapsible */
        .actions-section .action-buttons,
        .location-section .location-card,
        .location-controls-section .location-card {
            margin: 0;
            border: none;
            border-radius: 0;
            padding: 20px;
        }

        /* Email Modal Styles */
        .email-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(3px);
        }

        .email-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .email-modal-content.large {
            max-width: 1100px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .email-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid #f0f2f5;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .email-modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .email-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .email-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .email-report-form {
            padding: 30px;
        }

        .email-form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .email-form-section h4 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .email-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .email-form-row:last-child {
            margin-bottom: 0;
        }

        .email-form-group {
            display: flex;
            flex-direction: column;
        }

        .email-form-group.full-width {
            grid-column: 1 / -1;
        }

        .email-form-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }

        .email-form-group input,
        .email-form-group select,
        .email-form-group textarea {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .email-form-group input:focus,
        .email-form-group select:focus,
        .email-form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .email-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .email-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .email-checkbox-item:hover {
            background: #f0f2f5;
            border-color: #667eea;
        }

        .email-checkbox-item input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .email-checkbox-item span {
            font-size: 14px;
            color: #555;
        }

        .email-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding: 25px 30px;
            border-top: 2px solid #f0f2f5;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .email-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            min-width: 120px;
            justify-content: center;
        }

        .email-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .email-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .email-btn.preview {
            background: #17a2b8;
            color: white;
        }

        .email-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .email-preview-content {
            padding: 30px;
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-height: 60vh;
            overflow-y: auto;
        }

        .email-preview-content pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        /* Mobile Responsive Design - iPhone 13 & All Mobile Devices */
        @media (max-width: 768px) {
            /* Email Modal Styles */
            .email-modal-content {
                width: 98%;
                margin: 10px;
            }

            .email-form-row {
                grid-template-columns: 1fr;
            }

            .email-checkbox-grid {
                grid-template-columns: 1fr;
            }

            .email-form-actions {
                flex-direction: column;
                gap: 10px;
            }

            .email-btn {
                width: 100%;
            }

            /* Attendance Form Mobile Optimizations */
            .container {
                padding: 10px;
                max-width: 100%;
            }

            .form-card {
                margin: 10px 0;
                padding: 20px 15px;
                border-radius: 12px;
            }

            .attendance-form {
                gap: 15px;
            }

            .form-group {
                gap: 10px;
            }

            /* Student Selection Mobile */
            .student-selection-container {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .student-search-wrapper {
                width: 100%;
            }

            .student-search-input {
                padding: 14px 40px 14px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
                min-height: 44px; /* iOS touch target minimum */
            }

            .clear-search-btn {
                right: 10px;
                width: 30px;
                height: 30px;
            }

            .manage-students-btn {
                width: 100%;
                padding: 14px;
                min-height: 48px;
                justify-content: center;
            }

            /* Location Group Mobile */
            .location-group {
                flex-direction: column;
                gap: 15px;
            }

            /* Form Inputs Mobile */
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
                min-height: 44px;
                border-radius: 8px;
            }

            /* Attendance Buttons Mobile */
            .attendance-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .attendance-btn {
                width: 100%;
                padding: 16px;
                min-height: 52px;
                font-size: 18px;
                border-radius: 10px;
            }

            /* Form Help Text Mobile */
            .form-help {
                font-size: 14px;
                line-height: 1.4;
            }

            /* Student Dropdown Mobile */
            .student-dropdown {
                max-height: 250px;
                border-radius: 0 0 10px 10px;
            }

            .student-option {
                padding: 14px 16px;
                font-size: 16px;
                min-height: 44px;
                display: flex;
                align-items: center;
            }

            /* Date/Time Input Mobile */
            input[type="datetime-local"] {
                font-size: 16px;
                padding: 14px;
                min-height: 44px;
            }
        }

        /* iPhone 13 Specific Optimizations */
        @media (max-width: 428px) and (min-width: 375px) {
            .form-card {
                padding: 18px 12px;
                margin: 8px 0;
            }

            .student-search-input {
                font-size: 16px;
                padding: 12px 38px 12px 14px;
            }

            .attendance-btn {
                padding: 14px;
                min-height: 50px;
                font-size: 17px;
            }

            .form-group label {
                font-size: 15px;
                font-weight: 600;
            }

            .form-help {
                font-size: 13px;
            }
        }

        /* Universal Anti-Zoom Rules for All Mobile Devices */
        @media (max-width: 768px) {
            /* Ensure ALL inputs are 16px+ to prevent iOS zoom */
            input[type="text"],
            input[type="email"], 
            input[type="password"],
            input[type="number"],
            input[type="tel"],
            input[type="url"],
            input[type="search"],
            input[type="datetime-local"],
            input[type="date"],
            input[type="time"],
            select,
            textarea {
                font-size: 16px !important;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }

            /* Prevent zoom on focus for all interactive elements */
            input:focus,
            select:focus,
            textarea:focus {
                font-size: 16px !important;
            }

            /* Specific fixes for common zoom triggers */
            .student-search-input,
            .student-search-input:focus {
                font-size: 16px !important;
            }

            /* Override any smaller font sizes */
            * {
                -webkit-text-size-adjust: 100%;
                -moz-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
                text-size-adjust: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 ondblclick="secretAdminAccess()"><i class="fas fa-school"></i> Class Attendance System</h1>
                <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
            <div class="current-info">
                <div class="info-item">
                    <i class="fas fa-calendar"></i>
                    <span id="currentDate"></span>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime"></span>
                </div>
                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationStatus">Getting location...</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Attendance Form -->
            <section class="attendance-section">
                <div class="form-card">
                    <h2><i class="fas fa-user-check"></i> Record Attendance</h2>
                    
                    <form id="attendanceForm" class="attendance-form">
                        <!-- Student Selection with Search -->
                        <div class="form-group">
                            <label for="student"><i class="fas fa-user"></i> Select Student:</label>
                            <div class="student-selection-container">
                                <!-- Search Input with Clear Button -->
                                <div class="student-search-wrapper">
                                    <div class="student-search-input-container">
                                        <input type="text" 
                                               id="studentSearch" 
                                               class="student-search-input"
                                               placeholder="ðŸ” Type to search students..."
                                               autocomplete="off"
                                               aria-describedby="student-help"
                                               aria-label="Search students by name">
                                        <button type="button" 
                                                id="clearStudentSearch" 
                                                class="clear-search-btn" 
                                                title="Clear search"
                                                aria-label="Clear search text"
                                                style="display: none;">
                                            <i class="fas fa-times" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                    <div class="student-dropdown" id="studentDropdown">
                                        <div class="student-option" data-value="">-- Select Student --</div>
                                    </div>
                                </div>
                                <!-- Hidden select for form submission -->
                                <select id="student" name="student" required style="display: none;">
                                    <option value="">-- Select Student --</option>
                                </select>
                                <button type="button" id="manageStudentsBtn" class="manage-students-btn" 
                                        title="Manage Students" 
                                        aria-label="Manage student list"
                                        aria-expanded="false"
                                        aria-controls="studentManagementPanel">
                                    <i class="fas fa-cog" aria-hidden="true"></i>
                                </button>
                            </div>
                            <small id="student-help" class="form-help">ðŸ” Type student name to search, or click dropdown to browse all students</small>
                        </div>

                        <!-- Student Management Panel (Hidden by default) -->
                        <div id="studentManagementPanel" class="student-management-panel" style="display: none;">
                            <div class="student-management-header">
                                <h4><i class="fas fa-users-cog"></i> Manage Students</h4>
                                <button type="button" id="closeStudentPanel" class="close-panel-btn" onclick="closeStudentManagementPanel()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Add New Student -->
                            <div class="add-student-section">
                                <div class="add-student-form">
                                    <div class="form-row">
                                        <label for="newStudentId" class="sr-only">Student ID</label>
                                        <input type="text" id="newStudentId" placeholder="Student ID (optional - auto-generated if empty)" maxlength="20">
                                        <label for="newStudentName" class="sr-only">Student Full Name</label>
                                        <input type="text" id="newStudentName" placeholder="Student Full Name (e.g., John Smith)" maxlength="100">
                                    </div>
                                    <button type="button" id="addStudentBtn" class="add-student-btn">
                                        <i class="fas fa-plus"></i> Add Student
                                    </button>
                                </div>
                            </div>

                            <!-- Current Students List -->
                            <div class="current-students-section">
                                <div class="students-section-header">
                                    <h5><i class="fas fa-list"></i> Current Students</h5>
                                    <button type="button" id="restoreDefaultBtn" class="restore-default-btn" onclick="restoreDefaultStudents()" title="Restore Default Students">
                                        <i class="fas fa-undo"></i> Restore Defaults
                                    </button>
                                </div>
                                <div id="studentsList" class="students-list">
                                    <!-- Students will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Attendance Status -->
                        <div class="form-group">
                            <fieldset style="border: none; padding: 0; margin: 0;">
                                <legend style="font-weight: 600; color: #34495e; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="fas fa-user-check"></i> Mark Attendance:
                                </legend>
                                <div class="attendance-buttons">
                                    <button type="button" id="presentBtn" class="attendance-btn present-btn" tabindex="0">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Present</span>
                                    </button>
                                    <button type="button" id="absentBtn" class="attendance-btn absent-btn" tabindex="0">
                                        <i class="fas fa-times-circle"></i>
                                        <span>Absent</span>
                                    </button>
                                </div>
                                <input type="hidden" id="attendanceStatus" name="attendanceStatus" required>
                                <small id="attendance-help" class="form-help">Click Present or Absent to mark attendance</small>
                            </fieldset>
                        </div>

                        <!-- Date & Time (Editable) -->
                        <div class="form-group">
                            <label for="dateTime"><i class="fas fa-calendar-alt"></i> Date & Time: <small style="color: #3498db; font-weight: normal;">(Editable)</small></label>
                            <input type="datetime-local" id="dateTime" name="dateTime" 
                                   aria-describedby="datetime-help" 
                                   aria-label="Attendance date and time"
                                   title="Click to edit date and time for past lectures">
                            <small id="datetime-help" class="form-help">ðŸ“… Auto-set to current time, but you can edit to record past lectures or specific times</small>
                        </div>

                        <!-- Location Fields -->
                        <div class="location-group">
                            <div class="form-group half">
                                <label for="latitude"><i class="fas fa-globe"></i> Latitude:</label>
                                <input type="text" id="latitude" name="latitude" readonly>
                            </div>
                            <div class="form-group half">
                                <label for="longitude"><i class="fas fa-globe"></i> Longitude:</label>
                                <input type="text" id="longitude" name="longitude" readonly>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="form-group">
                            <label for="notes"><i class="fas fa-sticky-note"></i> Excuse Reason (Optional):</label>
                            <select id="notes" name="notes" 
                                    aria-describedby="notes-help" 
                                    aria-label="Optional excuse reason for attendance record">
                                <option value="">-- Select excuse reason --</option>
                                <option value="Abroad-excused">Abroad-excused</option>
                            </select>
                            <small id="notes-help" class="form-help">Select excuse reason (will exclude from attendance calculation if applicable)</small>
                        </div>

                        <!-- Fraud Protection Status (Hidden) -->
                        <div class="fraud-protection-status" id="fraudProtectionStatus" style="display: none; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;">
                            <div class="status-header">
                                <i class="fas fa-shield-alt"></i>
                                <strong>Security Status</strong>
                                <button type="button" id="toggleFraudStatus" class="toggle-btn" onclick="toggleFraudProtectionDetails()" title="Show/Hide Details">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                            <div id="fraudStatusDetails" class="status-details" style="display: none; margin-top: 8px; font-size: 0.9em; color: #666;">
                                <div id="fraudStatusText">Checking security status...</div>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Action Buttons -->
            <section class="actions-section">
                <div class="section-header collapsible-header" onclick="toggleSection('actions-content')">
                    <h3><i class="fas fa-tools"></i> Actions & Reports</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="actions-content-icon"></i>
                </div>
                <div id="actions-content" class="collapsible-content collapsed">
                <div class="action-buttons">
                    <button id="viewRecordsBtn" class="action-btn primary">
                        <i class="fas fa-eye"></i> View Records
                    </button>
                    <button id="viewAnalyticsBtn" class="action-btn info">
                        <i class="fas fa-chart-line"></i> View Analytics
                    </button>
                    <button id="viewPenaltiesBtn" class="action-btn warning">
                        <i class="fas fa-exclamation-triangle"></i> View Penalties
                    </button>
                    <button id="downloadBtn" class="action-btn success">
                        <i class="fas fa-download"></i> Download Excel
                    </button>
                    <button id="clearBtn" class="action-btn danger" onclick="clearAllData()" style="display: none !important; visibility: hidden !important;">
                        <i class="fas fa-trash"></i> Clear Data
                    </button>
                </div>

                <!-- Firebase Cloud Sync Section -->
                <div class="firebase-section" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 style="margin: 0 0 15px 0; color: white; font-size: 18px;">
                        <i class="fas fa-cloud"></i> Firebase Cloud Sync
                    </h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
                        <button id="toggleFirebaseBtn" class="action-btn" style="background: #4CAF50; color: white;" onclick="toggleFirebaseMode()">
                            <i class="fas fa-toggle-on"></i> <span id="firebaseStatusText">Enable Cloud Sync</span>
                        </button>
                        <button id="syncNowBtn" class="action-btn" style="background: #2196F3; color: white;" onclick="syncWithFirebase()">
                            <i class="fas fa-sync"></i> Sync Now
                        </button>
                        <button class="action-btn" style="background: #FF9800; color: white;" onclick="showFirebaseStatus()">
                            <i class="fas fa-info-circle"></i> Status
                        </button>
                    </div>
                    <div id="firebaseStatusInfo" style="font-size: 12px; color: #e8f4fd; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px;">
                        <div>ðŸ”— Status: <span id="connectionStatus">Checking...</span></div>
                        <div>Sync Queue: <span id="syncQueueCount">0</span> pending</div>
                        <div>Mode: <span id="currentMode">Local Only</span></div>
                    </div>
                </div>
                
                <!-- Email Reporting Section -->
                <div class="email-report-section" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">
                        <i class="fas fa-envelope"></i> Email Reports
                    </h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button id="openEmailFormBtn" class="action-btn primary" style="white-space: nowrap;" onclick="testEmailForm()">
                            <i class="fas fa-envelope-open"></i> Create Email Report
                        </button>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
                        Generate professional attendance reports for managers and administrators.
                    </p>
                </div>
                </div>
            </section>

            <!-- Records Display -->
            <section id="recordsSection" class="records-section" style="display: none;">
                <div class="records-card">
                    <div class="records-header">
                        <h2><i class="fas fa-list"></i> Attendance Records</h2>
                        <button class="records-close-btn" onclick="toggleRecordsView()" title="Close Records View">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <div class="filter-group">
                            <label for="dateFilterType"><i class="fas fa-calendar"></i> Filter By:</label>
                            <select id="dateFilterType" class="compact-select">
                                <option value="single">Single Day</option>
                                <option value="range">Date Range</option>
                            </select>
                        </div>
                        
                        <div class="filter-group" id="singleDateFilter">
                            <label for="filterDate"><i class="fas fa-calendar-day"></i> Select Date:</label>
                            <input type="date" id="filterDate" class="compact-input">
                        </div>

                        <div class="filter-group" id="dateRangeFilter" style="display: none;">
                            <label for="filterDateStart"><i class="fas fa-calendar-week"></i> Period:</label>
                            <div class="date-range-inputs">
                                <label for="filterDateStart" class="sr-only">Start Date</label>
                                <input type="date" id="filterDateStart" class="compact-input" title="Start Date">
                                <span class="date-separator">â†’</span>
                                <label for="filterDateEnd" class="sr-only">End Date</label>
                                <input type="date" id="filterDateEnd" class="compact-input" title="End Date">
                            </div>
                        </div>

                        <div class="filter-group">
                            <label for="filterEmployee"><i class="fas fa-user"></i> Student:</label>
                            <select id="filterEmployee" class="compact-select">
                                <option value="">All Students</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterAction"><i class="fas fa-filter"></i> Status:</label>
                            <select id="filterAction">
                                <option value="">All Status</option>
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                            </select>
                        </div>
                        <button id="applyFilters" class="filter-btn" onclick="applyFilters()">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <button id="clearFilters" class="filter-btn" onclick="clearFilters()" style="background-color: #95a5a6; margin-left: 5px;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button id="exportPdf" class="filter-btn" onclick="exportFilteredRecordsToPdf()" style="background-color: #e74c3c; margin-left: 10px;">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>

                    <!-- Records Table -->
                    <div class="table-container">
                        <table id="recordsTable" class="records-table">
                            <thead>
                                <tr>
                                    <th data-column="id">ID</th>
                                    <th data-column="student">Student</th>
                                    <th data-column="action">Action</th>
                                    <th data-column="date">Date</th>
                                    <th data-column="time">Time</th>
                                    <th data-column="location">Location</th>
                                    <th data-column="notes">Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody">
                                <!-- Records will be inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Records Information Bar -->
                    <div class="records-info-bar">
                        <div class="records-count">
                            <i class="fas fa-list-ol"></i>
                            <span id="recordsCount">0</span> records found
                        </div>
                        <div class="records-actions">
                            <button class="info-btn" onclick="scrollToTop()" title="Scroll to Top">
                                <i class="fas fa-arrow-up"></i> Top
                            </button>
                            <button class="info-btn" onclick="refreshRecords()" title="Refresh Records">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div id="statisticsSection" class="statistics-section">
                        <h3><i class="fas fa-chart-pie"></i> Today's Statistics</h3>
                        <div class="stats-grid" id="statsGrid">
                            <!-- Stats will be inserted here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Dashboard -->
            <section id="analyticsSection" class="analytics-section">
                <div class="analytics-header">
                    <h3><i class="fas fa-chart-line"></i> Analytics Dashboard</h3>
                    <div class="analytics-controls">
                        <select id="analyticsFilter" class="analytics-filter">
                            <option value="all">All Time</option>
                            <option value="last7days">Last 7 Days</option>
                            <option value="last30days">Last 30 Days</option>
                            <option value="thismonth">This Month</option>
                            <option value="lastmonth">Last Month</option>
                        </select>
                        <button class="refresh-analytics" onclick="generateAnalytics()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="refresh-analytics" onclick="debugDataStructure()" style="background-color: #ffc107; color: #000;">
                            <i class="fas fa-bug"></i> Debug Data
                        </button>
                        <button id="exportAnalyticsPdfBtn" class="export-pdf-btn">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                        <button class="analytics-close-btn" onclick="toggleAnalyticsView()" title="Close Analytics">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="analytics-grid">
                    <!-- Highest Weighted Score -->
                    <div class="analytics-card">
                        <h4><i class="fas fa-trophy"></i> Highest Weighted Score</h4>
                        <ul id="highestAttendanceList" class="analytics-list">
                            <li class="analytics-empty">No data available</li>
                        </ul>
                    </div>

                    <!-- Lowest Attendance Rate -->
                    <div class="analytics-card">
                        <h4><i class="fas fa-exclamation-triangle"></i> Lowest Attendance Rate</h4>
                        <ul id="lowestAttendanceList" class="analytics-list">
                            <li class="analytics-empty">No data available</li>
                        </ul>
                    </div>
                </div>

                <!-- Matrix Analysis: Dates with Highest Unexcused Absences -->
                <div class="matrix-absence-analytics">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span><i class="fas fa-matrix-code header-icon" style="color: #e74c3c;"></i> Matrix Analysis: Highest Unexcused Absences</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-content">
                        <div class="matrix-analysis-description">
                            <p><i class="fas fa-info-circle" style="color: #3498db;"></i> <strong>Intelligent Analysis:</strong> 
                            Uses binary matrix logic (1=Present, 0=Unexcused Absent) from Consistency Index calculations 
                            to identify dates with highest collective absenteeism patterns.</p>
                        </div>
                        <div id="matrixAbsenceTimeline" class="matrix-absence-timeline">
                            <div class="analytics-empty">Generate analytics to view matrix-based absence patterns</div>
                        </div>
                        <div id="matrixInsights" class="matrix-insights">
                            <div class="insights-grid">
                                <div class="insight-card">
                                    <div class="insight-label">Worst Date</div>
                                    <div class="insight-value" id="worstAbsenceDate">-</div>
                                </div>
                                <div class="insight-card">
                                    <div class="insight-label">Max Absences</div>
                                    <div class="insight-value" id="maxAbsences">-</div>
                                </div>
                                <div class="insight-card">
                                    <div class="insight-label">Avg Absenteeism</div>
                                    <div class="insight-value" id="avgAbsenteeism">-</div>
                                </div>
                                <div class="insight-card">
                                    <div class="insight-label">Matrix Zeros</div>
                                    <div class="insight-value" id="matrixZeros">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="individual-stats">
                    <div id="studentChartsContainer" class="charts-container">
                        <div class="analytics-empty">Select "Refresh Analytics" to generate charts</div>
                    </div>
                </div>
            </section>

            <!-- Penalties Section -->
            <section id="penaltiesSection" class="penalties-section">
                <div class="penalties-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Late Arrival Penalties</h3>
                    <div class="penalties-controls">
                        <select id="penaltiesFilter" class="penalties-filter">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="last7days">Last 7 Days</option>
                            <option value="last30days">Last 30 Days</option>
                            <option value="thismonth">This Month</option>
                            <option value="lastmonth">Last Month</option>
                        </select>
                        <div class="penalties-actions">
                            <button class="penalty-action-btn penalty-settings-btn" onclick="openPenaltySettings()" title="Configure Penalty Settings">
                                <i class="fas fa-cog"></i> Settings
                            </button>
                            <button class="penalty-action-btn penalty-refresh-btn" onclick="generatePenalties()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button id="exportPenaltiesPdfBtn" class="penalty-action-btn penalty-export-pdf-btn" onclick="exportPenaltiesToPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button class="penalty-action-btn penalty-clear-btn" onclick="clearPenaltyData()">
                                <i class="fas fa-trash"></i> Clear Penalties
                            </button>
                        </div>
                        <button class="penalties-close-btn" onclick="togglePenaltiesView()" title="Close Penalties View">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Penalty Summary -->
                <div class="penalty-summary">
                    <h4><i class="fas fa-calculator"></i> Penalty Summary</h4>
                    <div class="penalty-summary-grid">
                        <div class="penalty-stat">
                            <span id="totalPenaltyAmount" class="penalty-stat-value">0 AED</span>
                            <span class="penalty-stat-label">Total Penalties</span>
                        </div>
                        <div class="penalty-stat">
                            <span id="totalLateArrivals" class="penalty-stat-value">0</span>
                            <span class="penalty-stat-label">Late Arrivals</span>
                        </div>
                        <div class="penalty-stat">
                            <span id="studentsWithPenalties" class="penalty-stat-value">0</span>
                            <span class="penalty-stat-label">Students with Penalties</span>
                        </div>
                        <div class="penalty-stat">
                            <span id="averagePenaltyPerStudent" class="penalty-stat-value">0 AED</span>
                            <span class="penalty-stat-label">Average per Student</span>
                        </div>
                    </div>
                </div>

                <div class="penalties-grid">
                    <!-- Student Penalties -->
                    <div class="penalties-card">
                        <h4><i class="fas fa-user-times"></i> Student Penalties</h4>
                        <ul id="studentPenaltiesList" class="penalties-list">
                            <li class="penalties-empty">No penalties recorded</li>
                        </ul>
                    </div>

                    <!-- Recent Late Arrivals -->
                    <div class="penalties-card">
                        <h4><i class="fas fa-clock"></i> Recent Late Arrivals</h4>
                        <ul id="recentLateArrivalsList" class="penalties-list">
                            <li class="penalties-empty">No late arrivals recorded</li>
                        </ul>
                    </div>
                </div>

                <!-- Penalty Details -->
                <div class="penalties-card" style="margin-top: 25px;">
                    <h4><i class="fas fa-list-ul"></i> Detailed Penalty Log</h4>
                    <div id="penaltyDetailsContainer">
                        <div class="penalties-empty">No penalty details available</div>
                    </div>
                </div>
            </section>

            <!-- Penalty Settings Modal -->
            <div id="penaltySettingsModal" class="penalty-settings-modal">
                <div class="penalty-settings-content">
                    <div class="penalty-settings-header">
                        <h3><i class="fas fa-cog"></i> Penalty System Settings</h3>
                        <button class="penalty-settings-close" onclick="closePenaltySettings()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="penalty-settings-form">
                        <!-- Current Settings Display -->
                        <div class="penalty-current-settings">
                            <h4><i class="fas fa-info-circle"></i> Current Settings</h4>
                            <p id="currentPenaltyStatus"><strong>Status:</strong> <span id="penaltyStatusText">Enabled</span></p>
                            <p id="currentTimeRange"><strong>Allowed Time:</strong> <span id="timeRangeText">1:00 PM - 1:30 PM</span></p>
                            <p id="currentPenaltyAmount"><strong>Penalty Amount:</strong> <span id="penaltyAmountText">10 AED</span></p>
                        </div>

                        <!-- Penalty System Enable/Disable -->
                        <div class="penalty-toggle">
                            <input type="checkbox" id="penaltyEnabled" checked>
                            <label for="penaltyEnabled"><strong>Enable Penalty System</strong></label>
                        </div>

                        <!-- Time Settings -->
                        <div class="penalty-form-group">
                            <h4 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 8px; color: #2c3e50;">
                                <i class="fas fa-clock"></i> Allowed Attendance Time Window
                            </h4>
                            <div class="penalty-time-inputs">
                                <div>
                                    <label for="penaltyTimeStart">Start Time</label>
                                    <input type="time" id="penaltyTimeStart" value="13:00" required>
                                </div>
                                <div>
                                    <label for="penaltyTimeEnd">End Time</label>
                                    <input type="time" id="penaltyTimeEnd" value="13:30" required>
                                </div>
                            </div>
                            <small style="color: #7f8c8d; margin-top: 5px; display: block;">
                                <i class="fas fa-info-circle"></i> Students arriving outside this time window will receive penalties
                            </small>
                        </div>

                        <!-- Penalty Amount -->
                        <div class="penalty-form-group">
                            <label for="penaltyAmount"><i class="fas fa-dollar-sign"></i> Penalty Amount per Late Arrival</label>
                            <input type="number" id="penaltyAmount" min="0" step="0.01" value="10" required>
                        </div>

                        <!-- Currency -->
                        <div class="penalty-form-group">
                            <label for="penaltyCurrency"><i class="fas fa-coins"></i> Currency</label>
                            <select id="penaltyCurrency">
                                <option value="AED">AED (UAE Dirham)</option>
                                <option value="USD">USD (US Dollar)</option>
                                <option value="EUR">EUR (Euro)</option>
                                <option value="GBP">GBP (British Pound)</option>
                                <option value="SAR">SAR (Saudi Riyal)</option>
                                <option value="QAR">QAR (Qatari Riyal)</option>
                            </select>
                        </div>

                        <!-- Penalty Reason -->
                        <div class="penalty-form-group">
                            <label for="penaltyReason"><i class="fas fa-comment"></i> Penalty Reason Text</label>
                            <textarea id="penaltyReason" rows="3" maxlength="200" 
                                placeholder="Default reason shown for penalties...">Late arrival - outside allowed time window</textarea>
                            <small style="color: #7f8c8d;">Max 200 characters</small>
                        </div>

                        <!-- Action Buttons -->
                        <div class="penalty-settings-buttons">
                            <button type="button" class="penalty-settings-btn-action penalty-btn-cancel" onclick="closePenaltySettings()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="button" class="penalty-settings-btn-action penalty-btn-save" onclick="savePenaltySettingsForm()">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Info -->
            <section class="location-section">
                <div class="section-header collapsible-header" onclick="toggleSection('location-content')">
                    <h3><i class="fas fa-map-marker-alt"></i> Current Location</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="location-content-icon"></i>
                </div>
                <div id="location-content" class="collapsible-content collapsed">
                <div class="location-card">
                    <h3><i class="fas fa-map-marker-alt"></i> Current Location</h3>
                    <div class="location-details">
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-map-marker-alt"></i> Latitude:</span>
                            <span id="displayLatitude" class="location-value">--</span>Â°
                            <button class="copy-btn" onclick="copyToClipboard(document.getElementById('displayLatitude').textContent)" title="Copy latitude">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-map-marker-alt"></i> Longitude:</span>
                            <span id="displayLongitude" class="location-value">--</span>Â°
                            <button class="copy-btn" onclick="copyToClipboard(document.getElementById('displayLongitude').textContent)" title="Copy longitude">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-crosshairs"></i> Accuracy:</span>
                            <span id="locationAccuracy" class="accuracy-value">--</span>m
                            <span id="accuracyIcon" class="accuracy-icon"></span>
                            <div id="accuracyHelp" class="accuracy-help">
                                <small id="accuracyDescription">Waiting for GPS...</small>
                            </div>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-map-marked-alt"></i> Address:</span>
                            <div class="address-container">
                                <span id="locationAddress" class="address-value">Getting address...</span>
                                <div class="address-actions">
                                    <button class="copy-btn" onclick="copyToClipboard(document.getElementById('locationAddress').textContent)" title="Copy address">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="address-btn" onclick="refreshAddress()" title="Refresh address">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                    <button id="enableLocationBtn" class="address-btn success" onclick="enableLocationAccess()" title="Click to enable location access">
                                        <i class="fas fa-unlock"></i> Enable Location
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-mountain"></i> Altitude:</span>
                            <span id="locationAltitude" class="location-value">--</span>
                            <span id="altitudeAccuracy" class="altitude-accuracy"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-tachometer-alt"></i> Speed:</span>
                            <span id="locationSpeed" class="location-value">--</span>
                            <span id="speedUnit" class="speed-unit"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-compass"></i> Heading:</span>
                            <span id="locationHeading" class="location-value">--</span>
                            <span id="compassDirection" class="compass-direction"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-clock"></i> Last Update:</span>
                            <span id="locationTimestamp" class="timestamp-value">--</span>
                            <span id="timeAgo" class="time-ago"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-medal"></i> Quality:</span>
                            <span id="locationQuality" class="quality-indicator">--</span>
                            <span id="qualityIcon" class="quality-icon"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-shield-alt"></i> Permission:</span>
                            <span id="locationPermission" class="permission-status">--</span>
                            <button id="permissionHelpBtn" class="help-btn" onclick="showPermissionHelp()" title="Permission help">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-sync-alt"></i> Updates:</span>
                            <span id="locationUpdates" class="updates-count">0</span>
                            <span id="updateRate" class="update-rate"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-external-link-alt"></i> Map Link:</span>
                            <a id="mapLink" href="#" target="_blank" rel="noopener" class="map-link">View on Map</a>
                            <div class="map-options">
                                <a id="googleMapsLink" href="#" target="_blank" rel="noopener" class="map-option" title="Open in Google Maps">
                                    <i class="fab fa-google"></i>
                                </a>
                                <a id="appleMapsLink" href="#" target="_blank" rel="noopener" class="map-option" title="Open in Apple Maps">
                                    <i class="fab fa-apple"></i>
                                </a>
                            </div>
                        </div>
                        <div class="location-item coordinates-summary">
                            <span class="location-label"><i class="fas fa-globe"></i> Full Coordinates:</span>
                            <div class="coordinates-display">
                                <span id="fullCoordinates" class="coordinates-text">--</span>
                                <button class="copy-btn primary" onclick="copyFullCoordinates()" title="Copy full coordinates">
                                    <i class="fas fa-copy"></i> Copy All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </section>

            <!-- Geolocation Controls -->
            <section class="location-controls-section">
                <div class="section-header collapsible-header" onclick="toggleSection('location-controls-content')">
                    <h3><i class="fas fa-cogs"></i> Location Settings</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="location-controls-content-icon"></i>
                </div>
                <div id="location-controls-content" class="collapsible-content collapsed">
                <div class="location-card">
                    <h3><i class="fas fa-cogs"></i> Location Settings</h3>
                    <div class="location-controls">
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="highAccuracyToggle" checked>
                                <span>High Accuracy GPS</span>
                                <small>Uses GPS for better accuracy (higher battery usage)</small>
                            </label>
                        </div>
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="continuousTrackingToggle" checked>
                                <span>Continuous Tracking</span>
                                <small>Monitor location changes in real-time</small>
                            </label>
                        </div>
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="autoRefreshToggle">
                                <span>Auto Refresh Location</span>
                                <small>Automatically refresh location every 15 seconds for better accuracy</small>
                            </label>
                        </div>
                        <div class="control-group">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; max-width: 500px;">
                                <button id="refreshLocationBtn" class="action-btn primary" title="Get current location quickly">
                                    <i class="fas fa-sync-alt"></i> Refresh Location
                                </button>
                                <button id="forceGPSBtn" class="action-btn danger" title="Force GPS mode - keep trying until high accuracy (may take 60+ seconds)">
                                    <i class="fas fa-satellite-dish"></i> Force GPS
                                </button>
                                <button id="requestPermissionBtn" class="action-btn success" title="Request location permission if blocked">
                                    <i class="fas fa-unlock"></i> Get Permission
                                </button>
                            </div>
                        </div>
                        <div class="location-status-bar">
                            <div class="status-indicator" id="locationStatusIndicator">
                                <i class="fas fa-circle"></i>
                                <span id="locationStatusText">Initializing...</span>
                            </div>
                            <div id="locationTips" class="location-tips" style="display: none;">
                                <small>
                                    <i class="fas fa-lightbulb"></i> 
                                    <strong>Tips for better location accuracy:</strong><br>
                                    <strong>ðŸ›°ï¸ For GPS (3-10m accuracy):</strong> Move outdoors or near large windows<br>
                                    <strong>ðŸ“¶ For Indoor (10-100m accuracy):</strong> Enable WiFi for better network positioning<br>
                                    <strong>âš¡ Best Option:</strong> Use "Force GPS" for the most accurate location (may take up to 2 minutes)<br>
                                    <strong>ðŸŽ¯ Target:</strong> Under 100m accuracy is good for attendance tracking<br>
                                    <strong>â±ï¸ Patience:</strong> GPS can take 30-90 seconds to get satellite lock<br>
                                    <strong>ðŸ”‹ Battery:</strong> Force GPS uses more battery but gives the best results<br>
                                    <strong>ðŸ  Indoor Use:</strong> Near windows or in main rooms for best WiFi positioning<br>
                                    <strong>ðŸ“± Settings:</strong> Ensure device location services are enabled
                                </small>
                            </div>
                            <div id="locationRecommendation" class="location-recommendation" style="display: none;">
                                <div class="recommendation-content">
                                    <i class="fas fa-info-circle"></i>
                                    <span id="recommendationText">Getting location recommendations...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </section>
        </main>

        <!-- Simple Email Form Modal -->
        <div id="emailFormModal" class="email-modal" style="display: none;">
            <div class="email-modal-content" style="max-width: 500px; background: white; padding: 20px; border-radius: 8px;">
                <div class="email-modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                    <h3 style="margin: 0; color: #333;">ðŸ“§ Send Attendance Report</h3>
                    <button type="button" style="background: none; border: none; font-size: 20px; cursor: pointer;" onclick="closeEmailForm()">âœ•</button>
                </div>
                
                <form id="emailReportForm" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label for="recipientEmail" style="display: block; margin-bottom: 5px; font-weight: bold;">Send to Email:</label>
                        <input type="email" id="recipientEmail" required 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                               placeholder="manager@company.com">
                    </div>
                    
                    <div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <h4 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 14px;">ï¿½ Email Workflow:</h4>
                            <p style="margin: 0; color: #555; font-size: 13px; line-height: 1.4;">
                                <strong>Step 1:</strong> This will open your email client with pre-filled content
                                <br><strong>Step 2:</strong> Download PDF from Analytics section (Export PDF button)
                                <br><strong>Step 3:</strong> Attach the downloaded PDF to your email
                                <br><strong>Step 4:</strong> Send the email with the analytics report attached
                            </p>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" onclick="closeEmailForm()" 
                                style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button type="button" id="sendEmailBtn" onclick="sendSimpleEmail()" 
                                style="flex: 1; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">ï¿½ Send Email</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Email Preview Modal -->
        <div id="emailPreviewModal" class="email-modal" style="display: none;">
            <div class="email-modal-content large">
                <div class="email-modal-header">
                    <h3><i class="fas fa-eye"></i> Email Preview</h3>
                    <button type="button" class="email-modal-close" onclick="closeEmailPreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="emailPreviewContent" class="email-preview-content">
                    <!-- Preview content will be generated here -->
                </div>
                <div class="email-form-actions">
                    <button type="button" class="email-btn secondary" onclick="closeEmailPreview()">
                        <i class="fas fa-arrow-left"></i> Back to Edit
                    </button>
                    <button type="button" class="email-btn primary" onclick="sendFinalEmail()">
                        <i class="fas fa-paper-plane"></i> Send Email
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messageContainer" class="message-container"></div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Processing...</p>
            </div>
        </div>

        <!-- Admin Password Modal -->
        <div id="adminModal" class="admin-modal" style="display: none;">
            <div class="admin-modal-content">
                <div class="admin-modal-header">
                    <h3><i class="fas fa-shield-alt"></i> Admin Access Required</h3>
                    <button class="admin-modal-close" onclick="closeAdminModal()">&times;</button>
                </div>
                <div class="admin-modal-body">
                    <p>This action requires administrator privileges.</p>
                    <div class="admin-form-group">
                        <label for="adminPassword">
                            <i class="fas fa-lock"></i> Enter Admin Password:
                        </label>
                        <input type="password" id="adminPassword" placeholder="Admin password" 
                               onkeypress="handleAdminKeyPress(event)">
                    </div>
                    <div id="adminError" class="admin-error" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="adminErrorText"></span>
                    </div>
                    <div class="admin-attempts" id="adminAttempts" style="display: none;">
                        <small>Attempts remaining: <span id="attemptsCount">3</span></small>
                    </div>
                </div>
                <div class="admin-modal-footer">
                    <button class="admin-btn admin-btn-cancel" onclick="closeAdminModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="admin-btn admin-btn-confirm" onclick="validateAdminPassword()">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let attendanceData = [];
        let currentPosition = null;
        let watchId = null;
        let locationWatchId = null;
        let lastKnownPosition = null;
        let locationPermissionStatus = 'unknown';
        let isHighAccuracyEnabled = true;
        let locationUpdateCount = 0;
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = false;
        
            // Firebase Integration Settings
            let useFirebase = true; // Enable Firebase by default since we have working configuration
            let offlineMode = false; // Track offline status
            let syncQueue = []; // Queue for offline submissions
        
        // Theme Management
        let isDarkMode = false;
        
        // Admin Security - Fixed: No more annoying password prompts!
        let isAdminMode = false;
        let ADMIN_PASSWORD = null; // Will be set only when needed
        let adminAttempts = 0;
        const MAX_ATTEMPTS = 3;
        
        // Function to get admin password (secure runtime generation)
        function getAdminPassword() {
            if (!ADMIN_PASSWORD) {
                // Generate secure admin password at runtime (not exposed in source)
                const currentYear = new Date().getFullYear();
                const monthDay = String(new Date().getMonth() + 1).padStart(2, '0') + 
                                String(new Date().getDate()).padStart(2, '0');
                ADMIN_PASSWORD = currentYear.toString(); // Default: current year
                
                // For production, you should implement proper authentication
                // This is a basic security measure for demonstration
                sessionStorage.setItem('adminPassword', ADMIN_PASSWORD);
            }
            return ADMIN_PASSWORD;
        }
        
        // Function to reset admin password (useful for testing or changing password)
        function resetAdminPassword() {
            ADMIN_PASSWORD = null;
            sessionStorage.removeItem('adminPassword');
            isAdminMode = false;
            updateAdminUI();
            showMessage('Admin password reset. You will be prompted for a new password on next admin access.', 'info');
        }

        // Anti-Fraud Protection System
        let lastSubmissionTime = 0;
        let submissionCount = 0;
        let lastSubmittedStudent = '';
        let suspiciousActivity = false;
        const SUBMISSION_COOLDOWN = 0; // No waiting time - instant submissions allowed
        const MAX_HOURLY_SUBMISSIONS = Infinity; // No limit - infinite submissions allowed
        const MIN_LOCATION_ACCURACY = 20000; // Enhanced 20km range for better functionality
        const MAX_TRAVEL_SPEED = 120; // Maximum reasonable travel speed (km/h)
        const MIN_TIME_BETWEEN_LOCATIONS = 30000; // 30 seconds minimum between location changes
        const CAMPUS_LOCATIONS = [
            { lat: 25.2048, lng: 55.2708, name: 'Dubai' }, // Dubai coordinates
            { lat: 25.3548, lng: 55.4105, name: 'Sharjah' }, // Sharjah coordinates
        ];
        let hourlySubmissions = [];
        let consecutiveSubmissions = 0;
        let locationHistory = [];
        
        // Penalties System
        let penaltiesData = []; // Stores penalty records
        
        // Default penalty settings - can be configured via settings panel
        let penaltySettings = {
            enabled: true,
            amount: 10, // AED per late arrival
            allowedTimeStart: 13.0, // 1:00 PM (13:00 in 24-hour format)
            allowedTimeEnd: 13.5, // 1:30 PM (13:30 in 24-hour format)
            reason: 'Late arrival - outside allowed time window',
            currency: 'AED'
        };
        
        // Load penalty settings from localStorage
        function loadPenaltySettings() {
            try {
                const saved = localStorage.getItem('penaltySettings');
                if (saved) {
                    penaltySettings = { ...penaltySettings, ...JSON.parse(saved) };
                }
            } catch (error) {
                console.error('Error loading penalty settings:', error);
            }
        }
        
        // Save penalty settings to localStorage
        function savePenaltySettings() {
            try {
                localStorage.setItem('penaltySettings', JSON.stringify(penaltySettings));
                console.log('Penalty settings saved:', penaltySettings);
            } catch (error) {
                console.error('Error saving penalty settings:', error);
            }
        }
        
        // Load penalties data from localStorage
        function loadPenaltiesData() {
            try {
                const saved = localStorage.getItem('penaltiesData');
                if (saved) {
                    penaltiesData = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading penalties data:', error);
                penaltiesData = [];
            }
        }
        
        // Save penalties data to localStorage
        function savePenaltiesData() {
            try {
                localStorage.setItem('penaltiesData', JSON.stringify(penaltiesData));
            } catch (error) {
                console.error('Error saving penalties data:', error);
            }
        }
        
        // Check if attendance time is late (outside configured time window)
        function isLateArrival(timeString) {
            // If penalty system is disabled, no one is late
            if (!penaltySettings.enabled) {
                return false;
            }
            
            try {
                let hours = 0;
                let minutes = 0;
                
                if (timeString.includes('PM') || timeString.includes('AM')) {
                    // 12-hour format (e.g., "3:30:45 PM")
                    const timeParts = timeString.replace(/[APM\s]/g, '').split(':');
                    hours = parseInt(timeParts[0]);
                    minutes = parseInt(timeParts[1]) || 0;
                    const isPM = timeString.includes('PM');
                    
                    if (isPM && hours !== 12) {
                        hours += 12;
                    } else if (!isPM && hours === 12) {
                        hours = 0;
                    }
                } else {
                    // 24-hour format or time only
                    const time = new Date(`1970-01-01T${timeString}`);
                    hours = time.getHours();
                    minutes = time.getMinutes();
                }
                
                // Convert time to decimal hours for easier comparison (e.g., 1:30 PM = 13.5)
                const decimalTime = hours + (minutes / 60);
                
                console.log(`ðŸ•’ Checking time: ${timeString}, parsed: ${hours}:${minutes} (${decimalTime})`);
                const isLate = decimalTime < penaltySettings.allowedTimeStart || decimalTime >= penaltySettings.allowedTimeEnd;
                console.log(`âš ï¸ Is late arrival: ${isLate} (allowed: ${penaltySettings.allowedTimeStart}-${penaltySettings.allowedTimeEnd})`);
                
                return isLate;
            } catch (error) {
                console.error('Error parsing time for penalty check:', error);
                return false;
            }
        }
        
        // Add penalty for late arrival
        function addPenalty(studentName, attendanceTime, attendanceDate) {
            const penalty = {
                id: Date.now().toString(),
                studentName: studentName,
                amount: penaltySettings.amount,
                date: attendanceDate,
                time: attendanceTime,
                timestamp: Date.now(),
                reason: penaltySettings.reason,
                currency: penaltySettings.currency
            };
            
            penaltiesData.push(penalty);
            savePenaltiesData();
            
            // Update penalties display if visible
            if (document.getElementById('penaltiesSection').style.display !== 'none') {
                generatePenalties();
            }
            
            return penalty;
        }
        
        // Calculate total penalty for a student
        function calculateStudentPenalty(studentName) {
            return penaltiesData
                .filter(penalty => penalty.studentName === studentName)
                .reduce((total, penalty) => total + penalty.amount, 0);
        }
        
        // Get penalty statistics
        function getPenaltyStatistics() {
            const totalAmount = penaltiesData.reduce((total, penalty) => total + penalty.amount, 0);
            const totalCount = penaltiesData.length;
            const uniqueStudents = [...new Set(penaltiesData.map(p => p.studentName))].length;
            const averagePerStudent = uniqueStudents > 0 ? totalAmount / uniqueStudents : 0;
            
            return {
                totalAmount,
                totalCount,
                uniqueStudents,
                averagePerStudent
            };
        }
        
        // Penalty Settings Modal Functions
        function openPenaltySettings() {
            // Load current settings into form
            loadPenaltySettingsIntoForm();
            
            // Show modal
            const modal = document.getElementById('penaltySettingsModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
                // Add ESC key support
                const escKeyHandler = (e) => {
                    if (e.key === 'Escape') {
                        closePenaltySettings();
                        document.removeEventListener('keydown', escKeyHandler);
                    }
                };
                document.addEventListener('keydown', escKeyHandler);
                
                // Add click outside to close
                const clickOutsideHandler = (e) => {
                    if (e.target === modal) {
                        closePenaltySettings();
                        modal.removeEventListener('click', clickOutsideHandler);
                    }
                };
                modal.addEventListener('click', clickOutsideHandler);
            }
        }
        
        function closePenaltySettings() {
            const modal = document.getElementById('penaltySettingsModal');
            if (modal) {
                modal.style.display = 'none';
            }
            document.body.style.overflow = 'auto'; // Restore scrolling
        }
        
        // Close modal when clicking outside of it
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('penaltySettingsModal');
            const modalContent = document.querySelector('.penalty-settings-content');
            if (modal && event.target === modal && !modalContent.contains(event.target)) {
                closePenaltySettings();
            }
        });
        
        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('penaltySettingsModal');
                if (modal && modal.style.display === 'flex') {
                    closePenaltySettings();
                }
            }
        });
        
        function loadPenaltySettingsIntoForm() {
            // Update current settings display
            document.getElementById('penaltyStatusText').textContent = penaltySettings.enabled ? 'Enabled' : 'Disabled';
            document.getElementById('timeRangeText').textContent = formatTimeRange(penaltySettings.allowedTimeStart, penaltySettings.allowedTimeEnd);
            document.getElementById('penaltyAmountText').textContent = `${penaltySettings.amount} ${penaltySettings.currency}`;
            
            // Load values into form fields
            document.getElementById('penaltyEnabled').checked = penaltySettings.enabled;
            document.getElementById('penaltyTimeStart').value = formatDecimalTimeToHHMM(penaltySettings.allowedTimeStart);
            document.getElementById('penaltyTimeEnd').value = formatDecimalTimeToHHMM(penaltySettings.allowedTimeEnd);
            document.getElementById('penaltyAmount').value = penaltySettings.amount;
            document.getElementById('penaltyCurrency').value = penaltySettings.currency;
            document.getElementById('penaltyReason').value = penaltySettings.reason;
        }
        
        function savePenaltySettingsForm() {
            // Get form values
            const enabled = document.getElementById('penaltyEnabled').checked;
            const timeStart = document.getElementById('penaltyTimeStart').value;
            const timeEnd = document.getElementById('penaltyTimeEnd').value;
            const amount = parseFloat(document.getElementById('penaltyAmount').value);
            const currency = document.getElementById('penaltyCurrency').value;
            const reason = document.getElementById('penaltyReason').value.trim();
            
            // Validate inputs
            if (!timeStart || !timeEnd) {
                alert('Please set both start and end times.');
                return;
            }
            
            if (isNaN(amount) || amount < 0) {
                alert('Please enter a valid penalty amount (must be 0 or greater).');
                return;
            }
            
            if (reason.length === 0) {
                alert('Please enter a penalty reason.');
                return;
            }
            
            // Convert time strings to decimal hours
            const startDecimal = timeStringToDecimal(timeStart);
            const endDecimal = timeStringToDecimal(timeEnd);
            
            if (startDecimal >= endDecimal) {
                alert('End time must be after start time.');
                return;
            }
            
            // Update penalty settings
            penaltySettings.enabled = enabled;
            penaltySettings.allowedTimeStart = startDecimal;
            penaltySettings.allowedTimeEnd = endDecimal;
            penaltySettings.amount = amount;
            penaltySettings.currency = currency;
            penaltySettings.reason = reason;
            
            // Save to localStorage
            savePenaltySettings();
            
            // Show success message
            showSuccessMessage(`Penalty settings updated successfully! ${enabled ? 'Penalties are now enabled.' : 'Penalties are now disabled.'}`);
            
            // Close modal
            closePenaltySettings();
            
            // Refresh penalties display if visible
            if (document.getElementById('penaltiesSection').style.display !== 'none') {
                generatePenalties();
            }
        }
        
        // Helper function to convert decimal time to HH:MM format
        function formatDecimalTimeToHHMM(decimalTime) {
            const hours = Math.floor(decimalTime);
            const minutes = Math.round((decimalTime - hours) * 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        // Helper function to convert HH:MM time string to decimal
        function timeStringToDecimal(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours + (minutes / 60);
        }
        
        // Helper function to format time range for display
        function formatTimeRange(startDecimal, endDecimal) {
            const startTime = formatDecimalTimeToHHMM(startDecimal);
            const endTime = formatDecimalTimeToHHMM(endDecimal);
            
            // Convert to 12-hour format for display
            const start12 = formatTo12Hour(startTime);
            const end12 = formatTo12Hour(endTime);
            
            return `${start12} - ${end12}`;
        }
        
        // Helper function to convert 24-hour time to 12-hour format
        function formatTo12Hour(time24) {
            const [hours, minutes] = time24.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const hours12 = hours % 12 || 12;
            return `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
        }
        
        // Helper function to show success messages
        function showSuccessMessage(message) {
            // Create or update success message element
            let successEl = document.getElementById('penaltySuccessMessage');
            if (!successEl) {
                successEl = document.createElement('div');
                successEl.id = 'penaltySuccessMessage';
                successEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #27ae60, #229954);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
                    z-index: 10001;
                    font-weight: 600;
                    animation: slideInRight 0.3s ease-out;
                `;
                document.body.appendChild(successEl);
            }
            
            successEl.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            successEl.style.display = 'block';
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                if (successEl) {
                    successEl.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (successEl.parentNode) {
                            successEl.parentNode.removeChild(successEl);
                        }
                    }, 300);
                }
            }, 4000);
        }
        
        // Load fraud protection data from localStorage
        function loadFraudProtectionData() {
            try {
                const saved = localStorage.getItem('fraudProtectionData');
                if (saved) {
                    const data = JSON.parse(saved);
                    const now = Date.now();
                    
                    // Only restore recent data (within last hour)
                    lastSubmissionTime = data.lastSubmissionTime || 0;
                    submissionCount = data.submissionCount || 0;
                    lastSubmittedStudent = data.lastSubmittedStudent || '';
                    suspiciousActivity = data.suspiciousActivity || false;
                    
                    // Filter hourly submissions to only include last hour
                    hourlySubmissions = (data.hourlySubmissions || []).filter(time => 
                        now - time < 3600000
                    );
                    
                    // Filter location history to only include recent locations (last 30 minutes)
                    locationHistory = (data.locationHistory || []).filter(loc => 
                        now - loc.timestamp < 1800000
                    );
                }
            } catch (error) {
                console.error('Error loading fraud protection data:', error);
                // Reset to defaults if error
                resetFraudProtectionData();
            }
        }
        
        // Save fraud protection data to localStorage
        function saveFraudProtectionData() {
            try {
                const data = {
                    lastSubmissionTime,
                    submissionCount,
                    lastSubmittedStudent,
                    suspiciousActivity,
                    hourlySubmissions,
                    locationHistory,
                    timestamp: Date.now()
                };
                localStorage.setItem('fraudProtectionData', JSON.stringify(data));
            } catch (error) {
                console.error('Error saving fraud protection data:', error);
            }
        }
        
        // Reset fraud protection data
        function resetFraudProtectionData() {
            lastSubmissionTime = 0;
            submissionCount = 0;
            lastSubmittedStudent = '';
            suspiciousActivity = false;
            hourlySubmissions = [];
            consecutiveSubmissions = 0;
            locationHistory = [];
            saveFraudProtectionData();
            updateFraudProtectionUI();
            showMessage('Fraud protection data reset - all counters cleared', 'info');
        }
        
        // Admin function to manually reset submission counter
        function resetSubmissionCounter() {
            if (confirm('Reset submission counter? This will allow 3 new submissions immediately.')) {
                resetFraudProtectionData();
            }
        }

        // Student Management
        let activeStudents = {}; // Dynamic list of active students
        
        // Default student names (anonymized for public deployment)
        const defaultStudentNames = {
            'STU001': { id: 'STU001', name: 'Baraa Takala' },
            'STU002': { id: 'STU002', name: 'Yaman Takala' },
            'STU003': { id: 'STU003', name: 'Baraa Shaibani' },
            'STU004': { id: 'STU004', name: 'Homam Hassan' },
            'STU005': { id: 'STU005', name: 'Ahmed Naqawa' },
            'STU006': { id: 'STU006', name: 'Yahya Aldaik' },
            'STU007': { id: 'STU007', name: 'Asaad Diaa' },
            'STU008': { id: 'STU008', name: 'obada' },
            'STU009': { id: 'STU009', name: 'Omar Bawab' },
            'STU010': { id: 'STU010', name: 'Yosuf Sadek' },
            'STU011': { id: 'STU011', name: 'Mohamed Kheir' },
            'STU015': { id: 'STU015', name: 'Abdul Aziz Alzaubi' },
            'STU016': { id: 'STU016', name: 'Omar Akeel' },
            'STU017': { id: 'STU017', name: 'Maleek Bitar' },
            'STU018': { id: 'STU018', name: 'Mohamed Amin' },
            'STU019': { id: 'STU019', name: 'Lyth Kawokgi' },
            'STU021': { id: 'STU021', name: 'zaid kawokgi' }

        };

        // Student names mapping (for backward compatibility)
        let studentNames = {};

        // Action type mapping
        const actionTypeMapping = {
            'check-in': { label: 'Check In', icon: 'fas fa-sign-in-alt', color: '#27ae60' },
            'check-out': { label: 'Check Out', icon: 'fas fa-sign-out-alt', color: '#e74c3c' },
            'break-start': { label: 'Break Start', icon: 'fas fa-coffee', color: '#f39c12' },
            'break-end': { label: 'Break End', icon: 'fas fa-play', color: '#3498db' },
            'lunch-start': { label: 'Lunch Start', icon: 'fas fa-utensils', color: '#9b59b6' },
            'lunch-end': { label: 'Lunch End', icon: 'fas fa-utensils', color: '#1abc9c' }
        };

        // DOM Elements
        const elements = {
            form: document.getElementById('attendanceForm'),
            student: document.getElementById('student'),
            attendanceStatus: document.getElementById('attendanceStatus'),
            presentBtn: document.getElementById('presentBtn'),
            absentBtn: document.getElementById('absentBtn'),
            dateTime: document.getElementById('dateTime'),
            latitude: document.getElementById('latitude'),
            longitude: document.getElementById('longitude'),
            // Date Filter Elements
            dateFilterType: document.getElementById('dateFilterType'),
            singleDateFilter: document.getElementById('singleDateFilter'),
            dateRangeFilter: document.getElementById('dateRangeFilter'),
            filterDateStart: document.getElementById('filterDateStart'),
            filterDateEnd: document.getElementById('filterDateEnd'),
            notes: document.getElementById('notes'),
            
            // Display elements
            currentDate: document.getElementById('currentDate'),
            currentTime: document.getElementById('currentTime'),
            locationStatus: document.getElementById('locationStatus'),
            displayLatitude: document.getElementById('displayLatitude'),
            displayLongitude: document.getElementById('displayLongitude'),
            locationAccuracy: document.getElementById('locationAccuracy'),
            locationAddress: document.getElementById('locationAddress'),
            locationAltitude: document.getElementById('locationAltitude'),
            locationSpeed: document.getElementById('locationSpeed'),
            locationHeading: document.getElementById('locationHeading'),
            locationTimestamp: document.getElementById('locationTimestamp'),
            locationQuality: document.getElementById('locationQuality'),
            locationPermission: document.getElementById('locationPermission'),
            locationUpdates: document.getElementById('locationUpdates'),
            mapLink: document.getElementById('mapLink'),
            
            // Action buttons
            viewRecordsBtn: document.getElementById('viewRecordsBtn'),
            viewAnalyticsBtn: document.getElementById('viewAnalyticsBtn'),
            viewPenaltiesBtn: document.getElementById('viewPenaltiesBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            clearBtn: document.getElementById('clearBtn'),
            statsBtn: document.getElementById('statsBtn'),
            sendEmailBtn: document.getElementById('sendEmailBtn'),
            reportEmail: document.getElementById('reportEmail'),
            openEmailFormBtn: document.getElementById('openEmailFormBtn'),
            exportAnalyticsPdfBtn: document.getElementById('exportAnalyticsPdfBtn'),
            
            // Email Form Elements
            emailFormModal: document.getElementById('emailFormModal'),
            emailReportForm: document.getElementById('emailReportForm'),
            emailPreviewModal: document.getElementById('emailPreviewModal'),
            emailPreviewContent: document.getElementById('emailPreviewContent'),
            
            // Email Form Fields
            recipientEmail: document.getElementById('recipientEmail'),
            recipientName: document.getElementById('recipientName'),
            ccEmails: document.getElementById('ccEmails'),
            reportType: document.getElementById('reportType'),
            reportPriority: document.getElementById('reportPriority'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            emailSubject: document.getElementById('emailSubject'),
            customMessage: document.getElementById('customMessage'),
            senderName: document.getElementById('senderName'),
            dateRangeSection: document.getElementById('dateRangeSection'),
            
            // Records section
            recordsSection: document.getElementById('recordsSection'),
            analyticsSection: document.getElementById('analyticsSection'),
            filterDate: document.getElementById('filterDate'),
            filterEmployee: document.getElementById('filterEmployee'),
            filterAction: document.getElementById('filterAction'),
            applyFilters: document.getElementById('applyFilters'),
            recordsTableBody: document.getElementById('recordsTableBody'),
            statsGrid: document.getElementById('statsGrid'),
            
            // Messages
            messageContainer: document.getElementById('messageContainer'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            
            // Student Management
            manageStudentsBtn: document.getElementById('manageStudentsBtn'),
            studentManagementPanel: document.getElementById('studentManagementPanel'),
            closeStudentPanel: document.getElementById('closeStudentPanel'),
            newStudentId: document.getElementById('newStudentId'),
            newStudentName: document.getElementById('newStudentName'),
            addStudentBtn: document.getElementById('addStudentBtn'),
            studentsList: document.getElementById('studentsList')
        };

        // Global variable to store selected attendance status
        let selectedAttendanceStatus = null;

        // Function to handle attendance status selection
        function setAttendanceStatus(status) {
            // Check if student is selected first
            if (!elements.student.value) {
                showMessage('Please select a student first', 'warning');
                elements.student.focus();
                return;
            }
            
            const studentSelect = elements.student;
            const studentName = studentSelect.options[studentSelect.selectedIndex]?.text || 'Selected Student';
            
            selectedAttendanceStatus = status;
            
            // Update button appearances
            elements.presentBtn.classList.remove('selected');
            elements.absentBtn.classList.remove('selected');
            
            if (status === 'present') {
                elements.presentBtn.classList.add('selected');
                elements.attendanceStatus.value = 'present';
                // Submit form immediately without confirmation
                setTimeout(() => {
                    const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                    elements.form.dispatchEvent(submitEvent);
                }, 100);
            } else if (status === 'absent') {
                elements.absentBtn.classList.add('selected');
                elements.attendanceStatus.value = 'absent';
                // Submit form immediately without confirmation
                setTimeout(() => {
                    const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                    elements.form.dispatchEvent(submitEvent);
                }, 100);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize table sorting
            initializeTableSorting();
            initializeApp();
            initializeAnalyticsUI();
            
            // Initialize searchable student dropdown
            initializeSearchableDropdown();
            
            // Prevent mobile zoom on all inputs
            preventMobileZoom();
        });

        // Prevent iOS Safari from zooming on input focus
        function preventMobileZoom() {
            // Dynamic viewport adjustment to prevent zoom
            const viewport = document.querySelector('meta[name="viewport"]');
            
            function disableZoom() {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            }
            
            function enableZoom() {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes');
            }
            
            // Detect iOS devices
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (isIOS) {
                // Find all input elements
                const inputs = document.querySelectorAll('input, select, textarea');
                
                inputs.forEach(input => {
                    // Ensure font-size is always 16px+ on focus
                    input.addEventListener('focus', function() {
                        disableZoom();
                        const computedStyle = window.getComputedStyle(this);
                        const fontSize = parseInt(computedStyle.fontSize, 10);
                        
                        if (fontSize < 16) {
                            this.style.fontSize = '16px';
                        }
                    });
                    
                    input.addEventListener('blur', function() {
                        // Optional: Re-enable zoom after blur
                        // enableZoom();
                    });
                });
            }
            
            // Force all inputs to have 16px font-size
            const allInputs = document.querySelectorAll('input[type="text"], input[type="search"], input[type="email"], input[type="number"], input[type="tel"], input[type="datetime-local"], select, textarea');
            allInputs.forEach(input => {
                const style = window.getComputedStyle(input);
                if (parseInt(style.fontSize, 10) < 16) {
                    input.style.fontSize = '16px';
                }
            });
        }

        function initializeAnalyticsUI() {
            // Initialize collapsible sections - matrix analytics collapsed by default
            const matrixAnalyticsContent = document.querySelector('.matrix-absence-analytics .section-content');
            if (matrixAnalyticsContent) {
                matrixAnalyticsContent.style.display = 'none';
            }
            
            // Initialize tabs - first tab active by default
            const firstTab = document.querySelector('.analytics-tab');
            const firstTabContent = document.querySelector('.tab-content');
            if (firstTab && firstTabContent) {
                firstTab.classList.add('active');
                firstTabContent.classList.add('active');
            }
        }

        // Initialize searchable student dropdown functionality
        function initializeSearchableDropdown() {
            const searchInput = document.getElementById('studentSearch');
            const dropdown = document.getElementById('studentDropdown');
            const hiddenSelect = document.getElementById('student');
            const clearButton = document.getElementById('clearStudentSearch');
            
            if (!searchInput || !dropdown || !hiddenSelect || !clearButton) return;

            let allOptions = [];
            let highlightedIndex = -1;

            // Toggle clear button visibility based on input content
            function toggleClearButton() {
                if (searchInput.value.trim().length > 0) {
                    clearButton.style.display = 'flex';
                } else {
                    clearButton.style.display = 'none';
                }
            }

            // Clear search input and reset selection
            function clearSearch() {
                searchInput.value = '';
                hiddenSelect.value = '';
                toggleClearButton();
                
                // Show all students in dropdown after clearing
                showDropdown();
                filterOptions(''); // Show all options (empty search term)
                
                // Reset all options to show unselected state
                dropdown.querySelectorAll('.student-option').forEach(opt => 
                    opt.classList.remove('selected'));
                
                // Trigger change event for form validation
                hiddenSelect.dispatchEvent(new Event('change'));
                
                // Focus back on input for better UX
                searchInput.focus();
            }

            // Update dropdown options from hidden select
            function updateDropdownOptions() {
                allOptions = Array.from(dropdown.querySelectorAll('.student-option'));
            }

            // Show dropdown
            function showDropdown() {
                dropdown.classList.add('show');
                updateDropdownOptions();
            }

            // Hide dropdown
            function hideDropdown() {
                dropdown.classList.remove('show');
                highlightedIndex = -1;
            }

            // Filter options based on search term
            function filterOptions(searchTerm) {
                const options = dropdown.querySelectorAll('.student-option');
                const term = searchTerm.toLowerCase().trim();
                
                let visibleCount = 0;
                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    const isMatch = text.includes(term) || term === '';
                    
                    option.style.display = isMatch ? 'block' : 'none';
                    if (isMatch) visibleCount++;
                });

                // Update visible options array for keyboard navigation
                allOptions = Array.from(options).filter(opt => opt.style.display !== 'none');
                highlightedIndex = -1;
                
                return visibleCount > 0;
            }

            // Select an option
            function selectOption(option) {
                const value = option.getAttribute('data-value');
                const text = option.textContent;

                // Update hidden select
                hiddenSelect.value = value;

                // Update search input
                searchInput.value = text;

                // Update visual selection
                dropdown.querySelectorAll('.student-option').forEach(opt => 
                    opt.classList.remove('selected'));
                option.classList.add('selected');

                hideDropdown();
                
                // Update clear button visibility
                toggleClearButton();

                // Trigger change event for form validation
                hiddenSelect.dispatchEvent(new Event('change'));
            }

            // Handle keyboard navigation
            function handleKeyboard(e) {
                if (!dropdown.classList.contains('show')) {
                    if (e.key === 'ArrowDown' || e.key === 'Enter') {
                        e.preventDefault();
                        showDropdown();
                        return;
                    }
                    return;
                }

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        highlightedIndex = Math.min(highlightedIndex + 1, allOptions.length - 1);
                        updateHighlight();
                        break;
                    
                    case 'ArrowUp':
                        e.preventDefault();
                        highlightedIndex = Math.max(highlightedIndex - 1, -1);
                        updateHighlight();
                        break;
                    
                    case 'Enter':
                        e.preventDefault();
                        if (highlightedIndex >= 0 && allOptions[highlightedIndex]) {
                            selectOption(allOptions[highlightedIndex]);
                        }
                        break;
                    
                    case 'Escape':
                        hideDropdown();
                        searchInput.blur();
                        break;
                }
            }

            // Update highlighted option
            function updateHighlight() {
                allOptions.forEach((option, index) => {
                    option.classList.toggle('highlighted', index === highlightedIndex);
                });

                // Scroll highlighted option into view
                if (highlightedIndex >= 0 && allOptions[highlightedIndex]) {
                    allOptions[highlightedIndex].scrollIntoView({
                        block: 'nearest',
                        behavior: 'smooth'
                    });
                }
            }

            // Event listeners
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value;
                showDropdown();
                filterOptions(searchTerm);
                toggleClearButton();
            });

            searchInput.addEventListener('focus', function() {
                showDropdown();
                filterOptions(this.value);
                toggleClearButton();
            });

            // Clear button event listener
            clearButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                clearSearch();
            });

            searchInput.addEventListener('keydown', handleKeyboard);

            // Click on dropdown options
            dropdown.addEventListener('click', function(e) {
                const option = e.target.closest('.student-option');
                if (option) {
                    selectOption(option);
                }
            });

            // Click outside to close dropdown
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    hideDropdown();
                }
            });

            // Initialize dropdown with current data
            updateDropdownOptions();
            
            // Initialize clear button state
            toggleClearButton();
        }

        function initializeApp() {
            // Wait for Firebase to be ready
            if (!window.firebase) {
                setTimeout(initializeApp, 100);
                return;
            }
            
            // Initialize theme
            initializeTheme();
            
            // Load fraud protection data (MUST be loaded before other initializations)
            loadFraudProtectionData();
            
            // Load penalty settings and penalties data
            loadPenaltySettings();
            loadPenaltiesData();
            
            // Load saved data from Firestore (preferred) with localStorage fallback
            loadDataFromFirestore();
            
            // Temporarily disable real-time listener to avoid WebChannel errors
            // setupRealtimeListener();
            console.log('ðŸ”¥ Real-time listener temporarily disabled - use manual refresh');
            
            // Initialize Firebase UI
            initializeFirebaseUI();
            
            // Initialize geolocation
            initializeGeolocation();
            
            // Set up event listeners
            // Memory Leak Prevention: Store intervals for cleanup
            window.appIntervals = {
                timeUpdate: null,
                locationTimestamp: null,
                fraudProtection: null,
                submissionPatterns: null,
                locationConsistency: null,
                historyCleanup: null
            };
            
            setupEventListeners();
            
            // Start time updates
            updateCurrentTime();
            window.appIntervals.timeUpdate = setInterval(updateCurrentTime, 1000);
            
            // Start location timestamp updates
            window.appIntervals.locationTimestamp = setInterval(updateLocationTimestamps, 1000);
            
            // Update fraud protection status
            updateFraudProtectionUI();
            window.appIntervals.fraudProtection = setInterval(updateFraudProtectionUI, 60000); // Update every 60 seconds (less frequent)
            
            // Populate filter dropdowns
            populateFilterDropdowns();
            
            // Initialize student management
            initializeStudentManagement();
            
            // Initialize admin UI
            updateAdminUI();
            
            // Initialize collapsible sections
            initializeCollapsibleSections();
            
            // Analytics filter event listener
            const analyticsFilter = document.getElementById('analyticsFilter');
            if (analyticsFilter) {
                analyticsFilter.addEventListener('change', generateAnalytics);
            }
            
            // Penalties filter event listener
            const penaltiesFilter = document.getElementById('penaltiesFilter');
            if (penaltiesFilter) {
                penaltiesFilter.addEventListener('change', generatePenalties);
            }
            
            // Update initial statistics
            updateStatistics();
            
            showMessage('âœ… Attendance Tracker ready! Location will be requested automatically.', 'success');
        }

        function setupEventListeners() {
            // Prevent multiple event listener setup
            if (window.eventListenersSetup) {
                console.log('âš ï¸ Event listeners already set up, skipping...');
                return;
            }
            
            // Add null checks for all elements before adding event listeners
            console.log('ðŸ”§ Setting up event listeners...');
            
            // Form submission
            if (elements.form) {
                elements.form.addEventListener('submit', handleFormSubmit);
                console.log('âœ… Form event listener added');
            } else {
                console.error('âŒ Form element not found');
            }
            
            // Attendance buttons
            if (elements.presentBtn) {
                elements.presentBtn.addEventListener('click', () => setAttendanceStatus('present'));
                console.log('âœ… Present button event listener added');
            } else {
                console.error('âŒ Present button element not found');
            }
            
            if (elements.absentBtn) {
                elements.absentBtn.addEventListener('click', () => setAttendanceStatus('absent'));
                console.log('âœ… Absent button event listener added');
            } else {
                console.error('âŒ Absent button element not found');
            }
            
            // Date filter type change
            if (elements.dateFilterType) {
                elements.dateFilterType.addEventListener('change', function() {
                    const isRange = this.value === 'range';
                    if (elements.singleDateFilter && elements.dateRangeFilter) {
                        elements.singleDateFilter.style.display = isRange ? 'none' : 'block';
                        elements.dateRangeFilter.style.display = isRange ? 'block' : 'none';
                    }
                    if (isRange) {
                        if (elements.filterDate) elements.filterDate.value = '';
                    } else {
                        if (elements.filterDateStart) elements.filterDateStart.value = '';
                        if (elements.filterDateEnd) elements.filterDateEnd.value = '';
                    }
                    applyFilters();
                });
                console.log('âœ… Date filter event listener added');
            } else {
                console.warn('âš ï¸ Date filter type element not found');
            }
            
            // Add keyboard support for attendance buttons
            if (elements.presentBtn) {
                elements.presentBtn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        setAttendanceStatus('present');
                    }
                });
            }
            
            if (elements.absentBtn) {
                elements.absentBtn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        setAttendanceStatus('absent');
                    }
                });
            }
            
            // Student selection change - reset attendance status
            if (elements.student) {
                elements.student.addEventListener('change', () => {
                    if (elements.presentBtn) elements.presentBtn.classList.remove('selected');
                    if (elements.absentBtn) elements.absentBtn.classList.remove('selected');
                    if (elements.attendanceStatus) elements.attendanceStatus.value = '';
                    if (elements.submitText) elements.submitText.textContent = 'Record Attendance';
                    
                    // Reset submit button styling
                    if (elements.submitBtn) {
                        elements.submitBtn.style.background = '';
                        elements.submitBtn.style.boxShadow = '';
                        elements.submitBtn.style.transform = '';
                    }
                    
                    selectedAttendanceStatus = null;
                });
                console.log('âœ… Student selection event listener added');
            } else {
                console.error('âŒ Student selection element not found');
            }
            
            // Action buttons - with null checks
            if (elements.viewRecordsBtn) {
                elements.viewRecordsBtn.addEventListener('click', () => {
                    elements.viewRecordsBtn.disabled = true;
                    setTimeout(() => elements.viewRecordsBtn.disabled = false, 1000);
                    toggleRecordsView();
                });
                console.log('âœ… View records button event listener added');
            } else {
                console.warn('âš ï¸ View records button not found');
            }

            if (elements.viewAnalyticsBtn) {
                elements.viewAnalyticsBtn.addEventListener('click', () => {
                    elements.viewAnalyticsBtn.disabled = true;
                    setTimeout(() => elements.viewAnalyticsBtn.disabled = false, 1000);
                    toggleAnalyticsView();
                });
                console.log('âœ… View analytics button event listener added');
            } else {
                console.warn('âš ï¸ View analytics button not found');
            }
            
            // View Penalties Button
            if (elements.viewPenaltiesBtn) {
                elements.viewPenaltiesBtn.addEventListener('click', () => {
                    elements.viewPenaltiesBtn.disabled = true;
                    setTimeout(() => elements.viewPenaltiesBtn.disabled = false, 1000);
                    togglePenaltiesView();
                });
                console.log('âœ… View penalties button event listener added');
            } else {
                console.warn('âš ï¸ View penalties button not found');
            }
            
            if (elements.downloadBtn) {
                elements.downloadBtn.addEventListener('click', downloadExcel);
                console.log('âœ… Download button event listener added');
            } else {
                console.warn('âš ï¸ Download button not found');
            }
            
            if (elements.sendEmailBtn) {
                elements.sendEmailBtn.addEventListener('click', sendEmailReport);
                console.log('âœ… Send email button event listener added');
            } else {
                console.warn('âš ï¸ Send email button not found');
            }
            
            // Email form button
            console.log('Setting up openEmailFormBtn event listener');
            console.log('elements.openEmailFormBtn:', elements.openEmailFormBtn);
            if (elements.openEmailFormBtn) {
                elements.openEmailFormBtn.addEventListener('click', function() {
                    console.log('Email button clicked!');
                    openEmailForm();
                });
                console.log('âœ… Email form button event listener added');
            } else {
                console.warn('âš ï¸ Email form button not found');
            }
            
            // Email form event listeners
            if (elements.emailReportForm) {
                elements.emailReportForm.addEventListener('submit', handleEmailFormSubmit);
                console.log('âœ… Email form event listener added');
            } else {
                console.warn('âš ï¸ Email report form not found');
            }
            
            if (elements.reportType) {
                elements.reportType.addEventListener('change', handleReportTypeChange);
            }
            
            // PDF Export button
            if (elements.exportAnalyticsPdfBtn) {
                elements.exportAnalyticsPdfBtn.addEventListener('click', exportAnalyticsToPDF);
            } else {
                console.warn('âš ï¸ PDF export button not found');
            }
            
            elements.clearBtn.addEventListener('click', () => {
                elements.clearBtn.disabled = true;
                setTimeout(() => elements.clearBtn.disabled = false, 1000);
                clearAllData();
            });
            
            // Filters
            elements.applyFilters.addEventListener('click', applyFilters);
            
            // Student Management
            setupStudentManagementListeners();
            
            // Real-time datetime update
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Detect when user manually edits datetime
            if (elements.dateTime) {
                elements.dateTime.addEventListener('input', () => {
                    dateTimeUserEdited = true;
                    console.log('ðŸ“… User manually edited datetime, stopping auto-update');
                });
                
                elements.dateTime.addEventListener('change', () => {
                    dateTimeUserEdited = true;
                    console.log('ðŸ“… User changed datetime, stopping auto-update');
                });
                
                // Reset when form is submitted
                if (elements.form) {
                    elements.form.addEventListener('submit', () => {
                        dateTimeUserEdited = false;
                        console.log('ðŸ“… Form submitted, resuming auto-update for next entry');
                    });
                }
            }
            
            // Character counter for notes
            // Notes field is now a dropdown, no character counter needed
            const notesField = document.getElementById('notes');
            // No event listener needed for dropdown
            
            // Anti-fraud monitoring
            setupAntiFraudMonitoring();
            
            // Mark event listeners as set up
            window.eventListenersSetup = true;
            console.log('âœ… All event listeners set up successfully!');
        }

        // Anti-Fraud Protection System  
        function setupAntiFraudMonitoring() {
            // Monitor rapid submissions with proper cleanup
            window.appIntervals.submissionPatterns = setInterval(checkSubmissionPatterns, 60000); // Check every minute
            
            // Monitor location consistency
            window.appIntervals.locationConsistency = setInterval(validateLocationConsistency, 120000); // Check every 2 minutes
            
            // Clean old submission history
            window.appIntervals.historyCleanup = setInterval(cleanSubmissionHistory, 3600000); // Clean every hour
        }
        
        // Cleanup function to prevent memory leaks
        function cleanupAppIntervals() {
            try {
                if (window.appIntervals) {
                    Object.keys(window.appIntervals).forEach(key => {
                        if (window.appIntervals[key]) {
                            clearInterval(window.appIntervals[key]);
                            window.appIntervals[key] = null;
                        }
                    });
                }
                
                // Clean location watchers
                if (typeof watchId !== 'undefined' && watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                if (typeof locationWatchId !== 'undefined' && locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                }
                if (typeof autoRefreshInterval !== 'undefined' && autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            } catch (error) {
                console.warn('Cleanup function encountered an error:', error);
            }
        }
        
        // Add cleanup on page unload
        window.addEventListener('beforeunload', cleanupAppIntervals);

        function validateSubmission() {
            const now = Date.now();
            const timeSinceLastSubmission = now - lastSubmissionTime;
            const selectedStudent = elements.student.value;
            
            // All cooldown checks removed - instant submissions allowed
            
            // Check 3: Hourly submission limit - DISABLED (infinite submissions allowed)
            hourlySubmissions = hourlySubmissions.filter(time => now - time < 3600000); // Keep only last hour for tracking
            // Hourly limit check removed - unlimited submissions now allowed
            
            // Check 4: GPS accuracy requirement (enhanced for indoor use)
            if (!currentPosition) {
                showMessage(`ðŸ“ Location not available. Please enable location services and wait for GPS acquisition.`, 'error');
                return false;
            }
            
            if (currentPosition.coords.accuracy > MIN_LOCATION_ACCURACY) {
                const accuracy = currentPosition.coords.accuracy.toFixed(1);
                const maxKm = (MIN_LOCATION_ACCURACY/1000).toFixed(1);
                showMessage(`ðŸ“ Location accuracy (${accuracy}m) exceeds limit. Maximum ${maxKm}km radius allowed. Try moving to an open area or enable high-accuracy mode.`, 'warning');
                return false;
            }
            
            // Check 5: Location consistency (prevent spoofing)
            if (!validateLocationHistory()) {
                return false;
            }
            
            // Check 6: Time-based validation (prevent backdating)
            const submissionTime = new Date(elements.dateTime.value);
            const currentTime = new Date();
            const timeDiff = Math.abs(currentTime - submissionTime);
            
            if (timeDiff > 300000) { // 5 minutes tolerance
                showMessage('â° Submission time is too far from current time. Please refresh and try again.', 'warning');
                return false;
            }
            
            // Check 7: Detect suspicious patterns
            if (detectSuspiciousPattern()) {
                return false;
            }
            
            return true;
        }

        function validateLocationHistory() {
            if (!currentPosition) return false;
            
            const currentLat = currentPosition.coords.latitude;
            const currentLng = currentPosition.coords.longitude;
            const now = Date.now();
            
            // Add current location to history
            locationHistory.push({
                lat: currentLat,
                lng: currentLng,
                timestamp: now,
                accuracy: currentPosition.coords.accuracy
            });
            
            // Keep only last 10 locations
            locationHistory = locationHistory.slice(-10);
            
            // Check for impossible travel (teleportation detection)
            if (locationHistory.length >= 2) {
                const lastLocation = locationHistory[locationHistory.length - 2];
                const distance = calculateDistance(lastLocation.lat, lastLocation.lng, currentLat, currentLng);
                const timeElapsed = (now - lastLocation.timestamp) / 1000 / 60; // minutes
                const speed = distance / timeElapsed; // km/minute
                
                // If traveling faster than 5 km/minute (300 km/h), it's suspicious
                if (speed > 5 && distance > 1) { // Only check if distance > 1km
                    showMessage('ðŸš¨ Suspicious location change detected. GPS spoofing or rapid travel detected.', 'error');
                    logSuspiciousActivity(`Impossible travel: ${distance.toFixed(2)}km in ${timeElapsed.toFixed(1)} minutes`);
                    suspiciousActivity = true;
                    return false;
                }
            }
            
            return true;
        }

        function detectSuspiciousPattern() {
            const now = Date.now();
            
            // Check for consecutive submissions (bulk submission pattern)
            consecutiveSubmissions++;
            
            if (consecutiveSubmissions > 3) {
                const avgInterval = hourlySubmissions.length > 1 ? 
                    (now - hourlySubmissions[0]) / hourlySubmissions.length : 0;
                
                if (avgInterval < 60000) { // Less than 1 minute average
                    showMessage('ðŸš¨ Bulk submission pattern detected. Please record attendance naturally with normal intervals.', 'error');
                    logSuspiciousActivity('Rapid consecutive submissions detected');
                    suspiciousActivity = true;
                    return true;
                }
            }
            
            // Reset consecutive counter after 5 minutes of no submissions
            setTimeout(() => {
                consecutiveSubmissions = Math.max(0, consecutiveSubmissions - 1);
            }, 300000);
            
            return false;
        }

        function logSuspiciousActivity(reason) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                reason: reason,
                location: currentPosition ? {
                    lat: currentPosition.coords.latitude,
                    lng: currentPosition.coords.longitude,
                    accuracy: currentPosition.coords.accuracy
                } : null,
                userAgent: navigator.userAgent,
                submissionCount: submissionCount
            };
            
            // Store in localStorage for admin review
            const existingLogs = JSON.parse(localStorage.getItem('suspiciousActivity') || '[]');
            existingLogs.push(logEntry);
            
            // Keep only last 50 log entries
            if (existingLogs.length > 50) {
                existingLogs.splice(0, existingLogs.length - 50);
            }
            
            localStorage.setItem('suspiciousActivity', JSON.stringify(existingLogs));
            
            console.warn('Suspicious activity logged:', logEntry);
        }

        function checkSubmissionPatterns() {
            // Reset suspicious activity flag after 1 hour of clean behavior
            if (suspiciousActivity) {
                const lastHourSubmissions = hourlySubmissions.filter(time => 
                    Date.now() - time < 3600000
                );
                
                if (lastHourSubmissions.length === 0) {
                    suspiciousActivity = false;
                    // Removed annoying "Normal" status message
                }
            }
        }

        function validateLocationConsistency() {
            // Check if user has been in the same general area
            if (locationHistory.length >= 3) {
                const recent = locationHistory.slice(-3);
                const maxDistance = Math.max(...recent.map((loc, i) => {
                    if (i === 0) return 0;
                    return calculateDistance(
                        recent[0].lat, recent[0].lng,
                        loc.lat, loc.lng
                    );
                }));
                
                // If consistently in same area (within 1km), it's probably legitimate
                if (maxDistance < 1) {
                    // Reward consistent location with reduced cooldown
                    // This encourages legitimate use
                }
            }
        }

        function cleanSubmissionHistory() {
            const oneHourAgo = Date.now() - 3600000;
            hourlySubmissions = hourlySubmissions.filter(time => time > oneHourAgo);
        }

        // Cache for performance optimization
        let lastStatusUpdate = 0;
        let cachedStatus = '';
        let cachedRemainingSubmissions = MAX_HOURLY_SUBMISSIONS;

        function showFraudProtectionStatus() {
            const now = Date.now();
            
            // Only recalculate if it's been more than 5 seconds since last update
            if (now - lastStatusUpdate < 5000 && cachedStatus) {
                return cachedStatus;
            }
            
            const statusMessages = [];
            
            // Clean up old submissions first (only if needed)
            const initialLength = hourlySubmissions.length;
            hourlySubmissions = hourlySubmissions.filter(time => now - time < 3600000);
            
            if (suspiciousActivity) {
                statusMessages.push('ðŸš¨ Enhanced monitoring active');
            }
            
            // Remove hourly submission limit display since it's now infinite
            statusMessages.push(`ðŸ“Š Ready for unlimited submissions`);
            
            // Only add GPS status if we have a position
            if (currentPosition) {
                const accuracy = currentPosition.coords.accuracy;
                if (accuracy <= MIN_LOCATION_ACCURACY) {
                    statusMessages.push(`ðŸ“ GPS: Good (${accuracy.toFixed(0)}m)`);
                } else {
                    statusMessages.push(`ðŸ“ GPS: Fair (${accuracy.toFixed(0)}m)`);
                }
            } else {
                statusMessages.push(`ðŸ“ GPS: Waiting...`);
            }
            
            // Cooldown display removed - no waiting time required
            
            cachedStatus = statusMessages.join('\n');
            lastStatusUpdate = now;
            
            return cachedStatus;
        }

        // Cooldown timer functions removed - no waiting time required

        function updateFraudProtectionUI() {
            const statusElement = document.getElementById('fraudStatusText');
            if (!statusElement) return;
            
            const newStatus = showFraudProtectionStatus();
            
            // Only update DOM if status actually changed
            if (statusElement.innerHTML !== newStatus.replace(/\n/g, '<br>')) {
                statusElement.innerHTML = newStatus.replace(/\n/g, '<br>');
            }
            
            // Update status color based on protection level (only if needed)
            const statusContainer = document.getElementById('fraudProtectionStatus');
            if (!statusContainer) return;
            
            let newBorderColor = '#27ae60'; // Default green - unlimited submissions
            let newBackgroundColor = '#e8f5e8';
            
            if (suspiciousActivity) {
                newBorderColor = '#e74c3c'; // Red for suspicious
                newBackgroundColor = '#ffebee';
            }
            // Removed hourly submission count warning since limit is now infinite
            
            // Only update styles if they changed
            if (statusContainer.style.borderLeftColor !== newBorderColor) {
                statusContainer.style.borderLeftColor = newBorderColor;
                statusContainer.style.backgroundColor = newBackgroundColor;
            }
        }

        function toggleFraudProtectionDetails() {
            const details = document.getElementById('fraudStatusDetails');
            const toggleBtn = document.getElementById('toggleFraudStatus');
            const icon = toggleBtn.querySelector('i');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                details.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Admin function to view suspicious activity logs
        function viewSuspiciousActivityLogs() {
            const logs = JSON.parse(localStorage.getItem('suspiciousActivity') || '[]');
            
            if (logs.length === 0) {
                showMessage('No suspicious activity detected. System is clean! âœ…', 'success');
                return;
            }
            
            let logDisplay = `ðŸš¨ SUSPICIOUS ACTIVITY LOG (${logs.length} entries)\n\n`;
            
            logs.slice(-10).reverse().forEach((log, index) => {
                const date = new Date(log.timestamp).toLocaleString();
                logDisplay += `${index + 1}. ${date}\n`;
                logDisplay += `   Reason: ${log.reason}\n`;
                logDisplay += `   Submissions: ${log.submissionCount}\n`;
                if (log.location) {
                    logDisplay += `   Location: ${log.location.lat.toFixed(4)}, ${log.location.lng.toFixed(4)} (Â±${log.location.accuracy.toFixed(1)}m)\n`;
                }
                logDisplay += '\n';
            });
            
            // Show in modal or alert
            alert(logDisplay);
        }

        // Admin function to clear suspicious activity logs
        function clearSuspiciousActivityLogs() {
            if (confirm('Clear all suspicious activity logs? This action cannot be undone.')) {
                localStorage.removeItem('suspiciousActivity');
                suspiciousActivity = false;
                showMessage('Suspicious activity logs cleared', 'success');
                updateFraudProtectionUI();
            }
        }

        // Theme Management Functions
        function initializeTheme() {
            // Check for saved theme preference or default to light
            const savedTheme = localStorage.getItem('attendance-tracker-theme');
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            } else {
                isDarkMode = false;
                document.documentElement.removeAttribute('data-theme');
                updateThemeIcon();
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('attendance-tracker-theme', 'dark');
                showMessage('Switched to dark mode', 'info');
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('attendance-tracker-theme', 'light');
                showMessage('Switched to light mode', 'info');
            }
            
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                if (isDarkMode) {
                    themeIcon.className = 'fas fa-sun';
                    themeIcon.style.transform = 'rotate(180deg)';
                } else {
                    themeIcon.className = 'fas fa-moon';
                    themeIcon.style.transform = 'rotate(0deg)';
                }
            }
        }

        // Student Management Functions
        function initializeStudentManagement() {
            // Load active students from storage or use defaults
            loadActiveStudents();
            
            // Update student names for backward compatibility
            studentNames = {...activeStudents};
            
            // Populate the student dropdown
            populateStudentDropdown();
            
            // Update the student management panel
            updateStudentsList();
        }

        function loadActiveStudents() {
            try {
                const saved = localStorage.getItem('activeStudents');
                if (saved) {
                    activeStudents = JSON.parse(saved);
                } else {
                    // Use default students for first time
                    activeStudents = {...defaultStudentNames};
                    saveActiveStudents();
                }
            } catch (error) {
                console.error('Error loading active students:', error);
                activeStudents = {...defaultStudentNames};
                saveActiveStudents();
            }
        }

        function saveActiveStudents() {
            try {
                localStorage.setItem('activeStudents', JSON.stringify(activeStudents));
                // Update studentNames for backward compatibility
                studentNames = {...activeStudents};
            } catch (error) {
                console.error('Error saving active students:', error);
                showMessage('Error saving student data', 'error');
            }
        }

        function populateStudentDropdown() {
            const studentSelect = elements.student;
            const studentDropdown = document.getElementById('studentDropdown');
            if (!studentSelect || !studentDropdown) return;

            // Clear current options
            studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
            studentDropdown.innerHTML = '<div class="student-option" data-value="">-- Select Student --</div>';

            // Add active students with ID and name display
            Object.keys(activeStudents).sort().forEach(key => {
                // Add to hidden select (for form submission)
                const option = document.createElement('option');
                option.value = key;
                
                // Handle both old string format and new object format
                let displayText;
                if (typeof activeStudents[key] === 'string') {
                    displayText = activeStudents[key]; // Legacy format
                } else {
                    displayText = `${activeStudents[key].id} - ${activeStudents[key].name}`;
                }
                option.textContent = displayText;
                studentSelect.appendChild(option);

                // Add to searchable dropdown
                const dropdownOption = document.createElement('div');
                dropdownOption.className = 'student-option';
                dropdownOption.setAttribute('data-value', key);
                dropdownOption.textContent = displayText;
                studentDropdown.appendChild(dropdownOption);
            });

            // Also update filter dropdown if it exists
            updateFilterStudentDropdown();
            
            // Reinitialize searchable dropdown after population
            if (typeof initializeSearchableDropdown === 'function') {
                setTimeout(() => initializeSearchableDropdown(), 100);
            }
        }

        function updateFilterStudentDropdown() {
            const filterStudent = elements.filterEmployee; // Keep same element name for backward compatibility
            if (!filterStudent) return;

            const currentValue = filterStudent.value;
            filterStudent.innerHTML = '<option value="">All Students</option>';

            console.log('DROPDOWN DEBUG - activeStudents:', activeStudents);

            // Get unique students from actual attendance data
            const studentsFromData = new Set();
            if (attendanceData && attendanceData.length > 0) {
                attendanceData.forEach(record => {
                    if (record.studentName) studentsFromData.add(record.studentName);
                    if (record.studentId) studentsFromData.add(record.studentId);
                    if (record.student) studentsFromData.add(record.student);
                });
            }

            console.log('DROPDOWN DEBUG - students from data:', Array.from(studentsFromData));

            // Use students from activeStudents if available, otherwise from data
            if (Object.keys(activeStudents).length > 0) {
                Object.keys(activeStudents).sort().forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    
                    // Handle both old string format and new object format
                    if (typeof activeStudents[key] === 'string') {
                        option.textContent = activeStudents[key]; // Legacy format - just the name
                        console.log(`DROPDOWN DEBUG - Legacy: ${key} = "${activeStudents[key]}"`);
                    } else {
                        option.textContent = `${activeStudents[key].id} - ${activeStudents[key].name}`;
                        console.log(`DROPDOWN DEBUG - New: ${key} = "${activeStudents[key].id} - ${activeStudents[key].name}"`);
                    }
                    
                    filterStudent.appendChild(option);
                });
            } else {
                // Fallback: use students from attendance data
                Array.from(studentsFromData).sort().forEach(studentName => {
                    const option = document.createElement('option');
                    option.value = studentName;
                    option.textContent = studentName;
                    filterStudent.appendChild(option);
                });
            }

            // Restore previous selection if still valid
            if (currentValue && activeStudents[currentValue]) {
                filterStudent.value = currentValue;
            }
        }

        function setupStudentManagementListeners() {
            // Manage students button - direct access, no password needed
            if (elements.manageStudentsBtn) {
                console.log('âœ… Manage students button found, adding event listener');
                elements.manageStudentsBtn.addEventListener('click', (event) => {
                    console.log('ðŸ”§ Manage students button clicked!');
                    event.preventDefault();
                    event.stopPropagation();
                    toggleStudentManagementPanel();
                });
            } else {
                console.error('âŒ Manage students button not found!');
            }

            // Close panel button
            if (elements.closeStudentPanel) {
                elements.closeStudentPanel.addEventListener('click', closeStudentManagementPanel);
            }

            // Add student button
            if (elements.addStudentBtn) {
                elements.addStudentBtn.addEventListener('click', addNewStudent);
            }

            // Enter key support for add student inputs
            if (elements.newStudentId) {
                elements.newStudentId.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addNewStudent();
                    }
                });
                
                // Input validation
                elements.newStudentId.addEventListener('input', validateStudentInputs);
            }
            
            if (elements.newStudentName) {
                elements.newStudentName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addNewStudent();
                    }
                });
                
                // Input validation
                elements.newStudentName.addEventListener('input', validateStudentInputs);
            }
        }

        // Prevent rapid toggling
        let isToggling = false;
        
        function toggleStudentManagementPanel() {
            console.log('ðŸ”§ toggleStudentManagementPanel called');
            
            // Prevent rapid clicking
            if (isToggling) {
                console.log('âš ï¸ Still toggling, ignoring click');
                return;
            }
            
            isToggling = true;
            
            const panel = elements.studentManagementPanel;
            const button = document.querySelector('.manage-students-btn');
            console.log('ðŸ”§ Panel element:', panel);
            console.log('ðŸ”§ Button element:', button);
            
            if (!panel) {
                console.error('âŒ Student management panel not found!');
                isToggling = false;
                return;
            }

            console.log('ðŸ”§ Panel current display:', panel.style.display);
            
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                console.log('âœ… Panel shown');
                
                // Update button appearance
                if (button) {
                    button.style.backgroundColor = '#0056b3';
                    button.style.color = 'white';
                    button.setAttribute('aria-expanded', 'true');
                    button.title = 'Hide Student Management';
                }
                
                updateStudentsList();
                // Focus on the input
                setTimeout(() => {
                    if (elements.newStudentName) {
                        elements.newStudentName.focus();
                    }
                    isToggling = false; // Reset flag after animation
                }, 300);
            } else {
                panel.style.display = 'none';
                console.log('âœ… Panel hidden');
                
                // Reset button appearance
                if (button) {
                    button.style.backgroundColor = '';
                    button.style.color = '';
                    button.setAttribute('aria-expanded', 'false');
                    button.title = 'Manage Students';
                }
                
                setTimeout(() => {
                    isToggling = false; // Reset flag after animation
                }, 300);
            }
        }

        function closeStudentManagementPanel() {
            const panel = elements.studentManagementPanel;
            if (panel) {
                panel.style.display = 'none';
            }
            clearStudentInputs();
        }

        function clearStudentInputs() {
            if (elements.newStudentId) elements.newStudentId.value = '';
            if (elements.newStudentName) elements.newStudentName.value = '';
            validateStudentInputs();
        }

        function validateStudentInputs() {
            const idInput = elements.newStudentId;
            const nameInput = elements.newStudentName;
            const addBtn = elements.addStudentBtn;

            if (!nameInput || !addBtn) return;

            const id = idInput ? idInput.value.trim() : '';
            const name = nameInput.value.trim();

            // Validation rules
            const isNameValid = name.length >= 2;
            let isIdValid = true;
            let isIdUnique = true;

            // Check ID if provided
            if (id) {
                isIdValid = /^[A-Za-z0-9]{3,20}$/.test(id); // Allow alphanumeric, 3-20 chars
                isIdUnique = !Object.keys(activeStudents).some(key => {
                    const student = activeStudents[key];
                    if (typeof student === 'string') return false; // Legacy format
                    return student.id && student.id.toLowerCase() === id.toLowerCase();
                });
            }

            // Check name uniqueness
            const isNameUnique = !Object.keys(activeStudents).some(key => {
                const student = activeStudents[key];
                const studentName = typeof student === 'string' ? student : student.name;
                return studentName.toLowerCase() === name.toLowerCase();
            });

            // Update button state
            addBtn.disabled = !(isNameValid && isNameUnique && isIdValid && isIdUnique);

            // Show validation feedback for name
            if (name && !isNameValid) {
                nameInput.style.borderColor = '#e74c3c';
                nameInput.title = 'Name must be at least 2 characters';
            } else if (name && !isNameUnique) {
                nameInput.style.borderColor = '#f39c12';
                nameInput.title = 'A student with this name already exists';
            } else {
                nameInput.style.borderColor = '';
                nameInput.title = '';
            }

            // Show validation feedback for ID
            if (idInput) {
                if (id && !isIdValid) {
                    idInput.style.borderColor = '#e74c3c';
                    idInput.title = 'ID must be 3-20 alphanumeric characters';
                } else if (id && !isIdUnique) {
                    idInput.style.borderColor = '#f39c12';
                    idInput.title = 'This Student ID already exists';
                } else {
                    idInput.style.borderColor = '';
                    idInput.title = '';
                }
            }
        }

        function generateStudentKey(id) {
            // Use the ID as the key, or generate from name for legacy compatibility
            return id || 'LEGACY_' + Date.now();
        }

        function generateNextStudentId() {
            // Find the highest existing STU number
            let maxNum = 0;
            Object.keys(activeStudents).forEach(key => {
                const student = activeStudents[key];
                if (typeof student === 'object' && student.id) {
                    const match = student.id.match(/^STU(\d+)$/);
                    if (match) {
                        maxNum = Math.max(maxNum, parseInt(match[1]));
                    }
                }
            });
            
            // Return next available number with leading zeros
            return `STU${String(maxNum + 1).padStart(3, '0')}`;
        }

        function addNewStudent() {
            console.log('ðŸ”§ Add New Student function called');
            const idInput = elements.newStudentId;
            const nameInput = elements.newStudentName;

            console.log('ðŸ”§ ID Input:', idInput);
            console.log('ðŸ”§ Name Input:', nameInput);

            if (!nameInput) {
                console.log('ðŸ”§ Error: Name input not found');
                showMessage('Name input field not found', 'error');
                return;
            }

            const name = nameInput.value.trim();
            const providedId = idInput ? idInput.value.trim() : '';

            console.log('ðŸ”§ Name value:', name);
            console.log('ðŸ”§ ID value:', providedId);

            // Validate inputs
            if (!name) {
                showMessage('Please enter a student name', 'warning');
                return;
            }

            if (name.length < 2) {
                showMessage('Student name must be at least 2 characters', 'warning');
                return;
            }

            // Generate or use provided ID
            const studentId = providedId || generateNextStudentId();
            console.log('ðŸ”§ Generated/Used ID:', studentId);
            
            // Check for duplicate ID
            const idExists = Object.keys(activeStudents).some(key => {
                const student = activeStudents[key];
                if (typeof student === 'object' && student.id) {
                    return student.id.toLowerCase() === studentId.toLowerCase();
                }
                return false;
            });
            
            if (idExists) {
                showMessage('A student with this ID already exists', 'warning');
                return;
            }

            // Check for duplicate name
            const nameExists = Object.keys(activeStudents).some(key => {
                const student = activeStudents[key];
                const studentName = typeof student === 'string' ? student : student.name;
                return studentName.toLowerCase() === name.toLowerCase();
            });
            
            if (nameExists) {
                showMessage('A student with this name already exists', 'warning');
                return;
            }

            // Generate key from ID
            const key = generateStudentKey(studentId);

            // Add the new student
            activeStudents[key] = { id: studentId, name: name };
            saveActiveStudents();
            populateStudentDropdown();
            updateStudentsList();
            clearStudentInputs();

            showMessage(`Student "${studentId} - ${name}" added successfully!`, 'success');
        }

        function removeStudent(studentKey) {
            if (!activeStudents.hasOwnProperty(studentKey)) {
                showMessage('Student not found', 'error');
                return;
            }

            const student = activeStudents[studentKey];
            const studentName = typeof student === 'string' ? student : (student.name || 'Unknown Student');
            
            // Confirm removal
            if (!confirm(`Are you sure you want to remove "${studentName}" from the student list?\n\nThis will not delete their attendance records, but they will no longer appear in the dropdown for new entries.`)) {
                return;
            }

            // Remove the student
            delete activeStudents[studentKey];
            saveActiveStudents();
            populateStudentDropdown();
            updateStudentsList();

            showMessage(`Student "${studentName}" removed from active list`, 'success');
        }

        function updateStudentsList() {
            const list = elements.studentsList;
            if (!list) return;

            list.innerHTML = '';

            const studentKeys = Object.keys(activeStudents).sort();

            if (studentKeys.length === 0) {
                list.innerHTML = '<div class="no-students-message">No active students. Add students to get started.</div>';
                return;
            }

            studentKeys.forEach(key => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';

                const student = activeStudents[key];
                let displayText;
                
                // Handle both old string format and new object format
                if (typeof student === 'string') {
                    displayText = student; // Legacy format
                } else {
                    displayText = `${student.id} - ${student.name}`;
                }

                studentItem.innerHTML = `
                    <div class="student-info">
                        <div class="student-name">${displayText}</div>
                    </div>
                    <button class="remove-student-btn" onclick="removeStudent('${key}')" title="Remove Student">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                `;

                list.appendChild(studentItem);
            });
        }

        function restoreDefaultStudents() {
            // Restore default students immediately without confirmation
            activeStudents = {...defaultStudentNames};
            saveActiveStudents();
            populateStudentDropdown();
            updateStudentsList();
            showMessage('Default students restored successfully!', 'success');
        }

        // Admin Security Functions
        let pendingAdminAction = null;

        function requestAdminAccess(action) {
            if (isAdminMode) {
                // Already authenticated, execute action directly
                executeAdminAction(action);
                return;
            }

            // Store the pending action and show modal
            pendingAdminAction = action;
            showAdminModal();
        }

        function showAdminModal() {
            const modal = document.getElementById('adminModal');
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('adminError');
            const attemptsDiv = document.getElementById('adminAttempts');
            
            // Reset modal state
            passwordInput.value = '';
            errorDiv.style.display = 'none';
            attemptsDiv.style.display = adminAttempts > 0 ? 'block' : 'none';
            document.getElementById('attemptsCount').textContent = MAX_ATTEMPTS - adminAttempts;
            
            modal.style.display = 'flex';
            setTimeout(() => passwordInput.focus(), 100);
        }

        function closeAdminModal() {
            const modal = document.getElementById('adminModal');
            modal.style.display = 'none';
            pendingAdminAction = null;
        }

        function handleAdminKeyPress(event) {
            if (event.key === 'Enter') {
                validateAdminPassword();
            }
        }

        function validateAdminPassword() {
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('adminError');
            const errorText = document.getElementById('adminErrorText');
            const attemptsDiv = document.getElementById('adminAttempts');
            
            const enteredPassword = passwordInput.value;
            
            if (enteredPassword === getAdminPassword()) {
                // Correct password
                isAdminMode = true;
                adminAttempts = 0;
                closeAdminModal();
                executeAdminAction(pendingAdminAction);
                showMessage('Admin access granted', 'success');
                updateAdminUI();
                
                // Auto-logout after 10 minutes for security
                setTimeout(() => {
                    isAdminMode = false;
                    showMessage('Admin session expired', 'warning');
                    updateAdminUI();
                }, 600000); // 10 minutes
                
            } else {
                // Incorrect password
                adminAttempts++;
                
                if (adminAttempts >= MAX_ATTEMPTS) {
                    // Too many attempts - lock out
                    errorText.textContent = 'Too many failed attempts. Access locked for 5 minutes.';
                    errorDiv.style.display = 'flex';
                    attemptsDiv.style.display = 'none';
                    
                    // Disable the form
                    passwordInput.disabled = true;
                    document.querySelector('.admin-btn-confirm').disabled = true;
                    
                    // Reset attempts after 5 minutes
                    setTimeout(() => {
                        adminAttempts = 0;
                        passwordInput.disabled = false;
                        document.querySelector('.admin-btn-confirm').disabled = false;
                        closeAdminModal();
                    }, 300000); // 5 minutes
                    
                } else {
                    // Show error and remaining attempts
                    errorText.textContent = 'Incorrect password. Please try again.';
                    errorDiv.style.display = 'flex';
                    attemptsDiv.style.display = 'block';
                    document.getElementById('attemptsCount').textContent = MAX_ATTEMPTS - adminAttempts;
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }
        }

        function executeAdminAction(action) {
            switch(action) {
                case 'viewRecords':
                    toggleRecordsView();
                    break;
                case 'clearData':
                    clearAllData();
                    break;
                case 'manageStudents':
                    toggleStudentManagementPanel();
                    break;
                case 'viewSecurityLogs':
                    showSecurityLogsModal();
                    break;
                default:
                    console.error('Unknown admin action:', action);
            }
        }

        function showSecurityLogsModal() {
            const logs = JSON.parse(localStorage.getItem('suspiciousActivity') || '[]');
            
            let modalContent = `
                <div style="max-width: 600px; max-height: 400px; overflow-y: auto;">
                    <h3><i class="fas fa-shield-alt"></i> Security & Fraud Protection Logs</h3>
            `;
            
            if (logs.length === 0) {
                modalContent += `
                    <div style="text-align: center; padding: 20px; color: #27ae60;">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <p><strong>All Clear!</strong></p>
                        <p>No suspicious activity detected.</p>
                    </div>
                `;
            } else {
                modalContent += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                        <strong>âš ï¸ ${logs.length} suspicious activities detected</strong>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                `;
                
                logs.slice(-20).reverse().forEach((log, index) => {
                    const date = new Date(log.timestamp).toLocaleString();
                    modalContent += `
                        <div style="margin-bottom: 10px; padding: 10px; border-left: 3px solid #f39c12; background: #fafafa;">
                            <strong>${date}</strong><br>
                            <span style="color: #e74c3c;">${log.reason}</span><br>
                            <small>Submissions: ${log.submissionCount}</small>
                            ${log.location ? `<br><small>Location: ${log.location.lat.toFixed(4)}, ${log.location.lng.toFixed(4)} (Â±${log.location.accuracy.toFixed(1)}m)</small>` : ''}
                        </div>
                    `;
                });
                
                modalContent += `</div>`;
            }
            
            modalContent += `
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="clearSuspiciousActivityLogs()" style="margin-right: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-trash"></i> Clear Logs
                        </button>
                        <button onclick="closeSecurityModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            // Create and show modal
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'securityModal';
            modalOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            const modalBox = document.createElement('div');
            modalBox.style.cssText = `
                background: white; padding: 20px; border-radius: 8px; 
                box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 90%; max-height: 90%;
            `;
            modalBox.innerHTML = modalContent;
            
            modalOverlay.appendChild(modalBox);
            document.body.appendChild(modalOverlay);
        }

        function closeSecurityModal() {
            const modal = document.getElementById('securityModal');
            if (modal) {
                modal.remove();
            }
        }

        function updateAdminUI() {
            const adminButtons = ['viewRecordsBtn', 'clearBtn', 'manageStudentsBtn'];
            
            adminButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    if (isAdminMode) {
                        button.classList.add('admin-mode-active');
                        const lockIcon = button.querySelector('.admin-lock-icon');
                        if (lockIcon) {
                            lockIcon.style.display = 'none';
                        }
                    } else {
                        button.classList.remove('admin-mode-active');
                        const lockIcon = button.querySelector('.admin-lock-icon');
                        if (lockIcon) {
                            lockIcon.style.display = 'inline';
                        }
                    }
                }
            });
        }

        // Secret admin access (double-click on title)
        let secretClickCount = 0;
        function secretAdminAccess() {
            secretClickCount++;
            if (secretClickCount >= 2) {
                if (!isAdminMode) {
                    isAdminMode = true;
                    updateAdminUI();
                    showMessage('Secret admin access activated', 'success');
                    
                    // Auto-logout after 5 minutes for secret access
                    setTimeout(() => {
                        isAdminMode = false;
                        updateAdminUI();
                        showMessage('Secret admin session expired', 'warning');
                    }, 300000); // 5 minutes
                } else {
                    isAdminMode = false;
                    updateAdminUI();
                    showMessage('Admin mode deactivated', 'info');
                }
                secretClickCount = 0;
            }
            
            // Reset click count after 2 seconds
            setTimeout(() => {
                secretClickCount = 0;
            }, 2000);
        }

        function initializeGeolocation() {
            // Check for geolocation support
            if (!navigator.geolocation) {
                updateLocationStatus('Geolocation not supported by this browser', 'error');
                showMessage('Your browser does not support geolocation', 'error');
                return;
            }

            // Check for secure context (HTTPS)
            if (!window.isSecureContext && location.protocol !== 'file:') {
                updateLocationStatus('Geolocation requires HTTPS', 'error');
                showMessage('Geolocation requires a secure connection (HTTPS)', 'warning');
            }

            // Check current permission status
            checkGeolocationPermission();

            // Start location tracking automatically
            startLocationTracking();

            // Set up control event listeners
            setupLocationControls();

            updateLocationStatus('Initializing location services...', 'info');
        }

        async function checkGeolocationPermission() {
            try {
                if ('permissions' in navigator) {
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    locationPermissionStatus = permission.state;
                    
                    elements.locationPermission = document.getElementById('locationPermission');
                    elements.locationPermission.textContent = permission.state.toUpperCase();
                    elements.locationPermission.className = `permission-status ${permission.state}`;

                    // Listen for permission changes
                    permission.addEventListener('change', () => {
                        locationPermissionStatus = permission.state;
                        elements.locationPermission.textContent = permission.state.toUpperCase();
                        elements.locationPermission.className = `permission-status ${permission.state}`;
                        
                        if (permission.state === 'granted') {
                            startLocationTracking();
                        } else if (permission.state === 'denied') {
                            stopLocationTracking();
                            updateLocationStatus('Location permission denied', 'error');
                        }
                    });
                }
            } catch (error) {
                console.error('Error checking permissions:', error);
            }
        }

        function startLocationTracking() {
            updateLocationStatus('ðŸ“ Getting your location...', 'info');
            showMessage('Requesting location access...', 'info');

            // Start with a simple location request to get permission
            const standardOptions = {
                enableHighAccuracy: true,
                timeout: 30000, // Extended timeout
                maximumAge: 30000 // Allow 30-second old location for initial quick loading
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Got basic location successfully
                    handleLocationSuccess(position);
                    
                    // Start continuous tracking if enabled (default to enabled if element not accessible)
                    const continuousToggle = document.getElementById('continuousTrackingToggle');
                    if (!continuousToggle || continuousToggle.checked) {
                        startWatchingPosition();
                    }
                },
                (error) => {
                    console.warn('Standard location failed:', error);
                    handleLocationError(error);
                },
                standardOptions
            );
        }

        function startWatchingPosition() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }

            const options = getLocationOptions();
            
            watchId = navigator.geolocation.watchPosition(
                handleLocationUpdate,
                handleLocationError,
                options
            );

            updateLocationStatus('Monitoring location changes...', 'active');
        }

        function stopLocationTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            updateLocationStatus('Location tracking stopped', 'warning');
        }

        function getLocationOptions() {
            const isHighAccuracy = document.getElementById('highAccuracyToggle')?.checked ?? true;
            
            return {
                enableHighAccuracy: isHighAccuracy,
                timeout: isHighAccuracy ? 90000 : 30000, // Extended timeout for better GPS lock (90 seconds)
                maximumAge: 0, // Always get fresh readings for best accuracy
                // Additional options for better accuracy
                desiredAccuracy: 10, // Request 10-meter accuracy
                forceGPS: isHighAccuracy // Force GPS when high accuracy is enabled
            };
        }

        // Enhanced location acquisition with multiple attempts and averaging
        async function getEnhancedLocation(showProgress = true) {
            const attempts = 3;
            const positions = [];
            
            if (showProgress) {
                updateLocationStatus('ðŸŽ¯ Enhanced accuracy mode - taking multiple readings...', 'info');
                showMessage('Getting enhanced location accuracy (this may take 10-15 seconds)...', 'info');
            }
            
            // First reading - this will trigger permission if needed
            try {
                const firstPosition = await getCurrentPositionPromise({
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 0
                });
                positions.push(firstPosition);
                
                if (showProgress) {
                    showMessage(`Reading 1/${attempts} complete (${firstPosition.coords.accuracy.toFixed(1)}m)`, 'info');
                }
                
            } catch (error) {
                console.warn('First reading failed:', error.message);
                throw error; // If first reading fails, stop here
            }
            
            // Additional readings (only if first succeeded) - these won't trigger permission popups
            for (let i = 1; i < attempts; i++) {
                try {
                    // Wait 3 seconds between readings for GPS to stabilize
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    const position = await getCurrentPositionPromise({
                        enableHighAccuracy: true,
                        timeout: 20000, // Shorter timeout for subsequent readings
                        maximumAge: 0
                    });
                    
                    positions.push(position);
                    
                    if (showProgress) {
                        showMessage(`Reading ${i + 1}/${attempts} complete (${position.coords.accuracy.toFixed(1)}m)`, 'info');
                    }
                    
                } catch (error) {
                    console.warn(`Reading ${i + 1} failed:`, error.message);
                    // Continue with other readings even if one fails
                }
            }
            
            if (positions.length === 0) {
                throw new Error('Failed to get any location readings');
            }
            
            // Use the most accurate reading or average if similar accuracy
            const bestPosition = getBestPositionFromReadings(positions);
            
            if (showProgress) {
                showMessage(`âœ… Enhanced location complete! Best accuracy: ${bestPosition.coords.accuracy.toFixed(1)}m (from ${positions.length} readings)`, 'success');
            }
            
            return bestPosition;
        }

        function getBestPositionFromReadings(positions) {
            if (positions.length === 1) return positions[0];
            
            // Find the most accurate reading (lowest accuracy value)
            const mostAccurate = positions.reduce((best, current) => 
                current.coords.accuracy < best.coords.accuracy ? current : best
            );
            
            // If multiple readings have similar accuracy (within 20m), average them
            const similarAccuracy = positions.filter(p => 
                Math.abs(p.coords.accuracy - mostAccurate.coords.accuracy) <= 20
            );
            
            if (similarAccuracy.length > 1) {
                // Average the coordinates for better precision
                const avgLat = similarAccuracy.reduce((sum, p) => sum + p.coords.latitude, 0) / similarAccuracy.length;
                const avgLng = similarAccuracy.reduce((sum, p) => sum + p.coords.longitude, 0) / similarAccuracy.length;
                const avgAccuracy = similarAccuracy.reduce((sum, p) => sum + p.coords.accuracy, 0) / similarAccuracy.length;
                
                // Create averaged position
                return {
                    coords: {
                        latitude: avgLat,
                        longitude: avgLng,
                        accuracy: avgAccuracy,
                        altitude: mostAccurate.coords.altitude,
                        altitudeAccuracy: mostAccurate.coords.altitudeAccuracy,
                        heading: mostAccurate.coords.heading,
                        speed: mostAccurate.coords.speed
                    },
                    timestamp: Date.now()
                };
            }
            
            return mostAccurate;
        }

        function setupLocationControls() {
            // High accuracy toggle
            const highAccuracyToggle = document.getElementById('highAccuracyToggle');
            if (highAccuracyToggle) {
                highAccuracyToggle.addEventListener('change', (e) => {
                    isHighAccuracyEnabled = e.target.checked;
                    if (watchId !== null) {
                        startWatchingPosition(); // Restart with new options
                    }
                    showMessage(`High accuracy ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
                });
            }

            // Continuous tracking toggle
            const continuousToggle = document.getElementById('continuousTrackingToggle');
            if (continuousToggle) {
                continuousToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        startWatchingPosition();
                    } else {
                        stopLocationTracking();
                    }
                });
            }

            // Refresh location button
            const refreshBtn = document.getElementById('refreshLocationBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    // Add visual feedback
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('fa-spin');
                    refreshBtn.disabled = true;
                    
                    refreshLocation();
                    
                    // Remove visual feedback after 3 seconds
                    setTimeout(() => {
                        icon.classList.remove('fa-spin');
                        refreshBtn.disabled = false;
                    }, 3000);
                });
            }

            // Force GPS button - Most effective GPS acquisition
            const forceGPSBtn = document.getElementById('forceGPSBtn');
            if (forceGPSBtn) {
                forceGPSBtn.addEventListener('click', async (event) => {
                    try {
                        // Add visual feedback
                        const icon = forceGPSBtn.querySelector('i');
                        icon.classList.add('fa-spin');
                        forceGPSBtn.disabled = true;
                        
                        const shouldContinue = confirm(
                            'ðŸ›°ï¸ Force GPS Mode will:\n\n' +
                            'â€¢ Keep trying until accuracy is under 100m\n' +
                            'â€¢ Take up to 2 minutes\n' +
                            'â€¢ Use more battery\n' +
                            'â€¢ Work best outdoors or near windows\n\n' +
                            'Continue?'
                        );
                        
                        if (shouldContinue) {
                            await forceHighAccuracyGPS();
                        }
                    } catch (error) {
                        console.error('Force GPS error:', error);
                        showMessage('Force GPS failed - try moving outdoors or near windows', 'error');
                    } finally {
                        // Always clean up UI state
                        const icon = forceGPSBtn.querySelector('i');
                        if (icon) icon.classList.remove('fa-spin');
                        forceGPSBtn.disabled = false;
                    }
                });
            }

            // Request permission button
            const permissionBtn = document.getElementById('requestPermissionBtn');
            if (permissionBtn) {
                permissionBtn.addEventListener('click', () => {
                    requestLocationPermission();
                });
            }

            // Auto refresh toggle
            const autoRefreshToggle = document.getElementById('autoRefreshToggle');
            if (autoRefreshToggle) {
                autoRefreshToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        startAutoRefresh();
                        showMessage('Auto refresh enabled - location will update every 15 seconds for better accuracy', 'info');
                    } else {
                        stopAutoRefresh();
                        showMessage('Auto refresh disabled', 'info');
                    }
                });
            }
        }

        function refreshLocation() {
            updateLocationStatus('ðŸ“ Refreshing location...', 'info');
            showMessage('Refreshing location data...', 'info');
            
            // Check permission first
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    console.log('Geolocation permission:', result.state);
                    if (result.state === 'denied') {
                        updateLocationStatus('Location permission denied', 'error');
                        showMessage('Please enable location permission in your browser settings', 'error');
                        return;
                    }
                });
            }
            
            // Use standard refresh (fast and user-friendly)
            const options = {
                ...getLocationOptions(),
                maximumAge: 0 // Force fresh location
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('Location success:', position);
                    handleLocationSuccess(position);
                    showMessage('Location refreshed!', 'success');
                },
                (error) => {
                    console.error('Location error:', error);
                    handleLocationError(error);
                },
                options
            );
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            isAutoRefreshEnabled = true;
            autoRefreshInterval = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    refreshLocation();
                }
            }, 15000); // Reduced to 15 seconds for more frequent updates
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            isAutoRefreshEnabled = false;
        }

        function getCurrentPositionPromise(options) {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        // Force High Accuracy GPS - Keep trying until good accuracy is achieved
        async function forceHighAccuracyGPS() {
            const MAX_ATTEMPTS = 10;
            const TARGET_ACCURACY = 100; // Target accuracy in meters
            const DELAY_BETWEEN_ATTEMPTS = 5000; // 5 seconds between attempts
            
            updateLocationStatus('ðŸ›°ï¸ Force GPS Mode - Searching for satellites...', 'info');
            showMessage('ðŸ›°ï¸ Force GPS Mode started - this may take up to 2 minutes', 'info');
            
            for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
                try {
                    updateLocationStatus(`ðŸ›°ï¸ GPS attempt ${attempt}/${MAX_ATTEMPTS}...`, 'info');
                    
                    const position = await getCurrentPositionPromise({
                        enableHighAccuracy: true,
                        timeout: 15000, // 15 second timeout per attempt
                        maximumAge: 0   // Always get fresh readings
                    });
                    
                    const accuracy = position.coords.accuracy;
                    console.log(`GPS Attempt ${attempt}: ${accuracy.toFixed(1)}m accuracy`);
                    
                    // Update the display with current attempt
                    handleLocationSuccess(position);
                    
                    // Check if we've achieved target accuracy
                    if (accuracy <= TARGET_ACCURACY) {
                        updateLocationStatus(`ðŸŽ¯ Force GPS SUCCESS! ${accuracy.toFixed(1)}m accuracy achieved`, 'success');
                        showMessage(`ðŸŽ¯ Force GPS successful! Accuracy: ${accuracy.toFixed(1)}m (attempt ${attempt}/${MAX_ATTEMPTS})`, 'success');
                        return position;
                    } else {
                        showMessage(`ðŸ“¡ Attempt ${attempt}: ${accuracy.toFixed(1)}m accuracy (target: ${TARGET_ACCURACY}m)`, 'info');
                    }
                    
                    // Wait between attempts (except last attempt)
                    if (attempt < MAX_ATTEMPTS) {
                        updateLocationStatus(`â³ Waiting ${DELAY_BETWEEN_ATTEMPTS/1000}s before next GPS attempt...`, 'info');
                        await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_ATTEMPTS));
                    }
                    
                } catch (error) {
                    console.warn(`GPS Attempt ${attempt} failed:`, error.message);
                    showMessage(`âš ï¸ Attempt ${attempt} failed: ${error.message}`, 'warning');
                    
                    if (attempt < MAX_ATTEMPTS) {
                        await new Promise(resolve => setTimeout(resolve, 2000)); // Shorter delay on error
                    }
                }
            }
            
            // If we get here, all attempts failed to reach target accuracy
            const finalMessage = currentPosition 
                ? `Force GPS completed. Best accuracy achieved: ${currentPosition.coords.accuracy.toFixed(1)}m`
                : 'Force GPS failed - no GPS signal available';
            
            updateLocationStatus(finalMessage, 'warning');
            showMessage(`ðŸ“¡ ${finalMessage}. Try moving outdoors or near windows for better GPS signal.`, 'warning');
            
            throw new Error('Target GPS accuracy not achieved');
        }

        function requestLocationPermission() {
            updateLocationStatus('Requesting location permission...', 'info');
            showMessage('Requesting location access - please allow when prompted', 'info');
            
            // Use a clean permission request with minimal options for first request
            const options = {
                enableHighAccuracy: false, // Start with basic location to avoid delays
                timeout: 15000,
                maximumAge: 0 // Always fresh permission request
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    showMessage('âœ… Location permission granted successfully!', 'success');
                    handleLocationSuccess(position);
                    
                    // Start continuous tracking if enabled (default to enabled if element not accessible)
                    const continuousToggle = document.getElementById('continuousTrackingToggle');
                    if (!continuousToggle || continuousToggle.checked) {
                        startWatchingPosition();
                    }
                    
                    // Update button visibility - hide request button once permission is granted
                    const permissionBtn = document.getElementById('requestPermissionBtn');
                    if (permissionBtn) {
                        permissionBtn.style.display = 'none';
                    }
                },
                (error) => {
                    handleLocationError(error);
                    
                    // Provide user-friendly error messages
                    if (error.code === error.PERMISSION_DENIED) {
                        showMessage('âŒ Location access was denied. Click "Request Permission" to try again.', 'warning');
                        updateLocationStatus('Location permission denied - click "Request Permission" to try again', 'error');
                    } else {
                        showMessage('Location request failed. Please try again.', 'error');
                    }
                },
                options
            );
        }

        async function improveLocationAccuracy() {
            showMessage('ðŸ’¡ Analyzing your location environment...', 'info');
            
            // Detect environment and provide specific guidance
            const environment = await detectEnvironment();
            
            let improvementMessage = `
ðŸŽ¯ **GPS Accuracy Improvement Guide**

**Current Status:**
â€¢ Environment: ${environment.type}
â€¢ Accuracy: ${currentPosition ? currentPosition.coords.accuracy.toFixed(1) + 'm' : 'Unknown'}
â€¢ Location method: ${currentPosition && currentPosition.coords.accuracy <= 50 ? 'GPS satellites' : 'Network/WiFi positioning'}

**Environment Analysis:**
${environment.description}

**Recommended Actions:**
${environment.tips.slice(0, 3).join('\n')}

**Available Options:**
1. Use "Force GPS" for the most accurate location (may take up to 2 minutes)
2. Move to better location (outdoors for GPS, near windows for indoor)  
3. Enable WiFi for indoor positioning
4. Wait longer for GPS satellites to lock

**What affects accuracy:**
â€¢ GPS satellites (outdoor): 3-5m accuracy
â€¢ WiFi networks (indoor): 10-50m accuracy  
â€¢ Cell towers (backup): 100-1000m accuracy
            `;
            
            alert(improvementMessage);
        }

        async function detectEnvironment() {
            // Analyze current location characteristics to suggest improvements
            if (!currentPosition) {
                return {
                    type: "Unknown",
                    description: "No location data available",
                    tips: ["â€¢ Please allow location access first"]
                };
            }
            
            const accuracy = currentPosition.coords.accuracy;
            const hasAltitude = currentPosition.coords.altitude !== null;
            const hasSpeed = currentPosition.coords.speed !== null;
            
            // Determine environment based on accuracy and available data
            if (accuracy <= 10) {
                return {
                    type: "ðŸŒž Outdoor (Excellent GPS)",
                    description: "Strong GPS signal detected",
                    tips: [
                        "â€¢ You have excellent GPS reception!",
                        "â€¢ Current accuracy is optimal",
                        "â€¢ Consider this your reference location"
                    ]
                };
            } else if (accuracy <= 50) {
                return {
                    type: "ðŸžï¸ Outdoor (Good GPS)",
                    description: "Good GPS signal with some interference",
                    tips: [
                        "â€¢ Move away from tall buildings",
                        "â€¢ Avoid areas with thick tree cover",
                        "â€¢ Wait longer for better satellite lock"
                    ]
                };
            } else if (accuracy <= 200) {
                return {
                    type: "ðŸ˜ï¸ Urban/Suburban",
                    description: "Mixed GPS and network positioning",
                    tips: [
                        "â€¢ Try moving to open areas",
                        "â€¢ Enable WiFi for better indoor accuracy",
                        "â€¢ Avoid underground or enclosed areas"
                    ]
                };
            } else if (accuracy <= 1000) {
                return {
                    type: "ðŸ  Indoor (Network-based)",
                    description: "Primarily using WiFi and cell tower positioning",
                    tips: [
                        "â€¢ Connect to known WiFi networks",
                        "â€¢ Move closer to windows",
                        "â€¢ Enable high accuracy mode",
                        "â€¢ Consider moving outdoors for GPS"
                    ]
                };
            } else {
                return {
                    type: "ðŸ¢ Deep Indoor/Basement",
                    description: "Limited positioning accuracy",
                    tips: [
                        "â€¢ Move to upper floors if possible",
                        "â€¢ Go near windows or entrances",
                        "â€¢ Enable all location services",
                        "â€¢ Connect to WiFi networks",
                        "â€¢ Consider recording attendance outdoors"
                    ]
                };
            }
        }

        function getLocationImprovementTips() {
            return [
                "â€¢ Turn on WiFi (even if not connected)",
                "â€¢ Enable 'High Accuracy' location mode",
                "â€¢ Restart location services if needed",
                "â€¢ Clear view of sky improves GPS",
                "â€¢ Hold device steady for 30+ seconds",
                "â€¢ Close unnecessary apps using location",
                "â€¢ Ensure location permissions are granted"
            ];
        }

        function handleLocationSuccess(position) {
            currentPosition = position;
            lastKnownPosition = position;
            const { latitude, longitude, accuracy, altitude, speed, heading } = position.coords;
            const timestamp = new Date(position.timestamp);

            // Update form fields
            elements.latitude.value = latitude.toFixed(6);
            elements.longitude.value = longitude.toFixed(6);

            // Update display with comprehensive information
            updateLocationDisplay(position);
            
            // Update status
            const quality = getLocationQuality(accuracy);
            updateLocationStatus(`Location acquired (${quality.label})`, 'active');
            
            // Get address from coordinates (maps link is handled separately)
            getAddressFromCoordinates(latitude, longitude);
        }

        function handleLocationUpdate(position) {
            // Check if this is a significant position change or accuracy improvement
            if (lastKnownPosition) {
                const distance = calculateDistance(
                    lastKnownPosition.coords.latitude,
                    lastKnownPosition.coords.longitude,
                    position.coords.latitude,
                    position.coords.longitude
                );
                
                // Update if moved more than 2 meters OR accuracy improved by 5m OR new reading is much more accurate
                const accuracyImprovement = lastKnownPosition.coords.accuracy - position.coords.accuracy;
                const isMuchMoreAccurate = position.coords.accuracy < lastKnownPosition.coords.accuracy * 0.7;
                
                if (distance < 2 && accuracyImprovement < 5 && !isMuchMoreAccurate) {
                    return; // Skip minor updates
                }
            }

            handleLocationSuccess(position);
            locationUpdateCount++;
            document.getElementById('locationUpdates').textContent = locationUpdateCount;
        }

        function handleLocationError(error) {
            let message, statusClass;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied by user';
                    statusClass = 'error';
                    showMessage('Please enable location access in your browser settings', 'warning');
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable';
                    statusClass = 'warning';
                    showMessage('Unable to determine your location. Check your connection and GPS.', 'warning');
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out';
                    statusClass = 'warning';
                    showMessage('Location request took too long. Trying again...', 'info');
                    // Retry with less strict options
                    setTimeout(() => {
                        const fallbackOptions = {
                            enableHighAccuracy: false,
                            timeout: 15000,
                            maximumAge: 600000 // 10 minutes
                        };
                        navigator.geolocation.getCurrentPosition(
                            handleLocationSuccess,
                            () => showMessage('Location unavailable', 'error'),
                            fallbackOptions
                        );
                    }, 2000);
                    break;
                default:
                    message = `Location error: ${error.message}`;
                    statusClass = 'error';
                    showMessage(`Location Error: ${error.message}`, 'error');
                    break;
            }
            
            updateLocationStatus(message, statusClass);
            
            // Update permission status if needed
            if (error.code === error.PERMISSION_DENIED) {
                const permissionElement = document.getElementById('locationPermission');
                if (permissionElement) {
                    permissionElement.textContent = 'DENIED';
                    permissionElement.className = 'permission-status denied';
                }
            }
        }

        function updateLocationDisplay(position) {
            const { latitude, longitude, accuracy, altitude, speed, heading, altitudeAccuracy } = position.coords;
            const timestamp = new Date(position.timestamp);

            // Update basic coordinates
            elements.displayLatitude.textContent = latitude.toFixed(6);
            elements.displayLongitude.textContent = longitude.toFixed(6);
            elements.locationAccuracy.textContent = Math.round(accuracy);

            // Update accuracy description and icon
            updateAccuracyDisplay(accuracy);

            // Update additional data with enhanced formatting
            const altitudeElement = document.getElementById('locationAltitude');
            const altitudeAccuracyElement = document.getElementById('altitudeAccuracy');
            if (altitudeElement && altitudeAccuracyElement) {
                if (altitude !== null) {
                    altitudeElement.textContent = `${Math.round(altitude)}m`;
                    altitudeAccuracyElement.textContent = altitudeAccuracy ? `(Â±${Math.round(altitudeAccuracy)}m)` : '';
                } else {
                    altitudeElement.textContent = 'Not available';
                    altitudeAccuracyElement.textContent = '';
                }
            }

            const speedElement = document.getElementById('locationSpeed');
            const speedUnitElement = document.getElementById('speedUnit');
            if (speedElement && speedUnitElement) {
                if (speed !== null) {
                    const kmh = (speed * 3.6).toFixed(1);
                    speedElement.textContent = kmh;
                    speedUnitElement.textContent = 'km/h';
                    
                    // Add speed category
                    if (speed > 0.5) { // Moving
                        speedUnitElement.textContent += ' ðŸš¶';
                    }
                } else {
                    speedElement.textContent = 'Not available';
                    speedUnitElement.textContent = '';
                }
            }

            const headingElement = document.getElementById('locationHeading');
            const compassElement = document.getElementById('compassDirection');
            if (headingElement && compassElement) {
                if (heading !== null) {
                    headingElement.textContent = `${Math.round(heading)}Â°`;
                    const direction = getCardinalDirection(heading);
                    compassElement.textContent = `(${direction}) ${getCompassEmoji(heading)}`;
                } else {
                    headingElement.textContent = 'Not available';
                    compassElement.textContent = '';
                }
            }

            const timestampElement = document.getElementById('locationTimestamp');
            const timeAgoElement = document.getElementById('timeAgo');
            if (timestampElement && timeAgoElement) {
                timestampElement.textContent = timestamp.toLocaleTimeString();
                const now = new Date();
                const diffSeconds = Math.floor((now - timestamp) / 1000);
                timeAgoElement.textContent = getTimeAgoText(diffSeconds);
            }

            // Update quality indicator with icon and recommendation
            const qualityElement = document.getElementById('locationQuality');
            const qualityIconElement = document.getElementById('qualityIcon');
            if (qualityElement && qualityIconElement) {
                const quality = getLocationQuality(accuracy);
                qualityElement.textContent = quality.label;
                qualityElement.className = `quality-indicator ${quality.class}`;
                qualityIconElement.innerHTML = getQualityIcon(quality.class);
                
                // Show recommendation
                showLocationRecommendation(quality);
            }

            // Update map links
            updateMapLinks(latitude, longitude);

            // Update full coordinates display
            updateFullCoordinates(position);

            // Update update rate if applicable
            updateLocationRate();
        }

        function updateAccuracyDisplay(accuracy) {
            const accuracyIcon = document.getElementById('accuracyIcon');
            const accuracyDescription = document.getElementById('accuracyDescription');
            
            if (accuracyIcon && accuracyDescription) {
                let icon, description, color, tips = '';
                
                if (accuracy <= 5) {
                    icon = 'ðŸŽ¯';
                    description = 'Perfect - Excellent outdoor GPS (Survey grade)';
                    color = 'var(--success-color)';
                    tips = 'Optimal accuracy achieved!';
                } else if (accuracy <= 10) {
                    icon = ' ';
                    description = 'Excellent - Perfect outdoor GPS signal';
                    color = 'var(--success-color)';
                    tips = 'Great accuracy for all uses';
                } else if (accuracy <= 50) {
                    icon = 'âœ…';
                    description = 'Very Good - Strong GPS signal';
                    color = 'var(--success-color)';
                    tips = 'Excellent for outdoor tracking';
                } else if (accuracy <= 100) {
                    icon = 'ðŸ‘';
                    description = 'Good - Reliable GPS/Network positioning';
                    color = 'var(--primary-color)';
                    tips = 'Good for most tracking needs';
                } else if (accuracy <= 200) {
                    icon = 'ðŸ“';
                    description = 'Fair - Moderate accuracy (Urban/Suburban)';
                    color = 'var(--primary-color)';
                    tips = 'Try moving to open area for better GPS';
                } else if (accuracy <= 500) {
                    icon = 'ðŸ“±';
                    description = 'Fair - Network/WiFi positioning (Mixed environment)';
                    color = 'var(--warning-color)';
                    tips = 'Enable WiFi or move outdoors for better accuracy';
                } else if (accuracy <= 1000) {
                    icon = 'ðŸ˜ï¸';
                    description = 'Indoor/Urban - WiFi and cell tower location';
                    color = 'var(--warning-color)';
                    tips = 'Connect to WiFi networks for better indoor accuracy';
                } else if (accuracy <= 2500) {
                    icon = 'ðŸ ';
                    description = 'Indoor Mode - WiFi/Network positioning (Perfect for office/home attendance)';
                    color = '#9b59b6';
                    tips = 'âœ… Ideal for indoor attendance tracking - Normal accuracy for buildings';
                } else if (accuracy <= 5000) {
                    icon = 'ðŸ¢';
                    description = 'Deep Indoor - Building positioning (Acceptable for attendance)';
                    color = '#e67e22';
                    tips = 'Good for attendance - Try moving near windows for better signal';
                } else {
                    icon = 'âŒ';
                    description = 'Very Poor - Limited location services';
                    color = 'var(--error-color)';
                    tips = 'Check location permissions and try moving outdoors';
                }
                
                accuracyIcon.textContent = icon;
                accuracyDescription.textContent = description;
                accuracyDescription.style.color = color;
                
                // Update tooltip with improvement tips
                const accuracyElement = document.getElementById('locationAccuracy');
                if (accuracyElement) {
                    accuracyElement.title = `${accuracy.toFixed(1)}m accuracy - ${tips}`;
                }
                
                // No automatic popups - user can choose to improve GPS manually
            }
        }

        function updateMapLinks(lat, lng) {
            // Update OpenStreetMap link
            const mapLink = document.getElementById('mapLink');
            if (mapLink) {
                mapLink.href = `https://www.openstreetmap.org/#map=18/${lat}/${lng}`;
                mapLink.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }

            // Update Google Maps link
            const googleMapsLink = document.getElementById('googleMapsLink');
            if (googleMapsLink) {
                googleMapsLink.href = `https://www.google.com/maps?q=${lat},${lng}&z=18`;
            }

            // Update Apple Maps link
            const appleMapsLink = document.getElementById('appleMapsLink');
            if (appleMapsLink) {
                appleMapsLink.href = `https://maps.apple.com/?q=${lat},${lng}&z=18`;
            }
        }

        function updateFullCoordinates(position) {
            const fullCoordinatesElement = document.getElementById('fullCoordinates');
            if (fullCoordinatesElement) {
                const { latitude, longitude, accuracy, altitude, speed, heading } = position.coords;
                const timestamp = new Date(position.timestamp);
                
                // Determine location method based on accuracy
                let locationMethod = '';
                if (accuracy <= 50) {
                    locationMethod = ' (GPS)';
                } else if (accuracy <= 200) {
                    locationMethod = ' (GPS/Network)';
                } else if (accuracy <= 1000) {
                    locationMethod = ' (WiFi/Network)';
                } else {
                    locationMethod = ' (Indoor/Network)';
                }
                
                const coordString = 
                    `ðŸ“ Lat: ${latitude.toFixed(6)}Â°, Lng: ${longitude.toFixed(6)}Â°` +
                    ` | ðŸŽ¯ Accuracy: Â±${Math.round(accuracy)}m${locationMethod}` +
                    (altitude !== null ? ` | ðŸ“ Alt: ${Math.round(altitude)}m` : '') +
                    (speed !== null ? ` | ðŸš— Speed: ${(speed * 3.6).toFixed(1)}km/h` : '') +
                    (heading !== null ? ` | ðŸ§­ Heading: ${Math.round(heading)}Â°` : '') +
                    ` | ðŸ• ${timestamp.toLocaleString()}`;
                
                fullCoordinatesElement.textContent = coordString;
            }
        }

        function updateLocationRate() {
            const updateRateElement = document.getElementById('updateRate');
            if (updateRateElement && locationUpdateCount > 1) {
                const isHighAccuracy = document.getElementById('highAccuracyToggle')?.checked;
                const expectedRate = isHighAccuracy ? '~30s' : '~60s';
                updateRateElement.textContent = `(${expectedRate} interval)`;
            }
        }

        function getTimeAgoText(seconds) {
            if (seconds < 5) return '(just now) ðŸŸ¢';
            if (seconds < 30) return `(${seconds}s ago) ðŸŸ¢`;
            if (seconds < 60) return `(${seconds}s ago) ðŸŸ¡`;
            if (seconds < 300) return `(${Math.floor(seconds/60)}m ago) ðŸŸ¡`; // 5 minutes
            if (seconds < 3600) return `(${Math.floor(seconds/60)}m ago) ðŸŸ `;
            return `(${Math.floor(seconds/3600)}h ago) ðŸ”´`;
        }

        function getQualityIcon(qualityClass) {
            const icons = {
                'excellent': '<i class="fas fa-medal" style="color: var(--success-color);"></i>',
                'good': '<i class="fas fa-thumbs-up" style="color: var(--primary-color);"></i>',
                'fair': '<i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>',
                'poor': '<i class="fas fa-times-circle" style="color: var(--error-color);"></i>'
            };
            return icons[qualityClass] || '';
        }

        function getCompassEmoji(heading) {
            const directions = ['ðŸ§­N', 'ðŸ§­NE', 'ðŸ§­E', 'ðŸ§­SE', 'ðŸ§­S', 'ðŸ§­SW', 'ðŸ§­W', 'ðŸ§­NW'];
            const index = Math.round(heading / 45) % 8;
            return directions[index];
        }

        function showLocationRecommendation(quality) {
            const recommendationElement = document.getElementById('locationRecommendation');
            const recommendationText = document.getElementById('recommendationText');
            
            if (recommendationElement && recommendationText) {
                recommendationText.textContent = `${quality.icon} ${quality.recommendation}`;
                recommendationElement.className = `location-recommendation ${quality.class}`;
                recommendationElement.style.display = 'block';
                
                // Auto-hide excellent/good recommendations after 5 seconds
                if (quality.class === 'excellent' || quality.class === 'good') {
                    setTimeout(() => {
                        recommendationElement.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Copy functionality
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage(`Copied: ${text}`, 'success');
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage(`Copied: ${text}`, 'success');
            } catch (error) {
                showMessage('Copy failed - please select and copy manually', 'error');
            }
            textArea.remove();
        }

        function copyFullCoordinates() {
            const fullCoordinatesElement = document.getElementById('fullCoordinates');
            if (fullCoordinatesElement && fullCoordinatesElement.textContent !== '--') {
                copyToClipboard(fullCoordinatesElement.textContent);
            } else {
                showMessage('No coordinates available to copy', 'warning');
            }
        }

        function showPermissionHelp() {
            const helpMessage = 
                'ðŸ“ Location Permission Help:\n\n' +
                'ðŸŸ¢ GRANTED: Location access is allowed\n' +
                'ðŸ”´ DENIED: Location access is blocked\n' +
                'ðŸŸ¡ PROMPT: Browser will ask for permission\n\n' +
                'To fix denied permission:\n' +
                '1. Click the lock icon in address bar\n' +
                '2. Set Location to "Allow"\n' +
                '3. Refresh the page\n\n' +
                'For better accuracy:\n' +
                'â€¢ Enable GPS on your device\n' +
                'â€¢ Move to an open area\n' +
                'â€¢ Wait for GPS to stabilize';
            
            showMessage(helpMessage, 'info');
        }

        function updateLocationStatus(message, statusClass) {
            const statusIndicator = document.getElementById('locationStatusIndicator');
            const statusText = document.getElementById('locationStatusText');
            const locationTips = document.getElementById('locationTips');
            
            if (statusIndicator && statusText) {
                statusText.textContent = message;
                statusIndicator.className = `status-indicator ${statusClass}`;
            }

            // Show tips for poor accuracy
            if (locationTips) {
                if (message.includes('Poor') || statusClass === 'warning' || statusClass === 'error') {
                    locationTips.style.display = 'block';
                } else if (statusClass === 'active') {
                    locationTips.style.display = 'none';
                }
            }

            // Also update the header status
            if (elements.locationStatus) {
                elements.locationStatus.textContent = message;
                elements.locationStatus.style.color = getStatusColor(statusClass);
            }
        }

        function getStatusColor(statusClass) {
            const colors = {
                'active': '#27ae60',
                'error': '#e74c3c',
                'warning': '#f39c12',
                'info': '#3498db'
            };
            return colors[statusClass] || '#6c757d';
        }

        function getLocationQuality(accuracy) {
            if (accuracy <= 10) {
                return { 
                    label: 'Excellent', 
                    class: 'excellent',
                    recommendation: 'Perfect outdoor GPS signal!',
                    icon: 'ðŸŽ¯'
                };
            } else if (accuracy <= 50) {
                return { 
                    label: 'Very Good', 
                    class: 'excellent',
                    recommendation: 'Strong GPS signal - great accuracy',
                    icon: 'âœ…'
                };
            } else if (accuracy <= 200) {
                return { 
                    label: 'Good', 
                    class: 'good',
                    recommendation: 'Good accuracy for attendance tracking',
                    icon: 'ðŸ‘'
                };
            } else if (accuracy <= 1000) {
                return { 
                    label: 'Fair', 
                    class: 'fair',
                    recommendation: 'Network/WiFi location - suitable for indoor use',
                    icon: 'ðŸ“±'
                };
            } else if (accuracy <= 5000) {
                return { 
                    label: 'Indoor', 
                    class: 'indoor',
                    recommendation: 'ðŸ  Indoor Mode Active - Excellent for office/home attendance tracking',
                    icon: 'ðŸ '
                };
            } else {
                return { 
                    label: 'Poor', 
                    class: 'poor',
                    recommendation: 'No location services - check device settings',
                    icon: 'âŒ'
                };
            }
        }

        function getCardinalDirection(heading) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 
                              'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(heading / 22.5) % 16;
            return directions[index];
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        // Address Enhancement Functions
        function refreshAddress() {
            if (!currentPosition) {
                showMessage('No location available to refresh address', 'warning');
                return;
            }
            
            const lat = currentPosition.coords.latitude;
            const lng = currentPosition.coords.longitude;
            
            elements.locationAddress.textContent = 'Refreshing address...';
            showMessage('Refreshing address information...', 'info');
            
            getAddressFromCoordinates(lat, lng);
        }

        async function getAddressFromCoordinates(lat, lng) {
            try {
                // Using a free geocoding service
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
                const data = await response.json();
                
                if (data) {
                    const formattedAddress = formatAddressData(data);
                    
                    // Add accuracy context to address display
                    const accuracy = currentPosition ? currentPosition.coords.accuracy : null;
                    let addressWithContext = formattedAddress;
                    
                    if (accuracy && accuracy > 1000) {
                        addressWithContext += ` ðŸ“ (Indoor positioning - ${(accuracy/1000).toFixed(1)}km radius)`;
                    } else if (accuracy && accuracy > 200) {
                        addressWithContext += ` ðŸ“ (Network positioning - ${Math.round(accuracy)}m accuracy)`;
                    }
                    
                    elements.locationAddress.textContent = addressWithContext;
                } else {
                    elements.locationAddress.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                }
            } catch (error) {
                console.warn('Geocoding failed:', error);
                elements.locationAddress.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }

        function formatAddressData(data) {
            // Extract and clean address components with priority for detailed location
            const components = {
                street: data.road || data.street || '',
                area: data.suburb || data.neighbourhood || data.quarter || '',
                district: data.city_district || data.district || '',
                city: data.city || data.locality || data.town || data.village || '',
                region: data.principality || data.state || data.region || '',
                country: cleanCountryName(data.countryName || data.country || ''),
                // Add more specific location details
                building: data.building || data.house || '',
                postcode: data.postcode || data.postal_code || '',
                landmark: data.amenity || data.leisure || data.shop || ''
            };

            // Build address parts with priority for specific details
            const addressParts = [];
            
            // Add building/house number if available
            if (components.building) {
                addressParts.push(components.building);
            }
            
            // Add street (high priority for specific location)
            if (components.street) {
                addressParts.push(components.street);
            }
            
            // Add landmark/amenity for more context
            if (components.landmark && components.landmark !== components.street) {
                addressParts.push(components.landmark);
            }
            
            // Add area/neighborhood (important for specific location)
            if (components.area && 
                components.area !== components.street && 
                components.area !== components.landmark) {
                addressParts.push(components.area);
            }
            
            // Add district if it adds value
            if (components.district && 
                components.district !== components.area && 
                components.district !== components.city &&
                !components.area.includes(components.district)) {
                addressParts.push(components.district);
            }
            
            // Add city (always important)
            if (components.city) {
                addressParts.push(components.city);
            }
            
            // Add postcode for more precision
            if (components.postcode) {
                addressParts.push(components.postcode);
            }
            
            // Add region only if it's different from city and adds value
            if (components.region && 
                components.region !== components.city && 
                !components.city.includes(components.region) &&
                components.region.length < 20) { // Avoid very long region names
                addressParts.push(components.region);
            }
            
            // Add country (but only if we have other details, otherwise show more info)
            if (addressParts.length > 0 && components.country) {
                addressParts.push(components.country);
            }
            
            // Join with commas and clean up
            let formattedAddress = addressParts.join(', ');
            
            // Remove duplicates and clean up
            formattedAddress = removeDuplicateWords(formattedAddress);
            
            // If we don't have enough specific details, try to get more from display_name
            if (!formattedAddress || formattedAddress.length < 10 || addressParts.length < 2) {
                if (data.display_name) {
                    // Use display name but clean it and prioritize first 3-4 meaningful parts
                    const cleaned = cleanDisplayName(data.display_name);
                    if (cleaned.length > formattedAddress.length) {
                        formattedAddress = cleaned;
                    }
                }
                
                // Final fallback - but try to be more specific than just city, country
                if (!formattedAddress || formattedAddress.length < 5) {
                    if (components.city && components.country) {
                        formattedAddress = `${components.city}, ${components.country}`;
                    } else {
                        return 'Location detected';
                    }
                }
            }
            
            return formattedAddress;
        }

        function cleanCountryName(country) {
            if (!country) return '';
            
            // Remove unnecessary suffixes and clean up country names
            return country
                .replace(/\s*\(the\)\s*/gi, '') // Remove "(the)"
                .replace(/\s*\(.*?\)\s*/g, '')   // Remove any other parenthetical content
                .replace(/^the\s+/gi, '')        // Remove "the" at the beginning
                .trim();
        }

        function cleanDisplayName(displayName) {
            if (!displayName) return '';
            
            // Clean up the display name by removing unnecessary elements
            let cleaned = displayName
                .replace(/\s*\(the\)\s*/gi, '') // Remove "(the)"
                .replace(/\s*\(.*?\)\s*/g, '')   // Remove parenthetical content
                .replace(/^the\s+/gi, '');       // Remove "the" at the beginning
            
            // Split by comma and take meaningful parts
            const parts = cleaned.split(',').map(part => part.trim()).filter(part => part.length > 0);
            
            // Prioritize more specific location parts (first 2-3 parts usually most specific)
            let relevantParts = [];
            
            // Take first part (usually most specific - street/building)
            if (parts.length > 0 && parts[0].length > 2) {
                relevantParts.push(parts[0]);
            }
            
            // Take second part if it's different and adds specificity
            if (parts.length > 1 && parts[1].length > 2 && 
                !parts[0].toLowerCase().includes(parts[1].toLowerCase())) {
                relevantParts.push(parts[1]);
            }
            
            // Take third part if it's a neighborhood/area (not too generic)
            if (parts.length > 2 && parts[2].length > 2 && parts[2].length < 30 &&
                !parts[2].toLowerCase().includes('emirate') && 
                !parts[2].toLowerCase().includes('country') &&
                !relevantParts.some(part => part.toLowerCase().includes(parts[2].toLowerCase()))) {
                relevantParts.push(parts[2]);
            }
            
            // Add city if we don't have enough specificity
            if (relevantParts.length < 2 && parts.length > 3) {
                const cityPart = parts.find(part => 
                    part.toLowerCase().includes('sharjah') || 
                    part.toLowerCase().includes('dubai') ||
                    part.toLowerCase().includes('abu dhabi') ||
                    (part.length > 3 && part.length < 20)
                );
                if (cityPart && !relevantParts.includes(cityPart)) {
                    relevantParts.push(cityPart);
                }
            }
            
            // Ensure we have at least 2 parts for specificity, but not more than 4
            if (relevantParts.length < 2 && parts.length > relevantParts.length) {
                relevantParts = parts.slice(0, Math.min(3, parts.length));
            }
            relevantParts = relevantParts.slice(0, 4);
            
            return relevantParts.join(', ');
        }

        function removeDuplicateWords(address) {
            const parts = address.split(',').map(part => part.trim());
            const uniqueParts = [];
            const seen = new Set();
            
            for (const part of parts) {
                // Normalize for comparison (lowercase, no extra spaces)
                const normalized = part.toLowerCase().replace(/\s+/g, ' ');
                if (!seen.has(normalized) && part.length > 0) {
                    seen.add(normalized);
                    uniqueParts.push(part);
                }
            }
            
            return uniqueParts.join(', ');
        }

        function updateCurrentTime() {
            const now = new Date();
            elements.currentDate.textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            elements.currentTime.textContent = now.toLocaleTimeString('en-US', {
                hour12: true,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function updateLocationTimestamps() {
            if (currentPosition && currentPosition.timestamp) {
                const timeAgoElement = document.getElementById('timeAgo');
                if (timeAgoElement) {
                    const now = new Date();
                    const locationTime = new Date(currentPosition.timestamp);
                    const diffSeconds = Math.floor((now - locationTime) / 1000);
                    timeAgoElement.textContent = getTimeAgoText(diffSeconds);
                    
                    // Change color based on age
                    if (diffSeconds > 300) { // 5 minutes
                        timeAgoElement.style.color = 'var(--error-color)';
                    } else if (diffSeconds > 120) { // 2 minutes
                        timeAgoElement.style.color = 'var(--warning-color)';
                    } else {
                        timeAgoElement.style.color = 'var(--success-color)';
                    }
                }
            }
        }

        let dateTimeUserEdited = false;
        
        function updateDateTime() {
            // Only auto-update if user hasn't manually edited the datetime
            if (!dateTimeUserEdited) {
                const now = new Date();
                const isoString = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString();
                elements.dateTime.value = isoString.slice(0, 16);
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            console.log('ðŸš€ Form submission started');
            
            // Prevent multiple submissions
            if (elements.form.classList.contains('submitting')) {
                console.log('âš ï¸ Form already submitting, ignoring');
                return;
            }
            
            // Mark form as submitting
            elements.form.classList.add('submitting');
            
            // Show loading with immediate timeout fallback
            showLoading(true);
            
            // Shorter timeout for safety
            const timeoutId = setTimeout(() => {
                console.log('â° Submission timeout reached');
                showLoading(false);
                elements.form.classList.remove('submitting');
                showMessage('âš ï¸ Request timed out - attendance saved locally', 'warning');
            }, 5000); // Reduced to 5 seconds
            
            try {
                console.log('ðŸ” Validating form...');
                
                // Validate form
                if (!validateForm()) {
                    console.log('âŒ Form validation failed');
                    clearTimeout(timeoutId);
                    showLoading(false);
                    elements.form.classList.remove('submitting');
                    return;
                }
                
                console.log('âœ… Form validation passed');
                
                // Create attendance record
                const record = createAttendanceRecord();
                console.log('ðŸ“ Record created:', record);
                
                // Check for penalties if student is marked present
                let penaltyApplied = false;
                if (record.attendanceStatus === 'present') {
                    try {
                        const attendanceTime = record.time;
                        console.log('ðŸ•’ Checking penalty for time:', attendanceTime);
                        
                        if (isLateArrival(attendanceTime)) {
                            const penalty = addPenalty(record.studentName, attendanceTime, record.date);
                            penaltyApplied = true;
                            console.log('âš ï¸ Penalty applied:', penalty);
                            
                            // Add penalty info to the success message later
                            record.penaltyApplied = true;
                            record.penaltyAmount = penalty.amount;
                        }
                    } catch (penaltyError) {
                        console.error('âŒ Error applying penalty:', penaltyError);
                        // Don't block submission for penalty errors
                    }
                }
                
                // Always save locally first (primary storage)
                attendanceData.unshift(record);
                console.log('ðŸ’¾ Saved to local array');
                
                // Save to localStorage immediately
                try {
                    let localData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                    localData.unshift(record);
                    localStorage.setItem('attendanceData', JSON.stringify(localData));
                    console.log('ðŸ’¾ Saved to localStorage');
                } catch (storageError) {
                    console.error('âŒ localStorage error:', storageError);
                }
                
                // Try Firebase only if enabled and available
                let firebaseSuccess = false;
                if (window.firebase && navigator.onLine) {
                    try {
                        console.log('â˜ï¸ Attempting Firebase save...');
                        await saveDataToFirestore(record);
                        firebaseSuccess = true;
                        console.log('â˜ï¸ Firebase save successful');
                    } catch (firebaseError) {
                        console.error('â˜ï¸ Firebase error:', firebaseError);
                        // Firebase error already handled in saveDataToFirestore
                    }
                }
                
                // Show success message
                const studentInfo = activeStudents[record.student];
                let studentName = record.studentName;
                if (typeof studentInfo === 'object') {
                    studentName = `${studentInfo.id} - ${studentInfo.name}`;
                }
                
                const storageType = firebaseSuccess ? 'Cloud & Local' : 'Local Storage';
                let successMessage = `âœ… Attendance recorded for ${studentName} (${storageType})`;
                
                // Add penalty information if applicable
                if (penaltyApplied && record.penaltyAmount) {
                    successMessage += `\nâš ï¸ Late arrival penalty: ${record.penaltyAmount} ${penaltySettings.currency}`;
                    successMessage += `\nðŸ•’ Attendance not between 1 PM - 1:30 PM`;
                }
                
                showMessage(successMessage, 'success');
                console.log('âœ… Success message shown');
                
                // Reset form
                resetForm();
                console.log('ðŸ”„ Form reset');
                
                // Update displays if records are visible
                if (elements.recordsSection && elements.recordsSection.style.display !== 'none') {
                    displayRecords();
                    updateStatistics();
                    console.log('ðŸ“Š Displays updated');
                }
                
            } catch (error) {
                console.error('âŒ Submission error:', error);
                showMessage(`âŒ Error: ${error.message}`, 'error');
            } finally {
                // Always clear loading and submission state
                clearTimeout(timeoutId);
                showLoading(false);
                elements.form.classList.remove('submitting');
                console.log('ðŸ Form submission completed');
            }
        }

        function updateSubmissionTracking() {
            const now = Date.now();
            
            // Update tracking variables
            lastSubmissionTime = now;
            lastSubmittedStudent = elements.student.value;
            submissionCount++;
            hourlySubmissions.push(now);
            
            // Clean old submissions
            hourlySubmissions = hourlySubmissions.filter(time => now - time < 3600000);
            
            // Save fraud protection data to persist across page reloads
            saveFraudProtectionData();
            
            // Immediately update the UI to show new status
            cachedStatus = ''; // Clear cache to force refresh
            updateFraudProtectionUI();
        }

        function validateForm() {
            console.log('ðŸ” Starting form validation');
            
            if (!elements.student || !elements.attendanceStatus) {
                console.error('âŒ Form elements not found');
                showMessage('Form elements not properly loaded. Please refresh the page.', 'error');
                return false;
            }
            
            const student = elements.student.value;
            const attendanceStatus = elements.attendanceStatus.value;
            
            console.log('ðŸ“ Form values:', { student, attendanceStatus });
            
            if (!student) {
                showMessage('Please select a student', 'warning');
                elements.student.focus();
                return false;
            }
            
            if (!attendanceStatus) {
                showMessage('Please select Present or Absent', 'warning');
                return false;
            }
            
            if (!currentPosition) {
                showMessage('Location not available. Please wait for location to be acquired.', 'warning');
                return false;
            }
            
            console.log('âœ… Form validation passed');
            return true;
        }

        function createAttendanceRecord() {
            // Use the selected date/time from the input field, or current time as fallback
            let selectedDateTime;
            if (elements.dateTime.value && elements.dateTime.value.trim() !== '') {
                selectedDateTime = new Date(elements.dateTime.value);
                // Check if the date is valid
                if (isNaN(selectedDateTime.getTime())) {
                    selectedDateTime = new Date(); // Fallback to current time
                }
            } else {
                selectedDateTime = new Date(); // Fallback to current time
            }
            
            const coords = currentPosition.coords;
            
            // Get student information from activeStudents
            const selectedStudentKey = elements.student.value;
            const studentInfo = activeStudents[selectedStudentKey];
            
            let studentId, studentName;
            if (typeof studentInfo === 'string') {
                // Legacy format - use key as ID and string as name
                studentId = selectedStudentKey;
                studentName = studentInfo;
            } else {
                // New format with ID and name
                studentId = studentInfo.id;
                studentName = studentInfo.name;
            }
            
            return {
                id: generateId(),
                student: selectedStudentKey,
                studentId: studentId,
                studentName: studentName,
                attendanceStatus: elements.attendanceStatus.value,
                attendanceLabel: elements.attendanceStatus.value === 'present' ? 'Present' : 'Absent',
                dateTime: elements.dateTime.value,
                date: selectedDateTime.toLocaleDateString('en-US'),
                time: selectedDateTime.toLocaleTimeString('en-US', { hour12: true }),
                latitude: parseFloat(elements.latitude.value),
                longitude: parseFloat(elements.longitude.value),
                accuracy: coords.accuracy,
                altitude: coords.altitude,
                altitudeAccuracy: coords.altitudeAccuracy,
                speed: coords.speed,
                heading: coords.heading,
                locationQuality: getLocationQuality(coords.accuracy).label,
                address: elements.locationAddress.textContent,
                notes: elements.notes.value.trim(),
                timestamp: selectedDateTime.getTime(),
                locationTimestamp: currentPosition.timestamp,
                isHighAccuracy: document.getElementById('highAccuracyToggle')?.checked || false,
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language
                }
            };
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function resetForm() {
            elements.student.value = '';
            elements.attendanceStatus.value = '';
            elements.notes.value = '';
            elements.presentBtn.classList.remove('selected');
            elements.absentBtn.classList.remove('selected');
            
            selectedAttendanceStatus = null;
            
            // Reset and show full student list
            const searchInput = document.getElementById('studentSearch');
            const dropdown = document.getElementById('studentDropdown');
            const clearButton = document.getElementById('clearStudentSearch');
            
            if (searchInput && dropdown && clearButton) {
                // Clear search input
                searchInput.value = '';
                
                // Hide clear button
                clearButton.style.display = 'none';
                
                // Use setTimeout to ensure DOM is ready for dropdown manipulation
                setTimeout(() => {
                    // Show dropdown with all students
                    dropdown.classList.add('show');
                    
                    // Show all student options
                    const options = dropdown.querySelectorAll('.student-option');
                    options.forEach(option => {
                        option.style.display = 'block';
                        option.classList.remove('selected');
                        option.classList.remove('highlighted');
                    });
                    
                    // Focus on search input for immediate typing
                    searchInput.focus();
                }, 50); // Small delay to ensure proper initialization
            } else {
                // Fallback to original focus behavior if dropdown elements not found
                elements.student.focus();
            }
        }

        function toggleRecordsView() {
            const isVisible = elements.recordsSection.style.display !== 'none';
            
            if (isVisible) {
                elements.recordsSection.style.display = 'none';
                elements.viewRecordsBtn.innerHTML = '<i class="fas fa-eye"></i> View Records';
            } else {
                elements.recordsSection.style.display = 'block';
                elements.viewRecordsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Records';
                displayRecords();
                updateStatistics();
                
                // Smooth scroll to records section after showing it
                setTimeout(() => {
                    elements.recordsSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100); // Small delay to ensure the section is fully rendered
            }
        }

        function populateFilterDropdowns() {
            // Clear existing options
            elements.filterEmployee.innerHTML = '<option value="">All Students</option>';
            
            // Get unique students from attendance data or use active students
            let studentsToShow = new Map();
            
            // First, add students from attendance data
            attendanceData.forEach(record => {
                const studentKey = record.student || record.employee;
                if (studentKey && !studentsToShow.has(studentKey)) {
                    const studentInfo = activeStudents[studentKey];
                    let displayName = studentKey; // fallback
                    
                    if (typeof studentInfo === 'string') {
                        displayName = studentInfo;
                    } else if (studentInfo && studentInfo.name) {
                        displayName = studentInfo.name;
                    } else if (record.studentName) {
                        displayName = record.studentName;
                    }
                    
                    studentsToShow.set(studentKey, displayName);
                }
            });
            
            // If no attendance data, use all active students
            if (studentsToShow.size === 0) {
                Object.keys(activeStudents).forEach(studentKey => {
                    const student = activeStudents[studentKey];
                    const displayName = typeof student === 'string' ? student : (student.name || studentKey);
                    studentsToShow.set(studentKey, displayName);
                });
            }
            
            // Sort by display name and add to dropdown
            Array.from(studentsToShow.entries())
                .sort((a, b) => a[1].localeCompare(b[1]))
                .forEach(([studentKey, displayName]) => {
                    const option = document.createElement('option');
                    option.value = studentKey;
                    option.textContent = displayName;
                    elements.filterEmployee.appendChild(option);
                });
        }

        function applyFilters() {
            console.log('Apply Filters clicked');
            console.log('Filter values:', {
                date: elements.filterDate.value,
                student: elements.filterEmployee.value,
                status: elements.filterAction.value
            });
            
            const beforeCount = attendanceData.length;
            displayRecords();
            const afterCount = getFilteredRecords().length;
            
            // Show filter feedback
            if (beforeCount !== afterCount) {
                showMessage(`ðŸ” Filtered: Showing ${afterCount} of ${beforeCount} records`, 'info');
            } else if (beforeCount === 0) {
                showMessage('ðŸ“ No records to filter', 'warning');
            } else {
                showMessage(`ðŸ“Š Showing all ${beforeCount} records`, 'info');
            }
        }
        
        function clearFilters() {
            console.log('Clear Filters clicked');
            
            // Reset all filter inputs
            elements.filterDate.value = '';
            elements.filterDateStart.value = '';
            elements.filterDateEnd.value = '';
            elements.filterEmployee.value = '';
            elements.filterAction.value = '';
            
            // Reset date filter type to single
            elements.dateFilterType.value = 'single';
            elements.singleDateFilter.style.display = 'block';
            elements.dateRangeFilter.style.display = 'none';
            
            // Refresh the display and statistics
            displayRecords();
            updateStatistics();
            showMessage('ðŸ”„ Filters cleared - showing all records', 'info');
        }

        function getFilteredRecords() {
            let filtered = [...attendanceData];
            console.log('Starting with', filtered.length, 'records');
            
            // Filter by date (single date or date range)
            const isDateRange = elements.dateFilterType.value === 'range';
            if (isDateRange && (elements.filterDateStart.value || elements.filterDateEnd.value)) {
                const startDate = elements.filterDateStart.value ? new Date(elements.filterDateStart.value) : null;
                const endDate = elements.filterDateEnd.value ? new Date(elements.filterDateEnd.value) : null;
                
                if (startDate) startDate.setHours(0, 0, 0, 0);
                if (endDate) endDate.setHours(23, 59, 59, 999);
                
                console.log('Filtering by date range:', 
                    startDate ? startDate.toISOString() : 'any',
                    'to',
                    endDate ? endDate.toISOString() : 'any'
                );
                
                filtered = filtered.filter(record => {
                    if (!record.date) return true;
                    
                    try {
                        const recordDate = new Date(record.date);
                        recordDate.setHours(12, 0, 0, 0); // Set to noon to avoid timezone issues
                        
                        if (startDate && endDate) {
                            return recordDate >= startDate && recordDate <= endDate;
                        } else if (startDate) {
                            return recordDate >= startDate;
                        } else if (endDate) {
                            return recordDate <= endDate;
                        }
                        return true;
                    } catch (e) {
                        console.log('âŒ Date conversion error for:', record.date);
                        return false;
                    }
                });
            } else if (!isDateRange && elements.filterDate.value) {
                const filterDate = new Date(elements.filterDate.value);
                filterDate.setHours(0, 0, 0, 0);
                const filterEndDate = new Date(filterDate);
                filterEndDate.setHours(23, 59, 59, 999);
                
                console.log('Filtering by single date:', filterDate.toISOString());
                
                filtered = filtered.filter(record => {
                    if (!record.date) return true;
                    
                    try {
                        const recordDate = new Date(record.date);
                        return recordDate >= filterDate && recordDate <= filterEndDate;
                    } catch (e) {
                        console.log('âŒ Date conversion error for:', record.date);
                        return false;
                    }
                });
            }
            console.log('After date filter:', filtered.length, 'records');
            
            // Filter by student
            if (elements.filterEmployee.value) {
                const selectedStudent = elements.filterEmployee.value;
                console.log('Filtering by student:', selectedStudent);
                filtered = filtered.filter(record => {
                    // Check multiple student fields for better compatibility
                    const matches = (record.student === selectedStudent) || 
                                  (record.studentId === selectedStudent) ||
                                  (record.employee === selectedStudent);
                    console.log('Record student fields:', {
                        student: record.student,
                        studentId: record.studentId,
                        employee: record.employee,
                        matches: matches
                    });
                    return matches;
                });
                console.log('After student filter:', filtered.length, 'records');
            }
            
            // Filter by status - improved logic
            if (elements.filterAction.value) {
                const filterValue = elements.filterAction.value.toLowerCase();
                console.log('Filtering by status:', filterValue);
                filtered = filtered.filter(record => {
                    // Check multiple status fields with flexible matching
                    const status = (record.attendanceStatus || record.attendanceLabel || record.actionType || '').toLowerCase();
                    const matches = status.includes(filterValue) || 
                                  (filterValue === 'present' && (status === 'p' || status === '1' || status.includes('check-in'))) ||
                                  (filterValue === 'absent' && (status === 'a' || status === '0'));
                    console.log('Record status:', status, 'vs filter:', filterValue, 'matches:', matches);
                    return matches;
                });
                console.log('After status filter:', filtered.length, 'records');
            }
            
            console.log('Final filtered records:', filtered.length);
            return filtered;
        }

        // Sort state
        let currentSort = {
            column: null,
            direction: 'asc'
        };

        // Initialize sorting
        function initializeTableSorting() {
            const headers = document.querySelectorAll('.records-table th');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    if (!column) return;
                    
                    // Remove sort classes from all headers
                    headers.forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });

                    // Toggle sort direction
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }

                    // Add sort class to current header
                    header.classList.add(`sort-${currentSort.direction}`);
                    
                    displayRecords();
                });
            });
        }

        function compareValues(a, b) {
            if (a === b) return 0;
            if (a === null || a === undefined) return 1;
            if (b === null || b === undefined) return -1;
            return a < b ? -1 : 1;
        }

        function sortRecords(records) {
            if (!currentSort.column) return records;

            return records.sort((a, b) => {
                let valueA = a[currentSort.column];
                let valueB = b[currentSort.column];

                // Special handling for different columns
                if (currentSort.column === 'date') {
                    valueA = new Date(valueA).getTime();
                    valueB = new Date(valueB).getTime();
                } else if (currentSort.column === 'time') {
                    valueA = new Date('1970/01/01 ' + valueA).getTime();
                    valueB = new Date('1970/01/01 ' + valueB).getTime();
                } else if (currentSort.column === 'student') {
                    // Sort by student name alphabetically, not by ID
                    if (a.studentName && b.studentName) {
                        valueA = a.studentName.toLowerCase();
                        valueB = b.studentName.toLowerCase();
                    } else {
                        // Fallback to legacy field names if studentName doesn't exist
                        const studentInfoA = activeStudents[a.student || a.employee];
                        const studentInfoB = activeStudents[b.student || b.employee];
                        
                        if (typeof studentInfoA === 'object' && typeof studentInfoB === 'object') {
                            valueA = studentInfoA.name.toLowerCase();
                            valueB = studentInfoB.name.toLowerCase();
                        } else {
                            valueA = (studentInfoA || a.employeeName || a.student || a.employee || '').toLowerCase();
                            valueB = (studentInfoB || b.employeeName || b.student || b.employee || '').toLowerCase();
                        }
                    }
                } else if (currentSort.column === 'action') {
                    // Sort by action/status text, not by internal status values
                    let statusA, statusB;
                    
                    if (a.attendanceStatus) {
                        statusA = a.attendanceLabel || (a.attendanceStatus === 'present' ? 'Present' : 'Absent');
                    } else if (a.actionType && actionTypeMapping[a.actionType]) {
                        statusA = actionTypeMapping[a.actionType].label;
                    } else {
                        statusA = 'Unknown';
                    }
                    
                    if (b.attendanceStatus) {
                        statusB = b.attendanceLabel || (b.attendanceStatus === 'present' ? 'Present' : 'Absent');
                    } else if (b.actionType && actionTypeMapping[b.actionType]) {
                        statusB = actionTypeMapping[b.actionType].label;
                    } else {
                        statusB = 'Unknown';
                    }
                    
                    valueA = statusA.toLowerCase();
                    valueB = statusB.toLowerCase();
                }

                const comparison = compareValues(valueA, valueB);
                return currentSort.direction === 'asc' ? comparison : -comparison;
            });
        }

        function displayRecords() {
            console.log('Display records called');
            
            let records = getFilteredRecords();
            console.log('Filtered records count:', records.length);
            
            records = sortRecords(records);
            
            elements.recordsTableBody.innerHTML = '';
            
            if (records.length === 0) {
                elements.recordsTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
                            No records found
                        </td>
                    </tr>
                `;
                // Update records count
                updateRecordsCount(0);
                return;
            }
            
            records.forEach((record, index) => {
                const row = createRecordRow(record, index);
                elements.recordsTableBody.appendChild(row);
            });
            
            // Update records count
            updateRecordsCount(records.length);
        }

        function createRecordRow(record, index) {
            const row = document.createElement('tr');
            
            // Handle both new attendance status and legacy action type for backward compatibility
            let statusInfo;
            if (record.attendanceStatus) {
                // New attendance system
                statusInfo = {
                    label: record.attendanceLabel || (record.attendanceStatus === 'present' ? 'Present' : 'Absent'),
                    icon: record.attendanceStatus === 'present' ? 'fas fa-check-circle' : 'fas fa-times-circle',
                    color: record.attendanceStatus === 'present' ? '#27ae60' : '#e74c3c'
                };
            } else if (record.actionType && actionTypeMapping[record.actionType]) {
                // Legacy action type system
                statusInfo = actionTypeMapping[record.actionType];
            } else {
                // Fallback
                statusInfo = { label: 'Unknown', icon: 'fas fa-question', color: '#95a5a6' };
            }
            
            // Get student display name (check both new and legacy field names for backward compatibility)
            let studentDisplay;
            if (record.studentId && record.studentName) {
                // New format with ID and name
                studentDisplay = `${record.studentId} - ${record.studentName}`;
            } else if (record.studentName || record.employeeName) {
                // Has name but no ID
                studentDisplay = record.studentName || record.employeeName;
            } else {
                // Legacy format - lookup from activeStudents
                const studentInfo = activeStudents[record.student || record.employee];
                if (typeof studentInfo === 'object') {
                    studentDisplay = `${studentInfo.id} - ${studentInfo.name}`;
                } else {
                    studentDisplay = studentInfo || record.student || record.employee || 'Unknown Student';
                }
            }
            
            // Format location data
            const locationText = `${record.latitude.toFixed(4)}, ${record.longitude.toFixed(4)}`;
            const qualityBadge = record.locationQuality ? 
                `<span class="quality-indicator ${record.locationQuality.toLowerCase()}">${record.locationQuality}</span>` : '';
            const accuracyText = `Â±${Math.round(record.accuracy)}m`;
            const altitudeText = record.altitude ? `${Math.round(record.altitude)}m` : 'N/A';
            const speedText = record.speed ? `${(record.speed * 3.6).toFixed(1)} km/h` : 'N/A';
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><strong>${studentDisplay}</strong></td>
                <td>
                    <span class="status-badge ${record.attendanceStatus || record.actionType}" style="background-color: ${statusInfo.color};">
                        <i class="${statusInfo.icon}"></i> ${statusInfo.label}
                    </span>
                </td>
                <td>${record.date}</td>
                <td>${record.time}</td>
                <td>
                    <div style="font-size: 0.85rem;">
                        <div><strong>${locationText}</strong></div>
                        <div style="color: #6c757d;">
                            ${accuracyText} ${qualityBadge}
                        </div>
                        <div style="color: #6c757d; font-size: 0.8rem;">
                            Alt: ${altitudeText} | Speed: ${speedText}
                        </div>
                        <div style="color: #6c757d; font-size: 0.8rem; margin-top: 3px;">
                            <em>${record.address}</em>
                        </div>
                        <div style="margin-top: 5px;">
                            <a href="https://www.openstreetmap.org/#map=18/${record.latitude}/${record.longitude}" 
                               target="_blank" style="color: #3498db; font-size: 0.8rem;">
                                <i class="fas fa-map-marker-alt"></i> View on Map
                            </a>
                        </div>
                    </div>
                </td>
                <td>${record.notes || '-'}</td>
                <td>
                    <button class="table-action-btn" onclick="deleteRecord('${record.id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;
            
            return row;
        }

        function deleteRecord(recordId) {
            console.log('ðŸ—‘ï¸ Delete record called with ID:', recordId);
            
            // Find the record to get its details for the confirmation dialog
            const record = attendanceData.find(r => r.id === recordId);
            if (!record) {
                console.error('âŒ Record not found in attendanceData');
                showMessage('Record not found', 'error');
                return;
            }
            
            // Create modern confirmation dialog
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirmation-overlay';
            confirmDialog.innerHTML = `
                <div class="confirmation-modal">
                    <div class="confirmation-header" style="background: #e74c3c;">
                        <h3><i class="fas fa-trash"></i> Delete Record</h3>
                    </div>
                    <div class="confirmation-body">
                        <p><strong>Are you sure you want to delete this attendance record?</strong></p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
                            <p style="margin: 5px 0;"><strong>Student:</strong> ${record.studentName} (${record.studentId})</p>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${record.date}</p>
                            <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: ${record.attendanceStatus === 'present' ? '#28a745' : '#dc3545'};">${record.attendanceStatus.toUpperCase()}</span></p>
                            <p style="margin: 5px 0;"><strong>Time:</strong> ${record.time}</p>
                        </div>
                        <p style="color: #e74c3c; margin-top: 15px;"><i class="fas fa-warning"></i> This action cannot be undone!</p>
                    </div>
                    <div class="confirmation-actions">
                        <button class="confirm-btn cancel-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="confirm-btn" style="background: #e74c3c;">
                            <i class="fas fa-trash"></i> Yes, Delete
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            const cancelBtn = confirmDialog.querySelector('.cancel-btn');
            const confirmBtn = confirmDialog.querySelector('.confirm-btn:not(.cancel-btn)');
            
            const closeDialog = () => {
                document.body.removeChild(confirmDialog);
            };
            
            cancelBtn.addEventListener('click', () => {
                console.log('ðŸ—‘ï¸ User cancelled deletion');
                closeDialog();
            });
            
            confirmBtn.addEventListener('click', () => {
                console.log('ðŸ—‘ï¸ User confirmed deletion');
                console.log('ðŸ—‘ï¸ About to call deleteRecordFromStorage with ID:', recordId);
                console.log('ðŸ—‘ï¸ deleteRecordFromStorage function exists:', typeof deleteRecordFromStorage);
                closeDialog();
                try {
                    deleteRecordFromStorage(recordId);
                } catch (error) {
                    console.error('ðŸ—‘ï¸ Error calling deleteRecordFromStorage:', error);
                    showMessage('Error deleting record: ' + error.message, 'error');
                }
            });
            
            // Close on overlay click
            confirmDialog.addEventListener('click', (e) => {
                if (e.target === confirmDialog) {
                    console.log('ðŸ—‘ï¸ User cancelled deletion (overlay click)');
                    closeDialog();
                }
            });
            
            // Focus the confirm button after a short delay
            setTimeout(() => confirmBtn.focus(), 100);
        }

        async function deleteRecordFromStorage(recordId) {
            console.log('ðŸ—‘ï¸ deleteRecordFromStorage called with ID:', recordId);
            
            try {
                showLoading(true);
                showMessage('Deleting record...', 'info');
                
                // Find the record to get Firebase ID if it exists
                const recordIndex = attendanceData.findIndex(record => record.id === recordId);
                console.log('ðŸ—‘ï¸ Record index found:', recordIndex);
                
                if (recordIndex === -1) {
                    console.error('âŒ Record not found in attendanceData');
                    showMessage('Record not found', 'error');
                    showLoading(false);
                    return;
                }
                
                const record = attendanceData[recordIndex];
                console.log('ðŸ—‘ï¸ Record to delete:', record);
                
                // Delete from Firebase if it has a Firebase ID and Firebase is enabled
                let firebaseDeleteSuccess = false;
                const firebaseRecordId = record.firebaseId || record.firestoreId || record.id;
                
                console.log('ðŸ—‘ï¸ Record structure:', {
                    id: record.id,
                    firebaseId: record.firebaseId,
                    firestoreId: record.firestoreId,
                    finalId: firebaseRecordId
                });
                
                if (useFirebase && window.firebase && firebaseRecordId && navigator.onLine) {
                    console.log('ðŸ—‘ï¸ Attempting Firebase deletion with ID:', firebaseRecordId);
                    try {
                        // Use the same method as clearAllData - find the document first
                        const q = window.firebase.query(
                            window.firebase.collection(window.firebase.db, 'attendance'),
                            window.firebase.where('id', '==', record.id)
                        );
                        const querySnapshot = await window.firebase.getDocs(q);
                        
                        if (!querySnapshot.empty) {
                            const docToDelete = querySnapshot.docs[0];
                            console.log('ðŸ—‘ï¸ Found document to delete:', docToDelete.id);
                            await window.firebase.deleteDoc(docToDelete.ref);
                            console.log('ðŸ—‘ï¸ Document deleted successfully');
                            firebaseDeleteSuccess = true;
                            showMessage('âœ… Record deleted from cloud and local storage', 'success');
                        } else {
                            console.log('ðŸ—‘ï¸ Document not found in Firestore');
                            showMessage('âš ï¸ Record deleted locally (not found in cloud)', 'warning');
                        }
                    } catch (firebaseError) {
                        console.error('Firebase delete error:', firebaseError);
                        showMessage('âš ï¸ Record deleted locally (cloud sync failed: ' + firebaseError.message + ')', 'warning');
                    }
                } else {
                    console.log('ðŸ—‘ï¸ Deleting locally only - Firebase not available or no ID');
                    if (!firebaseRecordId) {
                        console.log('ðŸ—‘ï¸ No Firebase ID found in record');
                    }
                    if (!useFirebase) {
                        console.log('ðŸ—‘ï¸ Firebase disabled');
                    }
                    if (!window.firebase) {
                        console.log('ðŸ—‘ï¸ Firebase not available');
                    }
                    if (!navigator.onLine) {
                        console.log('ðŸ—‘ï¸ Device offline');
                    }
                    showMessage('âœ… Record deleted from local storage', 'success');
                }
                
                // Remove from local data
                console.log('ðŸ—‘ï¸ Removing from local data...');
                console.log('ðŸ—‘ï¸ attendanceData before deletion:', attendanceData.length, attendanceData);
                console.log('ðŸ—‘ï¸ Removing record at index:', recordIndex);
                attendanceData.splice(recordIndex, 1);
                console.log('ðŸ—‘ï¸ attendanceData after deletion:', attendanceData.length, attendanceData);
                console.log('ðŸ—‘ï¸ Updated attendanceData length:', attendanceData.length);
                
                // Update localStorage
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                // Also remove from sync queue if it's there
                const syncIndex = syncQueue.findIndex(record => record.id === recordId);
                if (syncIndex !== -1) {
                    console.log('ðŸ—‘ï¸ Removing from sync queue...');
                    syncQueue.splice(syncIndex, 1);
                    localStorage.setItem('attendanceSyncQueue', JSON.stringify(syncQueue));
                }
                
                // Refresh displays
                console.log('ðŸ—‘ï¸ Refreshing displays...');
                displayRecords();
                updateStatistics();
                generateAnalytics();
                
                console.log('ðŸ—‘ï¸ Record deletion completed successfully');
                
            } catch (error) {
                console.error('Error deleting record:', error);
                showMessage('âŒ Error deleting record: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateStatistics() {
            // Get filtered records based on current filter settings
            const filteredRecords = getFilteredRecords();
            
            console.log('Filtered records for statistics:', filteredRecords.length);
            console.log('Total attendance records:', attendanceData.length);
            
            // Calculate statistics based on filtered records
            const stats = {
                totalFiltered: filteredRecords.length,
                present: filteredRecords.filter(r => {
                    const status = (r.attendanceStatus || '').toLowerCase();
                    const label = (r.attendanceLabel || '').toLowerCase();
                    return status === 'present' || label === 'present' || r.actionType === 'check-in';
                }).length,
                absent: filteredRecords.filter(r => {
                    const status = (r.attendanceStatus || '').toLowerCase();
                    const label = (r.attendanceLabel || '').toLowerCase();
                    return status === 'absent' || label === 'absent';
                }).length,
                uniqueStudents: new Set(filteredRecords.map(r => r.studentId || r.employee)).size
            };
            
            console.log('Calculated stats for filtered records:', stats);
            
            // Determine labels based on current filters
            const filterDate = elements.filterDate.value;
            const filterStudent = elements.filterEmployee.value;
            const filterStatus = elements.filterAction.value;
            
            let recordsLabel = 'Total Records';
            let studentsLabel = 'Active Students';
            
            if (filterDate || filterStudent || filterStatus) {
                recordsLabel = 'Filtered Records';
                if (filteredRecords.length > 0) {
                    const uniqueInFiltered = new Set(filteredRecords.map(r => r.studentId || r.employee)).size;
                    studentsLabel = uniqueInFiltered > 0 ? 'Students in Filter' : 'Total Students';
                }
            } else {
                recordsLabel = 'All Records';
                studentsLabel = 'Total Students';
            }
            
            elements.statsGrid.innerHTML = `
                <div class="stat-card blue">
                    <div class="stat-number">${stats.totalFiltered}</div>
                    <div class="stat-label">${recordsLabel}</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number">${stats.present}</div>
                    <div class="stat-label">Present</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number">${stats.absent}</div>
                    <div class="stat-label">Absent</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-number">${stats.uniqueStudents}</div>
                    <div class="stat-label">${studentsLabel}</div>
                </div>
            `;
        }

        function showStatistics() {
            if (elements.recordsSection.style.display === 'none') {
                toggleRecordsView();
            }
            
            // Scroll to statistics section
            document.getElementById('statisticsSection').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        function parseTableData() {
            const data = [];
            const rows = document.querySelectorAll('#recordsTableBody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    // Extract student info from second cell (index 1)
                    const studentCell = cells[1].textContent.trim();
                    let studentId = '';
                    let studentName = '';
                    
                    // Parse formats like "STU002 - Yaman Takala"
                    const match = studentCell.match(/^(STU\d+)\s*-\s*(.+)$/);
                    if (match) {
                        studentId = match[1];
                        studentName = match[2];
                    } else {
                        studentName = studentCell;
                        studentId = studentCell;
                    }
                    
                    // Get status from third cell (index 2) - handle badge classes
                    const statusCell = cells[2];
                    let status = statusCell.textContent.trim();
                    
                    // Also check for badge classes to determine status
                    if (statusCell.querySelector('.status-present') || status.toLowerCase().includes('present')) {
                        status = 'Present';
                    } else if (statusCell.querySelector('.status-absent') || status.toLowerCase().includes('absent')) {
                        status = 'Absent';
                    }
                    
                    // Get date from fourth cell (index 3)
                    const dateText = cells[3].textContent.trim();
                    
                    // Get time from fifth cell (index 4) if it exists
                    const timeText = cells.length > 4 ? cells[4].textContent.trim() : '';
                    
                    const record = {
                        studentId: studentId,
                        studentName: studentName,
                        action: status,
                        attendanceStatus: status.toLowerCase(),
                        date: dateText,
                        time: timeText,
                        // Also include legacy format support
                        actionType: status.toLowerCase() === 'present' ? 'check-in' : 'absence'
                    };
                    
                    data.push(record);
                }
            });
            
            return data;
        }

        function parseRecordDate(dateString) {
            // Handle various date formats
            if (!dateString) return new Date();
            
            // Try to parse common formats
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return date;
            }
            
            // If direct parsing fails, try manual parsing for formats like "8/30/2025"
            const parts = dateString.match(/(\d+)\/(\d+)\/(\d+)/);
            if (parts) {
                const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                const day = parseInt(parts[2]);
                const year = parseInt(parts[3]);
                return new Date(year, month, day);
            }
            
            return new Date(); // fallback to current date
        }

        function generateAttendanceRateAnalytics(data) {
            const studentStats = {};
            
            // Calculate global days covered for the entire report period
            const globalDates = new Set();
            data.forEach(record => {
                const recordDate = record.datetime || record.date || record.timestamp || '';
                let dateStr = '';
                if (typeof recordDate === 'string' && recordDate.includes(' ')) {
                    dateStr = recordDate.split(' ')[0];
                } else if (typeof recordDate === 'string') {
                    dateStr = recordDate;
                } else {
                    dateStr = new Date().toISOString().split('T')[0]; // fallback to today
                }
                globalDates.add(dateStr);
            });
            const globalDaysCovered = globalDates.size;
            
            // Calculate stats for each student
            data.forEach(record => {
                // Handle both new format (studentId + studentName) and legacy formats
                let studentKey, studentName;
                
                if (record.studentId && record.studentName) {
                    studentKey = record.studentId;
                    studentName = `${record.studentId} - ${record.studentName}`;
                } else if (record.studentName) {
                    studentKey = record.studentName;
                    studentName = record.studentName;
                } else if (record.employeeName) {
                    studentKey = record.employeeName;
                    studentName = record.employeeName;
                } else {
                    studentKey = 'Unknown';
                    studentName = 'Unknown Student';
                }
                
                if (!studentStats[studentKey]) {
                    studentStats[studentKey] = {
                        name: studentName,
                        total: 0,
                        present: 0,
                        absent: 0
                    };
                }
                
                studentStats[studentKey].total++;
                
                // Check attendance status - handle both new and legacy formats
                const isPresent = record.attendanceStatus === 'present' || 
                                record.actionType === 'check-in' || 
                                record.action === 'Present';
                const isAbsent = record.attendanceStatus === 'absent' || 
                               record.actionType === 'absence' || 
                               record.action === 'Absent';
                
                if (isPresent) {
                    studentStats[studentKey].present++;
                } else if (isAbsent) {
                    studentStats[studentKey].absent++;
                }
            });

            // Calculate attendance rates using global days covered and sort students
            const studentRates = Object.keys(studentStats).map(key => {
                const stats = studentStats[key];
                // Calculate attendance rate as: (present records / global days covered) * 100
                const rate = globalDaysCovered > 0 ? (stats.present / globalDaysCovered) * 100 : 0;
                return {
                    name: stats.name,
                    rate: rate.toFixed(1),
                    total: stats.total,
                    present: stats.present,
                    absent: stats.absent,
                    daysCovered: globalDaysCovered
                };
            });

            // Sort for highest (best attendance first)
            const highest = [...studentRates].sort((a, b) => {
                // First sort by rate, then by total records (more data = more reliable)
                if (b.rate !== a.rate) return b.rate - a.rate;
                return b.total - a.total;
            }).slice(0, 5);

            // Sort for lowest (worst attendance first, but exclude 0% with very few records)
            const lowest = [...studentRates].sort((a, b) => {
                // First sort by rate, then by total records
                if (a.rate !== b.rate) return a.rate - b.rate;
                return b.total - a.total;
            }).slice(0, 5);

            // Display highest attendance
            const highestList = document.getElementById('highestAttendanceList');
            if (highest.length > 0) {
                highestList.innerHTML = highest.map(student => `
                    <li class="student-stat-item ${getPerformanceClass(student.rate)}">
                        <div>
                            <div class="analytics-metric">${student.name}</div>
                            <div class="stat-details">${student.present}P/${student.absent}A (${student.present}/${student.daysCovered} total days)</div>
                        </div>
                        <span class="analytics-percentage ${getPercentageClass(student.rate)}">${student.rate}%</span>
                    </li>
                `).join('');
            } else {
                highestList.innerHTML = '<li class="analytics-empty">No data available</li>';
            }

            // Display lowest attendance
            const lowestList = document.getElementById('lowestAttendanceList');
            if (lowest.length > 0) {
                lowestList.innerHTML = lowest.map(student => `
                    <li class="student-stat-item ${getPerformanceClass(student.rate)}">
                        <div>
                            <div class="analytics-metric">${student.name}</div>
                            <div class="stat-details">${student.present}P/${student.absent}A (${student.present}/${student.daysCovered} total days)</div>
                        </div>
                        <span class="analytics-percentage ${getPercentageClass(student.rate)}">${student.rate}%</span>
                    </li>
                `).join('');
            } else {
                lowestList.innerHTML = '<li class="analytics-empty">No data available</li>';
            }
        }

        function generateDateAnalytics(data) {
            const datePresence = {};
            
            data.forEach(record => {
                // Use the same presence detection logic as the PDF function
                const isPresent = record.attendanceStatus === 'present' || 
                                record.actionType === 'presence' || 
                                record.action === 'Present' ||
                                record.status === 'present';
                
                if (isPresent) {
                    const date = record.date;
                    if (!datePresence[date]) {
                        datePresence[date] = {
                            count: 0,
                            students: []
                        };
                    }
                    datePresence[date].count++;
                    
                    // Get student name
                    let studentName;
                    if (record.studentId && record.studentName) {
                        studentName = `${record.studentId} - ${record.studentName}`;
                    } else if (record.studentName) {
                        studentName = record.studentName;
                    } else if (record.employeeName) {
                        studentName = record.employeeName;
                    } else {
                        studentName = 'Unknown';
                    }
                    
                    datePresence[date].students.push(studentName);
                }
            });

            const sortedDates = Object.keys(datePresence)
                .map(date => ({
                    date: date,
                    count: datePresence[date].count,
                    students: datePresence[date].students,
                    formattedDate: formatDisplayDate(date)
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            const timelineContainer = document.getElementById('absenceTimeline');
            if (sortedDates.length > 0) {
                timelineContainer.innerHTML = sortedDates.map(item => `
                    <div class="timeline-item">
                        <div>
                            <div class="timeline-date">${item.date}</div>
                            <div class="stat-details">${item.students.slice(0, 3).join(', ')}${item.students.length > 3 ? ` +${item.students.length - 3} more` : ''}</div>
                        </div>
                        <div class="timeline-count">${item.count} present</div>
                    </div>
                `).join('');
            } else {
                timelineContainer.innerHTML = '<div class="analytics-empty">No presence data available</div>';
            }
        }

        function formatDisplayDate(dateString) {
            try {
                const date = parseRecordDate(dateString);
                return date.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString; // fallback to original string
            }
        }

        function calculateDatesWithHighestAbsences(data) {
            const dateStats = {};
            
            // Count present students by date - simple and straightforward!
            data.forEach(record => {
                // Check if student is present
                const isPresent = record.attendanceStatus === 'present' || 
                                record.actionType === 'presence' || 
                                record.action === 'Present' ||
                                record.status === 'present';
                
                if (isPresent) {
                    // Get date from multiple possible fields
                    let date = record.date || record.datetime;
                    if (!date && record.timestamp) {
                        date = record.timestamp.split('T')[0];
                    }
                    
                    // Extract date portion if it's a full datetime string
                    if (date && date.includes('T')) {
                        date = date.split('T')[0];
                    }
                    
                    if (!date) return;
                    
                    if (!dateStats[date]) {
                        dateStats[date] = {
                            present: 0
                        };
                    }
                    
                    dateStats[date].present++;
                }
            });
            
            // Convert to array and sort by present count (highest first)
            const sortedDates = Object.keys(dateStats)
                .map(date => ({
                    date: date,
                    absentStudents: dateStats[date].present, // Using this field name for compatibility
                    absenceRate: dateStats[date].present, // For display purposes
                    formattedDate: formatDisplayDate(date)
                }))
                .filter(item => item.absentStudents > 0) // Only show dates with present students
                .sort((a, b) => b.absentStudents - a.absentStudents)
                .slice(0, 10);
            
            return sortedDates;
        }

        function getPercentageClass(rate) {
            if (rate >= 80) return 'percentage-high';
            if (rate >= 60) return 'percentage-medium';
            return 'percentage-low';
        }

        function getPerformanceClass(rate) {
            if (rate >= 90) return 'excellent';
            if (rate >= 80) return 'good';
            if (rate >= 60) return 'average';
            return 'poor';
        }

        function showEmptyAnalytics() {
            document.getElementById('highestAttendanceList').innerHTML = '<li class="analytics-empty">No data available for selected period</li>';
            document.getElementById('lowestAttendanceList').innerHTML = '<li class="analytics-empty">No data available for selected period</li>';
            // Matrix analytics will handle its own empty state
        }

        // Helper function to resolve student names for PDF export
        function getStudentDisplayName(studentKey) {
            console.log('ðŸ” Looking up student name for key:', studentKey);
            
            // First try to get from activeStudents
            if (activeStudents && activeStudents[studentKey]) {
                const student = activeStudents[studentKey];
                console.log('ðŸ“ Found in activeStudents:', student);
                if (typeof student === 'object' && student.name) {
                    return student.name;
                } else if (typeof student === 'string') {
                    return student;
                }
            }
            
            // Fallback to defaultStudentNames
            if (defaultStudentNames && defaultStudentNames[studentKey]) {
                const student = defaultStudentNames[studentKey];
                console.log('ðŸ“ Found in defaultStudentNames:', student);
                if (typeof student === 'object' && student.name) {
                    return student.name;
                } else if (typeof student === 'string') {
                    return student;
                }
            }
            
            // If it's already a display name (not an ID), return as is
            if (studentKey && !studentKey.startsWith('STU')) {
                console.log('ðŸ“ Returning as display name:', studentKey);
                return studentKey;
            }
            
            // Last resort - return the key itself
            console.log('âŒ No name found, returning key:', studentKey);
            return studentKey || 'Unknown Student';
        }

        // Calculate Effective Attendance Rate Trend using Last Four Rates
        function calculateEffectiveAttendanceRateTrend(filteredData, totalStudents, allClassDates) {
            if (!filteredData || filteredData.length === 0 || !allClassDates || allClassDates.length < 4) {
                return 'INSUFFICIENT_DATA';
            }

            // Sort dates chronologically
            const sortedClassDates = [...allClassDates].sort((a, b) => new Date(a) - new Date(b));
            const dailyRates = [];
            const dateMapping = [];

            // Calculate CUMULATIVE effective attendance rate up to each date (like summary statistics)
            let cumulativePresentRecords = 0;
            let cumulativeTotalVacation = 0;
            let cumulativeDaysCovered = 0;

            sortedClassDates.forEach((date, dayIndex) => {
                cumulativeDaysCovered = dayIndex + 1; // Days covered up to this date

                // Get all records UP TO this date (cumulative)
                const recordsUpToDate = filteredData.filter(record => {
                    const recordDate = record.datetime ? record.datetime.split(' ')[0] : 
                                     record.date || record.timestamp?.split(' ')[0] || '';
                    const recordDateObj = new Date(recordDate);
                    const currentDateObj = new Date(date);
                    return recordDate && recordDateObj <= currentDateObj;
                });

                // Count cumulative present records and vacation days
                cumulativePresentRecords = recordsUpToDate.filter(record => {
                    const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                    return status === 'present' || status.includes('present');
                }).length;

                cumulativeTotalVacation = recordsUpToDate.filter(record => {
                    const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                    if (status === 'absent' || status.includes('absent')) {
                        const notes = record.notes || '';
                        return isExcusedAbsence(notes);
                    }
                    return false;
                }).length;

                // Calculate effective attendance rate using CORRECT formula
                // Formula: cumulativePresentRecords / (totalStudents * cumulativeDaysCovered - cumulativeTotalVacation) * 100
                const expectedTotalAttendance = totalStudents * cumulativeDaysCovered;
                const effectiveTotalDays = expectedTotalAttendance - cumulativeTotalVacation;
                const effectiveRate = effectiveTotalDays > 0 ? 
                    (cumulativePresentRecords / effectiveTotalDays) * 100 : 0;

                dailyRates.push(effectiveRate);
                dateMapping.push({
                    date: date,
                    rate: effectiveRate,
                    cumulativePresent: cumulativePresentRecords,
                    cumulativeVacation: cumulativeTotalVacation,
                    daysCovered: cumulativeDaysCovered,
                    expectedTotal: expectedTotalAttendance,
                    effectiveTotal: effectiveTotalDays
                });
            });

            if (dailyRates.length < 4) {
                return 'INSUFFICIENT_DATA';
            }

            // Use only the last 4 rates for trend analysis
            const lastFourRates = dailyRates.slice(-4);
            const lastFourDates = dateMapping.slice(-4);
            
            // Linear regression analysis (last four rates only)
            const n = lastFourRates.length; // Will be 4 (or less if insufficient data)
            const days = Array.from({ length: n }, (_, i) => i + 1);
            
            // Calculate means using only last four rates
            const days_mean = days.reduce((sum, val) => sum + val, 0) / n;
            const rates_mean = lastFourRates.reduce((sum, val) => sum + val, 0) / n;
            
            // Calculate slope and intercept
            let numerator = 0;
            let denominator = 0;
            
            for (let i = 0; i < n; i++) {
                numerator += (days[i] - days_mean) * (lastFourRates[i] - rates_mean);
                denominator += (days[i] - days_mean) ** 2;
            }
            
            const slope = denominator !== 0 ? numerator / denominator : 0;
            const intercept = rates_mean - (slope * days_mean);
            
            // Calculate fitted values and R-squared using last four rates
            const fitted = days.map(day => slope * day + intercept);
            const SSres = lastFourRates.reduce((sum, rate, i) => sum + Math.pow(rate - fitted[i], 2), 0);
            const SStot = lastFourRates.reduce((sum, rate) => sum + Math.pow(rate - rates_mean, 2), 0);
            const rSquared = SStot !== 0 ? 1 - (SSres / SStot) : 1;
            
            // Calculate RMSE using last four rates
            const rmse = Math.sqrt(SSres / n);
            
            // Calculate statistics using last four rates
            const avgRate = rates_mean;
            const minRate = Math.min(...lastFourRates);
            const maxRate = Math.max(...lastFourRates);
            const overallChange = lastFourRates[lastFourRates.length - 1] - lastFourRates[0];
            
            // Trend classification
            let classification;
            if (rSquared < 0.3) {
                classification = 'VOLATILE';
            } else if (slope > 1) {
                classification = 'IMPROVING';
            } else if (slope < -1) {
                classification = 'DECLINING';
            } else {
                classification = 'STABLE';
            }

            return {
                dataPoints: n,
                periodCoverage: `${lastFourDates[0].date} to ${lastFourDates[lastFourDates.length - 1].date}`,
                fullPeriodCoverage: `${sortedClassDates[0]} to ${sortedClassDates[sortedClassDates.length - 1]}`,
                slope: slope,
                intercept: intercept,
                rSquared: rSquared,
                rmse: rmse,
                avgRate: avgRate,
                minRate: minRate,
                maxRate: maxRate,
                overallChange: overallChange,
                classification: classification,
                dailyData: dateMapping,
                lastFourData: lastFourDates,
                fitted: fitted
            };
        }

        // Analyze Dates with Highest Unexcused Absences (using CI matrix logic)
        function analyzeDatesByUnexcusedAbsences(filteredData, totalStudents, allClassDates) {
            if (!filteredData || filteredData.length === 0 || !allClassDates || allClassDates.length === 0) {
                return [];
            }

            // Get unique students from the data
            const uniqueStudents = [...new Set(filteredData.map(record => 
                record.studentName || record.studentId || 'Unknown'
            ))];

            // If no unique students found, use totalStudents as fallback
            const studentCount = uniqueStudents.length > 0 ? uniqueStudents.length : totalStudents;
            
            // Sort dates chronologically (same as CI calculation)
            const sortedClassDates = [...allClassDates].sort((a, b) => new Date(a) - new Date(b));
            
            // Build attendance matrix for each date (inspired by CI logic)
            const dateAnalysis = [];
            
            sortedClassDates.forEach(date => {
                let unexcusedAbsences = 0;
                let presentCount = 0;
                let excusedAbsences = 0;
                
                // Create binary matrix for this date across all students
                uniqueStudents.forEach(studentName => {
                    // Find student's record for this date
                    const studentRecord = filteredData.find(record => {
                        const recordStudent = record.studentName || record.studentId || 'Unknown';
                        const recordDate = record.datetime ? record.datetime.split(' ')[0] : 
                                         record.date || record.timestamp?.split(' ')[0] || '';
                        
                        return recordStudent === studentName && recordDate === date;
                    });
                    
                    if (studentRecord) {
                        const status = (studentRecord.attendanceStatus || studentRecord.action || '').toLowerCase().trim();
                        
                        if (status === 'present' || status.includes('present')) {
                            // Binary: 1 (present)
                            presentCount++;
                        } else if (status === 'absent' || status.includes('absent')) {
                            // Check if absence is excused (has vacation notes)
                            const notes = studentRecord.notes || '';
                            if (isExcusedAbsence(notes)) {
                                // Excused absence - excluded from unexcused count
                                excusedAbsences++;
                            } else {
                                // Binary: 0 (unexcused absent)
                                unexcusedAbsences++;
                            }
                        } else {
                            // Unknown status - treat as unexcused absent (Binary: 0)
                            unexcusedAbsences++;
                        }
                    } else {
                        // No record at all - unexcused absent (Binary: 0)
                        unexcusedAbsences++;
                    }
                });
                
                // Calculate absenteeism percentage for this date
                const totalAccountableStudents = presentCount + unexcusedAbsences; // Exclude excused
                const absenteeismRate = totalAccountableStudents > 0 ? 
                    (unexcusedAbsences / totalAccountableStudents) * 100 : 0;
                
                dateAnalysis.push({
                    date: date,
                    unexcusedAbsences: unexcusedAbsences,
                    presentCount: presentCount,
                    excusedAbsences: excusedAbsences,
                    totalStudents: studentCount,
                    accountableStudents: totalAccountableStudents,
                    absenteeismRate: absenteeismRate,
                    // Binary matrix representation for this date (sum of zeros)
                    matrixZeros: unexcusedAbsences,
                    matrixOnes: presentCount
                });
            });
            
            // Sort by highest unexcused absences (most zeros in the matrix)
            dateAnalysis.sort((a, b) => b.unexcusedAbsences - a.unexcusedAbsences);
            
            return dateAnalysis;
        }

        // PDF Export Functions
        function exportAnalyticsToPDF() {
            try {
                // Show loading state
                const exportBtn = document.getElementById('exportAnalyticsPdfBtn');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                exportBtn.disabled = true;

                // Use the same data source as the dashboard analytics
                const filterPeriod = document.getElementById('analyticsFilter').value;
                let filteredData = getAnalyticsData(filterPeriod);
                
                // Validate and clean data
                if (!filteredData || filteredData.length === 0) {
                    showMessage('No data available to export', 'warning');
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                    return;
                }
                
                // Use the same attendance rate calculation as the dashboard
                const attendanceRates = [];
                const studentStats = {};
                
                // Calculate global days covered for the entire report period
                const globalDates = new Set();
                filteredData.forEach(record => {
                    const recordDate = record.datetime || record.date || record.timestamp || '';
                    let dateStr = '';
                    if (typeof recordDate === 'string' && recordDate.includes(' ')) {
                        dateStr = recordDate.split(' ')[0];
                    } else if (typeof recordDate === 'string') {
                        dateStr = recordDate;
                    } else {
                        dateStr = new Date().toISOString().split('T')[0]; // fallback to today
                    }
                    globalDates.add(dateStr);
                });
                const globalDaysCovered = globalDates.size;
                
                // Calculate attendance rates for each student (same logic as dashboard)
                filteredData.forEach(record => {
                    const studentKey = record.studentId || record.studentName || 'Unknown';
                    const studentName = record.studentName || studentKey;
                    
                    if (!studentStats[studentKey]) {
                        studentStats[studentKey] = {
                            name: studentName,
                            total: 0,
                            present: 0,
                            absent: 0,
                            vacation: 0
                        };
                    }
                    
                    studentStats[studentKey].total++;
                    
                    // Check for present status - handle multiple formats
                    const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                    if (status === 'present' || record.actionType === 'check-in' || status.includes('present')) {
                        studentStats[studentKey].present++;
                    } else if (status === 'absent' || status.includes('absent')) {
                        studentStats[studentKey].absent++;
                        // Check if this absence is excused (vacation/abroad)
                        if (isExcusedAbsence(record.notes)) {
                            studentStats[studentKey].vacation++;
                        }
                    }
                });
                
                // Calculate percentages using effective days covered (same as dashboard)
                const attendanceRatesWithWeights = Object.values(studentStats).map(student => {
                    // Calculate effective days covered (excluding vacation days)
                    const effectiveDaysCovered = globalDaysCovered - student.vacation;
                    
                    // Calculate actual absent days: Effective Days - Present days (CORRECTED)
                    const actualAbsent = effectiveDaysCovered - student.present;
                    
                    const rate = effectiveDaysCovered > 0 ? (student.present / effectiveDaysCovered * 100) : 0;
                    
                    // Calculate time-based analytics for this student
                    const calculateLateRecordsForStudent = (studentName) => {
                        let lateCount = 0;
                        const onTimeStart = "13:00"; // 1:00 PM
                        const onTimeEnd = "13:15";   // 1:15 PM
                        
                        filteredData.forEach(record => {
                            const recordStudent = record.studentName || record.studentId || 'Unknown';
                            const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                            
                            // Check if this record belongs to the student and is present
                            if (recordStudent === studentName && (status === 'present' || status.includes('present'))) {
                                // Get time from record
                                let recordTime = record.time;
                                
                                // If no direct time field, try to extract from datetime/timestamp
                                if (!recordTime && record.datetime) {
                                    const timePart = record.datetime.split(' ');
                                    if (timePart.length > 1) {
                                        recordTime = timePart[1];
                                    }
                                }
                                
                                if (!recordTime && record.timestamp) {
                                    const timePart = record.timestamp.split(' ');
                                    if (timePart.length > 1) {
                                        recordTime = timePart[1];
                                    }
                                }
                                
                                // Check if time is outside the on-time window (late)
                                if (recordTime && !isTimeInRange(recordTime, onTimeStart, onTimeEnd)) {
                                    lateCount++;
                                }
                            }
                        });
                        
                        return lateCount;
                    };
                    
                    const lateRecords = calculateLateRecordsForStudent(student.name);
                    const onTimeRecords = student.present - lateRecords;
                    
                    // Calculate weighted score using comprehensive 8-case system
                    const daysCovered = globalDaysCovered;
                    const effectiveDays = daysCovered - student.vacation;
                    const effectiveDaysPercentage = daysCovered > 0 ? (effectiveDays / daysCovered * 100) : 0;
                    const excusePercentage = daysCovered > 0 ? (student.vacation / daysCovered * 100) : 0;
                    const punctualityPercentage = student.present > 0 ? (onTimeRecords / student.present * 100) : 0;
                    const latePercentage = student.present > 0 ? (lateRecords / student.present * 100) : 0;
                    
                    let weightedScore;
                    
                    // Comprehensive 8-case weighted score system
                    if (student.vacation === 0 && onTimeRecords === 0 && lateRecords === 0) {
                        // Case 1: Num-Excuse = 0, On-Time = 0, Late = 0
                        weightedScore = (0.95 * rate) + (0.05 * punctualityPercentage);
                    } else if (student.vacation === 0 && onTimeRecords > 0 && lateRecords === 0) {
                        // Case 2: Num-Excuse = 0, On-Time > 0, Late = 0
                        weightedScore = (0.95 * rate) + (0.05 * punctualityPercentage);
                    } else if (student.vacation === 0 && onTimeRecords === 0 && lateRecords > 0) {
                        // Case 3: Num-Excuse = 0, On-Time = 0, Late > 0
                        weightedScore = (0.95 * rate) + (0.05 * punctualityPercentage);
                    } else if (student.vacation === 0 && onTimeRecords > 0 && lateRecords > 0) {
                        // Case 4: Num-Excuse = 0, On-Time > 0, Late > 0
                        weightedScore = (0.95 * rate) + (0.05 * punctualityPercentage);
                    } else if (student.vacation > 0 && onTimeRecords === 0 && lateRecords === 0) {
                        // Case 5: Num-Excuse > 0, On-Time = 0, Late = 0
                        weightedScore = (0.7 * rate) + (0.3 * effectiveDaysPercentage);
                    } else if (student.vacation > 0 && onTimeRecords > 0 && lateRecords === 0) {
                        // Case 6: Num-Excuse > 0, On-Time > 0, Late = 0
                        weightedScore = (0.65 * rate) + (0.3 * effectiveDaysPercentage) + (0.05 * punctualityPercentage);
                    } else if (student.vacation > 0 && onTimeRecords === 0 && lateRecords > 0) {
                        // Case 7: Num-Excuse > 0, On-Time = 0, Late > 0
                        weightedScore = (0.65 * rate) + (0.3 * effectiveDaysPercentage) + (0.05 * punctualityPercentage);
                    } else if (student.vacation > 0 && onTimeRecords > 0 && lateRecords > 0) {
                        // Case 8: Num-Excuse > 0, On-Time > 0, Late > 0
                        weightedScore = (0.65 * rate) + (0.3 * effectiveDaysPercentage) + (0.05 * punctualityPercentage);
                    } else {
                        // Fallback to original simple formula if something goes wrong
                        weightedScore = (0.95 * rate) + (0.05 * punctualityPercentage);
                    }
                    
                    return {
                        name: student.name,
                        present: student.present,
                        absent: actualAbsent, // Use calculated absent days
                        vacation: student.vacation,
                        daysCovered: globalDaysCovered,
                        effectiveDaysCovered: effectiveDaysCovered,
                        rate: Math.round(rate * 10) / 10,
                        weightedScore: Math.round(weightedScore * 10) / 10
                    };
                }).sort((a, b) => b.weightedScore - a.weightedScore); // Sort by weighted score descending

                // Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set up fonts and colors
                const primaryColor = [52, 152, 219]; // Blue
                const secondaryColor = [46, 204, 113]; // Green
                const dangerColor = [231, 76, 60]; // Red
                const textColor = [44, 62, 80]; // Dark blue-gray
                
                // Header - Optimized for compact layout
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 210, 32, 'F'); // Reduced from 38 to 32
                
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18); // Reduced from 20 to 18
                doc.text('ATTENDANCE ANALYTICS REPORT', 20, 18);
                
                // Date and filter info
                doc.setFontSize(9);
                const currentDate = new Date().toLocaleDateString();
                const filterText = getPeriodDisplayName(filterPeriod);
                const actualDateRange = getActualDateRange(filteredData);
                doc.text(`Generated on: ${currentDate} | Period: ${filterText}`, 20, 24);
                
                // Add the actual date range with simple text (still in white text on blue background)
                if (actualDateRange && actualDateRange !== 'No data') {
                    doc.text(`Report Period: ${actualDateRange}`, 20, 28);
                }
                
                // Reset text color for body
                doc.setTextColor(...textColor);
                
                let yPosition = 42; // Reduced from 50 to 42 for better spacing
                
                // Summary Statistics using the same calculations as dashboard
                addSectionHeader(doc, 'SUMMARY STATISTICS', yPosition);
                yPosition += 12;
                
                // Calculate summary statistics from the correctly calculated data
                const totalRecords = filteredData.length;
                const totalStudents = attendanceRatesWithWeights.length;
                const presentRecords = filteredData.filter(r => {
                    const status = (r.attendanceStatus || r.action || '').toLowerCase().trim();
                    return status === 'present' || status.includes('present');
                }).length;
                const absentRecords = filteredData.filter(r => {
                    const status = (r.attendanceStatus || r.action || '').toLowerCase().trim();
                    return status === 'absent' || status.includes('absent');
                }).length;
                
                // Calculate totals from student data
                const totalAbsent = attendanceRatesWithWeights.reduce((sum, student) => sum + student.absent, 0);
                const totalVacation = attendanceRatesWithWeights.reduce((sum, student) => sum + student.vacation, 0);
                const unexcusedAbsent = totalAbsent - totalVacation;
                
                // Calculate rates using the same logic as View Records PDF
                const rawAttendanceRate = totalStudents > 0 && globalDaysCovered > 0 ? 
                    ((presentRecords / (totalStudents * globalDaysCovered)) * 100).toFixed(1) : '0.0';
                
                // Use the same effective attendance rate calculation as View Records PDF
                // Formula: presentCount / (totalStudents * daysCovered - totalVacation) * 100
                const expectedTotalAttendance = totalStudents * globalDaysCovered;
                const effectiveTotalDays = expectedTotalAttendance - totalVacation;
                const effectiveAttendanceRate = effectiveTotalDays > 0 ? 
                    Math.round((presentRecords / effectiveTotalDays) * 100).toString() : '0';
                
                // Class Average Rate should be the average of individual student attendance rates
                const classAverageRate = attendanceRatesWithWeights.length > 0 ? 
                    (attendanceRatesWithWeights.reduce((sum, student) => sum + student.rate, 0) / attendanceRatesWithWeights.length).toFixed(1) : '0.0';
                
                const classAverageWeightedScore = attendanceRatesWithWeights.length > 0 ? 
                    (attendanceRatesWithWeights.reduce((sum, student) => sum + student.weightedScore, 0) / attendanceRatesWithWeights.length).toFixed(1) : '0.0';
                
                const summaryData = [
                    ['Total Records', totalRecords.toString()],
                    ['Total Students', totalStudents.toString()],
                    ['Present Records', presentRecords.toString()],
                    ['Excused Absences', totalVacation.toString()],
                    ['Total Absences', totalAbsent.toString()],
                    ['Unexcused Absences', unexcusedAbsent.toString()],
                    ['Raw Attendance Rate', `${rawAttendanceRate}%`],
                    ['Effective Attendance Rate', `${effectiveAttendanceRate}%`],
                    ['Class Average Rate', `${classAverageRate}%`],
                    ['Class Average Weighted Score', `${classAverageWeightedScore}`],
                    ['Days Covered', globalDaysCovered.toString()]
                ];
                
                doc.autoTable({
                    body: summaryData,
                    startY: yPosition,
                    theme: 'striped',
                    alternateRowStyles: {
                        fillColor: [248, 249, 250]
                    },
                    styles: {
                        fontSize: 9,
                        cellPadding: 2,
                        minCellHeight: 6
                    },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 80, halign: 'left' },
                        1: { cellWidth: 40, halign: 'center', fontStyle: 'bold' }
                    },
                    margin: { top: 2, left: 8, right: 8 },
                    pageBreak: 'avoid'
                });
                yPosition = doc.lastAutoTable.finalY + 8;
                
                // Check if we need a new page
                if (yPosition > 180) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Attendance Rates by Student
               
                
                console.log('ðŸ“„ PDF export data comparison:', {
                    filteredDataLength: filteredData.length,
                    attendanceRatesLength: attendanceRatesWithWeights.length,
                    sampleStudent: attendanceRatesWithWeights[0],
                    fullStudentData: attendanceRatesWithWeights.slice(0, 3).map(s => ({
                        name: s.name,
                        present: s.present,
                        absent: s.absent,
                        vacation: s.vacation,
                        effectiveDays: s.effectiveDaysCovered,
                        rate: s.rate,
                        weightedScore: s.weightedScore
                    }))
                });
                
                // Calculate late records for each student
                const calculateLateRecordsForStudent = (studentName) => {
                    let lateCount = 0;
                    const onTimeStart = "13:00"; // 1:00 PM
                    const onTimeEnd = "13:15";   // 1:15 PM
                    
                    filteredData.forEach(record => {
                        const recordStudent = record.studentName || record.studentId || 'Unknown';
                        const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                        
                        // Check if this record belongs to the student and is present
                        if (recordStudent === studentName && (status === 'present' || status.includes('present'))) {
                            // Get time from record
                            let recordTime = record.time;
                            
                            // If no direct time field, try to extract from datetime/timestamp
                            if (!recordTime && record.datetime) {
                                const timePart = record.datetime.split(' ');
                                if (timePart.length > 1) {
                                    recordTime = timePart[1];
                                }
                            }
                            
                            if (!recordTime && record.timestamp) {
                                const timePart = record.timestamp.split(' ');
                                if (timePart.length > 1) {
                                    recordTime = timePart[1];
                                }
                            }
                            
                            // Check if time is outside the on-time window (late)
                            if (recordTime && !isTimeInRange(recordTime, onTimeStart, onTimeEnd)) {
                                lateCount++;
                            }
                        }
                    });
                    
                    return lateCount;
                };
                
                // Calculate Consistency Index for each student
                const calculateConsistencyIndex = (studentName, allClassDates, filteredData) => {
                    // Create daily attendance pattern (1=present, 0=unexcused absent) 
                    // EXCLUDE excused absences entirely from consistency calculation
                    // USE SAME SMART PATTERN CONSTRUCTION as Trends column
                    const dailyPattern = [];
                    const includedDates = []; // Track which dates were included
                    
                    // Ensure dates are properly sorted chronologically (same as Trends)
                    const sortedClassDates = [...allClassDates].sort((a, b) => new Date(a) - new Date(b));
                    
                    sortedClassDates.forEach(date => {
                        // Check for any record for this student on this date
                        const studentRecord = filteredData.find(record => {
                            const recordStudent = record.studentName || record.studentId || 'Unknown';
                            const recordDate = record.datetime ? record.datetime.split(' ')[0] : 
                                             record.date || record.timestamp?.split(' ')[0] || '';
                            
                            return recordStudent === studentName && recordDate === date;
                        });
                        
                        if (studentRecord) {
                            const status = (studentRecord.attendanceStatus || studentRecord.action || '').toLowerCase().trim();
                            
                            if (status === 'present' || status.includes('present')) {
                                // Present - full attendance value
                                dailyPattern.push(1);
                                includedDates.push(date);
                            } else if (status === 'absent' || status.includes('absent')) {
                                // Check if this absence is excused (has vacation notes)
                                const notes = studentRecord.notes || '';
                                if (isExcusedAbsence(notes)) {
                                    // EXCLUDE excused absences from consistency calculation
                                    // (skip - don't add to pattern)
                                } else {
                                    // Unexcused absent (recorded as absent without vacation notes)
                                    dailyPattern.push(0);
                                    includedDates.push(date);
                                }
                            } else {
                                // Unknown status - treat as unexcused absent
                                dailyPattern.push(0);
                                includedDates.push(date);
                            }
                        } else {
                            // No record at all - unexcused absent (didn't show up, nothing recorded)
                            dailyPattern.push(0);
                            includedDates.push(date);
                        }
                    });
                    
                    // Need at least 2 data points to calculate meaningful consistency
                    if (dailyPattern.length < 2) {
                        console.log(`ðŸ“Š CI calculation for ${studentName}: Insufficient data (${dailyPattern.length} days), returning 1.0`);
                        return 1.0; // Perfect consistency if only 1 day or no applicable days
                    }
                    
                    // Calculate CI = 1 - (Ïƒ/Î¼) where Ïƒ is standard deviation and Î¼ is mean
                    // Using proper statistical formula for consistency measurement
                    const mean = dailyPattern.reduce((sum, val) => sum + val, 0) / dailyPattern.length;
                    
                    if (mean === 0) {
                        console.log(`ðŸ“Š CI calculation for ${studentName}: All unexcused absences, returning 1.0`);
                        return 1.0; // Perfect consistency in being absent (though poor attendance)
                    }
                    
                    const variance = dailyPattern.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / dailyPattern.length;
                    const standardDeviation = Math.sqrt(variance);
                    
                    const ci = Math.max(0, 1 - (standardDeviation / mean));
                    
                    console.log(`ðŸ“Š CI calculation for ${studentName}:`, {
                        sortedDates: sortedClassDates,
                        totalDates: sortedClassDates.length,
                        includedDates: includedDates.length,
                        excludedExcused: sortedClassDates.length - includedDates.length,
                        pattern: dailyPattern,
                        patternString: `[${dailyPattern.join(' ')}]`, // Same format as Trends
                        dateMapping: sortedClassDates.map((date, index) => ({
                            day: index + 1,
                            date: date,
                            attendance: dailyPattern[index] !== undefined ? dailyPattern[index] : 'excluded'
                        })),
                        mean: mean.toFixed(3),
                        stdDev: standardDeviation.toFixed(3),
                        ci: ci.toFixed(3),
                        interpretation: 'SMART PATTERN: Chronologically sorted dates, 1=Present, 0=Unexcused Absent. Excused absences EXCLUDED.'
                    });
                    
                    return ci;
                };
                
                // Calculate attendance trend using weekly/cumulative attendance rates
                // Much more meaningful than raw presence/absence (1/0) patterns
                const calculateAttendanceTrend = (studentName, allClassDates, filteredData) => {
                    // Create cumulative attendance rates over time (NOT raw 1/0 pattern)
                    // This gives meaningful trend data like [100%, 100%, 100%, 75%, 60%, 66.7%, 71.4%]
                    const weeklyRates = [];
                    const includedDates = []; // Track which dates were included in trend
                    
                    // Ensure dates are properly sorted chronologically
                    const sortedClassDates = [...allClassDates].sort((a, b) => new Date(a) - new Date(b));
                    
                    let cumulativePresent = 0;
                    let cumulativeTotal = 0;
                    
                    sortedClassDates.forEach((date, index) => {
                        // Check if student has any record for this date
                        const studentRecord = filteredData.find(record => {
                            const recordStudent = record.studentName || record.studentId || 'Unknown';
                            const recordDate = record.datetime ? record.datetime.split(' ')[0] : 
                                             record.date || record.timestamp?.split(' ')[0] || '';
                            
                            return recordStudent === studentName && recordDate === date;
                        });
                        
                        let isPresent = false;
                        let shouldInclude = true;
                        
                        if (studentRecord) {
                            const status = (studentRecord.attendanceStatus || studentRecord.action || '').toLowerCase().trim();
                            
                            if (status === 'present' || status.includes('present')) {
                                isPresent = true;
                            } else if (status === 'absent' || status.includes('absent')) {
                                // Check if this absence is excused (has notes)
                                const notes = studentRecord.notes || '';
                                if (isExcusedAbsence(notes)) {
                                    // EXCLUDE excused absences from trend calculation
                                    shouldInclude = false;
                                } else {
                                    isPresent = false; // Unexcused absent
                                }
                            } else {
                                isPresent = false; // Unknown status - treat as absent
                            }
                        } else {
                            isPresent = false; // No record found = absent
                        }
                        
                        if (shouldInclude) {
                            cumulativeTotal++;
                            if (isPresent) cumulativePresent++;
                            
                            // Calculate cumulative attendance rate up to this point
                            const rate = cumulativeTotal > 0 ? (cumulativePresent / cumulativeTotal) * 100 : 0;
                            weeklyRates.push(rate);
                            includedDates.push(date);
                        }
                    });
                    
                    // *** Take only last 3 samples for trend analysis (MATLAB-compatible) ***
                    // Store original for reference, use last 3 for calculations
                    const originalWeeklyRates = [...weeklyRates];
                    const originalIncludedDates = [...includedDates];
                    
                    // Use only last 3 samples for trend calculation
                    const trendWeeklyRates = weeklyRates.length > 3 ? weeklyRates.slice(-3) : weeklyRates;
                    const trendIncludedDates = includedDates.length > 3 ? includedDates.slice(-3) : includedDates;
                    
                    // Linear regression on attendance rates (MATLAB-compatible - Last 3 Samples)
                    const n = trendWeeklyRates.length;
                    if (n < 2) return 'FLAT'; // Need at least 2 points for trend
                    
                    // Sequential week numbers (1, 2, 3, ...)
                    const weeks = Array.from({ length: n }, (_, i) => i + 1);
                    
                    // Calculate means (using last 3 samples)
                    const weeks_mean = weeks.reduce((sum, val) => sum + val, 0) / n;
                    const rates_mean = trendWeeklyRates.reduce((sum, val) => sum + val, 0) / n;
                    
                    // Calculate numerator and denominator for slope
                    let numerator = 0;
                    let denominator = 0;
                    
                    for (let i = 0; i < n; i++) {
                        numerator += (weeks[i] - weeks_mean) * (trendWeeklyRates[i] - rates_mean);
                        denominator += (weeks[i] - weeks_mean) ** 2;
                    }
                    
                    // Calculate slope (% change per week) and intercept
                    const slope = denominator !== 0 ? numerator / denominator : 0;
                    const intercept = rates_mean - (slope * weeks_mean);
                    
                    // Calculate fitted values for R-squared
                    const fitted = weeks.map(week => slope * week + intercept);
                    
                    // Calculate R-squared (fit quality)
                    const SSres = trendWeeklyRates.reduce((sum, rate, i) => sum + Math.pow(rate - fitted[i], 2), 0);
                    const SStot = trendWeeklyRates.reduce((sum, rate) => sum + Math.pow(rate - rates_mean, 2), 0);
                    const rSquared = SStot !== 0 ? 1 - (SSres / SStot) : 1;
                    
                    // Sophisticated Overall Statistics (MATLAB-compatible - Last 3 Samples)
                    const overallChange = trendWeeklyRates.length > 0 ? trendWeeklyRates[trendWeeklyRates.length - 1] - trendWeeklyRates[0] : 0;
                    
                    // Week-to-week change (most recent change)
                    const weekToWeekChange = trendWeeklyRates.length > 1 ? 
                        trendWeeklyRates[trendWeeklyRates.length - 1] - trendWeeklyRates[trendWeeklyRates.length - 2] : 0;
                    
                    // Statistical measures (using last 3 samples)
                    const avgRate = rates_mean; // Already calculated above
                    
                    // Calculate minimum rate from FULL DATASET (not just last 3 samples) - if it's 0 (absent from day 1), use second minimum for more meaningful analysis
                    let minRate = Math.min(...originalWeeklyRates);
                    if (minRate === 0 && originalWeeklyRates.length > 1) {
                        // Get sorted rates and find second minimum
                        const sortedRates = [...originalWeeklyRates].sort((a, b) => a - b);
                        // Find first non-zero value as more meaningful minimum
                        minRate = sortedRates.find(rate => rate > 0) || 0;
                    }
                    
                    // Calculate maximum rate from FULL DATASET - if it's 100% (perfect attendance), use second highest for more meaningful analysis
                    let maxRate = Math.max(...originalWeeklyRates);
                    if (maxRate === 100 && originalWeeklyRates.length > 1) {
                        // Get sorted rates and find second maximum
                        const sortedRates = [...originalWeeklyRates].sort((a, b) => b - a);
                        // Find first value less than 100% as more meaningful maximum
                        maxRate = sortedRates.find(rate => rate < 100) || 100;
                    }
                    
                    // RMSE (Root Mean Square Error) for trend accuracy (Last 3 Samples)
                    const rmse = trendWeeklyRates.length > 0 ? 
                        Math.sqrt(trendWeeklyRates.reduce((sum, rate, i) => sum + Math.pow(rate - fitted[i], 2), 0) / trendWeeklyRates.length) : 0;
                    
                    // Week-to-week changes array (for volatility analysis - Last 3 Samples)
                    const weekToWeekChanges = [];
                    for (let i = 1; i < trendWeeklyRates.length; i++) {
                        weekToWeekChanges.push(trendWeeklyRates[i] - trendWeeklyRates[i - 1]);
                    }
                    
                    // Volatility measure (standard deviation of week-to-week changes)
                    let volatility = 0;
                    if (weekToWeekChanges.length > 1) {
                        const changesMean = weekToWeekChanges.reduce((sum, val) => sum + val, 0) / weekToWeekChanges.length;
                        volatility = Math.sqrt(weekToWeekChanges.reduce((sum, val) => sum + Math.pow(val - changesMean, 2), 0) / weekToWeekChanges.length);
                    }
                    
                    // Moving average (3-week window, MATLAB-compatible - Last 3 Samples)
                    const windowSize = Math.min(3, n);
                    const movingAvg = [];
                    for (let i = 0; i < n; i++) {
                        const start = Math.max(0, i - Math.floor(windowSize / 2));
                        const end = Math.min(n, start + windowSize);
                        const window = trendWeeklyRates.slice(start, end);
                        const avg = window.reduce((sum, val) => sum + val, 0) / window.length;
                        movingAvg.push(avg);
                    }
                    
                    // Trend classification based on slope and R-squared
                    let trendClassification;
                    if (rSquared < 0.3) {
                        trendClassification = 'VOLATILE'; // Poor fit - inconsistent pattern
                    } else if (slope > 2) {
                        trendClassification = 'IMPROVING'; // Strong upward trend
                    } else if (slope < -2) {
                        trendClassification = 'DECLINING'; // Strong downward trend
                    } else {
                        trendClassification = 'STABLE'; // Minimal change
                    }
                    
                    console.log(`ðŸ“Š Sophisticated Linear Weekly Attendance Trend Analysis for ${studentName}:`, {
                        sortedDates: sortedClassDates,
                        totalDates: sortedClassDates.length,
                        includedDates: includedDates.length,
                        excludedExcused: sortedClassDates.length - includedDates.length,
                        weeklyRates: trendWeeklyRates.map(rate => rate.toFixed(2)),
                        ratesString: `[${trendWeeklyRates.map(rate => rate.toFixed(2)).join('  ')}]`, // MATLAB format with spacing (Last 3 Samples)
                        
                        // Linear regression results
                        slope: slope.toFixed(4),
                        intercept: intercept.toFixed(2),
                        rSquared: rSquared.toFixed(3),
                        
                        // Sophisticated Overall Statistics (MATLAB-style)
                        avgRate: `${avgRate.toFixed(2)}%`,
                        minRate: `${minRate.toFixed(1)}%`,
                        maxRate: `${maxRate.toFixed(1)}%`,
                        overallChange: `${overallChange.toFixed(1)}%`,
                        weekToWeekChange: `${weekToWeekChange.toFixed(1)}%`, // Most recent change
                        rmse: rmse.toFixed(3),
                        volatility: volatility.toFixed(3),
                        
                        // Week-to-week analysis
                        weekToWeekChanges: weekToWeekChanges.map(change => change.toFixed(1)),
                        
                        // Advanced analysis
                        movingAverage: movingAvg.map(avg => avg.toFixed(1)),
                        trendClassification: trendClassification,
                        fitQuality: rSquared >= 0.7 ? 'EXCELLENT' : rSquared >= 0.5 ? 'GOOD' : rSquared >= 0.3 ? 'FAIR' : 'POOR',
                        
                        dateMapping: trendIncludedDates.map((date, index) => ({
                            week: index + 1,
                            date: date,
                            cumulativeRate: trendWeeklyRates[index].toFixed(1) + '%',
                            movingAvg: movingAvg[index].toFixed(1) + '%'
                        })),
                        
                        // MATLAB-style sophisticated output (Last 3 Samples)
                        matlabStyleOutput: [
                            '--- Sophisticated Linear Weekly Attendance Trend (Last 3 Samples) ---',
                            `Weekly Rates: ${trendWeeklyRates.map(rate => rate.toFixed(2)).join('  ')}`,
                            `Average Rate: ${avgRate.toFixed(2)}%`,
                            `Min Rate: ${minRate.toFixed(1)}%, Max Rate: ${maxRate.toFixed(1)}%`,
                            `Slope (%/week): ${slope.toFixed(4)}`,
                            `Intercept: ${intercept.toFixed(2)}`,
                            `Overall Change: ${overallChange.toFixed(1)}%`,
                            `Week-to-Week Change: ${weekToWeekChange.toFixed(1)}%`,
                            `R-squared (fit quality): ${rSquared.toFixed(3)}`,
                            `RMSE: ${rmse.toFixed(3)}`,
                            `Volatility: ${volatility.toFixed(3)}`,
                            `Trend: ${trendClassification} ${slope > 2 ? 'ðŸ“ˆ' : slope < -2 ? 'ðŸ“‰' : 'âž¡ï¸'}`
                        ].join('\n'),
                        
                        // Analysis summary
                        analysisNote: `Analysis based on last ${trendWeeklyRates.length} samples out of ${originalWeeklyRates.length} total data points`,
                        originalDataCount: originalWeeklyRates.length,
                        trendDataCount: trendWeeklyRates.length,
                        
                        // Compact summary for table display
                        interpretation: `${trendClassification} (${slope > 0 ? '+' : ''}${slope.toFixed(2)}%/wk, RÂ²=${rSquared.toFixed(2)}, Î”=${weekToWeekChange > 0 ? '+' : ''}${weekToWeekChange.toFixed(1)}%)`
                    });
                    
                    // Return comprehensive sophisticated trend analysis with metadata
                    return {
                        slope: parseFloat(slope.toFixed(2)),
                        intercept: parseFloat(intercept.toFixed(2)),
                        rSquared: parseFloat(rSquared.toFixed(3)),
                        rmse: parseFloat(rmse.toFixed(3)),
                        classification: trendClassification,
                        overallChange: parseFloat(overallChange.toFixed(1)),
                        weekToWeekChange: parseFloat(weekToWeekChange.toFixed(1)),
                        avgRate: parseFloat(avgRate.toFixed(2)),
                        minRate: parseFloat(minRate.toFixed(1)),
                        maxRate: parseFloat(maxRate.toFixed(1)),
                        volatility: parseFloat(volatility.toFixed(3)),
                        weeklyRatesCount: trendWeeklyRates.length,
                        originalDataCount: originalWeeklyRates.length,
                        fitQuality: rSquared >= 0.7 ? 'EXCELLENT' : rSquared >= 0.5 ? 'GOOD' : rSquared >= 0.3 ? 'FAIR' : 'POOR',
                        displayValue: `${slope > 0 ? '+' : ''}${slope.toFixed(1)}%/wk (RÂ²=${rSquared.toFixed(2)})`,
                        sophisticatedSummary: `Avg:${avgRate.toFixed(1)}% | Î”:${weekToWeekChange > 0 ? '+' : ''}${weekToWeekChange.toFixed(1)}% | RMSE:${rmse.toFixed(1)}`
                    };
                };

                // Find all class dates from filtered data, sorted chronologically
                const allClassDates = [...new Set(filteredData.map(record => {
                    return record.datetime ? record.datetime.split(' ')[0] : 
                           record.date || record.timestamp?.split(' ')[0] || '';
                }).filter(date => date))].sort();
                
                console.log('ðŸ“… All class dates detected:', allClassDates);
                
                // Prepare data for both basic and advanced tables
                const basicTableData = [];
                const advancedTableData = [];
                
                attendanceRatesWithWeights.forEach((student, index) => {
                    const lateRecords = calculateLateRecordsForStudent(student.name);
                    const onTimeRecords = student.present - lateRecords; // On-Time = Present - Late Records
                    const consistencyIndex = calculateConsistencyIndex(student.name, allClassDates, filteredData);
                    const attendanceTrend = calculateAttendanceTrend(student.name, allClassDates, filteredData);
                    
                    // Calculate Engagement Index (EI) = (0.8 Ã— Rate) + (0.1 Ã— Punctuality) + (0.1 Ã— CI)
                    const punctualityRate = student.present > 0 ? (onTimeRecords / student.present) * 100 : 0;
                    const engagementIndex = (0.8 * student.rate) + (0.1 * punctualityRate) + (0.1 * consistencyIndex * 100);
                    
                    console.log(`ðŸ“ˆ EI calculation for ${student.name}:`, {
                        rate: student.rate,
                        punctualityRate: punctualityRate.toFixed(1),
                        ci: consistencyIndex.toFixed(3),
                        ei: engagementIndex.toFixed(1),
                        trend: attendanceTrend,
                        formula: `(0.8 Ã— ${student.rate}) + (0.1 Ã— ${punctualityRate.toFixed(1)}) + (0.1 Ã— ${(consistencyIndex * 100).toFixed(1)})`
                    });
                    
                    // Basic table data (core attendance metrics)
                    basicTableData.push([
                        (index + 1).toString(), // Add row number
                        student.name,
                        student.present.toString(),
                        student.absent.toString(),
                        student.vacation.toString(),
                        student.effectiveDaysCovered.toString(),
                        lateRecords.toString(), // Late Records column
                        onTimeRecords.toString() // On-Time column
                    ]);
                    
                    // Advanced table data (analytics and trends)
                    const weeklyChange = typeof attendanceTrend === 'object' && attendanceTrend.weekToWeekChange !== undefined && attendanceTrend.weekToWeekChange !== null
                        ? `${attendanceTrend.weekToWeekChange > 0 ? '+' : ''}${attendanceTrend.weekToWeekChange.toFixed(1)}%`
                        : '0.0%'; // Default to 0.0% instead of N/A when insufficient weekly data
                    
                    const minRate = typeof attendanceTrend === 'object' && attendanceTrend.minRate !== undefined && attendanceTrend.minRate !== null
                        ? `${attendanceTrend.minRate.toFixed(1)}%`
                        : `${student.rate.toFixed(1)}%`; // Use current rate instead of N/A when insufficient weekly data
                    
                    const maxRate = typeof attendanceTrend === 'object' && attendanceTrend.maxRate !== undefined && attendanceTrend.maxRate !== null
                        ? `${attendanceTrend.maxRate.toFixed(1)}%`
                        : `${student.rate.toFixed(1)}%`; // Use current rate instead of N/A when insufficient weekly data
                    
                    advancedTableData.push([
                        (index + 1).toString(), // Add row number for reference
                        student.name,
                        `${student.rate}%`, // Rate column (moved from basic table)
                        student.weightedScore.toString(), // Weighted Score column (moved from basic table)
                        weeklyChange, // Weekly Rate Change column
                        minRate, // Min Rate column
                        maxRate, // Max Rate column
                        typeof attendanceTrend === 'object' ? attendanceTrend.displayValue : attendanceTrend // Advanced Trend column with RÂ² info
                    ]);
                });
                
                // Basic Attendance Table - ensure header and table stay together
                // Reserve space for title + at least 3 table rows (approximately 60px)
                if (yPosition > 180) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                addSectionHeader(doc, 'Basic Attendance Summary', yPosition);
                yPosition += 12;
                
                doc.autoTable({
                    head: [['#', 'Student Name', 'Present', 'Absent', 'Num-Excuse', 'Effective Days', 'Late Records', 'On-Time']],
                    body: basicTableData,
                    startY: yPosition,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [52, 73, 94],
                        textColor: 255,
                        fontStyle: 'bold',
                        fontSize: 8
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 8 },    // #
                        1: { cellWidth: 45 },                     // Student Name (wider since Rate/Weighted Score removed)
                        2: { halign: 'center', cellWidth: 18 },   // Present
                        3: { halign: 'center', cellWidth: 18 },   // Absent
                        4: { halign: 'center', cellWidth: 24 },   // Num-Excuse
                        5: { halign: 'center', cellWidth: 28 },   // Effective Days
                        6: { halign: 'center', cellWidth: 24 },   // Late Records (was column 8)
                        7: { halign: 'center', cellWidth: 24 }    // On-Time (was column 9)
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 1.5,
                        overflow: 'linebreak',
                        cellWidth: 'wrap',
                        minCellHeight: 6
                    },
                    margin: { top: 1, left: 8, right: 8 },
                    tableWidth: 'auto',
                    showHead: 'everyPage',
                    pageBreak: 'avoid',
                    rowPageBreak: 'avoid',
                    didParseCell: function(data) {
                        // Basic table now has no special color coding since Rate and Weighted Score moved to Advanced table
                        if (data.section === 'body') {
                            // No special color coding needed for basic attendance metrics
                        }
                    }
                });
                
                yPosition = doc.lastAutoTable.finalY + 8;
                
                // Advanced Analytics Table - ensure header and table stay together
                // Reserve space for title + at least 3 table rows (approximately 60px)
                if (yPosition > 180) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                addSectionHeader(doc, 'Advanced Analytics & Trends', yPosition);
                yPosition += 12;
                
                doc.autoTable({
                    head: [['#', 'Student Name', 'Rate', 'Weighted Score', 'Weekly Change', 'Min Rate', 'Max Rate', 'Trend']],
                    body: advancedTableData,
                    startY: yPosition,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [141, 68, 173], // Purple theme for advanced analytics
                        textColor: 255,
                        fontStyle: 'bold',
                        fontSize: 8
                    },
                    alternateRowStyles: {
                        fillColor: [248, 246, 250] // Light purple
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 8 },    // #
                        1: { cellWidth: 38 },                     // Student Name
                        2: { halign: 'center', cellWidth: 18 },   // Rate (moved from basic table)
                        3: { halign: 'center', cellWidth: 22 },   // Weighted Score (moved from basic table)
                        4: { halign: 'center', cellWidth: 22 },   // Weekly Change
                        5: { halign: 'center', cellWidth: 20 },   // Min Rate
                        6: { halign: 'center', cellWidth: 20 },   // Max Rate
                        7: { halign: 'center', cellWidth: 48 }    // Trend
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 1.5,
                        overflow: 'linebreak',
                        cellWidth: 'wrap',
                        minCellHeight: 6
                    },
                    margin: { top: 1, left: 8, right: 8 },
                    tableWidth: 'auto',
                    showHead: 'everyPage',
                    pageBreak: 'avoid',
                    rowPageBreak: 'avoid',
                    didParseCell: function(data) {
                        // Advanced analytics color coding
                        if (data.section === 'body') {
                            // Color coding for Rate (moved from basic table - now column index 2)
                            if (data.column.index === 2 && data.cell.raw.includes('%')) { // Rate column
                                const rate = parseFloat(data.cell.raw);
                                if (rate >= 80) data.cell.styles.textColor = [46, 204, 113]; // Green
                                else if (rate >= 60) data.cell.styles.textColor = [243, 156, 18]; // Orange
                                else data.cell.styles.textColor = [220, 20, 20]; // Bright Red
                            }
                            
                            // Color coding for Weighted Score (moved from basic table - now column index 3)
                            if (data.column.index === 3) { // Weighted Score column
                                const weightedScore = parseFloat(data.cell.raw);
                                const classAverage = parseFloat(classAverageWeightedScore);
                                
                                if (weightedScore > classAverage + 10) {
                                    // Significantly above average (>10 points above)
                                    data.cell.styles.textColor = [0, 100, 0]; // Dark Forest Green
                                    data.cell.styles.fontStyle = 'bold';
                                } else if (weightedScore > classAverage + 5) {
                                    // Well above average (5-10 points above)
                                    data.cell.styles.textColor = [34, 139, 34]; // Dark Green
                                    data.cell.styles.fontStyle = 'bold';
                                } else if (weightedScore > classAverage) {
                                    // Above average (0-5 points above)
                                    data.cell.styles.textColor = [46, 204, 113]; // Light Green
                                } else if (weightedScore >= classAverage - 5) {
                                    // Near average (within 5 points below)
                                    data.cell.styles.textColor = [255, 140, 0]; // Dark Orange
                                } else if (weightedScore >= classAverage - 10) {
                                    // Below average (5-10 points below)
                                    data.cell.styles.textColor = [220, 20, 20]; // Bright Red
                                    data.cell.styles.fontStyle = 'bold';
                                } else {
                                    // Significantly below average (>10 points below)
                                    data.cell.styles.textColor = [139, 0, 0]; // Dark Red
                                    data.cell.styles.fontStyle = 'bold';
                                }
                            }
                            
                            // Color coding for Weekly Change (now column index 4)
                            if (data.column.index === 4) { // Weekly Change column
                                const changeText = data.cell.raw.toString();
                                const change = parseFloat(changeText.replace(/[^-+\d.]/g, ''));
                                    if (change >= 10) {
                                        // Excellent weekly improvement (â‰¥10%)
                                        data.cell.styles.textColor = [0, 100, 0]; // Dark Forest Green
                                        data.cell.styles.fontStyle = 'bold';
                                    } else if (change >= 5) {
                                        // Good weekly improvement (5-9.9%)
                                        data.cell.styles.textColor = [34, 139, 34]; // Dark Green
                                        data.cell.styles.fontStyle = 'bold';
                                    } else if (change > 0) {
                                        // Slight weekly improvement (0.1-4.9%)
                                        data.cell.styles.textColor = [46, 204, 113]; // Light Green
                                    } else if (change === 0) {
                                        // No change
                                        data.cell.styles.textColor = [100, 100, 100]; // Gray
                                    } else if (change > -5) {
                                        // Slight weekly decline (-0.1 to -4.9%)
                                        data.cell.styles.textColor = [255, 140, 0]; // Dark Orange
                                    } else if (change > -10) {
                                        // Moderate weekly decline (-5 to -9.9%)
                                        data.cell.styles.textColor = [220, 20, 20]; // Bright Red
                                    } else {
                                        // Significant weekly decline (â‰¤-10%)
                                        data.cell.styles.textColor = [139, 0, 0]; // Dark Red
                                        data.cell.styles.fontStyle = 'bold';
                                    }
                            }
                            
                            // Color coding for Min Rate (now column index 5)
                            if (data.column.index === 5) { // Min Rate column
                                const minRateText = data.cell.raw.toString();
                                const minRate = parseFloat(minRateText.replace('%', ''));
                                    if (minRate >= 90) {
                                        // Excellent minimum rate (â‰¥90%)
                                        data.cell.styles.textColor = [0, 100, 0]; // Dark Forest Green
                                        data.cell.styles.fontStyle = 'bold';
                                    } else if (minRate >= 80) {
                                        // Very good minimum rate (80-89%)
                                        data.cell.styles.textColor = [34, 139, 34]; // Dark Green
                                        data.cell.styles.fontStyle = 'bold';
                                    } else if (minRate >= 70) {
                                        // Good minimum rate (70-79%)
                                        data.cell.styles.textColor = [46, 204, 113]; // Light Green
                                    } else if (minRate >= 60) {
                                        // Fair minimum rate (60-69%)
                                        data.cell.styles.textColor = [243, 156, 18]; // Orange
                                    } else if (minRate >= 50) {
                                        // Poor minimum rate (50-59%)
                                        data.cell.styles.textColor = [220, 20, 20]; // Bright Red
                                    } else {
                                        // Very poor minimum rate (<50%)
                                        data.cell.styles.textColor = [139, 0, 0]; // Dark Red
                                        data.cell.styles.fontStyle = 'bold';
                                    }
                            }
                            
                            // Color coding for Max Rate (now column index 6)
                            if (data.column.index === 6) { // Max Rate column
                                const maxRateText = data.cell.raw.toString();
                                const maxRate = parseFloat(maxRateText.replace('%', ''));
                                    if (maxRate >= 95) {
                                        // Excellent maximum rate (â‰¥95%)
                                        data.cell.styles.textColor = [0, 100, 0]; // Dark Forest Green
                                        data.cell.styles.fontStyle = 'bold';
                                    } else if (maxRate >= 90) {
                                        // Very good maximum rate (90-94%)
                                        data.cell.styles.textColor = [34, 139, 34]; // Dark Green
                                        data.cell.styles.fontStyle = 'bold';
                                    } else if (maxRate >= 80) {
                                        // Good maximum rate (80-89%)
                                        data.cell.styles.textColor = [46, 204, 113]; // Light Green
                                    } else if (maxRate >= 70) {
                                        // Fair maximum rate (70-79%)
                                        data.cell.styles.textColor = [243, 156, 18]; // Orange
                                    } else if (maxRate >= 60) {
                                        // Poor maximum rate (60-69%)
                                        data.cell.styles.textColor = [220, 20, 20]; // Bright Red
                                    } else {
                                        // Very poor maximum rate (<60%)
                                        data.cell.styles.textColor = [139, 0, 0]; // Dark Red
                                        data.cell.styles.fontStyle = 'bold';
                                    }
                            }
                            
                            // Color coding for Advanced Trend Analysis
                            if (data.column.index === 7) { // Trend column (now index 7)
                                const trendText = data.cell.raw.toString();
                                
                                if (trendText.includes('+')) {
                                    // Positive trend (improving)
                                    const slope = parseFloat(trendText.match(/[+-]?\d+\.?\d*/)[0]);
                                    if (slope >= 5) {
                                        // Strong improvement (â‰¥5%/week)
                                        data.cell.styles.textColor = [0, 100, 0]; // Dark Forest Green
                                        data.cell.styles.fontStyle = 'bold';
                                    } else if (slope >= 2) {
                                        // Moderate improvement (2-4.9%/week)
                                        data.cell.styles.textColor = [34, 139, 34]; // Dark Green
                                    } else {
                                        // Slight improvement (0.1-1.9%/week)
                                        data.cell.styles.textColor = [46, 204, 113]; // Light Green
                                    }
                                } else if (trendText.includes('-')) {
                                    // Negative trend (declining)
                                    const slope = Math.abs(parseFloat(trendText.match(/[+-]?\d+\.?\d*/)[0]));
                                    if (slope >= 5) {
                                        // Strong decline (â‰¥5%/week decline)
                                        data.cell.styles.textColor = [139, 0, 0]; // Dark Red
                                        data.cell.styles.fontStyle = 'bold';
                                    } else if (slope >= 2) {
                                        // Moderate decline (2-4.9%/week decline)
                                        data.cell.styles.textColor = [220, 20, 20]; // Bright Red
                                    } else {
                                        // Slight decline (0.1-1.9%/week decline)
                                        data.cell.styles.textColor = [255, 140, 0]; // Dark Orange
                                    }
                                } else {
                                    // Stable trend (near 0%/week)
                                    data.cell.styles.textColor = [100, 100, 100]; // Gray
                                }
                            }
                        }
                    }
                });
                
                yPosition = doc.lastAutoTable.finalY + 8;
                
                // Check page break before Matrix Analysis - ensure header and table stay together
                if (yPosition > 180) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Add Dates with Highest Unexcused Absences Analysis (Matrix Intelligence)
                addSectionHeader(doc, 'DATES WITH HIGHEST UNEXCUSED ABSENCES (MATRIX ANALYSIS)', yPosition);
                yPosition += 12;
                
                // Use our intelligent matrix-based analysis
                const dateAbsenceAnalysis = analyzeDatesByUnexcusedAbsences(filteredData, totalStudents, allClassDates);
                
                if (dateAbsenceAnalysis.length > 0) {
                    // Show top 10 dates with highest unexcused absences
                    const topAbsenceDates = dateAbsenceAnalysis.slice(0, 10);
                    
                    const datesTableData = topAbsenceDates.map(item => [
                        item.date,
                        item.unexcusedAbsences.toString(),
                        item.presentCount.toString(),
                        item.excusedAbsences.toString(),
                        `${item.absenteeismRate.toFixed(1)}%`,
                        `${item.matrixZeros}/${item.accountableStudents}` // Matrix representation
                    ]);
                    
                    doc.autoTable({
                        head: [['Date', 'Unexcused\nAbsent', 'Present', 'Excused\nAbsent', 'Absence\nRate', 'Matrix\n(0s/Total)']],
                        body: datesTableData,
                        startY: yPosition,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [231, 76, 60], // Red theme for absence analysis
                            textColor: 255,
                            fontStyle: 'bold',
                            fontSize: 9
                        },
                        alternateRowStyles: {
                            fillColor: [255, 245, 245] // Light red alternating rows
                        },
                        columnStyles: {
                            0: { halign: 'center', cellWidth: 25 },  // Date
                            1: { halign: 'center', cellWidth: 20, fillColor: [255, 235, 235] }, // Unexcused (highlighted)
                            2: { halign: 'center', cellWidth: 18 },  // Present
                            3: { halign: 'center', cellWidth: 20 },  // Excused
                            4: { halign: 'center', cellWidth: 20 },  // Rate
                            5: { halign: 'center', cellWidth: 25, fontStyle: 'bold' }   // Matrix representation
                        },
                        styles: {
                            fontSize: 8,
                            cellPadding: 1.5,
                            overflow: 'linebreak',
                            minCellHeight: 5
                        },
                        margin: { top: 1, left: 8, right: 8 },
                        showHead: 'everyPage',
                        pageBreak: 'avoid',
                        rowPageBreak: 'avoid'
                    });
                    yPosition = doc.lastAutoTable.finalY + 6;
                    
                    // Summary insights and explanation text removed per user request
                    yPosition += 10;
                    
                } else {
                    doc.setFontSize(10);
                    doc.text('No unexcused absence data available for matrix analysis in the selected period.', 20, yPosition);
                    yPosition += 20;
                }
                
                // Add time-based analytics section - ensure header and content stay together
                if (yPosition > 180) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Time-Based Attendance Analytics
                addSectionHeader(doc, 'TIME-BASED ATTENDANCE ANALYTICS', yPosition);
                yPosition += 12;
                
                // Calculate time-based analytics from the filtered data
                const timeAnalytics = calculateTimeBasedAnalyticsForPDF(filteredData);
                
                // Add analytics explanation
                doc.setFontSize(10);
                doc.text('Analysis of attendance timing patterns based on 1:00-1:15 PM on-time window:', 20, yPosition);
                yPosition += 10;
                
                // Time analytics table
                const timeTableData = [
                    ['Category', 'Count'],
                    ['On-Time Records (1:00-1:15 PM)', timeAnalytics.onTimeRecords.toString()],
                    ['Late Records (After 1:15 PM)', timeAnalytics.lateRecords.toString()],
                    ['Absent Records', timeAnalytics.absentRecords.toString()],
                    ['Total Records', timeAnalytics.totalRecords.toString()],
                    ['Punctuality Rate', `${timeAnalytics.punctualityRate}%`]
                ];
                
                doc.autoTable({
                    body: timeTableData,
                    startY: yPosition,
                    theme: 'striped',
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    didParseCell: function(data) {
                        // Style the first row as header
                        if (data.row.index === 0) {
                            data.cell.styles.fillColor = [52, 73, 94];
                            data.cell.styles.textColor = [255, 255, 255];
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = 10;
                        }
                    },
                    columnStyles: {
                        0: { halign: 'left', cellWidth: 100 },   // Category
                        1: { halign: 'center', cellWidth: 50 }   // Count
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 1.5,
                        overflow: 'linebreak',
                        minCellHeight: 6
                    },
                    margin: { top: 1, left: 8, right: 8 },
                    pageBreak: 'avoid',
                    rowPageBreak: 'avoid'
                });
                yPosition = doc.lastAutoTable.finalY + 8;
                
                // Add Effective Attendance Rate Trend Analysis (Last Four Rates) - moved after TIME-BASED section
                if (yPosition > 180) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                addSectionHeader(doc, 'EFFECTIVE ATTENDANCE RATE TREND (LAST FOUR RATES)', yPosition);
                yPosition += 12;
                
                // Calculate effective attendance rate trend using last four rates
                const effectiveRateTrend = calculateEffectiveAttendanceRateTrend(filteredData, totalStudents, allClassDates);
                
                if (effectiveRateTrend && effectiveRateTrend !== 'INSUFFICIENT_DATA') {
                    // Trend Analysis Table
                    const trendData = [
                        ['Metric', 'Value'],
                        ['Analysis Scope', 'Last 4 Rates'],
                        ['Data Points Used', effectiveRateTrend.dataPoints.toString()],
                        ['Analysis Period', effectiveRateTrend.periodCoverage],
                        ['Full Data Period', effectiveRateTrend.fullPeriodCoverage || 'N/A'],
                        ['Average Effective Rate', `${effectiveRateTrend.avgRate.toFixed(1)}%`],
                        ['Rate Range (Last 4)', `${effectiveRateTrend.minRate.toFixed(1)}% - ${effectiveRateTrend.maxRate.toFixed(1)}%`],
                        ['Overall Change (Last 4)', `${effectiveRateTrend.overallChange > 0 ? '+' : ''}${effectiveRateTrend.overallChange.toFixed(1)}%`],
                        ['Trend Slope', `${effectiveRateTrend.slope > 0 ? '+' : ''}${effectiveRateTrend.slope.toFixed(3)}%/day`],
                        ['Fit Quality (RÂ²)', effectiveRateTrend.rSquared.toFixed(3)],
                        ['Trend Classification', effectiveRateTrend.classification],
                        ['RMSE', effectiveRateTrend.rmse.toFixed(2)]
                    ];
                    
                    doc.autoTable({
                        body: trendData,
                        startY: yPosition,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [52, 73, 94],
                            textColor: 255,
                            fontStyle: 'bold',
                            fontSize: 10
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        columnStyles: {
                            0: { fontStyle: 'bold', cellWidth: 70 },
                            1: { cellWidth: 50, halign: 'center' }
                        },
                        styles: {
                            fontSize: 8,
                            cellPadding: 1.5,
                            minCellHeight: 6
                        },
                        margin: { top: 1, left: 8, right: 8 },
                        pageBreak: 'avoid',
                        rowPageBreak: 'avoid'
                    });
                    yPosition = doc.lastAutoTable.finalY + 8;
                } else {
                    doc.setFontSize(10);
                    doc.text('Insufficient data for trend analysis (need at least 4 data points)', 20, yPosition);
                    yPosition += 20;
                }
                
                // Footer
                addFooter(doc);
                
                // Save the PDF
                const fileName = `Attendance_Analytics_${filterText}_${currentDate.replace(/\//g, '-')}.pdf`;
                doc.save(fileName);
                
                showMessage(`Analytics report exported successfully! 
${filteredData.length} records processed.
File: ${fileName}`, 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Error generating PDF report. Please try again.', 'error');
            } finally {
                // Reset button state
                const exportBtn = document.getElementById('exportAnalyticsPdfBtn');
                exportBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Export PDF';
                exportBtn.disabled = false;
            }
        }
        
        function calculateTimeBasedAnalyticsForPDF(filteredData) {
            console.log('ðŸ• Calculating time-based analytics for PDF...');
            
            // Time thresholds: On-Time: 1:00-1:15 PM, Late: after 1:15 PM
            const onTimeStart = "13:00"; // 1:00 PM in 24-hour format
            const onTimeEnd = "13:15";   // 1:15 PM in 24-hour format
            
            let onTimeRecords = 0;
            let lateRecords = 0;
            let absentRecords = 0;
            
            // Process all filtered records
            filteredData.forEach(record => {
                const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                
                if (status === 'absent' || status.includes('absent')) {
                    absentRecords++;
                } else if (status === 'present' || status.includes('present')) {
                    // Get time from record (could be in record.time or extracted from datetime)
                    let recordTime = record.time;
                    
                    // If no direct time field, try to extract from datetime/timestamp
                    if (!recordTime && record.datetime) {
                        const timePart = record.datetime.split(' ');
                        if (timePart.length > 1) {
                            recordTime = timePart[1];
                        }
                    }
                    
                    if (!recordTime && record.timestamp) {
                        const timePart = record.timestamp.split(' ');
                        if (timePart.length > 1) {
                            recordTime = timePart[1];
                        }
                    }
                    
                    if (recordTime && isTimeInRange(recordTime, onTimeStart, onTimeEnd)) {
                        onTimeRecords++;
                    } else if (recordTime) {
                        // Present but outside on-time window = Late
                        lateRecords++;
                    } else {
                        // Present but no time data - count as on-time for backward compatibility
                        onTimeRecords++;
                    }
                }
            });
            
            // Calculate punctuality rate
            const totalPresentRecords = onTimeRecords + lateRecords;
            const punctualityRate = totalPresentRecords > 0 ? 
                ((onTimeRecords / totalPresentRecords) * 100).toFixed(1) : '0.0';
            
            console.log('ðŸ“Š PDF Time Analysis Results:', {
                onTime: onTimeRecords,
                late: lateRecords,
                absent: absentRecords,
                total: filteredData.length,
                punctualityRate: punctualityRate
            });
            
            return {
                onTimeRecords,
                lateRecords,
                absentRecords,
                totalRecords: filteredData.length,
                punctualityRate
            };
        }

        function addSectionHeader(doc, title, yPosition) {
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.setTextColor(52, 152, 219);
            doc.text(title, 8, yPosition); // Changed from 20 to 8 to match table margins
            
            // Add underline - adjust line position to match new left margin
            doc.setLineWidth(0.5);
            doc.setDrawColor(52, 152, 219);
            doc.line(8, yPosition + 2, 202, yPosition + 2); // Adjusted from 20,190 to 8,202
        }
        
        function addTable(doc, data, yPosition, hasHeaders = false, headers = []) {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(44, 62, 80);
            
            let currentY = yPosition;
            
            // Reduced margins: left margin 8 (was 10), right margin 8 (was 10)
            // Available width: 194 (was 190) - gives more space for columns
            const leftMargin = 8;
            const availableWidth = 194;
            const textStartX = leftMargin + 3; // Reduced from 5 to 3
            
            // Define custom column widths for attendance table (15 columns with separators)
            let columnWidths;
            if (headers.length === 15 && headers[0] === '#') {
                // Custom widths for attendance table with # column and separators
                columnWidths = [12, 3, 30, 3, 18, 3, 18, 3, 22, 3, 18, 3, 30, 3, 18]; // Total: 194
            } else if (headers.length === 8 && headers[0] === '#') {
                // Custom widths for attendance table with # column (fallback)
                columnWidths = [6, 47, 12, 12, 22, 40, 20, 22]; // Total: 194
            } else {
                // Equal width for other tables
                const colWidth = availableWidth / (headers.length || data[0].length);
                columnWidths = new Array(headers.length || data[0].length).fill(colWidth);
            }
            
            // Add headers if provided
            if (hasHeaders && headers.length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.setFillColor(240, 240, 240);
                doc.rect(leftMargin, currentY - 5, availableWidth, 8, 'F');
                
                let xOffset = 0;
                headers.forEach((header, index) => {
                    let headerXPosition = textStartX + xOffset;
                    
                    // Special alignment for "Rate" header (index 12) - shift right
                    if (header === 'Rate' && index === 12) {
                        const textWidth = doc.getTextWidth(header);
                        headerXPosition = textStartX + xOffset + (columnWidths[index] - textWidth) / 2 + 5; // Center + 5 units right
                    }
                    
                    doc.text(header, headerXPosition, currentY);
                    xOffset += columnWidths[index];
                });
                currentY += 10;
                doc.setFont('helvetica', 'normal');
            }
            
            // Add data rows
            data.forEach((row, index) => {
                // Alternate row colors
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(leftMargin, currentY - 5, availableWidth, 8, 'F');
                }
                
                let xOffset = 0;
                row.forEach((cell, cellIndex) => {
                    const text = cell.toString();
                    const xPosition = textStartX + xOffset;
                    
                    // Color coding for rates
                    if (text.includes('%') && (cellIndex === 12 || cellIndex === 14)) { // Rate and Weighted Score columns
                        const rate = parseFloat(text);
                        if (rate >= 80) doc.setTextColor(46, 204, 113); // Green
                        else if (rate >= 60) doc.setTextColor(243, 156, 18); // Orange
                        else doc.setTextColor(231, 76, 60); // Red
                    } else {
                        doc.setTextColor(44, 62, 80);
                    }
                    
                    // Handle alignment based on column type
                    if (text === '|') {
                        // Center align separator
                        const textWidth = doc.getTextWidth(text);
                        doc.text(text, xPosition + (columnWidths[cellIndex] - textWidth) / 2, currentY);
                    } else if (cellIndex === 0 && headers[0] === '#') {
                        // Center align # column
                        const textWidth = doc.getTextWidth(text);
                        doc.text(text, xPosition + (columnWidths[cellIndex] - textWidth) / 2, currentY);
                    } else if (headers.length === 15 && (cellIndex === 4 || cellIndex === 6 || cellIndex === 8 || cellIndex === 10 || cellIndex === 12 || cellIndex === 14)) {
                        // Center align numeric columns (Present, Absent, Num-Excuse, Effective Days, Rate, Weighted Score)
                        const textWidth = doc.getTextWidth(text);
                        doc.text(text, xPosition + (columnWidths[cellIndex] - textWidth) / 2, currentY);
                    } else if (cellIndex === 2 && headers.length === 15) {
                        // Left align Student Name column
                        doc.text(text, xPosition, currentY);
                    } else if (cellIndex >= 2 && cellIndex <= 7 && headers.length === 8) {
                        // Fallback: Center align numeric columns for 8-column layout
                        const textWidth = doc.getTextWidth(text);
                        doc.text(text, xPosition + (columnWidths[cellIndex] - textWidth) / 2, currentY);
                    } else {
                        // Default left align
                        doc.text(text, xPosition, currentY);
                    }
                    
                    xOffset += columnWidths[cellIndex];
                });
                currentY += 8;
            });
        }
        
        function addFooter(doc) {
            const pageCount = doc.internal.getNumberOfPages();
            
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                
                // Footer line
                doc.setLineWidth(0.5);
                doc.setDrawColor(200, 200, 200);
                doc.line(20, 285, 190, 285);
                
                // Footer text
                doc.text(`Class Attendance System - Generated on ${new Date().toLocaleString()}`, 20, 290);
                doc.text(`Page ${i} of ${pageCount}`, 170, 290);
            }
        }
        
        function calculateSummaryStats(data) {
            const totalRecords = data.length;
            
            // Count unique students by their display names
            const uniqueStudentKeys = new Set(data.map(record => record.student || record.name || 'Unknown'));
            const uniqueStudentNames = new Set();
            uniqueStudentKeys.forEach(key => {
                if (key !== 'Unknown') {
                    uniqueStudentNames.add(getStudentDisplayName(key));
                }
            });
            
            const presentRecords = data.filter(record => record.status === 'present').length;
            const absentRecords = data.filter(record => record.status === 'absent').length;
            
            // Handle different datetime formats safely
            const uniqueDays = new Set(data.map(record => {
                let dateStr = record.datetime || record.date || record.timestamp || '';
                if (typeof dateStr === 'string' && dateStr.includes(' ')) {
                    return dateStr.split(' ')[0];
                } else if (typeof dateStr === 'string') {
                    return dateStr;
                } else {
                    return new Date().toISOString().split('T')[0]; // fallback to today
                }
            }).filter(date => date)).size;
            
            // Calculate total vacation days across all students
            const totalVacationDays = data.filter(record => 
                record.status === 'absent' && isExcusedAbsence(record.notes)
            ).length;
            
            // Calculate overall effective attendance rate as: âˆ‘(Presents) / âˆ‘(Effective Days) Ã— 100
            // Where Effective Days = (Days Covered Ã— Total Students) - Total Vacation Days
            const expectedTotalAttendance = uniqueDays * uniqueStudentNames.size;
            const effectiveTotalDays = expectedTotalAttendance - totalVacationDays;
            const overallAttendanceRate = effectiveTotalDays > 0 ? ((presentRecords / effectiveTotalDays) * 100).toFixed(1) : '0.0';
            
            return {
                totalRecords,
                totalStudents: uniqueStudentNames.size,
                presentRecords,
                absentRecords,
                overallAttendanceRate,
                daysCovered: uniqueDays
            };
        }
        
        // Helper function to check if an absence is excused (vacation/abroad)
        function isExcusedAbsence(notes) {
            if (!notes) return false;
            const notesLower = notes.toLowerCase();
            return notesLower.includes('on vacation') || 
                   notesLower.includes('abroad-excused') ||
                   notes === 'Abroad-excused'; // Exact match for dropdown selection
        }
        
        function calculateAttendanceRates(data) {
            const studentStats = {};
            
            // Calculate global days covered for the entire report period
            const globalDates = new Set();
            data.forEach(record => {
                const recordDate = record.datetime || record.date || record.timestamp || '';
                let dateStr = '';
                if (typeof recordDate === 'string' && recordDate.includes(' ')) {
                    dateStr = recordDate.split(' ')[0];
                } else if (typeof recordDate === 'string') {
                    dateStr = recordDate;
                } else {
                    dateStr = new Date().toISOString().split('T')[0]; // fallback to today
                }
                globalDates.add(dateStr);
            });
            const globalDaysCovered = globalDates.size;
            
            data.forEach(record => {
                // Try multiple fields to get the student key - prioritize ID fields first
                const studentKey = record.student || record.studentId || record.name || record.studentName || 'Unknown Student';
                if (!studentKey || studentKey === 'Unknown Student') return; // Skip invalid records
                
                if (!studentStats[studentKey]) {
                    studentStats[studentKey] = { present: 0, absent: 0, vacation: 0, total: 0 };
                }
                
                studentStats[studentKey].total++;
                if (record.status === 'present') {
                    studentStats[studentKey].present++;
                } else if (record.status === 'absent') {
                    studentStats[studentKey].absent++;
                    // Check if this absence is excused (vacation/abroad)
                    if (isExcusedAbsence(record.notes)) {
                        studentStats[studentKey].vacation++;
                    }
                }
            });
            
            return Object.keys(studentStats).map(studentKey => {
                const stats = studentStats[studentKey];
                
                // Calculate effective days covered (exclude vacation days for this student)
                const effectiveDaysCovered = globalDaysCovered - stats.vacation;
                
                // Calculate attendance rate based on effective days covered
                // If student has vacation days: (present / (daysCovered - vacationDays)) * 100
                // If no vacation days: (present / daysCovered) * 100
                const rate = effectiveDaysCovered > 0 ? ((stats.present / effectiveDaysCovered) * 100).toFixed(1) : '0.0';
                const displayName = getStudentDisplayName(studentKey);
                
                return {
                    name: displayName,
                    present: stats.present,
                    absent: stats.absent,
                    vacation: stats.vacation,
                    total: stats.total,
                    daysCovered: globalDaysCovered,
                    effectiveDaysCovered: effectiveDaysCovered,
                    rate: parseFloat(rate)
                };
            }).sort((a, b) => b.rate - a.rate);
        }
        
        function calculateAbsenceAnalysis(data) {
            const globalDaysCovered = parseInt(document.getElementById('daysCovered')?.value) || 1;
            
            // Use the same logic as calculateAttendanceRates to ensure consistency
            const attendanceRates = calculateAttendanceRates(data);
            
            return attendanceRates.map(student => {
                const effectiveDays = student.effectiveDaysCovered || student.daysCovered;
                const absentDays = Math.max(0, effectiveDays - student.present);
                const absenceRate = effectiveDays > 0 ? (absentDays / effectiveDays) * 100 : 0;
                
                return {
                    name: student.name,
                    count: absentDays,
                    percentage: parseFloat(absenceRate.toFixed(1))
                };
            }).filter(item => item.count > 0) // Only show students with absences
              .sort((a, b) => b.count - a.count);
        }
        
        function getPeriodDisplayName(period) {
            const periodNames = {
                'all': 'All Time',
                'last7days': 'Last 7 Days',
                'last30days': 'Last 30 Days',
                'thismonth': 'This Month',
                'lastmonth': 'Last Month'
            };
            return periodNames[period] || 'All Time';
        }

        function getActualDateRange(data) {
            if (!data || data.length === 0) {
                return 'No data';
            }
            
            // Extract dates from the data and sort them
            const dates = data.map(record => {
                let dateStr = record.datetime || record.date || record.timestamp || '';
                
                // Handle different date formats
                if (typeof dateStr === 'string') {
                    // If it contains both date and time, extract just the date part
                    if (dateStr.includes(' ')) {
                        dateStr = dateStr.split(' ')[0];
                    }
                    // Convert to Date object
                    const date = new Date(dateStr);
                    return isNaN(date.getTime()) ? null : date;
                }
                return null;
            }).filter(date => date !== null);
            
            if (dates.length === 0) {
                return 'No valid dates';
            }
            
            // Sort dates
            dates.sort((a, b) => a.getTime() - b.getTime());
            
            const earliestDate = dates[0];
            const latestDate = dates[dates.length - 1];
            
            // Format dates as MM/DD/YYYY
            const formatDate = (date) => {
                return date.toLocaleDateString('en-US', {
                    month: 'numeric',
                    day: 'numeric',
                    year: 'numeric'
                });
            };
            
            // If same day, show just that day
            if (earliestDate.toDateString() === latestDate.toDateString()) {
                return formatDate(earliestDate);
            }
            
            // Otherwise show range with simple ASCII arrow
            return `${formatDate(earliestDate)} - ${formatDate(latestDate)}`;
        }

        function getActualDateRangeFromTable(tableRows) {
            if (!tableRows || tableRows.length === 0) {
                return 'No data';
            }
            
            // Extract dates from the table rows
            const dates = [];
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const dateStr = cells[3].textContent.trim(); // Date column
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        dates.push(date);
                    }
                }
            });
            
            if (dates.length === 0) {
                return 'No valid dates';
            }
            
            // Sort dates
            dates.sort((a, b) => a.getTime() - b.getTime());
            
            const earliestDate = dates[0];
            const latestDate = dates[dates.length - 1];
            
            // Format dates as MM/DD/YYYY
            const formatDate = (date) => {
                return date.toLocaleDateString('en-US', {
                    month: 'numeric',
                    day: 'numeric',
                    year: 'numeric'
                });
            };
            
            // If same day, show just that day
            if (earliestDate.toDateString() === latestDate.toDateString()) {
                return formatDate(earliestDate);
            }
            
            // Otherwise show range with simple ASCII arrow
            return `${formatDate(earliestDate)} - ${formatDate(latestDate)}`;
        }

        // Analytics Functions
        function toggleAnalyticsView() {
            const isVisible = elements.analyticsSection.style.display !== 'none';
            
            if (isVisible) {
                elements.viewAnalyticsBtn.innerHTML = '<i class="fas fa-chart-line"></i> View Analytics';
                elements.analyticsSection.style.display = 'none';
            } else {
                elements.viewAnalyticsBtn.innerHTML = '<i class="fas fa-chart-line"></i> Hide Analytics';
                elements.analyticsSection.style.display = 'block';
                generateAnalytics();
                
                // Scroll to analytics section
                elements.analyticsSection.scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }
        }

        function generateAnalytics() {
            const filterPeriod = document.getElementById('analyticsFilter').value;
            console.log('ðŸ”„ IMPROVED ANALYTICS: Generating data-driven insights for period:', filterPeriod);
            
            // Clear any cached data to ensure fresh calculation
            console.log('ðŸ§¹ Clearing cache and forcing fresh data calculation');
            
            const filteredData = getAnalyticsData(filterPeriod);
            
            console.log('ðŸ“Š Analytics Data Quality Check:', {
                period: filterPeriod,
                recordCount: filteredData.length,
                uniqueStudents: [...new Set(filteredData.map(r => r.studentId || r.studentName))].length,
                dataTypes: filteredData.slice(0, 3).map(r => ({
                    student: r.studentId || r.studentName,
                    status: r.attendanceStatus || r.action,
                    date: r.date
                }))
            });
            
            if (filteredData.length === 0) {
                console.log('âŒ No data available for analysis - showing empty state');
                showEmptyAnalytics();
                return;
            }

            console.log('âœ… Proceeding with improved analytics generation...');
            // Generate all analytics with improved algorithms
            generateAttendanceRateAnalytics(filteredData);
            generateMatrixAbsenceAnalytics(filteredData); // New intelligent matrix analysis
            generateDetailedStudentStats(filteredData);
        }

        function getAnalyticsData(period) {
            // First ensure we have data - if attendanceData is empty, try to load from table
            let dataSource = attendanceData && attendanceData.length > 0 ? attendanceData : [];
            
            // If still no data, try to parse from the displayed table
            if (dataSource.length === 0) {
                console.log('Parsing data from table...');
                const tableRows = document.querySelectorAll('#recordsTableBody tr');
                console.log('Found table rows:', tableRows.length);
                
                tableRows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 4) {
                        const studentCell = cells[1].textContent.trim();
                        const statusCell = cells[2].textContent.trim();
                        const dateCell = cells[3].textContent.trim();
                        
                        console.log(`Row ${index}:`, { studentCell, statusCell, dateCell });
                        
                        // Extract student ID and name from format "STU001 - Baraa Takala"
                        let studentId = '';
                        let studentName = '';
                        
                        if (studentCell.includes(' - ')) {
                            const parts = studentCell.split(' - ');
                            studentId = parts[0].trim();
                            studentName = parts[1].trim();
                        } else {
                            studentId = studentCell;
                            studentName = studentCell;
                        }
                        
                        // Map status to proper format
                        let mappedStatus = statusCell.toLowerCase().trim();
                        if (mappedStatus === 'present' || mappedStatus === 'absent') {
                            dataSource.push({
                                student: studentName || studentId, // Use student name primarily
                                studentId: studentId,
                                studentName: studentName,
                                status: mappedStatus, // Use the correct property name
                                action: statusCell,
                                attendanceStatus: mappedStatus,
                                datetime: dateCell,
                                date: dateCell
                            });
                        }
                    }
                });
                
                console.log('Parsed data from table:', dataSource.length, 'records');
            }
            
            console.log('Analytics Data Source:', {
                period: period,
                totalRecords: dataSource.length,
                sampleRecord: dataSource[0],
                uniqueStudents: [...new Set(dataSource.map(r => r.studentId || r.studentName))],
                sampleStudentData: dataSource.slice(0, 3)
            });
            
            const now = new Date();
            let startDate = new Date(0); // Default to beginning of time
            
            switch(period) {
                case 'last7days':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'last30days':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'thismonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'lastmonth':
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    return dataSource.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate >= lastMonth && recordDate < thisMonth;
                    });
                case 'all':
                default:
                    return dataSource; // All time
            }
            
            return dataSource.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= startDate;
            });
        }

        function generateAttendanceRateAnalytics(data) {
            const studentStats = {};
            
            // Calculate global days covered for the entire report period
            const globalDates = new Set();
            data.forEach(record => {
                const recordDate = record.datetime || record.date || record.timestamp || '';
                let dateStr = '';
                if (typeof recordDate === 'string' && recordDate.includes(' ')) {
                    dateStr = recordDate.split(' ')[0];
                } else if (typeof recordDate === 'string') {
                    dateStr = recordDate;
                } else {
                    dateStr = new Date().toISOString().split('T')[0]; // fallback to today
                }
                globalDates.add(dateStr);
            });
            const globalDaysCovered = globalDates.size;
            
            // Calculate attendance rates for each student
            data.forEach(record => {
                const studentKey = record.studentId || record.studentName || 'Unknown';
                const studentName = record.studentName || studentKey;
                
                if (!studentStats[studentKey]) {
                    studentStats[studentKey] = {
                        name: studentName,
                        total: 0,
                        present: 0,
                        absent: 0,
                        vacation: 0
                    };
                }
                
                studentStats[studentKey].total++;
                
                // Check for present status - handle multiple formats
                const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                if (status === 'present' || record.actionType === 'check-in' || status.includes('present')) {
                    studentStats[studentKey].present++;
                } else if (status === 'absent' || status.includes('absent')) {
                    studentStats[studentKey].absent++;
                    // Check if this absence is excused (vacation/abroad)
                    if (isExcusedAbsence(record.notes)) {
                        studentStats[studentKey].vacation++;
                    }
                }
            });
            
            // Calculate percentages using effective days covered and sort
            const studentsWithRates = Object.values(studentStats).map(student => {
                // Calculate effective days covered (excluding vacation days)
                const effectiveDaysCovered = globalDaysCovered - student.vacation;
                
                // Calculate attendance rate using effective days covered
                const rate = effectiveDaysCovered > 0 ? (student.present / effectiveDaysCovered) * 100 : 0;
                
                // Calculate time-based analytics for this student
                const calculateLateRecordsForStudent = (studentName) => {
                    let lateCount = 0;
                    const onTimeStart = "13:00"; // 1:00 PM
                    const onTimeEnd = "13:15";   // 1:15 PM
                    
                    data.forEach(record => {
                        const recordStudent = record.studentName || record.studentId || 'Unknown';
                        const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                        
                        // Check if this record belongs to the student and is present
                        if (recordStudent === studentName && (status === 'present' || status.includes('present'))) {
                            // Get time from record
                            let recordTime = record.time;
                            
                            // If no direct time field, try to extract from datetime/timestamp
                            if (!recordTime && record.datetime) {
                                const timePart = record.datetime.split(' ');
                                if (timePart.length > 1) {
                                    recordTime = timePart[1];
                                }
                            }
                            
                            if (!recordTime && record.timestamp) {
                                const timePart = record.timestamp.split(' ');
                                if (timePart.length > 1) {
                                    recordTime = timePart[1];
                                }
                            }
                            
                            // Check if time is outside the on-time window (late)
                            if (recordTime && !isTimeInRange(recordTime, onTimeStart, onTimeEnd)) {
                                lateCount++;
                            }
                        }
                    });
                    
                    return lateCount;
                };
                
                const lateRecords = calculateLateRecordsForStudent(student.name);
                const onTimeRecords = student.present - lateRecords;
                
                // Calculate weighted score using comprehensive 8-case system
                const effectiveDaysPercentage = globalDaysCovered > 0 ? (effectiveDaysCovered / globalDaysCovered * 100) : 0;
                const excusePercentage = globalDaysCovered > 0 ? (student.vacation / globalDaysCovered * 100) : 0;
                const punctualityPercentage = student.present > 0 ? (onTimeRecords / student.present * 100) : 0;
                const latePercentage = student.present > 0 ? (lateRecords / student.present * 100) : 0;
                
                let weightedScore;
                
                // Comprehensive 8-case weighted score system
                if (student.vacation === 0 && onTimeRecords === 0 && lateRecords === 0) {
                    // Case 1: Num-Excuse = 0, On-Time = 0, Late = 0
                    weightedScore = (0.95 * rate) + (0.05 * punctualityPercentage);
                } else if (student.vacation === 0 && onTimeRecords > 0 && lateRecords === 0) {
                    // Case 2: Num-Excuse = 0, On-Time > 0, Late = 0
                    weightedScore = (0.95 * rate) + (0.05 * punctualityPercentage);
                } else if (student.vacation === 0 && onTimeRecords === 0 && lateRecords > 0) {
                    // Case 3: Num-Excuse = 0, On-Time = 0, Late > 0
                    weightedScore = (0.95 * rate) + (0.05 * punctualityPercentage);
                } else if (student.vacation === 0 && onTimeRecords > 0 && lateRecords > 0) {
                    // Case 4: Num-Excuse = 0, On-Time > 0, Late > 0
                    weightedScore = (0.95 * rate) + (0.05 * punctualityPercentage);
                } else if (student.vacation > 0 && onTimeRecords === 0 && lateRecords === 0) {
                    // Case 5: Num-Excuse > 0, On-Time = 0, Late = 0
                    weightedScore = (0.7 * rate) + (0.3 * effectiveDaysPercentage);
                } else if (student.vacation > 0 && onTimeRecords > 0 && lateRecords === 0) {
                    // Case 6: Num-Excuse > 0, On-Time > 0, Late = 0
                    weightedScore = (0.65 * rate) + (0.3 * effectiveDaysPercentage) + (0.05 * punctualityPercentage);
                } else if (student.vacation > 0 && onTimeRecords === 0 && lateRecords > 0) {
                    // Case 7: Num-Excuse > 0, On-Time = 0, Late > 0
                    weightedScore = (0.65 * rate) + (0.3 * effectiveDaysPercentage) + (0.05 * punctualityPercentage);
                } else if (student.vacation > 0 && onTimeRecords > 0 && lateRecords > 0) {
                    // Case 8: Num-Excuse > 0, On-Time > 0, Late > 0
                    weightedScore = (0.65 * rate) + (0.3 * effectiveDaysPercentage) + (0.05 * punctualityPercentage);
                } else {
                    // Fallback to original simple formula if something goes wrong
                    weightedScore = (0.95 * rate) + (0.05 * punctualityPercentage);
                }

                return {
                    ...student,
                    attendanceRate: rate.toFixed(1),
                    numericRate: rate,
                    weightedScore: Math.round(weightedScore * 10) / 10,
                    daysCovered: globalDaysCovered,
                    effectiveDaysCovered: effectiveDaysCovered,
                    onTimeRecords: onTimeRecords,
                    lateRecords: lateRecords
                };
            });
            
            // Highest weighted scores (best to worst)
            const highest = studentsWithRates
                .sort((a, b) => b.weightedScore - a.weightedScore)
                .slice(0, 5);
            
            // Lowest weighted scores (worst to best)
            const lowest = studentsWithRates
                .sort((a, b) => a.weightedScore - b.weightedScore)
                .slice(0, 5);
            
            updateAttendanceRateDisplay(highest, lowest);
        }

        function updateAttendanceRateDisplay(highest, lowest) {
            const highestList = document.getElementById('highestAttendanceList');
            const lowestList = document.getElementById('lowestAttendanceList');
            
            // Highest weighted scores
            if (highest.length > 0) {
                highestList.innerHTML = highest.map(student => `
                    <li>
                        <span>${student.name}</span>
                        <span class="analytics-percentage percentage-high">${student.weightedScore}</span>
                    </li>
                `).join('');
            } else {
                highestList.innerHTML = '<li class="analytics-empty">No data available</li>';
            }
            
            // Lowest weighted scores
            if (lowest.length > 0) {
                lowestList.innerHTML = lowest.map(student => {
                    const percentClass = student.weightedScore >= 80 ? 'percentage-high' : 
                                       student.weightedScore >= 60 ? 'percentage-medium' : 'percentage-low';
                    return `
                        <li>
                            <span>${student.name}</span>
                            <span class="analytics-percentage ${percentClass}">${student.weightedScore}</span>
                        </li>
                    `;
                }).join('');
            } else {
                lowestList.innerHTML = '<li class="analytics-empty">No data available</li>';
            }
        }



        function generateMatrixAbsenceAnalytics(data) {
            console.log('ðŸ§® MATRIX ANALYSIS: Starting intelligent absence pattern detection...');
            
            // Get unique students and dates from data
            const uniqueStudents = [...new Set(data.map(record => 
                record.studentName || record.studentId || 'Unknown'
            ))];
            
            const uniqueDates = [...new Set(data.map(record => {
                const recordDate = record.datetime ? record.datetime.split(' ')[0] : 
                                 record.date || record.timestamp?.split(' ')[0] || '';
                return recordDate;
            }))].filter(date => date).sort();
            
            console.log('ðŸ“Š Matrix dimensions:', {
                students: uniqueStudents.length,
                dates: uniqueDates.length,
                totalRecords: data.length
            });
            
            // Use our intelligent matrix analysis function
            const matrixAnalysis = analyzeDatesByUnexcusedAbsences(data, uniqueStudents.length, uniqueDates);
            
            if (matrixAnalysis.length === 0) {
                updateMatrixAnalyticsDisplay([], null);
                return;
            }
            
            // Calculate summary insights
            const insights = {
                worstDate: matrixAnalysis[0],
                bestDate: matrixAnalysis[matrixAnalysis.length - 1],
                avgAbsenteeism: matrixAnalysis.reduce((sum, item) => sum + item.absenteeismRate, 0) / matrixAnalysis.length,
                totalDates: matrixAnalysis.length,
                maxAbsences: Math.max(...matrixAnalysis.map(item => item.unexcusedAbsences)),
                totalMatrixZeros: matrixAnalysis.reduce((sum, item) => sum + item.matrixZeros, 0)
            };
            
            console.log('ðŸŽ¯ Matrix Analysis Results:', {
                worstDate: insights.worstDate.date,
                maxAbsences: insights.maxAbsences,
                avgAbsenteeism: insights.avgAbsenteeism.toFixed(1) + '%',
                matrixIntelligence: 'Using CI binary logic (1/0) for pattern detection'
            });
            
            // Update the display
            updateMatrixAnalyticsDisplay(matrixAnalysis.slice(0, 10), insights); // Show top 10
        }

        function updateMatrixAnalyticsDisplay(matrixData, insights) {
            const container = document.getElementById('matrixAbsenceTimeline');
            const insightsContainer = document.getElementById('matrixInsights');
            
            if (!container) {
                console.error('Matrix analytics container not found');
                return;
            }
            
            if (matrixData.length === 0) {
                container.innerHTML = '<div class="analytics-empty">No matrix data available for the selected period</div>';
                if (insightsContainer) {
                    insightsContainer.style.display = 'none';
                }
                return;
            }
            
            // Update insights cards
            if (insights && insightsContainer) {
                insightsContainer.style.display = 'block';
                document.getElementById('worstAbsenceDate').textContent = insights.worstDate.date;
                document.getElementById('maxAbsences').textContent = insights.maxAbsences.toString();
                document.getElementById('avgAbsenteeism').textContent = insights.avgAbsenteeism.toFixed(1) + '%';
                document.getElementById('matrixZeros').textContent = insights.totalMatrixZeros.toString();
            }
            
            // Generate matrix timeline HTML
            const timelineHTML = matrixData.map(item => `
                <div class="matrix-date-item">
                    <div class="matrix-date-info">
                        <div class="matrix-date">${item.date}</div>
                        <div class="matrix-binary">${item.matrixZeros}/${item.accountableStudents}</div>
                    </div>
                    <div class="matrix-stats">
                        <div class="matrix-stat absences">
                            <i class="fas fa-times-circle"></i>
                            <span>${item.unexcusedAbsences} absent</span>
                        </div>
                        <div class="matrix-stat present">
                            <i class="fas fa-check-circle"></i>
                            <span>${item.presentCount} present</span>
                        </div>
                        <div class="matrix-stat rate">
                            <i class="fas fa-percentage"></i>
                            <span>${item.absenteeismRate.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = timelineHTML;
        }

        // Functions for collapsible sections and tabs
        function toggleSection(param) {
            try {
                let content, toggle;
                
                // Handle both string ID and DOM element parameters
                if (typeof param === 'string') {
                    // Old way: toggleSection('content-id')
                    content = document.getElementById(param);
                    toggle = document.getElementById(param + '-icon');
                    
                    if (content && toggle) {
                        if (content.classList.contains('collapsed')) {
                            content.classList.remove('collapsed');
                            content.classList.add('expanded');
                            toggle.classList.add('rotated');
                        } else {
                            content.classList.remove('expanded');
                            content.classList.add('collapsed');
                            toggle.classList.remove('rotated');
                        }
                    }
                } else if (param && param.nextElementSibling) {
                    // New way: toggleSection(this) - DOM element
                    const headerElement = param;
                    content = headerElement.nextElementSibling;
                    toggle = headerElement.querySelector('.section-toggle');
                    
                    if (content) {
                        if (content.classList.contains('active')) {
                            content.classList.remove('active');
                            if (toggle) toggle.classList.remove('active');
                            content.style.display = 'none';
                        } else {
                            content.classList.add('active');
                            if (toggle) toggle.classList.add('active');
                            content.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Error in toggleSection:', error);
            }
        }



        function generateDetailedStudentStats(data) {
            // Use the same reliable data processing as PDF export
            // Clean and validate each record first, exactly like the PDF export does
            const cleanedData = data.filter(record => {
                return record && 
                       (record.student || record.studentId || record.studentName || record.name) && 
                       (record.status === 'present' || record.status === 'absent' || 
                        record.attendanceStatus === 'present' || record.attendanceStatus === 'absent' ||
                        record.action === 'present' || record.action === 'absent');
            }).map(record => ({
                student: record.student || record.studentName || record.studentId || record.name || 'Unknown Student',
                status: record.status || record.attendanceStatus || record.action || 'unknown',
                datetime: record.datetime || record.date || record.timestamp || new Date().toISOString(),
                notes: record.notes || '',
                location: record.location || ''
            }));
            
            // Use the same reliable calculation logic as the PDF export
            const attendanceRates = calculateAttendanceRates(cleanedData);
            
            console.log('ðŸ“Š Charts using same reliable data as PDF:', {
                originalRecords: data.length,
                cleanedRecords: cleanedData.length,
                calculatedStudents: attendanceRates.length,
                sampleStudent: attendanceRates[0],
                fullStudentData: attendanceRates.slice(0, 3).map(s => ({
                    name: s.name,
                    present: s.present,
                    absent: s.absent,
                    vacation: s.vacation,
                    effectiveDays: s.effectiveDaysCovered,
                    rate: s.rate
                }))
            });
            
            // Convert the reliable PDF data format to chart display format
            const detailedStats = attendanceRates.map(student => ({
                name: student.name,
                totalRecords: student.total,
                presentCount: student.present,
                absentCount: student.absent,
                vacationCount: student.vacation,
                attendanceRate: student.rate.toFixed(1),
                effectiveDaysCovered: student.effectiveDaysCovered,
                globalDaysCovered: student.daysCovered,
                uniqueDays: student.daysCovered, // Use global days as unique days for consistency
                notes: '' // Notes not needed for charts display
            }));
            
            updateChartsDisplay(detailedStats);
        }

        function calculateTimeBasedAnalytics() {
            console.log('ðŸ• Calculating time-based analytics...');
            
            // Time thresholds: On-Time: 1:00-1:15 PM, Late: after 1:15 PM
            const onTimeStart = "13:00"; // 1:00 PM in 24-hour format
            const onTimeEnd = "13:15";   // 1:15 PM in 24-hour format
            
            let onTimeRecords = 0;
            let lateRecords = 0;
            let absentRecords = 0;
            
            // Process all attendance records
            attendanceData.forEach(record => {
                if (record.attendanceStatus === 'absent') {
                    absentRecords++;
                } else if (record.attendanceStatus === 'present' && record.time) {
                    // Parse the time from the record
                    const recordTime = record.time;
                    
                    // Check if time is in on-time window (1:00-1:15 PM)
                    if (isTimeInRange(recordTime, onTimeStart, onTimeEnd)) {
                        onTimeRecords++;
                    } else {
                        // Present but outside on-time window = Late
                        lateRecords++;
                    }
                }
            });
            
            console.log('ðŸ“Š Time Analysis Results:', {
                onTime: onTimeRecords,
                late: lateRecords,
                absent: absentRecords,
                total: attendanceData.length
            });
            
            return {
                onTimeRecords,
                lateRecords,
                absentRecords,
                totalRecords: attendanceData.length
            };
        }
        
        function isTimeInRange(timeStr, startTime, endTime) {
            // Convert time string to comparable format
            // Handle various time formats (e.g., "1:05 PM", "13:05", "01:05:30 PM")
            try {
                let normalizedTime = timeStr;
                
                // Convert 12-hour to 24-hour format if needed
                if (timeStr.includes('PM') || timeStr.includes('AM')) {
                    const [time, period] = timeStr.split(/\s+(AM|PM)/i);
                    let [hours, minutes] = time.split(':').map(num => parseInt(num));
                    
                    if (period.toUpperCase() === 'PM' && hours !== 12) {
                        hours += 12;
                    } else if (period.toUpperCase() === 'AM' && hours === 12) {
                        hours = 0;
                    }
                    
                    normalizedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                } else {
                    // Already in 24-hour format, just extract HH:MM
                    const timeParts = timeStr.split(':');
                    normalizedTime = `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
                }
                
                // Compare times as strings (HH:MM format)
                return normalizedTime >= startTime && normalizedTime <= endTime;
                
            } catch (error) {
                console.warn('âš ï¸ Error parsing time:', timeStr, error);
                return false;
            }
        }

        function updateChartsDisplay(stats) {
            const container = document.getElementById('studentChartsContainer');
            
            // Get time-based analytics
            const timeAnalytics = calculateTimeBasedAnalytics();
            
            // Create analytics dashboard with time-based data
            container.innerHTML = `
                <div class="time-analytics-dashboard">
                    <div class="dashboard-header">
                        <h4><i class="fas fa-clock"></i> Time-Based Attendance Analytics</h4>
                        <p>Analysis based on ${timeAnalytics.totalRecords} total records</p>
                    </div>
                    
                    <div class="time-stats-grid">
                        <div class="time-stat-card on-time">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">${timeAnalytics.onTimeRecords}</span>
                                <span class="stat-label">On-Time Records</span>
                                <span class="stat-detail">1:00 PM - 1:15 PM</span>
                            </div>
                        </div>
                        
                        <div class="time-stat-card late">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">${timeAnalytics.lateRecords}</span>
                                <span class="stat-label">Late Records</span>
                                <span class="stat-detail">After 1:15 PM</span>
                            </div>
                        </div>
                        
                        <div class="time-stat-card absent">
                            <div class="stat-icon">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">${timeAnalytics.absentRecords}</span>
                                <span class="stat-label">Absent Records</span>
                                <span class="stat-detail">No attendance</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="time-summary">
                        <div class="summary-item">
                            <strong>Punctuality Rate:</strong> 
                            <span class="${timeAnalytics.onTimeRecords > timeAnalytics.lateRecords ? 'good-rate' : 'poor-rate'}">
                                ${timeAnalytics.totalRecords > 0 ? ((timeAnalytics.onTimeRecords / (timeAnalytics.onTimeRecords + timeAnalytics.lateRecords)) * 100).toFixed(1) : 0}%
                            </span>
                            <small>(On-time vs Total Present Records)</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateMathematicalInsights(student, allStudents) {
            try {
                const attendanceRate = parseFloat(student.attendanceRate);
                
                // Get actual stored data for this student
                const studentRecords = getActualStudentRecords(student);
                
                // Add effective days information for trend analysis
                const effectiveDays = student.effectiveDaysCovered || student.daysCovered || 6;
                studentRecords.effectiveDays = effectiveDays;
                
                // Calculate real trends based on actual data
                const realTrendAnalysis = calculateRealTrend(studentRecords, attendanceRate);
                
                // Calculate meaningful risk assessment
                const riskAnalysis = calculateActualRisk(student, studentRecords, attendanceRate);
                
                // Generate personalized goals based on actual performance and risk level
                const goalAnalysis = calculatePersonalizedGoals(student, studentRecords, attendanceRate, realTrendAnalysis, riskAnalysis);
                
                // Calculate class comparative stats
                const classStats = calculateClassComparativeStats(attendanceRate, allStudents);
                
                // Generate actionable recommendations
                const recommendations = generateDataDrivenRecommendations(student, studentRecords, realTrendAnalysis, riskAnalysis, goalAnalysis);
                
                return {
                    ...student,
                    // Real trend data
                    trendDirection: realTrendAnalysis.direction,
                    trendIcon: realTrendAnalysis.icon,
                    trendVelocity: realTrendAnalysis.velocity,
                    trendConfidence: realTrendAnalysis.confidence,
                    
                    // Risk assessment
                    riskLevel: riskAnalysis.level,
                    riskScore: riskAnalysis.score,
                    riskFactors: riskAnalysis.factors,
                    
                    // Goal setting
                    goalAchievement: goalAnalysis.status,
                    goalAchievementClass: goalAnalysis.cssClass,
                    personalTarget: goalAnalysis.personalTarget,
                    timeToGoal: goalAnalysis.timeframe,
                    
                    // Class comparison
                    percentileRank: classStats.percentile,
                    classRanking: classStats.ranking,
                    
                    // Data quality indicators
                    dataQuality: studentRecords.dataQuality,
                    recordsAnalyzed: studentRecords.totalRecords,
                    analysisTimespan: studentRecords.timespan,
                    
                    // Actionable insights
                    recommendations: recommendations,
                    nextActions: recommendations.slice(0, 2), // Top 2 actions
                    
                    // Performance metrics
                    consistencyScore: calculateConsistencyScore(studentRecords),
                    improvementRate: realTrendAnalysis.monthlyImprovement,
                    attendancePattern: analyzeAttendancePattern(studentRecords)
                };
            } catch (error) {
                console.error('Error in calculateMathematicalInsights for student:', student.name, error);
                return createSafeAnalyticsDefault(student);
            }
        }

        function getActualStudentRecords(student) {
            // Use the same reliable data source as PDF export - no more table parsing
            console.log('ðŸ” DEBUG: Using reliable PDF data source for:', student.name);
            console.log('ðŸ” Student object from PDF calculation:', student);
            
            // Create synthetic records based on the reliable PDF calculation data
            // This ensures we use the same data source as the PDF export
            const presentCount = student.presentCount || 0;
            const absentCount = student.absentCount || 0; 
            const vacationCount = student.vacationCount || 0;
            const effectiveDays = student.effectiveDaysCovered || 6;
            const totalRecords = presentCount + absentCount;
            
            console.log('ðŸ“Š PDF-based student data:', {
                name: student.name,
                presentCount,
                absentCount,
                vacationCount,
                effectiveDays,
                totalRecords
            });
            
            // Generate synthetic daily records that match the PDF calculation
            const syntheticRecords = [];
            
            // Add present records
            for (let i = 0; i < presentCount; i++) {
                syntheticRecords.push({
                    date: `2025-09-${String(9 + i).padStart(2, '0')}`, // Generate dates
                    attendanceStatus: 'present',
                    action: 'present',
                    notes: ''
                });
            }
            
            // Add absent records (regular absences)
            const regularAbsences = Math.max(0, effectiveDays - presentCount - vacationCount);
            for (let i = 0; i < regularAbsences; i++) {
                syntheticRecords.push({
                    date: `2025-09-${String(9 + presentCount + i).padStart(2, '0')}`,
                    attendanceStatus: 'absent',
                    action: 'absent',
                    notes: ''
                });
            }
            
            // Add vacation/excused absences
            for (let i = 0; i < vacationCount; i++) {
                syntheticRecords.push({
                    date: `2025-09-${String(9 + presentCount + regularAbsences + i).padStart(2, '0')}`,
                    attendanceStatus: 'absent',
                    action: 'absent',
                    notes: 'Abroad-excused'
                });
            }
            
            // Sort by date
            const sortedRecords = syntheticRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            console.log('ðŸ“Š Generated synthetic records for trend analysis:', sortedRecords);
            
            // Calculate data quality based on actual record count and timespan
            const timespan = sortedRecords.length > 1 ? 
                Math.ceil((new Date(sortedRecords[sortedRecords.length - 1].date) - new Date(sortedRecords[0].date)) / (1000 * 60 * 60 * 24)) : 0;
            
            const dataQuality = {
                excellent: sortedRecords.length >= 8 && timespan >= 21, // 3+ weeks
                good: sortedRecords.length >= 4 && timespan >= 14,      // 2+ weeks  
                fair: sortedRecords.length >= 2 && timespan >= 7,       // 1+ week
                poor: sortedRecords.length < 2 || timespan < 7          // Less than 1 week
            };
            
            const result = {
                records: sortedRecords,
                totalRecords: sortedRecords.length,
                timespan: timespan,
                daysCovered: effectiveDays,
                dataQuality: dataQuality.excellent ? 'Excellent' : 
                           dataQuality.good ? 'Good' : 
                           dataQuality.fair ? 'Fair' : 'Limited'
            };
            
            console.log('ï¿½ Final synthetic record result for', student.name, ':', result);
            return result;
        }

        function checkStudentMatch(studentCell, student) {
            // Multiple ways to check if a table row belongs to a student
            
            // Direct name match
            if (studentCell.includes(student.name) || student.name.includes(studentCell)) {
                return true;
            }
            
            // Student ID match
            if (student.studentId && studentCell.includes(student.studentId)) {
                return true;
            }
            
            // Handle "STU017 - Maleek Bitar" format
            if (studentCell.includes(' - ')) {
                const parts = studentCell.split(' - ');
                if (parts.length === 2) {
                    const cellId = parts[0].trim();
                    const cellName = parts[1].trim();
                    
                    // Match by ID or name
                    if ((student.studentId && student.studentId === cellId) || 
                        (student.name && student.name === cellName)) {
                        return true;
                    }
                }
            }
            
            // Handle case where student.name might contain the ID (like "STU017")
            if (student.name && student.name.match(/^STU\d+$/) && studentCell.includes(student.name)) {
                return true;
            }
            
            return false;
        }

        function parseRecordsFromTable(student) {
            console.log('ðŸ” Parsing records from table for:', student.name);
            
            const tableRows = document.querySelectorAll('#recordsTableBody tr');
            console.log('ðŸ” Found table rows:', tableRows.length);
            
            const parsedRecords = [];
            
            tableRows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const studentCell = cells[1]?.textContent?.trim() || '';
                    const statusCell = cells[2]?.textContent?.trim() || '';
                    const dateCell = cells[3]?.textContent?.trim() || '';
                    const timeCell = cells[4]?.textContent?.trim() || '';
                    
                    console.log(`ðŸ” Row ${index}:`, { studentCell, statusCell, dateCell, timeCell });
                    
                    // Check if this row belongs to our student - improved matching
                    const belongsToStudent = checkStudentMatch(studentCell, student);
                    
                    if (belongsToStudent) {
                        console.log('âœ… Table row matches student:', studentCell, 'â†’', student.name);
                        
                        // Extract student ID and name from format "STU017 - Maleek Bitar"
                        let studentId = '';
                        let studentName = '';
                        
                        if (studentCell.includes(' - ')) {
                            const parts = studentCell.split(' - ');
                            studentId = parts[0].trim();
                            studentName = parts[1].trim();
                        } else {
                            studentId = studentCell;
                            studentName = studentCell;
                        }
                        
                        // Clean and map status (remove icons, extra formatting)
                        let mappedStatus = statusCell.toLowerCase().replace(/[^\w]/g, ''); // Remove icons/formatting
                        if (mappedStatus.includes('present')) {
                            mappedStatus = 'present';
                        } else if (mappedStatus.includes('absent')) {
                            mappedStatus = 'absent';
                        }
                        
                        if (mappedStatus === 'present' || mappedStatus === 'absent') {
                            parsedRecords.push({
                                student: studentName || studentId,
                                studentId: studentId,
                                studentName: studentName,
                                attendanceStatus: mappedStatus,
                                action: statusCell,
                                date: dateCell,
                                time: timeCell,
                                dateTime: `${dateCell} ${timeCell}`,
                                parsedFromTable: true
                            });
                        }
                    }
                }
            });
            
            console.log(`ðŸ” Parsed ${parsedRecords.length} records from table:`, parsedRecords);
            
            // Sort by date
            const sortedRecords = parsedRecords.sort((a, b) => {
                const dateA = new Date(a.dateTime);
                const dateB = new Date(b.dateTime);
                return dateA - dateB;
            });
            
            // Calculate timespan
            const timespan = sortedRecords.length > 1 ? 
                Math.ceil((new Date(sortedRecords[sortedRecords.length - 1].date) - new Date(sortedRecords[0].date)) / (1000 * 60 * 60 * 24)) : 0;
            
            const dataQuality = {
                excellent: sortedRecords.length >= 8 && timespan >= 21,
                good: sortedRecords.length >= 4 && timespan >= 14,
                fair: sortedRecords.length >= 2 && timespan >= 7,
                poor: sortedRecords.length < 2 || timespan < 7
            };
            
            return {
                records: sortedRecords,
                totalRecords: sortedRecords.length,
                timespan: timespan,
                dataQuality: dataQuality.excellent ? 'Excellent' : 
                           dataQuality.good ? 'Good' : 
                           dataQuality.fair ? 'Fair' : 'Limited'
            };
        }

        function analyzeShortTermTrend(sortedRecords, currentRate) {
            // For short-term analysis with < 4 records, use simple comparison
            const firstRecord = sortedRecords[0];
            const lastRecord = sortedRecords[sortedRecords.length - 1];
            
            const firstStatus = (firstRecord.attendanceStatus || firstRecord.action || '').toLowerCase();
            const lastStatus = (lastRecord.attendanceStatus || lastRecord.action || '').toLowerCase();
            
            let direction, icon, confidence;
            
            if (sortedRecords.length === 2) {
                // Only 2 records - simple comparison
                if (firstStatus.includes('absent') && lastStatus.includes('present')) {
                    direction = 'IMPROVING';
                    icon = 'ðŸ“ˆ';
                } else if (firstStatus.includes('present') && lastStatus.includes('absent')) {
                    direction = 'DECLINING';
                    icon = 'ðŸ“‰';
                } else {
                    direction = 'STABLE';
                    icon = 'âž¡ï¸';
                }
                confidence = 'Low';
            } else {
                // 3 records - look at overall pattern
                const presentCount = sortedRecords.filter(r => 
                    (r.attendanceStatus || r.action || '').toLowerCase().includes('present')
                ).length;
                
                const absentCount = sortedRecords.length - presentCount;
                
                if (presentCount >= absentCount) {
                    direction = 'STABLE';
                    icon = 'âž¡ï¸';
                } else {
                    direction = 'CONCERNING PATTERN';
                    icon = 'âš ï¸';
                }
                confidence = 'Medium';
            }
            
            return {
                direction: direction,
                icon: icon,
                velocity: '0.0',
                confidence: confidence,
                monthlyImprovement: '0.0',
                description: `${direction.toLowerCase()} pattern with limited data (${sortedRecords.length} records)`
            };
        }

        function calculateRealTrend(studentRecords, currentRate) {
            const records = studentRecords.records;
            const effectiveDays = studentRecords.effectiveDays || records.length;
            
            // Special case: Only 1 effective day - no trend possible
            if (effectiveDays <= 1) {
                return {
                    direction: 'INSUFFICIENT DATA',
                    icon: 'â“',
                    velocity: '0.0',
                    confidence: 'Low',
                    monthlyImprovement: '0.0',
                    description: 'Need more effective attendance days to determine trend'
                };
            }
            
            if (records.length < 2) {
                return {
                    direction: 'INSUFFICIENT DATA',
                    icon: 'â“',
                    velocity: '0.0',
                    confidence: 'Low',
                    monthlyImprovement: '0.0',
                    description: 'Need more attendance records to determine trend'
                };
            }
            
            // Check for mostly excused absences pattern
            const vacationPattern = records.some(r => isExcusedAbsence(r.notes));
            const excusedCount = records.filter(r => isExcusedAbsence(r.notes)).length;
            const unexcusedAbsences = records.filter(r => {
                const status = (r.attendanceStatus || r.action || '').toLowerCase().trim();
                return status.includes('absent') && !isExcusedAbsence(r.notes);
            }).length;
            
            // Special handling for students with mostly excused absences
            if (excusedCount > unexcusedAbsences && currentRate >= 60) {
                return {
                    direction: 'STABLE',
                    icon: 'âž¡ï¸',
                    velocity: '0.0',
                    confidence: 'Medium',
                    monthlyImprovement: '0.0',
                    description: `Stable pattern with planned absences (${excusedCount} excused)`
                };
            }
            
            console.log('ðŸ“Š TREND ANALYSIS for student:', {
                totalRecords: records.length,
                currentRate: currentRate,
                excusedCount: excusedCount,
                unexcusedAbsences: unexcusedAbsences,
                recordsPreview: records.slice(0, 3).map(r => ({
                    date: r.date,
                    status: r.attendanceStatus || r.action,
                    notes: r.notes
                }))
            });
            
            // Sort records chronologically first
            const sortedRecords = records.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateA - dateB;
            });
            
            // For small datasets (< 4 records), use simple chronological analysis
            if (sortedRecords.length < 4) {
                return analyzeShortTermTrend(sortedRecords, currentRate);
            }
            
            // For datasets with 4+ records, use daily analysis
            const dailyRates = [];
            const dailyStats = {};
            
            // Group by actual date to calculate daily attendance
            sortedRecords.forEach(record => {
                const dateStr = record.date;
                if (!dailyStats[dateStr]) {
                    dailyStats[dateStr] = { present: 0, absent: 0, total: 0, date: new Date(record.date) };
                }
                
                const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                dailyStats[dateStr].total++;
                
                if (status === 'present' || status.includes('present')) {
                    dailyStats[dateStr].present++;
                } else if (status === 'absent' || status.includes('absent')) {
                    dailyStats[dateStr].absent++;
                }
            });
            
            // Convert to daily rates and calculate trend
            const dates = Object.keys(dailyStats).sort();
            dates.forEach(dateStr => {
                const dayStats = dailyStats[dateStr];
                // For individual day, rate is either 0% or 100% 
                const rate = dayStats.present > 0 ? 100 : 0;
                dailyRates.push({ 
                    rate: rate, 
                    date: dayStats.date,
                    present: dayStats.present,
                    absent: dayStats.absent
                });
            });
            
            console.log('ðŸ“Š Daily rates calculated:', dailyRates);
            
            if (dailyRates.length < 2) {
                return {
                    direction: 'STABLE',
                    icon: 'âž¡ï¸',
                    velocity: '0.0',
                    confidence: 'Medium',
                    monthlyImprovement: '0.0',
                    description: 'Single day data - assuming stable pattern'
                };
            }
            
            // Calculate recent vs early performance for trend
            const totalDays = dailyRates.length;
            const splitPoint = Math.floor(totalDays / 2);
            
            const earlyPeriod = dailyRates.slice(0, splitPoint);
            const recentPeriod = dailyRates.slice(splitPoint);
            
            const earlyRate = earlyPeriod.reduce((sum, day) => sum + day.rate, 0) / earlyPeriod.length;
            const recentRate = recentPeriod.reduce((sum, day) => sum + day.rate, 0) / recentPeriod.length;
            
            const trendChange = recentRate - earlyRate;
            let changePerWeek = (trendChange / totalDays) * 7; // Approximate weekly change
            
            // Cap the weekly change to realistic values (-100% to +100%)
            changePerWeek = Math.max(-100, Math.min(100, changePerWeek));
            
            const monthlyChange = changePerWeek * 4.33;
            
            console.log('ðŸ“Š Trend calculation:', {
                totalDays,
                splitPoint,
                earlyRate: earlyRate.toFixed(1),
                recentRate: recentRate.toFixed(1),
                trendChange: trendChange.toFixed(1),
                changePerWeek: changePerWeek.toFixed(1)
            });
            
            // Determine confidence based on data quality - be more generous
            let confidence = 'Low';
            if (totalDays >= 6) {
                confidence = 'High';
            } else if (totalDays >= 4) {
                confidence = 'Medium';
            }
            
            // For students with very low attendance like Lyth (16.7%), assume declining trend
            // if most recent records are absences
            let direction, icon;
            
            // Special logic for high attendance with single absence
            if (currentRate >= 80 && trendChange >= -40) {
                // High attendance (80%+) with reasonable decline should be stable
                // This catches cases like 83.3% (5/6) which shouldn't be "declining"
                direction = 'STABLE';
                icon = 'âž¡ï¸';
            } else if (currentRate <= 20 && recentRate === 0) {
                // Special case: very low attendance with recent absences
                direction = 'CONCERNING PATTERN';
                icon = 'âš ï¸';
                confidence = 'High';
            } else if (Math.abs(trendChange) < 10) {
                direction = 'STABLE';
                icon = 'âž¡ï¸';
            } else if (trendChange >= 50) {
                direction = 'STRONGLY IMPROVING';
                icon = 'ðŸ“ˆ';
            } else if (trendChange >= 20) {
                direction = 'IMPROVING';
                icon = 'ðŸ“ˆ';
            } else if (trendChange <= -50) {
                direction = 'STRONGLY DECLINING';
                icon = 'ðŸ“‰';
            } else if (trendChange <= -20) {
                direction = 'DECLINING';
                icon = 'ðŸ“‰';
            } else {
                direction = trendChange > 0 ? 'SLIGHTLY IMPROVING' : 'SLIGHTLY DECLINING';
                icon = trendChange > 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
            }
            
            // Special handling for vacation/excuse patterns
            if (vacationPattern && Math.abs(trendChange) < 20) {
                direction = 'STABLE';
                icon = 'âž¡ï¸';
                confidence = 'Medium';
            }
            
            return {
                direction: direction,
                icon: icon,
                velocity: changePerWeek.toFixed(1),
                confidence: confidence,
                monthlyImprovement: monthlyChange.toFixed(1),
                description: `${direction.toLowerCase()} trend based on ${totalDays} days of data`
            };
        }
        
        function analyzeShortTermTrend(records, currentRate) {
            // For datasets with < 6 records, use simple chronological comparison
            const totalRecords = records.length;
            
            // Get first half and second half
            const midPoint = Math.ceil(totalRecords / 2);
            const firstHalf = records.slice(0, midPoint);
            const secondHalf = records.slice(midPoint);
            
            // Count present in each half
            const firstHalfPresent = firstHalf.filter(r => {
                const status = (r.attendanceStatus || r.action || '').toLowerCase();
                return status === 'present' || status.includes('present');
            }).length;
            
            const secondHalfPresent = secondHalf.filter(r => {
                const status = (r.attendanceStatus || r.action || '').toLowerCase();
                return status === 'present' || status.includes('present');
            }).length;
            
            const firstHalfRate = (firstHalfPresent / firstHalf.length) * 100;
            const secondHalfRate = secondHalfPresent > 0 ? (secondHalfPresent / secondHalf.length) * 100 : 0;
            
            const change = secondHalfRate - firstHalfRate;
            
            console.log('ðŸ“Š Short-term trend analysis:', {
                totalRecords,
                firstHalf: firstHalf.length,
                secondHalf: secondHalf.length,
                firstHalfPresent,
                secondHalfPresent,
                firstHalfRate: firstHalfRate.toFixed(1),
                secondHalfRate: secondHalfRate.toFixed(1),
                change: change.toFixed(1)
            });
            
            // For small datasets, be more conservative with trend detection
            let direction, icon, confidence = 'Low';
            
            if (Math.abs(change) < 25) {
                direction = 'STABLE';
                icon = 'âž¡ï¸';
            } else if (change >= 50) {
                direction = 'STRONGLY IMPROVING';
                icon = 'ðŸ“ˆ';
                confidence = 'Medium';
            } else if (change >= 25) {
                direction = 'IMPROVING';
                icon = 'ðŸ“ˆ';
                confidence = 'Medium';
            } else if (change <= -50) {
                direction = 'STRONGLY DECLINING';
                icon = 'ðŸ“‰';
                confidence = 'Medium';
            } else if (change <= -25) {
                direction = 'DECLINING';
                icon = 'ðŸ“‰';
                confidence = 'Medium';
            } else {
                direction = change > 0 ? 'SLIGHTLY IMPROVING' : 'SLIGHTLY DECLINING';
                icon = change > 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
            }
            
            // Weekly velocity approximation
            const weeklyChange = totalRecords >= 4 ? change / 2 : change;
            
            return {
                direction: direction,
                icon: icon,
                velocity: weeklyChange.toFixed(1),
                confidence: confidence,
                monthlyImprovement: (weeklyChange * 4).toFixed(1),
                description: `${direction.toLowerCase()} pattern in recent ${totalRecords} records`
            };
        }

        function calculateSimpleLinearRegression(weeklyRates) {
            const n = weeklyRates.length;
            if (n < 2) return { slope: 0, intercept: 0 };
            
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            
            weeklyRates.forEach((point, index) => {
                sumX += index;
                sumY += point.rate;
                sumXY += index * point.rate;
                sumXX += index * index;
            });
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            return { slope: slope, intercept: intercept };
        }

        function calculateActualRisk(student, studentRecords, attendanceRate) {
            let riskScore = 0;
            const riskFactors = [];
            const records = studentRecords.records;
            
            console.log('ðŸŽ¯ Risk assessment for:', student.name, 'Rate:', attendanceRate + '%');
            
            // Get Days Covered from global data (this should be passed or calculated globally)
            const daysCovered = studentRecords.daysCovered || 6; // Fallback to 6 if not provided
            
            // Count present records
            const presentRecords = records.filter(r => {
                const status = (r.attendanceStatus || r.action || '').toLowerCase();
                return status.includes('present');
            }).length;
            
            // Calculate missing days (Days Covered - Present Records)
            const missingDays = daysCovered - presentRecords;
            
            // Count vacation days from absent records with excused notes (vacation/abroad)
            let vacationDays = 0;
            records.forEach(record => {
                const status = (record.attendanceStatus || record.action || '').toLowerCase();
                if (status.includes('absent') && isExcusedAbsence(record.notes)) {
                    vacationDays++;
                }
            });
            
            // Calculate effective days covered (excluding vacation days)
            const effectiveDaysCovered = daysCovered - vacationDays;
            
            // Calculate regular missing days (missing days that are not vacation)
            const regularMissingDays = Math.max(0, missingDays - vacationDays);
            
            // Recalculate attendance rate using effective days covered
            const effectiveAttendanceRate = effectiveDaysCovered > 0 ? 
                (presentRecords / effectiveDaysCovered) * 100 : 0;
            
            console.log('ðŸ“Š Missing days analysis:', { 
                daysCovered, 
                presentRecords, 
                missingDays, 
                vacationDays, 
                regularMissingDays,
                effectiveDaysCovered,
                effectiveAttendanceRate 
            });
            
            // Note vacation information in risk factors but don't override percentage-based risk
            if (missingDays > 0 && regularMissingDays === 0 && vacationDays > 0) {
                riskFactors.push('Student excused - all absences planned (vacation/abroad)');
            }
            
            // FACTOR 1: Use appropriate attendance rate based on data quality
            let rateToUse = attendanceRate;
            let rateLabel = 'overall';
            
            // For students with vacation days, use effective rate if it's meaningful
            if (vacationDays > 0 && effectiveDaysCovered > 1) {
                rateToUse = effectiveAttendanceRate;
                rateLabel = 'effective';
            }
            
            // Only flag attendance issues if there are actual unplanned absences
            if (rateToUse === 0 && regularMissingDays > 0) {
                riskScore += 0.6; // Major risk for 0% attendance with unplanned absences
                riskFactors.push('Zero attendance rate');
            } else if (rateToUse < 30 && regularMissingDays > 0) {
                riskScore += 0.5;
                riskFactors.push('Critically low attendance rate');
            } else if (rateToUse < 50) {
                riskScore += 0.35;  // Reduced from 0.4 
                riskFactors.push('Very low attendance rate');
            } else if (rateToUse < 65) {  // Adjusted threshold from 70 to 65
                riskScore += 0.2;   // Reduced from 0.25
                riskFactors.push('Below average attendance');
            } else if (rateToUse < 80) {
                riskScore += 0.1;
                riskFactors.push('Slightly below target attendance');
            }
            
            // FACTOR 2: Regular missing days (non-vacation) weighted against Days Covered
            if (regularMissingDays > 0) {
                const regularMissingRate = (regularMissingDays / daysCovered) * 100;
                
                if (regularMissingRate > 50) {
                    riskScore += 0.4;
                    riskFactors.push('High rate of unplanned absences');
                } else if (regularMissingRate > 25) {
                    riskScore += 0.25;
                    riskFactors.push('Multiple unplanned absences');
                } else if (regularMissingDays >= 2) {
                    riskScore += 0.15;
                    riskFactors.push('Some unplanned absences');
                }
                
                console.log('ðŸ“Š Regular missing days analysis:', { 
                    regularMissingDays, 
                    daysCovered, 
                    regularMissingRate: regularMissingRate.toFixed(1) + '%' 
                });
            }
            
            // FACTOR 3: Recent trend analysis
            const trendAnalysis = calculateRealTrend(studentRecords, attendanceRate);
            if (trendAnalysis.direction.includes('DECLINING') && regularMissingDays > 0) {
                riskScore += 0.2;
                riskFactors.push('Declining attendance trend');
            } else if (trendAnalysis.direction.includes('IMPROVING')) {
                riskScore -= 0.1; // Improving trend reduces risk
                riskFactors.push('Improving attendance trend');
            }
            
            // FACTOR 4: Consecutive missing pattern (recent performance)
            // Look at attendance pattern in recent periods
            if (presentRecords < daysCovered * 0.6) { // If less than 60% attendance
                riskScore += 0.15;
                riskFactors.push('Consistently low attendance pattern');
            }
            
            // FACTOR 5: Data quality consideration
            if (studentRecords.dataQuality === 'Limited' && presentRecords < 3) {
                riskScore += 0.1;
                riskFactors.push('Insufficient data for complete assessment');
            }
            
            // FACTOR 6: Vacation planning reduces risk
            if (vacationDays > 0) {
                riskScore -= Math.min(0.3, vacationDays * 0.05); // Reduce risk for planned absences
                riskFactors.push(`${vacationDays} planned vacation day(s)`);
            }
            
            // Clamp risk score between 0 and 1
            riskScore = Math.max(0, Math.min(1, riskScore));
            
            // Simple risk level classification based on attendance percentage
            let riskLevel;
            
            // Clear percentage-based thresholds
            if (attendanceRate >= 80) {
                riskLevel = 'LOW';
            } else if (attendanceRate >= 60) {
                riskLevel = 'MEDIUM';
            } else {
                riskLevel = 'HIGH';
            }
            
            console.log('ðŸŽ¯ Final risk assessment:', { 
                student: student.name,
                riskLevel, 
                riskScore: riskScore.toFixed(2),
                factors: riskFactors 
            });
            
            return {
                score: riskScore,
                level: riskLevel,
                factors: riskFactors,
                needsIntervention: riskScore > 0.5,
                isOnVacation: vacationDays > 0 && regularMissingDays === 0,
                adjustedRate: vacationDays > 0 ? ((presentRecords / (daysCovered - vacationDays)) * 100).toFixed(1) + '%' : null,
                vacationDays: vacationDays,
                regularMissingDays: regularMissingDays
            };
        }

        function checkForVacationNotes(student, records) {
            // Check student-level notes
            const studentNotes = (student.notes || '').toLowerCase();
            if (studentNotes.includes('vacation') || studentNotes.includes('holiday') || studentNotes.includes('leave')) {
                return true;
            }
            
            // Check individual record notes
            return records.some(record => {
                const notes = (record.notes || '').toLowerCase();
                return notes.includes('vacation') || notes.includes('holiday') || notes.includes('leave');
            });
        }

        function calculatePersonalizedGoals(student, studentRecords, attendanceRate, trendAnalysis, riskAnalysis) {
            const defaultTarget = 80; // Standard target
            let personalTarget = defaultTarget;
            let timeframe = 'Long term';
            let status = 'NOT SET';
            let cssClass = 'not-set';
            
            // Check if already meeting standard target
            if (attendanceRate >= defaultTarget) {
                status = 'ACHIEVED âœ“';
                cssClass = 'achieved';
                // Use standard 95% target for excellence instead of variable targets
                personalTarget = 95; 
                timeframe = 'Maintain current performance';
            } else {
                // Consider risk level for goal setting
                if (riskAnalysis && riskAnalysis.level === 'LOW') {
                    // LOW RISK students with < 80% attendance get supportive goals, not urgent
                    status = 'MONITOR PROGRESS';
                    cssClass = 'monitor-progress';
                    timeframe = 'Gradual improvement with support';
                } else {
                    const shortfall = defaultTarget - attendanceRate;
                    const weeklyImprovement = parseFloat(trendAnalysis.velocity);
                    
                    if (weeklyImprovement > 0) {
                        // Improving trend - calculate realistic timeframe
                        const weeksToGoal = Math.ceil(shortfall / weeklyImprovement);
                        if (weeksToGoal <= 4) {
                            timeframe = `${weeksToGoal} week${weeksToGoal > 1 ? 's' : ''}`;
                            status = 'ACHIEVABLE';
                            cssClass = 'achievable';
                        } else if (weeksToGoal <= 12) {
                            timeframe = `${weeksToGoal} weeks`;
                            status = 'LONG TERM';
                            cssClass = 'long-term';
                        } else {
                            timeframe = 'Needs intervention';
                            status = 'NEEDS SUPPORT';
                            cssClass = 'needs-help';
                        }
                    } else {
                        // Stable or declining trend
                        if (attendanceRate >= 70) {
                            status = 'NEEDS INTERVENTION';
                            cssClass = 'needs-intervention';
                            timeframe = 'Immediate support required';
                        } else {
                            status = 'HIGH PRIORITY';
                            cssClass = 'high-priority';
                            timeframe = 'Urgent intervention needed';
                        }
                    }
                }
            }
            
            return {
                personalTarget: personalTarget,
                status: status,
                cssClass: cssClass,
                timeframe: timeframe,
                isRealistic: status.includes('ACHIEVABLE') || status.includes('ACHIEVED')
            };
        }

        function calculateClassComparativeStats(attendanceRate, allStudents) {
            const rates = allStudents.map(s => parseFloat(s.attendanceRate)).sort((a, b) => a - b);
            const studentRank = rates.indexOf(attendanceRate) + 1;
            const percentile = Math.round((studentRank / rates.length) * 100);
            
            return {
                percentile: `${percentile}th percentile`,
                ranking: `${studentRank} of ${rates.length}`,
                aboveAverage: attendanceRate > (rates.reduce((a, b) => a + b, 0) / rates.length)
            };
        }

        function generateDataDrivenRecommendations(student, studentRecords, trendAnalysis, riskAnalysis, goalAnalysis) {
            const recommendations = [];
            const attendanceRate = parseFloat(student.attendanceRate);
            
            // High priority recommendations based on risk
            if (riskAnalysis.level === 'HIGH') {
                recommendations.push({
                    text: "Schedule immediate meeting with student to discuss attendance patterns",
                    priority: "urgent",
                    icon: "fas fa-exclamation-triangle",
                    action: "meeting"
                });
                
                if (riskAnalysis.factors.includes('Multiple recent absences')) {
                    recommendations.push({
                        text: "Investigate potential barriers to attendance (health, transport, personal issues)",
                        priority: "high",
                        icon: "fas fa-search",
                        action: "investigate"
                    });
                }
            }
            
            // Trend-based recommendations
            if (trendAnalysis.direction.includes('DECLINING')) {
                recommendations.push({
                    text: `Address declining trend - attendance dropping by ${Math.abs(parseFloat(trendAnalysis.velocity))}% per week`,
                    priority: "high",
                    icon: "fas fa-chart-line-down",
                    action: "intervention"
                });
            } else if (trendAnalysis.direction.includes('IMPROVING')) {
                recommendations.push({
                    text: "Recognize and reinforce positive attendance improvement",
                    priority: "medium",
                    icon: "fas fa-award",
                    action: "positive_reinforcement"
                });
            }
            
            // Goal-based recommendations
            if (goalAnalysis.status === 'ACHIEVABLE') {
                recommendations.push({
                    text: `Goal is achievable in ${goalAnalysis.timeframe} - provide encouragement and track weekly progress`,
                    priority: "medium",
                    icon: "fas fa-target",
                    action: "track_progress"
                });
            } else if (goalAnalysis.status === 'NEEDS SUPPORT') {
                recommendations.push({
                    text: "Consider modified goals and additional support structures",
                    priority: "high",
                    icon: "fas fa-hands-helping",
                    action: "support_plan"
                });
            }
            
            // Data-driven specific recommendations
            if (studentRecords.dataQuality === 'Limited') {
                recommendations.push({
                    text: "Collect more attendance data to improve analysis accuracy",
                    priority: "low",
                    icon: "fas fa-database",
                    action: "data_collection"
                });
            }
            
            // Default recommendations if none generated
            if (recommendations.length === 0) {
                recommendations.push({
                    text: "Continue monitoring attendance patterns",
                    priority: "low",
                    icon: "fas fa-eye",
                    action: "monitor"
                });
            }
            
            return recommendations.slice(0, 4); // Return top 4 recommendations
        }

        function createSafeAnalyticsDefault(student) {
            return {
                ...student,
                trendDirection: 'DATA INSUFFICIENT',
                trendIcon: 'â“',
                trendVelocity: '0.0',
                trendConfidence: 'Low',
                riskLevel: 'MEDIUM',
                riskScore: 0.5,
                goalAchievement: 'NEEDS MORE DATA',
                goalAchievementClass: 'insufficient-data',
                personalTarget: 80,
                dataQuality: 'Limited',
                recommendations: [{
                    text: "Collect more attendance data for accurate analysis",
                    priority: "medium",
                    icon: "fas fa-chart-bar"
                }]
            };
        }

        function calculateConsistencyScore(studentRecords) {
            const records = studentRecords.records;
            if (records.length < 2) return 50;
            
            const attendanceRates = [];
            const weeks = {};
            
            // Calculate weekly attendance rates
            records.forEach(record => {
                const date = new Date(record.date);
                const weekKey = Math.floor(date.getTime() / (7 * 24 * 60 * 60 * 1000));
                
                if (!weeks[weekKey]) {
                    weeks[weekKey] = { present: 0, total: 0 };
                }
                
                weeks[weekKey].total++;
                const status = (record.attendanceStatus || record.action || '').toLowerCase();
                if (status.includes('present')) {
                    weeks[weekKey].present++;
                }
            });
            
            Object.values(weeks).forEach(week => {
                attendanceRates.push((week.present / week.total) * 100);
            });
            
            if (attendanceRates.length < 2) return 75;
            
            // Calculate coefficient of variation (lower = more consistent)
            const mean = attendanceRates.reduce((a, b) => a + b, 0) / attendanceRates.length;
            const variance = attendanceRates.reduce((sum, rate) => sum + Math.pow(rate - mean, 2), 0) / attendanceRates.length;
            const coeffVariation = Math.sqrt(variance) / mean * 100;
            
            // Convert to consistency score (100 - CV, clamped)
            return Math.max(0, Math.min(100, 100 - coeffVariation)).toFixed(0);
        }

        function analyzeAttendancePattern(studentRecords) {
            const records = studentRecords.records;
            if (records.length < 3) return 'Insufficient data for pattern analysis';
            
            // Analyze day-of-week patterns, consecutive patterns, etc.
            const dayPatterns = {};
            const consecutiveAbsences = [];
            let currentStreak = 0;
            
            records.forEach(record => {
                const date = new Date(record.date);
                const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' });
                const status = (record.attendanceStatus || record.action || '').toLowerCase();
                
                if (!dayPatterns[dayOfWeek]) dayPatterns[dayOfWeek] = { present: 0, total: 0 };
                dayPatterns[dayOfWeek].total++;
                
                if (status.includes('present')) {
                    dayPatterns[dayOfWeek].present++;
                    if (currentStreak > 0) {
                        consecutiveAbsences.push(currentStreak);
                        currentStreak = 0;
                    }
                } else {
                    currentStreak++;
                }
            });
            
            // Find patterns
            const patterns = [];
            Object.entries(dayPatterns).forEach(([day, stats]) => {
                const rate = (stats.present / stats.total) * 100;
                if (rate < 50 && stats.total >= 2) {
                    patterns.push(`Lower attendance on ${day}s`);
                }
            });
            
            if (Math.max(...consecutiveAbsences) > 2) {
                patterns.push(`Periods of consecutive absences (max: ${Math.max(...consecutiveAbsences)} days)`);
            }
            
            return patterns.length > 0 ? patterns.join('; ') : 'Regular attendance pattern';
        }

        // DEBUG FUNCTION - Click "Debug Data" button in analytics to use this
        function debugDataStructure() {
            console.log('ðŸ› DEBUG: Data Structure Analysis');
            console.log('==========================================');
            
            // 1. Check attendanceData array
            console.log('ðŸ“Š attendanceData array:', attendanceData);
            console.log('ðŸ“Š attendanceData length:', attendanceData?.length || 0);
            
            if (attendanceData && attendanceData.length > 0) {
                console.log('ðŸ“Š First 3 records structure:');
                attendanceData.slice(0, 3).forEach((record, i) => {
                    console.log(`Record ${i}:`, {
                        student: record.student,
                        studentId: record.studentId,
                        studentName: record.studentName,
                        action: record.action,
                        attendanceStatus: record.attendanceStatus,
                        date: record.date,
                        dateTime: record.dateTime,
                        allKeys: Object.keys(record)
                    });
                });
                
                // Show unique students in data
                const uniqueStudents = [...new Set(attendanceData.map(r => r.student || r.studentId || r.studentName))];
                console.log('ðŸ“Š Unique students in data:', uniqueStudents);
            }
            
            // 2. Check table data
            const tableRows = document.querySelectorAll('#recordsTableBody tr');
            console.log('ðŸ“Š Table rows found:', tableRows.length);
            
            if (tableRows.length > 0) {
                console.log('ðŸ“Š First 3 table rows:');
                for (let i = 0; i < Math.min(3, tableRows.length); i++) {
                    const cells = tableRows[i].querySelectorAll('td');
                    console.log(`Table row ${i}:`, {
                        studentCell: cells[1]?.textContent?.trim(),
                        statusCell: cells[2]?.textContent?.trim(),
                        dateCell: cells[3]?.textContent?.trim(),
                        timeCell: cells[4]?.textContent?.trim()
                    });
                }
            }
            
            // 3. Check analytics processing
            const analyticsData = getAnalyticsData('all');
            console.log('ðŸ“Š Analytics data processing result:', analyticsData.length, 'records');
            
            if (analyticsData.length > 0) {
                console.log('ðŸ“Š Processed analytics data sample:', analyticsData.slice(0, 3));
                
                // Test student record extraction
                const uniqueAnalyticsStudents = [...new Set(analyticsData.map(r => r.studentId || r.studentName || r.student))];
                console.log('ðŸ“Š Unique students from analytics:', uniqueAnalyticsStudents);
                
                // Test actual record fetching for first student
                if (uniqueAnalyticsStudents.length > 0) {
                    const testStudent = { 
                        name: uniqueAnalyticsStudents[0],
                        studentId: uniqueAnalyticsStudents[0]
                    };
                    console.log('ðŸ§ª Testing record fetch for student:', testStudent);
                    const studentRecords = getActualStudentRecords(testStudent);
                    console.log('ðŸ§ª Student records result:', studentRecords);
                }
            }
            
            alert('ðŸ› Debug complete! Check the browser console (F12) for detailed data analysis.');
        }

        function generateWeeklyAttendanceData(student) {
            // Try to use actual attendance data if available from student records
            if (student.attendanceRecords && student.attendanceRecords.length > 0) {
                // Parse real attendance data
                const records = student.attendanceRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
                const weeklyData = [];
                
                // Group by weeks and calculate weekly attendance rates
                const weeks = {};
                records.forEach(record => {
                    const date = new Date(record.date);
                    const weekKey = Math.floor(date.getTime() / (7 * 24 * 60 * 60 * 1000));
                    
                    if (!weeks[weekKey]) {
                        weeks[weekKey] = { present: 0, total: 0, weekNumber: Object.keys(weeks).length };
                    }
                    
                    weeks[weekKey].total++;
                    if (record.status === 'Present') {
                        weeks[weekKey].present++;
                    }
                });
                
                // Convert to weekly attendance percentages
                Object.values(weeks).forEach(week => {
                    const attendanceRate = (week.present / week.total) * 100;
                    weeklyData.push({ week: week.weekNumber, attendance: attendanceRate });
                });
                
                if (weeklyData.length > 0) {
                    return weeklyData;
                }
            }
            
            // Fallback: Generate realistic weekly attendance data based on current performance
            const weeks = Math.max(4, Math.min(12, Math.ceil(student.uniqueDays / 7) || 8));
            const baseRate = parseFloat(student.attendanceRate);
            const data = [];
            
            // For Baraa's case: 3P/1A over 4 weeks, simulate the actual pattern
            const presentCount = student.presentCount || 3;
            const totalCount = (student.presentCount || 3) + (student.absentCount || 1);
            
            for (let i = 0; i < weeks; i++) {
                let weeklyRate;
                
                if (totalCount === 4 && presentCount === 3) {
                    // Simulate declining trend: Present, Present, Present, Absent
                    if (i === 0 || i === 1 || i === 2) {
                        weeklyRate = 100; // Present weeks
                    } else if (i === 3) {
                        weeklyRate = 0;   // Absent week  
                    } else {
                        weeklyRate = baseRate; // Future predictions
                    }
                } else {
                    // Create more realistic weekly variation for other cases
                    const seasonalTrend = Math.sin(i * Math.PI / 6) * 5;
                    const randomVariation = (Math.random() - 0.5) * 10;
                    const trendComponent = (baseRate > 75) ? -2 * i : (baseRate < 50) ? 1 * i : 0;
                    
                    weeklyRate = baseRate + seasonalTrend + randomVariation + trendComponent;
                }
                
                weeklyRate = Math.max(0, Math.min(100, weeklyRate));
                data.push({ week: i, attendance: weeklyRate });
            }
            
            return data;
        }

        function calculateWeeklyConsistency(weeklyData) {
            if (weeklyData.length < 2) return 95; // Default for insufficient data
            
            const rates = weeklyData.map(d => d.attendance);
            const mean = rates.reduce((a, b) => a + b, 0) / rates.length;
            const variance = rates.reduce((sum, rate) => sum + Math.pow(rate - mean, 2), 0) / rates.length;
            const coefficientOfVariation = Math.sqrt(variance) / mean * 100;
            
            // Convert to consistency score (higher is better)
            return Math.max(0, Math.min(100, 100 - coefficientOfVariation)).toFixed(0);
        }

        function calculateWeeklyRiskScore(attendanceRate, slope, consistency, absences, studentNotes = '') {
            let score = 0;
            
            // Check actual notes for vacation
            const hasVacationNote = isExcusedAbsence(studentNotes);
            const allAbsent = attendanceRate === 0;
            
            // Base risk from attendance rate (logical thresholds)
            if (attendanceRate === 0) {
                score += hasVacationNote ? 0.5 : 0.8; // Medium if vacation, High if not
            } else if (attendanceRate < 40) {
                score += hasVacationNote ? 0.4 : 0.7; // Reduced risk if vacation
            } else if (attendanceRate < 60) {
                score += 0.5; // Medium-high risk
            } else if (attendanceRate < 80) {
                score += 0.3; // Medium risk
            } else if (attendanceRate < 90) {
                score += 0.1; // Low risk
            }
            // 90%+ gets no risk points
            
            // Risk from negative trend
            if (slope < -10) {
                score += 0.2; // Major decline
            } else if (slope < -5) {
                score += 0.1; // Moderate decline
            } else if (slope < 0) {
                score += 0.05; // Minor decline
            }
            
            // Risk from inconsistency
            const consistencyScore = parseInt(consistency);
            if (consistencyScore < 50) score += 0.1;
            else if (consistencyScore < 75) score += 0.05;
            
            // Risk from total absences
            if (absences > 3 && !hasVacationNote) {
                score += 0.1;
            }
            
            // Reduce risk for students with excellent attendance (90%+)
            if (attendanceRate >= 90) {
                score = Math.max(0, score - 0.2);
            }
            
            return Math.min(1, score);
        }

        function generateWeeklyRecommendations(attendanceRate, trendDirection, riskLevel, regression, student) {
            const recommendations = [];
            
            // NO MORE ASSUMPTIONS - Only check actual notes
            const hasVacationNote = isExcusedAbsence(student.notes);
            const allAbsent = student.presentCount === 0;
            const excellentAttendance = attendanceRate >= 90;
            
            // Priority 1: Handle excellent attendance (90%+)
            if (excellentAttendance) {
                recommendations.push({
                    text: "Excellent attendance - Consider as peer mentor",
                    priority: "low",
                    icon: "fas fa-star"
                });
                return recommendations;
            }
            
            // Priority 2: Handle zero attendance
            if (attendanceRate === 0) {
                if (hasVacationNote) {
                    recommendations.push({
                        text: "Excused absence - Monitor return and re-engagement",
                        priority: "medium",
                        icon: "fas fa-plane"
                    });
                } else {
                    recommendations.push({
                        text: "Critical: Complete absence - Immediate intervention required",
                        priority: "high",
                        icon: "fas fa-exclamation-triangle"
                    });
                }
                return recommendations;
            }
            
            // Priority 3: Handle very low attendance (1-39%)
            if (attendanceRate < 40) {
                recommendations.push({
                    text: "Critical: Missing more than 60% of sessions - Immediate intervention required",
                    priority: "high",
                    icon: "fas fa-exclamation-triangle"
                });
                return recommendations;
            }
            
            // Priority 4: Handle moderate attendance (40-79%)
            if (attendanceRate < 80) {
                if (trendDirection.includes('IMPROVING')) {
                    recommendations.push({
                        text: "Positive trend - Continue current engagement strategies",
                        priority: "medium",
                        icon: "fas fa-thumbs-up"
                    });
                } else if (trendDirection.includes('DECLINE')) {
                    recommendations.push({
                        text: "Declining attendance pattern - Early intervention recommended",
                        priority: "high",
                        icon: "fas fa-chart-line-down"
                    });
                } else {
                    recommendations.push({
                        text: "Attendance below target - Schedule regular check-ins",
                        priority: "medium",
                        icon: "fas fa-calendar-check"
                    });
                }
                return recommendations;
            }
            
            // Priority 5: Handle good attendance (80-89%)
            if (attendanceRate >= 80) {
                if (trendDirection.includes('DECLINE')) {
                    recommendations.push({
                        text: "Good attendance with slight decline - Monitor closely",
                        priority: "medium",
                        icon: "fas fa-eye"
                    });
                } else {
                    recommendations.push({
                        text: "Good attendance - Small improvements can reach excellence",
                        priority: "low",
                        icon: "fas fa-bullseye"
                    });
                }
                return recommendations;
            }
            
            // Fallback
            recommendations.push({
                text: "Continue monitoring attendance pattern",
                priority: "low",
                icon: "fas fa-eye"
            });
            
            return recommendations;
        }

        function calculateAttendanceStreak(weeklyData) {
            let currentStreak = 0;
            let maxStreak = 0;
            
            // Count consecutive weeks with good attendance (>75%)
            for (let i = weeklyData.length - 1; i >= 0; i--) {
                if (weeklyData[i].attendance >= 75) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    if (i === weeklyData.length - 1) break; // Reset current streak if latest week is bad
                }
            }
            
            return {
                current: currentStreak,
                best: maxStreak
            };
        }

        function analyzeWeeklyPattern(weeklyData) {
            if (weeklyData.length < 4) return 'INSUFFICIENT_DATA';
            
            const recentWeeks = weeklyData.slice(-4);
            const avgRecent = recentWeeks.reduce((sum, d) => sum + d.attendance, 0) / 4;
            
            if (avgRecent >= 90) return 'EXCELLENT';
            if (avgRecent >= 80) return 'GOOD';
            if (avgRecent >= 70) return 'NEEDS_IMPROVEMENT';
            return 'CONCERNING';
        }

        function generateTimeSeriesData(student) {
            // Simulate weekly attendance data (in real app, use actual historical data)
            const weeks = 8;
            const baseRate = parseFloat(student.attendanceRate);
            const data = [];
            
            for (let i = 0; i < weeks; i++) {
                // Add some realistic variation
                const noise = (Math.random() - 0.5) * 20;
                const trend = (Math.random() - 0.5) * 2;
                const rate = Math.max(0, Math.min(100, baseRate + noise + (trend * i)));
                data.push({ week: i, attendance: rate });
            }
            
            return data;
        }

        function calculateLinearRegression(data) {
            if (!data || data.length < 2) {
                return { slope: 0, intercept: 75, rSquared: '0.000' };
            }
            
            const n = data.length;
            const sumX = data.reduce((sum, point) => sum + point.week, 0);
            const sumY = data.reduce((sum, point) => sum + point.attendance, 0);
            const sumXY = data.reduce((sum, point) => sum + (point.week * point.attendance), 0);
            const sumXX = data.reduce((sum, point) => sum + (point.week * point.week), 0);
            
            const denominator = (n * sumXX - sumX * sumX);
            const slope = denominator !== 0 ? (n * sumXY - sumX * sumY) / denominator : 0;
            const intercept = n > 0 ? (sumY - slope * sumX) / n : 75;
            
            // Calculate R-squared with safety checks
            const yMean = sumY / n;
            const totalSumSquares = data.reduce((sum, point) => sum + Math.pow(point.attendance - yMean, 2), 0);
            
            if (totalSumSquares === 0) {
                return { slope, intercept, rSquared: '1.000' };
            }
            
            const residualSumSquares = data.reduce((sum, point) => {
                const predicted = slope * point.week + intercept;
                return sum + Math.pow(point.attendance - predicted, 2);
            }, 0);
            
            const rSquaredValue = 1 - (residualSumSquares / totalSumSquares);
            const rSquared = Math.max(0, Math.min(1, rSquaredValue)).toFixed(3);
            
            return { slope, intercept, rSquared };
        }

        function calculateRiskScore(attendanceRate, slope, standardDeviation) {
            let score = 0;
            
            // Base risk from attendance rate
            if (attendanceRate < 50) score += 0.4;
            else if (attendanceRate < 70) score += 0.2;
            else if (attendanceRate < 80) score += 0.1;
            
            // Risk from negative trend
            if (slope < -0.5) score += 0.3;
            else if (slope < 0) score += 0.1;
            
            // Risk from high variability
            if (parseFloat(standardDeviation) > 15) score += 0.2;
            else if (parseFloat(standardDeviation) > 10) score += 0.1;
            
            return Math.min(1, score);
        }

        function generateRecommendations(attendanceRate, trendDirection, riskLevel, regression) {
            const recommendations = [];
            
            if (attendanceRate < 70) {
                recommendations.push({
                    text: "Immediate intervention required - Schedule one-on-one meeting",
                    priority: "high",
                    icon: "fas fa-exclamation-triangle"
                });
            }
            
            if (trendDirection === 'DECLINING') {
                recommendations.push({
                    text: "Negative trend detected - Implement attendance improvement plan",
                    priority: "high",
                    icon: "fas fa-chart-line-down"
                });
            }
            
            if (riskLevel === 'HIGH') {
                recommendations.push({
                    text: "High risk student - Consider additional support services",
                    priority: "high",
                    icon: "fas fa-life-ring"
                });
            }
            
            if (attendanceRate >= 70 && attendanceRate < 80) {
                recommendations.push({
                    text: "Close to target - Motivational support may help achieve 80%",
                    priority: "medium",
                    icon: "fas fa-bullseye"
                });
            }
            
            if (trendDirection === 'IMPROVING') {
                recommendations.push({
                    text: "Positive trend - Reinforce current strategies",
                    priority: "low",
                    icon: "fas fa-thumbs-up"
                });
            }
            
            if (attendanceRate >= 90) {
                recommendations.push({
                    text: "Excellent performance - Consider peer mentoring role",
                    priority: "low",
                    icon: "fas fa-star"
                });
            }
            
            // Always provide at least one recommendation
            if (recommendations.length === 0) {
                recommendations.push({
                    text: "Continue monitoring - Maintain current attendance level",
                    priority: "low",
                    icon: "fas fa-eye"
                });
            }
            
            return recommendations;
        }

        function generateClassWideInsights(students) {
            const rates = students.map(s => parseFloat(s.attendanceRate));
            const mean = rates.reduce((a, b) => a + b, 0) / rates.length;
            const median = rates.sort((a, b) => a - b)[Math.floor(rates.length / 2)];
            const standardDev = Math.sqrt(rates.reduce((sum, rate) => sum + Math.pow(rate - mean, 2), 0) / rates.length);
            
            const improvingStudents = students.filter(s => s.trendDirection === 'IMPROVING').length;
            const decliningStudents = students.filter(s => s.trendDirection === 'DECLINING').length;
            const highRiskStudents = students.filter(s => s.riskLevel === 'HIGH').length;
            
            const classPerformanceIndex = (mean * 0.4) + ((100 - standardDev) * 0.3) + ((improvingStudents / students.length * 100) * 0.3);
            
            return `
                <div class="class-insights-grid">
                    <div class="insight-card">
                        <h5><i class="fas fa-calculator"></i> Statistical Summary</h5>
                        <div class="insight-content">
                            <p><strong>Mean:</strong> ${mean.toFixed(1)}%</p>
                            <p><strong>Median:</strong> ${median.toFixed(1)}%</p>
                            <p><strong>Std Dev:</strong> ${standardDev.toFixed(1)}%</p>
                            <p><strong>Distribution:</strong> ${standardDev < 10 ? 'Uniform' : standardDev < 20 ? 'Normal' : 'High Variance'}</p>
                        </div>
                    </div>
                    
                    <div class="insight-card">
                        <h5><i class="fas fa-trending-up"></i> Trend Analysis</h5>
                        <div class="insight-content">
                            <p><strong>Improving:</strong> ${improvingStudents} students (${((improvingStudents/students.length)*100).toFixed(0)}%)</p>
                            <p><strong>Declining:</strong> ${decliningStudents} students (${((decliningStudents/students.length)*100).toFixed(0)}%)</p>
                            <p><strong>Class Trend:</strong> ${improvingStudents > decliningStudents ? 'ðŸ“ˆ Positive' : 'ðŸ“‰ Needs Attention'}</p>
                        </div>
                    </div>
                    
                    <div class="insight-card">
                        <h5><i class="fas fa-exclamation-triangle"></i> Risk Assessment</h5>
                        <div class="insight-content">
                            <p><strong>High Risk:</strong> ${highRiskStudents} students</p>
                            <p><strong>Below Target (&lt;80%):</strong> ${students.filter(s => parseFloat(s.attendanceRate) < 80).length}</p>
                            <p><strong>Class Performance Index:</strong> ${classPerformanceIndex.toFixed(0)}/100</p>
                            <p><strong>Recommendation:</strong> ${classPerformanceIndex > 80 ? 'Maintain current strategies' : classPerformanceIndex > 60 ? 'Implement targeted interventions' : 'Comprehensive reform needed'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function showEmptyAnalytics() {
            document.getElementById('highestAttendanceList').innerHTML = '<li class="analytics-empty">No data for selected period</li>';
            document.getElementById('lowestAttendanceList').innerHTML = '<li class="analytics-empty">No data for selected period</li>';
            // Matrix analytics will handle its own empty state
            document.getElementById('studentChartsContainer').innerHTML = '<div class="analytics-empty">No chart data for selected period</div>';
        }











        // Penalties System Functions
        function togglePenaltiesView() {
            const penaltiesSection = document.getElementById('penaltiesSection');
            const viewPenaltiesBtn = document.getElementById('viewPenaltiesBtn');
            const isVisible = penaltiesSection.style.display !== 'none';
            
            if (isVisible) {
                viewPenaltiesBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> View Penalties';
                penaltiesSection.style.display = 'none';
            } else {
                viewPenaltiesBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Hide Penalties';
                penaltiesSection.style.display = 'block';
                generatePenalties();
                
                // Scroll to penalties section
                penaltiesSection.scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }
        }
        
        function generatePenalties() {
            const filterPeriod = document.getElementById('penaltiesFilter').value;
            console.log('generatePenalties called with filter:', filterPeriod);
            
            const filteredPenalties = getPenaltiesData(filterPeriod);
            
            console.log('Filtered penalties results:', {
                period: filterPeriod,
                penaltyCount: filteredPenalties.length
            });
            
            if (filteredPenalties.length === 0) {
                console.log('No penalties available, showing empty penalties');
                showEmptyPenalties();
                updatePenaltySummary([]);
                return;
            }

            // Generate all penalty displays
            generateStudentPenalties(filteredPenalties);
            generateRecentLateArrivals(filteredPenalties);
            generatePenaltyDetails(filteredPenalties);
            updatePenaltySummary(filteredPenalties);
        }
        
        function getPenaltiesData(period) {
            let filteredPenalties = [...penaltiesData];
            
            if (period !== 'all') {
                const now = new Date();
                let startDate;
                
                switch (period) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'last7days':
                        startDate = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                        break;
                    case 'last30days':
                        startDate = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                        break;
                    case 'thismonth':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'lastmonth':
                        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                        filteredPenalties = filteredPenalties.filter(penalty => {
                            const penaltyDate = new Date(penalty.timestamp);
                            return penaltyDate >= lastMonth && penaltyDate <= lastMonthEnd;
                        });
                        return filteredPenalties;
                    default:
                        return filteredPenalties;
                }
                
                filteredPenalties = filteredPenalties.filter(penalty => 
                    new Date(penalty.timestamp) >= startDate
                );
            }
            
            return filteredPenalties;
        }
        
        function generateStudentPenalties(penalties) {
            const studentPenalties = {};
            
            penalties.forEach(penalty => {
                if (!studentPenalties[penalty.studentName]) {
                    studentPenalties[penalty.studentName] = {
                        name: penalty.studentName,
                        totalAmount: 0,
                        count: 0,
                        latestPenalty: penalty.timestamp
                    };
                }
                
                studentPenalties[penalty.studentName].totalAmount += penalty.amount;
                studentPenalties[penalty.studentName].count++;
                
                if (penalty.timestamp > studentPenalties[penalty.studentName].latestPenalty) {
                    studentPenalties[penalty.studentName].latestPenalty = penalty.timestamp;
                }
            });
            
            const sortedStudents = Object.values(studentPenalties)
                .sort((a, b) => b.totalAmount - a.totalAmount);
            
            updateStudentPenaltiesList(sortedStudents);
        }
        
        function updateStudentPenaltiesList(students) {
            const container = document.getElementById('studentPenaltiesList');
            
            if (students.length > 0) {
                container.innerHTML = students.map(student => `
                    <li class="penalties-item">
                        <div>
                            <span class="penalty-student-name">${student.name}</span>
                            <div class="penalty-details">
                                <span><i class="fas fa-calendar-times"></i> ${student.count} late arrival${student.count !== 1 ? 's' : ''}</span>
                                <span><i class="fas fa-clock"></i> Latest: ${new Date(student.latestPenalty).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <span class="penalty-amount">${student.totalAmount} ${penaltySettings.currency}</span>
                    </li>
                `).join('');
            } else {
                container.innerHTML = '<li class="penalties-empty">No student penalties found</li>';
            }
        }
        
        function generateRecentLateArrivals(penalties) {
            const recentPenalties = penalties
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10); // Show last 10 late arrivals
            
            updateRecentLateArrivalsList(recentPenalties);
        }
        
        function updateRecentLateArrivalsList(recentPenalties) {
            const container = document.getElementById('recentLateArrivalsList');
            
            if (recentPenalties.length > 0) {
                container.innerHTML = recentPenalties.map(penalty => `
                    <li class="penalties-item">
                        <div>
                            <span class="penalty-student-name">${penalty.studentName}</span>
                            <div class="penalty-details">
                                <span><i class="fas fa-calendar"></i> ${penalty.date}</span>
                                <span><i class="fas fa-clock"></i> ${penalty.time}</span>
                            </div>
                        </div>
                        <span class="penalty-amount">${penalty.amount} ${penaltySettings.currency}</span>
                    </li>
                `).join('');
            } else {
                container.innerHTML = '<li class="penalties-empty">No recent late arrivals found</li>';
            }
        }
        
        function generatePenaltyDetails(penalties) {
            const container = document.getElementById('penaltyDetailsContainer');
            
            if (penalties.length > 0) {
                const sortedPenalties = penalties.sort((a, b) => b.timestamp - a.timestamp);
                
                container.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f8f9fa; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left;">Student</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left;">Date</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left;">Time</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: center;">Amount</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left;">Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedPenalties.map((penalty, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: 600;">${penalty.studentName}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${penalty.date}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${penalty.time}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: center; color: #e74c3c; font-weight: 700;">${penalty.amount} AED</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d;">${penalty.reason}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                container.innerHTML = '<div class="penalties-empty">No penalty details available</div>';
            }
        }
        
        function updatePenaltySummary(penalties) {
            const stats = getPenaltyStatistics();
            
            document.getElementById('totalPenaltyAmount').textContent = `${stats.totalAmount} ${penaltySettings.currency}`;
            document.getElementById('totalLateArrivals').textContent = stats.totalCount;
            document.getElementById('studentsWithPenalties').textContent = stats.uniqueStudents;
            document.getElementById('averagePenaltyPerStudent').textContent = `${stats.averagePerStudent.toFixed(2)} ${penaltySettings.currency}`;
        }
        
        function showEmptyPenalties() {
            document.getElementById('studentPenaltiesList').innerHTML = '<li class="penalties-empty">No student penalties found for selected period</li>';
            document.getElementById('recentLateArrivalsList').innerHTML = '<li class="penalties-empty">No late arrivals found for selected period</li>';
            document.getElementById('penaltyDetailsContainer').innerHTML = '<div class="penalties-empty">No penalty details available for selected period</div>';
        }
        
        function exportPenaltiesToPDF() {
            try {
                const filterPeriod = document.getElementById('penaltiesFilter').value;
                const filteredPenalties = getPenaltiesData(filterPeriod);
                
                if (filteredPenalties.length === 0) {
                    showMessage('No penalties data to export for the selected period.', 'warning');
                    return;
                }
                
                // Set button loading state
                const exportBtn = document.getElementById('exportPenaltiesPdfBtn');
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                exportBtn.disabled = true;
                
                // Create new PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title and header information
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Late Arrival Penalties Report', 14, 22);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 32);
                
                const filterText = document.getElementById('penaltiesFilter').selectedOptions[0].text;
                doc.text(`Period: ${filterText}`, 14, 40);
                doc.text(`Total Penalties: ${filteredPenalties.length}`, 14, 48);
                
                // Get penalty statistics
                const stats = getPenaltyStatistics();
                doc.text(`Total Amount: ${stats.totalAmount} AED`, 14, 56);
                doc.text(`Students Affected: ${stats.uniqueStudents}`, 14, 64);
                
                // Prepare penalty data for the table
                const penaltyData = filteredPenalties
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .map((penalty, index) => [
                        (index + 1).toString(),
                        penalty.studentName,
                        penalty.date,
                        penalty.time,
                        `${penalty.amount} AED`,
                        penalty.reason
                    ]);
                
                // Create table headers
                const headers = [['#', 'Student Name', 'Date', 'Time', 'Amount', 'Reason']];
                
                // Add table to PDF
                doc.autoTable({
                    head: headers,
                    body: penaltyData,
                    startY: 75,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [231, 76, 60], // Red theme for penalties
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [252, 245, 245] // Light red
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 8 },   // # (reduced from 10)
                        1: { cellWidth: 35 },                    // Student Name (reduced from 40)
                        2: { halign: 'center', cellWidth: 22 },  // Date (reduced from 25)
                        3: { halign: 'center', cellWidth: 18 },  // Time (reduced from 20)
                        4: { halign: 'center', cellWidth: 22 },  // Amount (reduced from 25)
                        5: { cellWidth: 55 }                     // Reason (reduced from 60)
                    },
                    styles: {
                        fontSize: 9,
                        cellPadding: 3,
                        overflow: 'linebreak',
                    },
                    didParseCell: function(data) {
                        // Highlight penalty amounts in red
                        if (data.column.index === 4) { // Amount column
                            data.cell.styles.textColor = [231, 76, 60];
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                });
                
                // Add summary section
                const finalY = doc.lastAutoTable.finalY || 75;
                if (finalY < 250) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Summary Statistics', 14, finalY + 20);
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Total Penalty Amount: ${stats.totalAmount} AED`, 14, finalY + 32);
                    doc.text(`Total Late Arrivals: ${stats.totalCount}`, 14, finalY + 40);
                    doc.text(`Students with Penalties: ${stats.uniqueStudents}`, 14, finalY + 48);
                    doc.text(`Average per Student: ${stats.averagePerStudent.toFixed(2)} AED`, 14, finalY + 56);
                }
                
                // Add footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Attendance System - Penalty Rate: ${penaltySettings.amount} ${penaltySettings.currency} per late arrival`, 14, 285);
                doc.text(`Page 1 of 1`, 180, 285);
                
                // Save the PDF
                const currentDate = new Date().toISOString().split('T')[0];
                const fileName = `Penalties_Report_${filterText.replace(/\s+/g, '_')}_${currentDate}.pdf`;
                doc.save(fileName);
                
                showMessage(`ðŸ“‹ Penalties report exported successfully!\nðŸ“„ File: ${fileName}\nðŸ’° Total: ${stats.totalAmount} AED\nðŸ‘¥ ${stats.uniqueStudents} students affected`, 'success');
                
            } catch (error) {
                console.error('Error generating penalties PDF:', error);
                showMessage('Error generating penalties PDF report. Please try again.', 'error');
            } finally {
                // Reset button state
                const exportBtn = document.getElementById('exportPenaltiesPdfBtn');
                exportBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Export PDF';
                exportBtn.disabled = false;
            }
        }
        
        function clearPenaltyData() {
            if (!confirm('Are you sure you want to clear all penalty data? This action cannot be undone.')) {
                return;
            }
            
            penaltiesData = [];
            savePenaltiesData();
            
            // Update display if penalties section is visible
            if (document.getElementById('penaltiesSection').style.display !== 'none') {
                generatePenalties();
            }
            
            showMessage('All penalty data has been cleared.', 'success');
        }

        function downloadExcel() {
            try {
                console.log('Download Excel clicked. Current attendanceData length:', attendanceData.length);
                console.log('First 3 records:', attendanceData.slice(0, 3));
                
                if (attendanceData.length === 0) {
                    showMessage('No data to export. Please submit some attendance records first.', 'warning');
                    return;
                }
                
                showLoading(true);
                
                // Prepare data for Excel with backward compatibility
                const excelData = attendanceData.map((record, index) => {
                    // Get student ID and name for display
                    let studentId = 'N/A';
                    let studentName = 'Unknown Student';
                    
                    if (record.studentId && record.studentName) {
                        // New format
                        studentId = record.studentId;
                        studentName = record.studentName;
                    } else if (record.studentName || record.employeeName) {
                        // Has name but no ID
                        studentName = record.studentName || record.employeeName;
                    } else {
                        // Legacy format - lookup from activeStudents
                        const studentInfo = activeStudents[record.student || record.employee];
                        if (typeof studentInfo === 'object') {
                            studentId = studentInfo.id;
                            studentName = studentInfo.name;
                        } else {
                            studentName = studentInfo || record.student || record.employee || 'Unknown Student';
                        }
                    }
                    
                    // Get action/attendance status
                    let actionStatus = 'N/A';
                    if (record.attendanceLabel) {
                        actionStatus = record.attendanceLabel;
                    } else if (record.attendanceStatus) {
                        actionStatus = record.attendanceStatus === 'present' ? 'Present' : 'Absent';
                    } else if (record.actionLabel) {
                        actionStatus = record.actionLabel;
                    } else if (record.actionType) {
                        // Legacy format mapping
                        const actionTypeMapping = {
                            'check-in': 'Present',
                            'check-out': 'Absent',
                            'break': 'Break',
                            'lunch': 'Lunch',
                            'meeting': 'Meeting',
                            'sick-leave': 'Sick Leave',
                            'vacation': 'Vacation'
                        };
                        actionStatus = actionTypeMapping[record.actionType] || record.actionType;
                    }
                    
                    return {
                        'No.': index + 1,
                        'Student ID': studentId,
                        'Student Name': studentName,
                        'Action': actionStatus,
                        'Date': record.date,
                        'Time': record.time,
                        'Latitude': record.latitude,
                        'Longitude': record.longitude,
                        'Address': record.address,
                        'Notes': record.notes || ''
                    };
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Auto-resize columns
                const colWidths = [
                    {wch: 5},   // No.
                    {wch: 12},  // Student ID
                    {wch: 25},  // Student Name
                    {wch: 15},  // Action
                    {wch: 12},  // Date
                    {wch: 12},  // Time
                    {wch: 12},  // Latitude
                    {wch: 12},  // Longitude
                    {wch: 40},  // Address
                    {wch: 30}   // Notes
                ];
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Student Attendance Records');
                
                // Generate filename with current date
                const now = new Date();
                const filename = `student_attendance_records_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, filename);
                
                showMessage(`Excel file downloaded: ${filename}`, 'success');
                
            } catch (error) {
                showMessage(`Error creating Excel file: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function exportFilteredRecordsToPdf() {
            try {
                // Get records directly from what's currently displayed in the table
                const tableRows = elements.recordsTableBody.querySelectorAll('tr');
                
                if (tableRows.length === 0) {
                    showMessage('No records to export. The table is empty or no records match your filters.', 'warning');
                    return;
                }
                
                // Check if showing "No records found" message
                if (tableRows.length === 1 && tableRows[0].innerHTML.includes('No records found')) {
                    showMessage('No records to export. Please adjust your filters or add some attendance records.', 'warning');
                    return;
                }
                
                showLoading(true);
                
                // Create new PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title and header information
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Attendance Records Report', 14, 22);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 32);
                doc.text(`Total Records: ${tableRows.length}`, 14, 40);
                
                // Get current filter values for display
                const filterDate = elements.filterDate.value;
                const filterStudent = elements.filterEmployee.value;
                const filterStatus = elements.filterAction.value;
                
                let filterInfo = 'Filters Applied: ';
                if (filterDate) filterInfo += `Date: ${filterDate} `;
                if (filterStudent) {
                    const studentInfo = activeStudents[filterStudent];
                    const studentName = typeof studentInfo === 'string' ? studentInfo : (studentInfo?.name || filterStudent);
                    filterInfo += `Student: ${studentName} `;
                }
                if (filterStatus) filterInfo += `Status: ${filterStatus} `;
                if (!filterDate && !filterStudent && !filterStatus) filterInfo += 'None (All Records)';
                
                doc.setFontSize(10);
                doc.text(filterInfo, 14, 48);
                
                // Calculate and display actual date range from the table data
                const actualDateRange = getActualDateRangeFromTable(tableRows);
                if (actualDateRange && actualDateRange !== 'No data') {
                    doc.text(`Report Period: ${actualDateRange}`, 14, 56);
                }
                
                // Extract data directly from table rows
                const tableData = [];
                let presentCount = 0;
                let absentCount = 0;
                const uniqueStudents = new Set();
                const uniqueDays = new Set();
                
                tableRows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 6) { // Make sure we have enough cells including notes
                        const studentName = cells[1].textContent.trim(); // Student column
                        const status = cells[2].textContent.trim(); // Action/Status column
                        const date = cells[3].textContent.trim(); // Date column
                        const time = cells[4].textContent.trim(); // Time column
                        const notes = cells[6] ? cells[6].textContent.trim() : ''; // Notes column (index 6, location is 5)
                        
                        // Track unique students and days
                        uniqueStudents.add(studentName);
                        uniqueDays.add(date);
                        
                        // Count status for statistics
                        if (status.toLowerCase().includes('present')) {
                            presentCount++;
                        } else if (status.toLowerCase().includes('absent')) {
                            absentCount++;
                        }
                        
                        tableData.push([
                            (index + 1).toString(),
                            studentName,
                            status,
                            date,
                            time,
                            notes || '-' // Show dash if no notes
                        ]);
                    }
                });
                
                // Create table headers
                const headers = [['#', 'Student Name', 'Status', 'Date', 'Time', 'Notes']];
                
                // Add table to PDF using the data from displayed table
                doc.autoTable({
                    head: headers,
                    body: tableData,
                    startY: 63, // Increased from 55 to account for the additional line
                    theme: 'striped',
                    headStyles: {
                        fillColor: [52, 73, 94],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 8 },   // # (reduced from 10)
                        1: { cellWidth: 32 },                    // Student Name (reduced from 35)
                        2: { halign: 'center', cellWidth: 18 },  // Status (reduced from 20)
                        3: { halign: 'center', cellWidth: 23 },  // Date (reduced from 25)
                        4: { halign: 'center', cellWidth: 23 },  // Time (reduced from 25)
                        5: { cellWidth: 36 }                     // Notes (reduced from 40)
                    },
                    styles: {
                        fontSize: 9,                             // Reduced from 10
                        cellPadding: 3,                          // Reduced from 4
                        overflow: 'linebreak',                   // Allow text wrapping
                        cellWidth: 'wrap'                        // Auto-wrap long content
                    },
                    margin: { top: 55, left: 14, right: 14 },
                    tableWidth: 'auto',                          // Auto-adjust table width
                    showHead: 'everyPage'                        // Show headers on every page
                });
                
                // Add summary statistics at the bottom
                const finalY = doc.lastAutoTable.finalY + 15;
                
                // Calculate total vacation days from the current filtered data
                let totalVacationDays = 0;
                tableRows.forEach((row) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 6) {
                        const status = cells[2].textContent.trim(); // Status column
                        const notes = cells[6] ? cells[6].textContent.trim() : ''; // Notes column
                        
                        // Count vacation days (absent records with excused notes)
                        if (status.toLowerCase().includes('absent') && isExcusedAbsence(notes)) {
                            totalVacationDays++;
                        }
                    }
                });
                
                // Calculate attendance rate using new effective days formula: âˆ‘(Presents) / âˆ‘(Effective Days) Ã— 100
                const totalStudents = uniqueStudents.size;
                const daysCovered = uniqueDays.size;
                const expectedTotalAttendance = daysCovered * totalStudents;
                const effectiveTotalDays = expectedTotalAttendance - totalVacationDays;
                const attendanceRate = effectiveTotalDays > 0 ? 
                    Math.round((presentCount / effectiveTotalDays) * 100) : 0;
                
                // Calculate raw attendance rate: (Total Present Records) / (Total Students Ã— Days Covered)
                const rawAttendanceRate = expectedTotalAttendance > 0 ? 
                    Math.round((presentCount / expectedTotalAttendance) * 100) : 0;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Summary Statistics:', 14, finalY);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text('Present: ' + presentCount + ' records', 14, finalY + 10);
                doc.text('Absent: ' + absentCount + ' records', 14, finalY + 18);
                doc.text('Total Students: ' + totalStudents, 14, finalY + 26);
                doc.text('Days Covered: ' + daysCovered, 14, finalY + 34);
                doc.text('Raw Attendance Rate: ' + rawAttendanceRate + '%', 14, finalY + 42);
                doc.text('Effective Attendance Rate: ' + attendanceRate + '%', 14, finalY + 50);
                
                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                    doc.text('Generated by Attendance Tracker v3.0', 14, doc.internal.pageSize.height - 10);
                }
                
                // Generate filename with filter info
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
                const timeStr = `${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}`;
                
                let filename = `attendance_report_${dateStr}_${timeStr}`;
                if (filterStudent) {
                    const studentInfo = activeStudents[filterStudent];
                    const studentName = typeof studentInfo === 'string' ? studentInfo : (studentInfo?.name || filterStudent);
                    filename += `_${studentName.replace(/\s+/g, '_')}`;
                }
                if (filterStatus) {
                    filename += `_${filterStatus}`;
                }
                filename += '.pdf';
                
                // Save the PDF
                doc.save(filename);
                
                showMessage(`ðŸ“„ PDF exported successfully: ${filename}\nðŸ“Š ${tableData.length} records exported\nðŸ“ˆ ${attendanceRate}% attendance rate`, 'success');
                
            } catch (error) {
                console.error('PDF Export Error:', error);
                showMessage(`Error creating PDF: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function sendEmailReport() {
            try {
                const emailAddress = elements.reportEmail.value.trim();
                
                if (!emailAddress) {
                    showMessage('Please enter an email address', 'warning');
                    elements.reportEmail.focus();
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(emailAddress)) {
                    showMessage('Please enter a valid email address', 'warning');
                    elements.reportEmail.focus();
                    return;
                }
                
                if (attendanceData.length === 0) {
                    showMessage('No attendance data to include in the report', 'warning');
                    return;
                }
                
                showLoading(true);
                
                // Generate comprehensive analytics
                const analytics = generateAttendanceAnalytics();
                
                // Create professional email subject and body
                const reportDate = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const emailSubject = `ðŸ“Š Attendance Analytics Report - ${reportDate}`;
                
                let emailBody = `ðŸŽ“ ATTENDANCE TRACKING SYSTEM - ANALYTICS REPORT\n`;
                emailBody += `${'='.repeat(55)}\n\n`;
                
                emailBody += `ðŸ“… Report Generated: ${new Date().toLocaleString()}\n`;
                emailBody += `ðŸ“Š Analysis Period: ${analytics.dateRange}\n`;
                emailBody += `â±ï¸  Last Updated: ${analytics.lastRecordTime}\n\n`;
                
                // KEY METRICS
                emailBody += `ðŸ“ˆ KEY PERFORMANCE INDICATORS\n`;
                emailBody += `${'-'.repeat(35)}\n`;
                emailBody += `ðŸ‘¥ Total Students Tracked: ${analytics.totalStudents}\n`;
                emailBody += `ðŸ“‹ Total Records: ${analytics.totalRecords}\n`;
                emailBody += `âœ… Present Records: ${analytics.presentCount} (${analytics.presentPercentage}%)\n`;
                emailBody += `âŒ Absent Records: ${analytics.absentCount} (${analytics.absentPercentage}%)\n`;
                emailBody += `ðŸ“Š Attendance Rate: ${analytics.attendanceRate}%\n\n`;
                
                // TODAY'S SUMMARY
                emailBody += `ðŸ—“ï¸  TODAY'S SUMMARY\n`;
                emailBody += `${'-'.repeat(20)}\n`;
                emailBody += `ðŸ“ Records Today: ${analytics.todayRecords}\n`;
                emailBody += `âœ… Present Today: ${analytics.todayPresent}\n`;
                emailBody += `âŒ Absent Today: ${analytics.todayAbsent}\n`;
                emailBody += `ðŸ“ˆ Today's Rate: ${analytics.todayRate}%\n\n`;
                
                // STUDENT BREAKDOWN
                if (analytics.studentBreakdown.length > 0) {
                    emailBody += `ðŸ‘¨â€ðŸŽ“ STUDENT ATTENDANCE BREAKDOWN\n`;
                    emailBody += `${'-'.repeat(35)}\n`;
                    analytics.studentBreakdown.forEach(student => {
                        emailBody += `â€¢ ${student.name}: ${student.presentCount}P/${student.absentCount}A (${student.rate}% rate)\n`;
                    });
                    emailBody += `\n`;
                }
                
                // RECENT ACTIVITY
                if (analytics.recentActivity.length > 0) {
                    emailBody += `ðŸ• RECENT ACTIVITY (Last 5 Records)\n`;
                    emailBody += `${'-'.repeat(35)}\n`;
                    analytics.recentActivity.forEach((record, index) => {
                        emailBody += `${index + 1}. ${record.name} - ${record.status} (${record.time})\n`;
                    });
                    emailBody += `\n`;
                }
                
                // INSIGHTS & RECOMMENDATIONS
                emailBody += `ðŸ’¡ INSIGHTS & RECOMMENDATIONS\n`;
                emailBody += `${'-'.repeat(35)}\n`;
                analytics.insights.forEach(insight => {
                    emailBody += `â€¢ ${insight}\n`;
                });
                emailBody += `\n`;
                
                // FOOTER
                emailBody += `${'-'.repeat(55)}\n`;
                emailBody += `ðŸ”— Access full system: [Your attendance tracker URL]\n`;
                emailBody += `ðŸ“ž Support: Contact your system administrator\n`;
                emailBody += `âš¡ Generated automatically by Attendance Tracking System\n`;
                
                // Create mailto link
                const mailtoLink = `mailto:${emailAddress}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                
                // Open email client
                window.open(mailtoLink);
                
                showMessage(`ðŸ“§ Professional analytics report prepared for: ${emailAddress}`, 'success');
                
                // Clear the email field
                elements.reportEmail.value = '';
                
            } catch (error) {
                showMessage(`Error preparing email report: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Analytics generation function
        function generateAttendanceAnalytics() {
            const today = new Date().toDateString();
            const analytics = {
                totalRecords: attendanceData.length,
                totalStudents: 0,
                presentCount: 0,
                absentCount: 0,
                presentPercentage: 0,
                absentPercentage: 0,
                attendanceRate: 0,
                todayRecords: 0,
                todayPresent: 0,
                todayAbsent: 0,
                todayRate: 0,
                dateRange: '',
                lastRecordTime: '',
                studentBreakdown: [],
                recentActivity: [],
                insights: []
            };
            
            if (attendanceData.length === 0) return analytics;
            
            // Calculate basic metrics
            const studentStats = {};
            let earliestDate = null;
            let latestDate = null;
            
            attendanceData.forEach(record => {
                // Get student info
                const studentId = record.student || record.studentId || 'Unknown';
                const studentInfo = activeStudents[studentId];
                const studentName = studentInfo ? 
                    (studentInfo.name || `${studentInfo.firstName} ${studentInfo.lastName}`) : 
                    studentId;
                
                // Initialize student stats
                if (!studentStats[studentId]) {
                    studentStats[studentId] = {
                        name: studentName,
                        presentCount: 0,
                        absentCount: 0,
                        totalCount: 0
                    };
                }
                
                // Count attendance
                const status = record.status || record.attendanceStatus;
                if (status === 'present') {
                    analytics.presentCount++;
                    studentStats[studentId].presentCount++;
                } else {
                    analytics.absentCount++;
                    studentStats[studentId].absentCount++;
                }
                studentStats[studentId].totalCount++;
                
                // Today's stats
                const recordDate = new Date(record.date).toDateString();
                if (recordDate === today) {
                    analytics.todayRecords++;
                    if (status === 'present') {
                        analytics.todayPresent++;
                    } else {
                        analytics.todayAbsent++;
                    }
                }
                
                // Date range
                const recordDateObj = new Date(record.date);
                if (!earliestDate || recordDateObj < earliestDate) earliestDate = recordDateObj;
                if (!latestDate || recordDateObj > latestDate) latestDate = recordDateObj;
            });
            
            // Calculate percentages
            analytics.totalStudents = Object.keys(studentStats).length;
            analytics.presentPercentage = Math.round((analytics.presentCount / analytics.totalRecords) * 100) || 0;
            analytics.absentPercentage = Math.round((analytics.absentCount / analytics.totalRecords) * 100) || 0;
            analytics.attendanceRate = analytics.presentPercentage;
            analytics.todayRate = analytics.todayRecords > 0 ? 
                Math.round((analytics.todayPresent / analytics.todayRecords) * 100) : 0;
            
            // Date range
            if (earliestDate && latestDate) {
                analytics.dateRange = earliestDate.toDateString() === latestDate.toDateString() ? 
                    earliestDate.toLocaleDateString() : 
                    `${earliestDate.toLocaleDateString()} - ${latestDate.toLocaleDateString()}`;
            }
            
            // Last record time
            if (attendanceData.length > 0) {
                const lastRecord = attendanceData[0]; // Most recent (array is newest first)
                analytics.lastRecordTime = `${lastRecord.date} at ${lastRecord.time}`;
            }
            
            // Student breakdown
            analytics.studentBreakdown = Object.values(studentStats).map(student => ({
                ...student,
                rate: student.totalCount > 0 ? Math.round((student.presentCount / student.totalCount) * 100) : 0
            })).sort((a, b) => b.rate - a.rate);
            
            // Recent activity (last 5 records)
            analytics.recentActivity = attendanceData.slice(0, 5).map(record => {
                const studentId = record.student || record.studentId || 'Unknown';
                const studentInfo = activeStudents[studentId];
                const studentName = studentInfo ? 
                    (studentInfo.name || `${studentInfo.firstName} ${studentInfo.lastName}`) : 
                    studentId;
                const status = record.status || record.attendanceStatus;
                
                return {
                    name: studentName,
                    status: status === 'present' ? 'âœ… Present' : 'âŒ Absent',
                    time: `${record.date} ${record.time}`
                };
            });
            
            // Generate insights
            if (analytics.attendanceRate >= 90) {
                analytics.insights.push('ðŸŽ‰ Excellent attendance rate! Keep up the great work.');
            } else if (analytics.attendanceRate >= 75) {
                analytics.insights.push('ðŸ‘ Good attendance rate, but room for improvement.');
            } else {
                analytics.insights.push('âš ï¸ Low attendance rate requires attention and intervention.');
            }
            
            if (analytics.todayRecords > 0) {
                if (analytics.todayRate > analytics.attendanceRate) {
                    analytics.insights.push('ðŸ“ˆ Today\'s attendance is above average - positive trend!');
                } else if (analytics.todayRate < analytics.attendanceRate) {
                    analytics.insights.push('ðŸ“‰ Today\'s attendance is below average - monitor closely.');
                }
            }
            
            if (analytics.totalStudents > 0) {
                const lowAttendanceStudents = analytics.studentBreakdown.filter(s => s.rate < 50).length;
                if (lowAttendanceStudents > 0) {
                    analytics.insights.push(`ðŸ” ${lowAttendanceStudents} student(s) have attendance below 50% - consider intervention.`);
                }
            }
            
            return analytics;
        }

        // Test functions for debugging
        function testEmailForm() {
            console.log('ðŸ§ª TESTING EMAIL FORM FUNCTIONALITY...');
            console.log('attendanceData length:', attendanceData.length);
            console.log('activeStudents count:', Object.keys(activeStudents).length);
            
            if (attendanceData.length === 0) {
                // Add comprehensive test data
                const testStudents = ['STU001', 'STU002', 'STU003', 'STU004', 'STU005'];
                const statuses = ['present', 'absent'];
                
                testStudents.forEach((studentId, index) => {
                    // Add student to activeStudents if not exists
                    if (!activeStudents[studentId]) {
                        activeStudents[studentId] = {
                            firstName: `Test Student ${index + 1}`,
                            lastName: `LastName${index + 1}`,
                            id: studentId
                        };
                    }
                    
                    // Add multiple attendance records per student
                    for (let i = 0; i < 5; i++) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const status = i < 2 ? 'present' : (Math.random() > 0.7 ? 'absent' : 'present');
                        
                        attendanceData.push({
                            student: studentId,
                            status: status,
                            date: date.toLocaleDateString(),
                            time: `${8 + i}:00 AM`,
                            latitude: '25.316557',
                            longitude: '55.374643',
                            address: `Test Location ${index + 1}`
                        });
                    }
                });
                
                console.log('âœ… Added comprehensive test data');
                console.log('Total records:', attendanceData.length);
                console.log('Students:', Object.keys(activeStudents));
            }
            
            // Test analytics generation
            const analytics = generateAdvancedAnalytics('weekly');
            console.log('ðŸ“Š Generated analytics:', analytics);
            
            // Test checkbox functionality
            const checkboxes = getSelectedCheckboxes();
            console.log('ðŸ“‹ Default checkboxes:', checkboxes);
            
            // Test report content generation
            const reportContent = generateReportContent(analytics, 'weekly');
            console.log('ðŸ“„ Generated report content length:', reportContent.length);
            console.log('ðŸ“„ Report preview (first 500 chars):', reportContent.substring(0, 500));
            
            // Open the email form
            openEmailForm();
            
            console.log('ðŸŽ¯ Email form test complete - check the modal!');
        }
        
        function testCompleteEmailWorkflow() {
            console.log('ðŸš€ TESTING COMPLETE EMAIL WORKFLOW...');
            
            // First ensure we have test data
            testEmailForm();
            
            // Wait a moment for the modal to open, then simulate form filling
            setTimeout(() => {
                try {
                    // Fill out the form with test data
                    const recipientEmail = document.getElementById('recipientEmail');
                    const recipientName = document.getElementById('recipientName');
                    const reportTypeSelect = document.getElementById('reportType');
                    
                    if (recipientEmail) recipientEmail.value = 'test@example.com';
                    if (recipientName) recipientName.value = 'Test Manager';
                    if (reportTypeSelect) reportTypeSelect.value = 'weekly';
                    
                    // Check all content options
                    const checkboxes = [
                        'includeSummary', 'includeStatistics', 'includeAbsentees',
                        'includePerfectAttendance', 'includeTrends', 'includeAlerts',
                        'includeCharts', 'includeDetails'
                    ];
                    
                    checkboxes.forEach(checkboxId => {
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) {
                            checkbox.checked = true;
                            console.log(`âœ… Checked ${checkboxId}`);
                        }
                    });
                    
                    console.log('ðŸ“‹ Form filled with test data - now test the Generate Email button!');
                    console.log('ðŸ’¡ Click "Generate Email" to see the full customized report.');
                    
                } catch (error) {
                    console.error('âŒ Error in test workflow:', error);
                }
            }, 1000);
        }
        
        function testClearData() {
            console.log('Testing clear data...');
            clearAllData();
        }

        // Simple Email Functions
        function openEmailForm() {
            console.log('Opening simple email form...');
            
            if (elements.emailFormModal) {
                elements.emailFormModal.style.display = 'flex';
                elements.emailFormModal.style.alignItems = 'center';
                elements.emailFormModal.style.justifyContent = 'center';
                elements.emailFormModal.style.position = 'fixed';
                elements.emailFormModal.style.top = '0';
                elements.emailFormModal.style.left = '0';
                elements.emailFormModal.style.width = '100%';
                elements.emailFormModal.style.height = '100%';
                elements.emailFormModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                elements.emailFormModal.style.zIndex = '1000';
            }
        }

        function closeEmailForm() {
            if (elements.emailFormModal) {
                elements.emailFormModal.style.display = 'none';
            }
        }
        
        function sendSimpleEmail() {
            const recipientEmail = document.getElementById('recipientEmail').value;
            
            if (!recipientEmail) {
                alert('Please enter an email address.');
                return;
            }

            // Get current date for filename
            const currentDate = new Date();
            const dateStr = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD format
            
            // Create email content with instructions for PDF attachment
            const emailContent = `ðŸ“Š ATTENDANCE ANALYTICS REPORT

Dear Recipient,

Please find the attached Attendance Analytics Report PDF that includes:

âœ… Complete attendance statistics for all students
âœ… Advanced analytics with trends and insights  
âœ… Statistical measures (CI, EI, Weekly Changes, Min Rate, etc.)
âœ… Color-coded performance indicators
âœ… Comprehensive data analysis

ðŸ“… Report Date: ${currentDate.toLocaleString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}

ðŸ“Ž Note: Please download the PDF report from the Analytics section and attach it to this email before sending.

Best regards,
Attendance Tracker System v3.0
`;

            // Open email client with the content
            const subject = `ðŸ“Š Attendance Analytics Report - ${dateStr}`;
            const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailContent)}`;
            
            try {
                window.open(mailtoLink, '_self');
            } catch (error) {
                // Fallback method
                const tempLink = document.createElement('a');
                tempLink.href = mailtoLink;
                tempLink.target = '_blank';
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);
            }
            
            // Close the email form
            closeEmailForm();
            
            // Show success message
            alert('ï¿½ Email opened successfully!\n\nï¿½ Remember to:\n1. Download the PDF from Analytics section\n2. Attach it to the email\n3. Send the email');
        }
        
        // Helper function to calculate email analytics
        function calculateEmailAnalytics(records) {
            if (records.length === 0) {
                return {
                    attendanceRate: 0,
                    dateRange: 'No records',
                    periodSummary: 'Empty',
                    quickInsights: 'âŒ No attendance data available.'
                };
            }
            
            const presentCount = records.filter(r => {
                const status = (r.attendanceStatus || r.attendanceLabel || '').toString().toLowerCase();
                return status.includes('present') || status === 'p' || status === '1';
            }).length;
            
            const absentCount = records.filter(r => {
                const status = (r.attendanceStatus || r.attendanceLabel || '').toString().toLowerCase();
                return status.includes('absent') || status === 'a' || status === '0';
            }).length;
            
            const attendanceRate = records.length > 0 ? Math.round((presentCount / records.length) * 100) : 0;
            
            // Get date range
            const dates = records.map(r => new Date(r.dateTime || `${r.date} ${r.time}`));
            const oldestDate = new Date(Math.min(...dates));
            const newestDate = new Date(Math.max(...dates));
            
            const dateRange = oldestDate.toDateString() === newestDate.toDateString() 
                ? oldestDate.toLocaleDateString('en-US')
                : `${oldestDate.toLocaleDateString('en-US')} â†’ ${newestDate.toLocaleDateString('en-US')}`;
            
            const daysDifference = Math.ceil((newestDate - oldestDate) / (1000 * 60 * 60 * 24)) + 1;
            const periodSummary = daysDifference === 1 ? 'Today' : `${daysDifference} Days`;
            
            // Generate insights
            let insights = '';
            if (attendanceRate >= 90) {
                insights = 'ðŸŽ‰ EXCELLENT: Outstanding attendance performance!';
            } else if (attendanceRate >= 75) {
                insights = 'ðŸ‘ GOOD: Solid attendance with room for improvement.';
            } else if (attendanceRate >= 50) {
                insights = 'âš ï¸  NEEDS ATTENTION: Below average attendance detected.';
            } else {
                insights = 'ðŸš¨ CRITICAL: Poor attendance requires immediate action.';
            }
            
            const quickInsights = `
ðŸŽ¯ QUICK INSIGHTS:
${insights}
âœ… Present: ${presentCount} records (${attendanceRate}%)
âŒ Absent: ${absentCount} records (${100-attendanceRate}%)
ðŸ“Š Tracking Period: ${daysDifference} day(s)
`;
            
            return {
                attendanceRate,
                dateRange,
                periodSummary,
                quickInsights,
                presentCount,
                absentCount
            };
        }
        
        // Helper function for present students report
        function generatePresentStudentsReport(records, analytics) {
            let content = `
âœ… PRESENT STUDENTS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“ˆ SUCCESS RATE: ${analytics.presentCount}/${records.length} (${analytics.attendanceRate}%)

`;
            
            let count = 0;
            let currentDate = '';
            
            records.forEach(record => {
                const status = (record.attendanceStatus || record.attendanceLabel || '').toString().toLowerCase();
                if (status.includes('present') || status === 'p' || status === '1') {
                    count++;
                    const student = activeStudents[record.student];
                    const name = student ? student.name : (record.studentName || record.student);
                    
                    // Group by date for better visualization
                    if (currentDate !== record.date) {
                        currentDate = record.date;
                        content += `\nðŸ“… ${currentDate}\n${'â”€'.repeat(30)}\n`;
                    }
                    
                    content += `${count.toString().padStart(2, '0')}. âœ… ${name.padEnd(20)} â”‚ ${record.time}\n`;
                }
            });
            
            if (count === 0) {
                content += `âŒ No present students found in the selected period.\n`;
            }
            
            return content;
        }
        
        // Helper function for absent students report  
        function generateAbsentStudentsReport(records, analytics) {
            let content = `
âŒ ABSENT STUDENTS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“Š ABSENCE RATE: ${analytics.absentCount}/${records.length} (${100-analytics.attendanceRate}%)

`;
            
            let count = 0;
            let currentDate = '';
            
            records.forEach(record => {
                const status = (record.attendanceStatus || record.attendanceLabel || '').toString().toLowerCase();
                if (status.includes('absent') || status === 'a' || status === '0') {
                    count++;
                    const student = activeStudents[record.student];
                    const name = student ? student.name : (record.studentName || record.student);
                    
                    // Group by date for better visualization
                    if (currentDate !== record.date) {
                        currentDate = record.date;
                        content += `\nðŸ“… ${currentDate}\n${'â”€'.repeat(30)}\n`;
                    }
                    
                    content += `${count.toString().padStart(2, '0')}. âŒ ${name.padEnd(20)} â”‚ ${record.time}\n`;
                }
            });
            
            if (count === 0) {
                content += `âœ… No absent students found - Perfect attendance!\n`;
            }
            
            return content;
        }
        
        // Helper function for complete attendance report
        function generateCompleteAttendanceReport(records, analytics) {
            let content = `
ðŸ“Š COMPLETE ATTENDANCE OVERVIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“ˆ PERFORMANCE BREAKDOWN:
âœ… Present: ${analytics.presentCount} (${analytics.attendanceRate}%)
âŒ Absent:  ${analytics.absentCount} (${100-analytics.attendanceRate}%)

ðŸ“‹ DETAILED RECORDS:
`;
            
            let currentDate = '';
            
            records.forEach((record, index) => {
                const student = activeStudents[record.student];
                const name = student ? student.name : (record.studentName || record.student);
                const status = record.attendanceStatus || record.attendanceLabel || 'Unknown';
                const statusIcon = status.toLowerCase().includes('present') ? 'âœ…' : 'âŒ';
                
                // Group by date for better visualization
                if (currentDate !== record.date) {
                    currentDate = record.date;
                    content += `\nðŸ“… ${currentDate}\n${'â”€'.repeat(50)}\n`;
                }
                
                content += `${statusIcon} ${name.padEnd(20)} â”‚ ${status.padEnd(8)} â”‚ ${record.time}\n`;
            });
            
            return content;
        }

        function closeEmailPreview() {
            if (elements.emailPreviewModal) {
                elements.emailPreviewModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function previewEmailReport() {
            // This function shows a preview of the email report
            try {
                const recipientEmail = document.getElementById('recipientEmail')?.value || 'user@example.com';
                const reportType = document.querySelector('input[name="reportType"]:checked')?.value || 'both';
                const senderName = document.getElementById('senderName')?.value || 'System';
                
                const analytics = calculateEmailAnalytics(attendanceData);
                const content = generateReportContent(analytics, reportType);
                
                const modal = document.getElementById('emailPreviewModal');
                if (modal) {
                    modal.innerHTML = `
                        <div class="email-modal-content large">
                            <div class="email-modal-header">
                                <h3><i class="fas fa-eye"></i> Email Preview</h3>
                                <button class="email-modal-close" onclick="closeEmailPreview()">&times;</button>
                            </div>
                            <div style="padding: 20px;">
                                <h4>To: ${recipientEmail}</h4>
                                <h4>Subject: Attendance Report - ${analytics.periodSummary}</h4>
                                <div class="email-preview-content">
                                    <pre>${content}</pre>
                                </div>
                                <div style="margin-top: 20px; text-align: center;">
                                    <button class="email-btn primary" onclick="sendFinalEmail()">
                                        <i class="fas fa-paper-plane"></i> Send Email
                                    </button>
                                    <button class="email-btn secondary" onclick="closeEmailPreview()">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    modal.style.display = 'block';
                }
            } catch (error) {
                console.error('Preview error:', error);
                showMessage('âŒ Preview failed: ' + error.message, 'error');
            }
        }

        function sendFinalEmail() {
            try {
                const recipientEmail = document.getElementById('recipientEmail')?.value || 'user@example.com';
                const reportType = document.querySelector('input[name="reportType"]:checked')?.value || 'both';
                
                const analytics = calculateEmailAnalytics(attendanceData);
                const content = generateReportContent(analytics, reportType);
                const subject = `Attendance Report - ${analytics.periodSummary}`;
                
                const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(content)}`;
                window.location.href = mailtoLink;
                
                closeEmailPreview();
                closeEmailForm();
                showMessage('ðŸ“§ Email client opened successfully!', 'success');
            } catch (error) {
                console.error('Send email error:', error);
                showMessage('âŒ Failed to open email client', 'error');
            }
        }

        function handleEmailFormSubmit(event) {
            event.preventDefault();
            console.log('ðŸ“§ Email form submitted');
            
            try {
                const formData = new FormData(event.target);
                const emailData = {
                    to: formData.get('email-to') || '',
                    subject: formData.get('email-subject') || '',
                    message: formData.get('email-message') || '',
                    reportType: formData.get('report-type') || 'today'
                };
                
                console.log('Email data:', emailData);
                
                // Validate required fields
                if (!emailData.to) {
                    showMessage('âŒ Please enter recipient email', 'error');
                    return;
                }
                
                if (!emailData.subject) {
                    showMessage('âŒ Please enter email subject', 'error');
                    return;
                }
                
                // Generate and send the email
                previewEmailReport();
                
            } catch (error) {
                console.error('Email form submission error:', error);
                showMessage('âŒ Failed to process email form', 'error');
            }
        }

        function handleReportTypeChange() {
            const reportType = elements.reportType.value;
            const dateRangeSection = elements.dateRangeSection;
            
            if (dateRangeSection) {
                dateRangeSection.style.display = reportType === 'custom' ? 'flex' : 'none';
            }
            
            // Update subject line based on report type
            if (elements.emailSubject) {
                const reportTypes = {
                    'daily': 'Daily Attendance Report - {date}',
                    'weekly': 'Weekly Attendance Summary - {date}',
                    'monthly': 'Monthly Attendance Report - {date}',
                    'custom': 'Custom Attendance Report - {date}',
                    'alerts': 'Attendance Alert Report - {date}',
                    'comprehensive': 'Comprehensive Attendance Analysis - {date}'
                };
                
                elements.emailSubject.value = reportTypes[reportType] || 'Attendance Report - {date}';
            }
        }

        // Test functions for debugging
        function testEmailForm() {
            console.log('ðŸ§ª TESTING SIMPLE EMAIL FORM...');
            console.log('attendanceData length:', attendanceData.length);
            console.log('activeStudents count:', Object.keys(activeStudents).length);
            
            // Don't add test data if real data exists
            if (attendanceData.length > 0) {
                console.log('âœ… Using existing real data');
                
                // Debug current data
                const today = new Date();
                const todayFormatted = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
                const todayRecords = attendanceData.filter(record => record.date === todayFormatted);
                const presentToday = todayRecords.filter(r => r.status === 'present');
                const absentToday = todayRecords.filter(r => r.status === 'absent');
                
                console.log('ðŸ“Š Current data summary:');
                console.log('- Total records:', attendanceData.length);
                console.log('- Today records:', todayRecords.length);
                console.log('- Present today:', presentToday.length);
                console.log('- Absent today:', absentToday.length);
                console.log('- Date being used:', todayFormatted);
                console.log('- Sample dates in data:', attendanceData.slice(0, 5).map(r => r.date));
                
                openEmailForm();
                return;
            }
            
            // Only add test data if no real data exists
            if (attendanceData.length === 0) {
                // Add simple test data
                const today = new Date();
                const todayFormatted = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
                console.log('Creating test data for date:', todayFormatted);
                
                // Add some test students
                activeStudents['STU001'] = { firstName: 'John', lastName: 'Doe', id: 'STU001' };
                activeStudents['STU002'] = { firstName: 'Jane', lastName: 'Smith', id: 'STU002' };
                activeStudents['STU003'] = { firstName: 'Mike', lastName: 'Johnson', id: 'STU003' };
                activeStudents['STU004'] = { firstName: 'Sarah', lastName: 'Wilson', id: 'STU004' };
                activeStudents['STU005'] = { firstName: 'Tom', lastName: 'Brown', id: 'STU005' };
                
                // Add attendance records for today - Mix of present and absent
                attendanceData.push(
                    { student: 'STU001', status: 'present', date: todayFormatted, time: '8:00 AM', latitude: '25.316557', longitude: '55.374643', address: 'School Location' },
                    { student: 'STU002', status: 'absent', date: todayFormatted, time: '8:00 AM', latitude: '', longitude: '', address: '' },
                    { student: 'STU003', status: 'present', date: todayFormatted, time: '8:15 AM', latitude: '25.316557', longitude: '55.374643', address: 'School Location' },
                    { student: 'STU004', status: 'absent', date: todayFormatted, time: '8:00 AM', latitude: '', longitude: '', address: '' },
                    { student: 'STU005', status: 'present', date: todayFormatted, time: '8:10 AM', latitude: '25.316557', longitude: '55.374643', address: 'School Location' }
                );
                
                console.log('âœ… Added test data for today:', todayFormatted);
                console.log('Total records:', attendanceData.length);
                console.log('Sample record:', attendanceData[0]);
                updateDisplay();
            }
            
            openEmailForm();
        }
        
        // Quick test function to debug your real data
        function debugRealData() {
            console.log('ðŸ” DEBUGGING REAL DATA...');
            console.log('Total attendance records:', attendanceData.length);
            
            if (attendanceData.length > 0) {
                console.log('First 10 records with exact status values:');
                attendanceData.slice(0, 10).forEach((record, index) => {
                    console.log(`${index + 1}. Student: ${record.student}, Status: "${record.status}" (type: ${typeof record.status}), Date: "${record.date}", Time: ${record.time}`);
                });
                
                // Check today's records
                const today = new Date();
                const todayFormatted = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
                const todayRecords = attendanceData.filter(record => record.date === todayFormatted);
                
                console.log(`\nToday's date: "${todayFormatted}"`);
                console.log(`Today's records: ${todayRecords.length}`);
                
                if (todayRecords.length > 0) {
                    console.log('Today\'s records with exact status values:');
                    todayRecords.forEach((record, index) => {
                        const student = activeStudents[record.student];
                        const name = student ? `${student.firstName} ${student.lastName}` : 'Unknown';
                        console.log(`${index + 1}. ${name} (${record.student}) - Status: "${record.status}" (${typeof record.status}) - Time: ${record.time}`);
                    });
                    
                    // Show all unique status values
                    const statusValues = todayRecords.map(r => r.status);
                    const uniqueStatuses = [...new Set(statusValues)];
                    console.log('\nUnique status values found today:', uniqueStatuses);
                    console.log('Status value details:', uniqueStatuses.map(s => `"${s}" (type: ${typeof s}, length: ${s ? s.length : 'null'})`));
                }
            } else {
                console.log('No attendance data found!');
            }
        }
        
        function generateAdvancedAnalytics(reportType) {
            const today = new Date().toDateString();
            const analytics = {
                totalRecords: attendanceData.length,
                totalStudents: Object.keys(activeStudents).length,
                presentCount: attendanceData.filter(r => r.status === 'present').length,
                absentCount: attendanceData.filter(r => r.status === 'absent').length,
                todayRecords: attendanceData.filter(r => new Date(r.date).toDateString() === today).length,
                todayPresent: attendanceData.filter(r => new Date(r.date).toDateString() === today && r.status === 'present').length,
                todayAbsent: attendanceData.filter(r => new Date(r.date).toDateString() === today && r.status === 'absent').length,
                dateRange: getDateRange(reportType),
                absentStudents: [],
                perfectAttendance: [],
                consecutiveAbsences: 0,
                weeklyAverage: 85,
                monthlyAverage: 82,
                previousRate: 78,
                peakDay: 'Monday'
            };
            
            // Calculate percentages
            analytics.attendanceRate = analytics.totalRecords > 0 ? 
                Math.round((analytics.presentCount / analytics.totalRecords) * 100) : 0;
            analytics.absentPercentage = 100 - analytics.attendanceRate;
            
            analytics.todayPresentRate = analytics.todayRecords > 0 ? 
                Math.round((analytics.todayPresent / analytics.todayRecords) * 100) : 0;
            analytics.todayAbsentRate = 100 - analytics.todayPresentRate;
            
            // Generate absentee analysis
            const studentAbsenceAnalysis = {};
            Object.keys(activeStudents).forEach(studentId => {
                const studentRecords = attendanceData.filter(r => r.student === studentId);
                const absentRecords = studentRecords.filter(r => r.status === 'absent');
                const presentRecords = studentRecords.filter(r => r.status === 'present');
                
                if (studentRecords.length > 0) {
                    const absenceRate = Math.round((absentRecords.length / studentRecords.length) * 100);
                    const lastPresent = presentRecords.length > 0 ? 
                        presentRecords[presentRecords.length - 1].date : 'Never';
                    
                    // Calculate consecutive absences (simplified)
                    let consecutiveAbsences = 0;
                    const recentRecords = studentRecords.slice(-5); // Last 5 records
                    for (let i = recentRecords.length - 1; i >= 0; i--) {
                        if (recentRecords[i].status === 'absent') {
                            consecutiveAbsences++;
                        } else {
                            break;
                        }
                    }
                    
                    studentAbsenceAnalysis[studentId] = {
                        name: `${activeStudents[studentId].firstName} ${activeStudents[studentId].lastName}`,
                        id: studentId,
                        absenceRate: absenceRate,
                        lastSeen: lastPresent,
                        consecutiveAbsences: consecutiveAbsences,
                        totalAbsences: absentRecords.length,
                        attendanceRate: 100 - absenceRate
                    };
                }
            });
            
            // Identify students requiring attention (high absence rates or consecutive absences)
            analytics.absentStudents = Object.values(studentAbsenceAnalysis)
                .filter(student => student.absenceRate > 25 || student.consecutiveAbsences >= 2)
                .sort((a, b) => b.absenceRate - a.absenceRate)
                .slice(0, 10); // Top 10 concerning students
            
            // Identify perfect/excellent attendance students
            analytics.perfectAttendance = Object.values(studentAbsenceAnalysis)
                .filter(student => student.attendanceRate >= 95 && student.totalAbsences <= 1)
                .sort((a, b) => b.attendanceRate - a.attendanceRate)
                .slice(0, 15) // Top 15 excellent students
                .map(student => ({
                    name: student.name,
                    id: student.id,
                    days: attendanceData.filter(r => r.student === student.id && r.status === 'present').length,
                    rate: student.attendanceRate
                }));
            
            return analytics;
        }

        function getDateRange(reportType) {
            const today = new Date();
            
            switch (reportType) {
                case 'daily':
                    return today.toLocaleDateString();
                case 'weekly':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    return `${weekStart.toLocaleDateString()} - ${today.toLocaleDateString()}`;
                case 'monthly':
                    return today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                case 'custom':
                    const startDate = elements.startDate?.value;
                    const endDate = elements.endDate?.value;
                    if (startDate && endDate) {
                        return `${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`;
                    }
                    return 'Custom Range';
                default:
                    return 'All Available Data';
            }
        }

        function getReportTypeIntro(reportType) {
            const intros = {
                'daily': 'Please find below the daily attendance summary for today:\n\n',
                'weekly': 'Please find below the weekly attendance summary:\n\n',
                'monthly': 'Please find below the monthly attendance performance report:\n\n',
                'custom': 'Please find below the custom attendance report for the selected period:\n\n',
                'alerts': 'This report highlights attendance concerns that require your attention:\n\n',
                'comprehensive': 'Please find below the comprehensive attendance analysis with detailed insights:\n\n'
            };
            
            return intros[reportType] || 'Please find below the attendance report:\n\n';
        }

        function generateReportContent(analytics, reportType) {
            const checkboxes = getSelectedCheckboxes();
            console.log('Selected checkboxes:', checkboxes);
            let content = '';
            
            // Executive Summary
            if (checkboxes.includeSummary) {
                content += `ðŸ“Š EXECUTIVE SUMMARY\n`;
                content += `${'='.repeat(50)}\n`;
                content += `â€¢ Overall Attendance Rate: ${analytics.attendanceRate}%\n`;
                content += `â€¢ Total Active Students: ${analytics.totalStudents}\n`;
                content += `â€¢ Records Analyzed: ${analytics.totalRecords}\n`;
                content += `â€¢ Report Period: ${analytics.dateRange}\n`;
                
                if (analytics.attendanceRate >= 90) {
                    content += `â€¢ Status: âœ… EXCELLENT attendance performance\n`;
                } else if (analytics.attendanceRate >= 75) {
                    content += `â€¢ Status: âš ï¸ GOOD attendance with room for improvement\n`;
                } else {
                    content += `â€¢ Status: ðŸš¨ ATTENTION REQUIRED - Low attendance\n`;
                }
                content += `\n`;
            }
            
            // Key Statistics
            if (checkboxes.includeStatistics) {
                content += `ðŸ“ˆ KEY PERFORMANCE INDICATORS\n`;
                content += `${'='.repeat(50)}\n`;
                content += `Present Today: ${analytics.todayPresent} students (${analytics.todayPresentRate}%)\n`;
                content += `Absent Today: ${analytics.todayAbsent} students (${analytics.todayAbsentRate}%)\n`;
                content += `Overall Present: ${analytics.presentCount} records\n`;
                content += `Overall Absent: ${analytics.absentCount} records\n`;
                content += `Peak Attendance Day: ${analytics.peakDay || 'Monday'}\n`;
                content += `Weekly Average: ${analytics.weeklyAverage || 85}%\n`;
                content += `Monthly Average: ${analytics.monthlyAverage || 82}%\n`;
                content += `\n`;
            }
            
            // Absentee List
            if (checkboxes.includeAbsentees) {
                content += `ðŸš¨ STUDENTS REQUIRING ATTENTION\n`;
                content += `${'='.repeat(50)}\n`;
                
                if (analytics.absentStudents && analytics.absentStudents.length > 0) {
                    analytics.absentStudents.forEach((student, index) => {
                        content += `${index + 1}. ${student.name} (${student.id})\n`;
                        content += `   Last Seen: ${student.lastSeen}\n`;
                        content += `   Absence Rate: ${student.absenceRate}%\n`;
                        content += `   Status: ${student.consecutiveAbsences >= 3 ? 'ðŸš¨ HIGH RISK' : 'âš ï¸ Monitor'}\n\n`;
                    });
                } else {
                    content += `âœ… No students requiring immediate attention.\n`;
                    content += `All students maintain acceptable attendance rates.\n\n`;
                }
            }
            
            // Perfect Attendance
            if (checkboxes.includePerfectAttendance) {
                content += `ðŸŒŸ PERFECT ATTENDANCE RECOGNITION\n`;
                content += `${'='.repeat(50)}\n`;
                
                if (analytics.perfectAttendance && analytics.perfectAttendance.length > 0) {
                    analytics.perfectAttendance.forEach((student, index) => {
                        content += `${index + 1}. ${student.name} (${student.id}) - ${student.days} days perfect attendance\n`;
                    });
                } else {
                    // Generate based on actual data
                    const excellentStudents = [];
                    Object.keys(activeStudents).forEach(studentId => {
                        const studentRecords = attendanceData.filter(r => r.student === studentId);
                        const presentCount = studentRecords.filter(r => r.status === 'present').length;
                        const rate = studentRecords.length > 0 ? (presentCount / studentRecords.length) * 100 : 0;
                        
                        if (rate >= 95 && studentRecords.length >= 3) {
                            const student = activeStudents[studentId];
                            excellentStudents.push({
                                name: `${student.firstName} ${student.lastName}`,
                                id: studentId,
                                rate: Math.round(rate),
                                days: studentRecords.length
                            });
                        }
                    });
                    
                    if (excellentStudents.length > 0) {
                        excellentStudents.forEach((student, index) => {
                            content += `${index + 1}. ${student.name} (${student.id}) - ${student.rate}% attendance (${student.days} records)\n`;
                        });
                    } else {
                        content += `No students currently qualify for perfect attendance recognition.\n`;
                        content += `Encourage students to maintain consistent attendance.\n`;
                    }
                }
                content += `\n`;
            }
            
            // Attendance Trends
            if (checkboxes.includeTrends) {
                content += `ðŸ“Š ATTENDANCE TRENDS & ANALYSIS\n`;
                content += `${'='.repeat(50)}\n`;
                
                const currentRate = analytics.attendanceRate;
                const previousRate = analytics.previousRate || 78;
                
                if (currentRate > previousRate) {
                    content += `ðŸ“ˆ Trend: IMPROVING (+${(currentRate - previousRate).toFixed(1)}%)\n`;
                    content += `   Positive momentum - maintain current strategies\n`;
                } else if (currentRate < previousRate) {
                    content += `ðŸ“‰ Trend: DECLINING (${(currentRate - previousRate).toFixed(1)}%)\n`;
                    content += `   Requires attention - consider intervention strategies\n`;
                } else {
                    content += `âž¡ï¸ Trend: STABLE (no significant change)\n`;
                    content += `   Consistent performance - monitor for improvements\n`;
                }
                
                content += `Daily Average: ${currentRate}%\n`;
                content += `Weekly Target: 85%\n`;
                content += `Monthly Goal: 90%\n`;
                content += `Best Day: Monday (estimated)\n`;
                content += `Improvement Areas: ${currentRate < 80 ? 'Overall attendance' : 'Consistency'}\n`;
                content += `\n`;
            }
            
            // Alert Recommendations
            if (checkboxes.includeAlerts) {
                content += `âš ï¸ ALERTS & ACTIONABLE RECOMMENDATIONS\n`;
                content += `${'='.repeat(50)}\n`;
                
                let alertCount = 0;
                
                if (analytics.attendanceRate < 75) {
                    alertCount++;
                    content += `ðŸš¨ CRITICAL ALERT: Overall attendance below 75%\n`;
                    content += `   â†’ Immediate Action: Schedule management review meeting\n`;
                    content += `   â†’ Contact parents/guardians of frequent absentees\n`;
                    content += `   â†’ Review attendance policies and incentives\n\n`;
                }
                
                if (analytics.todayAbsent > analytics.todayPresent) {
                    alertCount++;
                    content += `âš ï¸ TODAY'S ALERT: More absences than attendance today\n`;
                    content += `   â†’ Follow up with absent students\n`;
                    content += `   â†’ Check for external factors (weather, events, etc.)\n\n`;
                }
                
                const consecutiveAbsents = analytics.absentStudents ? analytics.absentStudents.filter(s => s.consecutiveAbsences >= 3).length : 0;
                if (consecutiveAbsents > 0) {
                    alertCount++;
                    content += `ðŸ“ž FOLLOW-UP REQUIRED: ${consecutiveAbsents} students with 3+ consecutive absences\n`;
                    content += `   â†’ Personal contact recommended\n`;
                    content += `   â†’ Documentation required\n\n`;
                }
                
                if (alertCount === 0) {
                    content += `âœ… NO CRITICAL ALERTS\n`;
                    content += `Current attendance levels are within acceptable parameters.\n`;
                    content += `Continue monitoring and maintain current strategies.\n`;
                }
                content += `\n`;
            }
            
            // Visual Charts (Text-based)
            if (checkboxes.includeCharts) {
                content += `ðŸ“Š VISUAL ATTENDANCE ANALYSIS\n`;
                content += `${'='.repeat(50)}\n`;
                
                // Attendance Rate Bar Chart
                const presentBars = Math.round(analytics.attendanceRate / 5);
                const absentBars = 20 - presentBars;
                content += `ATTENDANCE RATE VISUALIZATION:\n`;
                content += `Present : ${'â–ˆ'.repeat(presentBars)}${'â–‘'.repeat(absentBars)} ${analytics.attendanceRate}%\n`;
                content += `Absent  : ${'â–ˆ'.repeat(Math.round(analytics.absentPercentage / 5))}${'â–‘'.repeat(20 - Math.round(analytics.absentPercentage / 5))} ${analytics.absentPercentage}%\n`;
                content += `          ${'-'.repeat(20)}\n`;
                content += `          0%    25%    50%    75%   100%\n\n`;
                
                // Weekly Trend (simulated)
                content += `WEEKLY TREND (Last 7 Days):\n`;
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const rates = [88, 92, 85, 90, 87, 75, 80]; // Sample data
                days.forEach((day, index) => {
                    const bars = Math.round(rates[index] / 10);
                    content += `${day}: ${'â–ˆ'.repeat(bars)}${'â–‘'.repeat(10 - bars)} ${rates[index]}%\n`;
                });
                content += `\n`;
            }
            
            // Detailed Records
            if (checkboxes.includeDetails) {
                content += `ðŸ“‹ DETAILED ATTENDANCE RECORDS\n`;
                content += `${'='.repeat(50)}\n`;
                content += `Date       | Student ID | Name                | Status  | Time     | Location\n`;
                content += `${'-'.repeat(85)}\n`;
                
                const recordsToShow = Math.min(attendanceData.length, 25);
                attendanceData.slice(0, recordsToShow).forEach(record => {
                    const studentInfo = activeStudents[record.student] || {};
                    const name = `${studentInfo.firstName || ''} ${studentInfo.lastName || ''}`.trim() || record.student;
                    const status = record.status === 'present' ? 'Present' : 'Absent ';
                    const location = record.address ? record.address.substring(0, 20) : 'N/A';
                    
                    content += `${record.date.padEnd(10)} | ${record.student.padEnd(10)} | ${name.padEnd(19)} | ${status} | ${record.time.padEnd(8)} | ${location}\n`;
                });
                
                if (attendanceData.length > 25) {
                    content += `... and ${attendanceData.length - 25} more records (showing most recent 25)\n`;
                }
                
                if (attendanceData.length === 0) {
                    content += `No attendance records found.\n`;
                    content += `Please ensure students are marking attendance.\n`;
                }
                content += `\n`;
            }
            
            console.log('Generated content length:', content.length);
            return content;
        }

        function getSelectedCheckboxes() {
            return {
                includeSummary: document.getElementById('includeSummary')?.checked || false,
                includeStatistics: document.getElementById('includeStatistics')?.checked || false,
                includeAbsentees: document.getElementById('includeAbsentees')?.checked || false,
                includePerfectAttendance: document.getElementById('includePerfectAttendance')?.checked || false,
                includeTrends: document.getElementById('includeTrends')?.checked || false,
                includeAlerts: document.getElementById('includeAlerts')?.checked || false,
                includeCharts: document.getElementById('includeCharts')?.checked || false,
                includeDetails: document.getElementById('includeDetails')?.checked || false,
            };
        }

        function getReportFooter(senderName) {
            return `\n${'='.repeat(60)}\n` +
                   `ðŸ“‹ REPORT DETAILS\n` +
                   `Generated: ${new Date().toLocaleString()}\n` +
                   `System: Professional Attendance Tracking System\n` +
                   `Prepared by: ${senderName}\n` +
                   `Total Records Analyzed: ${attendanceData.length}\n\n` +
                   `ðŸ“ž For questions or assistance, please contact the system administrator.\n` +
                   `âš¡ This report was generated automatically with real-time data.\n\n` +
                   `Best regards,\n${senderName}\nAttendance Management Team`;
        }

        function clearAllData() {
            if (attendanceData.length === 0) {
                showMessage('No data to clear', 'warning');
                return;
            }
            
            // Create custom confirmation dialog for data clearing
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirmation-overlay';
            confirmDialog.innerHTML = `
                <div class="confirmation-modal">
                    <div class="confirmation-header" style="background: #e74c3c;">
                        <h3><i class="fas fa-exclamation-triangle"></i> Clear All Data</h3>
                    </div>
                    <div class="confirmation-body">
                        <p><strong>Are you sure you want to delete all ${attendanceData.length} attendance records?</strong></p>
                        <p style="color: #e74c3c; margin-top: 15px;"><i class="fas fa-warning"></i> This action cannot be undone!</p>
                    </div>
                    <div class="confirmation-actions">
                        <button class="confirm-btn cancel-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="confirm-btn" style="background: #e74c3c;">
                            <i class="fas fa-trash"></i> Yes, Delete All
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            const cancelBtn = confirmDialog.querySelector('.cancel-btn');
            const confirmBtn = confirmDialog.querySelector('.confirm-btn:not(.cancel-btn)');
            
            const closeDialog = () => {
                document.body.removeChild(confirmDialog);
            };
            
            cancelBtn.addEventListener('click', closeDialog);
            
            confirmBtn.addEventListener('click', () => {
                closeDialog();
                clearAllData();
            });
            
            confirmDialog.addEventListener('click', (e) => {
                if (e.target === confirmDialog) {
                    closeDialog();
                }
            });
            
            setTimeout(() => confirmBtn.focus(), 100);
        }
        
        // Local Storage Data Management Functions
        function loadDataFromStorage() {
            try {
                const saved = localStorage.getItem('attendanceData');
                if (saved) {
                    attendanceData = JSON.parse(saved);
                    displayRecords();
                    updateStatistics();
                    populateFilterDropdowns();
                    showMessage('ðŸ“± Data loaded from local storage', 'info');
                } else {
                    showMessage('ðŸ“ Ready to start recording attendance!', 'info');
                }
                
                // Load sync queue
                const syncQueueData = localStorage.getItem('attendanceSyncQueue');
                if (syncQueueData) {
                    try {
                        syncQueue = JSON.parse(syncQueueData);
                        console.log(`Loaded ${syncQueue.length} records in sync queue`);
                    } catch (error) {
                        console.error('Error parsing sync queue:', error);
                        syncQueue = [];
                    }
                }
                
                // Load Firebase preference
                const firebaseMode = localStorage.getItem('useFirebase');
                if (firebaseMode !== null) {
                    useFirebase = firebaseMode === 'true';
                }
                
                // Try to load from Firebase if available and online
                if (useFirebase && window.FirebaseHelper && navigator.onLine) {
                    setTimeout(() => loadFromFirebase(), 1000); // Delay to ensure Firebase is ready
                }
                
            } catch (error) {
                console.error('Error loading local data:', error);
                showMessage('ðŸ“ Ready to start recording attendance!', 'info');
            }
        }

        // Firebase data loading function
        async function loadFromFirebase() {
            try {
                showMessage('ðŸ”„ Syncing with cloud...', 'info');
                const result = await window.FirebaseHelper.getAttendanceRecords();
                
                if (result.success) {
                    // Merge Firebase data with local data (avoid duplicates)
                    const firebaseData = result.data;
                    const mergedData = mergeAttendanceData(attendanceData, firebaseData);
                    
                    if (mergedData.length !== attendanceData.length) {
                        attendanceData = mergedData;
                        saveDataToStorage(); // Update local storage
                        showMessage(`âœ… Synced ${firebaseData.length} records from cloud`, 'success');
                        
                        // Update displays if visible
                        if (elements.recordsSection.style.display !== 'none') {
                            displayRecords();
                            updateStatistics();
                            generateAnalytics();
                        }
                    }
                    
                    // Process sync queue if any
                    if (syncQueue.length > 0) {
                        await processSyncQueue();
                    }
                }
            } catch (error) {
                console.error('Firebase load error:', error);
                showMessage('âš ï¸ Using offline data', 'warning');
            }
        }

        // Merge attendance data avoiding duplicates
        function mergeAttendanceData(localData, firebaseData) {
            const merged = [...localData];
            const localIds = new Set(localData.map(record => record.id));
            
            firebaseData.forEach(firebaseRecord => {
                // Check if record already exists locally
                if (!localIds.has(firebaseRecord.id)) {
                    merged.push(firebaseRecord);
                }
            });
            
            // Sort by date (newest first)
            return merged.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Process sync queue (upload pending records)
        async function processSyncQueue() {
            if (syncQueue.length === 0) return;
            
            try {
                showMessage(`ðŸ“¤ Syncing ${syncQueue.length} pending records...`, 'info');
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = syncQueue.length - 1; i >= 0; i--) {
                    const record = syncQueue[i];
                    try {
                        const result = await window.FirebaseHelper.addAttendanceRecord(record);
                        if (result.success) {
                            successCount++;
                            // Update local record with Firebase ID
                            const localRecord = attendanceData.find(r => r.id === record.id);
                            if (localRecord) {
                                localRecord.firebaseId = result.id;
                            }
                            // Remove from sync queue
                            syncQueue.splice(i, 1);
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error('Sync error for record:', error);
                        errorCount++;
                    }
                }
                
                // Update sync queue in storage
                localStorage.setItem('attendanceSyncQueue', JSON.stringify(syncQueue));
                
                if (successCount > 0) {
                    showMessage(`âœ… Synced ${successCount} records to cloud`, 'success');
                    saveDataToStorage(); // Update local storage with Firebase IDs
                }
                
                if (errorCount > 0) {
                    showMessage(`âš ï¸ ${errorCount} records failed to sync`, 'warning');
                }
                
            } catch (error) {
                console.error('Sync queue processing error:', error);
                showMessage('âš ï¸ Sync failed - records saved locally', 'warning');
            }
        }

        // Manual sync function
        async function syncWithFirebase() {
            if (!useFirebase || !window.FirebaseHelper) {
                showMessage('âŒ Firebase not configured', 'error');
                return;
            }
            
            if (!navigator.onLine) {
                showMessage('âŒ No internet connection', 'error');
                return;
            }
            
            try {
                showLoading(true);
                await loadFromFirebase();
                await processSyncQueue();
                showMessage('ðŸ”„ Full sync completed!', 'success');
            } catch (error) {
                console.error('Manual sync error:', error);
                showMessage('âŒ Sync failed', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Toggle Firebase usage
        function toggleFirebaseMode() {
            useFirebase = !useFirebase;
            localStorage.setItem('useFirebase', useFirebase.toString());
            
            if (useFirebase) {
                showMessage('ðŸ”¥ Firebase enabled - data will sync to cloud', 'success');
                if (navigator.onLine && window.FirebaseHelper) {
                    syncWithFirebase();
                }
            } else {
                showMessage('ðŸ’¾ Local mode - data saved offline only', 'info');
            }
            
            updateFirebaseUI();
        }

        // Update UI to show Firebase status
        function updateFirebaseUI() {
            const statusText = useFirebase ? 'ðŸ”¥ Cloud Sync' : 'ðŸ’¾ Local Only';
            const modeElement = document.getElementById('currentMode');
            const buttonElement = document.getElementById('firebaseStatusText');
            const toggleButton = document.getElementById('toggleFirebaseBtn');
            
            if (modeElement) modeElement.textContent = statusText;
            if (buttonElement) buttonElement.textContent = useFirebase ? 'Disable Cloud' : 'Enable Cloud';
            if (toggleButton) {
                toggleButton.style.background = useFirebase ? '#f44336' : '#4CAF50';
                toggleButton.innerHTML = useFirebase ? '<i class="fas fa-toggle-off"></i> Disable Cloud' : '<i class="fas fa-toggle-on"></i> Enable Cloud';
            }
            
            updateSyncQueueUI();
            updateConnectionStatus();
        }

        function updateSyncQueueUI() {
            const queueElement = document.getElementById('syncQueueCount');
            if (queueElement) {
                queueElement.textContent = syncQueue.length;
                queueElement.style.color = syncQueue.length > 0 ? '#ff9800' : '#4caf50';
            }
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                if (!navigator.onLine) {
                    statusElement.textContent = 'Offline ðŸ”´';
                    statusElement.style.color = '#f44336';
                } else if (!useFirebase || !window.FirebaseHelper) {
                    statusElement.textContent = 'Local Mode ðŸŸ¡';
                    statusElement.style.color = '#ff9800';
                } else {
                    statusElement.textContent = 'Online ðŸŸ¢';
                    statusElement.style.color = '#4caf50';
                }
            }
        }

        function showFirebaseStatus() {
            const status = `
ðŸ”¥ FIREBASE STATUS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ”— Connection: ${navigator.onLine ? 'Online' : 'Offline'}
ðŸ”¥ Firebase: ${useFirebase ? 'Enabled' : 'Disabled'}
ðŸ“Š Local Records: ${attendanceData.length}
ðŸ“¤ Sync Queue: ${syncQueue.length} pending uploads
  Storage Mode: ${useFirebase && navigator.onLine ? 'Cloud + Local' : 'Local Only'}

  ACTIONS AVAILABLE:
â€¢ ${useFirebase ? 'Disable' : 'Enable'} cloud sync
â€¢ Manual sync with cloud
â€¢ View sync queue status
â€¢ Clear local data

${syncQueue.length > 0 ? 'âš  You have pending uploads. Click "Sync Now" to upload them.' : 'âœ… All data is synced.'}
            `;
            
            alert(status);
        }

        // Initialize Firebase UI when page loads
        function initializeFirebaseUI() {
            // Update UI periodically
            updateFirebaseUI();
            setInterval(() => {
                updateConnectionStatus();
                updateSyncQueueUI();
            }, 5000); // Update every 5 seconds
            
            // Listen for online/offline events
            window.addEventListener('online', () => {
                updateConnectionStatus();
                showMessage('ðŸŒ Connection restored - syncing...', 'success');
                if (useFirebase && window.FirebaseHelper) {
                    setTimeout(() => syncWithFirebase(), 1000);
                }
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus();
                showMessage('ðŸ“± Working offline - data saved locally', 'warning');
            });
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                console.log('Data saved to local storage');
            } catch (error) {
                console.error('Error saving to local storage:', error);
                showMessage('Error saving data locally', 'error');
            }
        }

        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.setAttribute('role', 'alert');
            messageEl.setAttribute('aria-live', 'polite');
            
            const icon = getMessageIcon(type);
            messageEl.innerHTML = `
                <i class="${icon}" aria-hidden="true"></i>
                <span>${message}</span>
                <button class="message-close" aria-label="Close message" onclick="this.parentElement.remove()">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            `;
            
            elements.messageContainer.appendChild(messageEl);
            
            // Remove message after 5 seconds (except errors which stay longer)
            const timeout = type === 'error' ? 10000 : 5000;
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.style.opacity = '0';
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.parentNode.removeChild(messageEl);
                        }
                    }, 300);
                }
            }, timeout);
            
            // Remove on click
            messageEl.addEventListener('click', (e) => {
                if (!e.target.closest('.message-close')) {
                    messageEl.remove();
                }
            });
        }

        function getMessageIcon(type) {
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            return icons[type] || icons.info;
        }

        function enableLocationAccess() {
            updateLocationStatus('ðŸ“ Requesting location permission...', 'info');
            showMessage('Please allow location access when prompted by your browser', 'info');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('Location permission granted:', position);
                    handleLocationSuccess(position);
                    showMessage('Location access enabled successfully!', 'success');
                    
                    // Hide the enable button since permission is now granted
                    const enableBtn = document.getElementById('enableLocationBtn');
                    if (enableBtn) {
                        enableBtn.style.display = 'none';
                    }
                    
                    // Start continuous tracking
                    const continuousToggle = document.getElementById('continuousTrackingToggle');
                    if (!continuousToggle || continuousToggle.checked) {
                        startWatchingPosition();
                    }
                },
                (error) => {
                    console.error('Location permission error:', error);
                    let errorMessage = 'Unable to access location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Permission denied. Please enable location in browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                        default:
                            errorMessage += 'Unknown error occurred.';
                            break;
                    }
                    updateLocationStatus(errorMessage, 'error');
                    showMessage(errorMessage, 'error');
                },
                options
            );
        }

        function showLoading(show) {
            console.log('ðŸ”„ showLoading called with:', show);
            
            if (!elements.loadingOverlay) {
                console.error('âŒ Loading overlay element not found');
                return;
            }
            
            try {
                elements.loadingOverlay.style.display = show ? 'flex' : 'none';
                
                // Disable/enable the attendance buttons during processing
                if (elements.presentBtn) {
                    elements.presentBtn.disabled = show;
                }
                if (elements.absentBtn) {
                    elements.absentBtn.disabled = show;
                }
                
                // Also disable the form submit to prevent multiple submissions
                if (elements.form) {
                    const submitButtons = elements.form.querySelectorAll('button[type="submit"], input[type="submit"]');
                    submitButtons.forEach(btn => {
                        btn.disabled = show;
                    });
                }
                
                console.log('âœ… Loading state updated successfully');
            } catch (error) {
                console.error('âŒ Error in showLoading:', error);
            }
        }

        // Initialize collapsible sections on page load
        function initializeCollapsibleSections() {
            // Set all sections to collapsed by default except Record Attendance
            const collapsibleSections = [
                'actions-content',
                'location-content', 
                'location-controls-content'
            ];
            
            collapsibleSections.forEach(sectionId => {
                const content = document.getElementById(sectionId);
                const icon = document.getElementById(sectionId + '-icon');
                
                if (content && icon) {
                    // All sections start collapsed except Record Attendance
                    content.classList.add('collapsed');
                    icon.classList.remove('rotated');
                }
            });
        }

        // Export functions for global access
        window.deleteRecord = deleteRecord;
        window.removeStudent = removeStudent;
        window.restoreDefaultStudents = restoreDefaultStudents;
        window.closeStudentManagementPanel = closeStudentManagementPanel;
        window.toggleSection = toggleSection;
        window.openEmailForm = openEmailForm;
        window.closeEmailForm = closeEmailForm;
        window.closeEmailPreview = closeEmailPreview;
        window.previewEmailReport = previewEmailReport;
        window.sendFinalEmail = sendFinalEmail;
        window.testEmailForm = testEmailForm;
        window.testClearData = testClearData;
        window.addNewStudent = addNewStudent;
        window.exportFilteredRecordsToPdf = exportFilteredRecordsToPdf;

        
        // Simple Firebase Functions (Working version from index-clean.html)
        async function saveDataToFirestore(record) {
            try {
                showMessage('Saving to cloud...', 'info');
                const docRef = await window.firebase.addDoc(
                    window.firebase.collection(window.firebase.db, 'attendance'), 
                    record
                );
                console.log('Document written with ID: ', docRef.id);
                showMessage('Attendance saved to cloud!', 'success');
            } catch (error) {
                console.error('Error adding document: ', error);
                showMessage('Error saving to cloud: ' + error.message, 'error');
                
                // Fallback to localStorage if Firebase fails
                try {
                    let localData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                    localData.unshift(record);
                    localStorage.setItem('attendanceData', JSON.stringify(localData));
                    showMessage('Saved locally instead', 'warning');
                } catch (localError) {
                    showMessage('Failed to save data', 'error');
                }
            }
        }       

        async function loadDataFromFirestore() {
            try {
                showMessage('Loading data from cloud...', 'info');
                
                // Add more detailed error logging
                console.log('ðŸ”¥ Attempting to load data from Firestore...');
                console.log('ðŸ”¥ Firebase app:', window.firebaseApp);
                console.log('ðŸ”¥ Firebase db:', window.firebase.db);
                
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'attendance'),
                    window.firebase.orderBy('timestamp', 'desc')
                );
                const querySnapshot = await window.firebase.getDocs(q);
                
                attendanceData = [];
                querySnapshot.forEach((doc) => {
                    attendanceData.push({
                        firestoreId: doc.id,
                        firebaseId: doc.id,  // Add this for consistency
                        ...doc.data()
                    });
                });
                
                console.log(`ðŸ”¥ Loaded ${attendanceData.length} records from Firestore`);
                displayRecords();
                updateStatistics();
                populateFilterDropdowns();
                showMessage('Data loaded from cloud!', 'success');
            } catch (error) {
                console.error('ðŸ”¥ Firestore load error details:', error);
                console.error('ðŸ”¥ Error code:', error.code);
                console.error('ðŸ”¥ Error message:', error.message);
                
                // More specific error messages
                let errorMessage = 'Cloud connection failed';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied - check Firestore security rules';
                } else if (error.code === 'not-found') {
                    errorMessage = 'Firestore database not found - create database first';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Firestore service unavailable';
                }
                
                showMessage(errorMessage + ', using local storage', 'warning');
                
                // Fallback to localStorage
                try {
                    const saved = localStorage.getItem('attendanceData');
                    if (saved) {
                        attendanceData = JSON.parse(saved);
                        displayRecords();
                        updateStatistics();
                        populateFilterDropdowns();
                        showMessage('Local data loaded', 'info');
                    }
                } catch (localError) {
                    showMessage('No data found', 'info');
                }
            }
        }

        function setupRealtimeListener() {
            try {
                console.log('ðŸ”¥ Setting up real-time listener...');
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'attendance'),
                    window.firebase.orderBy('timestamp', 'desc')
                );
                
                realtimeUnsubscribe = window.firebase.onSnapshot(q, (querySnapshot) => {
                    console.log('ðŸ”¥ Real-time update received - records count:', querySnapshot.size);
                    attendanceData = [];
                    querySnapshot.forEach((doc) => {
                        attendanceData.push({
                            firestoreId: doc.id,
                            firebaseId: doc.id,  // Add this for consistency with manual loading
                            ...doc.data()
                        });
                    });
                    console.log('ðŸ”¥ Real-time data updated - new length:', attendanceData.length);
                    
                    displayRecords();
                    updateStatistics();
                    populateFilterDropdowns();
                }, (error) => {
                    console.error('ðŸ”¥ Real-time listener error details:', error);
                    console.error('ðŸ”¥ Error code:', error.code);
                    console.error('ðŸ”¥ Error message:', error.message);
                    
                    let errorMessage = 'Real-time sync disabled';
                    if (error.code === 'permission-denied') {
                        errorMessage = 'Real-time sync denied - check Firestore rules';
                    } else if (error.code === 'not-found') {
                        errorMessage = 'Firestore collection not found';
                    }
                    
                    showMessage(errorMessage, 'warning');
                });
                
                // Store unsubscribe function globally
                window.realtimeUnsubscribe = realtimeUnsubscribe;
                
                console.log('ðŸ”¥ Real-time listener setup complete');
                showMessage('Real-time sync enabled!', 'info');
            } catch (error) {
                console.error('ðŸ”¥ Error setting up real-time listener: ', error);
                showMessage('Real-time sync failed: ' + error.message, 'warning');
            }
        }

        async function deleteRecordFromFirestore(recordId) {
            try {
                showLoading(true);
                showMessage('Deleting record...', 'info');
                
                // Find the record by its firestoreId
                const record = attendanceData.find(r => r.firestoreId === recordId);
                if (record && record.firestoreId) {
                    await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'attendance', record.firestoreId));
                    showMessage('Record deleted from cloud!', 'success');
                }
                
                // Remove from local array
                attendanceData = attendanceData.filter(r => r.firestoreId !== recordId);
                
                // Update displays
                displayRecords();
                updateStatistics();
                populateFilterDropdowns();
                
            } catch (error) {
                console.error('Error deleting record: ', error);
                showMessage('Error deleting record: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function clearAllDataFromFirestore() {
            try {
                showLoading(true);
                showMessage('Clearing all cloud data...', 'info');
                
                // Delete all records from Firestore
                const q = window.firebase.query(window.firebase.collection(window.firebase.db, 'attendance'));
                const querySnapshot = await window.firebase.getDocs(q);
                
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(window.firebase.deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                
                // Clear local data
                attendanceData = [];
                localStorage.removeItem('attendanceData');
                
                // Update displays
                displayRecords();
                updateStatistics();
                populateFilterDropdowns();
                
                showMessage('All data cleared from cloud and local storage!', 'success');
            } catch (error) {
                console.error('Error clearing cloud data: ', error);
                showMessage('Error clearing cloud data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Simple Firebase connection test
        async function testFirebaseConnection() {
            try {
                showMessage('Testing Firebase connection...', 'info');
                
                // Try to read from the attendance collection (this will test connectivity)
                const testQuery = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'attendance'),
                    window.firebase.limit(1)
                );
                await window.firebase.getDocs(testQuery);
                
                showMessage('âœ… Firebase connection successful!', 'success');
                return true;
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                showMessage('âŒ Firebase connection failed: ' + error.message, 'error');
                return false;
            }
        }

        // Disable real-time listener (useful for troubleshooting)
        function disableRealtimeSync() {
            try {
                if (window.realtimeUnsubscribe) {
                    window.realtimeUnsubscribe();
                    window.realtimeUnsubscribe = null;
                    showMessage('Real-time sync disabled', 'info');
                }
            } catch (error) {
                console.error('Error disabling real-time sync:', error);
            }
        }

        // Store the unsubscribe function for the real-time listener
        let realtimeUnsubscribe = null;

        // Export simple Firebase functions for global access
        window.saveDataToFirestore = saveDataToFirestore;
        window.loadDataFromFirestore = loadDataFromFirestore;
        window.setupRealtimeListener = setupRealtimeListener;
        window.deleteRecordFromFirestore = deleteRecordFromFirestore;
        window.clearAllDataFromFirestore = clearAllDataFromFirestore;
        window.testFirebaseConnection = testFirebaseConnection;
        window.disableRealtimeSync = disableRealtimeSync;
        
        // Firebase functions
        window.toggleFirebaseMode = toggleFirebaseMode;
        window.syncWithFirebase = syncWithFirebase;
        window.showFirebaseStatus = showFirebaseStatus;
        window.loadFromFirebase = loadFromFirebase;
        window.processSyncQueue = processSyncQueue;
        
        // Error handling for missing functions
        window.handleMissingFunction = function(functionName) {
            console.error(`âŒ Function ${functionName} not found or not properly defined`);
            showMessage(`âŒ Feature temporarily unavailable: ${functionName}`, 'error');
        };
        
        // Test function for debugging
        window.testAddStudent = function() {
            console.log('ðŸ§ª Testing Add Student function...');
            console.log('ðŸ§ª Elements:', {
                addStudentBtn: elements.addStudentBtn,
                newStudentId: elements.newStudentId,
                newStudentName: elements.newStudentName
            });
            console.log('ðŸ§ª Active Students:', activeStudents);
            addNewStudent();
        };

        // Records navigation helper functions
        function updateRecordsCount(count) {
            const recordsCountElement = document.getElementById('recordsCount');
            if (recordsCountElement) {
                recordsCountElement.textContent = count;
                recordsCountElement.parentElement.style.animation = 'countUpdate 0.5s ease';
            }
        }

        function scrollToTop() {
            const recordsSection = document.getElementById('recordsSection');
            if (recordsSection) {
                recordsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            // Also scroll table container to top
            const tableContainer = recordsSection.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.scrollTop = 0;
                tableContainer.scrollLeft = 0;
            }
        }

        function refreshRecords() {
            const refreshBtn = event.target.closest('.info-btn');
            if (refreshBtn) {
                const icon = refreshBtn.querySelector('i');
                icon.style.animation = 'spin 1s linear infinite';
                setTimeout(() => {
                    icon.style.animation = '';
                }, 1000);
            }
            
            // Trigger records refresh
            loadAttendanceData();
            
            // Show success message
            setTimeout(() => {
                showMessage('âœ… Records refreshed successfully!', 'success');
            }, 500);
        }

        // Add count update animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes countUpdate {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); color: var(--button-primary); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // Enhanced keyboard navigation for records
        document.addEventListener('keydown', function(event) {
            const recordsSection = document.getElementById('recordsSection');
            
            // Only handle shortcuts when records section is visible
            if (recordsSection && recordsSection.style.display !== 'none') {
                switch(event.key) {
                    case 'Escape':
                        // Close records view
                        toggleRecordsView();
                        event.preventDefault();
                        break;
                    case 'Home':
                        if (event.ctrlKey) {
                            // Ctrl+Home: Scroll to top
                            scrollToTop();
                            event.preventDefault();
                        }
                        break;
                    case 'F5':
                        if (event.ctrlKey) {
                            // Ctrl+F5: Refresh records
                            event.preventDefault();
                            refreshRecords();
                        }
                        break;
                }
            }
        });

        // Security Helper Functions
        window.configureFirebaseSecurely = function(apiKey) {
            if (!apiKey) {
                console.log(`
ðŸ” SECURE FIREBASE CONFIGURATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

To configure Firebase securely, use one of these methods:

1. LOCALSTORAGE METHOD (Recommended for personal use):
   localStorage.setItem('firebase_api_key', 'YOUR_FIREBASE_API_KEY');

2. EXTERNAL CONFIG FILE:
   Edit firebase-secure-config.js with your API key

3. CONSOLE METHOD:
   configureFirebaseSecurely('YOUR_FIREBASE_API_KEY');

Current Status:
â€¢ Firebase: ${window.useFirebase ? 'Active' : 'Offline Mode'}
â€¢ Config: ${window.secureFirebaseConfig ? 'External' : 'Default'}
â€¢ API Key: ${firebaseConfig.apiKey ? 'Set' : 'Missing'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`);
                return;
            }
            
            localStorage.setItem('firebase_api_key', apiKey);
            console.log('âœ… Firebase API key configured securely!');
            console.log('ðŸ’¡ Reload the page to apply changes.');
        };

        // Add security info to console
        console.log('ðŸ” Security: API keys are now protected from public exposure');
        console.log('ðŸ’¡ Run configureFirebaseSecurely() in console for setup help');

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional attendance tracking system with GPS location verification and penalties management - v3.0 Production Ready">
    <meta name="keywords" content="attendance tracker, GPS location, student management, penalties system">
    <meta name="author" content="Attendance Management System v3.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#2c3e50">
    <!-- Force GitHub Pages Deployment v3.0 - 2025-09-04 -->
    <title>Class Attendance System - School Management</title>
    
    <!-- Critical Error Prevention -->
    <script>
        // Early error suppression before any other scripts load
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('listener indicated an asynchronous response')) {
                e.preventDefault();
                return true;
            }
        });
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.message && 
                e.reason.message.includes('listener indicated an asynchronous response')) {
                e.preventDefault();
            }
        });
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Suppress Chrome Extension Errors -->
    <script>
        // Comprehensive Chrome extension error suppression for production
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message) {
                const errorMessage = event.reason.message.toLowerCase();
                // Suppress various Chrome extension related errors
                if (errorMessage.includes('message channel closed') ||
                    errorMessage.includes('listener indicated an asynchronous response') ||
                    errorMessage.includes('extension') ||
                    errorMessage.includes('chrome-extension://') ||
                    errorMessage.includes('message port closed')) {
                    event.preventDefault(); // Silent suppression for production
                }
            }
        });

        // Also catch general errors that might be extension-related
        window.addEventListener('error', function(event) {
            if (event.error && event.error.message) {
                const errorMessage = event.error.message.toLowerCase();
                if (errorMessage.includes('listener indicated an asynchronous response') ||
                    errorMessage.includes('message channel closed') ||
                    errorMessage.includes('extension')) {
                    event.preventDefault();
                    return true; // Prevent default error handling
                }
            }
        });

        // Suppress console errors for extension-related issues
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ').toLowerCase();
            if (message.includes('listener indicated an asynchronous response') ||
                message.includes('message channel closed') ||
                message.includes('extension')) {
                return; // Don't log extension errors
            }
            originalConsoleError.apply(console, args);
        };
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, orderBy, query, updateDoc, where, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCB2BR1uIJLXH_tw-AJatC5f9tVrMhhHio",
            authDomain: "smstt-c0a67.firebaseapp.com",
            projectId: "smstt-c0a67",
            storageBucket: "smstt-c0a67.firebasestorage.app",
            messagingSenderId: "6657651110",
            appId: "1:6657651110:web:78567936db83da39025f67",
            measurementId: "G-3H3TQEQFH9"
        };

        // Initialize Firebase with error handling
        let app, db, analytics;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            analytics = getAnalytics(app);
            
            console.log("ðŸ”¥ Firebase initialized successfully!");
            // Enable Firebase mode since initialization was successful
            window.useFirebase = true;
        } catch (firebaseInitError) {
            console.error("ðŸ”¥ Firebase initialization failed:", firebaseInitError);
            // Disable Firebase if initialization fails
            window.useFirebase = false;
        }

        // Make Firebase functions available globally (similar to index-clean.html structure)
        if (app && db) {
            window.firebaseDB = db;
            window.firebaseApp = app;
            window.firebaseAnalytics = analytics;
            
            // Also make functions available globally like in index-clean.html
            window.firebase = {
                db,
                collection,
                addDoc,
                getDocs,
                deleteDoc,
                doc,
                onSnapshot,
                orderBy,
                query,
                updateDoc,
                where,
                limit
            };
            
            // Update Firebase status in the UI
            console.log("ðŸ”¥ Firebase is ready, updating UI...");
        
            // Firebase Firestore helper functions
            window.FirebaseHelper = {
                // Collection names
                COLLECTIONS: {
                    ATTENDANCE: 'attendance',
                    STUDENTS: 'students',
                    SETTINGS: 'app_settings'
                },

            // Add a new attendance record
            async addAttendanceRecord(recordData) {
                try {
                    const docRef = await addDoc(collection(db, this.COLLECTIONS.ATTENDANCE), {
                        ...recordData,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    console.log("Document written with ID: ", docRef.id);
                    return { success: true, id: docRef.id };
                } catch (error) {
                    console.error("Error adding document: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Get all attendance records
            async getAttendanceRecords() {
                try {
                    const querySnapshot = await getDocs(
                        query(collection(db, this.COLLECTIONS.ATTENDANCE), orderBy("date", "desc"))
                    );
                    const records = [];
                    querySnapshot.forEach((doc) => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    return { success: true, data: records };
                } catch (error) {
                    console.error("Error getting documents: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Get attendance records by student
            async getAttendanceByStudent(studentId) {
                try {
                    const q = query(
                        collection(db, this.COLLECTIONS.ATTENDANCE), 
                        where("studentId", "==", studentId),
                        orderBy("date", "desc")
                    );
                    const querySnapshot = await getDocs(q);
                    const records = [];
                    querySnapshot.forEach((doc) => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    return { success: true, data: records };
                } catch (error) {
                    console.error("Error getting student records: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Get attendance records by date range
            async getAttendanceByDateRange(startDate, endDate) {
                try {
                    const q = query(
                        collection(db, this.COLLECTIONS.ATTENDANCE),
                        where("date", ">=", startDate),
                        where("date", "<=", endDate),
                        orderBy("date", "desc")
                    );
                    const querySnapshot = await getDocs(q);
                    const records = [];
                    querySnapshot.forEach((doc) => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    return { success: true, data: records };
                } catch (error) {
                    console.error("Error getting date range records: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Update an attendance record
            async updateAttendanceRecord(recordId, updateData) {
                try {
                    const recordRef = doc(db, this.COLLECTIONS.ATTENDANCE, recordId);
                    await updateDoc(recordRef, {
                        ...updateData,
                        updatedAt: new Date()
                    });
                    return { success: true };
                } catch (error) {
                    console.error("Error updating document: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Delete an attendance record
            async deleteAttendanceRecord(recordId) {
                try {
                    console.log("ðŸ”¥ FirebaseHelper.deleteAttendanceRecord called with ID:", recordId);
                    console.log("ðŸ”¥ About to call deleteDoc with collection path:", this.COLLECTIONS.ATTENDANCE);
                    console.log("ðŸ”¥ Full document path:", `${this.COLLECTIONS.ATTENDANCE}/${recordId}`);
                    
                    const docRef = doc(db, this.COLLECTIONS.ATTENDANCE, recordId);
                    console.log("ðŸ”¥ Document reference created:", docRef);
                    
                    await deleteDoc(docRef);
                    console.log("ðŸ”¥ deleteDoc completed successfully for ID:", recordId);
                    
                    return { success: true };
                } catch (error) {
                    console.error("ðŸ”¥ Error deleting document: ", error);
                    console.error("ðŸ”¥ Error code:", error.code);
                    console.error("ðŸ”¥ Error message:", error.message);
                    return { success: false, error: error.message };
                }
            },

            // Add or update student
            async saveStudent(studentData) {
                try {
                    const docRef = await addDoc(collection(db, this.COLLECTIONS.STUDENTS), {
                        ...studentData,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    return { success: true, id: docRef.id };
                } catch (error) {
                    console.error("Error saving student: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Get all students
            async getStudents() {
                try {
                    const querySnapshot = await getDocs(collection(db, this.COLLECTIONS.STUDENTS));
                    const students = [];
                    querySnapshot.forEach((doc) => {
                        students.push({ id: doc.id, ...doc.data() });
                    });
                    return { success: true, data: students };
                } catch (error) {
                    console.error("Error getting students: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Sync local data to Firebase
            async syncLocalToFirebase(localData) {
                try {
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const record of localData) {
                        const result = await this.addAttendanceRecord(record);
                        if (result.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    }
                    
                    return { 
                        success: true, 
                        syncedCount: successCount, 
                        errorCount: errorCount 
                    };
                } catch (error) {
                    console.error("Error syncing data: ", error);
                    return { success: false, error: error.message };
                }
            },

            // Get real-time updates (optional)
            onAttendanceUpdates(callback) {
                const unsubscribe = onSnapshot(
                    query(collection(db, this.COLLECTIONS.ATTENDANCE), orderBy("date", "desc")),
                    (querySnapshot) => {
                        const records = [];
                        querySnapshot.forEach((doc) => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        callback(records);
                    }
                );
                return unsubscribe; // Call this function to stop listening
            }
        };
        
        } // End of if (app && db) block

        // Additional safety check
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ”¥ DOM loaded, Firebase status:', {
                firebaseApp: !!window.firebaseApp,
                firebaseDB: !!window.firebaseDB,
                FirebaseHelper: !!window.FirebaseHelper
            });
        });
    </script>
    
    <style>
        /* CSS Variables for Theme Support */
        :root {
            /* Light Theme */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #2c3e50;
            --text-accent: #3498db;
            --border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --input-border: #ddd;
            --button-primary: #3498db;
            --button-success: #27ae60;
            --button-danger: #e74c3c;
            --button-warning: #f39c12;
            --button-info: #17a2b8;
            --table-header: #f8f9fa;
            --table-border: #dee2e6;
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-secondary: rgba(30, 30, 30, 0.95);
            --bg-card: #2c3e50;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-accent: #3498db;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --input-bg: #34495e;
            --input-border: #4a5f7a;
            --button-primary: #3498db;
            --button-success: #27ae60;
            --button-danger: #e74c3c;
            --button-warning: #f39c12;
            --button-info: #17a2b8;
            --table-header: #34495e;
            --table-border: #4a5f7a;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .theme-toggle:active {
            transform: translateY(0);
        }

        .theme-toggle i {
            transition: transform 0.3s ease;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-content h1 {
            margin: 0;
            flex: 1;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Screen Reader Only - Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--text-secondary);
            font-size: 2.5rem;
            text-align: center;
            font-weight: 700;
        }

        .header h1 i {
            color: var(--text-accent);
            margin-right: 15px;
        }

        .current-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .info-item i {
            color: var(--text-accent);
            font-size: 1.2rem;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        /* Form Card */
        .form-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .form-card h2 {
            color: var(--text-secondary);
            font-size: 1.8rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-card h2 i {
            color: var(--button-success);
        }

        /* Form Styles */
        .attendance-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.half {
            flex: 1;
        }

        .location-group {
            display: flex;
            gap: 20px;
        }

        .form-group label {
            font-weight: 600;
            color: #34495e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label i {
            color: #3498db;
            width: 16px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group input[readonly] {
            background: var(--table-header);
            color: var(--text-secondary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Form Help Text */
        .form-help {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            opacity: 0.8;
            line-height: 1.4;
        }

        /* Attendance Buttons */
        .attendance-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .attendance-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .attendance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .attendance-btn.selected {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: pulseSelected 0.6s ease;
        }

        @keyframes pulseSelected {
            0% { transform: translateY(-1px) scale(1); }
            50% { transform: translateY(-1px) scale(1.05); }
            100% { transform: translateY(-1px) scale(1); }
        }

        .present-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .present-btn:hover {
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }

        .present-btn.selected {
            background: linear-gradient(135deg, #1e8449, #27ae60);
        }

        .absent-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .absent-btn:hover {
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .absent-btn.selected {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }

        /* Confirmation Modal */
        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .confirmation-modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .confirmation-header {
            background: var(--button-primary);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }

        .confirmation-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .confirmation-header i {
            margin-right: 8px;
        }

        .confirmation-body {
            padding: 25px;
            text-align: center;
            color: var(--text-primary);
        }

        .confirmation-body p {
            margin: 0;
            font-size: 1rem;
            line-height: 1.5;
        }

        .confirmation-actions {
            padding: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid var(--border-color);
        }

        .confirm-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .confirm-btn.cancel-btn {
            background: #6c757d;
            color: white;
        }

        .confirm-btn.cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .confirm-btn.confirm-btn-yes {
            background: var(--button-success);
            color: white;
        }

        .confirm-btn.confirm-btn-yes:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        /* Fraud Protection Status */
        .fraud-protection-status {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .fraud-protection-status .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: #495057;
        }

        .fraud-protection-status .status-header i {
            margin-right: 8px;
            color: #007bff;
        }

        .fraud-protection-status .toggle-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .fraud-protection-status .toggle-btn:hover {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .fraud-protection-status .status-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #6c757d;
        }

        /* Student Management Styles */
        .student-selection-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .student-selection-container select {
            flex: 1;
        }

        .manage-students-btn {
            background: var(--button-info);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 45px;
            height: 45px;
        }

        .manage-students-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .student-management-panel {
            background: var(--bg-card);
            border: 2px solid var(--input-border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.3s ease;
            position: relative;
            z-index: 100;
            min-height: 200px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding: 0 20px;
            }
            to {
                opacity: 1;
                max-height: 500px;
                padding: 20px;
            }
        }

        .student-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--input-border);
        }

        .student-management-header h4 {
            color: var(--text-secondary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-panel-btn {
            background: var(--button-danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-panel-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .add-student-section {
            margin-bottom: 25px;
        }

        .add-student-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .add-student-form .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .add-student-form input {
            padding: 10px 12px;
            border: 2px solid var(--input-border);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
            flex: 1;
            min-width: 200px;
        }

        .add-student-form input:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .add-student-btn {
            background: var(--button-success);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-student-btn:hover {
            background: #27ae60;
            transform: translateY(-1px);
        }

        .add-student-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .current-students-section h5 {
            color: var(--text-secondary);
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .students-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .students-section-header h5 {
            margin: 0;
        }

        .restore-default-btn {
            background: var(--button-warning);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .restore-default-btn:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }

        .students-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--input-border);
            transition: background-color 0.3s ease;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-item:hover {
            background: var(--table-header);
        }

        .student-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .student-key {
            font-size: 0.8rem;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            opacity: 0.8;
        }

        .remove-student-btn {
            background: var(--button-danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .remove-student-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .no-students-message {
            text-align: center;
            padding: 20px;
            color: var(--text-primary);
            font-style: italic;
            opacity: 0.7;
        }

        /* Action Buttons */
        .actions-section {
            margin: 20px 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--button-primary), #2980b9);
        }

        .action-btn.success {
            background: linear-gradient(135deg, var(--button-success), #2ecc71);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, var(--button-danger), #c0392b);
        }

        .action-btn.warning {
            background: linear-gradient(135deg, var(--button-warning), #e67e22);
        }

        .action-btn.info {
            background: linear-gradient(135deg, var(--button-info), #8e44ad);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .action-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Records Section */
        .records-section {
            margin-top: 30px;
        }

        .records-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .records-card h2 {
            color: var(--text-secondary);
            font-size: 1.8rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-color);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            align-items: start;
        }

        .filter-group {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .filter-group label i {
            color: var(--primary-color);
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 6px 10px;
            height: 32px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .date-range-inputs {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            width: 100%;
        }

        .date-range-inputs input {
            width: 100%;
        }

        .date-separator {
            display: none;
        }

        /* Ensure date inputs don't overlap */
        .filter-group.date-range {
            grid-row: span 2;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.1);
            outline: none;
        }

        .filter-group input:hover,
        .filter-group select:hover {
            border-color: var(--primary-color);
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 500;
            min-height: 42px;
            line-height: 1.4;
        }

        /* Enhanced dropdown options styling */
        .filter-group select option {
            font-size: 1.1rem;
            font-weight: 500;
            padding: 8px 12px;
            line-height: 1.5;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .filter-group select:focus {
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        .filter-btn {
            background: linear-gradient(135deg, var(--button-primary), #2980b9);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 42px;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .records-table th {
            background: linear-gradient(135deg, var(--text-secondary), var(--text-secondary));
            color: white;
            padding: 15px 25px 15px 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
            white-space: nowrap;
        }

        .records-table th:hover {
            background: linear-gradient(135deg, var(--text-secondary-hover, #34495e), var(--text-secondary-hover, #2c3e50));
        }

        .records-table th::after {
            content: 'â‡•';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            font-size: 0.8em;
        }

        .records-table th.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
            color: #2ecc71;
        }

        .records-table th.sort-desc::after {
            content: 'â†“';
            opacity: 1;
            color: #e74c3c;
            font-size: 0.9rem;
        }

        .records-table td {
            padding: 12px;
            border-bottom: 1px solid var(--table-border);
            font-size: 0.9rem;
            color: var(--text-primary);
            background: var(--bg-card);
        }

        .records-table tbody tr:hover {
            background: var(--table-header);
        }

        .records-table tbody tr:nth-child(even) {
            background: var(--table-header);
        }

        /* Action buttons in table */
        .table-action-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .table-action-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        /* Statistics */
        .statistics-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
        }

        .statistics-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .stat-card.red {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Analytics Dashboard */
        .analytics-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .analytics-header h3 {
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .analytics-header h3 i {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
        }

        .analytics-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .analytics-filter {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .analytics-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .analytics-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .analytics-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .analytics-card h4 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .analytics-card h4 i {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5rem;
        }

        .analytics-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .analytics-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            color: #2c3e50;
            transition: all 0.2s ease;
        }

        .analytics-list li:hover {
            background: rgba(102, 126, 234, 0.05);
            padding-left: 10px;
            border-radius: 8px;
        }

        .analytics-list li:last-child {
            border-bottom: none;
        }

        .analytics-metric {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .analytics-percentage {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .percentage-high {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
        }

        .percentage-medium {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .percentage-low {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .analytics-chart {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            margin-top: 15px;
            position: relative;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }

        .analytics-empty {
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            padding: 20px;
            font-size: 1.1rem;
        }

        .date-analytics {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .date-analytics h4 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .date-analytics h4 i {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .absence-timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 350px;
            overflow-y: auto;
        }

        .timeline-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.1));
            border-radius: 12px;
            border-left: 4px solid #e74c3c;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.2);
        }

        .timeline-date {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .timeline-count {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }

        .individual-stats {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .individual-stats h4 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .student-detail {
            padding: 15px 20px;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .student-detail:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .student-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .absence-badge {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }

        .refresh-analytics {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }

        .refresh-analytics:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .refresh-analytics i {
            animation: spin 2s linear infinite;
        }

        .export-pdf-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .export-pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
            background: linear-gradient(45deg, #c0392b, #a93226);
        }

        .export-pdf-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .export-pdf-btn i {
            font-size: 1.1em;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Student stat item styling */
        .student-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 10px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .student-stat-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-stat-item.excellent {
            border-left-color: #2ecc71;
        }

        .student-stat-item.good {
            border-left-color: #3498db;
        }

        .student-stat-item.average {
            border-left-color: #f39c12;
        }

        .student-stat-item.poor {
            border-left-color: #e74c3c;
        }

        .stat-details {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* Penalties Section */
        .penalties-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
            display: none;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .penalties-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .penalties-header h3 {
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .penalties-header h3 i {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
        }

        .penalties-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .penalties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .penalties-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .penalties-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .penalties-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .penalties-card h4 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .penalties-card h4 i {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .penalties-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .penalties-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 10px 0;
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.05));
            border-radius: 12px;
            border-left: 4px solid #e74c3c;
            transition: all 0.3s ease;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .penalties-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.2);
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.15), rgba(192, 57, 43, 0.1));
        }

        .penalty-student-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .penalty-amount {
            font-weight: 700;
            color: #e74c3c;
            font-size: 1.2rem;
            background: rgba(231, 76, 60, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid rgba(231, 76, 60, 0.3);
        }

        .penalty-details {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .penalty-summary {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            grid-column: 1 / -1;
        }

        .penalty-summary h4 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .penalty-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .penalty-stat {
            text-align: center;
            padding: 15px;
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .penalty-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #e74c3c;
            display: block;
            margin-bottom: 5px;
        }

        .penalty-stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 600;
        }

        .penalties-empty {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px;
            background: rgba(127, 140, 141, 0.1);
            border-radius: 12px;
            border: 2px dashed rgba(127, 140, 141, 0.3);
        }

        .penalties-filter {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .penalties-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .penalties-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .penalty-action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .penalty-export-pdf-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .penalty-export-pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .penalty-clear-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            color: white;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }

        .penalty-clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
        }

        .penalty-refresh-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .penalty-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        /* Location Section */
        .location-section {
            margin-top: 30px;
        }

        .location-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .location-card h3 {
            color: var(--text-secondary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: var(--input-border);
            color: var(--primary-color);
        }

        .location-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .location-details strong {
            color: var(--text-secondary);
        }

        .location-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--table-header);
            border-radius: 8px;
            border-left: 4px solid var(--text-accent);
            color: var(--text-primary);
            margin-bottom: 8px;
            position: relative;
            flex-wrap: wrap;
            gap: 8px;
        }

        .location-item:hover {
            background: var(--card-hover, var(--background-secondary));
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .location-label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 120px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .location-label i {
            color: var(--text-accent);
            width: 16px;
        }

        .location-value, .accuracy-value, .timestamp-value, .updates-count {
            font-family: 'Courier New', monospace;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--background-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .address-value {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            color: var(--text-primary);
            background: var(--background-secondary);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            line-height: 1.4;
            max-width: 100%;
            word-wrap: break-word;
            position: relative;
        }

        .address-value:hover {
            background: var(--primary-color-light);
            border-color: var(--primary-color);
            transition: all 0.2s ease;
        }

        .address-container {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            flex-wrap: wrap;
        }

        .address-actions {
            display: flex;
            gap: 4px;
            margin-top: 2px;
        }

        .address-btn {
            padding: 2px 6px;
            font-size: 11px;
            border: 1px solid var(--border-color);
            background: var(--background-primary);
            color: var(--text-secondary);
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .address-btn:hover {
            background: var(--primary-color);
            color: white;
            text-decoration: none;
        }

        .address-btn i {
            margin-right: 2px;
        }

        .coordinates-summary {
            background: var(--background-primary);
            border: 2px solid var(--text-accent);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .coordinates-display {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .coordinates-text {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: var(--background-secondary);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            flex-grow: 1;
            min-width: 200px;
        }

        .copy-btn {
            background: var(--text-accent);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .copy-btn:hover {
            background: var(--primary-dark, #2c3e50);
            transform: scale(1.05);
        }

        .copy-btn.primary {
            background: var(--primary-color);
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .copy-btn.primary:hover {
            background: var(--primary-dark, #27ae60);
        }

        .help-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .help-btn:hover {
            background: var(--warning-dark, #e67e22);
            transform: scale(1.1);
        }

        .accuracy-icon, .quality-icon {
            margin-left: 5px;
            font-size: 1.1rem;
        }

        .accuracy-help {
            width: 100%;
            margin-top: 4px;
        }

        .accuracy-help small {
            color: var(--text-secondary);
            font-style: italic;
        }

        .altitude-accuracy, .speed-unit, .compass-direction, .time-ago, .update-rate {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-left: 5px;
        }

        .map-options {
            display: flex;
            gap: 8px;
            margin-left: 10px;
        }

        .map-option {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-accent);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .map-option:hover {
            background: var(--text-accent);
            color: white;
            transform: scale(1.1);
        }

        .map-link {
            color: var(--text-accent);
            text-decoration: none;
            font-weight: 500;
        }

        .map-link:hover {
            text-decoration: underline;
        }

        .permission-status.granted {
            color: var(--success-color);
            font-weight: 600;
        }

        .permission-status.denied {
            color: var(--error-color);
            font-weight: 600;
        }

        .permission-status.prompt {
            color: var(--warning-color);
            font-weight: 600;
        }

        .quality-indicator.excellent {
            color: var(--success-color);
            font-weight: 600;
        }

        .quality-indicator.good {
            color: var(--primary-color);
            font-weight: 600;
        }

        .quality-indicator.fair {
            color: var(--warning-color);
            font-weight: 600;
        }

        .quality-indicator.poor {
            color: var(--error-color);
            font-weight: 600;
        }

        .quality-indicator.indoor {
            color: #9b59b6;
            font-weight: 600;
        }

        /* Location Controls */
        .location-controls-section {
            margin-top: 20px;
        }

        .location-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            padding: 12px;
            background: var(--table-header);
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .control-group label:hover {
            background: var(--input-border);
        }

        .control-group label input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .control-group label span {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .control-group label small {
            color: var(--text-primary);
            font-size: 0.85rem;
            margin-top: 2px;
        }

        .location-status-bar {
            padding: 15px;
            background: var(--table-header);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .location-tips {
            margin-top: 10px;
            padding: 15px;
            background: var(--background-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--warning-color);
        }

        .location-tips small {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .location-recommendation {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
        }

        .location-recommendation.excellent {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
            color: white;
        }

        .location-recommendation.good {
            background: linear-gradient(135deg, var(--primary-color), #3498db);
            color: white;
        }

        .location-recommendation.fair {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
        }

        .location-recommendation.poor {
            background: linear-gradient(135deg, var(--error-color), #c0392b);
            color: white;
        }

        .recommendation-content {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .recommendation-content i {
            font-size: 1.2rem;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-indicator i {
            transition: color 0.3s ease;
        }

        .status-indicator.active i {
            color: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-indicator.error i {
            color: #e74c3c;
        }

        .status-indicator.warning i {
            color: #f39c12;
        }

        .status-indicator.info i {
            color: #3498db;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Quality Indicators */
        .quality-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .quality-indicator.excellent {
            background: #d4edda;
            color: #155724;
        }

        .quality-indicator.good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .quality-indicator.fair {
            background: #fff3cd;
            color: #856404;
        }

        .quality-indicator.poor {
            background: #f8d7da;
            color: #721c24;
        }

        /* Permission Status */
        .permission-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .permission-status.granted {
            background: #d4edda;
            color: #155724;
        }

        .permission-status.denied {
            background: #f8d7da;
            color: #721c24;
        }

        .permission-status.prompt {
            background: #fff3cd;
            color: #856404;
        }

        /* Enhanced location item styling */
        .location-item a {
            text-decoration: none;
            font-weight: 500;
            color: var(--text-accent);
        }

        .location-item a:hover {
            text-decoration: underline;
        }

        /* Admin Modal Styles */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .admin-modal-content {
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: 0 20px 60px var(--shadow-color);
            max-width: 450px;
            width: 90%;
            animation: adminModalSlide 0.3s ease;
            border: 1px solid var(--border-color);
        }

        @keyframes adminModalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .admin-modal-header {
            padding: 25px 30px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-modal-header h3 {
            color: var(--text-secondary);
            margin: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-modal-header h3 i {
            color: var(--button-danger);
        }

        .admin-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .admin-modal-close:hover {
            background: var(--table-header);
            color: var(--button-danger);
        }

        .admin-modal-body {
            padding: 25px 30px;
        }

        .admin-modal-body p {
            color: var(--text-primary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .admin-form-group {
            margin-bottom: 20px;
        }

        .admin-form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .admin-form-group input:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .admin-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .admin-attempts {
            color: var(--button-warning);
            text-align: center;
            margin-top: 10px;
        }

        .admin-modal-footer {
            padding: 15px 30px 25px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            border-top: 1px solid var(--border-color);
        }

        .admin-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-btn-cancel {
            background: var(--text-primary);
            color: var(--bg-card);
        }

        .admin-btn-cancel:hover {
            background: var(--text-secondary);
            transform: translateY(-1px);
        }

        .admin-btn-confirm {
            background: var(--button-danger);
            color: white;
        }

        .admin-btn-confirm:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .admin-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Admin Lock Icons */
        .admin-lock-icon {
            font-size: 0.8rem;
            margin-left: 5px;
            opacity: 0.7;
        }

        .action-btn:hover .admin-lock-icon {
            opacity: 1;
        }

        /* Admin Mode Indicators */
        .admin-mode-active {
            position: relative;
        }

        .admin-mode-active::after {
            content: "ADMIN";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Messages */
        .message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .message {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            position: relative;
            transition: opacity 0.3s ease;
        }

        .message-close {
            background: none;
            border: none;
            color: inherit;
            opacity: 0.7;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease;
            margin-left: auto;
        }

        .message-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }

        .message.success {
            background: #2ecc71;
            color: white;
        }

        .message.error {
            background: #e74c3c;
            color: white;
        }

        .message.warning {
            background: #f39c12;
            color: white;
        }

        .message.info {
            background: #3498db;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            text-align: center;
            color: var(--text-primary);
        }

        .loading-spinner i {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .loading-spinner p {
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* Action Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.check-in {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.check-out {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.break-start,
        .status-badge.lunch-start {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.break-end,
        .status-badge.lunch-end {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.present {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.absent {
            background: #f8d7da;
            color: #721c24;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .current-info {
                flex-direction: column;
                gap: 10px;
            }

            .location-group {
                flex-direction: column;
                gap: 15px;
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .filters {
                flex-direction: column;
                gap: 10px;
            }

            .filter-group {
                min-width: auto;
            }

            .table-container {
                font-size: 0.8rem;
            }

            .records-table th,
            .records-table td {
                padding: 8px 6px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .location-details {
                grid-template-columns: 1fr;
            }

            .control-group {
                gap: 8px;
            }

            .control-group label {
                padding: 10px;
                font-size: 0.9rem;
            }

            .location-controls {
                gap: 15px;
            }

            /* Student Management Responsive */
            .student-selection-container {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .add-student-form {
                flex-direction: column;
                gap: 8px;
            }

            .add-student-form input {
                min-width: auto;
            }

            .students-section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .student-item {
                padding: 10px;
            }

            .student-info {
                gap: 2px;
            }

            .remove-student-btn {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .form-card,
            .records-card,
            .location-card {
                padding: 20px;
            }

            .message-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
        
        /* Collapsible Section Styles */
        .section-header {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            margin-bottom: 0;
        }
        
        .section-header:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }
        
        .dark-theme .section-header {
            background: #2d3748;
            border-color: #4a5568;
        }
        
        .dark-theme .section-header:hover {
            background: #4a5568;
        }
        
        .dark-theme .section-header h3 {
            color: #e2e8f0;
        }
        
        .toggle-icon {
            font-size: 16px;
            transition: transform 0.3s ease;
            color: #6c757d;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background: #fff;
        }
        
        .dark-theme .collapsible-content {
            background: #1a202c;
            border-color: #4a5568;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            border: none;
        }
        
        .collapsible-content.expanded {
            max-height: 2000px;
            opacity: 1;
        }
        
        /* Adjust existing sections to work with collapsible */
        .actions-section .action-buttons,
        .location-section .location-card,
        .location-controls-section .location-card {
            margin: 0;
            border: none;
            border-radius: 0;
            padding: 20px;
        }

        /* Email Modal Styles */
        .email-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(3px);
        }

        .email-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .email-modal-content.large {
            max-width: 1100px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .email-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid #f0f2f5;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .email-modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .email-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .email-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .email-report-form {
            padding: 30px;
        }

        .email-form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .email-form-section h4 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .email-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .email-form-row:last-child {
            margin-bottom: 0;
        }

        .email-form-group {
            display: flex;
            flex-direction: column;
        }

        .email-form-group.full-width {
            grid-column: 1 / -1;
        }

        .email-form-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }

        .email-form-group input,
        .email-form-group select,
        .email-form-group textarea {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .email-form-group input:focus,
        .email-form-group select:focus,
        .email-form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .email-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .email-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .email-checkbox-item:hover {
            background: #f0f2f5;
            border-color: #667eea;
        }

        .email-checkbox-item input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .email-checkbox-item span {
            font-size: 14px;
            color: #555;
        }

        .email-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding: 25px 30px;
            border-top: 2px solid #f0f2f5;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .email-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            min-width: 120px;
            justify-content: center;
        }

        .email-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .email-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .email-btn.preview {
            background: #17a2b8;
            color: white;
        }

        .email-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .email-preview-content {
            padding: 30px;
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-height: 60vh;
            overflow-y: auto;
        }

        .email-preview-content pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .email-modal-content {
                width: 98%;
                margin: 10px;
            }

            .email-form-row {
                grid-template-columns: 1fr;
            }

            .email-checkbox-grid {
                grid-template-columns: 1fr;
            }

            .email-form-actions {
                flex-direction: column;
                gap: 10px;
            }

            .email-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 ondblclick="secretAdminAccess()"><i class="fas fa-school"></i> Class Attendance System</h1>
                <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
            <div class="current-info">
                <div class="info-item">
                    <i class="fas fa-calendar"></i>
                    <span id="currentDate"></span>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime"></span>
                </div>
                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationStatus">Getting location...</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Attendance Form -->
            <section class="attendance-section">
                <div class="form-card">
                    <h2><i class="fas fa-user-check"></i> Record Attendance</h2>
                    
                    <form id="attendanceForm" class="attendance-form">
                        <!-- Student Selection -->
                        <div class="form-group">
                            <label for="student"><i class="fas fa-user"></i> Select Student:</label>
                            <div class="student-selection-container">
                                <select id="student" name="student" required 
                                        aria-describedby="student-help" 
                                        aria-label="Select student for attendance tracking">
                                    <option value="">-- Select Student --</option>
                                </select>
                                <button type="button" id="manageStudentsBtn" class="manage-students-btn" 
                                        title="Manage Students" 
                                        aria-label="Manage student list"
                                        aria-expanded="false"
                                        aria-controls="studentManagementPanel">
                                    <i class="fas fa-cog" aria-hidden="true"></i>
                                </button>
                            </div>
                            <small id="student-help" class="form-help">Select the student for attendance tracking</small>
                        </div>

                        <!-- Student Management Panel (Hidden by default) -->
                        <div id="studentManagementPanel" class="student-management-panel" style="display: none;">
                            <div class="student-management-header">
                                <h4><i class="fas fa-users-cog"></i> Manage Students</h4>
                                <button type="button" id="closeStudentPanel" class="close-panel-btn" onclick="closeStudentManagementPanel()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Add New Student -->
                            <div class="add-student-section">
                                <div class="add-student-form">
                                    <div class="form-row">
                                        <label for="newStudentId" class="sr-only">Student ID</label>
                                        <input type="text" id="newStudentId" placeholder="Student ID (optional - auto-generated if empty)" maxlength="20">
                                        <label for="newStudentName" class="sr-only">Student Full Name</label>
                                        <input type="text" id="newStudentName" placeholder="Student Full Name (e.g., John Smith)" maxlength="100">
                                    </div>
                                    <button type="button" id="addStudentBtn" class="add-student-btn" onclick="addNewStudent()">
                                        <i class="fas fa-plus"></i> Add Student
                                    </button>
                                </div>
                            </div>

                            <!-- Current Students List -->
                            <div class="current-students-section">
                                <div class="students-section-header">
                                    <h5><i class="fas fa-list"></i> Current Students</h5>
                                    <button type="button" id="restoreDefaultBtn" class="restore-default-btn" onclick="restoreDefaultStudents()" title="Restore Default Students">
                                        <i class="fas fa-undo"></i> Restore Defaults
                                    </button>
                                </div>
                                <div id="studentsList" class="students-list">
                                    <!-- Students will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Attendance Status -->
                        <div class="form-group">
                            <fieldset style="border: none; padding: 0; margin: 0;">
                                <legend style="font-weight: 600; color: #34495e; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="fas fa-user-check"></i> Mark Attendance:
                                </legend>
                                <div class="attendance-buttons">
                                    <button type="button" id="presentBtn" class="attendance-btn present-btn" tabindex="0">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Present</span>
                                    </button>
                                    <button type="button" id="absentBtn" class="attendance-btn absent-btn" tabindex="0">
                                        <i class="fas fa-times-circle"></i>
                                        <span>Absent</span>
                                    </button>
                                </div>
                                <input type="hidden" id="attendanceStatus" name="attendanceStatus" required>
                                <small id="attendance-help" class="form-help">Click Present or Absent to mark attendance</small>
                            </fieldset>
                        </div>

                        <!-- Date & Time (Editable) -->
                        <div class="form-group">
                            <label for="dateTime"><i class="fas fa-calendar-alt"></i> Date & Time: <small style="color: #3498db; font-weight: normal;">(Editable)</small></label>
                            <input type="datetime-local" id="dateTime" name="dateTime" 
                                   aria-describedby="datetime-help" 
                                   aria-label="Attendance date and time"
                                   title="Click to edit date and time for past lectures">
                            <small id="datetime-help" class="form-help">ðŸ“… Auto-set to current time, but you can edit to record past lectures or specific times</small>
                        </div>

                        <!-- Location Fields -->
                        <div class="location-group">
                            <div class="form-group half">
                                <label for="latitude"><i class="fas fa-globe"></i> Latitude:</label>
                                <input type="text" id="latitude" name="latitude" readonly>
                            </div>
                            <div class="form-group half">
                                <label for="longitude"><i class="fas fa-globe"></i> Longitude:</label>
                                <input type="text" id="longitude" name="longitude" readonly>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="form-group">
                            <label for="notes"><i class="fas fa-sticky-note"></i> Notes (Optional):</label>
                            <textarea id="notes" name="notes" rows="3" 
                                      placeholder="Add any additional notes..." 
                                      aria-describedby="notes-help" 
                                      aria-label="Optional notes for attendance record"
                                      maxlength="500"></textarea>
                            <small id="notes-help" class="form-help">Optional additional information (max 500 characters)</small>
                        </div>

                        <!-- Fraud Protection Status -->
                        <div class="fraud-protection-status" id="fraudProtectionStatus" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;">
                            <div class="status-header">
                                <i class="fas fa-shield-alt"></i>
                                <strong>Security Status</strong>
                                <button type="button" id="toggleFraudStatus" class="toggle-btn" onclick="toggleFraudProtectionDetails()" title="Show/Hide Details">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                            <div id="fraudStatusDetails" class="status-details" style="display: none; margin-top: 8px; font-size: 0.9em; color: #666;">
                                <div id="fraudStatusText">Checking security status...</div>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Action Buttons -->
            <section class="actions-section">
                <div class="section-header collapsible-header" onclick="toggleSection('actions-content')">
                    <h3><i class="fas fa-tools"></i> Actions & Reports</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="actions-content-icon"></i>
                </div>
                <div id="actions-content" class="collapsible-content collapsed">
                <div class="action-buttons">
                    <button id="viewRecordsBtn" class="action-btn primary">
                        <i class="fas fa-eye"></i> View Records
                    </button>
                    <button id="viewAnalyticsBtn" class="action-btn info">
                        <i class="fas fa-chart-line"></i> View Analytics
                    </button>
                    <button id="viewPenaltiesBtn" class="action-btn warning">
                        <i class="fas fa-exclamation-triangle"></i> View Penalties
                    </button>
                    <button id="downloadBtn" class="action-btn success">
                        <i class="fas fa-download"></i> Download Excel
                    </button>
                    <button id="clearBtn" class="action-btn danger" onclick="clearAllData()" style="display: none !important; visibility: hidden !important;">
                        <i class="fas fa-trash"></i> Clear Data
                    </button>
                </div>

                <!-- Firebase Cloud Sync Section -->
                <div class="firebase-section" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 style="margin: 0 0 15px 0; color: white; font-size: 18px;">
                        <i class="fas fa-cloud"></i> Firebase Cloud Sync
                    </h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
                        <button id="toggleFirebaseBtn" class="action-btn" style="background: #4CAF50; color: white;" onclick="toggleFirebaseMode()">
                            <i class="fas fa-toggle-on"></i> <span id="firebaseStatusText">Enable Cloud Sync</span>
                        </button>
                        <button id="syncNowBtn" class="action-btn" style="background: #2196F3; color: white;" onclick="syncWithFirebase()">
                            <i class="fas fa-sync"></i> Sync Now
                        </button>
                        <button class="action-btn" style="background: #FF9800; color: white;" onclick="showFirebaseStatus()">
                            <i class="fas fa-info-circle"></i> Status
                        </button>
                    </div>
                    <div id="firebaseStatusInfo" style="font-size: 12px; color: #e8f4fd; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px;">
                        <div>ðŸ”— Status: <span id="connectionStatus">Checking...</span></div>
                        <div>Sync Queue: <span id="syncQueueCount">0</span> pending</div>
                        <div>Mode: <span id="currentMode">Local Only</span></div>
                    </div>
                </div>
                
                <!-- Email Reporting Section -->
                <div class="email-report-section" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">
                        <i class="fas fa-envelope"></i> Email Reports
                    </h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button id="openEmailFormBtn" class="action-btn primary" style="white-space: nowrap;" onclick="testEmailForm()">
                            <i class="fas fa-envelope-open"></i> Create Email Report
                        </button>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
                        Generate professional attendance reports for managers and administrators.
                    </p>
                </div>
                </div>
            </section>

            <!-- Records Display -->
            <section id="recordsSection" class="records-section" style="display: none;">
                <div class="records-card">
                    <h2><i class="fas fa-list"></i> Attendance Records</h2>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <div class="filter-group">
                            <label for="dateFilterType"><i class="fas fa-calendar"></i> Filter By:</label>
                            <select id="dateFilterType" class="compact-select">
                                <option value="single">Single Day</option>
                                <option value="range">Date Range</option>
                            </select>
                        </div>
                        
                        <div class="filter-group" id="singleDateFilter">
                            <label for="filterDate"><i class="fas fa-calendar-day"></i> Select Date:</label>
                            <input type="date" id="filterDate" class="compact-input">
                        </div>

                        <div class="filter-group" id="dateRangeFilter" style="display: none;">
                            <label for="filterDateStart"><i class="fas fa-calendar-week"></i> Period:</label>
                            <div class="date-range-inputs">
                                <label for="filterDateStart" class="sr-only">Start Date</label>
                                <input type="date" id="filterDateStart" class="compact-input" title="Start Date">
                                <span class="date-separator">â†’</span>
                                <label for="filterDateEnd" class="sr-only">End Date</label>
                                <input type="date" id="filterDateEnd" class="compact-input" title="End Date">
                            </div>
                        </div>

                        <div class="filter-group">
                            <label for="filterEmployee"><i class="fas fa-user"></i> Student:</label>
                            <select id="filterEmployee" class="compact-select">
                                <option value="">All Students</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterAction"><i class="fas fa-filter"></i> Status:</label>
                            <select id="filterAction">
                                <option value="">All Status</option>
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                            </select>
                        </div>
                        <button id="applyFilters" class="filter-btn" onclick="applyFilters()">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <button id="clearFilters" class="filter-btn" onclick="clearFilters()" style="background-color: #95a5a6; margin-left: 5px;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button id="exportPdf" class="filter-btn" onclick="exportFilteredRecordsToPdf()" style="background-color: #e74c3c; margin-left: 10px;">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>

                    <!-- Records Table -->
                    <div class="table-container">
                        <table id="recordsTable" class="records-table">
                            <thead>
                                <tr>
                                    <th data-column="id">ID</th>
                                    <th data-column="student">Student</th>
                                    <th data-column="action">Action</th>
                                    <th data-column="date">Date</th>
                                    <th data-column="time">Time</th>
                                    <th data-column="location">Location</th>
                                    <th data-column="notes">Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody">
                                <!-- Records will be inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Statistics -->
                    <div id="statisticsSection" class="statistics-section">
                        <h3><i class="fas fa-chart-pie"></i> Today's Statistics</h3>
                        <div class="stats-grid" id="statsGrid">
                            <!-- Stats will be inserted here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Dashboard -->
            <section id="analyticsSection" class="analytics-section">
                <div class="analytics-header">
                    <h3><i class="fas fa-chart-line"></i> Analytics Dashboard</h3>
                    <div class="analytics-controls">
                        <select id="analyticsFilter" class="analytics-filter">
                            <option value="all">All Time</option>
                            <option value="last7days">Last 7 Days</option>
                            <option value="last30days">Last 30 Days</option>
                            <option value="thismonth">This Month</option>
                            <option value="lastmonth">Last Month</option>
                        </select>
                        <button class="refresh-analytics" onclick="generateAnalytics()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button id="exportAnalyticsPdfBtn" class="export-pdf-btn" onclick="exportAnalyticsToPDF()">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>
                </div>

                <div class="analytics-grid">
                    <!-- Highest Attendance Rate -->
                    <div class="analytics-card">
                        <h4><i class="fas fa-trophy"></i> Highest Attendance Rate</h4>
                        <ul id="highestAttendanceList" class="analytics-list">
                            <li class="analytics-empty">No data available</li>
                        </ul>
                    </div>

                    <!-- Lowest Attendance Rate -->
                    <div class="analytics-card">
                        <h4><i class="fas fa-exclamation-triangle"></i> Lowest Attendance Rate</h4>
                        <ul id="lowestAttendanceList" class="analytics-list">
                            <li class="analytics-empty">No data available</li>
                        </ul>
                    </div>

                    <!-- Individual Absence Count -->
                    <div class="analytics-card">
                        <h4><i class="fas fa-user-times"></i> Individual Absence Count</h4>
                        <ul id="individualAbsenceList" class="analytics-list">
                            <li class="analytics-empty">No data available</li>
                        </ul>
                    </div>
                </div>

                <!-- Dates with Highest Absences -->
                <div class="date-analytics">
                    <h4><i class="fas fa-calendar-times"></i> Dates with Highest Absences</h4>
                    <div id="absenceTimeline" class="absence-timeline">
                        <div class="analytics-empty">No absence data available</div>
                    </div>
                </div>

                <!-- Detailed Student Statistics -->
                <div class="individual-stats">
                    <h4><i class="fas fa-users"></i> Detailed Student Statistics</h4>
                    <div id="detailedStudentStats" class="analytics-chart">
                        <div class="analytics-empty">No detailed statistics available</div>
                    </div>
                </div>
            </section>

            <!-- Penalties Section -->
            <section id="penaltiesSection" class="penalties-section">
                <div class="penalties-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Late Arrival Penalties</h3>
                    <div class="penalties-controls">
                        <select id="penaltiesFilter" class="penalties-filter">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="last7days">Last 7 Days</option>
                            <option value="last30days">Last 30 Days</option>
                            <option value="thismonth">This Month</option>
                            <option value="lastmonth">Last Month</option>
                        </select>
                        <div class="penalties-actions">
                            <button class="penalty-action-btn penalty-refresh-btn" onclick="generatePenalties()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button id="exportPenaltiesPdfBtn" class="penalty-action-btn penalty-export-pdf-btn" onclick="exportPenaltiesToPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button class="penalty-action-btn penalty-clear-btn" onclick="clearPenaltyData()">
                                <i class="fas fa-trash"></i> Clear Penalties
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Penalty Summary -->
                <div class="penalty-summary">
                    <h4><i class="fas fa-calculator"></i> Penalty Summary</h4>
                    <div class="penalty-summary-grid">
                        <div class="penalty-stat">
                            <span id="totalPenaltyAmount" class="penalty-stat-value">0 AED</span>
                            <span class="penalty-stat-label">Total Penalties</span>
                        </div>
                        <div class="penalty-stat">
                            <span id="totalLateArrivals" class="penalty-stat-value">0</span>
                            <span class="penalty-stat-label">Late Arrivals</span>
                        </div>
                        <div class="penalty-stat">
                            <span id="studentsWithPenalties" class="penalty-stat-value">0</span>
                            <span class="penalty-stat-label">Students with Penalties</span>
                        </div>
                        <div class="penalty-stat">
                            <span id="averagePenaltyPerStudent" class="penalty-stat-value">0 AED</span>
                            <span class="penalty-stat-label">Average per Student</span>
                        </div>
                    </div>
                </div>

                <div class="penalties-grid">
                    <!-- Student Penalties -->
                    <div class="penalties-card">
                        <h4><i class="fas fa-user-times"></i> Student Penalties</h4>
                        <ul id="studentPenaltiesList" class="penalties-list">
                            <li class="penalties-empty">No penalties recorded</li>
                        </ul>
                    </div>

                    <!-- Recent Late Arrivals -->
                    <div class="penalties-card">
                        <h4><i class="fas fa-clock"></i> Recent Late Arrivals</h4>
                        <ul id="recentLateArrivalsList" class="penalties-list">
                            <li class="penalties-empty">No late arrivals recorded</li>
                        </ul>
                    </div>
                </div>

                <!-- Penalty Details -->
                <div class="penalties-card" style="margin-top: 25px;">
                    <h4><i class="fas fa-list-ul"></i> Detailed Penalty Log</h4>
                    <div id="penaltyDetailsContainer">
                        <div class="penalties-empty">No penalty details available</div>
                    </div>
                </div>
            </section>

            <!-- Location Info -->
            <section class="location-section">
                <div class="section-header collapsible-header" onclick="toggleSection('location-content')">
                    <h3><i class="fas fa-map-marker-alt"></i> Current Location</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="location-content-icon"></i>
                </div>
                <div id="location-content" class="collapsible-content collapsed">
                <div class="location-card">
                    <h3><i class="fas fa-map-marker-alt"></i> Current Location</h3>
                    <div class="location-details">
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-map-marker-alt"></i> Latitude:</span>
                            <span id="displayLatitude" class="location-value">--</span>Â°
                            <button class="copy-btn" onclick="copyToClipboard(document.getElementById('displayLatitude').textContent)" title="Copy latitude">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-map-marker-alt"></i> Longitude:</span>
                            <span id="displayLongitude" class="location-value">--</span>Â°
                            <button class="copy-btn" onclick="copyToClipboard(document.getElementById('displayLongitude').textContent)" title="Copy longitude">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-crosshairs"></i> Accuracy:</span>
                            <span id="locationAccuracy" class="accuracy-value">--</span>m
                            <span id="accuracyIcon" class="accuracy-icon"></span>
                            <div id="accuracyHelp" class="accuracy-help">
                                <small id="accuracyDescription">Waiting for GPS...</small>
                            </div>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-map-marked-alt"></i> Address:</span>
                            <div class="address-container">
                                <span id="locationAddress" class="address-value">Getting address...</span>
                                <div class="address-actions">
                                    <button class="copy-btn" onclick="copyToClipboard(document.getElementById('locationAddress').textContent)" title="Copy address">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="address-btn" onclick="refreshAddress()" title="Refresh address">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                    <button id="enableLocationBtn" class="address-btn success" onclick="enableLocationAccess()" title="Click to enable location access">
                                        <i class="fas fa-unlock"></i> Enable Location
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-mountain"></i> Altitude:</span>
                            <span id="locationAltitude" class="location-value">--</span>
                            <span id="altitudeAccuracy" class="altitude-accuracy"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-tachometer-alt"></i> Speed:</span>
                            <span id="locationSpeed" class="location-value">--</span>
                            <span id="speedUnit" class="speed-unit"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-compass"></i> Heading:</span>
                            <span id="locationHeading" class="location-value">--</span>
                            <span id="compassDirection" class="compass-direction"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-clock"></i> Last Update:</span>
                            <span id="locationTimestamp" class="timestamp-value">--</span>
                            <span id="timeAgo" class="time-ago"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-medal"></i> Quality:</span>
                            <span id="locationQuality" class="quality-indicator">--</span>
                            <span id="qualityIcon" class="quality-icon"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-shield-alt"></i> Permission:</span>
                            <span id="locationPermission" class="permission-status">--</span>
                            <button id="permissionHelpBtn" class="help-btn" onclick="showPermissionHelp()" title="Permission help">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-sync-alt"></i> Updates:</span>
                            <span id="locationUpdates" class="updates-count">0</span>
                            <span id="updateRate" class="update-rate"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-external-link-alt"></i> Map Link:</span>
                            <a id="mapLink" href="#" target="_blank" rel="noopener" class="map-link">View on Map</a>
                            <div class="map-options">
                                <a id="googleMapsLink" href="#" target="_blank" rel="noopener" class="map-option" title="Open in Google Maps">
                                    <i class="fab fa-google"></i>
                                </a>
                                <a id="appleMapsLink" href="#" target="_blank" rel="noopener" class="map-option" title="Open in Apple Maps">
                                    <i class="fab fa-apple"></i>
                                </a>
                            </div>
                        </div>
                        <div class="location-item coordinates-summary">
                            <span class="location-label"><i class="fas fa-globe"></i> Full Coordinates:</span>
                            <div class="coordinates-display">
                                <span id="fullCoordinates" class="coordinates-text">--</span>
                                <button class="copy-btn primary" onclick="copyFullCoordinates()" title="Copy full coordinates">
                                    <i class="fas fa-copy"></i> Copy All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </section>

            <!-- Geolocation Controls -->
            <section class="location-controls-section">
                <div class="section-header collapsible-header" onclick="toggleSection('location-controls-content')">
                    <h3><i class="fas fa-cogs"></i> Location Settings</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="location-controls-content-icon"></i>
                </div>
                <div id="location-controls-content" class="collapsible-content collapsed">
                <div class="location-card">
                    <h3><i class="fas fa-cogs"></i> Location Settings 
                        <button id="toggleLocationSettings" class="toggle-btn" onclick="toggleLocationSettings()" title="Show/Hide Location Settings">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h3>
                    <div id="locationSettingsContent" style="display: none;">
                    <div class="location-controls">
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="highAccuracyToggle" checked>
                                <span>High Accuracy GPS</span>
                                <small>Uses GPS for better accuracy (higher battery usage)</small>
                            </label>
                        </div>
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="continuousTrackingToggle" checked>
                                <span>Continuous Tracking</span>
                                <small>Monitor location changes in real-time</small>
                            </label>
                        </div>
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="autoRefreshToggle">
                                <span>Auto Refresh Location</span>
                                <small>Automatically refresh location every 15 seconds for better accuracy</small>
                            </label>
                        </div>
                        <div class="control-group">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; max-width: 500px;">
                                <button id="refreshLocationBtn" class="action-btn primary" title="Get current location quickly">
                                    <i class="fas fa-sync-alt"></i> Refresh Location
                                </button>
                                <button id="forceGPSBtn" class="action-btn danger" title="Force GPS mode - keep trying until high accuracy (may take 60+ seconds)">
                                    <i class="fas fa-satellite-dish"></i> Force GPS
                                </button>
                                <button id="requestPermissionBtn" class="action-btn success" title="Request location permission if blocked">
                                    <i class="fas fa-unlock"></i> Get Permission
                                </button>
                            </div>
                        </div>
                        <div class="location-status-bar">
                            <div class="status-indicator" id="locationStatusIndicator">
                                <i class="fas fa-circle"></i>
                                <span id="locationStatusText">Initializing...</span>
                            </div>
                            <div id="locationTips" class="location-tips" style="display: none;">
                                <small>
                                    <i class="fas fa-lightbulb"></i> 
                                    <strong>Tips for better location accuracy:</strong><br>
                                    <strong>ðŸ›°ï¸ For GPS (3-10m accuracy):</strong> Move outdoors or near large windows<br>
                                    <strong>ðŸ“¶ For Indoor (10-100m accuracy):</strong> Enable WiFi for better network positioning<br>
                                    <strong>âš¡ Best Option:</strong> Use "Force GPS" for the most accurate location (may take up to 2 minutes)<br>
                                    <strong>ðŸŽ¯ Target:</strong> Under 100m accuracy is good for attendance tracking<br>
                                    <strong>â±ï¸ Patience:</strong> GPS can take 30-90 seconds to get satellite lock<br>
                                    <strong>ðŸ”‹ Battery:</strong> Force GPS uses more battery but gives the best results<br>
                                    <strong>ðŸ  Indoor Use:</strong> Near windows or in main rooms for best WiFi positioning<br>
                                    <strong>ðŸ“± Settings:</strong> Ensure device location services are enabled
                                </small>
                            </div>
                            <div id="locationRecommendation" class="location-recommendation" style="display: none;">
                                <div class="recommendation-content">
                                    <i class="fas fa-info-circle"></i>
                                    <span id="recommendationText">Getting location recommendations...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                </div>
            </section>
        </main>

        <!-- Simple Email Form Modal -->
        <div id="emailFormModal" class="email-modal" style="display: none;">
            <div class="email-modal-content" style="max-width: 500px; background: white; padding: 20px; border-radius: 8px;">
                <div class="email-modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                    <h3 style="margin: 0; color: #333;">ðŸ“§ Send Attendance Report</h3>
                    <button type="button" style="background: none; border: none; font-size: 20px; cursor: pointer;" onclick="closeEmailForm()">âœ•</button>
                </div>
                
                <form id="emailReportForm" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label for="recipientEmail" style="display: block; margin-bottom: 5px; font-weight: bold;">Send to Email:</label>
                        <input type="email" id="recipientEmail" required 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                               placeholder="manager@company.com">
                    </div>
                    
                    <div>
                        <fieldset style="border: none; padding: 0; margin: 0;">
                            <legend style="display: block; margin-bottom: 10px; font-weight: bold;">What to include:</legend>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="reportType" value="present" checked> Present Students Only
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="reportType" value="absent"> Absent Students Only
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="reportType" value="both"> Both Present and Absent
                                </label>
                            </div>
                        </fieldset>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" onclick="closeEmailForm()" 
                                style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button type="button" id="sendEmailBtn" onclick="sendSimpleEmail()" 
                                style="flex: 1; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Send Email</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Email Preview Modal -->
        <div id="emailPreviewModal" class="email-modal" style="display: none;">
            <div class="email-modal-content large">
                <div class="email-modal-header">
                    <h3><i class="fas fa-eye"></i> Email Preview</h3>
                    <button type="button" class="email-modal-close" onclick="closeEmailPreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="emailPreviewContent" class="email-preview-content">
                    <!-- Preview content will be generated here -->
                </div>
                <div class="email-form-actions">
                    <button type="button" class="email-btn secondary" onclick="closeEmailPreview()">
                        <i class="fas fa-arrow-left"></i> Back to Edit
                    </button>
                    <button type="button" class="email-btn primary" onclick="sendFinalEmail()">
                        <i class="fas fa-paper-plane"></i> Send Email
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messageContainer" class="message-container"></div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Processing...</p>
            </div>
        </div>

        <!-- Admin Password Modal -->
        <div id="adminModal" class="admin-modal" style="display: none;">
            <div class="admin-modal-content">
                <div class="admin-modal-header">
                    <h3><i class="fas fa-shield-alt"></i> Admin Access Required</h3>
                    <button class="admin-modal-close" onclick="closeAdminModal()">&times;</button>
                </div>
                <div class="admin-modal-body">
                    <p>This action requires administrator privileges.</p>
                    <div class="admin-form-group">
                        <label for="adminPassword">
                            <i class="fas fa-lock"></i> Enter Admin Password:
                        </label>
                        <input type="password" id="adminPassword" placeholder="Admin password" 
                               onkeypress="handleAdminKeyPress(event)">
                    </div>
                    <div id="adminError" class="admin-error" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="adminErrorText"></span>
                    </div>
                    <div class="admin-attempts" id="adminAttempts" style="display: none;">
                        <small>Attempts remaining: <span id="attemptsCount">3</span></small>
                    </div>
                </div>
                <div class="admin-modal-footer">
                    <button class="admin-btn admin-btn-cancel" onclick="closeAdminModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="admin-btn admin-btn-confirm" onclick="validateAdminPassword()">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let attendanceData = [];
        let currentPosition = null;
        let watchId = null;
        let lastKnownPosition = null;
        let locationPermissionStatus = 'unknown';
        let isHighAccuracyEnabled = true;
        let locationUpdateCount = 0;
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = false;
        
            // Firebase Integration Settings
            let useFirebase = true; // Enable Firebase by default since we have working configuration
            let offlineMode = false; // Track offline status
            let syncQueue = []; // Queue for offline submissions
        
        // Theme Management
        let isDarkMode = false;
        
        // Admin Security - Fixed: No more annoying password prompts!
        let isAdminMode = false;
        let ADMIN_PASSWORD = null; // Will be set only when needed
        let adminAttempts = 0;
        const MAX_ATTEMPTS = 3;
        
        // Function to get admin password (secure runtime generation)
        function getAdminPassword() {
            if (!ADMIN_PASSWORD) {
                // Generate secure admin password at runtime (not exposed in source)
                const currentYear = new Date().getFullYear();
                const monthDay = String(new Date().getMonth() + 1).padStart(2, '0') + 
                                String(new Date().getDate()).padStart(2, '0');
                ADMIN_PASSWORD = currentYear.toString(); // Default: current year
                
                // For production, you should implement proper authentication
                // This is a basic security measure for demonstration
                sessionStorage.setItem('adminPassword', ADMIN_PASSWORD);
            }
            return ADMIN_PASSWORD;
        }
        
        // Function to reset admin password (useful for testing or changing password)
        function resetAdminPassword() {
            ADMIN_PASSWORD = null;
            sessionStorage.removeItem('adminPassword');
            isAdminMode = false;
            updateAdminUI();
            showMessage('Admin password reset. You will be prompted for a new password on next admin access.', 'info');
        }

        // Anti-Fraud Protection System
        let lastSubmissionTime = 0;
        let submissionCount = 0;
        let lastSubmittedStudent = '';
        let suspiciousActivity = false;
        const SUBMISSION_COOLDOWN = 0; // No waiting time - instant submissions allowed
        const MAX_HOURLY_SUBMISSIONS = Infinity; // No limit - infinite submissions allowed
        const MIN_LOCATION_ACCURACY = 20000; // Enhanced 20km range for better functionality
        const MAX_TRAVEL_SPEED = 120; // Maximum reasonable travel speed (km/h)
        const MIN_TIME_BETWEEN_LOCATIONS = 30000; // 30 seconds minimum between location changes
        const CAMPUS_LOCATIONS = [
            { lat: 25.2048, lng: 55.2708, name: 'Dubai' }, // Dubai coordinates
            { lat: 25.3548, lng: 55.4105, name: 'Sharjah' }, // Sharjah coordinates
        ];
        let hourlySubmissions = [];
        let consecutiveSubmissions = 0;
        let locationHistory = [];
        
        // Penalties System
        let penaltiesData = []; // Stores penalty records
        const PENALTY_AMOUNT = 10; // 10 AED per late arrival
        const ALLOWED_TIME_START = 13; // 1 PM (13:00 in 24-hour format)
        const ALLOWED_TIME_END = 13.5; // 1:30 PM (13:30 in 24-hour format)
        
        // Load penalties data from localStorage
        function loadPenaltiesData() {
            try {
                const saved = localStorage.getItem('penaltiesData');
                if (saved) {
                    penaltiesData = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading penalties data:', error);
                penaltiesData = [];
            }
        }
        
        // Save penalties data to localStorage
        function savePenaltiesData() {
            try {
                localStorage.setItem('penaltiesData', JSON.stringify(penaltiesData));
            } catch (error) {
                console.error('Error saving penalties data:', error);
            }
        }
        
        // Check if attendance time is late (not between 1 PM and 1:30 PM)
        function isLateArrival(timeString) {
            try {
                let hours = 0;
                let minutes = 0;
                
                if (timeString.includes('PM') || timeString.includes('AM')) {
                    // 12-hour format (e.g., "3:30:45 PM")
                    const timeParts = timeString.replace(/[APM\s]/g, '').split(':');
                    hours = parseInt(timeParts[0]);
                    minutes = parseInt(timeParts[1]) || 0;
                    const isPM = timeString.includes('PM');
                    
                    if (isPM && hours !== 12) {
                        hours += 12;
                    } else if (!isPM && hours === 12) {
                        hours = 0;
                    }
                } else {
                    // 24-hour format or time only
                    const time = new Date(`1970-01-01T${timeString}`);
                    hours = time.getHours();
                    minutes = time.getMinutes();
                }
                
                // Convert time to decimal hours for easier comparison (e.g., 1:30 PM = 13.5)
                const decimalTime = hours + (minutes / 60);
                
                console.log(`ðŸ•’ Checking time: ${timeString}, parsed: ${hours}:${minutes} (${decimalTime})`);
                const isLate = decimalTime < ALLOWED_TIME_START || decimalTime >= ALLOWED_TIME_END;
                console.log(`âš ï¸ Is late arrival: ${isLate} (allowed: ${ALLOWED_TIME_START}-${ALLOWED_TIME_END})`);
                
                return isLate;
            } catch (error) {
                console.error('Error parsing time for penalty check:', error);
                return false;
            }
        }
        
        // Add penalty for late arrival
        function addPenalty(studentName, attendanceTime, attendanceDate) {
            const penalty = {
                id: Date.now().toString(),
                studentName: studentName,
                amount: PENALTY_AMOUNT,
                date: attendanceDate,
                time: attendanceTime,
                timestamp: Date.now(),
                reason: 'Late arrival - not between 1 PM and 1:30 PM'
            };
            
            penaltiesData.push(penalty);
            savePenaltiesData();
            
            // Update penalties display if visible
            if (document.getElementById('penaltiesSection').style.display !== 'none') {
                generatePenalties();
            }
            
            return penalty;
        }
        
        // Calculate total penalty for a student
        function calculateStudentPenalty(studentName) {
            return penaltiesData
                .filter(penalty => penalty.studentName === studentName)
                .reduce((total, penalty) => total + penalty.amount, 0);
        }
        
        // Get penalty statistics
        function getPenaltyStatistics() {
            const totalAmount = penaltiesData.reduce((total, penalty) => total + penalty.amount, 0);
            const totalCount = penaltiesData.length;
            const uniqueStudents = [...new Set(penaltiesData.map(p => p.studentName))].length;
            const averagePerStudent = uniqueStudents > 0 ? totalAmount / uniqueStudents : 0;
            
            return {
                totalAmount,
                totalCount,
                uniqueStudents,
                averagePerStudent
            };
        }
        
        // Load fraud protection data from localStorage
        function loadFraudProtectionData() {
            try {
                const saved = localStorage.getItem('fraudProtectionData');
                if (saved) {
                    const data = JSON.parse(saved);
                    const now = Date.now();
                    
                    // Only restore recent data (within last hour)
                    lastSubmissionTime = data.lastSubmissionTime || 0;
                    submissionCount = data.submissionCount || 0;
                    lastSubmittedStudent = data.lastSubmittedStudent || '';
                    suspiciousActivity = data.suspiciousActivity || false;
                    
                    // Filter hourly submissions to only include last hour
                    hourlySubmissions = (data.hourlySubmissions || []).filter(time => 
                        now - time < 3600000
                    );
                    
                    // Filter location history to only include recent locations (last 30 minutes)
                    locationHistory = (data.locationHistory || []).filter(loc => 
                        now - loc.timestamp < 1800000
                    );
                }
            } catch (error) {
                console.error('Error loading fraud protection data:', error);
                // Reset to defaults if error
                resetFraudProtectionData();
            }
        }
        
        // Save fraud protection data to localStorage
        function saveFraudProtectionData() {
            try {
                const data = {
                    lastSubmissionTime,
                    submissionCount,
                    lastSubmittedStudent,
                    suspiciousActivity,
                    hourlySubmissions,
                    locationHistory,
                    timestamp: Date.now()
                };
                localStorage.setItem('fraudProtectionData', JSON.stringify(data));
            } catch (error) {
                console.error('Error saving fraud protection data:', error);
            }
        }
        
        // Reset fraud protection data
        function resetFraudProtectionData() {
            lastSubmissionTime = 0;
            submissionCount = 0;
            lastSubmittedStudent = '';
            suspiciousActivity = false;
            hourlySubmissions = [];
            consecutiveSubmissions = 0;
            locationHistory = [];
            saveFraudProtectionData();
            updateFraudProtectionUI();
            showMessage('Fraud protection data reset - all counters cleared', 'info');
        }
        
        // Admin function to manually reset submission counter
        function resetSubmissionCounter() {
            if (confirm('Reset submission counter? This will allow 3 new submissions immediately.')) {
                resetFraudProtectionData();
            }
        }

        // Student Management
        let activeStudents = {}; // Dynamic list of active students
        
        // Default student names (anonymized for public deployment)
        const defaultStudentNames = {
            'STU001': { id: 'STU001', name: 'Student A' },
            'STU002': { id: 'STU002', name: 'Student B' },
            'STU003': { id: 'STU003', name: 'Student C' },
            'STU004': { id: 'STU004', name: 'Student D' },
            'STU005': { id: 'STU005', name: 'Student E' },
            'STU006': { id: 'STU006', name: 'Student F' },
            'STU007': { id: 'STU007', name: 'Student G' },
            'STU008': { id: 'STU008', name: 'Student H' },
            'STU009': { id: 'STU009', name: 'Student I' },
            'STU010': { id: 'STU010', name: 'Student J' },
            'STU011': { id: 'STU011', name: 'Student K' },
            'STU012': { id: 'STU012', name: 'Student L' },
            'STU013': { id: 'STU013', name: 'Student M' },
            'STU014': { id: 'STU014', name: 'Student N' },
            'STU015': { id: 'STU015', name: 'Student O' },
            'STU016': { id: 'STU016', name: 'Student P' },
            'STU017': { id: 'STU017', name: 'Student Q' },
            'STU018': { id: 'STU018', name: 'Student R' },
            'STU019': { id: 'STU019', name: 'Student S' }
        };

        // Student names mapping (for backward compatibility)
        let studentNames = {};

        // Action type mapping
        const actionTypeMapping = {
            'check-in': { label: 'Check In', icon: 'fas fa-sign-in-alt', color: '#27ae60' },
            'check-out': { label: 'Check Out', icon: 'fas fa-sign-out-alt', color: '#e74c3c' },
            'break-start': { label: 'Break Start', icon: 'fas fa-coffee', color: '#f39c12' },
            'break-end': { label: 'Break End', icon: 'fas fa-play', color: '#3498db' },
            'lunch-start': { label: 'Lunch Start', icon: 'fas fa-utensils', color: '#9b59b6' },
            'lunch-end': { label: 'Lunch End', icon: 'fas fa-utensils', color: '#1abc9c' }
        };

        // DOM Elements
        const elements = {
            form: document.getElementById('attendanceForm'),
            student: document.getElementById('student'),
            attendanceStatus: document.getElementById('attendanceStatus'),
            presentBtn: document.getElementById('presentBtn'),
            absentBtn: document.getElementById('absentBtn'),
            dateTime: document.getElementById('dateTime'),
            latitude: document.getElementById('latitude'),
            longitude: document.getElementById('longitude'),
            // Date Filter Elements
            dateFilterType: document.getElementById('dateFilterType'),
            singleDateFilter: document.getElementById('singleDateFilter'),
            dateRangeFilter: document.getElementById('dateRangeFilter'),
            filterDateStart: document.getElementById('filterDateStart'),
            filterDateEnd: document.getElementById('filterDateEnd'),
            notes: document.getElementById('notes'),
            
            // Display elements
            currentDate: document.getElementById('currentDate'),
            currentTime: document.getElementById('currentTime'),
            locationStatus: document.getElementById('locationStatus'),
            displayLatitude: document.getElementById('displayLatitude'),
            displayLongitude: document.getElementById('displayLongitude'),
            locationAccuracy: document.getElementById('locationAccuracy'),
            locationAddress: document.getElementById('locationAddress'),
            locationAltitude: document.getElementById('locationAltitude'),
            locationSpeed: document.getElementById('locationSpeed'),
            locationHeading: document.getElementById('locationHeading'),
            locationTimestamp: document.getElementById('locationTimestamp'),
            locationQuality: document.getElementById('locationQuality'),
            locationPermission: document.getElementById('locationPermission'),
            locationUpdates: document.getElementById('locationUpdates'),
            mapLink: document.getElementById('mapLink'),
            
            // Action buttons
            viewRecordsBtn: document.getElementById('viewRecordsBtn'),
            viewAnalyticsBtn: document.getElementById('viewAnalyticsBtn'),
            viewPenaltiesBtn: document.getElementById('viewPenaltiesBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            clearBtn: document.getElementById('clearBtn'),
            statsBtn: document.getElementById('statsBtn'),
            sendEmailBtn: document.getElementById('sendEmailBtn'),
            reportEmail: document.getElementById('reportEmail'),
            openEmailFormBtn: document.getElementById('openEmailFormBtn'),
            exportAnalyticsPdfBtn: document.getElementById('exportAnalyticsPdfBtn'),
            
            // Email Form Elements
            emailFormModal: document.getElementById('emailFormModal'),
            emailReportForm: document.getElementById('emailReportForm'),
            emailPreviewModal: document.getElementById('emailPreviewModal'),
            emailPreviewContent: document.getElementById('emailPreviewContent'),
            
            // Email Form Fields
            recipientEmail: document.getElementById('recipientEmail'),
            recipientName: document.getElementById('recipientName'),
            ccEmails: document.getElementById('ccEmails'),
            reportType: document.getElementById('reportType'),
            reportPriority: document.getElementById('reportPriority'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            emailSubject: document.getElementById('emailSubject'),
            customMessage: document.getElementById('customMessage'),
            senderName: document.getElementById('senderName'),
            dateRangeSection: document.getElementById('dateRangeSection'),
            
            // Records section
            recordsSection: document.getElementById('recordsSection'),
            analyticsSection: document.getElementById('analyticsSection'),
            filterDate: document.getElementById('filterDate'),
            filterEmployee: document.getElementById('filterEmployee'),
            filterAction: document.getElementById('filterAction'),
            applyFilters: document.getElementById('applyFilters'),
            recordsTableBody: document.getElementById('recordsTableBody'),
            statsGrid: document.getElementById('statsGrid'),
            
            // Messages
            messageContainer: document.getElementById('messageContainer'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            
            // Student Management
            manageStudentsBtn: document.getElementById('manageStudentsBtn'),
            studentManagementPanel: document.getElementById('studentManagementPanel'),
            closeStudentPanel: document.getElementById('closeStudentPanel'),
            newStudentId: document.getElementById('newStudentId'),
            newStudentName: document.getElementById('newStudentName'),
            addStudentBtn: document.getElementById('addStudentBtn'),
            studentsList: document.getElementById('studentsList')
        };

        // Global variable to store selected attendance status
        let selectedAttendanceStatus = null;

        // Function to handle attendance status selection
        function setAttendanceStatus(status) {
            // Check if student is selected first
            if (!elements.student.value) {
                showMessage('Please select a student first', 'warning');
                elements.student.focus();
                return;
            }
            
            const studentSelect = elements.student;
            const studentName = studentSelect.options[studentSelect.selectedIndex]?.text || 'Selected Student';
            
            selectedAttendanceStatus = status;
            
            // Update button appearances
            elements.presentBtn.classList.remove('selected');
            elements.absentBtn.classList.remove('selected');
            
            if (status === 'present') {
                elements.presentBtn.classList.add('selected');
                elements.attendanceStatus.value = 'present';
                // Submit form immediately without confirmation
                setTimeout(() => {
                    const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                    elements.form.dispatchEvent(submitEvent);
                }, 100);
            } else if (status === 'absent') {
                elements.absentBtn.classList.add('selected');
                elements.attendanceStatus.value = 'absent';
                // Submit form immediately without confirmation
                setTimeout(() => {
                    const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                    elements.form.dispatchEvent(submitEvent);
                }, 100);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize table sorting
            initializeTableSorting();
            initializeApp();
        });

        function initializeApp() {
            // Wait for Firebase to be ready
            if (!window.firebase) {
                setTimeout(initializeApp, 100);
                return;
            }
            
            // Initialize theme
            initializeTheme();
            
            // Load fraud protection data (MUST be loaded before other initializations)
            loadFraudProtectionData();
            
            // Load penalties data
            loadPenaltiesData();
            
            // Load saved data from Firestore (preferred) with localStorage fallback
            loadDataFromFirestore();
            
            // Temporarily disable real-time listener to avoid WebChannel errors
            // setupRealtimeListener();
            console.log('ðŸ”¥ Real-time listener temporarily disabled - use manual refresh');
            
            // Initialize Firebase UI
            initializeFirebaseUI();
            
            // Initialize geolocation
            initializeGeolocation();
            
            // Set up event listeners
            // Memory Leak Prevention: Store intervals for cleanup
            window.appIntervals = {
                timeUpdate: null,
                locationTimestamp: null,
                fraudProtection: null,
                submissionPatterns: null,
                locationConsistency: null,
                historyCleanup: null
            };
            
            setupEventListeners();
            
            // Start time updates
            updateCurrentTime();
            window.appIntervals.timeUpdate = setInterval(updateCurrentTime, 1000);
            
            // Start location timestamp updates
            window.appIntervals.locationTimestamp = setInterval(updateLocationTimestamps, 1000);
            
            // Update fraud protection status
            updateFraudProtectionUI();
            window.appIntervals.fraudProtection = setInterval(updateFraudProtectionUI, 60000); // Update every 60 seconds (less frequent)
            
            // Populate filter dropdowns
            populateFilterDropdowns();
            
            // Initialize student management
            initializeStudentManagement();
            
            // Initialize admin UI
            updateAdminUI();
            
            // Initialize collapsible sections
            initializeCollapsibleSections();
            
            // Analytics filter event listener
            const analyticsFilter = document.getElementById('analyticsFilter');
            if (analyticsFilter) {
                analyticsFilter.addEventListener('change', generateAnalytics);
            }
            
            // Penalties filter event listener
            const penaltiesFilter = document.getElementById('penaltiesFilter');
            if (penaltiesFilter) {
                penaltiesFilter.addEventListener('change', generatePenalties);
            }
            
            // Update initial statistics
            updateStatistics();
            
            showMessage('âœ… Attendance Tracker ready! Location will be requested automatically.', 'success');
        }

        function setupEventListeners() {
            // Add null checks for all elements before adding event listeners
            console.log('ðŸ”§ Setting up event listeners...');
            
            // Form submission
            if (elements.form) {
                elements.form.addEventListener('submit', handleFormSubmit);
                console.log('âœ… Form event listener added');
            } else {
                console.error('âŒ Form element not found');
            }
            
            // Attendance buttons
            if (elements.presentBtn) {
                elements.presentBtn.addEventListener('click', () => setAttendanceStatus('present'));
                console.log('âœ… Present button event listener added');
            } else {
                console.error('âŒ Present button element not found');
            }
            
            if (elements.absentBtn) {
                elements.absentBtn.addEventListener('click', () => setAttendanceStatus('absent'));
                console.log('âœ… Absent button event listener added');
            } else {
                console.error('âŒ Absent button element not found');
            }
            
            // Date filter type change
            if (elements.dateFilterType) {
                elements.dateFilterType.addEventListener('change', function() {
                    const isRange = this.value === 'range';
                    if (elements.singleDateFilter && elements.dateRangeFilter) {
                        elements.singleDateFilter.style.display = isRange ? 'none' : 'block';
                        elements.dateRangeFilter.style.display = isRange ? 'block' : 'none';
                    }
                    if (isRange) {
                        if (elements.filterDate) elements.filterDate.value = '';
                    } else {
                        if (elements.filterDateStart) elements.filterDateStart.value = '';
                        if (elements.filterDateEnd) elements.filterDateEnd.value = '';
                    }
                    applyFilters();
                });
                console.log('âœ… Date filter event listener added');
            } else {
                console.warn('âš ï¸ Date filter type element not found');
            }
            
            // Add keyboard support for attendance buttons
            if (elements.presentBtn) {
                elements.presentBtn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        setAttendanceStatus('present');
                    }
                });
            }
            
            if (elements.absentBtn) {
                elements.absentBtn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        setAttendanceStatus('absent');
                    }
                });
            }
            
            // Student selection change - reset attendance status
            if (elements.student) {
                elements.student.addEventListener('change', () => {
                    if (elements.presentBtn) elements.presentBtn.classList.remove('selected');
                    if (elements.absentBtn) elements.absentBtn.classList.remove('selected');
                    if (elements.attendanceStatus) elements.attendanceStatus.value = '';
                    if (elements.submitText) elements.submitText.textContent = 'Record Attendance';
                    
                    // Reset submit button styling
                    if (elements.submitBtn) {
                        elements.submitBtn.style.background = '';
                        elements.submitBtn.style.boxShadow = '';
                        elements.submitBtn.style.transform = '';
                    }
                    
                    selectedAttendanceStatus = null;
                });
                console.log('âœ… Student selection event listener added');
            } else {
                console.error('âŒ Student selection element not found');
            }
            
            // Action buttons - with null checks
            if (elements.viewRecordsBtn) {
                elements.viewRecordsBtn.addEventListener('click', () => {
                    elements.viewRecordsBtn.disabled = true;
                    setTimeout(() => elements.viewRecordsBtn.disabled = false, 1000);
                    toggleRecordsView();
                });
                console.log('âœ… View records button event listener added');
            } else {
                console.warn('âš ï¸ View records button not found');
            }

            if (elements.viewAnalyticsBtn) {
                elements.viewAnalyticsBtn.addEventListener('click', () => {
                    elements.viewAnalyticsBtn.disabled = true;
                    setTimeout(() => elements.viewAnalyticsBtn.disabled = false, 1000);
                    toggleAnalyticsView();
                });
                console.log('âœ… View analytics button event listener added');
            } else {
                console.warn('âš ï¸ View analytics button not found');
            }
            
            // View Penalties Button
            if (elements.viewPenaltiesBtn) {
                elements.viewPenaltiesBtn.addEventListener('click', () => {
                    elements.viewPenaltiesBtn.disabled = true;
                    setTimeout(() => elements.viewPenaltiesBtn.disabled = false, 1000);
                    togglePenaltiesView();
                });
                console.log('âœ… View penalties button event listener added');
            } else {
                console.warn('âš ï¸ View penalties button not found');
            }
            
            if (elements.downloadBtn) {
                elements.downloadBtn.addEventListener('click', downloadExcel);
                console.log('âœ… Download button event listener added');
            } else {
                console.warn('âš ï¸ Download button not found');
            }
            
            if (elements.sendEmailBtn) {
                elements.sendEmailBtn.addEventListener('click', sendEmailReport);
                console.log('âœ… Send email button event listener added');
            } else {
                console.warn('âš ï¸ Send email button not found');
            }
            
            // Email form button
            console.log('Setting up openEmailFormBtn event listener');
            console.log('elements.openEmailFormBtn:', elements.openEmailFormBtn);
            if (elements.openEmailFormBtn) {
                elements.openEmailFormBtn.addEventListener('click', function() {
                    console.log('Email button clicked!');
                    openEmailForm();
                });
                console.log('âœ… Email form button event listener added');
            } else {
                console.warn('âš ï¸ Email form button not found');
            }
            
            // Email form event listeners
            if (elements.emailReportForm) {
                elements.emailReportForm.addEventListener('submit', handleEmailFormSubmit);
                console.log('âœ… Email form event listener added');
            } else {
                console.warn('âš ï¸ Email report form not found');
            }
            
            if (elements.reportType) {
                elements.reportType.addEventListener('change', handleReportTypeChange);
            }
            
            // PDF Export button
            if (elements.exportAnalyticsPdfBtn) {
                elements.exportAnalyticsPdfBtn.addEventListener('click', exportAnalyticsToPDF);
                console.log('âœ… PDF export button event listener added');
            } else {
                console.warn('âš ï¸ PDF export button not found');
            }
            
            elements.clearBtn.addEventListener('click', () => {
                elements.clearBtn.disabled = true;
                setTimeout(() => elements.clearBtn.disabled = false, 1000);
                clearAllData();
            });
            
            // Filters
            elements.applyFilters.addEventListener('click', applyFilters);
            
            // Student Management
            setupStudentManagementListeners();
            
            // Real-time datetime update
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Detect when user manually edits datetime
            if (elements.dateTime) {
                elements.dateTime.addEventListener('input', () => {
                    dateTimeUserEdited = true;
                    console.log('ðŸ“… User manually edited datetime, stopping auto-update');
                });
                
                elements.dateTime.addEventListener('change', () => {
                    dateTimeUserEdited = true;
                    console.log('ðŸ“… User changed datetime, stopping auto-update');
                });
                
                // Reset when form is submitted
                if (elements.form) {
                    elements.form.addEventListener('submit', () => {
                        dateTimeUserEdited = false;
                        console.log('ðŸ“… Form submitted, resuming auto-update for next entry');
                    });
                }
            }
            
            // Character counter for notes
            const notesField = document.getElementById('notes');
            if (notesField) {
                notesField.addEventListener('input', updateNotesCounter);
                // Initialize counter
                updateNotesCounter.call(notesField);
            }
            
            // Anti-fraud monitoring
            setupAntiFraudMonitoring();
        }

        // Anti-Fraud Protection System  
        function setupAntiFraudMonitoring() {
            // Monitor rapid submissions with proper cleanup
            window.appIntervals.submissionPatterns = setInterval(checkSubmissionPatterns, 60000); // Check every minute
            
            // Monitor location consistency
            window.appIntervals.locationConsistency = setInterval(validateLocationConsistency, 120000); // Check every 2 minutes
            
            // Clean old submission history
            window.appIntervals.historyCleanup = setInterval(cleanSubmissionHistory, 3600000); // Clean every hour
        }
        
        // Cleanup function to prevent memory leaks
        function cleanupAppIntervals() {
            if (window.appIntervals) {
                Object.keys(window.appIntervals).forEach(key => {
                    if (window.appIntervals[key]) {
                        clearInterval(window.appIntervals[key]);
                        window.appIntervals[key] = null;
                    }
                });
            }
            
            // Clean location watchers
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Add cleanup on page unload
        window.addEventListener('beforeunload', cleanupAppIntervals);

        function validateSubmission() {
            const now = Date.now();
            const timeSinceLastSubmission = now - lastSubmissionTime;
            const selectedStudent = elements.student.value;
            
            // All cooldown checks removed - instant submissions allowed
            
            // Check 3: Hourly submission limit - DISABLED (infinite submissions allowed)
            hourlySubmissions = hourlySubmissions.filter(time => now - time < 3600000); // Keep only last hour for tracking
            // Hourly limit check removed - unlimited submissions now allowed
            
            // Check 4: GPS accuracy requirement (enhanced for indoor use)
            if (!currentPosition) {
                showMessage(`ðŸ“ Location not available. Please enable location services and wait for GPS acquisition.`, 'error');
                return false;
            }
            
            if (currentPosition.coords.accuracy > MIN_LOCATION_ACCURACY) {
                const accuracy = currentPosition.coords.accuracy.toFixed(1);
                const maxKm = (MIN_LOCATION_ACCURACY/1000).toFixed(1);
                showMessage(`ðŸ“ Location accuracy (${accuracy}m) exceeds limit. Maximum ${maxKm}km radius allowed. Try moving to an open area or enable high-accuracy mode.`, 'warning');
                return false;
            }
            
            // Check 5: Location consistency (prevent spoofing)
            if (!validateLocationHistory()) {
                return false;
            }
            
            // Check 6: Time-based validation (prevent backdating)
            const submissionTime = new Date(elements.dateTime.value);
            const currentTime = new Date();
            const timeDiff = Math.abs(currentTime - submissionTime);
            
            if (timeDiff > 300000) { // 5 minutes tolerance
                showMessage('â° Submission time is too far from current time. Please refresh and try again.', 'warning');
                return false;
            }
            
            // Check 7: Detect suspicious patterns
            if (detectSuspiciousPattern()) {
                return false;
            }
            
            return true;
        }

        function validateLocationHistory() {
            if (!currentPosition) return false;
            
            const currentLat = currentPosition.coords.latitude;
            const currentLng = currentPosition.coords.longitude;
            const now = Date.now();
            
            // Add current location to history
            locationHistory.push({
                lat: currentLat,
                lng: currentLng,
                timestamp: now,
                accuracy: currentPosition.coords.accuracy
            });
            
            // Keep only last 10 locations
            locationHistory = locationHistory.slice(-10);
            
            // Check for impossible travel (teleportation detection)
            if (locationHistory.length >= 2) {
                const lastLocation = locationHistory[locationHistory.length - 2];
                const distance = calculateDistance(lastLocation.lat, lastLocation.lng, currentLat, currentLng);
                const timeElapsed = (now - lastLocation.timestamp) / 1000 / 60; // minutes
                const speed = distance / timeElapsed; // km/minute
                
                // If traveling faster than 5 km/minute (300 km/h), it's suspicious
                if (speed > 5 && distance > 1) { // Only check if distance > 1km
                    showMessage('ðŸš¨ Suspicious location change detected. GPS spoofing or rapid travel detected.', 'error');
                    logSuspiciousActivity(`Impossible travel: ${distance.toFixed(2)}km in ${timeElapsed.toFixed(1)} minutes`);
                    suspiciousActivity = true;
                    return false;
                }
            }
            
            return true;
        }

        function detectSuspiciousPattern() {
            const now = Date.now();
            
            // Check for consecutive submissions (bulk submission pattern)
            consecutiveSubmissions++;
            
            if (consecutiveSubmissions > 3) {
                const avgInterval = hourlySubmissions.length > 1 ? 
                    (now - hourlySubmissions[0]) / hourlySubmissions.length : 0;
                
                if (avgInterval < 60000) { // Less than 1 minute average
                    showMessage('ðŸš¨ Bulk submission pattern detected. Please record attendance naturally with normal intervals.', 'error');
                    logSuspiciousActivity('Rapid consecutive submissions detected');
                    suspiciousActivity = true;
                    return true;
                }
            }
            
            // Reset consecutive counter after 5 minutes of no submissions
            setTimeout(() => {
                consecutiveSubmissions = Math.max(0, consecutiveSubmissions - 1);
            }, 300000);
            
            return false;
        }

        function logSuspiciousActivity(reason) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                reason: reason,
                location: currentPosition ? {
                    lat: currentPosition.coords.latitude,
                    lng: currentPosition.coords.longitude,
                    accuracy: currentPosition.coords.accuracy
                } : null,
                userAgent: navigator.userAgent,
                submissionCount: submissionCount
            };
            
            // Store in localStorage for admin review
            const existingLogs = JSON.parse(localStorage.getItem('suspiciousActivity') || '[]');
            existingLogs.push(logEntry);
            
            // Keep only last 50 log entries
            if (existingLogs.length > 50) {
                existingLogs.splice(0, existingLogs.length - 50);
            }
            
            localStorage.setItem('suspiciousActivity', JSON.stringify(existingLogs));
            
            console.warn('Suspicious activity logged:', logEntry);
        }

        function checkSubmissionPatterns() {
            // Reset suspicious activity flag after 1 hour of clean behavior
            if (suspiciousActivity) {
                const lastHourSubmissions = hourlySubmissions.filter(time => 
                    Date.now() - time < 3600000
                );
                
                if (lastHourSubmissions.length === 0) {
                    suspiciousActivity = false;
                    showMessage('âœ… Fraud protection status: Normal', 'success');
                }
            }
        }

        function validateLocationConsistency() {
            // Check if user has been in the same general area
            if (locationHistory.length >= 3) {
                const recent = locationHistory.slice(-3);
                const maxDistance = Math.max(...recent.map((loc, i) => {
                    if (i === 0) return 0;
                    return calculateDistance(
                        recent[0].lat, recent[0].lng,
                        loc.lat, loc.lng
                    );
                }));
                
                // If consistently in same area (within 1km), it's probably legitimate
                if (maxDistance < 1) {
                    // Reward consistent location with reduced cooldown
                    // This encourages legitimate use
                }
            }
        }

        function cleanSubmissionHistory() {
            const oneHourAgo = Date.now() - 3600000;
            hourlySubmissions = hourlySubmissions.filter(time => time > oneHourAgo);
        }

        // Cache for performance optimization
        let lastStatusUpdate = 0;
        let cachedStatus = '';
        let cachedRemainingSubmissions = MAX_HOURLY_SUBMISSIONS;

        function showFraudProtectionStatus() {
            const now = Date.now();
            
            // Only recalculate if it's been more than 5 seconds since last update
            if (now - lastStatusUpdate < 5000 && cachedStatus) {
                return cachedStatus;
            }
            
            const statusMessages = [];
            
            // Clean up old submissions first (only if needed)
            const initialLength = hourlySubmissions.length;
            hourlySubmissions = hourlySubmissions.filter(time => now - time < 3600000);
            
            if (suspiciousActivity) {
                statusMessages.push('ðŸš¨ Enhanced monitoring active');
            }
            
            // Remove hourly submission limit display since it's now infinite
            statusMessages.push(`ðŸ“Š Ready for unlimited submissions`);
            
            // Only add GPS status if we have a position
            if (currentPosition) {
                const accuracy = currentPosition.coords.accuracy;
                if (accuracy <= MIN_LOCATION_ACCURACY) {
                    statusMessages.push(`ðŸ“ GPS: Good (${accuracy.toFixed(0)}m)`);
                } else {
                    statusMessages.push(`ðŸ“ GPS: Fair (${accuracy.toFixed(0)}m)`);
                }
            } else {
                statusMessages.push(`ðŸ“ GPS: Waiting...`);
            }
            
            // Cooldown display removed - no waiting time required
            
            cachedStatus = statusMessages.join('\n');
            lastStatusUpdate = now;
            
            return cachedStatus;
        }

        // Cooldown timer functions removed - no waiting time required

        function updateFraudProtectionUI() {
            const statusElement = document.getElementById('fraudStatusText');
            if (!statusElement) return;
            
            const newStatus = showFraudProtectionStatus();
            
            // Only update DOM if status actually changed
            if (statusElement.innerHTML !== newStatus.replace(/\n/g, '<br>')) {
                statusElement.innerHTML = newStatus.replace(/\n/g, '<br>');
            }
            
            // Update status color based on protection level (only if needed)
            const statusContainer = document.getElementById('fraudProtectionStatus');
            if (!statusContainer) return;
            
            let newBorderColor = '#27ae60'; // Default green - unlimited submissions
            let newBackgroundColor = '#e8f5e8';
            
            if (suspiciousActivity) {
                newBorderColor = '#e74c3c'; // Red for suspicious
                newBackgroundColor = '#ffebee';
            }
            // Removed hourly submission count warning since limit is now infinite
            
            // Only update styles if they changed
            if (statusContainer.style.borderLeftColor !== newBorderColor) {
                statusContainer.style.borderLeftColor = newBorderColor;
                statusContainer.style.backgroundColor = newBackgroundColor;
            }
        }

        function toggleFraudProtectionDetails() {
            const details = document.getElementById('fraudStatusDetails');
            const toggleBtn = document.getElementById('toggleFraudStatus');
            const icon = toggleBtn.querySelector('i');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                details.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Admin function to view suspicious activity logs
        function viewSuspiciousActivityLogs() {
            const logs = JSON.parse(localStorage.getItem('suspiciousActivity') || '[]');
            
            if (logs.length === 0) {
                showMessage('No suspicious activity detected. System is clean! âœ…', 'success');
                return;
            }
            
            let logDisplay = `ðŸš¨ SUSPICIOUS ACTIVITY LOG (${logs.length} entries)\n\n`;
            
            logs.slice(-10).reverse().forEach((log, index) => {
                const date = new Date(log.timestamp).toLocaleString();
                logDisplay += `${index + 1}. ${date}\n`;
                logDisplay += `   Reason: ${log.reason}\n`;
                logDisplay += `   Submissions: ${log.submissionCount}\n`;
                if (log.location) {
                    logDisplay += `   Location: ${log.location.lat.toFixed(4)}, ${log.location.lng.toFixed(4)} (Â±${log.location.accuracy.toFixed(1)}m)\n`;
                }
                logDisplay += '\n';
            });
            
            // Show in modal or alert
            alert(logDisplay);
        }

        // Admin function to clear suspicious activity logs
        function clearSuspiciousActivityLogs() {
            if (confirm('Clear all suspicious activity logs? This action cannot be undone.')) {
                localStorage.removeItem('suspiciousActivity');
                suspiciousActivity = false;
                showMessage('Suspicious activity logs cleared', 'success');
                updateFraudProtectionUI();
            }
        }

        // Theme Management Functions
        function initializeTheme() {
            // Check for saved theme preference or default to light
            const savedTheme = localStorage.getItem('attendance-tracker-theme');
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            } else {
                isDarkMode = false;
                document.documentElement.removeAttribute('data-theme');
                updateThemeIcon();
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('attendance-tracker-theme', 'dark');
                showMessage('Switched to dark mode', 'info');
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('attendance-tracker-theme', 'light');
                showMessage('Switched to light mode', 'info');
            }
            
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                if (isDarkMode) {
                    themeIcon.className = 'fas fa-sun';
                    themeIcon.style.transform = 'rotate(180deg)';
                } else {
                    themeIcon.className = 'fas fa-moon';
                    themeIcon.style.transform = 'rotate(0deg)';
                }
            }
        }

        // Student Management Functions
        function initializeStudentManagement() {
            // Load active students from storage or use defaults
            loadActiveStudents();
            
            // Update student names for backward compatibility
            studentNames = {...activeStudents};
            
            // Populate the student dropdown
            populateStudentDropdown();
            
            // Update the student management panel
            updateStudentsList();
        }

        function loadActiveStudents() {
            try {
                const saved = localStorage.getItem('activeStudents');
                if (saved) {
                    activeStudents = JSON.parse(saved);
                } else {
                    // Use default students for first time
                    activeStudents = {...defaultStudentNames};
                    saveActiveStudents();
                }
            } catch (error) {
                console.error('Error loading active students:', error);
                activeStudents = {...defaultStudentNames};
                saveActiveStudents();
            }
        }

        function saveActiveStudents() {
            try {
                localStorage.setItem('activeStudents', JSON.stringify(activeStudents));
                // Update studentNames for backward compatibility
                studentNames = {...activeStudents};
            } catch (error) {
                console.error('Error saving active students:', error);
                showMessage('Error saving student data', 'error');
            }
        }

        function populateStudentDropdown() {
            const studentSelect = elements.student;
            if (!studentSelect) return;

            // Clear current options except the first one
            studentSelect.innerHTML = '<option value="">-- Select Student --</option>';

            // Add active students with ID and name display
            Object.keys(activeStudents).sort().forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                
                // Handle both old string format and new object format
                if (typeof activeStudents[key] === 'string') {
                    option.textContent = activeStudents[key]; // Legacy format
                } else {
                    option.textContent = `${activeStudents[key].id} - ${activeStudents[key].name}`;
                }
                
                studentSelect.appendChild(option);
            });

            // Also update filter dropdown if it exists
            updateFilterStudentDropdown();
        }

        function updateFilterStudentDropdown() {
            const filterStudent = elements.filterEmployee; // Keep same element name for backward compatibility
            if (!filterStudent) return;

            const currentValue = filterStudent.value;
            filterStudent.innerHTML = '<option value="">All Students</option>';

            console.log('DROPDOWN DEBUG - activeStudents:', activeStudents);

            // Get unique students from actual attendance data
            const studentsFromData = new Set();
            if (attendanceData && attendanceData.length > 0) {
                attendanceData.forEach(record => {
                    if (record.studentName) studentsFromData.add(record.studentName);
                    if (record.studentId) studentsFromData.add(record.studentId);
                    if (record.student) studentsFromData.add(record.student);
                });
            }

            console.log('DROPDOWN DEBUG - students from data:', Array.from(studentsFromData));

            // Use students from activeStudents if available, otherwise from data
            if (Object.keys(activeStudents).length > 0) {
                Object.keys(activeStudents).sort().forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    
                    // Handle both old string format and new object format
                    if (typeof activeStudents[key] === 'string') {
                        option.textContent = activeStudents[key]; // Legacy format - just the name
                        console.log(`DROPDOWN DEBUG - Legacy: ${key} = "${activeStudents[key]}"`);
                    } else {
                        option.textContent = `${activeStudents[key].id} - ${activeStudents[key].name}`;
                        console.log(`DROPDOWN DEBUG - New: ${key} = "${activeStudents[key].id} - ${activeStudents[key].name}"`);
                    }
                    
                    filterStudent.appendChild(option);
                });
            } else {
                // Fallback: use students from attendance data
                Array.from(studentsFromData).sort().forEach(studentName => {
                    const option = document.createElement('option');
                    option.value = studentName;
                    option.textContent = studentName;
                    filterStudent.appendChild(option);
                });
            }

            // Restore previous selection if still valid
            if (currentValue && activeStudents[currentValue]) {
                filterStudent.value = currentValue;
            }
        }

        function setupStudentManagementListeners() {
            // Manage students button - direct access, no password needed
            if (elements.manageStudentsBtn) {
                console.log('âœ… Manage students button found, adding event listener');
                elements.manageStudentsBtn.addEventListener('click', (event) => {
                    console.log('ðŸ”§ Manage students button clicked!');
                    event.preventDefault();
                    event.stopPropagation();
                    toggleStudentManagementPanel();
                });
            } else {
                console.error('âŒ Manage students button not found!');
            }

            // Close panel button
            if (elements.closeStudentPanel) {
                elements.closeStudentPanel.addEventListener('click', closeStudentManagementPanel);
            }

            // Add student button
            if (elements.addStudentBtn) {
                elements.addStudentBtn.addEventListener('click', addNewStudent);
            }

            // Enter key support for add student inputs
            if (elements.newStudentId) {
                elements.newStudentId.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addNewStudent();
                    }
                });
                
                // Input validation
                elements.newStudentId.addEventListener('input', validateStudentInputs);
            }
            
            if (elements.newStudentName) {
                elements.newStudentName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addNewStudent();
                    }
                });
                
                // Input validation
                elements.newStudentName.addEventListener('input', validateStudentInputs);
            }
        }

        // Prevent rapid toggling
        let isToggling = false;
        
        function toggleStudentManagementPanel() {
            console.log('ðŸ”§ toggleStudentManagementPanel called');
            
            // Prevent rapid clicking
            if (isToggling) {
                console.log('âš ï¸ Still toggling, ignoring click');
                return;
            }
            
            isToggling = true;
            
            const panel = elements.studentManagementPanel;
            const button = document.querySelector('.manage-students-btn');
            console.log('ðŸ”§ Panel element:', panel);
            console.log('ðŸ”§ Button element:', button);
            
            if (!panel) {
                console.error('âŒ Student management panel not found!');
                isToggling = false;
                return;
            }

            console.log('ðŸ”§ Panel current display:', panel.style.display);
            
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                console.log('âœ… Panel shown');
                
                // Update button appearance
                if (button) {
                    button.style.backgroundColor = '#0056b3';
                    button.style.color = 'white';
                    button.setAttribute('aria-expanded', 'true');
                    button.title = 'Hide Student Management';
                }
                
                updateStudentsList();
                // Focus on the input
                setTimeout(() => {
                    if (elements.newStudentName) {
                        elements.newStudentName.focus();
                    }
                    isToggling = false; // Reset flag after animation
                }, 300);
            } else {
                panel.style.display = 'none';
                console.log('âœ… Panel hidden');
                
                // Reset button appearance
                if (button) {
                    button.style.backgroundColor = '';
                    button.style.color = '';
                    button.setAttribute('aria-expanded', 'false');
                    button.title = 'Manage Students';
                }
                
                setTimeout(() => {
                    isToggling = false; // Reset flag after animation
                }, 300);
            }
        }

        function closeStudentManagementPanel() {
            const panel = elements.studentManagementPanel;
            if (panel) {
                panel.style.display = 'none';
            }
            clearStudentInputs();
        }

        function clearStudentInputs() {
            if (elements.newStudentId) elements.newStudentId.value = '';
            if (elements.newStudentName) elements.newStudentName.value = '';
            validateStudentInputs();
        }

        function validateStudentInputs() {
            const idInput = elements.newStudentId;
            const nameInput = elements.newStudentName;
            const addBtn = elements.addStudentBtn;

            if (!nameInput || !addBtn) return;

            const id = idInput ? idInput.value.trim() : '';
            const name = nameInput.value.trim();

            // Validation rules
            const isNameValid = name.length >= 2;
            let isIdValid = true;
            let isIdUnique = true;

            // Check ID if provided
            if (id) {
                isIdValid = /^[A-Za-z0-9]{3,20}$/.test(id); // Allow alphanumeric, 3-20 chars
                isIdUnique = !Object.keys(activeStudents).some(key => {
                    const student = activeStudents[key];
                    if (typeof student === 'string') return false; // Legacy format
                    return student.id && student.id.toLowerCase() === id.toLowerCase();
                });
            }

            // Check name uniqueness
            const isNameUnique = !Object.keys(activeStudents).some(key => {
                const student = activeStudents[key];
                const studentName = typeof student === 'string' ? student : student.name;
                return studentName.toLowerCase() === name.toLowerCase();
            });

            // Update button state
            addBtn.disabled = !(isNameValid && isNameUnique && isIdValid && isIdUnique);

            // Show validation feedback for name
            if (name && !isNameValid) {
                nameInput.style.borderColor = '#e74c3c';
                nameInput.title = 'Name must be at least 2 characters';
            } else if (name && !isNameUnique) {
                nameInput.style.borderColor = '#f39c12';
                nameInput.title = 'A student with this name already exists';
            } else {
                nameInput.style.borderColor = '';
                nameInput.title = '';
            }

            // Show validation feedback for ID
            if (idInput) {
                if (id && !isIdValid) {
                    idInput.style.borderColor = '#e74c3c';
                    idInput.title = 'ID must be 3-20 alphanumeric characters';
                } else if (id && !isIdUnique) {
                    idInput.style.borderColor = '#f39c12';
                    idInput.title = 'This Student ID already exists';
                } else {
                    idInput.style.borderColor = '';
                    idInput.title = '';
                }
            }
        }

        function generateStudentKey(id) {
            // Use the ID as the key, or generate from name for legacy compatibility
            return id || 'LEGACY_' + Date.now();
        }

        function generateNextStudentId() {
            // Find the highest existing STU number
            let maxNum = 0;
            Object.keys(activeStudents).forEach(key => {
                const student = activeStudents[key];
                if (typeof student === 'object' && student.id) {
                    const match = student.id.match(/^STU(\d+)$/);
                    if (match) {
                        maxNum = Math.max(maxNum, parseInt(match[1]));
                    }
                }
            });
            
            // Return next available number with leading zeros
            return `STU${String(maxNum + 1).padStart(3, '0')}`;
        }

        function addNewStudent() {
            console.log('ðŸ”§ Add New Student function called');
            const idInput = elements.newStudentId;
            const nameInput = elements.newStudentName;

            console.log('ðŸ”§ ID Input:', idInput);
            console.log('ðŸ”§ Name Input:', nameInput);

            if (!nameInput) {
                console.log('ðŸ”§ Error: Name input not found');
                showMessage('Name input field not found', 'error');
                return;
            }

            const name = nameInput.value.trim();
            const providedId = idInput ? idInput.value.trim() : '';

            console.log('ðŸ”§ Name value:', name);
            console.log('ðŸ”§ ID value:', providedId);

            // Validate inputs
            if (!name) {
                showMessage('Please enter a student name', 'warning');
                return;
            }

            if (name.length < 2) {
                showMessage('Student name must be at least 2 characters', 'warning');
                return;
            }

            // Generate or use provided ID
            const studentId = providedId || generateNextStudentId();
            console.log('ðŸ”§ Generated/Used ID:', studentId);
            
            // Check for duplicate ID
            const idExists = Object.keys(activeStudents).some(key => {
                const student = activeStudents[key];
                if (typeof student === 'object' && student.id) {
                    return student.id.toLowerCase() === studentId.toLowerCase();
                }
                return false;
            });
            
            if (idExists) {
                showMessage('A student with this ID already exists', 'warning');
                return;
            }

            // Check for duplicate name
            const nameExists = Object.keys(activeStudents).some(key => {
                const student = activeStudents[key];
                const studentName = typeof student === 'string' ? student : student.name;
                return studentName.toLowerCase() === name.toLowerCase();
            });
            
            if (nameExists) {
                showMessage('A student with this name already exists', 'warning');
                return;
            }

            // Generate key from ID
            const key = generateStudentKey(studentId);

            // Add the new student
            activeStudents[key] = { id: studentId, name: name };
            saveActiveStudents();
            populateStudentDropdown();
            updateStudentsList();
            clearStudentInputs();

            showMessage(`Student "${studentId} - ${name}" added successfully!`, 'success');
        }

        function removeStudent(studentKey) {
            if (!activeStudents.hasOwnProperty(studentKey)) {
                showMessage('Student not found', 'error');
                return;
            }

            const student = activeStudents[studentKey];
            const studentName = typeof student === 'string' ? student : (student.name || 'Unknown Student');
            
            // Confirm removal
            if (!confirm(`Are you sure you want to remove "${studentName}" from the student list?\n\nThis will not delete their attendance records, but they will no longer appear in the dropdown for new entries.`)) {
                return;
            }

            // Remove the student
            delete activeStudents[studentKey];
            saveActiveStudents();
            populateStudentDropdown();
            updateStudentsList();

            showMessage(`Student "${studentName}" removed from active list`, 'success');
        }

        function updateStudentsList() {
            const list = elements.studentsList;
            if (!list) return;

            list.innerHTML = '';

            const studentKeys = Object.keys(activeStudents).sort();

            if (studentKeys.length === 0) {
                list.innerHTML = '<div class="no-students-message">No active students. Add students to get started.</div>';
                return;
            }

            studentKeys.forEach(key => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';

                const student = activeStudents[key];
                let displayText;
                
                // Handle both old string format and new object format
                if (typeof student === 'string') {
                    displayText = student; // Legacy format
                } else {
                    displayText = `${student.id} - ${student.name}`;
                }

                studentItem.innerHTML = `
                    <div class="student-info">
                        <div class="student-name">${displayText}</div>
                    </div>
                    <button class="remove-student-btn" onclick="removeStudent('${key}')" title="Remove Student">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                `;

                list.appendChild(studentItem);
            });
        }

        function restoreDefaultStudents() {
            // Restore default students immediately without confirmation
            activeStudents = {...defaultStudentNames};
            saveActiveStudents();
            populateStudentDropdown();
            updateStudentsList();
            showMessage('Default students restored successfully!', 'success');
        }

        // Admin Security Functions
        let pendingAdminAction = null;

        function requestAdminAccess(action) {
            if (isAdminMode) {
                // Already authenticated, execute action directly
                executeAdminAction(action);
                return;
            }

            // Store the pending action and show modal
            pendingAdminAction = action;
            showAdminModal();
        }

        function showAdminModal() {
            const modal = document.getElementById('adminModal');
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('adminError');
            const attemptsDiv = document.getElementById('adminAttempts');
            
            // Reset modal state
            passwordInput.value = '';
            errorDiv.style.display = 'none';
            attemptsDiv.style.display = adminAttempts > 0 ? 'block' : 'none';
            document.getElementById('attemptsCount').textContent = MAX_ATTEMPTS - adminAttempts;
            
            modal.style.display = 'flex';
            setTimeout(() => passwordInput.focus(), 100);
        }

        function closeAdminModal() {
            const modal = document.getElementById('adminModal');
            modal.style.display = 'none';
            pendingAdminAction = null;
        }

        function handleAdminKeyPress(event) {
            if (event.key === 'Enter') {
                validateAdminPassword();
            }
        }

        function validateAdminPassword() {
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('adminError');
            const errorText = document.getElementById('adminErrorText');
            const attemptsDiv = document.getElementById('adminAttempts');
            
            const enteredPassword = passwordInput.value;
            
            if (enteredPassword === getAdminPassword()) {
                // Correct password
                isAdminMode = true;
                adminAttempts = 0;
                closeAdminModal();
                executeAdminAction(pendingAdminAction);
                showMessage('Admin access granted', 'success');
                updateAdminUI();
                
                // Auto-logout after 10 minutes for security
                setTimeout(() => {
                    isAdminMode = false;
                    showMessage('Admin session expired', 'warning');
                    updateAdminUI();
                }, 600000); // 10 minutes
                
            } else {
                // Incorrect password
                adminAttempts++;
                
                if (adminAttempts >= MAX_ATTEMPTS) {
                    // Too many attempts - lock out
                    errorText.textContent = 'Too many failed attempts. Access locked for 5 minutes.';
                    errorDiv.style.display = 'flex';
                    attemptsDiv.style.display = 'none';
                    
                    // Disable the form
                    passwordInput.disabled = true;
                    document.querySelector('.admin-btn-confirm').disabled = true;
                    
                    // Reset attempts after 5 minutes
                    setTimeout(() => {
                        adminAttempts = 0;
                        passwordInput.disabled = false;
                        document.querySelector('.admin-btn-confirm').disabled = false;
                        closeAdminModal();
                    }, 300000); // 5 minutes
                    
                } else {
                    // Show error and remaining attempts
                    errorText.textContent = 'Incorrect password. Please try again.';
                    errorDiv.style.display = 'flex';
                    attemptsDiv.style.display = 'block';
                    document.getElementById('attemptsCount').textContent = MAX_ATTEMPTS - adminAttempts;
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }
        }

        function executeAdminAction(action) {
            switch(action) {
                case 'viewRecords':
                    toggleRecordsView();
                    break;
                case 'clearData':
                    clearAllData();
                    break;
                case 'manageStudents':
                    toggleStudentManagementPanel();
                    break;
                case 'viewSecurityLogs':
                    showSecurityLogsModal();
                    break;
                default:
                    console.error('Unknown admin action:', action);
            }
        }

        function showSecurityLogsModal() {
            const logs = JSON.parse(localStorage.getItem('suspiciousActivity') || '[]');
            
            let modalContent = `
                <div style="max-width: 600px; max-height: 400px; overflow-y: auto;">
                    <h3><i class="fas fa-shield-alt"></i> Security & Fraud Protection Logs</h3>
            `;
            
            if (logs.length === 0) {
                modalContent += `
                    <div style="text-align: center; padding: 20px; color: #27ae60;">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <p><strong>All Clear!</strong></p>
                        <p>No suspicious activity detected.</p>
                    </div>
                `;
            } else {
                modalContent += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                        <strong>âš ï¸ ${logs.length} suspicious activities detected</strong>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                `;
                
                logs.slice(-20).reverse().forEach((log, index) => {
                    const date = new Date(log.timestamp).toLocaleString();
                    modalContent += `
                        <div style="margin-bottom: 10px; padding: 10px; border-left: 3px solid #f39c12; background: #fafafa;">
                            <strong>${date}</strong><br>
                            <span style="color: #e74c3c;">${log.reason}</span><br>
                            <small>Submissions: ${log.submissionCount}</small>
                            ${log.location ? `<br><small>Location: ${log.location.lat.toFixed(4)}, ${log.location.lng.toFixed(4)} (Â±${log.location.accuracy.toFixed(1)}m)</small>` : ''}
                        </div>
                    `;
                });
                
                modalContent += `</div>`;
            }
            
            modalContent += `
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="clearSuspiciousActivityLogs()" style="margin-right: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-trash"></i> Clear Logs
                        </button>
                        <button onclick="closeSecurityModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            // Create and show modal
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'securityModal';
            modalOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            const modalBox = document.createElement('div');
            modalBox.style.cssText = `
                background: white; padding: 20px; border-radius: 8px; 
                box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 90%; max-height: 90%;
            `;
            modalBox.innerHTML = modalContent;
            
            modalOverlay.appendChild(modalBox);
            document.body.appendChild(modalOverlay);
        }

        function closeSecurityModal() {
            const modal = document.getElementById('securityModal');
            if (modal) {
                modal.remove();
            }
        }

        function updateAdminUI() {
            const adminButtons = ['viewRecordsBtn', 'clearBtn', 'manageStudentsBtn'];
            
            adminButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    if (isAdminMode) {
                        button.classList.add('admin-mode-active');
                        const lockIcon = button.querySelector('.admin-lock-icon');
                        if (lockIcon) {
                            lockIcon.style.display = 'none';
                        }
                    } else {
                        button.classList.remove('admin-mode-active');
                        const lockIcon = button.querySelector('.admin-lock-icon');
                        if (lockIcon) {
                            lockIcon.style.display = 'inline';
                        }
                    }
                }
            });
        }

        // Secret admin access (double-click on title)
        let secretClickCount = 0;
        function secretAdminAccess() {
            secretClickCount++;
            if (secretClickCount >= 2) {
                if (!isAdminMode) {
                    isAdminMode = true;
                    updateAdminUI();
                    showMessage('Secret admin access activated', 'success');
                    
                    // Auto-logout after 5 minutes for secret access
                    setTimeout(() => {
                        isAdminMode = false;
                        updateAdminUI();
                        showMessage('Secret admin session expired', 'warning');
                    }, 300000); // 5 minutes
                } else {
                    isAdminMode = false;
                    updateAdminUI();
                    showMessage('Admin mode deactivated', 'info');
                }
                secretClickCount = 0;
            }
            
            // Reset click count after 2 seconds
            setTimeout(() => {
                secretClickCount = 0;
            }, 2000);
        }

        function initializeGeolocation() {
            // Check for geolocation support
            if (!navigator.geolocation) {
                updateLocationStatus('Geolocation not supported by this browser', 'error');
                showMessage('Your browser does not support geolocation', 'error');
                return;
            }

            // Check for secure context (HTTPS)
            if (!window.isSecureContext && location.protocol !== 'file:') {
                updateLocationStatus('Geolocation requires HTTPS', 'error');
                showMessage('Geolocation requires a secure connection (HTTPS)', 'warning');
            }

            // Check current permission status
            checkGeolocationPermission();

            // Start location tracking automatically
            startLocationTracking();

            // Set up control event listeners
            setupLocationControls();

            updateLocationStatus('Initializing location services...', 'info');
        }

        async function checkGeolocationPermission() {
            try {
                if ('permissions' in navigator) {
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    locationPermissionStatus = permission.state;
                    
                    elements.locationPermission = document.getElementById('locationPermission');
                    elements.locationPermission.textContent = permission.state.toUpperCase();
                    elements.locationPermission.className = `permission-status ${permission.state}`;

                    // Listen for permission changes
                    permission.addEventListener('change', () => {
                        locationPermissionStatus = permission.state;
                        elements.locationPermission.textContent = permission.state.toUpperCase();
                        elements.locationPermission.className = `permission-status ${permission.state}`;
                        
                        if (permission.state === 'granted') {
                            startLocationTracking();
                        } else if (permission.state === 'denied') {
                            stopLocationTracking();
                            updateLocationStatus('Location permission denied', 'error');
                        }
                    });
                }
            } catch (error) {
                console.error('Error checking permissions:', error);
            }
        }

        function startLocationTracking() {
            updateLocationStatus('ðŸ“ Getting your location...', 'info');
            showMessage('Requesting location access...', 'info');

            // Start with a simple location request to get permission
            const standardOptions = {
                enableHighAccuracy: true,
                timeout: 30000, // Extended timeout
                maximumAge: 30000 // Allow 30-second old location for initial quick loading
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Got basic location successfully
                    handleLocationSuccess(position);
                    
                    // Start continuous tracking if enabled (default to enabled if element not accessible)
                    const continuousToggle = document.getElementById('continuousTrackingToggle');
                    if (!continuousToggle || continuousToggle.checked) {
                        startWatchingPosition();
                    }
                },
                (error) => {
                    console.warn('Standard location failed:', error);
                    handleLocationError(error);
                },
                standardOptions
            );
        }

        function startWatchingPosition() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }

            const options = getLocationOptions();
            
            watchId = navigator.geolocation.watchPosition(
                handleLocationUpdate,
                handleLocationError,
                options
            );

            updateLocationStatus('Monitoring location changes...', 'active');
        }

        function stopLocationTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            updateLocationStatus('Location tracking stopped', 'warning');
        }

        function getLocationOptions() {
            const isHighAccuracy = document.getElementById('highAccuracyToggle')?.checked ?? true;
            
            return {
                enableHighAccuracy: isHighAccuracy,
                timeout: isHighAccuracy ? 90000 : 30000, // Extended timeout for better GPS lock (90 seconds)
                maximumAge: 0, // Always get fresh readings for best accuracy
                // Additional options for better accuracy
                desiredAccuracy: 10, // Request 10-meter accuracy
                forceGPS: isHighAccuracy // Force GPS when high accuracy is enabled
            };
        }

        // Enhanced location acquisition with multiple attempts and averaging
        async function getEnhancedLocation(showProgress = true) {
            const attempts = 3;
            const positions = [];
            
            if (showProgress) {
                updateLocationStatus('ðŸŽ¯ Enhanced accuracy mode - taking multiple readings...', 'info');
                showMessage('Getting enhanced location accuracy (this may take 10-15 seconds)...', 'info');
            }
            
            // First reading - this will trigger permission if needed
            try {
                const firstPosition = await getCurrentPositionPromise({
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 0
                });
                positions.push(firstPosition);
                
                if (showProgress) {
                    showMessage(`Reading 1/${attempts} complete (${firstPosition.coords.accuracy.toFixed(1)}m)`, 'info');
                }
                
            } catch (error) {
                console.warn('First reading failed:', error.message);
                throw error; // If first reading fails, stop here
            }
            
            // Additional readings (only if first succeeded) - these won't trigger permission popups
            for (let i = 1; i < attempts; i++) {
                try {
                    // Wait 3 seconds between readings for GPS to stabilize
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    const position = await getCurrentPositionPromise({
                        enableHighAccuracy: true,
                        timeout: 20000, // Shorter timeout for subsequent readings
                        maximumAge: 0
                    });
                    
                    positions.push(position);
                    
                    if (showProgress) {
                        showMessage(`Reading ${i + 1}/${attempts} complete (${position.coords.accuracy.toFixed(1)}m)`, 'info');
                    }
                    
                } catch (error) {
                    console.warn(`Reading ${i + 1} failed:`, error.message);
                    // Continue with other readings even if one fails
                }
            }
            
            if (positions.length === 0) {
                throw new Error('Failed to get any location readings');
            }
            
            // Use the most accurate reading or average if similar accuracy
            const bestPosition = getBestPositionFromReadings(positions);
            
            if (showProgress) {
                showMessage(`âœ… Enhanced location complete! Best accuracy: ${bestPosition.coords.accuracy.toFixed(1)}m (from ${positions.length} readings)`, 'success');
            }
            
            return bestPosition;
        }

        function getBestPositionFromReadings(positions) {
            if (positions.length === 1) return positions[0];
            
            // Find the most accurate reading (lowest accuracy value)
            const mostAccurate = positions.reduce((best, current) => 
                current.coords.accuracy < best.coords.accuracy ? current : best
            );
            
            // If multiple readings have similar accuracy (within 20m), average them
            const similarAccuracy = positions.filter(p => 
                Math.abs(p.coords.accuracy - mostAccurate.coords.accuracy) <= 20
            );
            
            if (similarAccuracy.length > 1) {
                // Average the coordinates for better precision
                const avgLat = similarAccuracy.reduce((sum, p) => sum + p.coords.latitude, 0) / similarAccuracy.length;
                const avgLng = similarAccuracy.reduce((sum, p) => sum + p.coords.longitude, 0) / similarAccuracy.length;
                const avgAccuracy = similarAccuracy.reduce((sum, p) => sum + p.coords.accuracy, 0) / similarAccuracy.length;
                
                // Create averaged position
                return {
                    coords: {
                        latitude: avgLat,
                        longitude: avgLng,
                        accuracy: avgAccuracy,
                        altitude: mostAccurate.coords.altitude,
                        altitudeAccuracy: mostAccurate.coords.altitudeAccuracy,
                        heading: mostAccurate.coords.heading,
                        speed: mostAccurate.coords.speed
                    },
                    timestamp: Date.now()
                };
            }
            
            return mostAccurate;
        }

        function setupLocationControls() {
            // High accuracy toggle
            const highAccuracyToggle = document.getElementById('highAccuracyToggle');
            if (highAccuracyToggle) {
                highAccuracyToggle.addEventListener('change', (e) => {
                    isHighAccuracyEnabled = e.target.checked;
                    if (watchId !== null) {
                        startWatchingPosition(); // Restart with new options
                    }
                    showMessage(`High accuracy ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
                });
            }

            // Continuous tracking toggle
            const continuousToggle = document.getElementById('continuousTrackingToggle');
            if (continuousToggle) {
                continuousToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        startWatchingPosition();
                    } else {
                        stopLocationTracking();
                    }
                });
            }

            // Refresh location button
            const refreshBtn = document.getElementById('refreshLocationBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    // Add visual feedback
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('fa-spin');
                    refreshBtn.disabled = true;
                    
                    refreshLocation();
                    
                    // Remove visual feedback after 3 seconds
                    setTimeout(() => {
                        icon.classList.remove('fa-spin');
                        refreshBtn.disabled = false;
                    }, 3000);
                });
            }

            // Force GPS button - Most effective GPS acquisition
            const forceGPSBtn = document.getElementById('forceGPSBtn');
            if (forceGPSBtn) {
                forceGPSBtn.addEventListener('click', async () => {
                    // Add visual feedback
                    const icon = forceGPSBtn.querySelector('i');
                    icon.classList.add('fa-spin');
                    forceGPSBtn.disabled = true;
                    
                    try {
                        const shouldContinue = confirm(
                            'ðŸ›°ï¸ Force GPS Mode will:\n\n' +
                            'â€¢ Keep trying until accuracy is under 100m\n' +
                            'â€¢ Take up to 2 minutes\n' +
                            'â€¢ Use more battery\n' +
                            'â€¢ Work best outdoors or near windows\n\n' +
                            'Continue?'
                        );
                        
                        if (shouldContinue) {
                            await forceHighAccuracyGPS();
                        }
                    } catch (error) {
                        showMessage('Force GPS failed - try moving outdoors or near windows', 'error');
                    }
                    
                    // Remove visual feedback
                    icon.classList.remove('fa-spin');
                    forceGPSBtn.disabled = false;
                });
            }

            // Request permission button
            const permissionBtn = document.getElementById('requestPermissionBtn');
            if (permissionBtn) {
                permissionBtn.addEventListener('click', () => {
                    requestLocationPermission();
                });
            }

            // Auto refresh toggle
            const autoRefreshToggle = document.getElementById('autoRefreshToggle');
            if (autoRefreshToggle) {
                autoRefreshToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        startAutoRefresh();
                        showMessage('Auto refresh enabled - location will update every 15 seconds for better accuracy', 'info');
                    } else {
                        stopAutoRefresh();
                        showMessage('Auto refresh disabled', 'info');
                    }
                });
            }
        }

        function refreshLocation() {
            updateLocationStatus('ðŸ“ Refreshing location...', 'info');
            showMessage('Refreshing location data...', 'info');
            
            // Check permission first
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    console.log('Geolocation permission:', result.state);
                    if (result.state === 'denied') {
                        updateLocationStatus('Location permission denied', 'error');
                        showMessage('Please enable location permission in your browser settings', 'error');
                        return;
                    }
                });
            }
            
            // Use standard refresh (fast and user-friendly)
            const options = {
                ...getLocationOptions(),
                maximumAge: 0 // Force fresh location
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('Location success:', position);
                    handleLocationSuccess(position);
                    showMessage('Location refreshed!', 'success');
                },
                (error) => {
                    console.error('Location error:', error);
                    handleLocationError(error);
                },
                options
            );
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            isAutoRefreshEnabled = true;
            autoRefreshInterval = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    refreshLocation();
                }
            }, 15000); // Reduced to 15 seconds for more frequent updates
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            isAutoRefreshEnabled = false;
        }

        function getCurrentPositionPromise(options) {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        // Force High Accuracy GPS - Keep trying until good accuracy is achieved
        async function forceHighAccuracyGPS() {
            const MAX_ATTEMPTS = 10;
            const TARGET_ACCURACY = 100; // Target accuracy in meters
            const DELAY_BETWEEN_ATTEMPTS = 5000; // 5 seconds between attempts
            
            updateLocationStatus('ðŸ›°ï¸ Force GPS Mode - Searching for satellites...', 'info');
            showMessage('ðŸ›°ï¸ Force GPS Mode started - this may take up to 2 minutes', 'info');
            
            for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
                try {
                    updateLocationStatus(`ðŸ›°ï¸ GPS attempt ${attempt}/${MAX_ATTEMPTS}...`, 'info');
                    
                    const position = await getCurrentPositionPromise({
                        enableHighAccuracy: true,
                        timeout: 15000, // 15 second timeout per attempt
                        maximumAge: 0   // Always get fresh readings
                    });
                    
                    const accuracy = position.coords.accuracy;
                    console.log(`GPS Attempt ${attempt}: ${accuracy.toFixed(1)}m accuracy`);
                    
                    // Update the display with current attempt
                    handleLocationSuccess(position);
                    
                    // Check if we've achieved target accuracy
                    if (accuracy <= TARGET_ACCURACY) {
                        updateLocationStatus(`ðŸŽ¯ Force GPS SUCCESS! ${accuracy.toFixed(1)}m accuracy achieved`, 'success');
                        showMessage(`ðŸŽ¯ Force GPS successful! Accuracy: ${accuracy.toFixed(1)}m (attempt ${attempt}/${MAX_ATTEMPTS})`, 'success');
                        return position;
                    } else {
                        showMessage(`ðŸ“¡ Attempt ${attempt}: ${accuracy.toFixed(1)}m accuracy (target: ${TARGET_ACCURACY}m)`, 'info');
                    }
                    
                    // Wait between attempts (except last attempt)
                    if (attempt < MAX_ATTEMPTS) {
                        updateLocationStatus(`â³ Waiting ${DELAY_BETWEEN_ATTEMPTS/1000}s before next GPS attempt...`, 'info');
                        await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_ATTEMPTS));
                    }
                    
                } catch (error) {
                    console.warn(`GPS Attempt ${attempt} failed:`, error.message);
                    showMessage(`âš ï¸ Attempt ${attempt} failed: ${error.message}`, 'warning');
                    
                    if (attempt < MAX_ATTEMPTS) {
                        await new Promise(resolve => setTimeout(resolve, 2000)); // Shorter delay on error
                    }
                }
            }
            
            // If we get here, all attempts failed to reach target accuracy
            const finalMessage = currentPosition 
                ? `Force GPS completed. Best accuracy achieved: ${currentPosition.coords.accuracy.toFixed(1)}m`
                : 'Force GPS failed - no GPS signal available';
            
            updateLocationStatus(finalMessage, 'warning');
            showMessage(`ðŸ“¡ ${finalMessage}. Try moving outdoors or near windows for better GPS signal.`, 'warning');
            
            throw new Error('Target GPS accuracy not achieved');
        }

        function requestLocationPermission() {
            updateLocationStatus('Requesting location permission...', 'info');
            showMessage('Requesting location access - please allow when prompted', 'info');
            
            // Use a clean permission request with minimal options for first request
            const options = {
                enableHighAccuracy: false, // Start with basic location to avoid delays
                timeout: 15000,
                maximumAge: 0 // Always fresh permission request
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    showMessage('âœ… Location permission granted successfully!', 'success');
                    handleLocationSuccess(position);
                    
                    // Start continuous tracking if enabled (default to enabled if element not accessible)
                    const continuousToggle = document.getElementById('continuousTrackingToggle');
                    if (!continuousToggle || continuousToggle.checked) {
                        startWatchingPosition();
                    }
                    
                    // Update button visibility - hide request button once permission is granted
                    const permissionBtn = document.getElementById('requestPermissionBtn');
                    if (permissionBtn) {
                        permissionBtn.style.display = 'none';
                    }
                },
                (error) => {
                    handleLocationError(error);
                    
                    // Provide user-friendly error messages
                    if (error.code === error.PERMISSION_DENIED) {
                        showMessage('âŒ Location access was denied. Click "Request Permission" to try again.', 'warning');
                        updateLocationStatus('Location permission denied - click "Request Permission" to try again', 'error');
                    } else {
                        showMessage('Location request failed. Please try again.', 'error');
                    }
                },
                options
            );
        }

        async function improveLocationAccuracy() {
            showMessage('ðŸ’¡ Analyzing your location environment...', 'info');
            
            // Detect environment and provide specific guidance
            const environment = await detectEnvironment();
            
            let improvementMessage = `
ðŸŽ¯ **GPS Accuracy Improvement Guide**

**Current Status:**
â€¢ Environment: ${environment.type}
â€¢ Accuracy: ${currentPosition ? currentPosition.coords.accuracy.toFixed(1) + 'm' : 'Unknown'}
â€¢ Location method: ${currentPosition && currentPosition.coords.accuracy <= 50 ? 'GPS satellites' : 'Network/WiFi positioning'}

**Environment Analysis:**
${environment.description}

**Recommended Actions:**
${environment.tips.slice(0, 3).join('\n')}

**Available Options:**
1. Use "Force GPS" for the most accurate location (may take up to 2 minutes)
2. Move to better location (outdoors for GPS, near windows for indoor)  
3. Enable WiFi for indoor positioning
4. Wait longer for GPS satellites to lock

**What affects accuracy:**
â€¢ GPS satellites (outdoor): 3-5m accuracy
â€¢ WiFi networks (indoor): 10-50m accuracy  
â€¢ Cell towers (backup): 100-1000m accuracy
            `;
            
            alert(improvementMessage);
        }

        async function detectEnvironment() {
            // Analyze current location characteristics to suggest improvements
            if (!currentPosition) {
                return {
                    type: "Unknown",
                    description: "No location data available",
                    tips: ["â€¢ Please allow location access first"]
                };
            }
            
            const accuracy = currentPosition.coords.accuracy;
            const hasAltitude = currentPosition.coords.altitude !== null;
            const hasSpeed = currentPosition.coords.speed !== null;
            
            // Determine environment based on accuracy and available data
            if (accuracy <= 10) {
                return {
                    type: "ðŸŒž Outdoor (Excellent GPS)",
                    description: "Strong GPS signal detected",
                    tips: [
                        "â€¢ You have excellent GPS reception!",
                        "â€¢ Current accuracy is optimal",
                        "â€¢ Consider this your reference location"
                    ]
                };
            } else if (accuracy <= 50) {
                return {
                    type: "ðŸžï¸ Outdoor (Good GPS)",
                    description: "Good GPS signal with some interference",
                    tips: [
                        "â€¢ Move away from tall buildings",
                        "â€¢ Avoid areas with thick tree cover",
                        "â€¢ Wait longer for better satellite lock"
                    ]
                };
            } else if (accuracy <= 200) {
                return {
                    type: "ðŸ˜ï¸ Urban/Suburban",
                    description: "Mixed GPS and network positioning",
                    tips: [
                        "â€¢ Try moving to open areas",
                        "â€¢ Enable WiFi for better indoor accuracy",
                        "â€¢ Avoid underground or enclosed areas"
                    ]
                };
            } else if (accuracy <= 1000) {
                return {
                    type: "ðŸ  Indoor (Network-based)",
                    description: "Primarily using WiFi and cell tower positioning",
                    tips: [
                        "â€¢ Connect to known WiFi networks",
                        "â€¢ Move closer to windows",
                        "â€¢ Enable high accuracy mode",
                        "â€¢ Consider moving outdoors for GPS"
                    ]
                };
            } else {
                return {
                    type: "ðŸ¢ Deep Indoor/Basement",
                    description: "Limited positioning accuracy",
                    tips: [
                        "â€¢ Move to upper floors if possible",
                        "â€¢ Go near windows or entrances",
                        "â€¢ Enable all location services",
                        "â€¢ Connect to WiFi networks",
                        "â€¢ Consider recording attendance outdoors"
                    ]
                };
            }
        }

        function getLocationImprovementTips() {
            return [
                "â€¢ Turn on WiFi (even if not connected)",
                "â€¢ Enable 'High Accuracy' location mode",
                "â€¢ Restart location services if needed",
                "â€¢ Clear view of sky improves GPS",
                "â€¢ Hold device steady for 30+ seconds",
                "â€¢ Close unnecessary apps using location",
                "â€¢ Ensure location permissions are granted"
            ];
        }

        function handleLocationSuccess(position) {
            currentPosition = position;
            lastKnownPosition = position;
            const { latitude, longitude, accuracy, altitude, speed, heading } = position.coords;
            const timestamp = new Date(position.timestamp);

            // Update form fields
            elements.latitude.value = latitude.toFixed(6);
            elements.longitude.value = longitude.toFixed(6);

            // Update display with comprehensive information
            updateLocationDisplay(position);
            
            // Update status
            const quality = getLocationQuality(accuracy);
            updateLocationStatus(`Location acquired (${quality.label})`, 'active');
            
            // Get address from coordinates (maps link is handled separately)
            getAddressFromCoordinates(latitude, longitude);
        }

        function handleLocationUpdate(position) {
            // Check if this is a significant position change or accuracy improvement
            if (lastKnownPosition) {
                const distance = calculateDistance(
                    lastKnownPosition.coords.latitude,
                    lastKnownPosition.coords.longitude,
                    position.coords.latitude,
                    position.coords.longitude
                );
                
                // Update if moved more than 2 meters OR accuracy improved by 5m OR new reading is much more accurate
                const accuracyImprovement = lastKnownPosition.coords.accuracy - position.coords.accuracy;
                const isMuchMoreAccurate = position.coords.accuracy < lastKnownPosition.coords.accuracy * 0.7;
                
                if (distance < 2 && accuracyImprovement < 5 && !isMuchMoreAccurate) {
                    return; // Skip minor updates
                }
            }

            handleLocationSuccess(position);
            locationUpdateCount++;
            document.getElementById('locationUpdates').textContent = locationUpdateCount;
        }

        function handleLocationError(error) {
            let message, statusClass;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied by user';
                    statusClass = 'error';
                    showMessage('Please enable location access in your browser settings', 'warning');
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable';
                    statusClass = 'warning';
                    showMessage('Unable to determine your location. Check your connection and GPS.', 'warning');
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out';
                    statusClass = 'warning';
                    showMessage('Location request took too long. Trying again...', 'info');
                    // Retry with less strict options
                    setTimeout(() => {
                        const fallbackOptions = {
                            enableHighAccuracy: false,
                            timeout: 15000,
                            maximumAge: 600000 // 10 minutes
                        };
                        navigator.geolocation.getCurrentPosition(
                            handleLocationSuccess,
                            () => showMessage('Location unavailable', 'error'),
                            fallbackOptions
                        );
                    }, 2000);
                    break;
                default:
                    message = `Location error: ${error.message}`;
                    statusClass = 'error';
                    showMessage(`Location Error: ${error.message}`, 'error');
                    break;
            }
            
            updateLocationStatus(message, statusClass);
            
            // Update permission status if needed
            if (error.code === error.PERMISSION_DENIED) {
                const permissionElement = document.getElementById('locationPermission');
                if (permissionElement) {
                    permissionElement.textContent = 'DENIED';
                    permissionElement.className = 'permission-status denied';
                }
            }
        }

        function updateLocationDisplay(position) {
            const { latitude, longitude, accuracy, altitude, speed, heading, altitudeAccuracy } = position.coords;
            const timestamp = new Date(position.timestamp);

            // Update basic coordinates
            elements.displayLatitude.textContent = latitude.toFixed(6);
            elements.displayLongitude.textContent = longitude.toFixed(6);
            elements.locationAccuracy.textContent = Math.round(accuracy);

            // Update accuracy description and icon
            updateAccuracyDisplay(accuracy);

            // Update additional data with enhanced formatting
            const altitudeElement = document.getElementById('locationAltitude');
            const altitudeAccuracyElement = document.getElementById('altitudeAccuracy');
            if (altitudeElement && altitudeAccuracyElement) {
                if (altitude !== null) {
                    altitudeElement.textContent = `${Math.round(altitude)}m`;
                    altitudeAccuracyElement.textContent = altitudeAccuracy ? `(Â±${Math.round(altitudeAccuracy)}m)` : '';
                } else {
                    altitudeElement.textContent = 'Not available';
                    altitudeAccuracyElement.textContent = '';
                }
            }

            const speedElement = document.getElementById('locationSpeed');
            const speedUnitElement = document.getElementById('speedUnit');
            if (speedElement && speedUnitElement) {
                if (speed !== null) {
                    const kmh = (speed * 3.6).toFixed(1);
                    speedElement.textContent = kmh;
                    speedUnitElement.textContent = 'km/h';
                    
                    // Add speed category
                    if (speed > 0.5) { // Moving
                        speedUnitElement.textContent += ' ðŸš¶';
                    }
                } else {
                    speedElement.textContent = 'Not available';
                    speedUnitElement.textContent = '';
                }
            }

            const headingElement = document.getElementById('locationHeading');
            const compassElement = document.getElementById('compassDirection');
            if (headingElement && compassElement) {
                if (heading !== null) {
                    headingElement.textContent = `${Math.round(heading)}Â°`;
                    const direction = getCardinalDirection(heading);
                    compassElement.textContent = `(${direction}) ${getCompassEmoji(heading)}`;
                } else {
                    headingElement.textContent = 'Not available';
                    compassElement.textContent = '';
                }
            }

            const timestampElement = document.getElementById('locationTimestamp');
            const timeAgoElement = document.getElementById('timeAgo');
            if (timestampElement && timeAgoElement) {
                timestampElement.textContent = timestamp.toLocaleTimeString();
                const now = new Date();
                const diffSeconds = Math.floor((now - timestamp) / 1000);
                timeAgoElement.textContent = getTimeAgoText(diffSeconds);
            }

            // Update quality indicator with icon and recommendation
            const qualityElement = document.getElementById('locationQuality');
            const qualityIconElement = document.getElementById('qualityIcon');
            if (qualityElement && qualityIconElement) {
                const quality = getLocationQuality(accuracy);
                qualityElement.textContent = quality.label;
                qualityElement.className = `quality-indicator ${quality.class}`;
                qualityIconElement.innerHTML = getQualityIcon(quality.class);
                
                // Show recommendation
                showLocationRecommendation(quality);
            }

            // Update map links
            updateMapLinks(latitude, longitude);

            // Update full coordinates display
            updateFullCoordinates(position);

            // Update update rate if applicable
            updateLocationRate();
        }

        function updateAccuracyDisplay(accuracy) {
            const accuracyIcon = document.getElementById('accuracyIcon');
            const accuracyDescription = document.getElementById('accuracyDescription');
            
            if (accuracyIcon && accuracyDescription) {
                let icon, description, color, tips = '';
                
                if (accuracy <= 5) {
                    icon = 'ðŸŽ¯';
                    description = 'Perfect - Excellent outdoor GPS (Survey grade)';
                    color = 'var(--success-color)';
                    tips = 'Optimal accuracy achieved!';
                } else if (accuracy <= 10) {
                    icon = 'ï¿½';
                    description = 'Excellent - Perfect outdoor GPS signal';
                    color = 'var(--success-color)';
                    tips = 'Great accuracy for all uses';
                } else if (accuracy <= 50) {
                    icon = 'âœ…';
                    description = 'Very Good - Strong GPS signal';
                    color = 'var(--success-color)';
                    tips = 'Excellent for outdoor tracking';
                } else if (accuracy <= 100) {
                    icon = 'ðŸ‘';
                    description = 'Good - Reliable GPS/Network positioning';
                    color = 'var(--primary-color)';
                    tips = 'Good for most tracking needs';
                } else if (accuracy <= 200) {
                    icon = 'ðŸ“';
                    description = 'Fair - Moderate accuracy (Urban/Suburban)';
                    color = 'var(--primary-color)';
                    tips = 'Try moving to open area for better GPS';
                } else if (accuracy <= 500) {
                    icon = 'ðŸ“±';
                    description = 'Fair - Network/WiFi positioning (Mixed environment)';
                    color = 'var(--warning-color)';
                    tips = 'Enable WiFi or move outdoors for better accuracy';
                } else if (accuracy <= 1000) {
                    icon = 'ðŸ˜ï¸';
                    description = 'Indoor/Urban - WiFi and cell tower location';
                    color = 'var(--warning-color)';
                    tips = 'Connect to WiFi networks for better indoor accuracy';
                } else if (accuracy <= 2500) {
                    icon = 'ðŸ ';
                    description = 'Indoor Mode - WiFi/Network positioning (Perfect for office/home attendance)';
                    color = '#9b59b6';
                    tips = 'âœ… Ideal for indoor attendance tracking - Normal accuracy for buildings';
                } else if (accuracy <= 5000) {
                    icon = 'ðŸ¢';
                    description = 'Deep Indoor - Building positioning (Acceptable for attendance)';
                    color = '#e67e22';
                    tips = 'Good for attendance - Try moving near windows for better signal';
                } else {
                    icon = 'âŒ';
                    description = 'Very Poor - Limited location services';
                    color = 'var(--error-color)';
                    tips = 'Check location permissions and try moving outdoors';
                }
                
                accuracyIcon.textContent = icon;
                accuracyDescription.textContent = description;
                accuracyDescription.style.color = color;
                
                // Update tooltip with improvement tips
                const accuracyElement = document.getElementById('locationAccuracy');
                if (accuracyElement) {
                    accuracyElement.title = `${accuracy.toFixed(1)}m accuracy - ${tips}`;
                }
                
                // No automatic popups - user can choose to improve GPS manually
            }
        }

        function updateMapLinks(lat, lng) {
            // Update OpenStreetMap link
            const mapLink = document.getElementById('mapLink');
            if (mapLink) {
                mapLink.href = `https://www.openstreetmap.org/#map=18/${lat}/${lng}`;
                mapLink.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }

            // Update Google Maps link
            const googleMapsLink = document.getElementById('googleMapsLink');
            if (googleMapsLink) {
                googleMapsLink.href = `https://www.google.com/maps?q=${lat},${lng}&z=18`;
            }

            // Update Apple Maps link
            const appleMapsLink = document.getElementById('appleMapsLink');
            if (appleMapsLink) {
                appleMapsLink.href = `https://maps.apple.com/?q=${lat},${lng}&z=18`;
            }
        }

        function updateFullCoordinates(position) {
            const fullCoordinatesElement = document.getElementById('fullCoordinates');
            if (fullCoordinatesElement) {
                const { latitude, longitude, accuracy, altitude, speed, heading } = position.coords;
                const timestamp = new Date(position.timestamp);
                
                // Determine location method based on accuracy
                let locationMethod = '';
                if (accuracy <= 50) {
                    locationMethod = ' (GPS)';
                } else if (accuracy <= 200) {
                    locationMethod = ' (GPS/Network)';
                } else if (accuracy <= 1000) {
                    locationMethod = ' (WiFi/Network)';
                } else {
                    locationMethod = ' (Indoor/Network)';
                }
                
                const coordString = 
                    `ðŸ“ Lat: ${latitude.toFixed(6)}Â°, Lng: ${longitude.toFixed(6)}Â°` +
                    ` | ðŸŽ¯ Accuracy: Â±${Math.round(accuracy)}m${locationMethod}` +
                    (altitude !== null ? ` | ðŸ“ Alt: ${Math.round(altitude)}m` : '') +
                    (speed !== null ? ` | ðŸš— Speed: ${(speed * 3.6).toFixed(1)}km/h` : '') +
                    (heading !== null ? ` | ðŸ§­ Heading: ${Math.round(heading)}Â°` : '') +
                    ` | ðŸ• ${timestamp.toLocaleString()}`;
                
                fullCoordinatesElement.textContent = coordString;
            }
        }

        function updateLocationRate() {
            const updateRateElement = document.getElementById('updateRate');
            if (updateRateElement && locationUpdateCount > 1) {
                const isHighAccuracy = document.getElementById('highAccuracyToggle')?.checked;
                const expectedRate = isHighAccuracy ? '~30s' : '~60s';
                updateRateElement.textContent = `(${expectedRate} interval)`;
            }
        }

        function getTimeAgoText(seconds) {
            if (seconds < 5) return '(just now) ðŸŸ¢';
            if (seconds < 30) return `(${seconds}s ago) ðŸŸ¢`;
            if (seconds < 60) return `(${seconds}s ago) ðŸŸ¡`;
            if (seconds < 300) return `(${Math.floor(seconds/60)}m ago) ðŸŸ¡`; // 5 minutes
            if (seconds < 3600) return `(${Math.floor(seconds/60)}m ago) ðŸŸ `;
            return `(${Math.floor(seconds/3600)}h ago) ðŸ”´`;
        }

        function getQualityIcon(qualityClass) {
            const icons = {
                'excellent': '<i class="fas fa-medal" style="color: var(--success-color);"></i>',
                'good': '<i class="fas fa-thumbs-up" style="color: var(--primary-color);"></i>',
                'fair': '<i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>',
                'poor': '<i class="fas fa-times-circle" style="color: var(--error-color);"></i>'
            };
            return icons[qualityClass] || '';
        }

        function getCompassEmoji(heading) {
            const directions = ['ðŸ§­N', 'ðŸ§­NE', 'ðŸ§­E', 'ðŸ§­SE', 'ðŸ§­S', 'ðŸ§­SW', 'ðŸ§­W', 'ðŸ§­NW'];
            const index = Math.round(heading / 45) % 8;
            return directions[index];
        }

        function showLocationRecommendation(quality) {
            const recommendationElement = document.getElementById('locationRecommendation');
            const recommendationText = document.getElementById('recommendationText');
            
            if (recommendationElement && recommendationText) {
                recommendationText.textContent = `${quality.icon} ${quality.recommendation}`;
                recommendationElement.className = `location-recommendation ${quality.class}`;
                recommendationElement.style.display = 'block';
                
                // Auto-hide excellent/good recommendations after 5 seconds
                if (quality.class === 'excellent' || quality.class === 'good') {
                    setTimeout(() => {
                        recommendationElement.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Copy functionality
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage(`Copied: ${text}`, 'success');
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage(`Copied: ${text}`, 'success');
            } catch (error) {
                showMessage('Copy failed - please select and copy manually', 'error');
            }
            textArea.remove();
        }

        function copyFullCoordinates() {
            const fullCoordinatesElement = document.getElementById('fullCoordinates');
            if (fullCoordinatesElement && fullCoordinatesElement.textContent !== '--') {
                copyToClipboard(fullCoordinatesElement.textContent);
            } else {
                showMessage('No coordinates available to copy', 'warning');
            }
        }

        function showPermissionHelp() {
            const helpMessage = 
                'ðŸ“ Location Permission Help:\n\n' +
                'ðŸŸ¢ GRANTED: Location access is allowed\n' +
                'ðŸ”´ DENIED: Location access is blocked\n' +
                'ðŸŸ¡ PROMPT: Browser will ask for permission\n\n' +
                'To fix denied permission:\n' +
                '1. Click the lock icon in address bar\n' +
                '2. Set Location to "Allow"\n' +
                '3. Refresh the page\n\n' +
                'For better accuracy:\n' +
                'â€¢ Enable GPS on your device\n' +
                'â€¢ Move to an open area\n' +
                'â€¢ Wait for GPS to stabilize';
            
            showMessage(helpMessage, 'info');
        }

        function updateLocationStatus(message, statusClass) {
            const statusIndicator = document.getElementById('locationStatusIndicator');
            const statusText = document.getElementById('locationStatusText');
            const locationTips = document.getElementById('locationTips');
            
            if (statusIndicator && statusText) {
                statusText.textContent = message;
                statusIndicator.className = `status-indicator ${statusClass}`;
            }

            // Show tips for poor accuracy
            if (locationTips) {
                if (message.includes('Poor') || statusClass === 'warning' || statusClass === 'error') {
                    locationTips.style.display = 'block';
                } else if (statusClass === 'active') {
                    locationTips.style.display = 'none';
                }
            }

            // Also update the header status
            if (elements.locationStatus) {
                elements.locationStatus.textContent = message;
                elements.locationStatus.style.color = getStatusColor(statusClass);
            }
        }

        function getStatusColor(statusClass) {
            const colors = {
                'active': '#27ae60',
                'error': '#e74c3c',
                'warning': '#f39c12',
                'info': '#3498db'
            };
            return colors[statusClass] || '#6c757d';
        }

        function getLocationQuality(accuracy) {
            if (accuracy <= 10) {
                return { 
                    label: 'Excellent', 
                    class: 'excellent',
                    recommendation: 'Perfect outdoor GPS signal!',
                    icon: 'ðŸŽ¯'
                };
            } else if (accuracy <= 50) {
                return { 
                    label: 'Very Good', 
                    class: 'excellent',
                    recommendation: 'Strong GPS signal - great accuracy',
                    icon: 'âœ…'
                };
            } else if (accuracy <= 200) {
                return { 
                    label: 'Good', 
                    class: 'good',
                    recommendation: 'Good accuracy for attendance tracking',
                    icon: 'ðŸ‘'
                };
            } else if (accuracy <= 1000) {
                return { 
                    label: 'Fair', 
                    class: 'fair',
                    recommendation: 'Network/WiFi location - suitable for indoor use',
                    icon: 'ðŸ“±'
                };
            } else if (accuracy <= 5000) {
                return { 
                    label: 'Indoor', 
                    class: 'indoor',
                    recommendation: 'ðŸ  Indoor Mode Active - Excellent for office/home attendance tracking',
                    icon: 'ðŸ '
                };
            } else {
                return { 
                    label: 'Poor', 
                    class: 'poor',
                    recommendation: 'No location services - check device settings',
                    icon: 'âŒ'
                };
            }
        }

        function getCardinalDirection(heading) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 
                              'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(heading / 22.5) % 16;
            return directions[index];
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        // Address Enhancement Functions
        function refreshAddress() {
            if (!currentPosition) {
                showMessage('No location available to refresh address', 'warning');
                return;
            }
            
            const lat = currentPosition.coords.latitude;
            const lng = currentPosition.coords.longitude;
            
            elements.locationAddress.textContent = 'Refreshing address...';
            showMessage('Refreshing address information...', 'info');
            
            getAddressFromCoordinates(lat, lng);
        }

        async function getAddressFromCoordinates(lat, lng) {
            try {
                // Using a free geocoding service
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
                const data = await response.json();
                
                if (data) {
                    const formattedAddress = formatAddressData(data);
                    
                    // Add accuracy context to address display
                    const accuracy = currentPosition ? currentPosition.coords.accuracy : null;
                    let addressWithContext = formattedAddress;
                    
                    if (accuracy && accuracy > 1000) {
                        addressWithContext += ` ðŸ“ (Indoor positioning - ${(accuracy/1000).toFixed(1)}km radius)`;
                    } else if (accuracy && accuracy > 200) {
                        addressWithContext += ` ðŸ“ (Network positioning - ${Math.round(accuracy)}m accuracy)`;
                    }
                    
                    elements.locationAddress.textContent = addressWithContext;
                } else {
                    elements.locationAddress.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                }
            } catch (error) {
                console.warn('Geocoding failed:', error);
                elements.locationAddress.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }

        function formatAddressData(data) {
            // Extract and clean address components with priority for detailed location
            const components = {
                street: data.road || data.street || '',
                area: data.suburb || data.neighbourhood || data.quarter || '',
                district: data.city_district || data.district || '',
                city: data.city || data.locality || data.town || data.village || '',
                region: data.principality || data.state || data.region || '',
                country: cleanCountryName(data.countryName || data.country || ''),
                // Add more specific location details
                building: data.building || data.house || '',
                postcode: data.postcode || data.postal_code || '',
                landmark: data.amenity || data.leisure || data.shop || ''
            };

            // Build address parts with priority for specific details
            const addressParts = [];
            
            // Add building/house number if available
            if (components.building) {
                addressParts.push(components.building);
            }
            
            // Add street (high priority for specific location)
            if (components.street) {
                addressParts.push(components.street);
            }
            
            // Add landmark/amenity for more context
            if (components.landmark && components.landmark !== components.street) {
                addressParts.push(components.landmark);
            }
            
            // Add area/neighborhood (important for specific location)
            if (components.area && 
                components.area !== components.street && 
                components.area !== components.landmark) {
                addressParts.push(components.area);
            }
            
            // Add district if it adds value
            if (components.district && 
                components.district !== components.area && 
                components.district !== components.city &&
                !components.area.includes(components.district)) {
                addressParts.push(components.district);
            }
            
            // Add city (always important)
            if (components.city) {
                addressParts.push(components.city);
            }
            
            // Add postcode for more precision
            if (components.postcode) {
                addressParts.push(components.postcode);
            }
            
            // Add region only if it's different from city and adds value
            if (components.region && 
                components.region !== components.city && 
                !components.city.includes(components.region) &&
                components.region.length < 20) { // Avoid very long region names
                addressParts.push(components.region);
            }
            
            // Add country (but only if we have other details, otherwise show more info)
            if (addressParts.length > 0 && components.country) {
                addressParts.push(components.country);
            }
            
            // Join with commas and clean up
            let formattedAddress = addressParts.join(', ');
            
            // Remove duplicates and clean up
            formattedAddress = removeDuplicateWords(formattedAddress);
            
            // If we don't have enough specific details, try to get more from display_name
            if (!formattedAddress || formattedAddress.length < 10 || addressParts.length < 2) {
                if (data.display_name) {
                    // Use display name but clean it and prioritize first 3-4 meaningful parts
                    const cleaned = cleanDisplayName(data.display_name);
                    if (cleaned.length > formattedAddress.length) {
                        formattedAddress = cleaned;
                    }
                }
                
                // Final fallback - but try to be more specific than just city, country
                if (!formattedAddress || formattedAddress.length < 5) {
                    if (components.city && components.country) {
                        formattedAddress = `${components.city}, ${components.country}`;
                    } else {
                        return 'Location detected';
                    }
                }
            }
            
            return formattedAddress;
        }

        function cleanCountryName(country) {
            if (!country) return '';
            
            // Remove unnecessary suffixes and clean up country names
            return country
                .replace(/\s*\(the\)\s*/gi, '') // Remove "(the)"
                .replace(/\s*\(.*?\)\s*/g, '')   // Remove any other parenthetical content
                .replace(/^the\s+/gi, '')        // Remove "the" at the beginning
                .trim();
        }

        function cleanDisplayName(displayName) {
            if (!displayName) return '';
            
            // Clean up the display name by removing unnecessary elements
            let cleaned = displayName
                .replace(/\s*\(the\)\s*/gi, '') // Remove "(the)"
                .replace(/\s*\(.*?\)\s*/g, '')   // Remove parenthetical content
                .replace(/^the\s+/gi, '');       // Remove "the" at the beginning
            
            // Split by comma and take meaningful parts
            const parts = cleaned.split(',').map(part => part.trim()).filter(part => part.length > 0);
            
            // Prioritize more specific location parts (first 2-3 parts usually most specific)
            let relevantParts = [];
            
            // Take first part (usually most specific - street/building)
            if (parts.length > 0 && parts[0].length > 2) {
                relevantParts.push(parts[0]);
            }
            
            // Take second part if it's different and adds specificity
            if (parts.length > 1 && parts[1].length > 2 && 
                !parts[0].toLowerCase().includes(parts[1].toLowerCase())) {
                relevantParts.push(parts[1]);
            }
            
            // Take third part if it's a neighborhood/area (not too generic)
            if (parts.length > 2 && parts[2].length > 2 && parts[2].length < 30 &&
                !parts[2].toLowerCase().includes('emirate') && 
                !parts[2].toLowerCase().includes('country') &&
                !relevantParts.some(part => part.toLowerCase().includes(parts[2].toLowerCase()))) {
                relevantParts.push(parts[2]);
            }
            
            // Add city if we don't have enough specificity
            if (relevantParts.length < 2 && parts.length > 3) {
                const cityPart = parts.find(part => 
                    part.toLowerCase().includes('sharjah') || 
                    part.toLowerCase().includes('dubai') ||
                    part.toLowerCase().includes('abu dhabi') ||
                    (part.length > 3 && part.length < 20)
                );
                if (cityPart && !relevantParts.includes(cityPart)) {
                    relevantParts.push(cityPart);
                }
            }
            
            // Ensure we have at least 2 parts for specificity, but not more than 4
            if (relevantParts.length < 2 && parts.length > relevantParts.length) {
                relevantParts = parts.slice(0, Math.min(3, parts.length));
            }
            relevantParts = relevantParts.slice(0, 4);
            
            return relevantParts.join(', ');
        }

        function removeDuplicateWords(address) {
            const parts = address.split(',').map(part => part.trim());
            const uniqueParts = [];
            const seen = new Set();
            
            for (const part of parts) {
                // Normalize for comparison (lowercase, no extra spaces)
                const normalized = part.toLowerCase().replace(/\s+/g, ' ');
                if (!seen.has(normalized) && part.length > 0) {
                    seen.add(normalized);
                    uniqueParts.push(part);
                }
            }
            
            return uniqueParts.join(', ');
        }

        function updateCurrentTime() {
            const now = new Date();
            elements.currentDate.textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            elements.currentTime.textContent = now.toLocaleTimeString('en-US', {
                hour12: true,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function updateLocationTimestamps() {
            if (currentPosition && currentPosition.timestamp) {
                const timeAgoElement = document.getElementById('timeAgo');
                if (timeAgoElement) {
                    const now = new Date();
                    const locationTime = new Date(currentPosition.timestamp);
                    const diffSeconds = Math.floor((now - locationTime) / 1000);
                    timeAgoElement.textContent = getTimeAgoText(diffSeconds);
                    
                    // Change color based on age
                    if (diffSeconds > 300) { // 5 minutes
                        timeAgoElement.style.color = 'var(--error-color)';
                    } else if (diffSeconds > 120) { // 2 minutes
                        timeAgoElement.style.color = 'var(--warning-color)';
                    } else {
                        timeAgoElement.style.color = 'var(--success-color)';
                    }
                }
            }
        }

        let dateTimeUserEdited = false;
        
        function updateDateTime() {
            // Only auto-update if user hasn't manually edited the datetime
            if (!dateTimeUserEdited) {
                const now = new Date();
                const isoString = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString();
                elements.dateTime.value = isoString.slice(0, 16);
            }
        }

        function updateNotesCounter() {
            const maxLength = 500;
            const currentLength = this.value.length;
            const remaining = maxLength - currentLength;
            
            // Find or create counter element
            let counter = document.getElementById('notes-counter');
            if (!counter) {
                counter = document.createElement('small');
                counter.id = 'notes-counter';
                counter.className = 'form-help notes-counter';
                counter.style.cssText = 'float: right; margin-top: 2px;';
                
                const helpElement = document.getElementById('notes-help');
                if (helpElement) {
                    helpElement.parentNode.insertBefore(counter, helpElement.nextSibling);
                }
            }
            
            counter.textContent = `${currentLength}/${maxLength} characters`;
            
            // Color code based on remaining characters
            if (remaining < 50) {
                counter.style.color = '#e74c3c'; // Red
            } else if (remaining < 100) {
                counter.style.color = '#f39c12'; // Orange  
            } else {
                counter.style.color = 'var(--text-secondary)'; // Normal
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            console.log('ðŸš€ Form submission started');
            
            // Prevent multiple submissions
            if (elements.form.classList.contains('submitting')) {
                console.log('âš ï¸ Form already submitting, ignoring');
                return;
            }
            
            // Mark form as submitting
            elements.form.classList.add('submitting');
            
            // Show loading with immediate timeout fallback
            showLoading(true);
            
            // Shorter timeout for safety
            const timeoutId = setTimeout(() => {
                console.log('â° Submission timeout reached');
                showLoading(false);
                elements.form.classList.remove('submitting');
                showMessage('âš ï¸ Request timed out - attendance saved locally', 'warning');
            }, 5000); // Reduced to 5 seconds
            
            try {
                console.log('ðŸ” Validating form...');
                
                // Validate form
                if (!validateForm()) {
                    console.log('âŒ Form validation failed');
                    clearTimeout(timeoutId);
                    showLoading(false);
                    elements.form.classList.remove('submitting');
                    return;
                }
                
                console.log('âœ… Form validation passed');
                
                // Create attendance record
                const record = createAttendanceRecord();
                console.log('ðŸ“ Record created:', record);
                
                // Check for penalties if student is marked present
                let penaltyApplied = false;
                if (record.attendanceStatus === 'present') {
                    try {
                        const attendanceTime = record.time;
                        console.log('ðŸ•’ Checking penalty for time:', attendanceTime);
                        
                        if (isLateArrival(attendanceTime)) {
                            const penalty = addPenalty(record.studentName, attendanceTime, record.date);
                            penaltyApplied = true;
                            console.log('âš ï¸ Penalty applied:', penalty);
                            
                            // Add penalty info to the success message later
                            record.penaltyApplied = true;
                            record.penaltyAmount = penalty.amount;
                        }
                    } catch (penaltyError) {
                        console.error('âŒ Error applying penalty:', penaltyError);
                        // Don't block submission for penalty errors
                    }
                }
                
                // Always save locally first (primary storage)
                attendanceData.unshift(record);
                console.log('ðŸ’¾ Saved to local array');
                
                // Save to localStorage immediately
                try {
                    let localData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                    localData.unshift(record);
                    localStorage.setItem('attendanceData', JSON.stringify(localData));
                    console.log('ðŸ’¾ Saved to localStorage');
                } catch (storageError) {
                    console.error('âŒ localStorage error:', storageError);
                }
                
                // Try Firebase only if enabled and available
                let firebaseSuccess = false;
                if (window.firebase && navigator.onLine) {
                    try {
                        console.log('â˜ï¸ Attempting Firebase save...');
                        await saveDataToFirestore(record);
                        firebaseSuccess = true;
                        console.log('â˜ï¸ Firebase save successful');
                    } catch (firebaseError) {
                        console.error('â˜ï¸ Firebase error:', firebaseError);
                        // Firebase error already handled in saveDataToFirestore
                    }
                }
                
                // Show success message
                const studentInfo = activeStudents[record.student];
                let studentName = record.studentName;
                if (typeof studentInfo === 'object') {
                    studentName = `${studentInfo.id} - ${studentInfo.name}`;
                }
                
                const storageType = firebaseSuccess ? 'Cloud & Local' : 'Local Storage';
                let successMessage = `âœ… Attendance recorded for ${studentName} (${storageType})`;
                
                // Add penalty information if applicable
                if (penaltyApplied && record.penaltyAmount) {
                    successMessage += `\nâš ï¸ Late arrival penalty: ${record.penaltyAmount} AED`;
                    successMessage += `\nðŸ•’ Attendance not between 1 PM - 1:30 PM`;
                }
                
                showMessage(successMessage, 'success');
                console.log('âœ… Success message shown');
                
                // Reset form
                resetForm();
                console.log('ðŸ”„ Form reset');
                
                // Update displays if records are visible
                if (elements.recordsSection && elements.recordsSection.style.display !== 'none') {
                    displayRecords();
                    updateStatistics();
                    console.log('ðŸ“Š Displays updated');
                }
                
            } catch (error) {
                console.error('âŒ Submission error:', error);
                showMessage(`âŒ Error: ${error.message}`, 'error');
            } finally {
                // Always clear loading and submission state
                clearTimeout(timeoutId);
                showLoading(false);
                elements.form.classList.remove('submitting');
                console.log('ðŸ Form submission completed');
            }
        }

        function updateSubmissionTracking() {
            const now = Date.now();
            
            // Update tracking variables
            lastSubmissionTime = now;
            lastSubmittedStudent = elements.student.value;
            submissionCount++;
            hourlySubmissions.push(now);
            
            // Clean old submissions
            hourlySubmissions = hourlySubmissions.filter(time => now - time < 3600000);
            
            // Save fraud protection data to persist across page reloads
            saveFraudProtectionData();
            
            // Immediately update the UI to show new status
            cachedStatus = ''; // Clear cache to force refresh
            updateFraudProtectionUI();
        }

        function validateForm() {
            console.log('ðŸ” Starting form validation');
            
            if (!elements.student || !elements.attendanceStatus) {
                console.error('âŒ Form elements not found');
                showMessage('Form elements not properly loaded. Please refresh the page.', 'error');
                return false;
            }
            
            const student = elements.student.value;
            const attendanceStatus = elements.attendanceStatus.value;
            
            console.log('ðŸ“ Form values:', { student, attendanceStatus });
            
            if (!student) {
                showMessage('Please select a student', 'warning');
                elements.student.focus();
                return false;
            }
            
            if (!attendanceStatus) {
                showMessage('Please select Present or Absent', 'warning');
                return false;
            }
            
            if (!currentPosition) {
                showMessage('Location not available. Please wait for location to be acquired.', 'warning');
                return false;
            }
            
            console.log('âœ… Form validation passed');
            return true;
        }

        function createAttendanceRecord() {
            // Use the selected date/time from the input field, or current time as fallback
            let selectedDateTime;
            if (elements.dateTime.value && elements.dateTime.value.trim() !== '') {
                selectedDateTime = new Date(elements.dateTime.value);
                // Check if the date is valid
                if (isNaN(selectedDateTime.getTime())) {
                    selectedDateTime = new Date(); // Fallback to current time
                }
            } else {
                selectedDateTime = new Date(); // Fallback to current time
            }
            
            const coords = currentPosition.coords;
            
            // Get student information from activeStudents
            const selectedStudentKey = elements.student.value;
            const studentInfo = activeStudents[selectedStudentKey];
            
            let studentId, studentName;
            if (typeof studentInfo === 'string') {
                // Legacy format - use key as ID and string as name
                studentId = selectedStudentKey;
                studentName = studentInfo;
            } else {
                // New format with ID and name
                studentId = studentInfo.id;
                studentName = studentInfo.name;
            }
            
            return {
                id: generateId(),
                student: selectedStudentKey,
                studentId: studentId,
                studentName: studentName,
                attendanceStatus: elements.attendanceStatus.value,
                attendanceLabel: elements.attendanceStatus.value === 'present' ? 'Present' : 'Absent',
                dateTime: elements.dateTime.value,
                date: selectedDateTime.toLocaleDateString('en-US'),
                time: selectedDateTime.toLocaleTimeString('en-US', { hour12: true }),
                latitude: parseFloat(elements.latitude.value),
                longitude: parseFloat(elements.longitude.value),
                accuracy: coords.accuracy,
                altitude: coords.altitude,
                altitudeAccuracy: coords.altitudeAccuracy,
                speed: coords.speed,
                heading: coords.heading,
                locationQuality: getLocationQuality(coords.accuracy).label,
                address: elements.locationAddress.textContent,
                notes: elements.notes.value.trim(),
                timestamp: selectedDateTime.getTime(),
                locationTimestamp: currentPosition.timestamp,
                isHighAccuracy: document.getElementById('highAccuracyToggle')?.checked || false,
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language
                }
            };
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function resetForm() {
            elements.student.value = '';
            elements.attendanceStatus.value = '';
            elements.notes.value = '';
            elements.presentBtn.classList.remove('selected');
            elements.absentBtn.classList.remove('selected');
            
            selectedAttendanceStatus = null;
            elements.student.focus();
        }

        function toggleRecordsView() {
            const isVisible = elements.recordsSection.style.display !== 'none';
            
            if (isVisible) {
                elements.recordsSection.style.display = 'none';
                elements.viewRecordsBtn.innerHTML = '<i class="fas fa-eye"></i> View Records';
            } else {
                elements.recordsSection.style.display = 'block';
                elements.viewRecordsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Records';
                displayRecords();
                updateStatistics();
            }
        }

        function populateFilterDropdowns() {
            // Clear existing options
            elements.filterEmployee.innerHTML = '<option value="">All Students</option>';
            
            // Get unique students from attendance data or use active students
            let studentsToShow = new Map();
            
            // First, add students from attendance data
            attendanceData.forEach(record => {
                const studentKey = record.student || record.employee;
                if (studentKey && !studentsToShow.has(studentKey)) {
                    const studentInfo = activeStudents[studentKey];
                    let displayName = studentKey; // fallback
                    
                    if (typeof studentInfo === 'string') {
                        displayName = studentInfo;
                    } else if (studentInfo && studentInfo.name) {
                        displayName = studentInfo.name;
                    } else if (record.studentName) {
                        displayName = record.studentName;
                    }
                    
                    studentsToShow.set(studentKey, displayName);
                }
            });
            
            // If no attendance data, use all active students
            if (studentsToShow.size === 0) {
                Object.keys(activeStudents).forEach(studentKey => {
                    const student = activeStudents[studentKey];
                    const displayName = typeof student === 'string' ? student : (student.name || studentKey);
                    studentsToShow.set(studentKey, displayName);
                });
            }
            
            // Sort by display name and add to dropdown
            Array.from(studentsToShow.entries())
                .sort((a, b) => a[1].localeCompare(b[1]))
                .forEach(([studentKey, displayName]) => {
                    const option = document.createElement('option');
                    option.value = studentKey;
                    option.textContent = displayName;
                    elements.filterEmployee.appendChild(option);
                });
        }

        function applyFilters() {
            console.log('Apply Filters clicked');
            console.log('Filter values:', {
                date: elements.filterDate.value,
                student: elements.filterEmployee.value,
                status: elements.filterAction.value
            });
            
            const beforeCount = attendanceData.length;
            displayRecords();
            const afterCount = getFilteredRecords().length;
            
            // Show filter feedback
            if (beforeCount !== afterCount) {
                showMessage(`ðŸ” Filtered: Showing ${afterCount} of ${beforeCount} records`, 'info');
            } else if (beforeCount === 0) {
                showMessage('ðŸ“ No records to filter', 'warning');
            } else {
                showMessage(`ðŸ“Š Showing all ${beforeCount} records`, 'info');
            }
        }
        
        function clearFilters() {
            console.log('Clear Filters clicked');
            
            // Reset all filter inputs
            elements.filterDate.value = '';
            elements.filterDateStart.value = '';
            elements.filterDateEnd.value = '';
            elements.filterEmployee.value = '';
            elements.filterAction.value = '';
            
            // Reset date filter type to single
            elements.dateFilterType.value = 'single';
            elements.singleDateFilter.style.display = 'block';
            elements.dateRangeFilter.style.display = 'none';
            
            // Refresh the display
            displayRecords();
            showMessage('ðŸ”„ Filters cleared - showing all records', 'info');
        }

        function getFilteredRecords() {
            let filtered = [...attendanceData];
            console.log('Starting with', filtered.length, 'records');
            
            // Filter by date (single date or date range)
            const isDateRange = elements.dateFilterType.value === 'range';
            if (isDateRange && (elements.filterDateStart.value || elements.filterDateEnd.value)) {
                const startDate = elements.filterDateStart.value ? new Date(elements.filterDateStart.value) : null;
                const endDate = elements.filterDateEnd.value ? new Date(elements.filterDateEnd.value) : null;
                
                if (startDate) startDate.setHours(0, 0, 0, 0);
                if (endDate) endDate.setHours(23, 59, 59, 999);
                
                console.log('Filtering by date range:', 
                    startDate ? startDate.toISOString() : 'any',
                    'to',
                    endDate ? endDate.toISOString() : 'any'
                );
                
                filtered = filtered.filter(record => {
                    if (!record.date) return true;
                    
                    try {
                        const recordDate = new Date(record.date);
                        recordDate.setHours(12, 0, 0, 0); // Set to noon to avoid timezone issues
                        
                        if (startDate && endDate) {
                            return recordDate >= startDate && recordDate <= endDate;
                        } else if (startDate) {
                            return recordDate >= startDate;
                        } else if (endDate) {
                            return recordDate <= endDate;
                        }
                        return true;
                    } catch (e) {
                        console.log('âŒ Date conversion error for:', record.date);
                        return false;
                    }
                });
            } else if (!isDateRange && elements.filterDate.value) {
                const filterDate = new Date(elements.filterDate.value);
                filterDate.setHours(0, 0, 0, 0);
                const filterEndDate = new Date(filterDate);
                filterEndDate.setHours(23, 59, 59, 999);
                
                console.log('Filtering by single date:', filterDate.toISOString());
                
                filtered = filtered.filter(record => {
                    if (!record.date) return true;
                    
                    try {
                        const recordDate = new Date(record.date);
                        return recordDate >= filterDate && recordDate <= filterEndDate;
                    } catch (e) {
                        console.log('âŒ Date conversion error for:', record.date);
                        return false;
                    }
                });
            }
            console.log('After date filter:', filtered.length, 'records');
            
            // Filter by student
            if (elements.filterEmployee.value) {
                const selectedStudent = elements.filterEmployee.value;
                console.log('Filtering by student:', selectedStudent);
                filtered = filtered.filter(record => {
                    // Check multiple student fields for better compatibility
                    const matches = (record.student === selectedStudent) || 
                                  (record.studentId === selectedStudent) ||
                                  (record.employee === selectedStudent);
                    console.log('Record student fields:', {
                        student: record.student,
                        studentId: record.studentId,
                        employee: record.employee,
                        matches: matches
                    });
                    return matches;
                });
                console.log('After student filter:', filtered.length, 'records');
            }
            
            // Filter by status - improved logic
            if (elements.filterAction.value) {
                const filterValue = elements.filterAction.value.toLowerCase();
                console.log('Filtering by status:', filterValue);
                filtered = filtered.filter(record => {
                    // Check multiple status fields with flexible matching
                    const status = (record.attendanceStatus || record.attendanceLabel || record.actionType || '').toLowerCase();
                    const matches = status.includes(filterValue) || 
                                  (filterValue === 'present' && (status === 'p' || status === '1' || status.includes('check-in'))) ||
                                  (filterValue === 'absent' && (status === 'a' || status === '0'));
                    console.log('Record status:', status, 'vs filter:', filterValue, 'matches:', matches);
                    return matches;
                });
                console.log('After status filter:', filtered.length, 'records');
            }
            
            console.log('Final filtered records:', filtered.length);
            return filtered;
        }

        // Sort state
        let currentSort = {
            column: null,
            direction: 'asc'
        };

        // Initialize sorting
        function initializeTableSorting() {
            const headers = document.querySelectorAll('.records-table th');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    if (!column) return;
                    
                    // Remove sort classes from all headers
                    headers.forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });

                    // Toggle sort direction
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }

                    // Add sort class to current header
                    header.classList.add(`sort-${currentSort.direction}`);
                    
                    displayRecords();
                });
            });
        }

        function compareValues(a, b) {
            if (a === b) return 0;
            if (a === null || a === undefined) return 1;
            if (b === null || b === undefined) return -1;
            return a < b ? -1 : 1;
        }

        function sortRecords(records) {
            if (!currentSort.column) return records;

            return records.sort((a, b) => {
                let valueA = a[currentSort.column];
                let valueB = b[currentSort.column];

                // Special handling for dates and times
                if (currentSort.column === 'date') {
                    valueA = new Date(valueA).getTime();
                    valueB = new Date(valueB).getTime();
                } else if (currentSort.column === 'time') {
                    valueA = new Date('1970/01/01 ' + valueA).getTime();
                    valueB = new Date('1970/01/01 ' + valueB).getTime();
                }

                const comparison = compareValues(valueA, valueB);
                return currentSort.direction === 'asc' ? comparison : -comparison;
            });
        }

        function displayRecords() {
            console.log('Display records called');
            
            let records = getFilteredRecords();
            console.log('Filtered records count:', records.length);
            
            records = sortRecords(records);
            
            elements.recordsTableBody.innerHTML = '';
            
            if (records.length === 0) {
                elements.recordsTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
                            No records found
                        </td>
                    </tr>
                `;
                return;
            }
            
            records.forEach((record, index) => {
                const row = createRecordRow(record, index);
                elements.recordsTableBody.appendChild(row);
            });
        }

        function createRecordRow(record, index) {
            const row = document.createElement('tr');
            
            // Handle both new attendance status and legacy action type for backward compatibility
            let statusInfo;
            if (record.attendanceStatus) {
                // New attendance system
                statusInfo = {
                    label: record.attendanceLabel || (record.attendanceStatus === 'present' ? 'Present' : 'Absent'),
                    icon: record.attendanceStatus === 'present' ? 'fas fa-check-circle' : 'fas fa-times-circle',
                    color: record.attendanceStatus === 'present' ? '#27ae60' : '#e74c3c'
                };
            } else if (record.actionType && actionTypeMapping[record.actionType]) {
                // Legacy action type system
                statusInfo = actionTypeMapping[record.actionType];
            } else {
                // Fallback
                statusInfo = { label: 'Unknown', icon: 'fas fa-question', color: '#95a5a6' };
            }
            
            // Get student display name (check both new and legacy field names for backward compatibility)
            let studentDisplay;
            if (record.studentId && record.studentName) {
                // New format with ID and name
                studentDisplay = `${record.studentId} - ${record.studentName}`;
            } else if (record.studentName || record.employeeName) {
                // Has name but no ID
                studentDisplay = record.studentName || record.employeeName;
            } else {
                // Legacy format - lookup from activeStudents
                const studentInfo = activeStudents[record.student || record.employee];
                if (typeof studentInfo === 'object') {
                    studentDisplay = `${studentInfo.id} - ${studentInfo.name}`;
                } else {
                    studentDisplay = studentInfo || record.student || record.employee || 'Unknown Student';
                }
            }
            
            // Format location data
            const locationText = `${record.latitude.toFixed(4)}, ${record.longitude.toFixed(4)}`;
            const qualityBadge = record.locationQuality ? 
                `<span class="quality-indicator ${record.locationQuality.toLowerCase()}">${record.locationQuality}</span>` : '';
            const accuracyText = `Â±${Math.round(record.accuracy)}m`;
            const altitudeText = record.altitude ? `${Math.round(record.altitude)}m` : 'N/A';
            const speedText = record.speed ? `${(record.speed * 3.6).toFixed(1)} km/h` : 'N/A';
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><strong>${studentDisplay}</strong></td>
                <td>
                    <span class="status-badge ${record.attendanceStatus || record.actionType}" style="background-color: ${statusInfo.color};">
                        <i class="${statusInfo.icon}"></i> ${statusInfo.label}
                    </span>
                </td>
                <td>${record.date}</td>
                <td>${record.time}</td>
                <td>
                    <div style="font-size: 0.85rem;">
                        <div><strong>${locationText}</strong></div>
                        <div style="color: #6c757d;">
                            ${accuracyText} ${qualityBadge}
                        </div>
                        <div style="color: #6c757d; font-size: 0.8rem;">
                            Alt: ${altitudeText} | Speed: ${speedText}
                        </div>
                        <div style="color: #6c757d; font-size: 0.8rem; margin-top: 3px;">
                            <em>${record.address}</em>
                        </div>
                        <div style="margin-top: 5px;">
                            <a href="https://www.openstreetmap.org/#map=18/${record.latitude}/${record.longitude}" 
                               target="_blank" style="color: #3498db; font-size: 0.8rem;">
                                <i class="fas fa-map-marker-alt"></i> View on Map
                            </a>
                        </div>
                    </div>
                </td>
                <td>${record.notes || '-'}</td>
                <td>
                    <button class="table-action-btn" onclick="deleteRecord('${record.id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;
            
            return row;
        }

        function deleteRecord(recordId) {
            console.log('ðŸ—‘ï¸ Delete record called with ID:', recordId);
            
            // Find the record to get its details for the confirmation dialog
            const record = attendanceData.find(r => r.id === recordId);
            if (!record) {
                console.error('âŒ Record not found in attendanceData');
                showMessage('Record not found', 'error');
                return;
            }
            
            // Create modern confirmation dialog
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirmation-overlay';
            confirmDialog.innerHTML = `
                <div class="confirmation-modal">
                    <div class="confirmation-header" style="background: #e74c3c;">
                        <h3><i class="fas fa-trash"></i> Delete Record</h3>
                    </div>
                    <div class="confirmation-body">
                        <p><strong>Are you sure you want to delete this attendance record?</strong></p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
                            <p style="margin: 5px 0;"><strong>Student:</strong> ${record.studentName} (${record.studentId})</p>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${record.date}</p>
                            <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: ${record.attendanceStatus === 'present' ? '#28a745' : '#dc3545'};">${record.attendanceStatus.toUpperCase()}</span></p>
                            <p style="margin: 5px 0;"><strong>Time:</strong> ${record.time}</p>
                        </div>
                        <p style="color: #e74c3c; margin-top: 15px;"><i class="fas fa-warning"></i> This action cannot be undone!</p>
                    </div>
                    <div class="confirmation-actions">
                        <button class="confirm-btn cancel-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="confirm-btn" style="background: #e74c3c;">
                            <i class="fas fa-trash"></i> Yes, Delete
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            const cancelBtn = confirmDialog.querySelector('.cancel-btn');
            const confirmBtn = confirmDialog.querySelector('.confirm-btn:not(.cancel-btn)');
            
            const closeDialog = () => {
                document.body.removeChild(confirmDialog);
            };
            
            cancelBtn.addEventListener('click', () => {
                console.log('ðŸ—‘ï¸ User cancelled deletion');
                closeDialog();
            });
            
            confirmBtn.addEventListener('click', () => {
                console.log('ðŸ—‘ï¸ User confirmed deletion');
                console.log('ðŸ—‘ï¸ About to call deleteRecordFromStorage with ID:', recordId);
                console.log('ðŸ—‘ï¸ deleteRecordFromStorage function exists:', typeof deleteRecordFromStorage);
                closeDialog();
                try {
                    deleteRecordFromStorage(recordId);
                } catch (error) {
                    console.error('ðŸ—‘ï¸ Error calling deleteRecordFromStorage:', error);
                    showMessage('Error deleting record: ' + error.message, 'error');
                }
            });
            
            // Close on overlay click
            confirmDialog.addEventListener('click', (e) => {
                if (e.target === confirmDialog) {
                    console.log('ðŸ—‘ï¸ User cancelled deletion (overlay click)');
                    closeDialog();
                }
            });
            
            // Focus the confirm button after a short delay
            setTimeout(() => confirmBtn.focus(), 100);
        }

        async function deleteRecordFromStorage(recordId) {
            console.log('ðŸ—‘ï¸ deleteRecordFromStorage called with ID:', recordId);
            
            try {
                showLoading(true);
                showMessage('Deleting record...', 'info');
                
                // Find the record to get Firebase ID if it exists
                const recordIndex = attendanceData.findIndex(record => record.id === recordId);
                console.log('ðŸ—‘ï¸ Record index found:', recordIndex);
                
                if (recordIndex === -1) {
                    console.error('âŒ Record not found in attendanceData');
                    showMessage('Record not found', 'error');
                    showLoading(false);
                    return;
                }
                
                const record = attendanceData[recordIndex];
                console.log('ðŸ—‘ï¸ Record to delete:', record);
                
                // Delete from Firebase if it has a Firebase ID and Firebase is enabled
                let firebaseDeleteSuccess = false;
                const firebaseRecordId = record.firebaseId || record.firestoreId || record.id;
                
                console.log('ðŸ—‘ï¸ Record structure:', {
                    id: record.id,
                    firebaseId: record.firebaseId,
                    firestoreId: record.firestoreId,
                    finalId: firebaseRecordId
                });
                
                if (useFirebase && window.firebase && firebaseRecordId && navigator.onLine) {
                    console.log('ðŸ—‘ï¸ Attempting Firebase deletion with ID:', firebaseRecordId);
                    try {
                        // Use the same method as clearAllData - find the document first
                        const q = window.firebase.query(
                            window.firebase.collection(window.firebase.db, 'attendance'),
                            window.firebase.where('id', '==', record.id)
                        );
                        const querySnapshot = await window.firebase.getDocs(q);
                        
                        if (!querySnapshot.empty) {
                            const docToDelete = querySnapshot.docs[0];
                            console.log('ðŸ—‘ï¸ Found document to delete:', docToDelete.id);
                            await window.firebase.deleteDoc(docToDelete.ref);
                            console.log('ðŸ—‘ï¸ Document deleted successfully');
                            firebaseDeleteSuccess = true;
                            showMessage('âœ… Record deleted from cloud and local storage', 'success');
                        } else {
                            console.log('ðŸ—‘ï¸ Document not found in Firestore');
                            showMessage('âš ï¸ Record deleted locally (not found in cloud)', 'warning');
                        }
                    } catch (firebaseError) {
                        console.error('Firebase delete error:', firebaseError);
                        showMessage('âš ï¸ Record deleted locally (cloud sync failed: ' + firebaseError.message + ')', 'warning');
                    }
                } else {
                    console.log('ðŸ—‘ï¸ Deleting locally only - Firebase not available or no ID');
                    if (!firebaseRecordId) {
                        console.log('ðŸ—‘ï¸ No Firebase ID found in record');
                    }
                    if (!useFirebase) {
                        console.log('ðŸ—‘ï¸ Firebase disabled');
                    }
                    if (!window.firebase) {
                        console.log('ðŸ—‘ï¸ Firebase not available');
                    }
                    if (!navigator.onLine) {
                        console.log('ðŸ—‘ï¸ Device offline');
                    }
                    showMessage('âœ… Record deleted from local storage', 'success');
                }
                
                // Remove from local data
                console.log('ðŸ—‘ï¸ Removing from local data...');
                console.log('ðŸ—‘ï¸ attendanceData before deletion:', attendanceData.length, attendanceData);
                console.log('ðŸ—‘ï¸ Removing record at index:', recordIndex);
                attendanceData.splice(recordIndex, 1);
                console.log('ðŸ—‘ï¸ attendanceData after deletion:', attendanceData.length, attendanceData);
                console.log('ðŸ—‘ï¸ Updated attendanceData length:', attendanceData.length);
                
                // Update localStorage
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                // Also remove from sync queue if it's there
                const syncIndex = syncQueue.findIndex(record => record.id === recordId);
                if (syncIndex !== -1) {
                    console.log('ðŸ—‘ï¸ Removing from sync queue...');
                    syncQueue.splice(syncIndex, 1);
                    localStorage.setItem('attendanceSyncQueue', JSON.stringify(syncQueue));
                }
                
                // Refresh displays
                console.log('ðŸ—‘ï¸ Refreshing displays...');
                displayRecords();
                updateStatistics();
                generateAnalytics();
                
                console.log('ðŸ—‘ï¸ Record deletion completed successfully');
                
            } catch (error) {
                console.error('Error deleting record:', error);
                showMessage('âŒ Error deleting record: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateStatistics() {
            // Get filtered records based on current filter settings
            const filteredRecords = getFilteredRecords();
            
            console.log('Filtered records for statistics:', filteredRecords.length);
            console.log('Total attendance records:', attendanceData.length);
            
            // Calculate statistics based on filtered records
            const stats = {
                totalFiltered: filteredRecords.length,
                present: filteredRecords.filter(r => {
                    const status = (r.attendanceStatus || '').toLowerCase();
                    const label = (r.attendanceLabel || '').toLowerCase();
                    return status === 'present' || label === 'present' || r.actionType === 'check-in';
                }).length,
                absent: filteredRecords.filter(r => {
                    const status = (r.attendanceStatus || '').toLowerCase();
                    const label = (r.attendanceLabel || '').toLowerCase();
                    return status === 'absent' || label === 'absent';
                }).length,
                uniqueStudents: new Set(filteredRecords.map(r => r.studentId || r.employee)).size
            };
            
            console.log('Calculated stats for filtered records:', stats);
            
            // Determine labels based on current filters
            const filterDate = elements.filterDate.value;
            const filterStudent = elements.filterEmployee.value;
            const filterStatus = elements.filterAction.value;
            
            let recordsLabel = 'Total Records';
            let studentsLabel = 'Active Students';
            
            if (filterDate || filterStudent || filterStatus) {
                recordsLabel = 'Filtered Records';
                if (filteredRecords.length > 0) {
                    const uniqueInFiltered = new Set(filteredRecords.map(r => r.studentId || r.employee)).size;
                    studentsLabel = uniqueInFiltered > 0 ? 'Students in Filter' : 'Total Students';
                }
            } else {
                recordsLabel = 'All Records';
                studentsLabel = 'Total Students';
            }
            
            elements.statsGrid.innerHTML = `
                <div class="stat-card blue">
                    <div class="stat-number">${stats.totalFiltered}</div>
                    <div class="stat-label">${recordsLabel}</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number">${stats.present}</div>
                    <div class="stat-label">Present</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number">${stats.absent}</div>
                    <div class="stat-label">Absent</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-number">${stats.uniqueStudents}</div>
                    <div class="stat-label">${studentsLabel}</div>
                </div>
            `;
        }

        function showStatistics() {
            if (elements.recordsSection.style.display === 'none') {
                toggleRecordsView();
            }
            
            // Scroll to statistics section
            document.getElementById('statisticsSection').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        function parseTableData() {
            const data = [];
            const rows = document.querySelectorAll('#recordsTableBody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    // Extract student info from second cell (index 1)
                    const studentCell = cells[1].textContent.trim();
                    let studentId = '';
                    let studentName = '';
                    
                    // Parse formats like "STU002 - Yaman Takala"
                    const match = studentCell.match(/^(STU\d+)\s*-\s*(.+)$/);
                    if (match) {
                        studentId = match[1];
                        studentName = match[2];
                    } else {
                        studentName = studentCell;
                        studentId = studentCell;
                    }
                    
                    // Get status from third cell (index 2) - handle badge classes
                    const statusCell = cells[2];
                    let status = statusCell.textContent.trim();
                    
                    // Also check for badge classes to determine status
                    if (statusCell.querySelector('.status-present') || status.toLowerCase().includes('present')) {
                        status = 'Present';
                    } else if (statusCell.querySelector('.status-absent') || status.toLowerCase().includes('absent')) {
                        status = 'Absent';
                    }
                    
                    // Get date from fourth cell (index 3)
                    const dateText = cells[3].textContent.trim();
                    
                    // Get time from fifth cell (index 4) if it exists
                    const timeText = cells.length > 4 ? cells[4].textContent.trim() : '';
                    
                    const record = {
                        studentId: studentId,
                        studentName: studentName,
                        action: status,
                        attendanceStatus: status.toLowerCase(),
                        date: dateText,
                        time: timeText,
                        // Also include legacy format support
                        actionType: status.toLowerCase() === 'present' ? 'check-in' : 'absence'
                    };
                    
                    data.push(record);
                }
            });
            
            return data;
        }

        function parseRecordDate(dateString) {
            // Handle various date formats
            if (!dateString) return new Date();
            
            // Try to parse common formats
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return date;
            }
            
            // If direct parsing fails, try manual parsing for formats like "8/30/2025"
            const parts = dateString.match(/(\d+)\/(\d+)\/(\d+)/);
            if (parts) {
                const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                const day = parseInt(parts[2]);
                const year = parseInt(parts[3]);
                return new Date(year, month, day);
            }
            
            return new Date(); // fallback to current date
        }

        function generateAttendanceRateAnalytics(data) {
            const studentStats = {};
            
            // Calculate stats for each student
            data.forEach(record => {
                // Handle both new format (studentId + studentName) and legacy formats
                let studentKey, studentName;
                
                if (record.studentId && record.studentName) {
                    studentKey = record.studentId;
                    studentName = `${record.studentId} - ${record.studentName}`;
                } else if (record.studentName) {
                    studentKey = record.studentName;
                    studentName = record.studentName;
                } else if (record.employeeName) {
                    studentKey = record.employeeName;
                    studentName = record.employeeName;
                } else {
                    studentKey = 'Unknown';
                    studentName = 'Unknown Student';
                }
                
                if (!studentStats[studentKey]) {
                    studentStats[studentKey] = {
                        name: studentName,
                        total: 0,
                        present: 0,
                        absent: 0
                    };
                }
                
                studentStats[studentKey].total++;
                
                // Check attendance status - handle both new and legacy formats
                const isPresent = record.attendanceStatus === 'present' || 
                                record.actionType === 'check-in' || 
                                record.action === 'Present';
                const isAbsent = record.attendanceStatus === 'absent' || 
                               record.actionType === 'absence' || 
                               record.action === 'Absent';
                
                if (isPresent) {
                    studentStats[studentKey].present++;
                } else if (isAbsent) {
                    studentStats[studentKey].absent++;
                }
            });

            // Calculate attendance rates and sort students
            const studentRates = Object.keys(studentStats).map(key => {
                const stats = studentStats[key];
                const rate = stats.total > 0 ? (stats.present / stats.total) * 100 : 0;
                return {
                    name: stats.name,
                    rate: rate.toFixed(1),
                    total: stats.total,
                    present: stats.present,
                    absent: stats.absent
                };
            });

            // Sort for highest (best attendance first)
            const highest = [...studentRates].sort((a, b) => {
                // First sort by rate, then by total records (more data = more reliable)
                if (b.rate !== a.rate) return b.rate - a.rate;
                return b.total - a.total;
            }).slice(0, 5);

            // Sort for lowest (worst attendance first, but exclude 0% with very few records)
            const lowest = [...studentRates].sort((a, b) => {
                // First sort by rate, then by total records
                if (a.rate !== b.rate) return a.rate - b.rate;
                return b.total - a.total;
            }).slice(0, 5);

            // Display highest attendance
            const highestList = document.getElementById('highestAttendanceList');
            if (highest.length > 0) {
                highestList.innerHTML = highest.map(student => `
                    <li class="student-stat-item ${getPerformanceClass(student.rate)}">
                        <div>
                            <div class="analytics-metric">${student.name}</div>
                            <div class="stat-details">${student.present}P/${student.absent}A out of ${student.total} total</div>
                        </div>
                        <span class="analytics-percentage ${getPercentageClass(student.rate)}">${student.rate}%</span>
                    </li>
                `).join('');
            } else {
                highestList.innerHTML = '<li class="analytics-empty">No data available</li>';
            }

            // Display lowest attendance
            const lowestList = document.getElementById('lowestAttendanceList');
            if (lowest.length > 0) {
                lowestList.innerHTML = lowest.map(student => `
                    <li class="student-stat-item ${getPerformanceClass(student.rate)}">
                        <div>
                            <div class="analytics-metric">${student.name}</div>
                            <div class="stat-details">${student.present}P/${student.absent}A out of ${student.total} total</div>
                        </div>
                        <span class="analytics-percentage ${getPercentageClass(student.rate)}">${student.rate}%</span>
                    </li>
                `).join('');
            } else {
                lowestList.innerHTML = '<li class="analytics-empty">No data available</li>';
            }
        }

        function generateAbsenceAnalytics(data) {
            const studentAbsences = {};
            
            data.forEach(record => {
                const isAbsent = record.attendanceStatus === 'absent' || 
                               record.actionType === 'absence' || 
                               record.action === 'Absent';
                
                if (isAbsent) {
                    let studentKey, studentName;
                    
                    if (record.studentId && record.studentName) {
                        studentKey = record.studentId;
                        studentName = `${record.studentId} - ${record.studentName}`;
                    } else if (record.studentName) {
                        studentKey = record.studentName;
                        studentName = record.studentName;
                    } else if (record.employeeName) {
                        studentKey = record.employeeName;
                        studentName = record.employeeName;
                    } else {
                        studentKey = 'Unknown';
                        studentName = 'Unknown Student';
                    }
                    
                    if (!studentAbsences[studentKey]) {
                        studentAbsences[studentKey] = {
                            name: studentName,
                            count: 0,
                            dates: []
                        };
                    }
                    studentAbsences[studentKey].count++;
                    studentAbsences[studentKey].dates.push(record.date);
                }
            });

            const absenceList = Object.keys(studentAbsences)
                .map(key => studentAbsences[key])
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            const absenceContainer = document.getElementById('individualAbsenceList');
            if (absenceList.length > 0) {
                absenceContainer.innerHTML = absenceList.map(student => `
                    <li class="student-stat-item poor">
                        <div>
                            <div class="analytics-metric">${student.name}</div>
                            <div class="stat-details">Absent on: ${student.dates.slice(0, 3).join(', ')}${student.dates.length > 3 ? '...' : ''}</div>
                        </div>
                        <span class="absence-badge">${student.count} absence${student.count > 1 ? 's' : ''}</span>
                    </li>
                `).join('');
            } else {
                absenceContainer.innerHTML = '<li class="analytics-empty">No absences recorded</li>';
            }
        }

        function generateDateAnalytics(data) {
            const dateAbsences = {};
            
            data.forEach(record => {
                const isAbsent = record.attendanceStatus === 'absent' || 
                               record.actionType === 'absence' || 
                               record.action === 'Absent';
                
                if (isAbsent) {
                    const date = record.date;
                    if (!dateAbsences[date]) {
                        dateAbsences[date] = {
                            count: 0,
                            students: []
                        };
                    }
                    dateAbsences[date].count++;
                    
                    // Get student name
                    let studentName;
                    if (record.studentId && record.studentName) {
                        studentName = `${record.studentId} - ${record.studentName}`;
                    } else if (record.studentName) {
                        studentName = record.studentName;
                    } else if (record.employeeName) {
                        studentName = record.employeeName;
                    } else {
                        studentName = 'Unknown';
                    }
                    
                    dateAbsences[date].students.push(studentName);
                }
            });

            const sortedDates = Object.keys(dateAbsences)
                .map(date => ({
                    date: date,
                    count: dateAbsences[date].count,
                    students: dateAbsences[date].students,
                    formattedDate: formatDisplayDate(date)
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            const timelineContainer = document.getElementById('absenceTimeline');
            if (sortedDates.length > 0) {
                timelineContainer.innerHTML = sortedDates.map(item => `
                    <div class="timeline-item">
                        <div>
                            <div class="timeline-date">${item.formattedDate}</div>
                            <div class="stat-details">${item.students.slice(0, 3).join(', ')}${item.students.length > 3 ? ` +${item.students.length - 3} more` : ''}</div>
                        </div>
                        <div class="timeline-count">${item.count} absence${item.count > 1 ? 's' : ''}</div>
                    </div>
                `).join('');
            } else {
                timelineContainer.innerHTML = '<div class="analytics-empty">No absence data available</div>';
            }
        }

        function formatDisplayDate(dateString) {
            try {
                const date = parseRecordDate(dateString);
                return date.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString; // fallback to original string
            }
        }

        function generateDetailedStudentStats(data) {
            const studentDetails = {};
            
            data.forEach(record => {
                let studentKey, studentName;
                
                if (record.studentId && record.studentName) {
                    studentKey = record.studentId;
                    studentName = `${record.studentId} - ${record.studentName}`;
                } else if (record.studentName) {
                    studentKey = record.studentName;
                    studentName = record.studentName;
                } else if (record.employeeName) {
                    studentKey = record.employeeName;
                    studentName = record.employeeName;
                } else {
                    studentKey = 'Unknown';
                    studentName = 'Unknown Student';
                }
                
                if (!studentDetails[studentKey]) {
                    studentDetails[studentKey] = {
                        name: studentName,
                        dates: new Set(),
                        total: 0,
                        present: 0,
                        absent: 0
                    };
                }
                
                studentDetails[studentKey].dates.add(record.date);
                studentDetails[studentKey].total++;
                
                const isPresent = record.attendanceStatus === 'present' || 
                                record.actionType === 'check-in' || 
                                record.action === 'Present';
                const isAbsent = record.attendanceStatus === 'absent' || 
                               record.actionType === 'absence' || 
                               record.action === 'Absent';
                
                if (isPresent) {
                    studentDetails[studentKey].present++;
                } else if (isAbsent) {
                    studentDetails[studentKey].absent++;
                }
            });

            const detailedStats = Object.keys(studentDetails).map(key => {
                const stats = studentDetails[key];
                const rate = stats.total > 0 ? (stats.present / stats.total) * 100 : 0;
                return {
                    name: stats.name,
                    uniqueDays: stats.dates.size,
                    total: stats.total,
                    present: stats.present,
                    absent: stats.absent,
                    rate: rate.toFixed(1)
                };
            }).sort((a, b) => b.rate - a.rate);

            const detailsContainer = document.getElementById('detailedStudentStats');
            if (detailedStats.length > 0) {
                detailsContainer.innerHTML = detailedStats.map(student => `
                    <div class="student-detail">
                        <div>
                            <div class="student-name">${student.name}</div>
                            <div class="stat-details">
                                ${student.total} records across ${student.uniqueDays} day${student.uniqueDays > 1 ? 's' : ''} | 
                                Present: ${student.present} | Absent: ${student.absent}
                            </div>
                        </div>
                        <span class="analytics-percentage ${getPercentageClass(student.rate)}">${student.rate}%</span>
                    </div>
                `).join('');
            } else {
                detailsContainer.innerHTML = '<div class="analytics-empty">No detailed statistics available</div>';
            }
        }

        function getPercentageClass(rate) {
            if (rate >= 80) return 'percentage-high';
            if (rate >= 60) return 'percentage-medium';
            return 'percentage-low';
        }

        function getPerformanceClass(rate) {
            if (rate >= 90) return 'excellent';
            if (rate >= 80) return 'good';
            if (rate >= 60) return 'average';
            return 'poor';
        }

        function showEmptyAnalytics() {
            document.getElementById('highestAttendanceList').innerHTML = '<li class="analytics-empty">No data available for selected period</li>';
            document.getElementById('lowestAttendanceList').innerHTML = '<li class="analytics-empty">No data available for selected period</li>';
            document.getElementById('individualAbsenceList').innerHTML = '<li class="analytics-empty">No absence data available</li>';
            document.getElementById('absenceTimeline').innerHTML = '<div class="analytics-empty">No absence data available</div>';
            document.getElementById('detailedStudentStats').innerHTML = '<div class="analytics-empty">No detailed statistics available</div>';
        }

        // Helper function to resolve student names for PDF export
        function getStudentDisplayName(studentKey) {
            // First try to get from activeStudents
            if (activeStudents && activeStudents[studentKey]) {
                const student = activeStudents[studentKey];
                if (typeof student === 'object' && student.name) {
                    return student.name;
                } else if (typeof student === 'string') {
                    return student;
                }
            }
            
            // Fallback to defaultStudentNames
            if (defaultStudentNames && defaultStudentNames[studentKey]) {
                const student = defaultStudentNames[studentKey];
                if (typeof student === 'object' && student.name) {
                    return student.name;
                } else if (typeof student === 'string') {
                    return student;
                }
            }
            
            // If it's already a display name (not an ID), return as is
            if (studentKey && !studentKey.startsWith('STU')) {
                return studentKey;
            }
            
            // Last resort - return the key itself
            return studentKey || 'Unknown Student';
        }

        // PDF Export Functions
        function exportAnalyticsToPDF() {
            try {
                // Show loading state
                const exportBtn = document.getElementById('exportAnalyticsPdfBtn');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                exportBtn.disabled = true;

                // Get current analytics data
                const filterPeriod = document.getElementById('analyticsFilter').value;
                let filteredData = getAnalyticsData(filterPeriod);
                
                console.log('PDF Export - Raw data from getAnalyticsData:', {
                    length: filteredData.length,
                    firstRecord: filteredData[0],
                    sampleRecords: filteredData.slice(0, 3),
                    globalAttendanceData: {
                        length: attendanceData.length,
                        sample: attendanceData.slice(0, 2)
                    }
                });
                
                // Validate and clean data
                if (!filteredData || filteredData.length === 0) {
                    showMessage('No data available to export', 'warning');
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                    return;
                }
                
                // Clean and validate each record
                filteredData = filteredData.filter(record => {
                    return record && 
                           (record.student || record.studentId || record.studentName || record.name) && 
                           (record.status === 'present' || record.status === 'absent' || 
                            record.attendanceStatus === 'present' || record.attendanceStatus === 'absent' ||
                            record.action === 'present' || record.action === 'absent');
                }).map(record => ({
                    student: record.student || record.studentName || record.studentId || record.name || 'Unknown Student',
                    status: record.status || record.attendanceStatus || record.action || 'unknown',
                    datetime: record.datetime || record.date || record.timestamp || new Date().toISOString(),
                    notes: record.notes || '',
                    location: record.location || ''
                }));
                
                console.log('PDF Export - Cleaned data:', filteredData.slice(0, 3)); // Log first 3 records for debugging
                
                if (filteredData.length === 0) {
                    showMessage('No valid attendance records found to export', 'warning');
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                    return;
                }

                // Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set up fonts and colors
                const primaryColor = [52, 152, 219]; // Blue
                const secondaryColor = [46, 204, 113]; // Green
                const dangerColor = [231, 76, 60]; // Red
                const textColor = [44, 62, 80]; // Dark blue-gray
                
                // Header
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 210, 30, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.text('ATTENDANCE ANALYTICS REPORT', 20, 20);
                
                // Date and filter info
                doc.setFontSize(10);
                const currentDate = new Date().toLocaleDateString();
                const filterText = getPeriodDisplayName(filterPeriod);
                doc.text(`Generated on: ${currentDate} | Period: ${filterText}`, 20, 26);
                
                // Reset text color for body
                doc.setTextColor(...textColor);
                
                let yPosition = 45;
                
                // Summary Statistics
                const summaryStats = calculateSummaryStats(filteredData);
                addSectionHeader(doc, 'SUMMARY STATISTICS', yPosition);
                yPosition += 15;
                
                const summaryData = [
                    ['Total Records', summaryStats.totalRecords.toString()],
                    ['Total Students', summaryStats.totalStudents.toString()],
                    ['Present Records', summaryStats.presentRecords.toString()],
                    ['Absent Records', summaryStats.absentRecords.toString()],
                    ['Overall Attendance Rate', `${summaryStats.overallAttendanceRate}%`],
                    ['Days Covered', summaryStats.daysCovered.toString()]
                ];
                
                addTable(doc, summaryData, yPosition, false);
                yPosition += (summaryData.length * 8) + 20;
                
                // Check if we need a new page
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Attendance Rates by Student
                addSectionHeader(doc, 'INDIVIDUAL ATTENDANCE RATES', yPosition);
                yPosition += 15;
                
                const attendanceRates = calculateAttendanceRates(filteredData);
                const attendanceTableData = attendanceRates.map(student => [
                    student.name,
                    student.present.toString(),
                    student.absent.toString(),
                    student.total.toString(),
                    `${student.rate}%`
                ]);
                
                addTable(doc, attendanceTableData, yPosition, true, 
                    ['Student Name', 'Present', 'Absent', 'Total', 'Rate']);
                yPosition += (attendanceTableData.length * 8) + 25;
                
                // Check if we need a new page
                if (yPosition > 220) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Absence Analysis
                addSectionHeader(doc, 'ABSENCE ANALYSIS', yPosition);
                yPosition += 15;
                
                const absenceData = calculateAbsenceAnalysis(filteredData);
                if (absenceData.length > 0) {
                    const absenceTableData = absenceData.map(item => [
                        item.name,
                        item.count.toString(),
                        `${item.percentage}%`
                    ]);
                    
                    addTable(doc, absenceTableData, yPosition, true, 
                        ['Student Name', 'Absent Days', 'Absence Rate']);
                    yPosition += (absenceTableData.length * 8) + 20;
                } else {
                    doc.setFontSize(10);
                    doc.text('No absence data available for the selected period.', 20, yPosition);
                    yPosition += 20;
                }
                
                // Footer
                addFooter(doc);
                
                // Save the PDF
                const fileName = `Attendance_Analytics_${filterText}_${currentDate.replace(/\//g, '-')}.pdf`;
                doc.save(fileName);
                
                showMessage(`Analytics report exported successfully! 
${filteredData.length} records processed.
File: ${fileName}`, 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Error generating PDF report. Please try again.', 'error');
            } finally {
                // Reset button state
                const exportBtn = document.getElementById('exportAnalyticsPdfBtn');
                exportBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Export PDF';
                exportBtn.disabled = false;
            }
        }
        
        function addSectionHeader(doc, title, yPosition) {
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.setTextColor(52, 152, 219);
            doc.text(title, 20, yPosition);
            
            // Add underline
            doc.setLineWidth(0.5);
            doc.setDrawColor(52, 152, 219);
            doc.line(20, yPosition + 2, 190, yPosition + 2);
        }
        
        function addTable(doc, data, yPosition, hasHeaders = false, headers = []) {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(44, 62, 80);
            
            let currentY = yPosition;
            
            // Add headers if provided
            if (hasHeaders && headers.length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.setFillColor(240, 240, 240);
                doc.rect(20, currentY - 5, 170, 8, 'F');
                
                const colWidth = 170 / headers.length;
                headers.forEach((header, index) => {
                    doc.text(header, 25 + (index * colWidth), currentY);
                });
                currentY += 10;
                doc.setFont('helvetica', 'normal');
            }
            
            // Add data rows
            data.forEach((row, index) => {
                const colWidth = 170 / row.length;
                
                // Alternate row colors
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(20, currentY - 5, 170, 8, 'F');
                }
                
                row.forEach((cell, cellIndex) => {
                    const text = cell.toString();
                    const xPosition = 25 + (cellIndex * colWidth);
                    
                    // Color coding for rates
                    if (text.includes('%') && cellIndex === row.length - 1) {
                        const rate = parseFloat(text);
                        if (rate >= 80) doc.setTextColor(46, 204, 113); // Green
                        else if (rate >= 60) doc.setTextColor(243, 156, 18); // Orange
                        else doc.setTextColor(231, 76, 60); // Red
                    } else {
                        doc.setTextColor(44, 62, 80);
                    }
                    
                    doc.text(text, xPosition, currentY);
                });
                currentY += 8;
            });
        }
        
        function addFooter(doc) {
            const pageCount = doc.internal.getNumberOfPages();
            
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                
                // Footer line
                doc.setLineWidth(0.5);
                doc.setDrawColor(200, 200, 200);
                doc.line(20, 285, 190, 285);
                
                // Footer text
                doc.text(`Class Attendance System - Generated on ${new Date().toLocaleString()}`, 20, 290);
                doc.text(`Page ${i} of ${pageCount}`, 170, 290);
            }
        }
        
        function calculateSummaryStats(data) {
            const totalRecords = data.length;
            
            // Count unique students by their display names
            const uniqueStudentKeys = new Set(data.map(record => record.student || record.name || 'Unknown'));
            const uniqueStudentNames = new Set();
            uniqueStudentKeys.forEach(key => {
                if (key !== 'Unknown') {
                    uniqueStudentNames.add(getStudentDisplayName(key));
                }
            });
            
            const presentRecords = data.filter(record => record.status === 'present').length;
            const absentRecords = data.filter(record => record.status === 'absent').length;
            const overallAttendanceRate = totalRecords > 0 ? ((presentRecords / totalRecords) * 100).toFixed(1) : '0.0';
            
            // Handle different datetime formats safely
            const uniqueDays = new Set(data.map(record => {
                let dateStr = record.datetime || record.date || record.timestamp || '';
                if (typeof dateStr === 'string' && dateStr.includes(' ')) {
                    return dateStr.split(' ')[0];
                } else if (typeof dateStr === 'string') {
                    return dateStr;
                } else {
                    return new Date().toISOString().split('T')[0]; // fallback to today
                }
            }).filter(date => date)).size;
            
            return {
                totalRecords,
                totalStudents: uniqueStudentNames.size,
                presentRecords,
                absentRecords,
                overallAttendanceRate,
                daysCovered: uniqueDays
            };
        }
        
        function calculateAttendanceRates(data) {
            const studentStats = {};
            
            data.forEach(record => {
                const studentKey = record.student || record.name || 'Unknown Student';
                if (!studentKey || studentKey === 'Unknown Student') return; // Skip invalid records
                
                if (!studentStats[studentKey]) {
                    studentStats[studentKey] = { present: 0, absent: 0, total: 0 };
                }
                
                studentStats[studentKey].total++;
                if (record.status === 'present') {
                    studentStats[studentKey].present++;
                } else if (record.status === 'absent') {
                    studentStats[studentKey].absent++;
                }
            });
            
            return Object.keys(studentStats).map(studentKey => {
                const stats = studentStats[studentKey];
                const rate = stats.total > 0 ? ((stats.present / stats.total) * 100).toFixed(1) : '0.0';
                const displayName = getStudentDisplayName(studentKey);
                
                return {
                    name: displayName,
                    present: stats.present,
                    absent: stats.absent,
                    total: stats.total,
                    rate: parseFloat(rate)
                };
            }).sort((a, b) => b.rate - a.rate);
        }
        
        function calculateAbsenceAnalysis(data) {
            const studentAbsences = {};
            const totalRecordsPerStudent = {};
            
            data.forEach(record => {
                const studentKey = record.student || record.name || 'Unknown Student';
                if (!studentKey || studentKey === 'Unknown Student') return; // Skip invalid records
                
                if (!totalRecordsPerStudent[studentKey]) {
                    totalRecordsPerStudent[studentKey] = 0;
                }
                totalRecordsPerStudent[studentKey]++;
                
                if (record.status === 'absent') {
                    if (!studentAbsences[studentKey]) {
                        studentAbsences[studentKey] = 0;
                    }
                    studentAbsences[studentKey]++;
                }
            });
            
            return Object.keys(studentAbsences).map(studentKey => {
                const absenceCount = studentAbsences[studentKey];
                const totalRecords = totalRecordsPerStudent[studentKey];
                const percentage = ((absenceCount / totalRecords) * 100).toFixed(1);
                const displayName = getStudentDisplayName(studentKey);
                
                return {
                    name: displayName,
                    count: absenceCount,
                    percentage: parseFloat(percentage)
                };
            }).sort((a, b) => b.count - a.count);
        }
        
        function getPeriodDisplayName(period) {
            const periodNames = {
                'all': 'All Time',
                'last7days': 'Last 7 Days',
                'last30days': 'Last 30 Days',
                'thismonth': 'This Month',
                'lastmonth': 'Last Month'
            };
            return periodNames[period] || 'All Time';
        }

        // Analytics Functions
        function toggleAnalyticsView() {
            const isVisible = elements.analyticsSection.style.display !== 'none';
            
            if (isVisible) {
                elements.viewAnalyticsBtn.innerHTML = '<i class="fas fa-chart-line"></i> View Analytics';
                elements.analyticsSection.style.display = 'none';
            } else {
                elements.viewAnalyticsBtn.innerHTML = '<i class="fas fa-chart-line"></i> Hide Analytics';
                elements.analyticsSection.style.display = 'block';
                generateAnalytics();
                
                // Scroll to analytics section
                elements.analyticsSection.scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }
        }

        function generateAnalytics() {
            const filterPeriod = document.getElementById('analyticsFilter').value;
            console.log('generateAnalytics called with filter:', filterPeriod);
            
            const filteredData = getAnalyticsData(filterPeriod);
            
            console.log('Filtered data results:', {
                period: filterPeriod,
                recordCount: filteredData.length
            });
            
            if (filteredData.length === 0) {
                console.log('No data available, showing empty analytics');
                showEmptyAnalytics();
                return;
            }

            // Generate all analytics
            generateAttendanceRateAnalytics(filteredData);
            generateAbsenceAnalytics(filteredData);
            generateDateAnalytics(filteredData);
            generateDetailedStudentStats(filteredData);
        }

        function getAnalyticsData(period) {
            // First ensure we have data - if attendanceData is empty, try to load from table
            let dataSource = attendanceData && attendanceData.length > 0 ? attendanceData : [];
            
            // If still no data, try to parse from the displayed table
            if (dataSource.length === 0) {
                console.log('Parsing data from table...');
                const tableRows = document.querySelectorAll('#recordsTableBody tr');
                console.log('Found table rows:', tableRows.length);
                
                tableRows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 4) {
                        const studentCell = cells[1].textContent.trim();
                        const statusCell = cells[2].textContent.trim();
                        const dateCell = cells[3].textContent.trim();
                        
                        console.log(`Row ${index}:`, { studentCell, statusCell, dateCell });
                        
                        // Extract student ID and name from format "STU001 - Baraa Takala"
                        let studentId = '';
                        let studentName = '';
                        
                        if (studentCell.includes(' - ')) {
                            const parts = studentCell.split(' - ');
                            studentId = parts[0].trim();
                            studentName = parts[1].trim();
                        } else {
                            studentId = studentCell;
                            studentName = studentCell;
                        }
                        
                        // Map status to proper format
                        let mappedStatus = statusCell.toLowerCase().trim();
                        if (mappedStatus === 'present' || mappedStatus === 'absent') {
                            dataSource.push({
                                student: studentName || studentId, // Use student name primarily
                                studentId: studentId,
                                studentName: studentName,
                                status: mappedStatus, // Use the correct property name
                                action: statusCell,
                                attendanceStatus: mappedStatus,
                                datetime: dateCell,
                                date: dateCell
                            });
                        }
                    }
                });
                
                console.log('Parsed data from table:', dataSource.length, 'records');
            }
            
            console.log('Analytics Data Source:', {
                period: period,
                totalRecords: dataSource.length,
                sampleRecord: dataSource[0],
                uniqueStudents: [...new Set(dataSource.map(r => r.studentId || r.studentName))],
                sampleStudentData: dataSource.slice(0, 3)
            });
            
            const now = new Date();
            let startDate = new Date(0); // Default to beginning of time
            
            switch(period) {
                case 'last7days':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'last30days':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'thismonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'lastmonth':
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    return dataSource.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate >= lastMonth && recordDate < thisMonth;
                    });
                case 'all':
                default:
                    return dataSource; // All time
            }
            
            return dataSource.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= startDate;
            });
        }

        function generateAttendanceRateAnalytics(data) {
            const studentStats = {};
            
            // Calculate attendance rates for each student
            data.forEach(record => {
                const studentKey = record.studentId || record.studentName || 'Unknown';
                const studentName = record.studentName || studentKey;
                
                if (!studentStats[studentKey]) {
                    studentStats[studentKey] = {
                        name: studentName,
                        total: 0,
                        present: 0,
                        absent: 0
                    };
                }
                
                studentStats[studentKey].total++;
                
                // Check for present status - handle multiple formats
                const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                if (status === 'present' || record.actionType === 'check-in' || status.includes('present')) {
                    studentStats[studentKey].present++;
                } else if (status === 'absent' || status.includes('absent')) {
                    studentStats[studentKey].absent++;
                }
            });
            
            // Calculate percentages and sort
            const studentsWithRates = Object.values(studentStats).map(student => {
                const rate = student.total > 0 ? (student.present / student.total) * 100 : 0;
                return {
                    ...student,
                    attendanceRate: rate.toFixed(1),
                    numericRate: rate
                };
            });
            
            // Highest attendance rates (best to worst)
            const highest = studentsWithRates
                .sort((a, b) => b.numericRate - a.numericRate)
                .slice(0, 5);
            
            // Lowest attendance rates (worst to best)
            const lowest = studentsWithRates
                .sort((a, b) => a.numericRate - b.numericRate)
                .slice(0, 5);
            
            updateAttendanceRateDisplay(highest, lowest);
        }

        function updateAttendanceRateDisplay(highest, lowest) {
            const highestList = document.getElementById('highestAttendanceList');
            const lowestList = document.getElementById('lowestAttendanceList');
            
            // Highest attendance
            if (highest.length > 0) {
                highestList.innerHTML = highest.map(student => `
                    <li>
                        <span>${student.name}</span>
                        <span class="analytics-percentage percentage-high">${student.attendanceRate}%</span>
                    </li>
                `).join('');
            } else {
                highestList.innerHTML = '<li class="analytics-empty">No data available</li>';
            }
            
            // Lowest attendance
            if (lowest.length > 0) {
                lowestList.innerHTML = lowest.map(student => {
                    const percentClass = student.attendanceRate >= 80 ? 'percentage-high' : 
                                       student.attendanceRate >= 60 ? 'percentage-medium' : 'percentage-low';
                    return `
                        <li>
                            <span>${student.name}</span>
                            <span class="analytics-percentage ${percentClass}">${student.attendanceRate}%</span>
                        </li>
                    `;
                }).join('');
            } else {
                lowestList.innerHTML = '<li class="analytics-empty">No data available</li>';
            }
        }

        function generateAbsenceAnalytics(data) {
            const studentAbsences = {};
            
            data.forEach(record => {
                const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                if (status === 'absent' || record.actionType === 'absent' || status.includes('absent')) {
                    const studentKey = record.studentId || record.studentName || 'Unknown';
                    const studentName = record.studentName || studentKey;
                    
                    if (!studentAbsences[studentKey]) {
                        studentAbsences[studentKey] = {
                            name: studentName,
                            count: 0
                        };
                    }
                    studentAbsences[studentKey].count++;
                }
            });
            
            const sortedAbsences = Object.values(studentAbsences)
                .sort((a, b) => b.count - a.count);
            
            updateAbsenceDisplay(sortedAbsences);
        }

        function updateAbsenceDisplay(absences) {
            const absenceList = document.getElementById('individualAbsenceList');
            
            if (absences.length > 0) {
                absenceList.innerHTML = absences.map(student => `
                    <li>
                        <span>${student.name}</span>
                        <span class="absence-badge">${student.count} absence${student.count !== 1 ? 's' : ''}</span>
                    </li>
                `).join('');
            } else {
                absenceList.innerHTML = '<li class="analytics-empty">No absences recorded</li>';
            }
        }

        function generateDateAnalytics(data) {
            const dateAbsences = {};
            
            data.forEach(record => {
                const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                if (status === 'absent' || record.actionType === 'absent' || status.includes('absent')) {
                    const date = record.date;
                    if (!dateAbsences[date]) {
                        dateAbsences[date] = 0;
                    }
                    dateAbsences[date]++;
                }
            });
            
            const sortedDates = Object.entries(dateAbsences)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Top 10 dates with most absences
            
            updateDateAnalyticsDisplay(sortedDates);
        }

        function updateDateAnalyticsDisplay(dates) {
            const timeline = document.getElementById('absenceTimeline');
            
            if (dates.length > 0) {
                timeline.innerHTML = dates.map(([date, count]) => `
                    <div class="timeline-item">
                        <span class="timeline-date">${new Date(date).toLocaleDateString()}</span>
                        <span class="timeline-count">${count} absence${count !== 1 ? 's' : ''}</span>
                    </div>
                `).join('');
            } else {
                timeline.innerHTML = '<div class="analytics-empty">No absence data available</div>';
            }
        }

        function generateDetailedStudentStats(data) {
            const studentDetails = {};
            
            data.forEach(record => {
                const studentKey = record.studentId || record.studentName || 'Unknown';
                const studentName = record.studentName || studentKey;
                
                if (!studentDetails[studentKey]) {
                    studentDetails[studentKey] = {
                        name: studentName,
                        totalRecords: 0,
                        presentCount: 0,
                        absentCount: 0,
                        dates: new Set()
                    };
                }
                
                const student = studentDetails[studentKey];
                student.totalRecords++;
                student.dates.add(record.date);
                
                // Check for present/absent status - handle multiple formats
                const status = (record.attendanceStatus || record.action || '').toLowerCase().trim();
                if (status === 'present' || record.actionType === 'check-in' || status.includes('present')) {
                    student.presentCount++;
                } else if (status === 'absent' || status.includes('absent')) {
                    student.absentCount++;
                }
            });
            
            const detailedStats = Object.values(studentDetails).map(student => ({
                ...student,
                attendanceRate: student.totalRecords > 0 ? ((student.presentCount / student.totalRecords) * 100).toFixed(1) : '0.0',
                uniqueDays: student.dates.size
            })).sort((a, b) => b.totalRecords - a.totalRecords);
            
            updateDetailedStatsDisplay(detailedStats);
        }

        function updateDetailedStatsDisplay(stats) {
            const container = document.getElementById('detailedStudentStats');
            
            if (stats.length > 0) {
                container.innerHTML = stats.map(student => {
                    const percentClass = student.attendanceRate >= 80 ? 'percentage-high' : 
                                       student.attendanceRate >= 60 ? 'percentage-medium' : 'percentage-low';
                    return `
                        <div class="student-detail">
                            <div>
                                <div class="student-name">${student.name}</div>
                                <small>${student.totalRecords} records across ${student.uniqueDays} days</small>
                            </div>
                            <div style="text-align: right;">
                                <div class="analytics-percentage ${percentClass}">${student.attendanceRate}%</div>
                                <small>P: ${student.presentCount} | A: ${student.absentCount}</small>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="analytics-empty">No detailed statistics available</div>';
            }
        }

        function showEmptyAnalytics() {
            document.getElementById('highestAttendanceList').innerHTML = '<li class="analytics-empty">No data for selected period</li>';
            document.getElementById('lowestAttendanceList').innerHTML = '<li class="analytics-empty">No data for selected period</li>';
            document.getElementById('individualAbsenceList').innerHTML = '<li class="analytics-empty">No data for selected period</li>';
            document.getElementById('absenceTimeline').innerHTML = '<div class="analytics-empty">No data for selected period</div>';
            document.getElementById('detailedStudentStats').innerHTML = '<div class="analytics-empty">No data for selected period</div>';
        }

        // Penalties System Functions
        function togglePenaltiesView() {
            const penaltiesSection = document.getElementById('penaltiesSection');
            const viewPenaltiesBtn = document.getElementById('viewPenaltiesBtn');
            const isVisible = penaltiesSection.style.display !== 'none';
            
            if (isVisible) {
                viewPenaltiesBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> View Penalties';
                penaltiesSection.style.display = 'none';
            } else {
                viewPenaltiesBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Hide Penalties';
                penaltiesSection.style.display = 'block';
                generatePenalties();
                
                // Scroll to penalties section
                penaltiesSection.scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }
        }
        
        function generatePenalties() {
            const filterPeriod = document.getElementById('penaltiesFilter').value;
            console.log('generatePenalties called with filter:', filterPeriod);
            
            const filteredPenalties = getPenaltiesData(filterPeriod);
            
            console.log('Filtered penalties results:', {
                period: filterPeriod,
                penaltyCount: filteredPenalties.length
            });
            
            if (filteredPenalties.length === 0) {
                console.log('No penalties available, showing empty penalties');
                showEmptyPenalties();
                updatePenaltySummary([]);
                return;
            }

            // Generate all penalty displays
            generateStudentPenalties(filteredPenalties);
            generateRecentLateArrivals(filteredPenalties);
            generatePenaltyDetails(filteredPenalties);
            updatePenaltySummary(filteredPenalties);
        }
        
        function getPenaltiesData(period) {
            let filteredPenalties = [...penaltiesData];
            
            if (period !== 'all') {
                const now = new Date();
                let startDate;
                
                switch (period) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'last7days':
                        startDate = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                        break;
                    case 'last30days':
                        startDate = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                        break;
                    case 'thismonth':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'lastmonth':
                        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                        filteredPenalties = filteredPenalties.filter(penalty => {
                            const penaltyDate = new Date(penalty.timestamp);
                            return penaltyDate >= lastMonth && penaltyDate <= lastMonthEnd;
                        });
                        return filteredPenalties;
                    default:
                        return filteredPenalties;
                }
                
                filteredPenalties = filteredPenalties.filter(penalty => 
                    new Date(penalty.timestamp) >= startDate
                );
            }
            
            return filteredPenalties;
        }
        
        function generateStudentPenalties(penalties) {
            const studentPenalties = {};
            
            penalties.forEach(penalty => {
                if (!studentPenalties[penalty.studentName]) {
                    studentPenalties[penalty.studentName] = {
                        name: penalty.studentName,
                        totalAmount: 0,
                        count: 0,
                        latestPenalty: penalty.timestamp
                    };
                }
                
                studentPenalties[penalty.studentName].totalAmount += penalty.amount;
                studentPenalties[penalty.studentName].count++;
                
                if (penalty.timestamp > studentPenalties[penalty.studentName].latestPenalty) {
                    studentPenalties[penalty.studentName].latestPenalty = penalty.timestamp;
                }
            });
            
            const sortedStudents = Object.values(studentPenalties)
                .sort((a, b) => b.totalAmount - a.totalAmount);
            
            updateStudentPenaltiesList(sortedStudents);
        }
        
        function updateStudentPenaltiesList(students) {
            const container = document.getElementById('studentPenaltiesList');
            
            if (students.length > 0) {
                container.innerHTML = students.map(student => `
                    <li class="penalties-item">
                        <div>
                            <span class="penalty-student-name">${student.name}</span>
                            <div class="penalty-details">
                                <span><i class="fas fa-calendar-times"></i> ${student.count} late arrival${student.count !== 1 ? 's' : ''}</span>
                                <span><i class="fas fa-clock"></i> Latest: ${new Date(student.latestPenalty).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <span class="penalty-amount">${student.totalAmount} AED</span>
                    </li>
                `).join('');
            } else {
                container.innerHTML = '<li class="penalties-empty">No student penalties found</li>';
            }
        }
        
        function generateRecentLateArrivals(penalties) {
            const recentPenalties = penalties
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10); // Show last 10 late arrivals
            
            updateRecentLateArrivalsList(recentPenalties);
        }
        
        function updateRecentLateArrivalsList(recentPenalties) {
            const container = document.getElementById('recentLateArrivalsList');
            
            if (recentPenalties.length > 0) {
                container.innerHTML = recentPenalties.map(penalty => `
                    <li class="penalties-item">
                        <div>
                            <span class="penalty-student-name">${penalty.studentName}</span>
                            <div class="penalty-details">
                                <span><i class="fas fa-calendar"></i> ${penalty.date}</span>
                                <span><i class="fas fa-clock"></i> ${penalty.time}</span>
                            </div>
                        </div>
                        <span class="penalty-amount">${penalty.amount} AED</span>
                    </li>
                `).join('');
            } else {
                container.innerHTML = '<li class="penalties-empty">No recent late arrivals found</li>';
            }
        }
        
        function generatePenaltyDetails(penalties) {
            const container = document.getElementById('penaltyDetailsContainer');
            
            if (penalties.length > 0) {
                const sortedPenalties = penalties.sort((a, b) => b.timestamp - a.timestamp);
                
                container.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f8f9fa; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left;">Student</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left;">Date</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left;">Time</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: center;">Amount</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left;">Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedPenalties.map((penalty, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: 600;">${penalty.studentName}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${penalty.date}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${penalty.time}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: center; color: #e74c3c; font-weight: 700;">${penalty.amount} AED</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d;">${penalty.reason}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                container.innerHTML = '<div class="penalties-empty">No penalty details available</div>';
            }
        }
        
        function updatePenaltySummary(penalties) {
            const stats = getPenaltyStatistics();
            
            document.getElementById('totalPenaltyAmount').textContent = `${stats.totalAmount} AED`;
            document.getElementById('totalLateArrivals').textContent = stats.totalCount;
            document.getElementById('studentsWithPenalties').textContent = stats.uniqueStudents;
            document.getElementById('averagePenaltyPerStudent').textContent = `${stats.averagePerStudent.toFixed(2)} AED`;
        }
        
        function showEmptyPenalties() {
            document.getElementById('studentPenaltiesList').innerHTML = '<li class="penalties-empty">No student penalties found for selected period</li>';
            document.getElementById('recentLateArrivalsList').innerHTML = '<li class="penalties-empty">No late arrivals found for selected period</li>';
            document.getElementById('penaltyDetailsContainer').innerHTML = '<div class="penalties-empty">No penalty details available for selected period</div>';
        }
        
        function exportPenaltiesToPDF() {
            try {
                const filterPeriod = document.getElementById('penaltiesFilter').value;
                const filteredPenalties = getPenaltiesData(filterPeriod);
                
                if (filteredPenalties.length === 0) {
                    showMessage('No penalties data to export for the selected period.', 'warning');
                    return;
                }
                
                // Set button loading state
                const exportBtn = document.getElementById('exportPenaltiesPdfBtn');
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                exportBtn.disabled = true;
                
                // Create new PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title and header information
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Late Arrival Penalties Report', 14, 22);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 32);
                
                const filterText = document.getElementById('penaltiesFilter').selectedOptions[0].text;
                doc.text(`Period: ${filterText}`, 14, 40);
                doc.text(`Total Penalties: ${filteredPenalties.length}`, 14, 48);
                
                // Get penalty statistics
                const stats = getPenaltyStatistics();
                doc.text(`Total Amount: ${stats.totalAmount} AED`, 14, 56);
                doc.text(`Students Affected: ${stats.uniqueStudents}`, 14, 64);
                
                // Prepare penalty data for the table
                const penaltyData = filteredPenalties
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .map((penalty, index) => [
                        (index + 1).toString(),
                        penalty.studentName,
                        penalty.date,
                        penalty.time,
                        `${penalty.amount} AED`,
                        penalty.reason
                    ]);
                
                // Create table headers
                const headers = [['#', 'Student Name', 'Date', 'Time', 'Amount', 'Reason']];
                
                // Add table to PDF
                doc.autoTable({
                    head: headers,
                    body: penaltyData,
                    startY: 75,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [231, 76, 60], // Red theme for penalties
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [252, 245, 245] // Light red
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 8 },   // # (reduced from 10)
                        1: { cellWidth: 35 },                    // Student Name (reduced from 40)
                        2: { halign: 'center', cellWidth: 22 },  // Date (reduced from 25)
                        3: { halign: 'center', cellWidth: 18 },  // Time (reduced from 20)
                        4: { halign: 'center', cellWidth: 22 },  // Amount (reduced from 25)
                        5: { cellWidth: 55 }                     // Reason (reduced from 60)
                    },
                    styles: {
                        fontSize: 9,
                        cellPadding: 3,
                        overflow: 'linebreak',
                    },
                    didParseCell: function(data) {
                        // Highlight penalty amounts in red
                        if (data.column.index === 4) { // Amount column
                            data.cell.styles.textColor = [231, 76, 60];
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                });
                
                // Add summary section
                const finalY = doc.lastAutoTable.finalY || 75;
                if (finalY < 250) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Summary Statistics', 14, finalY + 20);
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Total Penalty Amount: ${stats.totalAmount} AED`, 14, finalY + 32);
                    doc.text(`Total Late Arrivals: ${stats.totalCount}`, 14, finalY + 40);
                    doc.text(`Students with Penalties: ${stats.uniqueStudents}`, 14, finalY + 48);
                    doc.text(`Average per Student: ${stats.averagePerStudent.toFixed(2)} AED`, 14, finalY + 56);
                }
                
                // Add footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Attendance System - Penalty Rate: ${PENALTY_AMOUNT} AED per late arrival`, 14, 285);
                doc.text(`Page 1 of 1`, 180, 285);
                
                // Save the PDF
                const currentDate = new Date().toISOString().split('T')[0];
                const fileName = `Penalties_Report_${filterText.replace(/\s+/g, '_')}_${currentDate}.pdf`;
                doc.save(fileName);
                
                showMessage(`ðŸ“‹ Penalties report exported successfully!\nðŸ“„ File: ${fileName}\nðŸ’° Total: ${stats.totalAmount} AED\nðŸ‘¥ ${stats.uniqueStudents} students affected`, 'success');
                
            } catch (error) {
                console.error('Error generating penalties PDF:', error);
                showMessage('Error generating penalties PDF report. Please try again.', 'error');
            } finally {
                // Reset button state
                const exportBtn = document.getElementById('exportPenaltiesPdfBtn');
                exportBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Export PDF';
                exportBtn.disabled = false;
            }
        }
        
        function clearPenaltyData() {
            if (!confirm('Are you sure you want to clear all penalty data? This action cannot be undone.')) {
                return;
            }
            
            penaltiesData = [];
            savePenaltiesData();
            
            // Update display if penalties section is visible
            if (document.getElementById('penaltiesSection').style.display !== 'none') {
                generatePenalties();
            }
            
            showMessage('All penalty data has been cleared.', 'success');
        }

        function downloadExcel() {
            try {
                console.log('Download Excel clicked. Current attendanceData length:', attendanceData.length);
                console.log('First 3 records:', attendanceData.slice(0, 3));
                
                if (attendanceData.length === 0) {
                    showMessage('No data to export. Please submit some attendance records first.', 'warning');
                    return;
                }
                
                showLoading(true);
                
                // Prepare data for Excel with backward compatibility
                const excelData = attendanceData.map((record, index) => {
                    // Get student ID and name for display
                    let studentId = 'N/A';
                    let studentName = 'Unknown Student';
                    
                    if (record.studentId && record.studentName) {
                        // New format
                        studentId = record.studentId;
                        studentName = record.studentName;
                    } else if (record.studentName || record.employeeName) {
                        // Has name but no ID
                        studentName = record.studentName || record.employeeName;
                    } else {
                        // Legacy format - lookup from activeStudents
                        const studentInfo = activeStudents[record.student || record.employee];
                        if (typeof studentInfo === 'object') {
                            studentId = studentInfo.id;
                            studentName = studentInfo.name;
                        } else {
                            studentName = studentInfo || record.student || record.employee || 'Unknown Student';
                        }
                    }
                    
                    // Get action/attendance status
                    let actionStatus = 'N/A';
                    if (record.attendanceLabel) {
                        actionStatus = record.attendanceLabel;
                    } else if (record.attendanceStatus) {
                        actionStatus = record.attendanceStatus === 'present' ? 'Present' : 'Absent';
                    } else if (record.actionLabel) {
                        actionStatus = record.actionLabel;
                    } else if (record.actionType) {
                        // Legacy format mapping
                        const actionTypeMapping = {
                            'check-in': 'Present',
                            'check-out': 'Absent',
                            'break': 'Break',
                            'lunch': 'Lunch',
                            'meeting': 'Meeting',
                            'sick-leave': 'Sick Leave',
                            'vacation': 'Vacation'
                        };
                        actionStatus = actionTypeMapping[record.actionType] || record.actionType;
                    }
                    
                    return {
                        'No.': index + 1,
                        'Student ID': studentId,
                        'Student Name': studentName,
                        'Action': actionStatus,
                        'Date': record.date,
                        'Time': record.time,
                        'Latitude': record.latitude,
                        'Longitude': record.longitude,
                        'Address': record.address
                    };
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Auto-resize columns
                const colWidths = [
                    {wch: 5},   // No.
                    {wch: 12},  // Student ID
                    {wch: 25},  // Student Name
                    {wch: 15},  // Action
                    {wch: 12},  // Date
                    {wch: 12},  // Time
                    {wch: 12},  // Latitude
                    {wch: 12},  // Longitude
                    {wch: 40}   // Address
                ];
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Student Attendance Records');
                
                // Generate filename with current date
                const now = new Date();
                const filename = `student_attendance_records_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, filename);
                
                showMessage(`Excel file downloaded: ${filename}`, 'success');
                
            } catch (error) {
                showMessage(`Error creating Excel file: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function exportFilteredRecordsToPdf() {
            try {
                // Get records directly from what's currently displayed in the table
                const tableRows = elements.recordsTableBody.querySelectorAll('tr');
                
                if (tableRows.length === 0) {
                    showMessage('No records to export. The table is empty or no records match your filters.', 'warning');
                    return;
                }
                
                // Check if showing "No records found" message
                if (tableRows.length === 1 && tableRows[0].innerHTML.includes('No records found')) {
                    showMessage('No records to export. Please adjust your filters or add some attendance records.', 'warning');
                    return;
                }
                
                showLoading(true);
                
                // Create new PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title and header information
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Attendance Records Report', 14, 22);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 32);
                doc.text(`Total Records: ${tableRows.length}`, 14, 40);
                
                // Get current filter values for display
                const filterDate = elements.filterDate.value;
                const filterStudent = elements.filterEmployee.value;
                const filterStatus = elements.filterAction.value;
                
                let filterInfo = 'Filters Applied: ';
                if (filterDate) filterInfo += `Date: ${filterDate} `;
                if (filterStudent) {
                    const studentInfo = activeStudents[filterStudent];
                    const studentName = typeof studentInfo === 'string' ? studentInfo : (studentInfo?.name || filterStudent);
                    filterInfo += `Student: ${studentName} `;
                }
                if (filterStatus) filterInfo += `Status: ${filterStatus} `;
                if (!filterDate && !filterStudent && !filterStatus) filterInfo += 'None (All Records)';
                
                doc.setFontSize(10);
                doc.text(filterInfo, 14, 48);
                
                // Extract data directly from table rows
                const tableData = [];
                let presentCount = 0;
                let absentCount = 0;
                
                tableRows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 6) { // Make sure we have enough cells including notes
                        const studentName = cells[1].textContent.trim(); // Student column
                        const status = cells[2].textContent.trim(); // Action/Status column
                        const date = cells[3].textContent.trim(); // Date column
                        const time = cells[4].textContent.trim(); // Time column
                        const notes = cells[6] ? cells[6].textContent.trim() : ''; // Notes column (index 6, location is 5)
                        
                        // Count status for statistics
                        if (status.toLowerCase().includes('present')) {
                            presentCount++;
                        } else if (status.toLowerCase().includes('absent')) {
                            absentCount++;
                        }
                        
                        tableData.push([
                            (index + 1).toString(),
                            studentName,
                            status,
                            date,
                            time,
                            notes || '-' // Show dash if no notes
                        ]);
                    }
                });
                
                // Create table headers
                const headers = [['#', 'Student Name', 'Status', 'Date', 'Time', 'Notes']];
                
                // Add table to PDF using the data from displayed table
                doc.autoTable({
                    head: headers,
                    body: tableData,
                    startY: 55,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [52, 73, 94],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 8 },   // # (reduced from 10)
                        1: { cellWidth: 32 },                    // Student Name (reduced from 35)
                        2: { halign: 'center', cellWidth: 18 },  // Status (reduced from 20)
                        3: { halign: 'center', cellWidth: 23 },  // Date (reduced from 25)
                        4: { halign: 'center', cellWidth: 23 },  // Time (reduced from 25)
                        5: { cellWidth: 36 }                     // Notes (reduced from 40)
                    },
                    styles: {
                        fontSize: 9,                             // Reduced from 10
                        cellPadding: 3,                          // Reduced from 4
                        overflow: 'linebreak',                   // Allow text wrapping
                        cellWidth: 'wrap'                        // Auto-wrap long content
                    },
                    margin: { top: 55, left: 14, right: 14 },
                    tableWidth: 'auto',                          // Auto-adjust table width
                    showHead: 'everyPage'                        // Show headers on every page
                });
                
                // Add summary statistics at the bottom
                const finalY = doc.lastAutoTable.finalY + 15;
                
                // Calculate attendance rate from table data (already counted above)
                const attendanceRate = tableData.length > 0 ? 
                    Math.round((presentCount / tableData.length) * 100) : 0;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Summary Statistics:', 14, finalY);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text('Present: ' + presentCount + ' records', 14, finalY + 10);
                doc.text('Absent: ' + absentCount + ' records', 14, finalY + 18);
                doc.text('Attendance Rate: ' + attendanceRate + '%', 14, finalY + 26);
                
                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                    doc.text('Generated by Attendance Tracker v3.0', 14, doc.internal.pageSize.height - 10);
                }
                
                // Generate filename with filter info
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
                const timeStr = `${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}`;
                
                let filename = `attendance_report_${dateStr}_${timeStr}`;
                if (filterStudent) {
                    const studentInfo = activeStudents[filterStudent];
                    const studentName = typeof studentInfo === 'string' ? studentInfo : (studentInfo?.name || filterStudent);
                    filename += `_${studentName.replace(/\s+/g, '_')}`;
                }
                if (filterStatus) {
                    filename += `_${filterStatus}`;
                }
                filename += '.pdf';
                
                // Save the PDF
                doc.save(filename);
                
                showMessage(`ðŸ“„ PDF exported successfully: ${filename}\nðŸ“Š ${tableData.length} records exported\nðŸ“ˆ ${attendanceRate}% attendance rate`, 'success');
                
            } catch (error) {
                console.error('PDF Export Error:', error);
                showMessage(`Error creating PDF: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function sendEmailReport() {
            try {
                const emailAddress = elements.reportEmail.value.trim();
                
                if (!emailAddress) {
                    showMessage('Please enter an email address', 'warning');
                    elements.reportEmail.focus();
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(emailAddress)) {
                    showMessage('Please enter a valid email address', 'warning');
                    elements.reportEmail.focus();
                    return;
                }
                
                if (attendanceData.length === 0) {
                    showMessage('No attendance data to include in the report', 'warning');
                    return;
                }
                
                showLoading(true);
                
                // Generate comprehensive analytics
                const analytics = generateAttendanceAnalytics();
                
                // Create professional email subject and body
                const reportDate = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const emailSubject = `ðŸ“Š Attendance Analytics Report - ${reportDate}`;
                
                let emailBody = `ðŸŽ“ ATTENDANCE TRACKING SYSTEM - ANALYTICS REPORT\n`;
                emailBody += `${'='.repeat(55)}\n\n`;
                
                emailBody += `ðŸ“… Report Generated: ${new Date().toLocaleString()}\n`;
                emailBody += `ðŸ“Š Analysis Period: ${analytics.dateRange}\n`;
                emailBody += `â±ï¸  Last Updated: ${analytics.lastRecordTime}\n\n`;
                
                // KEY METRICS
                emailBody += `ðŸ“ˆ KEY PERFORMANCE INDICATORS\n`;
                emailBody += `${'-'.repeat(35)}\n`;
                emailBody += `ðŸ‘¥ Total Students Tracked: ${analytics.totalStudents}\n`;
                emailBody += `ðŸ“‹ Total Records: ${analytics.totalRecords}\n`;
                emailBody += `âœ… Present Records: ${analytics.presentCount} (${analytics.presentPercentage}%)\n`;
                emailBody += `âŒ Absent Records: ${analytics.absentCount} (${analytics.absentPercentage}%)\n`;
                emailBody += `ðŸ“Š Attendance Rate: ${analytics.attendanceRate}%\n\n`;
                
                // TODAY'S SUMMARY
                emailBody += `ðŸ—“ï¸  TODAY'S SUMMARY\n`;
                emailBody += `${'-'.repeat(20)}\n`;
                emailBody += `ðŸ“ Records Today: ${analytics.todayRecords}\n`;
                emailBody += `âœ… Present Today: ${analytics.todayPresent}\n`;
                emailBody += `âŒ Absent Today: ${analytics.todayAbsent}\n`;
                emailBody += `ðŸ“ˆ Today's Rate: ${analytics.todayRate}%\n\n`;
                
                // STUDENT BREAKDOWN
                if (analytics.studentBreakdown.length > 0) {
                    emailBody += `ðŸ‘¨â€ðŸŽ“ STUDENT ATTENDANCE BREAKDOWN\n`;
                    emailBody += `${'-'.repeat(35)}\n`;
                    analytics.studentBreakdown.forEach(student => {
                        emailBody += `â€¢ ${student.name}: ${student.presentCount}P/${student.absentCount}A (${student.rate}% rate)\n`;
                    });
                    emailBody += `\n`;
                }
                
                // RECENT ACTIVITY
                if (analytics.recentActivity.length > 0) {
                    emailBody += `ðŸ• RECENT ACTIVITY (Last 5 Records)\n`;
                    emailBody += `${'-'.repeat(35)}\n`;
                    analytics.recentActivity.forEach((record, index) => {
                        emailBody += `${index + 1}. ${record.name} - ${record.status} (${record.time})\n`;
                    });
                    emailBody += `\n`;
                }
                
                // INSIGHTS & RECOMMENDATIONS
                emailBody += `ðŸ’¡ INSIGHTS & RECOMMENDATIONS\n`;
                emailBody += `${'-'.repeat(35)}\n`;
                analytics.insights.forEach(insight => {
                    emailBody += `â€¢ ${insight}\n`;
                });
                emailBody += `\n`;
                
                // FOOTER
                emailBody += `${'-'.repeat(55)}\n`;
                emailBody += `ðŸ”— Access full system: [Your attendance tracker URL]\n`;
                emailBody += `ðŸ“ž Support: Contact your system administrator\n`;
                emailBody += `âš¡ Generated automatically by Attendance Tracking System\n`;
                
                // Create mailto link
                const mailtoLink = `mailto:${emailAddress}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                
                // Open email client
                window.open(mailtoLink);
                
                showMessage(`ðŸ“§ Professional analytics report prepared for: ${emailAddress}`, 'success');
                
                // Clear the email field
                elements.reportEmail.value = '';
                
            } catch (error) {
                showMessage(`Error preparing email report: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Analytics generation function
        function generateAttendanceAnalytics() {
            const today = new Date().toDateString();
            const analytics = {
                totalRecords: attendanceData.length,
                totalStudents: 0,
                presentCount: 0,
                absentCount: 0,
                presentPercentage: 0,
                absentPercentage: 0,
                attendanceRate: 0,
                todayRecords: 0,
                todayPresent: 0,
                todayAbsent: 0,
                todayRate: 0,
                dateRange: '',
                lastRecordTime: '',
                studentBreakdown: [],
                recentActivity: [],
                insights: []
            };
            
            if (attendanceData.length === 0) return analytics;
            
            // Calculate basic metrics
            const studentStats = {};
            let earliestDate = null;
            let latestDate = null;
            
            attendanceData.forEach(record => {
                // Get student info
                const studentId = record.student || record.studentId || 'Unknown';
                const studentInfo = activeStudents[studentId];
                const studentName = studentInfo ? 
                    (studentInfo.name || `${studentInfo.firstName} ${studentInfo.lastName}`) : 
                    studentId;
                
                // Initialize student stats
                if (!studentStats[studentId]) {
                    studentStats[studentId] = {
                        name: studentName,
                        presentCount: 0,
                        absentCount: 0,
                        totalCount: 0
                    };
                }
                
                // Count attendance
                const status = record.status || record.attendanceStatus;
                if (status === 'present') {
                    analytics.presentCount++;
                    studentStats[studentId].presentCount++;
                } else {
                    analytics.absentCount++;
                    studentStats[studentId].absentCount++;
                }
                studentStats[studentId].totalCount++;
                
                // Today's stats
                const recordDate = new Date(record.date).toDateString();
                if (recordDate === today) {
                    analytics.todayRecords++;
                    if (status === 'present') {
                        analytics.todayPresent++;
                    } else {
                        analytics.todayAbsent++;
                    }
                }
                
                // Date range
                const recordDateObj = new Date(record.date);
                if (!earliestDate || recordDateObj < earliestDate) earliestDate = recordDateObj;
                if (!latestDate || recordDateObj > latestDate) latestDate = recordDateObj;
            });
            
            // Calculate percentages
            analytics.totalStudents = Object.keys(studentStats).length;
            analytics.presentPercentage = Math.round((analytics.presentCount / analytics.totalRecords) * 100) || 0;
            analytics.absentPercentage = Math.round((analytics.absentCount / analytics.totalRecords) * 100) || 0;
            analytics.attendanceRate = analytics.presentPercentage;
            analytics.todayRate = analytics.todayRecords > 0 ? 
                Math.round((analytics.todayPresent / analytics.todayRecords) * 100) : 0;
            
            // Date range
            if (earliestDate && latestDate) {
                analytics.dateRange = earliestDate.toDateString() === latestDate.toDateString() ? 
                    earliestDate.toLocaleDateString() : 
                    `${earliestDate.toLocaleDateString()} - ${latestDate.toLocaleDateString()}`;
            }
            
            // Last record time
            if (attendanceData.length > 0) {
                const lastRecord = attendanceData[0]; // Most recent (array is newest first)
                analytics.lastRecordTime = `${lastRecord.date} at ${lastRecord.time}`;
            }
            
            // Student breakdown
            analytics.studentBreakdown = Object.values(studentStats).map(student => ({
                ...student,
                rate: student.totalCount > 0 ? Math.round((student.presentCount / student.totalCount) * 100) : 0
            })).sort((a, b) => b.rate - a.rate);
            
            // Recent activity (last 5 records)
            analytics.recentActivity = attendanceData.slice(0, 5).map(record => {
                const studentId = record.student || record.studentId || 'Unknown';
                const studentInfo = activeStudents[studentId];
                const studentName = studentInfo ? 
                    (studentInfo.name || `${studentInfo.firstName} ${studentInfo.lastName}`) : 
                    studentId;
                const status = record.status || record.attendanceStatus;
                
                return {
                    name: studentName,
                    status: status === 'present' ? 'âœ… Present' : 'âŒ Absent',
                    time: `${record.date} ${record.time}`
                };
            });
            
            // Generate insights
            if (analytics.attendanceRate >= 90) {
                analytics.insights.push('ðŸŽ‰ Excellent attendance rate! Keep up the great work.');
            } else if (analytics.attendanceRate >= 75) {
                analytics.insights.push('ðŸ‘ Good attendance rate, but room for improvement.');
            } else {
                analytics.insights.push('âš ï¸ Low attendance rate requires attention and intervention.');
            }
            
            if (analytics.todayRecords > 0) {
                if (analytics.todayRate > analytics.attendanceRate) {
                    analytics.insights.push('ðŸ“ˆ Today\'s attendance is above average - positive trend!');
                } else if (analytics.todayRate < analytics.attendanceRate) {
                    analytics.insights.push('ðŸ“‰ Today\'s attendance is below average - monitor closely.');
                }
            }
            
            if (analytics.totalStudents > 0) {
                const lowAttendanceStudents = analytics.studentBreakdown.filter(s => s.rate < 50).length;
                if (lowAttendanceStudents > 0) {
                    analytics.insights.push(`ðŸ” ${lowAttendanceStudents} student(s) have attendance below 50% - consider intervention.`);
                }
            }
            
            return analytics;
        }

        // Test functions for debugging
        function testEmailForm() {
            console.log('ðŸ§ª TESTING EMAIL FORM FUNCTIONALITY...');
            console.log('attendanceData length:', attendanceData.length);
            console.log('activeStudents count:', Object.keys(activeStudents).length);
            
            if (attendanceData.length === 0) {
                // Add comprehensive test data
                const testStudents = ['STU001', 'STU002', 'STU003', 'STU004', 'STU005'];
                const statuses = ['present', 'absent'];
                
                testStudents.forEach((studentId, index) => {
                    // Add student to activeStudents if not exists
                    if (!activeStudents[studentId]) {
                        activeStudents[studentId] = {
                            firstName: `Test Student ${index + 1}`,
                            lastName: `LastName${index + 1}`,
                            id: studentId
                        };
                    }
                    
                    // Add multiple attendance records per student
                    for (let i = 0; i < 5; i++) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const status = i < 2 ? 'present' : (Math.random() > 0.7 ? 'absent' : 'present');
                        
                        attendanceData.push({
                            student: studentId,
                            status: status,
                            date: date.toLocaleDateString(),
                            time: `${8 + i}:00 AM`,
                            latitude: '25.316557',
                            longitude: '55.374643',
                            address: `Test Location ${index + 1}`
                        });
                    }
                });
                
                console.log('âœ… Added comprehensive test data');
                console.log('Total records:', attendanceData.length);
                console.log('Students:', Object.keys(activeStudents));
            }
            
            // Test analytics generation
            const analytics = generateAdvancedAnalytics('weekly');
            console.log('ðŸ“Š Generated analytics:', analytics);
            
            // Test checkbox functionality
            const checkboxes = getSelectedCheckboxes();
            console.log('ðŸ“‹ Default checkboxes:', checkboxes);
            
            // Test report content generation
            const reportContent = generateReportContent(analytics, 'weekly');
            console.log('ðŸ“„ Generated report content length:', reportContent.length);
            console.log('ðŸ“„ Report preview (first 500 chars):', reportContent.substring(0, 500));
            
            // Open the email form
            openEmailForm();
            
            console.log('ðŸŽ¯ Email form test complete - check the modal!');
        }
        
        function testCompleteEmailWorkflow() {
            console.log('ðŸš€ TESTING COMPLETE EMAIL WORKFLOW...');
            
            // First ensure we have test data
            testEmailForm();
            
            // Wait a moment for the modal to open, then simulate form filling
            setTimeout(() => {
                try {
                    // Fill out the form with test data
                    const recipientEmail = document.getElementById('recipientEmail');
                    const recipientName = document.getElementById('recipientName');
                    const reportTypeSelect = document.getElementById('reportType');
                    
                    if (recipientEmail) recipientEmail.value = 'test@example.com';
                    if (recipientName) recipientName.value = 'Test Manager';
                    if (reportTypeSelect) reportTypeSelect.value = 'weekly';
                    
                    // Check all content options
                    const checkboxes = [
                        'includeSummary', 'includeStatistics', 'includeAbsentees',
                        'includePerfectAttendance', 'includeTrends', 'includeAlerts',
                        'includeCharts', 'includeDetails'
                    ];
                    
                    checkboxes.forEach(checkboxId => {
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) {
                            checkbox.checked = true;
                            console.log(`âœ… Checked ${checkboxId}`);
                        }
                    });
                    
                    console.log('ðŸ“‹ Form filled with test data - now test the Generate Email button!');
                    console.log('ðŸ’¡ Click "Generate Email" to see the full customized report.');
                    
                } catch (error) {
                    console.error('âŒ Error in test workflow:', error);
                }
            }, 1000);
        }
        
        function testClearData() {
            console.log('Testing clear data...');
            clearAllData();
        }

        // Simple Email Functions
        function openEmailForm() {
            console.log('Opening simple email form...');
            
            if (elements.emailFormModal) {
                elements.emailFormModal.style.display = 'flex';
                elements.emailFormModal.style.alignItems = 'center';
                elements.emailFormModal.style.justifyContent = 'center';
                elements.emailFormModal.style.position = 'fixed';
                elements.emailFormModal.style.top = '0';
                elements.emailFormModal.style.left = '0';
                elements.emailFormModal.style.width = '100%';
                elements.emailFormModal.style.height = '100%';
                elements.emailFormModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                elements.emailFormModal.style.zIndex = '1000';
            }
        }

        function closeEmailForm() {
            if (elements.emailFormModal) {
                elements.emailFormModal.style.display = 'none';
            }
        }
        
        function sendSimpleEmail() {
            const recipientEmail = document.getElementById('recipientEmail').value;
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            
            if (!recipientEmail) {
                alert('Please enter an email address.');
                return;
            }
            
            // Get ALL records instead of just today's records
            let recordsToInclude = attendanceData.slice(); // Copy all records
            
            // Sort records by date and time (newest first)
            recordsToInclude.sort((a, b) => {
                const dateA = new Date(a.dateTime || `${a.date} ${a.time}`);
                const dateB = new Date(b.dateTime || `${b.date} ${b.time}`);
                return dateB - dateA; // Newest first
            });
            
            // Calculate analytics for beautiful insights
            const analytics = calculateEmailAnalytics(recordsToInclude);
            
            // Create beautiful email content
            let emailContent = `
ðŸ“Š ATTENDANCE ANALYSIS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“… Report Period: ${analytics.dateRange}
ðŸ”¢ Total Records: ${recordsToInclude.length}
ðŸ‘¥ Active Students: ${Object.keys(activeStudents).length}
ðŸ“ˆ Overall Attendance Rate: ${analytics.attendanceRate}%

${analytics.quickInsights}

`;

            // Show records based on selection with beautiful formatting
            if (reportType === 'present') {
                emailContent += generatePresentStudentsReport(recordsToInclude, analytics);
            }
            else if (reportType === 'absent') {
                emailContent += generateAbsentStudentsReport(recordsToInclude, analytics);
            }
            else { // both
                emailContent += generateCompleteAttendanceReport(recordsToInclude, analytics);
            }

            emailContent += `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“± Generated: ${new Date().toLocaleString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}
ðŸŽ¯ System: Attendance Tracker v3.0
`;
            
            // Open email with beautiful subject
            const subject = `ðŸ“Š Attendance Report (${analytics.periodSummary}) - ${analytics.attendanceRate}% Rate`;
            const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailContent)}`;
            window.location.href = mailtoLink;
            
            alert(`ðŸ“§ Beautiful email report ready!\nðŸ“Š ${recordsToInclude.length} records analyzed\nðŸ“ˆ ${analytics.attendanceRate}% attendance rate`);
            closeEmailForm();
        }
        
        // Helper function to calculate email analytics
        function calculateEmailAnalytics(records) {
            if (records.length === 0) {
                return {
                    attendanceRate: 0,
                    dateRange: 'No records',
                    periodSummary: 'Empty',
                    quickInsights: 'âŒ No attendance data available.'
                };
            }
            
            const presentCount = records.filter(r => {
                const status = (r.attendanceStatus || r.attendanceLabel || '').toString().toLowerCase();
                return status.includes('present') || status === 'p' || status === '1';
            }).length;
            
            const absentCount = records.filter(r => {
                const status = (r.attendanceStatus || r.attendanceLabel || '').toString().toLowerCase();
                return status.includes('absent') || status === 'a' || status === '0';
            }).length;
            
            const attendanceRate = records.length > 0 ? Math.round((presentCount / records.length) * 100) : 0;
            
            // Get date range
            const dates = records.map(r => new Date(r.dateTime || `${r.date} ${r.time}`));
            const oldestDate = new Date(Math.min(...dates));
            const newestDate = new Date(Math.max(...dates));
            
            const dateRange = oldestDate.toDateString() === newestDate.toDateString() 
                ? oldestDate.toLocaleDateString('en-US')
                : `${oldestDate.toLocaleDateString('en-US')} â†’ ${newestDate.toLocaleDateString('en-US')}`;
            
            const daysDifference = Math.ceil((newestDate - oldestDate) / (1000 * 60 * 60 * 24)) + 1;
            const periodSummary = daysDifference === 1 ? 'Today' : `${daysDifference} Days`;
            
            // Generate insights
            let insights = '';
            if (attendanceRate >= 90) {
                insights = 'ðŸŽ‰ EXCELLENT: Outstanding attendance performance!';
            } else if (attendanceRate >= 75) {
                insights = 'ðŸ‘ GOOD: Solid attendance with room for improvement.';
            } else if (attendanceRate >= 50) {
                insights = 'âš ï¸  NEEDS ATTENTION: Below average attendance detected.';
            } else {
                insights = 'ðŸš¨ CRITICAL: Poor attendance requires immediate action.';
            }
            
            const quickInsights = `
ðŸŽ¯ QUICK INSIGHTS:
${insights}
âœ… Present: ${presentCount} records (${attendanceRate}%)
âŒ Absent: ${absentCount} records (${100-attendanceRate}%)
ðŸ“Š Tracking Period: ${daysDifference} day(s)
`;
            
            return {
                attendanceRate,
                dateRange,
                periodSummary,
                quickInsights,
                presentCount,
                absentCount
            };
        }
        
        // Helper function for present students report
        function generatePresentStudentsReport(records, analytics) {
            let content = `
âœ… PRESENT STUDENTS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“ˆ SUCCESS RATE: ${analytics.presentCount}/${records.length} (${analytics.attendanceRate}%)

`;
            
            let count = 0;
            let currentDate = '';
            
            records.forEach(record => {
                const status = (record.attendanceStatus || record.attendanceLabel || '').toString().toLowerCase();
                if (status.includes('present') || status === 'p' || status === '1') {
                    count++;
                    const student = activeStudents[record.student];
                    const name = student ? student.name : (record.studentName || record.student);
                    
                    // Group by date for better visualization
                    if (currentDate !== record.date) {
                        currentDate = record.date;
                        content += `\nðŸ“… ${currentDate}\n${'â”€'.repeat(30)}\n`;
                    }
                    
                    content += `${count.toString().padStart(2, '0')}. âœ… ${name.padEnd(20)} â”‚ ${record.time}\n`;
                }
            });
            
            if (count === 0) {
                content += `âŒ No present students found in the selected period.\n`;
            }
            
            return content;
        }
        
        // Helper function for absent students report  
        function generateAbsentStudentsReport(records, analytics) {
            let content = `
âŒ ABSENT STUDENTS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“Š ABSENCE RATE: ${analytics.absentCount}/${records.length} (${100-analytics.attendanceRate}%)

`;
            
            let count = 0;
            let currentDate = '';
            
            records.forEach(record => {
                const status = (record.attendanceStatus || record.attendanceLabel || '').toString().toLowerCase();
                if (status.includes('absent') || status === 'a' || status === '0') {
                    count++;
                    const student = activeStudents[record.student];
                    const name = student ? student.name : (record.studentName || record.student);
                    
                    // Group by date for better visualization
                    if (currentDate !== record.date) {
                        currentDate = record.date;
                        content += `\nðŸ“… ${currentDate}\n${'â”€'.repeat(30)}\n`;
                    }
                    
                    content += `${count.toString().padStart(2, '0')}. âŒ ${name.padEnd(20)} â”‚ ${record.time}\n`;
                }
            });
            
            if (count === 0) {
                content += `âœ… No absent students found - Perfect attendance!\n`;
            }
            
            return content;
        }
        
        // Helper function for complete attendance report
        function generateCompleteAttendanceReport(records, analytics) {
            let content = `
ðŸ“Š COMPLETE ATTENDANCE OVERVIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“ˆ PERFORMANCE BREAKDOWN:
âœ… Present: ${analytics.presentCount} (${analytics.attendanceRate}%)
âŒ Absent:  ${analytics.absentCount} (${100-analytics.attendanceRate}%)

ðŸ“‹ DETAILED RECORDS:
`;
            
            let currentDate = '';
            
            records.forEach((record, index) => {
                const student = activeStudents[record.student];
                const name = student ? student.name : (record.studentName || record.student);
                const status = record.attendanceStatus || record.attendanceLabel || 'Unknown';
                const statusIcon = status.toLowerCase().includes('present') ? 'âœ…' : 'âŒ';
                
                // Group by date for better visualization
                if (currentDate !== record.date) {
                    currentDate = record.date;
                    content += `\nðŸ“… ${currentDate}\n${'â”€'.repeat(50)}\n`;
                }
                
                content += `${statusIcon} ${name.padEnd(20)} â”‚ ${status.padEnd(8)} â”‚ ${record.time}\n`;
            });
            
            return content;
        }

        function closeEmailPreview() {
            if (elements.emailPreviewModal) {
                elements.emailPreviewModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function previewEmailReport() {
            // This function shows a preview of the email report
            try {
                const recipientEmail = document.getElementById('recipientEmail')?.value || 'user@example.com';
                const reportType = document.querySelector('input[name="reportType"]:checked')?.value || 'both';
                const senderName = document.getElementById('senderName')?.value || 'System';
                
                const analytics = calculateEmailAnalytics(attendanceData);
                const content = generateReportContent(analytics, reportType);
                
                const modal = document.getElementById('emailPreviewModal');
                if (modal) {
                    modal.innerHTML = `
                        <div class="email-modal-content large">
                            <div class="email-modal-header">
                                <h3><i class="fas fa-eye"></i> Email Preview</h3>
                                <button class="email-modal-close" onclick="closeEmailPreview()">&times;</button>
                            </div>
                            <div style="padding: 20px;">
                                <h4>To: ${recipientEmail}</h4>
                                <h4>Subject: Attendance Report - ${analytics.periodSummary}</h4>
                                <div class="email-preview-content">
                                    <pre>${content}</pre>
                                </div>
                                <div style="margin-top: 20px; text-align: center;">
                                    <button class="email-btn primary" onclick="sendFinalEmail()">
                                        <i class="fas fa-paper-plane"></i> Send Email
                                    </button>
                                    <button class="email-btn secondary" onclick="closeEmailPreview()">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    modal.style.display = 'block';
                }
            } catch (error) {
                console.error('Preview error:', error);
                showMessage('âŒ Preview failed: ' + error.message, 'error');
            }
        }

        function sendFinalEmail() {
            try {
                const recipientEmail = document.getElementById('recipientEmail')?.value || 'user@example.com';
                const reportType = document.querySelector('input[name="reportType"]:checked')?.value || 'both';
                
                const analytics = calculateEmailAnalytics(attendanceData);
                const content = generateReportContent(analytics, reportType);
                const subject = `Attendance Report - ${analytics.periodSummary}`;
                
                const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(content)}`;
                window.location.href = mailtoLink;
                
                closeEmailPreview();
                closeEmailForm();
                showMessage('ðŸ“§ Email client opened successfully!', 'success');
            } catch (error) {
                console.error('Send email error:', error);
                showMessage('âŒ Failed to open email client', 'error');
            }
        }

        function handleEmailFormSubmit(event) {
            event.preventDefault();
            console.log('ðŸ“§ Email form submitted');
            
            try {
                const formData = new FormData(event.target);
                const emailData = {
                    to: formData.get('email-to') || '',
                    subject: formData.get('email-subject') || '',
                    message: formData.get('email-message') || '',
                    reportType: formData.get('report-type') || 'today'
                };
                
                console.log('Email data:', emailData);
                
                // Validate required fields
                if (!emailData.to) {
                    showMessage('âŒ Please enter recipient email', 'error');
                    return;
                }
                
                if (!emailData.subject) {
                    showMessage('âŒ Please enter email subject', 'error');
                    return;
                }
                
                // Generate and send the email
                previewEmailReport();
                
            } catch (error) {
                console.error('Email form submission error:', error);
                showMessage('âŒ Failed to process email form', 'error');
            }
        }

        function handleReportTypeChange() {
            const reportType = elements.reportType.value;
            const dateRangeSection = elements.dateRangeSection;
            
            if (dateRangeSection) {
                dateRangeSection.style.display = reportType === 'custom' ? 'flex' : 'none';
            }
            
            // Update subject line based on report type
            if (elements.emailSubject) {
                const reportTypes = {
                    'daily': 'Daily Attendance Report - {date}',
                    'weekly': 'Weekly Attendance Summary - {date}',
                    'monthly': 'Monthly Attendance Report - {date}',
                    'custom': 'Custom Attendance Report - {date}',
                    'alerts': 'Attendance Alert Report - {date}',
                    'comprehensive': 'Comprehensive Attendance Analysis - {date}'
                };
                
                elements.emailSubject.value = reportTypes[reportType] || 'Attendance Report - {date}';
            }
        }

        // Test functions for debugging
        function testEmailForm() {
            console.log('ðŸ§ª TESTING SIMPLE EMAIL FORM...');
            console.log('attendanceData length:', attendanceData.length);
            console.log('activeStudents count:', Object.keys(activeStudents).length);
            
            // Don't add test data if real data exists
            if (attendanceData.length > 0) {
                console.log('âœ… Using existing real data');
                
                // Debug current data
                const today = new Date();
                const todayFormatted = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
                const todayRecords = attendanceData.filter(record => record.date === todayFormatted);
                const presentToday = todayRecords.filter(r => r.status === 'present');
                const absentToday = todayRecords.filter(r => r.status === 'absent');
                
                console.log('ðŸ“Š Current data summary:');
                console.log('- Total records:', attendanceData.length);
                console.log('- Today records:', todayRecords.length);
                console.log('- Present today:', presentToday.length);
                console.log('- Absent today:', absentToday.length);
                console.log('- Date being used:', todayFormatted);
                console.log('- Sample dates in data:', attendanceData.slice(0, 5).map(r => r.date));
                
                openEmailForm();
                return;
            }
            
            // Only add test data if no real data exists
            if (attendanceData.length === 0) {
                // Add simple test data
                const today = new Date();
                const todayFormatted = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
                console.log('Creating test data for date:', todayFormatted);
                
                // Add some test students
                activeStudents['STU001'] = { firstName: 'John', lastName: 'Doe', id: 'STU001' };
                activeStudents['STU002'] = { firstName: 'Jane', lastName: 'Smith', id: 'STU002' };
                activeStudents['STU003'] = { firstName: 'Mike', lastName: 'Johnson', id: 'STU003' };
                activeStudents['STU004'] = { firstName: 'Sarah', lastName: 'Wilson', id: 'STU004' };
                activeStudents['STU005'] = { firstName: 'Tom', lastName: 'Brown', id: 'STU005' };
                
                // Add attendance records for today - Mix of present and absent
                attendanceData.push(
                    { student: 'STU001', status: 'present', date: todayFormatted, time: '8:00 AM', latitude: '25.316557', longitude: '55.374643', address: 'School Location' },
                    { student: 'STU002', status: 'absent', date: todayFormatted, time: '8:00 AM', latitude: '', longitude: '', address: '' },
                    { student: 'STU003', status: 'present', date: todayFormatted, time: '8:15 AM', latitude: '25.316557', longitude: '55.374643', address: 'School Location' },
                    { student: 'STU004', status: 'absent', date: todayFormatted, time: '8:00 AM', latitude: '', longitude: '', address: '' },
                    { student: 'STU005', status: 'present', date: todayFormatted, time: '8:10 AM', latitude: '25.316557', longitude: '55.374643', address: 'School Location' }
                );
                
                console.log('âœ… Added test data for today:', todayFormatted);
                console.log('Total records:', attendanceData.length);
                console.log('Sample record:', attendanceData[0]);
                updateDisplay();
            }
            
            openEmailForm();
        }
        
        // Quick test function to debug your real data
        function debugRealData() {
            console.log('ðŸ” DEBUGGING REAL DATA...');
            console.log('Total attendance records:', attendanceData.length);
            
            if (attendanceData.length > 0) {
                console.log('First 10 records with exact status values:');
                attendanceData.slice(0, 10).forEach((record, index) => {
                    console.log(`${index + 1}. Student: ${record.student}, Status: "${record.status}" (type: ${typeof record.status}), Date: "${record.date}", Time: ${record.time}`);
                });
                
                // Check today's records
                const today = new Date();
                const todayFormatted = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
                const todayRecords = attendanceData.filter(record => record.date === todayFormatted);
                
                console.log(`\nToday's date: "${todayFormatted}"`);
                console.log(`Today's records: ${todayRecords.length}`);
                
                if (todayRecords.length > 0) {
                    console.log('Today\'s records with exact status values:');
                    todayRecords.forEach((record, index) => {
                        const student = activeStudents[record.student];
                        const name = student ? `${student.firstName} ${student.lastName}` : 'Unknown';
                        console.log(`${index + 1}. ${name} (${record.student}) - Status: "${record.status}" (${typeof record.status}) - Time: ${record.time}`);
                    });
                    
                    // Show all unique status values
                    const statusValues = todayRecords.map(r => r.status);
                    const uniqueStatuses = [...new Set(statusValues)];
                    console.log('\nUnique status values found today:', uniqueStatuses);
                    console.log('Status value details:', uniqueStatuses.map(s => `"${s}" (type: ${typeof s}, length: ${s ? s.length : 'null'})`));
                }
            } else {
                console.log('No attendance data found!');
            }
        }
        
        function generateAdvancedAnalytics(reportType) {
            const today = new Date().toDateString();
            const analytics = {
                totalRecords: attendanceData.length,
                totalStudents: Object.keys(activeStudents).length,
                presentCount: attendanceData.filter(r => r.status === 'present').length,
                absentCount: attendanceData.filter(r => r.status === 'absent').length,
                todayRecords: attendanceData.filter(r => new Date(r.date).toDateString() === today).length,
                todayPresent: attendanceData.filter(r => new Date(r.date).toDateString() === today && r.status === 'present').length,
                todayAbsent: attendanceData.filter(r => new Date(r.date).toDateString() === today && r.status === 'absent').length,
                dateRange: getDateRange(reportType),
                absentStudents: [],
                perfectAttendance: [],
                consecutiveAbsences: 0,
                weeklyAverage: 85,
                monthlyAverage: 82,
                previousRate: 78,
                peakDay: 'Monday'
            };
            
            // Calculate percentages
            analytics.attendanceRate = analytics.totalRecords > 0 ? 
                Math.round((analytics.presentCount / analytics.totalRecords) * 100) : 0;
            analytics.absentPercentage = 100 - analytics.attendanceRate;
            
            analytics.todayPresentRate = analytics.todayRecords > 0 ? 
                Math.round((analytics.todayPresent / analytics.todayRecords) * 100) : 0;
            analytics.todayAbsentRate = 100 - analytics.todayPresentRate;
            
            // Generate absentee analysis
            const studentAbsenceAnalysis = {};
            Object.keys(activeStudents).forEach(studentId => {
                const studentRecords = attendanceData.filter(r => r.student === studentId);
                const absentRecords = studentRecords.filter(r => r.status === 'absent');
                const presentRecords = studentRecords.filter(r => r.status === 'present');
                
                if (studentRecords.length > 0) {
                    const absenceRate = Math.round((absentRecords.length / studentRecords.length) * 100);
                    const lastPresent = presentRecords.length > 0 ? 
                        presentRecords[presentRecords.length - 1].date : 'Never';
                    
                    // Calculate consecutive absences (simplified)
                    let consecutiveAbsences = 0;
                    const recentRecords = studentRecords.slice(-5); // Last 5 records
                    for (let i = recentRecords.length - 1; i >= 0; i--) {
                        if (recentRecords[i].status === 'absent') {
                            consecutiveAbsences++;
                        } else {
                            break;
                        }
                    }
                    
                    studentAbsenceAnalysis[studentId] = {
                        name: `${activeStudents[studentId].firstName} ${activeStudents[studentId].lastName}`,
                        id: studentId,
                        absenceRate: absenceRate,
                        lastSeen: lastPresent,
                        consecutiveAbsences: consecutiveAbsences,
                        totalAbsences: absentRecords.length,
                        attendanceRate: 100 - absenceRate
                    };
                }
            });
            
            // Identify students requiring attention (high absence rates or consecutive absences)
            analytics.absentStudents = Object.values(studentAbsenceAnalysis)
                .filter(student => student.absenceRate > 25 || student.consecutiveAbsences >= 2)
                .sort((a, b) => b.absenceRate - a.absenceRate)
                .slice(0, 10); // Top 10 concerning students
            
            // Identify perfect/excellent attendance students
            analytics.perfectAttendance = Object.values(studentAbsenceAnalysis)
                .filter(student => student.attendanceRate >= 95 && student.totalAbsences <= 1)
                .sort((a, b) => b.attendanceRate - a.attendanceRate)
                .slice(0, 15) // Top 15 excellent students
                .map(student => ({
                    name: student.name,
                    id: student.id,
                    days: attendanceData.filter(r => r.student === student.id && r.status === 'present').length,
                    rate: student.attendanceRate
                }));
            
            return analytics;
        }

        function getDateRange(reportType) {
            const today = new Date();
            
            switch (reportType) {
                case 'daily':
                    return today.toLocaleDateString();
                case 'weekly':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    return `${weekStart.toLocaleDateString()} - ${today.toLocaleDateString()}`;
                case 'monthly':
                    return today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                case 'custom':
                    const startDate = elements.startDate?.value;
                    const endDate = elements.endDate?.value;
                    if (startDate && endDate) {
                        return `${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`;
                    }
                    return 'Custom Range';
                default:
                    return 'All Available Data';
            }
        }

        function getReportTypeIntro(reportType) {
            const intros = {
                'daily': 'Please find below the daily attendance summary for today:\n\n',
                'weekly': 'Please find below the weekly attendance summary:\n\n',
                'monthly': 'Please find below the monthly attendance performance report:\n\n',
                'custom': 'Please find below the custom attendance report for the selected period:\n\n',
                'alerts': 'This report highlights attendance concerns that require your attention:\n\n',
                'comprehensive': 'Please find below the comprehensive attendance analysis with detailed insights:\n\n'
            };
            
            return intros[reportType] || 'Please find below the attendance report:\n\n';
        }

        function generateReportContent(analytics, reportType) {
            const checkboxes = getSelectedCheckboxes();
            console.log('Selected checkboxes:', checkboxes);
            let content = '';
            
            // Executive Summary
            if (checkboxes.includeSummary) {
                content += `ðŸ“Š EXECUTIVE SUMMARY\n`;
                content += `${'='.repeat(50)}\n`;
                content += `â€¢ Overall Attendance Rate: ${analytics.attendanceRate}%\n`;
                content += `â€¢ Total Active Students: ${analytics.totalStudents}\n`;
                content += `â€¢ Records Analyzed: ${analytics.totalRecords}\n`;
                content += `â€¢ Report Period: ${analytics.dateRange}\n`;
                
                if (analytics.attendanceRate >= 90) {
                    content += `â€¢ Status: âœ… EXCELLENT attendance performance\n`;
                } else if (analytics.attendanceRate >= 75) {
                    content += `â€¢ Status: âš ï¸ GOOD attendance with room for improvement\n`;
                } else {
                    content += `â€¢ Status: ðŸš¨ ATTENTION REQUIRED - Low attendance\n`;
                }
                content += `\n`;
            }
            
            // Key Statistics
            if (checkboxes.includeStatistics) {
                content += `ðŸ“ˆ KEY PERFORMANCE INDICATORS\n`;
                content += `${'='.repeat(50)}\n`;
                content += `Present Today: ${analytics.todayPresent} students (${analytics.todayPresentRate}%)\n`;
                content += `Absent Today: ${analytics.todayAbsent} students (${analytics.todayAbsentRate}%)\n`;
                content += `Overall Present: ${analytics.presentCount} records\n`;
                content += `Overall Absent: ${analytics.absentCount} records\n`;
                content += `Peak Attendance Day: ${analytics.peakDay || 'Monday'}\n`;
                content += `Weekly Average: ${analytics.weeklyAverage || 85}%\n`;
                content += `Monthly Average: ${analytics.monthlyAverage || 82}%\n`;
                content += `\n`;
            }
            
            // Absentee List
            if (checkboxes.includeAbsentees) {
                content += `ðŸš¨ STUDENTS REQUIRING ATTENTION\n`;
                content += `${'='.repeat(50)}\n`;
                
                if (analytics.absentStudents && analytics.absentStudents.length > 0) {
                    analytics.absentStudents.forEach((student, index) => {
                        content += `${index + 1}. ${student.name} (${student.id})\n`;
                        content += `   Last Seen: ${student.lastSeen}\n`;
                        content += `   Absence Rate: ${student.absenceRate}%\n`;
                        content += `   Status: ${student.consecutiveAbsences >= 3 ? 'ðŸš¨ HIGH RISK' : 'âš ï¸ Monitor'}\n\n`;
                    });
                } else {
                    content += `âœ… No students requiring immediate attention.\n`;
                    content += `All students maintain acceptable attendance rates.\n\n`;
                }
            }
            
            // Perfect Attendance
            if (checkboxes.includePerfectAttendance) {
                content += `ðŸŒŸ PERFECT ATTENDANCE RECOGNITION\n`;
                content += `${'='.repeat(50)}\n`;
                
                if (analytics.perfectAttendance && analytics.perfectAttendance.length > 0) {
                    analytics.perfectAttendance.forEach((student, index) => {
                        content += `${index + 1}. ${student.name} (${student.id}) - ${student.days} days perfect attendance\n`;
                    });
                } else {
                    // Generate based on actual data
                    const excellentStudents = [];
                    Object.keys(activeStudents).forEach(studentId => {
                        const studentRecords = attendanceData.filter(r => r.student === studentId);
                        const presentCount = studentRecords.filter(r => r.status === 'present').length;
                        const rate = studentRecords.length > 0 ? (presentCount / studentRecords.length) * 100 : 0;
                        
                        if (rate >= 95 && studentRecords.length >= 3) {
                            const student = activeStudents[studentId];
                            excellentStudents.push({
                                name: `${student.firstName} ${student.lastName}`,
                                id: studentId,
                                rate: Math.round(rate),
                                days: studentRecords.length
                            });
                        }
                    });
                    
                    if (excellentStudents.length > 0) {
                        excellentStudents.forEach((student, index) => {
                            content += `${index + 1}. ${student.name} (${student.id}) - ${student.rate}% attendance (${student.days} records)\n`;
                        });
                    } else {
                        content += `No students currently qualify for perfect attendance recognition.\n`;
                        content += `Encourage students to maintain consistent attendance.\n`;
                    }
                }
                content += `\n`;
            }
            
            // Attendance Trends
            if (checkboxes.includeTrends) {
                content += `ðŸ“Š ATTENDANCE TRENDS & ANALYSIS\n`;
                content += `${'='.repeat(50)}\n`;
                
                const currentRate = analytics.attendanceRate;
                const previousRate = analytics.previousRate || 78;
                
                if (currentRate > previousRate) {
                    content += `ðŸ“ˆ Trend: IMPROVING (+${(currentRate - previousRate).toFixed(1)}%)\n`;
                    content += `   Positive momentum - maintain current strategies\n`;
                } else if (currentRate < previousRate) {
                    content += `ðŸ“‰ Trend: DECLINING (${(currentRate - previousRate).toFixed(1)}%)\n`;
                    content += `   Requires attention - consider intervention strategies\n`;
                } else {
                    content += `âž¡ï¸ Trend: STABLE (no significant change)\n`;
                    content += `   Consistent performance - monitor for improvements\n`;
                }
                
                content += `Daily Average: ${currentRate}%\n`;
                content += `Weekly Target: 85%\n`;
                content += `Monthly Goal: 90%\n`;
                content += `Best Day: Monday (estimated)\n`;
                content += `Improvement Areas: ${currentRate < 80 ? 'Overall attendance' : 'Consistency'}\n`;
                content += `\n`;
            }
            
            // Alert Recommendations
            if (checkboxes.includeAlerts) {
                content += `âš ï¸ ALERTS & ACTIONABLE RECOMMENDATIONS\n`;
                content += `${'='.repeat(50)}\n`;
                
                let alertCount = 0;
                
                if (analytics.attendanceRate < 75) {
                    alertCount++;
                    content += `ðŸš¨ CRITICAL ALERT: Overall attendance below 75%\n`;
                    content += `   â†’ Immediate Action: Schedule management review meeting\n`;
                    content += `   â†’ Contact parents/guardians of frequent absentees\n`;
                    content += `   â†’ Review attendance policies and incentives\n\n`;
                }
                
                if (analytics.todayAbsent > analytics.todayPresent) {
                    alertCount++;
                    content += `âš ï¸ TODAY'S ALERT: More absences than attendance today\n`;
                    content += `   â†’ Follow up with absent students\n`;
                    content += `   â†’ Check for external factors (weather, events, etc.)\n\n`;
                }
                
                const consecutiveAbsents = analytics.absentStudents ? analytics.absentStudents.filter(s => s.consecutiveAbsences >= 3).length : 0;
                if (consecutiveAbsents > 0) {
                    alertCount++;
                    content += `ðŸ“ž FOLLOW-UP REQUIRED: ${consecutiveAbsents} students with 3+ consecutive absences\n`;
                    content += `   â†’ Personal contact recommended\n`;
                    content += `   â†’ Documentation required\n\n`;
                }
                
                if (alertCount === 0) {
                    content += `âœ… NO CRITICAL ALERTS\n`;
                    content += `Current attendance levels are within acceptable parameters.\n`;
                    content += `Continue monitoring and maintain current strategies.\n`;
                }
                content += `\n`;
            }
            
            // Visual Charts (Text-based)
            if (checkboxes.includeCharts) {
                content += `ðŸ“Š VISUAL ATTENDANCE ANALYSIS\n`;
                content += `${'='.repeat(50)}\n`;
                
                // Attendance Rate Bar Chart
                const presentBars = Math.round(analytics.attendanceRate / 5);
                const absentBars = 20 - presentBars;
                content += `ATTENDANCE RATE VISUALIZATION:\n`;
                content += `Present : ${'â–ˆ'.repeat(presentBars)}${'â–‘'.repeat(absentBars)} ${analytics.attendanceRate}%\n`;
                content += `Absent  : ${'â–ˆ'.repeat(Math.round(analytics.absentPercentage / 5))}${'â–‘'.repeat(20 - Math.round(analytics.absentPercentage / 5))} ${analytics.absentPercentage}%\n`;
                content += `          ${'-'.repeat(20)}\n`;
                content += `          0%    25%    50%    75%   100%\n\n`;
                
                // Weekly Trend (simulated)
                content += `WEEKLY TREND (Last 7 Days):\n`;
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const rates = [88, 92, 85, 90, 87, 75, 80]; // Sample data
                days.forEach((day, index) => {
                    const bars = Math.round(rates[index] / 10);
                    content += `${day}: ${'â–ˆ'.repeat(bars)}${'â–‘'.repeat(10 - bars)} ${rates[index]}%\n`;
                });
                content += `\n`;
            }
            
            // Detailed Records
            if (checkboxes.includeDetails) {
                content += `ðŸ“‹ DETAILED ATTENDANCE RECORDS\n`;
                content += `${'='.repeat(50)}\n`;
                content += `Date       | Student ID | Name                | Status  | Time     | Location\n`;
                content += `${'-'.repeat(85)}\n`;
                
                const recordsToShow = Math.min(attendanceData.length, 25);
                attendanceData.slice(0, recordsToShow).forEach(record => {
                    const studentInfo = activeStudents[record.student] || {};
                    const name = `${studentInfo.firstName || ''} ${studentInfo.lastName || ''}`.trim() || record.student;
                    const status = record.status === 'present' ? 'Present' : 'Absent ';
                    const location = record.address ? record.address.substring(0, 20) : 'N/A';
                    
                    content += `${record.date.padEnd(10)} | ${record.student.padEnd(10)} | ${name.padEnd(19)} | ${status} | ${record.time.padEnd(8)} | ${location}\n`;
                });
                
                if (attendanceData.length > 25) {
                    content += `... and ${attendanceData.length - 25} more records (showing most recent 25)\n`;
                }
                
                if (attendanceData.length === 0) {
                    content += `No attendance records found.\n`;
                    content += `Please ensure students are marking attendance.\n`;
                }
                content += `\n`;
            }
            
            console.log('Generated content length:', content.length);
            return content;
        }

        function getSelectedCheckboxes() {
            return {
                includeSummary: document.getElementById('includeSummary')?.checked || false,
                includeStatistics: document.getElementById('includeStatistics')?.checked || false,
                includeAbsentees: document.getElementById('includeAbsentees')?.checked || false,
                includePerfectAttendance: document.getElementById('includePerfectAttendance')?.checked || false,
                includeTrends: document.getElementById('includeTrends')?.checked || false,
                includeAlerts: document.getElementById('includeAlerts')?.checked || false,
                includeCharts: document.getElementById('includeCharts')?.checked || false,
                includeDetails: document.getElementById('includeDetails')?.checked || false,
            };
        }

        function getReportFooter(senderName) {
            return `\n${'='.repeat(60)}\n` +
                   `ðŸ“‹ REPORT DETAILS\n` +
                   `Generated: ${new Date().toLocaleString()}\n` +
                   `System: Professional Attendance Tracking System\n` +
                   `Prepared by: ${senderName}\n` +
                   `Total Records Analyzed: ${attendanceData.length}\n\n` +
                   `ðŸ“ž For questions or assistance, please contact the system administrator.\n` +
                   `âš¡ This report was generated automatically with real-time data.\n\n` +
                   `Best regards,\n${senderName}\nAttendance Management Team`;
        }

        function clearAllData() {
            if (attendanceData.length === 0) {
                showMessage('No data to clear', 'warning');
                return;
            }
            
            // Create custom confirmation dialog for data clearing
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirmation-overlay';
            confirmDialog.innerHTML = `
                <div class="confirmation-modal">
                    <div class="confirmation-header" style="background: #e74c3c;">
                        <h3><i class="fas fa-exclamation-triangle"></i> Clear All Data</h3>
                    </div>
                    <div class="confirmation-body">
                        <p><strong>Are you sure you want to delete all ${attendanceData.length} attendance records?</strong></p>
                        <p style="color: #e74c3c; margin-top: 15px;"><i class="fas fa-warning"></i> This action cannot be undone!</p>
                    </div>
                    <div class="confirmation-actions">
                        <button class="confirm-btn cancel-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="confirm-btn" style="background: #e74c3c;">
                            <i class="fas fa-trash"></i> Yes, Delete All
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            const cancelBtn = confirmDialog.querySelector('.cancel-btn');
            const confirmBtn = confirmDialog.querySelector('.confirm-btn:not(.cancel-btn)');
            
            const closeDialog = () => {
                document.body.removeChild(confirmDialog);
            };
            
            cancelBtn.addEventListener('click', closeDialog);
            
            confirmBtn.addEventListener('click', () => {
                closeDialog();
                clearAllData();
            });
            
            confirmDialog.addEventListener('click', (e) => {
                if (e.target === confirmDialog) {
                    closeDialog();
                }
            });
            
            setTimeout(() => confirmBtn.focus(), 100);
        }
        
        // Local Storage Data Management Functions
        function loadDataFromStorage() {
            try {
                const saved = localStorage.getItem('attendanceData');
                if (saved) {
                    attendanceData = JSON.parse(saved);
                    displayRecords();
                    updateStatistics();
                    populateFilterDropdowns();
                    showMessage('ðŸ“± Data loaded from local storage', 'info');
                } else {
                    showMessage('ðŸ“ Ready to start recording attendance!', 'info');
                }
                
                // Load sync queue
                const syncQueueData = localStorage.getItem('attendanceSyncQueue');
                if (syncQueueData) {
                    try {
                        syncQueue = JSON.parse(syncQueueData);
                        console.log(`Loaded ${syncQueue.length} records in sync queue`);
                    } catch (error) {
                        console.error('Error parsing sync queue:', error);
                        syncQueue = [];
                    }
                }
                
                // Load Firebase preference
                const firebaseMode = localStorage.getItem('useFirebase');
                if (firebaseMode !== null) {
                    useFirebase = firebaseMode === 'true';
                }
                
                // Try to load from Firebase if available and online
                if (useFirebase && window.FirebaseHelper && navigator.onLine) {
                    setTimeout(() => loadFromFirebase(), 1000); // Delay to ensure Firebase is ready
                }
                
            } catch (error) {
                console.error('Error loading local data:', error);
                showMessage('ðŸ“ Ready to start recording attendance!', 'info');
            }
        }

        // Firebase data loading function
        async function loadFromFirebase() {
            try {
                showMessage('ðŸ”„ Syncing with cloud...', 'info');
                const result = await window.FirebaseHelper.getAttendanceRecords();
                
                if (result.success) {
                    // Merge Firebase data with local data (avoid duplicates)
                    const firebaseData = result.data;
                    const mergedData = mergeAttendanceData(attendanceData, firebaseData);
                    
                    if (mergedData.length !== attendanceData.length) {
                        attendanceData = mergedData;
                        saveDataToStorage(); // Update local storage
                        showMessage(`âœ… Synced ${firebaseData.length} records from cloud`, 'success');
                        
                        // Update displays if visible
                        if (elements.recordsSection.style.display !== 'none') {
                            displayRecords();
                            updateStatistics();
                            generateAnalytics();
                        }
                    }
                    
                    // Process sync queue if any
                    if (syncQueue.length > 0) {
                        await processSyncQueue();
                    }
                }
            } catch (error) {
                console.error('Firebase load error:', error);
                showMessage('âš ï¸ Using offline data', 'warning');
            }
        }

        // Merge attendance data avoiding duplicates
        function mergeAttendanceData(localData, firebaseData) {
            const merged = [...localData];
            const localIds = new Set(localData.map(record => record.id));
            
            firebaseData.forEach(firebaseRecord => {
                // Check if record already exists locally
                if (!localIds.has(firebaseRecord.id)) {
                    merged.push(firebaseRecord);
                }
            });
            
            // Sort by date (newest first)
            return merged.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Process sync queue (upload pending records)
        async function processSyncQueue() {
            if (syncQueue.length === 0) return;
            
            try {
                showMessage(`ðŸ“¤ Syncing ${syncQueue.length} pending records...`, 'info');
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = syncQueue.length - 1; i >= 0; i--) {
                    const record = syncQueue[i];
                    try {
                        const result = await window.FirebaseHelper.addAttendanceRecord(record);
                        if (result.success) {
                            successCount++;
                            // Update local record with Firebase ID
                            const localRecord = attendanceData.find(r => r.id === record.id);
                            if (localRecord) {
                                localRecord.firebaseId = result.id;
                            }
                            // Remove from sync queue
                            syncQueue.splice(i, 1);
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error('Sync error for record:', error);
                        errorCount++;
                    }
                }
                
                // Update sync queue in storage
                localStorage.setItem('attendanceSyncQueue', JSON.stringify(syncQueue));
                
                if (successCount > 0) {
                    showMessage(`âœ… Synced ${successCount} records to cloud`, 'success');
                    saveDataToStorage(); // Update local storage with Firebase IDs
                }
                
                if (errorCount > 0) {
                    showMessage(`âš ï¸ ${errorCount} records failed to sync`, 'warning');
                }
                
            } catch (error) {
                console.error('Sync queue processing error:', error);
                showMessage('âš ï¸ Sync failed - records saved locally', 'warning');
            }
        }

        // Manual sync function
        async function syncWithFirebase() {
            if (!useFirebase || !window.FirebaseHelper) {
                showMessage('âŒ Firebase not configured', 'error');
                return;
            }
            
            if (!navigator.onLine) {
                showMessage('âŒ No internet connection', 'error');
                return;
            }
            
            try {
                showLoading(true);
                await loadFromFirebase();
                await processSyncQueue();
                showMessage('ðŸ”„ Full sync completed!', 'success');
            } catch (error) {
                console.error('Manual sync error:', error);
                showMessage('âŒ Sync failed', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Toggle Firebase usage
        function toggleFirebaseMode() {
            useFirebase = !useFirebase;
            localStorage.setItem('useFirebase', useFirebase.toString());
            
            if (useFirebase) {
                showMessage('ðŸ”¥ Firebase enabled - data will sync to cloud', 'success');
                if (navigator.onLine && window.FirebaseHelper) {
                    syncWithFirebase();
                }
            } else {
                showMessage('ðŸ’¾ Local mode - data saved offline only', 'info');
            }
            
            updateFirebaseUI();
        }

        // Update UI to show Firebase status
        function updateFirebaseUI() {
            const statusText = useFirebase ? 'ðŸ”¥ Cloud Sync' : 'ðŸ’¾ Local Only';
            const modeElement = document.getElementById('currentMode');
            const buttonElement = document.getElementById('firebaseStatusText');
            const toggleButton = document.getElementById('toggleFirebaseBtn');
            
            if (modeElement) modeElement.textContent = statusText;
            if (buttonElement) buttonElement.textContent = useFirebase ? 'Disable Cloud' : 'Enable Cloud';
            if (toggleButton) {
                toggleButton.style.background = useFirebase ? '#f44336' : '#4CAF50';
                toggleButton.innerHTML = useFirebase ? '<i class="fas fa-toggle-off"></i> Disable Cloud' : '<i class="fas fa-toggle-on"></i> Enable Cloud';
            }
            
            updateSyncQueueUI();
            updateConnectionStatus();
        }

        function updateSyncQueueUI() {
            const queueElement = document.getElementById('syncQueueCount');
            if (queueElement) {
                queueElement.textContent = syncQueue.length;
                queueElement.style.color = syncQueue.length > 0 ? '#ff9800' : '#4caf50';
            }
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                if (!navigator.onLine) {
                    statusElement.textContent = 'Offline ðŸ”´';
                    statusElement.style.color = '#f44336';
                } else if (!useFirebase || !window.FirebaseHelper) {
                    statusElement.textContent = 'Local Mode ðŸŸ¡';
                    statusElement.style.color = '#ff9800';
                } else {
                    statusElement.textContent = 'Online ðŸŸ¢';
                    statusElement.style.color = '#4caf50';
                }
            }
        }

        function showFirebaseStatus() {
            const status = `
ðŸ”¥ FIREBASE STATUS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ”— Connection: ${navigator.onLine ? 'Online' : 'Offline'}
ðŸ”¥ Firebase: ${useFirebase ? 'Enabled' : 'Disabled'}
ðŸ“Š Local Records: ${attendanceData.length}
ðŸ“¤ Sync Queue: ${syncQueue.length} pending uploads
ï¿½ Storage Mode: ${useFirebase && navigator.onLine ? 'Cloud + Local' : 'Local Only'}

ï¿½ ACTIONS AVAILABLE:
â€¢ ${useFirebase ? 'Disable' : 'Enable'} cloud sync
â€¢ Manual sync with cloud
â€¢ View sync queue status
â€¢ Clear local data

${syncQueue.length > 0 ? 'âš  You have pending uploads. Click "Sync Now" to upload them.' : 'âœ… All data is synced.'}
            `;
            
            alert(status);
        }

        // Initialize Firebase UI when page loads
        function initializeFirebaseUI() {
            // Update UI periodically
            updateFirebaseUI();
            setInterval(() => {
                updateConnectionStatus();
                updateSyncQueueUI();
            }, 5000); // Update every 5 seconds
            
            // Listen for online/offline events
            window.addEventListener('online', () => {
                updateConnectionStatus();
                showMessage('ðŸŒ Connection restored - syncing...', 'success');
                if (useFirebase && window.FirebaseHelper) {
                    setTimeout(() => syncWithFirebase(), 1000);
                }
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus();
                showMessage('ðŸ“± Working offline - data saved locally', 'warning');
            });
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                console.log('Data saved to local storage');
            } catch (error) {
                console.error('Error saving to local storage:', error);
                showMessage('Error saving data locally', 'error');
            }
        }

        function clearAllData() {
            try {
                showLoading(true);
                showMessage('Clearing all data...', 'info');
                
                // Use Firebase clear function if available
                if (window.firebase && navigator.onLine) {
                    clearAllDataFromFirestore();
                } else {
                    // Clear local data only
                    attendanceData = [];
                    localStorage.removeItem('attendanceData');
                    
                    // Update displays
                    displayRecords();
                    updateStatistics();
                    populateFilterDropdowns();
                    
                    showMessage('All local data cleared successfully', 'success');
                }
            } catch (error) {
                console.error('Error clearing data: ', error);
                showMessage('Error clearing data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.setAttribute('role', 'alert');
            messageEl.setAttribute('aria-live', 'polite');
            
            const icon = getMessageIcon(type);
            messageEl.innerHTML = `
                <i class="${icon}" aria-hidden="true"></i>
                <span>${message}</span>
                <button class="message-close" aria-label="Close message" onclick="this.parentElement.remove()">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            `;
            
            elements.messageContainer.appendChild(messageEl);
            
            // Remove message after 5 seconds (except errors which stay longer)
            const timeout = type === 'error' ? 10000 : 5000;
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.style.opacity = '0';
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.parentNode.removeChild(messageEl);
                        }
                    }, 300);
                }
            }, timeout);
            
            // Remove on click
            messageEl.addEventListener('click', (e) => {
                if (!e.target.closest('.message-close')) {
                    messageEl.remove();
                }
            });
        }

        function getMessageIcon(type) {
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            return icons[type] || icons.info;
        }

        function toggleLocationSettings() {
            const content = document.getElementById('locationSettingsContent');
            const toggleBtn = document.querySelector('#toggleLocationSettings i');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleBtn.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                toggleBtn.className = 'fas fa-chevron-down';
            }
        }

        function enableLocationAccess() {
            updateLocationStatus('ðŸ“ Requesting location permission...', 'info');
            showMessage('Please allow location access when prompted by your browser', 'info');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('Location permission granted:', position);
                    handleLocationSuccess(position);
                    showMessage('Location access enabled successfully!', 'success');
                    
                    // Hide the enable button since permission is now granted
                    const enableBtn = document.getElementById('enableLocationBtn');
                    if (enableBtn) {
                        enableBtn.style.display = 'none';
                    }
                    
                    // Start continuous tracking
                    const continuousToggle = document.getElementById('continuousTrackingToggle');
                    if (!continuousToggle || continuousToggle.checked) {
                        startWatchingPosition();
                    }
                },
                (error) => {
                    console.error('Location permission error:', error);
                    let errorMessage = 'Unable to access location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Permission denied. Please enable location in browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                        default:
                            errorMessage += 'Unknown error occurred.';
                            break;
                    }
                    updateLocationStatus(errorMessage, 'error');
                    showMessage(errorMessage, 'error');
                },
                options
            );
        }

        function showLoading(show) {
            console.log('ðŸ”„ showLoading called with:', show);
            
            if (!elements.loadingOverlay) {
                console.error('âŒ Loading overlay element not found');
                return;
            }
            
            try {
                elements.loadingOverlay.style.display = show ? 'flex' : 'none';
                
                // Disable/enable the attendance buttons during processing
                if (elements.presentBtn) {
                    elements.presentBtn.disabled = show;
                }
                if (elements.absentBtn) {
                    elements.absentBtn.disabled = show;
                }
                
                // Also disable the form submit to prevent multiple submissions
                if (elements.form) {
                    const submitButtons = elements.form.querySelectorAll('button[type="submit"], input[type="submit"]');
                    submitButtons.forEach(btn => {
                        btn.disabled = show;
                    });
                }
                
                console.log('âœ… Loading state updated successfully');
            } catch (error) {
                console.error('âŒ Error in showLoading:', error);
            }
        }

        // Collapsible Section Functionality
        function toggleSection(contentId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(contentId + '-icon');
            
            if (content.classList.contains('collapsed')) {
                // Expand
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                icon.classList.add('rotated');
            } else {
                // Collapse
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                icon.classList.remove('rotated');
            }
        }

        // Initialize collapsible sections on page load
        function initializeCollapsibleSections() {
            // Set all sections to collapsed by default except Record Attendance
            const collapsibleSections = [
                'actions-content',
                'location-content', 
                'location-controls-content'
            ];
            
            collapsibleSections.forEach(sectionId => {
                const content = document.getElementById(sectionId);
                const icon = document.getElementById(sectionId + '-icon');
                
                if (content && icon) {
                    // All sections start collapsed except Record Attendance
                    content.classList.add('collapsed');
                    icon.classList.remove('rotated');
                }
            });
        }

        // Export functions for global access
        window.deleteRecord = deleteRecord;
        window.removeStudent = removeStudent;
        window.restoreDefaultStudents = restoreDefaultStudents;
        window.closeStudentManagementPanel = closeStudentManagementPanel;
        window.toggleSection = toggleSection;
        window.openEmailForm = openEmailForm;
        window.closeEmailForm = closeEmailForm;
        window.closeEmailPreview = closeEmailPreview;
        window.previewEmailReport = previewEmailReport;
        window.sendFinalEmail = sendFinalEmail;
        window.testEmailForm = testEmailForm;
        window.testClearData = testClearData;
        window.addNewStudent = addNewStudent;
        window.exportFilteredRecordsToPdf = exportFilteredRecordsToPdf;
        
        // Simple Firebase Functions (Working version from index-clean.html)
        async function saveDataToFirestore(record) {
            try {
                showMessage('Saving to cloud...', 'info');
                const docRef = await window.firebase.addDoc(
                    window.firebase.collection(window.firebase.db, 'attendance'), 
                    record
                );
                console.log('Document written with ID: ', docRef.id);
                showMessage('Attendance saved to cloud!', 'success');
            } catch (error) {
                console.error('Error adding document: ', error);
                showMessage('Error saving to cloud: ' + error.message, 'error');
                
                // Fallback to localStorage if Firebase fails
                try {
                    let localData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                    localData.unshift(record);
                    localStorage.setItem('attendanceData', JSON.stringify(localData));
                    showMessage('Saved locally instead', 'warning');
                } catch (localError) {
                    showMessage('Failed to save data', 'error');
                }
            }
        }       

        async function loadDataFromFirestore() {
            try {
                showMessage('Loading data from cloud...', 'info');
                
                // Add more detailed error logging
                console.log('ðŸ”¥ Attempting to load data from Firestore...');
                console.log('ðŸ”¥ Firebase app:', window.firebaseApp);
                console.log('ðŸ”¥ Firebase db:', window.firebase.db);
                
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'attendance'),
                    window.firebase.orderBy('timestamp', 'desc')
                );
                const querySnapshot = await window.firebase.getDocs(q);
                
                attendanceData = [];
                querySnapshot.forEach((doc) => {
                    attendanceData.push({
                        firestoreId: doc.id,
                        firebaseId: doc.id,  // Add this for consistency
                        ...doc.data()
                    });
                });
                
                console.log(`ðŸ”¥ Loaded ${attendanceData.length} records from Firestore`);
                displayRecords();
                updateStatistics();
                populateFilterDropdowns();
                showMessage('Data loaded from cloud!', 'success');
            } catch (error) {
                console.error('ðŸ”¥ Firestore load error details:', error);
                console.error('ðŸ”¥ Error code:', error.code);
                console.error('ðŸ”¥ Error message:', error.message);
                
                // More specific error messages
                let errorMessage = 'Cloud connection failed';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied - check Firestore security rules';
                } else if (error.code === 'not-found') {
                    errorMessage = 'Firestore database not found - create database first';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Firestore service unavailable';
                }
                
                showMessage(errorMessage + ', using local storage', 'warning');
                
                // Fallback to localStorage
                try {
                    const saved = localStorage.getItem('attendanceData');
                    if (saved) {
                        attendanceData = JSON.parse(saved);
                        displayRecords();
                        updateStatistics();
                        populateFilterDropdowns();
                        showMessage('Local data loaded', 'info');
                    }
                } catch (localError) {
                    showMessage('No data found', 'info');
                }
            }
        }

        function setupRealtimeListener() {
            try {
                console.log('ðŸ”¥ Setting up real-time listener...');
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'attendance'),
                    window.firebase.orderBy('timestamp', 'desc')
                );
                
                realtimeUnsubscribe = window.firebase.onSnapshot(q, (querySnapshot) => {
                    console.log('ðŸ”¥ Real-time update received - records count:', querySnapshot.size);
                    attendanceData = [];
                    querySnapshot.forEach((doc) => {
                        attendanceData.push({
                            firestoreId: doc.id,
                            firebaseId: doc.id,  // Add this for consistency with manual loading
                            ...doc.data()
                        });
                    });
                    console.log('ðŸ”¥ Real-time data updated - new length:', attendanceData.length);
                    
                    displayRecords();
                    updateStatistics();
                    populateFilterDropdowns();
                }, (error) => {
                    console.error('ðŸ”¥ Real-time listener error details:', error);
                    console.error('ðŸ”¥ Error code:', error.code);
                    console.error('ðŸ”¥ Error message:', error.message);
                    
                    let errorMessage = 'Real-time sync disabled';
                    if (error.code === 'permission-denied') {
                        errorMessage = 'Real-time sync denied - check Firestore rules';
                    } else if (error.code === 'not-found') {
                        errorMessage = 'Firestore collection not found';
                    }
                    
                    showMessage(errorMessage, 'warning');
                });
                
                // Store unsubscribe function globally
                window.realtimeUnsubscribe = realtimeUnsubscribe;
                
                console.log('ðŸ”¥ Real-time listener setup complete');
                showMessage('Real-time sync enabled!', 'info');
            } catch (error) {
                console.error('ðŸ”¥ Error setting up real-time listener: ', error);
                showMessage('Real-time sync failed: ' + error.message, 'warning');
            }
        }

        async function deleteRecordFromFirestore(recordId) {
            try {
                showLoading(true);
                showMessage('Deleting record...', 'info');
                
                // Find the record by its firestoreId
                const record = attendanceData.find(r => r.firestoreId === recordId);
                if (record && record.firestoreId) {
                    await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'attendance', record.firestoreId));
                    showMessage('Record deleted from cloud!', 'success');
                }
                
                // Remove from local array
                attendanceData = attendanceData.filter(r => r.firestoreId !== recordId);
                
                // Update displays
                displayRecords();
                updateStatistics();
                populateFilterDropdowns();
                
            } catch (error) {
                console.error('Error deleting record: ', error);
                showMessage('Error deleting record: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function clearAllDataFromFirestore() {
            try {
                showLoading(true);
                showMessage('Clearing all cloud data...', 'info');
                
                // Delete all records from Firestore
                const q = window.firebase.query(window.firebase.collection(window.firebase.db, 'attendance'));
                const querySnapshot = await window.firebase.getDocs(q);
                
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(window.firebase.deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                
                // Clear local data
                attendanceData = [];
                localStorage.removeItem('attendanceData');
                
                // Update displays
                displayRecords();
                updateStatistics();
                populateFilterDropdowns();
                
                showMessage('All data cleared from cloud and local storage!', 'success');
            } catch (error) {
                console.error('Error clearing cloud data: ', error);
                showMessage('Error clearing cloud data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Simple Firebase connection test
        async function testFirebaseConnection() {
            try {
                showMessage('Testing Firebase connection...', 'info');
                
                // Try to read from the attendance collection (this will test connectivity)
                const testQuery = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'attendance'),
                    window.firebase.limit(1)
                );
                await window.firebase.getDocs(testQuery);
                
                showMessage('âœ… Firebase connection successful!', 'success');
                return true;
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                showMessage('âŒ Firebase connection failed: ' + error.message, 'error');
                return false;
            }
        }

        // Disable real-time listener (useful for troubleshooting)
        function disableRealtimeSync() {
            try {
                if (window.realtimeUnsubscribe) {
                    window.realtimeUnsubscribe();
                    window.realtimeUnsubscribe = null;
                    showMessage('Real-time sync disabled', 'info');
                }
            } catch (error) {
                console.error('Error disabling real-time sync:', error);
            }
        }

        // Store the unsubscribe function for the real-time listener
        let realtimeUnsubscribe = null;

        // Export simple Firebase functions for global access
        window.saveDataToFirestore = saveDataToFirestore;
        window.loadDataFromFirestore = loadDataFromFirestore;
        window.setupRealtimeListener = setupRealtimeListener;
        window.deleteRecordFromFirestore = deleteRecordFromFirestore;
        window.clearAllDataFromFirestore = clearAllDataFromFirestore;
        window.testFirebaseConnection = testFirebaseConnection;
        window.disableRealtimeSync = disableRealtimeSync;
        
        // Firebase functions
        window.toggleFirebaseMode = toggleFirebaseMode;
        window.syncWithFirebase = syncWithFirebase;
        window.showFirebaseStatus = showFirebaseStatus;
        window.loadFromFirebase = loadFromFirebase;
        window.processSyncQueue = processSyncQueue;
        
        // Error handling for missing functions
        window.handleMissingFunction = function(functionName) {
            console.error(`âŒ Function ${functionName} not found or not properly defined`);
            showMessage(`âŒ Feature temporarily unavailable: ${functionName}`, 'error');
        };
        
        // Test function for debugging
        window.testAddStudent = function() {
            console.log('ðŸ§ª Testing Add Student function...');
            console.log('ðŸ§ª Elements:', {
                addStudentBtn: elements.addStudentBtn,
                newStudentId: elements.newStudentId,
                newStudentName: elements.newStudentName
            });
            console.log('ðŸ§ª Active Students:', activeStudents);
            addNewStudent();
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Attendance System - School Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* CSS Variables for Theme Support */
        :root {
            /* Light Theme */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #2c3e50;
            --text-accent: #3498db;
            --border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --input-border: #ddd;
            --button-primary: #3498db;
            --button-success: #27ae60;
            --button-danger: #e74c3c;
            --button-warning: #f39c12;
            --button-info: #17a2b8;
            --table-header: #f8f9fa;
            --table-border: #dee2e6;
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-secondary: rgba(30, 30, 30, 0.95);
            --bg-card: #2c3e50;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-accent: #3498db;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --input-bg: #34495e;
            --input-border: #4a5f7a;
            --button-primary: #3498db;
            --button-success: #27ae60;
            --button-danger: #e74c3c;
            --button-warning: #f39c12;
            --button-info: #17a2b8;
            --table-header: #34495e;
            --table-border: #4a5f7a;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .theme-toggle:active {
            transform: translateY(0);
        }

        .theme-toggle i {
            transition: transform 0.3s ease;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-content h1 {
            margin: 0;
            flex: 1;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--text-secondary);
            font-size: 2.5rem;
            text-align: center;
            font-weight: 700;
        }

        .header h1 i {
            color: var(--text-accent);
            margin-right: 15px;
        }

        .current-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .info-item i {
            color: var(--text-accent);
            font-size: 1.2rem;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        /* Form Card */
        .form-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .form-card h2 {
            color: var(--text-secondary);
            font-size: 1.8rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-card h2 i {
            color: var(--button-success);
        }

        /* Form Styles */
        .attendance-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.half {
            flex: 1;
        }

        .location-group {
            display: flex;
            gap: 20px;
        }

        .form-group label {
            font-weight: 600;
            color: #34495e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label i {
            color: #3498db;
            width: 16px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group input[readonly] {
            background: var(--table-header);
            color: var(--text-secondary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Form Help Text */
        .form-help {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            opacity: 0.8;
            line-height: 1.4;
        }

        /* Attendance Buttons */
        .attendance-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .attendance-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .attendance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .attendance-btn.selected {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: pulseSelected 0.6s ease;
        }

        @keyframes pulseSelected {
            0% { transform: translateY(-1px) scale(1); }
            50% { transform: translateY(-1px) scale(1.05); }
            100% { transform: translateY(-1px) scale(1); }
        }

        .present-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .present-btn:hover {
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }

        .present-btn.selected {
            background: linear-gradient(135deg, #1e8449, #27ae60);
        }

        .absent-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .absent-btn:hover {
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .absent-btn.selected {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }

        /* Confirmation Modal */
        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .confirmation-modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .confirmation-header {
            background: var(--button-primary);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }

        .confirmation-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .confirmation-header i {
            margin-right: 8px;
        }

        .confirmation-body {
            padding: 25px;
            text-align: center;
            color: var(--text-primary);
        }

        .confirmation-body p {
            margin: 0;
            font-size: 1rem;
            line-height: 1.5;
        }

        .confirmation-actions {
            padding: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid var(--border-color);
        }

        .confirm-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .confirm-btn.cancel-btn {
            background: #6c757d;
            color: white;
        }

        .confirm-btn.cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .confirm-btn.confirm-btn-yes {
            background: var(--button-success);
            color: white;
        }

        .confirm-btn.confirm-btn-yes:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        /* Fraud Protection Status */
        .fraud-protection-status {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .fraud-protection-status .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: #495057;
        }

        .fraud-protection-status .status-header i {
            margin-right: 8px;
            color: #007bff;
        }

        .fraud-protection-status .toggle-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .fraud-protection-status .toggle-btn:hover {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .fraud-protection-status .status-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #6c757d;
        }

        /* Student Management Styles */
        .student-selection-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .student-selection-container select {
            flex: 1;
        }

        .manage-students-btn {
            background: var(--button-info);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 45px;
            height: 45px;
        }

        .manage-students-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .student-management-panel {
            background: var(--bg-card);
            border: 2px solid var(--input-border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding: 0 20px;
            }
            to {
                opacity: 1;
                max-height: 500px;
                padding: 20px;
            }
        }

        .student-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--input-border);
        }

        .student-management-header h4 {
            color: var(--text-secondary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-panel-btn {
            background: var(--button-danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-panel-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .add-student-section {
            margin-bottom: 25px;
        }

        .add-student-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .add-student-form .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .add-student-form input {
            padding: 10px 12px;
            border: 2px solid var(--input-border);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
            flex: 1;
            min-width: 200px;
        }

        .add-student-form input:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .add-student-btn {
            background: var(--button-success);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-student-btn:hover {
            background: #27ae60;
            transform: translateY(-1px);
        }

        .add-student-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .current-students-section h5 {
            color: var(--text-secondary);
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .students-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .students-section-header h5 {
            margin: 0;
        }

        .restore-default-btn {
            background: var(--button-warning);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .restore-default-btn:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }

        .students-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--input-border);
            transition: background-color 0.3s ease;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-item:hover {
            background: var(--table-header);
        }

        .student-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .student-key {
            font-size: 0.8rem;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            opacity: 0.8;
        }

        .remove-student-btn {
            background: var(--button-danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .remove-student-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .no-students-message {
            text-align: center;
            padding: 20px;
            color: var(--text-primary);
            font-style: italic;
            opacity: 0.7;
        }

        /* Action Buttons */
        .actions-section {
            margin: 20px 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--button-primary), #2980b9);
        }

        .action-btn.success {
            background: linear-gradient(135deg, var(--button-success), #2ecc71);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, var(--button-danger), #c0392b);
        }

        .action-btn.warning {
            background: linear-gradient(135deg, var(--button-warning), #e67e22);
        }

        .action-btn.info {
            background: linear-gradient(135deg, var(--button-info), #8e44ad);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .action-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Records Section */
        .records-section {
            margin-top: 30px;
        }

        .records-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .records-card h2 {
            color: var(--text-secondary);
            font-size: 1.8rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            font-weight: 600;
            color: #34495e;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 14px;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 500;
            min-height: 42px;
            line-height: 1.4;
        }

        /* Enhanced dropdown options styling */
        .filter-group select option {
            font-size: 1.1rem;
            font-weight: 500;
            padding: 8px 12px;
            line-height: 1.5;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .filter-group select:focus {
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        .filter-btn {
            background: linear-gradient(135deg, var(--button-primary), #2980b9);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 42px;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .records-table th {
            background: linear-gradient(135deg, var(--text-secondary), var(--text-secondary));
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .records-table td {
            padding: 12px;
            border-bottom: 1px solid var(--table-border);
            font-size: 0.9rem;
            color: var(--text-primary);
            background: var(--bg-card);
        }

        .records-table tbody tr:hover {
            background: var(--table-header);
        }

        .records-table tbody tr:nth-child(even) {
            background: var(--table-header);
        }

        /* Action buttons in table */
        .table-action-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .table-action-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        /* Statistics */
        .statistics-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
        }

        .statistics-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .stat-card.red {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Location Section */
        .location-section {
            margin-top: 30px;
        }

        .location-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .location-card h3 {
            color: var(--text-secondary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: var(--input-border);
            color: var(--primary-color);
        }

        .location-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .location-details strong {
            color: var(--text-secondary);
        }

        .location-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--table-header);
            border-radius: 8px;
            border-left: 4px solid var(--text-accent);
            color: var(--text-primary);
            margin-bottom: 8px;
            position: relative;
            flex-wrap: wrap;
            gap: 8px;
        }

        .location-item:hover {
            background: var(--card-hover, var(--background-secondary));
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .location-label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 120px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .location-label i {
            color: var(--text-accent);
            width: 16px;
        }

        .location-value, .accuracy-value, .timestamp-value, .updates-count {
            font-family: 'Courier New', monospace;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--background-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .address-value {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            color: var(--text-primary);
            background: var(--background-secondary);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            line-height: 1.4;
            max-width: 100%;
            word-wrap: break-word;
            position: relative;
        }

        .address-value:hover {
            background: var(--primary-color-light);
            border-color: var(--primary-color);
            transition: all 0.2s ease;
        }

        .address-container {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            flex-wrap: wrap;
        }

        .address-actions {
            display: flex;
            gap: 4px;
            margin-top: 2px;
        }

        .address-btn {
            padding: 2px 6px;
            font-size: 11px;
            border: 1px solid var(--border-color);
            background: var(--background-primary);
            color: var(--text-secondary);
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .address-btn:hover {
            background: var(--primary-color);
            color: white;
            text-decoration: none;
        }

        .address-btn i {
            margin-right: 2px;
        }

        .coordinates-summary {
            background: var(--background-primary);
            border: 2px solid var(--text-accent);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .coordinates-display {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .coordinates-text {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: var(--background-secondary);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            flex-grow: 1;
            min-width: 200px;
        }

        .copy-btn {
            background: var(--text-accent);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .copy-btn:hover {
            background: var(--primary-dark, #2c3e50);
            transform: scale(1.05);
        }

        .copy-btn.primary {
            background: var(--primary-color);
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .copy-btn.primary:hover {
            background: var(--primary-dark, #27ae60);
        }

        .help-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .help-btn:hover {
            background: var(--warning-dark, #e67e22);
            transform: scale(1.1);
        }

        .accuracy-icon, .quality-icon {
            margin-left: 5px;
            font-size: 1.1rem;
        }

        .accuracy-help {
            width: 100%;
            margin-top: 4px;
        }

        .accuracy-help small {
            color: var(--text-secondary);
            font-style: italic;
        }

        .altitude-accuracy, .speed-unit, .compass-direction, .time-ago, .update-rate {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-left: 5px;
        }

        .map-options {
            display: flex;
            gap: 8px;
            margin-left: 10px;
        }

        .map-option {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-accent);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .map-option:hover {
            background: var(--text-accent);
            color: white;
            transform: scale(1.1);
        }

        .map-link {
            color: var(--text-accent);
            text-decoration: none;
            font-weight: 500;
        }

        .map-link:hover {
            text-decoration: underline;
        }

        .permission-status.granted {
            color: var(--success-color);
            font-weight: 600;
        }

        .permission-status.denied {
            color: var(--error-color);
            font-weight: 600;
        }

        .permission-status.prompt {
            color: var(--warning-color);
            font-weight: 600;
        }

        .quality-indicator.excellent {
            color: var(--success-color);
            font-weight: 600;
        }

        .quality-indicator.good {
            color: var(--primary-color);
            font-weight: 600;
        }

        .quality-indicator.fair {
            color: var(--warning-color);
            font-weight: 600;
        }

        .quality-indicator.poor {
            color: var(--error-color);
            font-weight: 600;
        }

        .quality-indicator.indoor {
            color: #9b59b6;
            font-weight: 600;
        }

        /* Location Controls */
        .location-controls-section {
            margin-top: 20px;
        }

        .location-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            padding: 12px;
            background: var(--table-header);
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .control-group label:hover {
            background: var(--input-border);
        }

        .control-group label input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .control-group label span {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .control-group label small {
            color: var(--text-primary);
            font-size: 0.85rem;
            margin-top: 2px;
        }

        .location-status-bar {
            padding: 15px;
            background: var(--table-header);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .location-tips {
            margin-top: 10px;
            padding: 15px;
            background: var(--background-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--warning-color);
        }

        .location-tips small {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .location-recommendation {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
        }

        .location-recommendation.excellent {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
            color: white;
        }

        .location-recommendation.good {
            background: linear-gradient(135deg, var(--primary-color), #3498db);
            color: white;
        }

        .location-recommendation.fair {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
        }

        .location-recommendation.poor {
            background: linear-gradient(135deg, var(--error-color), #c0392b);
            color: white;
        }

        .recommendation-content {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .recommendation-content i {
            font-size: 1.2rem;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-indicator i {
            transition: color 0.3s ease;
        }

        .status-indicator.active i {
            color: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-indicator.error i {
            color: #e74c3c;
        }

        .status-indicator.warning i {
            color: #f39c12;
        }

        .status-indicator.info i {
            color: #3498db;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Quality Indicators */
        .quality-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .quality-indicator.excellent {
            background: #d4edda;
            color: #155724;
        }

        .quality-indicator.good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .quality-indicator.fair {
            background: #fff3cd;
            color: #856404;
        }

        .quality-indicator.poor {
            background: #f8d7da;
            color: #721c24;
        }

        /* Permission Status */
        .permission-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .permission-status.granted {
            background: #d4edda;
            color: #155724;
        }

        .permission-status.denied {
            background: #f8d7da;
            color: #721c24;
        }

        .permission-status.prompt {
            background: #fff3cd;
            color: #856404;
        }

        /* Enhanced location item styling */
        .location-item a {
            text-decoration: none;
            font-weight: 500;
            color: var(--text-accent);
        }

        .location-item a:hover {
            text-decoration: underline;
        }

        /* Admin Modal Styles */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .admin-modal-content {
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: 0 20px 60px var(--shadow-color);
            max-width: 450px;
            width: 90%;
            animation: adminModalSlide 0.3s ease;
            border: 1px solid var(--border-color);
        }

        @keyframes adminModalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .admin-modal-header {
            padding: 25px 30px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-modal-header h3 {
            color: var(--text-secondary);
            margin: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-modal-header h3 i {
            color: var(--button-danger);
        }

        .admin-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .admin-modal-close:hover {
            background: var(--table-header);
            color: var(--button-danger);
        }

        .admin-modal-body {
            padding: 25px 30px;
        }

        .admin-modal-body p {
            color: var(--text-primary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .admin-form-group {
            margin-bottom: 20px;
        }

        .admin-form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .admin-form-group input:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .admin-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .admin-attempts {
            color: var(--button-warning);
            text-align: center;
            margin-top: 10px;
        }

        .admin-modal-footer {
            padding: 15px 30px 25px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            border-top: 1px solid var(--border-color);
        }

        .admin-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-btn-cancel {
            background: var(--text-primary);
            color: var(--bg-card);
        }

        .admin-btn-cancel:hover {
            background: var(--text-secondary);
            transform: translateY(-1px);
        }

        .admin-btn-confirm {
            background: var(--button-danger);
            color: white;
        }

        .admin-btn-confirm:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .admin-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Admin Lock Icons */
        .admin-lock-icon {
            font-size: 0.8rem;
            margin-left: 5px;
            opacity: 0.7;
        }

        .action-btn:hover .admin-lock-icon {
            opacity: 1;
        }

        /* Admin Mode Indicators */
        .admin-mode-active {
            position: relative;
        }

        .admin-mode-active::after {
            content: "ADMIN";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Messages */
        .message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .message {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            position: relative;
            transition: opacity 0.3s ease;
        }

        .message-close {
            background: none;
            border: none;
            color: inherit;
            opacity: 0.7;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease;
            margin-left: auto;
        }

        .message-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }

        .message.success {
            background: #2ecc71;
            color: white;
        }

        .message.error {
            background: #e74c3c;
            color: white;
        }

        .message.warning {
            background: #f39c12;
            color: white;
        }

        .message.info {
            background: #3498db;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            text-align: center;
            color: var(--text-primary);
        }

        .loading-spinner i {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .loading-spinner p {
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* Action Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.check-in {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.check-out {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.break-start,
        .status-badge.lunch-start {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.break-end,
        .status-badge.lunch-end {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.present {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.absent {
            background: #f8d7da;
            color: #721c24;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .current-info {
                flex-direction: column;
                gap: 10px;
            }

            .location-group {
                flex-direction: column;
                gap: 15px;
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .filters {
                flex-direction: column;
                gap: 10px;
            }

            .filter-group {
                min-width: auto;
            }

            .table-container {
                font-size: 0.8rem;
            }

            .records-table th,
            .records-table td {
                padding: 8px 6px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .location-details {
                grid-template-columns: 1fr;
            }

            .control-group {
                gap: 8px;
            }

            .control-group label {
                padding: 10px;
                font-size: 0.9rem;
            }

            .location-controls {
                gap: 15px;
            }

            /* Student Management Responsive */
            .student-selection-container {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .add-student-form {
                flex-direction: column;
                gap: 8px;
            }

            .add-student-form input {
                min-width: auto;
            }

            .students-section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .student-item {
                padding: 10px;
            }

            .student-info {
                gap: 2px;
            }

            .remove-student-btn {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .form-card,
            .records-card,
            .location-card {
                padding: 20px;
            }

            .message-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
        
        /* Collapsible Section Styles */
        .section-header {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            margin-bottom: 0;
        }
        
        .section-header:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }
        
        .dark-theme .section-header {
            background: #2d3748;
            border-color: #4a5568;
        }
        
        .dark-theme .section-header:hover {
            background: #4a5568;
        }
        
        .dark-theme .section-header h3 {
            color: #e2e8f0;
        }
        
        .toggle-icon {
            font-size: 16px;
            transition: transform 0.3s ease;
            color: #6c757d;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background: #fff;
        }
        
        .dark-theme .collapsible-content {
            background: #1a202c;
            border-color: #4a5568;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            border: none;
        }
        
        .collapsible-content.expanded {
            max-height: 2000px;
            opacity: 1;
        }
        
        /* Adjust existing sections to work with collapsible */
        .actions-section .action-buttons,
        .location-section .location-card,
        .location-controls-section .location-card {
            margin: 0;
            border: none;
            border-radius: 0;
            padding: 20px;
        }

        /* Email Modal Styles */
        .email-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(3px);
        }

        .email-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .email-modal-content.large {
            max-width: 1100px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .email-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid #f0f2f5;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .email-modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .email-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .email-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .email-report-form {
            padding: 30px;
        }

        .email-form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .email-form-section h4 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .email-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .email-form-row:last-child {
            margin-bottom: 0;
        }

        .email-form-group {
            display: flex;
            flex-direction: column;
        }

        .email-form-group.full-width {
            grid-column: 1 / -1;
        }

        .email-form-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }

        .email-form-group input,
        .email-form-group select,
        .email-form-group textarea {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .email-form-group input:focus,
        .email-form-group select:focus,
        .email-form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .email-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .email-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .email-checkbox-item:hover {
            background: #f0f2f5;
            border-color: #667eea;
        }

        .email-checkbox-item input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .email-checkbox-item span {
            font-size: 14px;
            color: #555;
        }

        .email-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding: 25px 30px;
            border-top: 2px solid #f0f2f5;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .email-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            min-width: 120px;
            justify-content: center;
        }

        .email-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .email-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .email-btn.preview {
            background: #17a2b8;
            color: white;
        }

        .email-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .email-preview-content {
            padding: 30px;
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-height: 60vh;
            overflow-y: auto;
        }

        .email-preview-content pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .email-modal-content {
                width: 98%;
                margin: 10px;
            }

            .email-form-row {
                grid-template-columns: 1fr;
            }

            .email-checkbox-grid {
                grid-template-columns: 1fr;
            }

            .email-form-actions {
                flex-direction: column;
                gap: 10px;
            }

            .email-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 ondblclick="secretAdminAccess()"><i class="fas fa-school"></i> Class Attendance System</h1>
                <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
            <div class="current-info">
                <div class="info-item">
                    <i class="fas fa-calendar"></i>
                    <span id="currentDate"></span>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime"></span>
                </div>
                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationStatus">Getting location...</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Attendance Form -->
            <section class="attendance-section">
                <div class="form-card">
                    <h2><i class="fas fa-user-check"></i> Record Attendance</h2>
                    
                    <form id="attendanceForm" class="attendance-form">
                        <!-- Student Selection -->
                        <div class="form-group">
                            <label for="student"><i class="fas fa-user"></i> Select Student:</label>
                            <div class="student-selection-container">
                                <select id="student" name="student" required 
                                        aria-describedby="student-help" 
                                        aria-label="Select student for attendance tracking">
                                    <option value="">-- Select Student --</option>
                                </select>
                                <button type="button" id="manageStudentsBtn" class="manage-students-btn" 
                                        title="Manage Students" 
                                        aria-label="Manage student list"
                                        aria-expanded="false"
                                        aria-controls="studentManagementPanel"
                                        onclick="toggleStudentManagementPanel()">
                                    <i class="fas fa-cog" aria-hidden="true"></i>
                                </button>
                            </div>
                            <small id="student-help" class="form-help">Select the student for attendance tracking</small>
                        </div>

                        <!-- Student Management Panel (Hidden by default) -->
                        <div id="studentManagementPanel" class="student-management-panel" style="display: none;">
                            <div class="student-management-header">
                                <h4><i class="fas fa-users-cog"></i> Manage Students</h4>
                                <button type="button" id="closeStudentPanel" class="close-panel-btn" onclick="closeStudentManagementPanel()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Add New Student -->
                            <div class="add-student-section">
                                <div class="add-student-form">
                                    <div class="form-row">
                                        <input type="text" id="newStudentId" placeholder="Student ID (optional - auto-generated if empty)" maxlength="20">
                                        <input type="text" id="newStudentName" placeholder="Student Full Name (e.g., John Smith)" maxlength="100">
                                    </div>
                                    <button type="button" id="addStudentBtn" class="add-student-btn" onclick="addNewStudent()">
                                        <i class="fas fa-plus"></i> Add Student
                                    </button>
                                </div>
                            </div>

                            <!-- Current Students List -->
                            <div class="current-students-section">
                                <div class="students-section-header">
                                    <h5><i class="fas fa-list"></i> Current Students</h5>
                                    <button type="button" id="restoreDefaultBtn" class="restore-default-btn" onclick="restoreDefaultStudents()" title="Restore Default Students">
                                        <i class="fas fa-undo"></i> Restore Defaults
                                    </button>
                                </div>
                                <div id="studentsList" class="students-list">
                                    <!-- Students will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Attendance Status -->
                        <div class="form-group">
                            <label><i class="fas fa-user-check"></i> Mark Attendance:</label>
                            <div class="attendance-buttons">
                                <button type="button" id="presentBtn" class="attendance-btn present-btn" tabindex="0">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Present</span>
                                </button>
                                <button type="button" id="absentBtn" class="attendance-btn absent-btn" tabindex="0">
                                    <i class="fas fa-times-circle"></i>
                                    <span>Absent</span>
                                </button>
                            </div>
                            <input type="hidden" id="attendanceStatus" name="attendanceStatus" required>
                            <small id="attendance-help" class="form-help">Click Present or Absent to mark attendance</small>
                        </div>

                        <!-- Date & Time (Editable) -->
                        <div class="form-group">
                            <label for="dateTime"><i class="fas fa-calendar-alt"></i> Date & Time: <small style="color: #3498db; font-weight: normal;">(Editable)</small></label>
                            <input type="datetime-local" id="dateTime" name="dateTime" 
                                   aria-describedby="datetime-help" 
                                   aria-label="Attendance date and time"
                                   title="Click to edit date and time for past lectures">
                            <small id="datetime-help" class="form-help"> Auto-set to current time, but you can edit to record past lectures or specific times</small>
                        </div>

                        <!-- Location Fields -->
                        <div class="location-group">
                            <div class="form-group half">
                                <label for="latitude"><i class="fas fa-globe"></i> Latitude:</label>
                                <input type="text" id="latitude" name="latitude" readonly>
                            </div>
                            <div class="form-group half">
                                <label for="longitude"><i class="fas fa-globe"></i> Longitude:</label>
                                <input type="text" id="longitude" name="longitude" readonly>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="form-group">
                            <label for="notes"><i class="fas fa-sticky-note"></i> Notes (Optional):</label>
                            <textarea id="notes" name="notes" rows="3" 
                                      placeholder="Add any additional notes..." 
                                      aria-describedby="notes-help" 
                                      aria-label="Optional notes for attendance record"
                                      maxlength="500"></textarea>
                            <small id="notes-help" class="form-help">Optional additional information (max 500 characters)</small>
                        </div>

                        <!-- Fraud Protection Status -->
                        <div class="fraud-protection-status" id="fraudProtectionStatus" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;">
                            <div class="status-header">
                                <i class="fas fa-shield-alt"></i>
                                <strong>Security Status</strong>
                                <button type="button" id="toggleFraudStatus" class="toggle-btn" onclick="toggleFraudProtectionDetails()" title="Show/Hide Details">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                            <div id="fraudStatusDetails" class="status-details" style="display: none; margin-top: 8px; font-size: 0.9em; color: #666;">
                                <div id="fraudStatusText">Checking security status...</div>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Action Buttons -->
            <section class="actions-section">
                <div class="section-header collapsible-header" onclick="toggleSection('actions-content')">
                    <h3><i class="fas fa-tools"></i> Actions & Reports</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="actions-content-icon"></i>
                </div>
                <div id="actions-content" class="collapsible-content collapsed">
                <div class="action-buttons">
                    <button id="viewRecordsBtn" class="action-btn primary">
                        <i class="fas fa-eye"></i> View Records
                    </button>
                    <button id="downloadBtn" class="action-btn success">
                        <i class="fas fa-download"></i> Download Excel
                    </button>
                    <button id="clearBtn" class="action-btn danger" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Clear Data
                    </button>
                </div>
                
                <!-- Email Reporting Section -->
                <div class="email-report-section" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">
                        <i class="fas fa-envelope"></i> Email Reports
                    </h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button id="openEmailFormBtn" class="action-btn primary" style="white-space: nowrap;" onclick="testEmailForm()">
                            <i class="fas fa-envelope-open"></i> Create Email Report
                        </button>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
                        Generate professional attendance reports for managers and administrators.
                    </p>
                </div>
                </div>
            </section>

            <!-- Records Display -->
            <section id="recordsSection" class="records-section" style="display: none;">
                <div class="records-card">
                    <h2><i class="fas fa-list"></i> Attendance Records</h2>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <div class="filter-group">
                            <label for="filterDate"><i class="fas fa-calendar"></i> Date:</label>
                            <input type="date" id="filterDate">
                        </div>
                        <div class="filter-group">
                            <label for="filterEmployee"><i class="fas fa-user"></i> Student:</label>
                            <select id="filterEmployee">
                                <option value="">All Students</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterAction"><i class="fas fa-filter"></i> Status:</label>
                            <select id="filterAction">
                                <option value="">All Status</option>
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                            </select>
                        </div>
                        <button id="applyFilters" class="filter-btn" onclick="applyFilters()">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <button id="clearFilters" class="filter-btn" onclick="clearFilters()" style="background-color: #95a5a6; margin-left: 5px;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button id="exportPdf" class="filter-btn" onclick="exportFilteredRecordsToPdf()" style="background-color: #e74c3c; margin-left: 10px;">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>

                    <!-- Records Table -->
                    <div class="table-container">
                        <table id="recordsTable" class="records-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Student</th>
                                    <th>Action</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Location</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody">
                                <!-- Records will be inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Statistics -->
                    <div id="statisticsSection" class="statistics-section">
                        <h3><i class="fas fa-chart-pie"></i> Today's Statistics</h3>
                        <div class="stats-grid" id="statsGrid">
                            <!-- Stats will be inserted here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Location Info -->
            <section class="location-section">
                <div class="section-header collapsible-header" onclick="toggleSection('location-content')">
                    <h3><i class="fas fa-map-marker-alt"></i> Current Location</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="location-content-icon"></i>
                </div>
                <div id="location-content" class="collapsible-content collapsed">
                <div class="location-card">
                    <h3><i class="fas fa-map-marker-alt"></i> Current Location</h3>
                    <div class="location-details">
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-map-marker-alt"></i> Latitude:</span>
                            <span id="displayLatitude" class="location-value">--</span>
                            <button class="copy-btn" onclick="copyToClipboard(document.getElementById('displayLatitude').textContent)" title="Copy latitude">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-map-marker-alt"></i> Longitude:</span>
                            <span id="displayLongitude" class="location-value">--</span>
                            <button class="copy-btn" onclick="copyToClipboard(document.getElementById('displayLongitude').textContent)" title="Copy longitude">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-crosshairs"></i> Accuracy:</span>
                            <span id="locationAccuracy" class="accuracy-value">--</span>m
                            <span id="accuracyIcon" class="accuracy-icon"></span>
                            <div id="accuracyHelp" class="accuracy-help">
                                <small id="accuracyDescription">Waiting for GPS...</small>
                            </div>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-map-marked-alt"></i> Address:</span>
                            <div class="address-container">
                                <span id="locationAddress" class="address-value">Getting address...</span>
                                <div class="address-actions">
                                    <button class="copy-btn" onclick="copyToClipboard(document.getElementById('locationAddress').textContent)" title="Copy address">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="address-btn" onclick="refreshAddress()" title="Refresh address">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                    <button id="enableLocationBtn" class="address-btn success" onclick="enableLocationAccess()" title="Click to enable location access">
                                        <i class="fas fa-unlock"></i> Enable Location
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-mountain"></i> Altitude:</span>
                            <span id="locationAltitude" class="location-value">--</span>
                            <span id="altitudeAccuracy" class="altitude-accuracy"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-tachometer-alt"></i> Speed:</span>
                            <span id="locationSpeed" class="location-value">--</span>
                            <span id="speedUnit" class="speed-unit"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-compass"></i> Heading:</span>
                            <span id="locationHeading" class="location-value">--</span>
                            <span id="compassDirection" class="compass-direction"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-clock"></i> Last Update:</span>
                            <span id="locationTimestamp" class="timestamp-value">--</span>
                            <span id="timeAgo" class="time-ago"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-medal"></i> Quality:</span>
                            <span id="locationQuality" class="quality-indicator">--</span>
                            <span id="qualityIcon" class="quality-icon"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-shield-alt"></i> Permission:</span>
                            <span id="locationPermission" class="permission-status">--</span>
                            <button id="permissionHelpBtn" class="help-btn" onclick="showPermissionHelp()" title="Permission help">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-sync-alt"></i> Updates:</span>
                            <span id="locationUpdates" class="updates-count">0</span>
                            <span id="updateRate" class="update-rate"></span>
                        </div>
                        <div class="location-item">
                            <span class="location-label"><i class="fas fa-external-link-alt"></i> Map Link:</span>
                            <a id="mapLink" href="#" target="_blank" rel="noopener" class="map-link">View on Map</a>
                            <div class="map-options">
                                <a id="googleMapsLink" href="#" target="_blank" rel="noopener" class="map-option" title="Open in Google Maps">
                                    <i class="fab fa-google"></i>
                                </a>
                                <a id="appleMapsLink" href="#" target="_blank" rel="noopener" class="map-option" title="Open in Apple Maps">
                                    <i class="fab fa-apple"></i>
                                </a>
                            </div>
                        </div>
                        <div class="location-item coordinates-summary">
                            <span class="location-label"><i class="fas fa-globe"></i> Full Coordinates:</span>
                            <div class="coordinates-display">
                                <span id="fullCoordinates" class="coordinates-text">--</span>
                                <button class="copy-btn primary" onclick="copyFullCoordinates()" title="Copy full coordinates">
                                    <i class="fas fa-copy"></i> Copy All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </section>

            <!-- Geolocation Controls -->
            <section class="location-controls-section">
                <div class="section-header collapsible-header" onclick="toggleSection('location-controls-content')">
                    <h3><i class="fas fa-cogs"></i> Location Settings</h3>
                    <i class="fas fa-chevron-down toggle-icon" id="location-controls-content-icon"></i>
                </div>
                <div id="location-controls-content" class="collapsible-content collapsed">
                <div class="location-card">
                    <h3><i class="fas fa-cogs"></i> Location Settings 
                        <button id="toggleLocationSettings" class="toggle-btn" onclick="toggleLocationSettings()" title="Show/Hide Location Settings">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h3>
                    <div id="locationSettingsContent" style="display: none;">
                    <div class="location-controls">
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="highAccuracyToggle" checked>
                                <span>High Accuracy GPS</span>
                                <small>Uses GPS for better accuracy (higher battery usage)</small>
                            </label>
                        </div>
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="continuousTrackingToggle" checked>
                                <span>Continuous Tracking</span>
                                <small>Monitor location changes in real-time</small>
                            </label>
                        </div>
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="autoRefreshToggle">
                                <span>Auto Refresh Location</span>
                                <small>Automatically refresh location every 15 seconds for better accuracy</small>
                            </label>
                        </div>
                        <div class="control-group">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                <button id="refreshLocationBtn" class="action-btn primary">
                                    <i class="fas fa-sync-alt"></i> Refresh Location
                                </button>
                                <button id="testLocationBtn" class="action-btn info">
                                    <i class="fas fa-crosshairs"></i> Test Accuracy
                                </button>
                                <button id="improveAccuracyBtn" class="action-btn warning" title="Get enhanced GPS accuracy with multiple readings">
                                    <i class="fas fa-satellite"></i> Improve GPS
                                </button>
                                <button id="requestPermissionBtn" class="action-btn success" title="Click to request location permission - will show browser permission dialog">
                                    <i class="fas fa-unlock"></i> Get Location Permission
                                </button>
                            </div>
                        </div>
                        <div class="location-status-bar">
                            <div class="status-indicator" id="locationStatusIndicator">
                                <i class="fas fa-circle"></i>
                                <span id="locationStatusText">Initializing...</span>
                            </div>
                            <div id="locationTips" class="location-tips" style="display: none;">
                                <small>
                                    <i class="fas fa-lightbulb"></i> 
                                    <strong>Tips for better location accuracy:</strong><br>
                                     <strong>Permission:</strong> Enable location permission when prompted<br>
                                     <strong>Indoor Use:</strong> System supports indoor tracking with network/WiFi location<br>
                                     <strong>Best Results:</strong> Near windows or outdoors for GPS signal<br>
                                     <strong>Device:</strong> Enable WiFi and mobile data for better indoor accuracy<br>
                                     <strong>Settings:</strong> Location services must be enabled in device settings<br>
                                     <strong>Indoor Mode:</strong> 1-5km accuracy is normal and acceptable for home/office use<br>
                                     <strong>Network:</strong> Strong WiFi connection helps with indoor positioning<br>
                                     <strong>Outdoors:</strong> Move outside briefly for high-precision GPS if needed<br>
                                     <strong>Patience:</strong> Allow 30-60 seconds for location services to initialize
                                </small>
                            </div>
                            <div id="locationRecommendation" class="location-recommendation" style="display: none;">
                                <div class="recommendation-content">
                                    <i class="fas fa-info-circle"></i>
                                    <span id="recommendationText">Getting location recommendations...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                </div>
            </section>
        </main>

        <!-- Simple Email Form Modal -->
        <div id="emailFormModal" class="email-modal" style="display: none;">
            <div class="email-modal-content" style="max-width: 500px; background: white; padding: 20px; border-radius: 8px;">
                <div class="email-modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                    <h3 style="margin: 0; color: #333;"> Send Attendance Report</h3>
                    <button type="button" style="background: none; border: none; font-size: 20px; cursor: pointer;" onclick="closeEmailForm()"></button>
                </div>
                
                <form id="emailReportForm" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Send to Email:</label>
                        <input type="email" id="recipientEmail" required 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                               placeholder="manager@company.com">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 10px; font-weight: bold;">What to include:</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="reportType" value="present" checked> Present Students Only
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="reportType" value="absent"> Absent Students Only
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="reportType" value="both"> Both Present and Absent
                            </label>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" onclick="closeEmailForm()" 
                                style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button type="button" onclick="sendSimpleEmail()" 
                                style="flex: 1; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Send Email</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Email Preview Modal -->
        <div id="emailPreviewModal" class="email-modal" style="display: none;">
            <div class="email-modal-content large">
                <div class="email-modal-header">
                    <h3><i class="fas fa-eye"></i> Email Preview</h3>
                    <button type="button" class="email-modal-close" onclick="closeEmailPreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="emailPreviewContent" class="email-preview-content">
                    <!-- Preview content will be generated here -->
                </div>
                <div class="email-form-actions">
                    <button type="button" class="email-btn secondary" onclick="closeEmailPreview()">
                        <i class="fas fa-arrow-left"></i> Back to Edit
                    </button>
                    <button type="button" class="email-btn primary" onclick="sendFinalEmail()">
                        <i class="fas fa-paper-plane"></i> Send Email
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messageContainer" class="message-container"></div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Processing...</p>
            </div>
        </div>

        <!-- Admin Password Modal -->
        <div id="adminModal" class="admin-modal" style="display: none;">
            <div class="admin-modal-content">
                <div class="admin-modal-header">
                    <h3><i class="fas fa-shield-alt"></i> Admin Access Required</h3>
                    <button class="admin-modal-close" onclick="closeAdminModal()">&times;</button>
                </div>
                <div class="admin-modal-body">
                    <p>This action requires administrator privileges.</p>
                    <div class="admin-form-group">
                        <label for="adminPassword">
                            <i class="fas fa-lock"></i> Enter Admin Password:
                        </label>
                        <input type="password" id="adminPassword" placeholder="Admin password" 
                               onkeypress="handleAdminKeyPress(event)">
                    </div>
                    <div id="adminError" class="admin-error" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="adminErrorText"></span>
                    </div>
                    <div class="admin-attempts" id="adminAttempts" style="display: none;">
                        <small>Attempts remaining: <span id="attemptsCount">3</span></small>
                    </div>
                </div>
                <div class="admin-modal-footer">
                    <button class="admin-btn admin-btn-cancel" onclick="closeAdminModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="admin-btn admin-btn-confirm" onclick="validateAdminPassword()">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let attendanceData = [];
        let currentPosition = null;
        let watchId = null;
        let lastKnownPosition = null;
        let locationPermissionStatus = 'unknown';
        let isHighAccuracyEnabled = true;
        let locationUpdateCount = 0;
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = false;
        
        // Theme Management
        let isDarkMode = false;
        
        // Admin Security - Fixed: No more annoying password prompts!
        let isAdminMode = false;
        let ADMIN_PASSWORD = null; // Will be set only when needed
        let adminAttempts = 0;
        const MAX_ATTEMPTS = 3;
        
        // Function to get admin password (original security with baraa2021!)
        function getAdminPassword() {
            if (!ADMIN_PASSWORD) {
                // Use the original hardcoded admin password for security
                ADMIN_PASSWORD = "2021";
                // Store in session (cleared when browser closes)
                sessionStorage.setItem('adminPassword', ADMIN_PASSWORD);
            }
            return ADMIN_PASSWORD;
        }
        
        // Function to reset admin password (useful for testing or changing password)
        function resetAdminPassword() {
            ADMIN_PASSWORD = null;
            sessionStorage.removeItem('adminPassword');
            isAdminMode = false;
            updateAdminUI();
            showMessage('Admin password reset. You will be prompted for a new password on next admin access.', 'info');
        }

        // Anti-Fraud Protection System
        let lastSubmissionTime = 0;
        let submissionCount = 0;
        let lastSubmittedStudent = '';
        let suspiciousActivity = false;
        const SUBMISSION_COOLDOWN = 0; // No waiting time - instant submissions allowed
        const MAX_HOURLY_SUBMISSIONS = Infinity; // No limit - infinite submissions allowed
        const MIN_LOCATION_ACCURACY = 20000; // Enhanced 20km range for better functionality
        const MAX_TRAVEL_SPEED = 120; // Maximum reasonable travel speed (km/h)
        const MIN_TIME_BETWEEN_LOCATIONS = 30000; // 30 seconds minimum between location changes
        const CAMPUS_LOCATIONS = [
            { lat: 25.2048, lng: 55.2708, name: 'Dubai' }, // Dubai coordinates
            { lat: 25.3548, lng: 55.4105, name: 'Sharjah' }, // Sharjah coordinates
        ];
        let hourlySubmissions = [];
        let consecutiveSubmissions = 0;
        let locationHistory = [];
        
        // Load fraud protection data from localStorage
        function loadFraudProtectionData() {
            try {
                const saved = localStorage.getItem('fraudProtectionData');
                if (saved) {
                    const data = JSON.parse(saved);
                    const now = Date.now();
                    
                    // Only restore recent data (within last hour)
                    lastSubmissionTime = data.lastSubmissionTime || 0;
                    submissionCount = data.submissionCount || 0;
                    lastSubmittedStudent = data.lastSubmittedStudent || '';
                    suspiciousActivity = data.suspiciousActivity || false;
                    
                    // Filter hourly submissions to only include last hour
                    hourlySubmissions = (data.hourlySubmissions || []).filter(time => 
                        now - time < 3600000
                    );
                    
                    // Filter location history to only include recent locations (last 30 minutes)
                    locationHistory = (data.locationHistory || []).filter(loc => 
                        now - loc.timestamp < 1800000
                    );
                }
            } catch (error) {
                console.error('Error loading fraud protection data:', error);
                // Reset to defaults if error
                resetFraudProtectionData();
            }
        }
        
        // Save fraud protection data to localStorage
        function saveFraudProtectionData() {
            try {
                const data = {
                    lastSubmissionTime,
                    submissionCount,
                    lastSubmittedStudent,
                    suspiciousActivity,
                    hourlySubmissions,
                    locationHistory,
                    timestamp: Date.now()
                };
                localStorage.setItem('fraudProtectionData', JSON.stringify(data));
            } catch (error) {
                console.error('Error saving fraud protection data:', error);
            }
        }
        
        // Reset fraud protection data
        function resetFraudProtectionData() {
            lastSubmissionTime = 0;
            submissionCount = 0;
            lastSubmittedStudent = '';
            suspiciousActivity = false;
            hourlySubmissions = [];
            consecutiveSubmissions = 0;
            locationHistory = [];
            saveFraudProtectionData();
            updateFraudProtectionUI();
            showMessage('Fraud protection data reset - all counters cleared', 'info');
        }
        
        // Admin function to manually reset submission counter
        function resetSubmissionCounter() {
            if (confirm('Reset submission counter? This will allow 3 new submissions immediately.')) {
                resetFraudProtectionData();
            }
        }

        // Student Management
        let activeStudents = {}; // Dynamic list of active students
        
        // Default student names (can be restored if needed)
        const defaultStudentNames = {
            'STU001': { id: 'STU001', name: 'Baraa Takala' },
            'STU002': { id: 'STU002', name: 'Yaman Takala' },
            'STU003': { id: 'STU003', name: 'Baraa Shaibani' },
            'STU004': { id: 'STU004', name: 'Homam Hassan' },
            'STU005': { id: 'STU005', name: 'Ahmed Naqawa' },
            'STU006': { id: 'STU006', name: 'Yahya Aldaik' },
            'STU007': { id: 'STU007', name: 'Asaad Diaa' },
            'STU008': { id: 'STU008', name: 'obada' },
            'STU009': { id: 'STU009', name: 'Omar Bawab' },
            'STU010': { id: 'STU010', name: 'Yosuf Sadek' },
            'STU011': { id: 'STU011', name: 'Mohamed Kheir' },
            'STU012': { id: 'STU012', name: 'Lyth atour' },
            'STU013': { id: 'STU013', name: 'Zouher Qbaqibi' },
            'STU014': { id: 'STU014', name: 'Mohamed Qbaqibi' },
            'STU015': { id: 'STU015', name: 'Abdul Aziz Alzaubi' },
            'STU016': { id: 'STU016', name: 'Omar Akeel' },
            'STU017': { id: 'STU017', name: 'Maleek Bitar' },
            'STU018': { id: 'STU018', name: 'Mohamed Amin' },
            'STU019': { id: 'STU019', name: 'Lyth Kawokgi' }
        };

        // Student names mapping (for backward compatibility)
        let studentNames = {};

        // Action type mapping
        const actionTypeMapping = {
            'check-in': { label: 'Check In', icon: 'fas fa-sign-in-alt', color: '#27ae60' },
            'check-out': { label: 'Check Out', icon: 'fas fa-sign-out-alt', color: '#e74c3c' },
            'break-start': { label: 'Break Start', icon: 'fas fa-coffee', color: '#f39c12' },
            'break-end': { label: 'Break End', icon: 'fas fa-play', color: '#3498db' },
            'lunch-start': { label: 'Lunch Start', icon: 'fas fa-utensils', color: '#9b59b6' },
            'lunch-end': { label: 'Lunch End', icon: 'fas fa-utensils', color: '#1abc9c' }
        };

        // DOM Elements
        const elements = {
            form: document.getElementById('attendanceForm'),
            student: document.getElementById('student'),
            attendanceStatus: document.getElementById('attendanceStatus'),
            presentBtn: document.getElementById('presentBtn'),
            absentBtn: document.getElementById('absentBtn'),
            dateTime: document.getElementById('dateTime'),
            latitude: document.getElementById('latitude'),
            longitude: document.getElementById('longitude'),
            notes: document.getElementById('notes'),
            
            // Display elements
            currentDate: document.getElementById('currentDate'),
            currentTime: document.getElementById('currentTime'),
            locationStatus: document.getElementById('locationStatus'),
            displayLatitude: document.getElementById('displayLatitude'),
            displayLongitude: document.getElementById('displayLongitude'),
            locationAccuracy: document.getElementById('locationAccuracy'),
            locationAddress: document.getElementById('locationAddress'),
            locationAltitude: document.getElementById('locationAltitude'),
            locationSpeed: document.getElementById('locationSpeed'),
            locationHeading: document.getElementById('locationHeading'),
            locationTimestamp: document.getElementById('locationTimestamp'),
            locationQuality: document.getElementById('locationQuality'),
            locationPermission: document.getElementById('locationPermission'),
            locationUpdates: document.getElementById('locationUpdates'),
            mapLink: document.getElementById('mapLink'),
            
            // Action buttons
            viewRecordsBtn: document.getElementById('viewRecordsBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            clearBtn: document.getElementById('clearBtn'),
            statsBtn: document.getElementById('statsBtn'),
            sendEmailBtn: document.getElementById('sendEmailBtn'),
            reportEmail: document.getElementById('reportEmail'),
            openEmailFormBtn: document.getElementById('openEmailFormBtn'),
            
            // Email Form Elements
            emailFormModal: document.getElementById('emailFormModal'),
            emailReportForm: document.getElementById('emailReportForm'),
            emailPreviewModal: document.getElementById('emailPreviewModal'),
            emailPreviewContent: document.getElementById('emailPreviewContent'),
            
            // Email Form Fields
            recipientEmail: document.getElementById('recipientEmail'),
            recipientName: document.getElementById('recipientName'),
            ccEmails: document.getElementById('ccEmails'),
            reportType: document.getElementById('reportType'),
            reportPriority: document.getElementById('reportPriority'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            emailSubject: document.getElementById('emailSubject'),
            customMessage: document.getElementById('customMessage'),
            senderName: document.getElementById('senderName'),
            dateRangeSection: document.getElementById('dateRangeSection'),
            
            // Records section
            recordsSection: document.getElementById('recordsSection'),
            filterDate: document.getElementById('filterDate'),
            filterEmployee: document.getElementById('filterEmployee'),
            filterAction: document.getElementById('filterAction'),
            applyFilters: document.getElementById('applyFilters'),
            recordsTableBody: document.getElementById('recordsTableBody'),
            statsGrid: document.getElementById('statsGrid'),
            
            // Messages
            messageContainer: document.getElementById('messageContainer'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            
            // Student Management
            manageStudentsBtn: document.getElementById('manageStudentsBtn'),
            studentManagementPanel: document.getElementById('studentManagementPanel'),
            closeStudentPanel: document.getElementById('closeStudentPanel'),
            newStudentId: document.getElementById('newStudentId'),
            newStudentName: document.getElementById('newStudentName'),
            addStudentBtn: document.getElementById('addStudentBtn'),
            studentsList: document.getElementById('studentsList')
        };

        // Global variable to store selected attendance status
        let selectedAttendanceStatus = null;

        // Function to handle attendance status selection
        function setAttendanceStatus(status) {
            // Check if student is selected first
            if (!elements.student.value) {
                showMessage('Please select a student first', 'warning');
                elements.student.focus();
                return;
            }
            
            const studentSelect = elements.student;
            const studentName = studentSelect.options[studentSelect.selectedIndex]?.text || 'Selected Student';
            
            selectedAttendanceStatus = status;
            
            // Update button appearances
            elements.presentBtn.classList.remove('selected');
            elements.absentBtn.classList.remove('selected');
            
            if (status === 'present') {
                elements.presentBtn.classList.add('selected');
                elements.attendanceStatus.value = 'present';
                // Submit form immediately without confirmation
                setTimeout(() => {
                    const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                    elements.form.dispatchEvent(submitEvent);
                }, 100);
            } else if (status === 'absent') {
                elements.absentBtn.classList.add('selected');
                elements.attendanceStatus.value = 'absent';
                // Submit form immediately without confirmation
                setTimeout(() => {
                    const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                    elements.form.dispatchEvent(submitEvent);
                }, 100);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Initialize theme
            initializeTheme();
            
            // Load fraud protection data (MUST be loaded before other initializations)
            loadFraudProtectionData();
            
            // Load saved data from localStorage
            loadDataFromStorage();
            
            // Initialize geolocation
            initializeGeolocation();
            
            // Set up event listeners
            // Memory Leak Prevention: Store intervals for cleanup
            window.appIntervals = {
                timeUpdate: null,
                locationTimestamp: null,
                fraudProtection: null,
                submissionPatterns: null,
                locationConsistency: null,
                historyCleanup: null
            };
            
            setupEventListeners();
            
            // Start time updates
            updateCurrentTime();
            window.appIntervals.timeUpdate = setInterval(updateCurrentTime, 1000);
            
            // Start location timestamp updates
            window.appIntervals.locationTimestamp = setInterval(updateLocationTimestamps, 1000);
            
            // Update fraud protection status
            updateFraudProtectionUI();
            window.appIntervals.fraudProtection = setInterval(updateFraudProtectionUI, 60000); // Update every 60 seconds (less frequent)
            
            // Populate filter dropdowns
            populateFilterDropdowns();
            
            // Initialize student management
            initializeStudentManagement();
            
            // Initialize admin UI
            updateAdminUI();
            
            // Initialize collapsible sections
            initializeCollapsibleSections();
            
            // Update initial statistics
            updateStatistics();
            
            showMessage(' Attendance Tracker ready! Location will be requested automatically.', 'success');
        }

        function setupEventListeners() {
            // Form submission
            elements.form.addEventListener('submit', handleFormSubmit);
            
            // Attendance buttons
            elements.presentBtn.addEventListener('click', () => setAttendanceStatus('present'));
            elements.absentBtn.addEventListener('click', () => setAttendanceStatus('absent'));
            
            // Add keyboard support for attendance buttons
            elements.presentBtn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    setAttendanceStatus('present');
                }
            });
            
            elements.absentBtn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    setAttendanceStatus('absent');
                }
            });
            
            // Student selection change - reset attendance status
            elements.student.addEventListener('change', () => {
                elements.presentBtn.classList.remove('selected');
                elements.absentBtn.classList.remove('selected');
                elements.attendanceStatus.value = '';
                elements.submitText.textContent = 'Record Attendance';
                
                // Reset submit button styling
                elements.submitBtn.style.background = '';
                elements.submitBtn.style.boxShadow = '';
                elements.submitBtn.style.transform = '';
                
                selectedAttendanceStatus = null;
            });
            
            // Action buttons
            elements.viewRecordsBtn.addEventListener('click', () => {
                elements.viewRecordsBtn.disabled = true;
                setTimeout(() => elements.viewRecordsBtn.disabled = false, 1000);
                toggleRecordsView();
            });
            
            elements.downloadBtn.addEventListener('click', downloadExcel);
            
            elements.sendEmailBtn.addEventListener('click', sendEmailReport);
            
            console.log('Setting up openEmailFormBtn event listener');
            console.log('elements.openEmailFormBtn:', elements.openEmailFormBtn);
            if (elements.openEmailFormBtn) {
                elements.openEmailFormBtn.addEventListener('click', function() {
                    console.log('Email button clicked!');
                    openEmailForm();
                });
                console.log('Event listener added successfully');
            } else {
                console.error('openEmailFormBtn element not found!');
            }
            
            // Email form event listeners
            if (elements.emailReportForm) {
                elements.emailReportForm.addEventListener('submit', handleEmailFormSubmit);
            }
            
            if (elements.reportType) {
                elements.reportType.addEventListener('change', handleReportTypeChange);
            }
            
            elements.clearBtn.addEventListener('click', () => {
                elements.clearBtn.disabled = true;
                setTimeout(() => elements.clearBtn.disabled = false, 1000);
                clearAllData();
            });
            
            // Filters
            elements.applyFilters.addEventListener('click', applyFilters);
            
            // Student Management
            setupStudentManagementListeners();
            
            // Real-time datetime update
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Character counter for notes
            const notesField = document.getElementById('notes');
            if (notesField) {
                notesField.addEventListener('input', updateNotesCounter);
                // Initialize counter
                updateNotesCounter.call(notesField);
            }
            
            // Anti-fraud monitoring
            setupAntiFraudMonitoring();
        }

        // Anti-Fraud Protection System  
        function setupAntiFraudMonitoring() {
            // Monitor rapid submissions with proper cleanup
            window.appIntervals.submissionPatterns = setInterval(checkSubmissionPatterns, 60000); // Check every minute
            
            // Monitor location consistency
            window.appIntervals.locationConsistency = setInterval(validateLocationConsistency, 120000); // Check every 2 minutes
            
            // Clean old submission history
            window.appIntervals.historyCleanup = setInterval(cleanSubmissionHistory, 3600000); // Clean every hour
        }
        
        // Cleanup function to prevent memory leaks
        function cleanupAppIntervals() {
            if (window.appIntervals) {
                Object.keys(window.appIntervals).forEach(key => {
                    if (window.appIntervals[key]) {
                        clearInterval(window.appIntervals[key]);
                        window.appIntervals[key] = null;
                    }
                });
            }
            
            // Clean location watchers
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Add cleanup on page unload
        window.addEventListener('beforeunload', cleanupAppIntervals);

        function validateSubmission() {
            const now = Date.now();
            const timeSinceLastSubmission = now - lastSubmissionTime;
            const selectedStudent = elements.student.value;
            
            // All cooldown checks removed - instant submissions allowed
            
            // Check 3: Hourly submission limit - DISABLED (infinite submissions allowed)
            hourlySubmissions = hourlySubmissions.filter(time => now - time < 3600000); // Keep only last hour for tracking
            // Hourly limit check removed - unlimited submissions now allowed
            
            // Check 4: GPS accuracy requirement (enhanced for indoor use)
            if (!currentPosition) {
                showMessage(` Location not available. Please enable location services and wait for GPS acquisition.`, 'error');
                return false;
            }
            
            if (currentPosition.coords.accuracy > MIN_LOCATION_ACCURACY) {
                const accuracy = currentPosition.coords.accuracy.toFixed(1);
                const maxKm = (MIN_LOCATION_ACCURACY/1000).toFixed(1);
                showMessage(` Location accuracy (${accuracy}m) exceeds limit. Maximum ${maxKm}km radius allowed. Try moving to an open area or enable high-accuracy mode.`, 'warning');
                return false;
            }
            
            // Check 5: Location consistency (prevent spoofing)
            if (!validateLocationHistory()) {
                return false;
            }
            
            // Check 6: Time-based validation (prevent backdating)
            const submissionTime = new Date(elements.dateTime.value);
            const currentTime = new Date();
            const timeDiff = Math.abs(currentTime - submissionTime);
            
            if (timeDiff > 300000) { // 5 minutes tolerance
                showMessage(' Submission time is too far from current time. Please refresh and try again.', 'warning');
                return false;
            }
            
            // Check 7: Detect suspicious patterns
            if (detectSuspiciousPattern()) {
                return false;
            }
            
            return true;
        }

        function validateLocationHistory() {
            if (!currentPosition) return false;
            
            const currentLat = currentPosition.coords.latitude;
            const currentLng = currentPosition.coords.longitude;
            const now = Date.now();
            
            // Add current location to history
            locationHistory.push({
                lat: currentLat,
                lng: currentLng,
                timestamp: now,
                accuracy: currentPosition.coords.accuracy
            });
            
            // Keep only last 10 locations
            locationHistory = locationHistory.slice(-10);
            
            // Check for impossible travel (teleportation detection)
            if (locationHistory.length >= 2) {
                const lastLocation = locationHistory[locationHistory.length - 2];
                const distance = calculateDistance(lastLocation.lat, lastLocation.lng, currentLat, currentLng);
                const timeElapsed = (now - lastLocation.timestamp) / 1000 / 60; // minutes
                const speed = distance / timeElapsed; // km/minute
                
                // If traveling faster than 5 km/minute (300 km/h), it's suspicious
                if (speed > 5 && distance > 1) { // Only check if distance > 1km
                    showMessage(' Suspicious location change detected. GPS spoofing or rapid travel detected.', 'error');
                    logSuspiciousActivity(`Impossible travel: ${distance.toFixed(2)}km in ${timeElapsed.toFixed(1)} minutes`);
                    suspiciousActivity = true;
                    return false;
                }
            }
            
            return true;
        }

        function detectSuspiciousPattern() {
            const now = Date.now();
            
            // Check for consecutive submissions (bulk submission pattern)
            consecutiveSubmissions++;
            
            if (consecutiveSubmissions > 3) {
                const avgInterval = hourlySubmissions.length > 1 ? 
                    (now - hourlySubmissions[0]) / hourlySubmissions.length : 0;
                
                if (avgInterval < 60000) { // Less than 1 minute average
                    showMessage(' Bulk submission pattern detected. Please record attendance naturally with normal intervals.', 'error');
                    logSuspiciousActivity('Rapid consecutive submissions detected');
                    suspiciousActivity = true;
                    return true;
                }
            }
            
            // Reset consecutive counter after 5 minutes of no submissions
            setTimeout(() => {
                consecutiveSubmissions = Math.max(0, consecutiveSubmissions - 1);
            }, 300000);
            
            return false;
        }

        function logSuspiciousActivity(reason) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                reason: reason,
                location: currentPosition ? {
                    lat: currentPosition.coords.latitude,
                    lng: currentPosition.coords.longitude,
                    accuracy: currentPosition.coords.accuracy
                } : null,
                userAgent: navigator.userAgent,
                submissionCount: submissionCount
            };
            
            // Store in localStorage for admin review
            const existingLogs = JSON.parse(localStorage.getItem('suspiciousActivity') || '[]');
            existingLogs.push(logEntry);
            
            // Keep only last 50 log entries
            if (existingLogs.length > 50) {
                existingLogs.splice(0, existingLogs.length - 50);
            }
            
            localStorage.setItem('suspiciousActivity', JSON.stringify(existingLogs));
            
            console.warn('Suspicious activity logged:', logEntry);
        }

        function checkSubmissionPatterns() {
            // Reset suspicious activity flag after 1 hour of clean behavior
            if (suspiciousActivity) {
                const lastHourSubmissions = hourlySubmissions.filter(time => 
                    Date.now() - time < 3600000
                );
                
                if (lastHourSubmissions.length === 0) {
                    suspiciousActivity = false;
                    showMessage(' Fraud protection status: Normal', 'success');
                }
            }
        }

        function validateLocationConsistency() {
            // Check if user has been in the same general area
            if (locationHistory.length >= 3) {
                const recent = locationHistory.slice(-3);
                const maxDistance = Math.max(...recent.map((loc, i) => {
                    if (i === 0) return 0;
                    return calculateDistance(
                        recent[0].lat, recent[0].lng,
                        loc.lat, loc.lng
                    );
                }));
                
                // If consistently in same area (within 1km), it's probably legitimate
                if (maxDistance < 1) {
                    // Reward consistent location with reduced cooldown
                    // This encourages legitimate use
                }
            }
        }

        function cleanSubmissionHistory() {
            const oneHourAgo = Date.now() - 3600000;
            hourlySubmissions = hourlySubmissions.filter(time => time > oneHourAgo);
        }

        // Cache for performance optimization
        let lastStatusUpdate = 0;
        let cachedStatus = '';
        let cachedRemainingSubmissions = MAX_HOURLY_SUBMISSIONS;

        function showFraudProtectionStatus() {
            const now = Date.now();
            
            // Only recalculate if it's been more than 5 seconds since last update
            if (now - lastStatusUpdate < 5000 && cachedStatus) {
                return cachedStatus;
            }
            
            const statusMessages = [];
            
            // Clean up old submissions first (only if needed)
            const initialLength = hourlySubmissions.length;
            hourlySubmissions = hourlySubmissions.filter(time => now - time < 3600000);
            
            if (suspiciousActivity) {
                statusMessages.push(' Enhanced monitoring active');
            }
            
            // Remove hourly submission limit display since it's now infinite
            statusMessages.push(` Ready for unlimited submissions`);
            
            // Only add GPS status if we have a position
            if (currentPosition) {
                const accuracy = currentPosition.coords.accuracy;
                if (accuracy <= MIN_LOCATION_ACCURACY) {
                    statusMessages.push(` GPS: Good (${accuracy.toFixed(0)}m)`);
                } else {
                    statusMessages.push(` GPS: Fair (${accuracy.toFixed(0)}m)`);
                }
            } else {
                statusMessages.push(` GPS: Waiting...`);
            }
            
            // Cooldown display removed - no waiting time required
            
            cachedStatus = statusMessages.join('\n');
            lastStatusUpdate = now;
            
            return cachedStatus;
        }

        // Cooldown timer functions removed - no waiting time required

        function updateFraudProtectionUI() {
            const statusElement = document.getElementById('fraudStatusText');
            if (!statusElement) return;
            
            const newStatus = showFraudProtectionStatus();
            
            // Only update DOM if status actually changed
            if (statusElement.innerHTML !== newStatus.replace(/\n/g, '<br>')) {
                statusElement.innerHTML = newStatus.replace(/\n/g, '<br>');
            }
            
            // Update status color based on protection level (only if needed)
            const statusContainer = document.getElementById('fraudProtectionStatus');
            if (!statusContainer) return;
            
            let newBorderColor = '#27ae60'; // Default green - unlimited submissions
            let newBackgroundColor = '#e8f5e8';
            
            if (suspiciousActivity) {
                newBorderColor = '#e74c3c'; // Red for suspicious
                newBackgroundColor = '#ffebee';
            }
            // Removed hourly submission count warning since limit is now infinite
            
            // Only update styles if they changed
            if (statusContainer.style.borderLeftColor !== newBorderColor) {
                statusContainer.style.borderLeftColor = newBorderColor;
                statusContainer.style.backgroundColor = newBackgroundColor;
            }
        }

        function toggleFraudProtectionDetails() {
            const details = document.getElementById('fraudStatusDetails');
            const toggleBtn = document.getElementById('toggleFraudStatus');
            const icon = toggleBtn.querySelector('i');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                details.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Admin function to view suspicious activity logs
        function viewSuspiciousActivityLogs() {
            const logs = JSON.parse(localStorage.getItem('suspiciousActivity') || '[]');
            
            if (logs.length === 0) {
                showMessage('No suspicious activity detected. System is clean! ', 'success');
                return;
            }
            
            let logDisplay = ` SUSPICIOUS ACTIVITY LOG (${logs.length} entries)\n\n`;
            
            logs.slice(-10).reverse().forEach((log, index) => {
                const date = new Date(log.timestamp).toLocaleString();
                logDisplay += `${index + 1}. ${date}\n`;
                logDisplay += `   Reason: ${log.reason}\n`;
                logDisplay += `   Submissions: ${log.submissionCount}\n`;
                if (log.location) {
                    logDisplay += `   Location: ${log.location.lat.toFixed(4)}, ${log.location.lng.toFixed(4)} (${log.location.accuracy.toFixed(1)}m)\n`;
                }
                logDisplay += '\n';
            });
            
            // Show in modal or alert
            alert(logDisplay);
        }

        // Admin function to clear suspicious activity logs
        function clearSuspiciousActivityLogs() {
            if (confirm('Clear all suspicious activity logs? This action cannot be undone.')) {
                localStorage.removeItem('suspiciousActivity');
                suspiciousActivity = false;
                showMessage('Suspicious activity logs cleared', 'success');
                updateFraudProtectionUI();
            }
        }

        // Theme Management Functions
        function initializeTheme() {
            // Check for saved theme preference or default to light
            const savedTheme = localStorage.getItem('attendance-tracker-theme');
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            } else {
                isDarkMode = false;
                document.documentElement.removeAttribute('data-theme');
                updateThemeIcon();
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('attendance-tracker-theme', 'dark');
                showMessage('Switched to dark mode', 'info');
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('attendance-tracker-theme', 'light');
                showMessage('Switched to light mode', 'info');
            }
            
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                if (isDarkMode) {
                    themeIcon.className = 'fas fa-sun';
                    themeIcon.style.transform = 'rotate(180deg)';
                } else {
                    themeIcon.className = 'fas fa-moon';
                    themeIcon.style.transform = 'rotate(0deg)';
                }
            }
        }

        // Student Management Functions
        function initializeStudentManagement() {
            // Load active students from storage or use defaults
            loadActiveStudents();
            
            // Update student names for backward compatibility
            studentNames = {...activeStudents};
            
            // Populate the student dropdown
            populateStudentDropdown();
            
            // Update the student management panel
            updateStudentsList();
        }

        function loadActiveStudents() {
            try {
                const saved = localStorage.getItem('activeStudents');
                if (saved) {
                    activeStudents = JSON.parse(saved);
                } else {
                    // Use default students for first time
                    activeStudents = {...defaultStudentNames};
                    saveActiveStudents();
                }
            } catch (error) {
                console.error('Error loading active students:', error);
                activeStudents = {...defaultStudentNames};
                saveActiveStudents();
            }
        }

        function saveActiveStudents() {
            try {
                localStorage.setItem('activeStudents', JSON.stringify(activeStudents));
                // Update studentNames for backward compatibility
                studentNames = {...activeStudents};
            } catch (error) {
                console.error('Error saving active students:', error);
                showMessage('Error saving student data', 'error');
            }
        }

        function populateStudentDropdown() {
            const studentSelect = elements.student;
            if (!studentSelect) return;

            // Clear current options except the first one
            studentSelect.innerHTML = '<option value="">-- Select Student --</option>';

            // Add active students with ID and name display
            Object.keys(activeStudents).sort().forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                
                // Handle both old string format and new object format
                if (typeof activeStudents[key] === 'string') {
                    option.textContent = activeStudents[key]; // Legacy format
                } else {
                    option.textContent = `${activeStudents[key].id} - ${activeStudents[key].name}`;
                }
                
                studentSelect.appendChild(option);
            });

            // Also update filter dropdown if it exists
            updateFilterStudentDropdown();
        }

        function updateFilterStudentDropdown() {
            const filterStudent = elements.filterEmployee; // Keep same element name for backward compatibility
            if (!filterStudent) return;

            const currentValue = filterStudent.value;
            filterStudent.innerHTML = '<option value="">All Students</option>';

            Object.keys(activeStudents).sort().forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                
                // Handle both old string format and new object format
                if (typeof activeStudents[key] === 'string') {
                    option.textContent = activeStudents[key]; // Legacy format
                } else {
                    option.textContent = `${activeStudents[key].id} - ${activeStudents[key].name}`;
                }
                
                filterStudent.appendChild(option);
            });

            // Restore previous selection if still valid
            if (currentValue && activeStudents[currentValue]) {
                filterStudent.value = currentValue;
            }
        }

        function setupStudentManagementListeners() {
            // Manage students button - direct access, no password needed
            if (elements.manageStudentsBtn) {
                elements.manageStudentsBtn.addEventListener('click', () => {
                    toggleStudentManagementPanel();
                });
            }

            // Close panel button
            if (elements.closeStudentPanel) {
                elements.closeStudentPanel.addEventListener('click', closeStudentManagementPanel);
            }

            // Add student button
            if (elements.addStudentBtn) {
                elements.addStudentBtn.addEventListener('click', addNewStudent);
            }

            // Enter key support for add student inputs
            if (elements.newStudentId) {
                elements.newStudentId.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addNewStudent();
                    }
                });
                
                // Input validation
                elements.newStudentId.addEventListener('input', validateStudentInputs);
            }
            
            if (elements.newStudentName) {
                elements.newStudentName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addNewStudent();
                    }
                });
                
                // Input validation
                elements.newStudentName.addEventListener('input', validateStudentInputs);
            }
        }

        function toggleStudentManagementPanel() {
            const panel = elements.studentManagementPanel;
            if (!panel) return;

            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                updateStudentsList();
                // Focus on the input
                setTimeout(() => {
                    if (elements.newStudentName) {
                        elements.newStudentName.focus();
                    }
                }, 100);
            } else {
                panel.style.display = 'none';
            }
        }

        function closeStudentManagementPanel() {
            const panel = elements.studentManagementPanel;
            if (panel) {
                panel.style.display = 'none';
            }
            clearStudentInputs();
        }

        function clearStudentInputs() {
            if (elements.newStudentId) elements.newStudentId.value = '';
            if (elements.newStudentName) elements.newStudentName.value = '';
            validateStudentInputs();
        }

        function validateStudentInputs() {
            const idInput = elements.newStudentId;
            const nameInput = elements.newStudentName;
            const addBtn = elements.addStudentBtn;

            if (!nameInput || !addBtn) return;

            const id = idInput ? idInput.value.trim() : '';
            const name = nameInput.value.trim();

            // Validation rules
            const isNameValid = name.length >= 2;
            let isIdValid = true;
            let isIdUnique = true;

            // Check ID if provided
            if (id) {
                isIdValid = /^[A-Za-z0-9]{3,20}$/.test(id); // Allow alphanumeric, 3-20 chars
                isIdUnique = !Object.keys(activeStudents).some(key => {
                    const student = activeStudents[key];
                    if (typeof student === 'string') return false; // Legacy format
                    return student.id && student.id.toLowerCase() === id.toLowerCase();
                });
            }

            // Check name uniqueness
            const isNameUnique = !Object.keys(activeStudents).some(key => {
                const student = activeStudents[key];
                const studentName = typeof student === 'string' ? student : student.name;
                return studentName.toLowerCase() === name.toLowerCase();
            });

            // Update button state
            addBtn.disabled = !(isNameValid && isNameUnique && isIdValid && isIdUnique);

            // Show validation feedback for name
            if (name && !isNameValid) {
                nameInput.style.borderColor = '#e74c3c';
                nameInput.title = 'Name must be at least 2 characters';
            } else if (name && !isNameUnique) {
                nameInput.style.borderColor = '#f39c12';
                nameInput.title = 'A student with this name already exists';
            } else {
                nameInput.style.borderColor = '';
                nameInput.title = '';
            }

            // Show validation feedback for ID
            if (idInput) {
                if (id && !isIdValid) {
                    idInput.style.borderColor = '#e74c3c';
                    idInput.title = 'ID must be 3-20 alphanumeric characters';
                } else if (id && !isIdUnique) {
                    idInput.style.borderColor = '#f39c12';
                    idInput.title = 'This Student ID already exists';
                } else {
                    idInput.style.borderColor = '';
                    idInput.title = '';
                }
            }
        }

        function generateStudentKey(id) {
            // Use the ID as the key, or generate from name for legacy compatibility
            return id || 'LEGACY_' + Date.now();
        }

        function generateNextStudentId() {
            // Find the highest existing STU number
            let maxNum = 0;
            Object.keys(activeStudents).forEach(key => {
                const student = activeStudents[key];
                if (typeof student === 'object' && student.id) {
                    const match = student.id.match(/^STU(\d+)$/);
                    if (match) {
                        maxNum = Math.max(maxNum, parseInt(match[1]));
                    }
                }
            });
            
            // Return next available number with leading zeros
            return `STU${String(maxNum + 1).padStart(3, '0')}`;
        }

        function addNewStudent() {
            console.log(' Add New Student function called');
            const idInput = elements.newStudentId;
            const nameInput = elements.newStudentName;

            console.log(' ID Input:', idInput);
            console.log(' Name Input:', nameInput);

            if (!nameInput) {
                console.log(' Error: Name input not found');
                showMessage('Name input field not found', 'error');
                return;
            }

            const name = nameInput.value.trim();
            const providedId = idInput ? idInput.value.trim() : '';

            console.log(' Name value:', name);
            console.log(' ID value:', providedId);

            // Validate inputs
            if (!name) {
                showMessage('Please enter a student name', 'warning');
                return;
            }

            if (name.length < 2) {
                showMessage('Student name must be at least 2 characters', 'warning');
                return;
            }

            // Generate or use provided ID
            const studentId = providedId || generateNextStudentId();
            console.log(' Generated/Used ID:', studentId);
            
            // Check for duplicate ID
            const idExists = Object.keys(activeStudents).some(key => {
                const student = activeStudents[key];
                if (typeof student === 'object' && student.id) {
                    return student.id.toLowerCase() === studentId.toLowerCase();
                }
                return false;
            });
            
            if (idExists) {
                showMessage('A student with this ID already exists', 'warning');
                return;
            }

            // Check for duplicate name
            const nameExists = Object.keys(activeStudents).some(key => {
                const student = activeStudents[key];
                const studentName = typeof student === 'string' ? student : student.name;
                return studentName.toLowerCase() === name.toLowerCase();
            });
            
            if (nameExists) {
                showMessage('A student with this name already exists', 'warning');
                return;
            }

            // Generate key from ID
            const key = generateStudentKey(studentId);

            // Add the new student
            activeStudents[key] = { id: studentId, name: name };
            saveActiveStudents();
            populateStudentDropdown();
            updateStudentsList();
            clearStudentInputs();

            showMessage(`Student "${studentId} - ${name}" added successfully!`, 'success');
        }

        function removeStudent(studentKey) {
            if (!activeStudents.hasOwnProperty(studentKey)) {
                showMessage('Student not found', 'error');
                return;
            }

            const student = activeStudents[studentKey];
            const studentName = typeof student === 'string' ? student : (student.name || 'Unknown Student');
            
            // Confirm removal
            if (!confirm(`Are you sure you want to remove "${studentName}" from the student list?\n\nThis will not delete their attendance records, but they will no longer appear in the dropdown for new entries.`)) {
                return;
            }

            // Remove the student
            delete activeStudents[studentKey];
            saveActiveStudents();
            populateStudentDropdown();
            updateStudentsList();

            showMessage(`Student "${studentName}" removed from active list`, 'success');
        }

        function updateStudentsList() {
            const list = elements.studentsList;
            if (!list) return;

            list.innerHTML = '';

            const studentKeys = Object.keys(activeStudents).sort();

            if (studentKeys.length === 0) {
                list.innerHTML = '<div class="no-students-message">No active students. Add students to get started.</div>';
                return;
            }

            studentKeys.forEach(key => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';

                const student = activeStudents[key];
                let displayText;
                
                // Handle both old string format and new object format
                if (typeof student === 'string') {
                    displayText = student; // Legacy format
                } else {
                    displayText = `${student.id} - ${student.name}`;
                }

                studentItem.innerHTML = `
                    <div class="student-info">
                        <div class="student-name">${displayText}</div>
                    </div>
                    <button class="remove-student-btn" onclick="removeStudent('${key}')" title="Remove Student">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                `;

                list.appendChild(studentItem);
            });
        }

        function restoreDefaultStudents() {
            // Restore default students immediately without confirmation
            activeStudents = {...defaultStudentNames};
            saveActiveStudents();
            populateStudentDropdown();
            updateStudentsList();
            showMessage('Default students restored successfully!', 'success');
        }

        // Admin Security Functions
        let pendingAdminAction = null;

        function requestAdminAccess(action) {
            if (isAdminMode) {
                // Already authenticated, execute action directly
                executeAdminAction(action);
                return;
            }

            // Store the pending action and show modal
            pendingAdminAction = action;
            showAdminModal();
        }

        function showAdminModal() {
            const modal = document.getElementById('adminModal');
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('adminError');
            const attemptsDiv = document.getElementById('adminAttempts');
            
            // Reset modal state
            passwordInput.value = '';
            errorDiv.style.display = 'none';
            attemptsDiv.style.display = adminAttempts > 0 ? 'block' : 'none';
            document.getElementById('attemptsCount').textContent = MAX_ATTEMPTS - adminAttempts;
            
            modal.style.display = 'flex';
            setTimeout(() => passwordInput.focus(), 100);
        }

        function closeAdminModal() {
            const modal = document.getElementById('adminModal');
            modal.style.display = 'none';
            pendingAdminAction = null;
        }

        function handleAdminKeyPress(event) {
            if (event.key === 'Enter') {
                validateAdminPassword();
            }
        }

        function validateAdminPassword() {
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('adminError');
            const errorText = document.getElementById('adminErrorText');
            const attemptsDiv = document.getElementById('adminAttempts');
            
            const enteredPassword = passwordInput.value;
            
            if (enteredPassword === getAdminPassword()) {
                // Correct password
                isAdminMode = true;
                adminAttempts = 0;
                closeAdminModal();
                executeAdminAction(pendingAdminAction);
                showMessage('Admin access granted', 'success');
                updateAdminUI();
                
                // Auto-logout after 10 minutes for security
                setTimeout(() => {
                    isAdminMode = false;
                    showMessage('Admin session expired', 'warning');
                    updateAdminUI();
                }, 600000); // 10 minutes
                
            } else {
                // Incorrect password
                adminAttempts++;
                
                if (adminAttempts >= MAX_ATTEMPTS) {
                    // Too many attempts - lock out
                    errorText.textContent = 'Too many failed attempts. Access locked for 5 minutes.';
                    errorDiv.style.display = 'flex';
                    attemptsDiv.style.display = 'none';
                    
                    // Disable the form
                    passwordInput.disabled = true;
                    document.querySelector('.admin-btn-confirm').disabled = true;
                    
                    // Reset attempts after 5 minutes
                    setTimeout(() => {
                        adminAttempts = 0;
                        passwordInput.disabled = false;
                        document.querySelector('.admin-btn-confirm').disabled = false;
                        closeAdminModal();
                    }, 300000); // 5 minutes
                    
                } else {
                    // Show error and remaining attempts
                    errorText.textContent = 'Incorrect password. Please try again.';
                    errorDiv.style.display = 'flex';
                    attemptsDiv.style.display = 'block';
                    document.getElementById('attemptsCount').textContent = MAX_ATTEMPTS - adminAttempts;
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }
        }

        function executeAdminAction(action) {
            switch(action) {
                case 'viewRecords':
                    toggleRecordsView();
                    break;
                case 'clearData':
                    clearAllData();
                    break;
                case 'manageStudents':
                    toggleStudentManagementPanel();
                    break;
                case 'viewSecurityLogs':
                    showSecurityLogsModal();
                    break;
                default:
                    console.error('Unknown admin action:', action);
            }
        }

        function showSecurityLogsModal() {
            const logs = JSON.parse(localStorage.getItem('suspiciousActivity') || '[]');
            
            let modalContent = `
                <div style="max-width: 600px; max-height: 400px; overflow-y: auto;">
                    <h3><i class="fas fa-shield-alt"></i> Security & Fraud Protection Logs</h3>
            `;
            
            if (logs.length === 0) {
                modalContent += `
                    <div style="text-align: center; padding: 20px; color: #27ae60;">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <p><strong>All Clear!</strong></p>
                        <p>No suspicious activity detected.</p>
                    </div>
                `;
            } else {
                modalContent += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                        <strong> ${logs.length} suspicious activities detected</strong>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                `;
                
                logs.slice(-20).reverse().forEach((log, index) => {
                    const date = new Date(log.timestamp).toLocaleString();
                    modalContent += `
                        <div style="margin-bottom: 10px; padding: 10px; border-left: 3px solid #f39c12; background: #fafafa;">
                            <strong>${date}</strong><br>
                            <span style="color: #e74c3c;">${log.reason}</span><br>
                            <small>Submissions: ${log.submissionCount}</small>
                            ${log.location ? `<br><small>Location: ${log.location.lat.toFixed(4)}, ${log.location.lng.toFixed(4)} (${log.location.accuracy.toFixed(1)}m)</small>` : ''}
                        </div>
                    `;
                });
                
                modalContent += `</div>`;
            }
            
            modalContent += `
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="clearSuspiciousActivityLogs()" style="margin-right: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-trash"></i> Clear Logs
                        </button>
                        <button onclick="closeSecurityModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            // Create and show modal
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'securityModal';
            modalOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            const modalBox = document.createElement('div');
            modalBox.style.cssText = `
                background: white; padding: 20px; border-radius: 8px; 
                box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 90%; max-height: 90%;
            `;
            modalBox.innerHTML = modalContent;
            
            modalOverlay.appendChild(modalBox);
            document.body.appendChild(modalOverlay);
        }

        function closeSecurityModal() {
            const modal = document.getElementById('securityModal');
            if (modal) {
                modal.remove();
            }
        }

        function updateAdminUI() {
            const adminButtons = ['viewRecordsBtn', 'clearBtn', 'manageStudentsBtn'];
            
            adminButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    if (isAdminMode) {
                        button.classList.add('admin-mode-active');
                        const lockIcon = button.querySelector('.admin-lock-icon');
                        if (lockIcon) {
                            lockIcon.style.display = 'none';
                        }
                    } else {
                        button.classList.remove('admin-mode-active');
                        const lockIcon = button.querySelector('.admin-lock-icon');
                        if (lockIcon) {
                            lockIcon.style.display = 'inline';
                        }
                    }
                }
            });
        }

        // Secret admin access (double-click on title)
        let secretClickCount = 0;
        function secretAdminAccess() {
            secretClickCount++;
            if (secretClickCount >= 2) {
                if (!isAdminMode) {
                    isAdminMode = true;
                    updateAdminUI();
                    showMessage('Secret admin access activated', 'success');
                    
                    // Auto-logout after 5 minutes for secret access
                    setTimeout(() => {
                        isAdminMode = false;
                        updateAdminUI();
                        showMessage('Secret admin session expired', 'warning');
                    }, 300000); // 5 minutes
                } else {
                    isAdminMode = false;
                    updateAdminUI();
                    showMessage('Admin mode deactivated', 'info');
                }
                secretClickCount = 0;
            }
            
            // Reset click count after 2 seconds
            setTimeout(() => {
                secretClickCount = 0;
            }, 2000);
        }

        function initializeGeolocation() {
            // Check for geolocation support
            if (!navigator.geolocation) {
                updateLocationStatus('Geolocation not supported by this browser', 'error');
                showMessage('Your browser does not support geolocation', 'error');
                return;
            }

            // Check for secure context (HTTPS)
            if (!window.isSecureContext && location.protocol !== 'file:') {
                updateLocationStatus('Geolocation requires HTTPS', 'error');
                showMessage('Geolocation requires a secure connection (HTTPS)', 'warning');
            }

            // Check current permission status
            checkGeolocationPermission();

            // Start location tracking automatically
            startLocationTracking();

            // Set up control event listeners
            setupLocationControls();

            updateLocationStatus('Initializing location services...', 'info');
        }

        async function checkGeolocationPermission() {
            try {
                if ('permissions' in navigator) {
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    locationPermissionStatus = permission.state;
                    
                    elements.locationPermission = document.getElementById('locationPermission');
                    elements.locationPermission.textContent = permission.state.toUpperCase();
                    elements.locationPermission.className = `permission-status ${permission.state}`;

                    // Listen for permission changes
                    permission.addEventListener('change', () => {
                        locationPermissionStatus = permission.state;
                        elements.locationPermission.textContent = permission.state.toUpperCase();
                        elements.locationPermission.className = `permission-status ${permission.state}`;
                        
                        if (permission.state === 'granted') {
                            startLocationTracking();
                        } else if (permission.state === 'denied') {
                            stopLocationTracking();
                            updateLocationStatus('Location permission denied', 'error');
                        }
                    });
                }
            } catch (error) {
                console.error('Error checking permissions:', error);
            }
        }

        function startLocationTracking() {
            updateLocationStatus(' Getting your location...', 'info');
            showMessage('Requesting location access...', 'info');

            // Start with a simple location request to get permission
            const standardOptions = {
                enableHighAccuracy: true,
                timeout: 20000,
                maximumAge: 60000 // Allow 1-minute old location for initial quick loading
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Got basic location successfully
                    handleLocationSuccess(position);
                    
                    // Start continuous tracking if enabled (default to enabled if element not accessible)
                    const continuousToggle = document.getElementById('continuousTrackingToggle');
                    if (!continuousToggle || continuousToggle.checked) {
                        startWatchingPosition();
                    }
                },
                (error) => {
                    console.warn('Standard location failed:', error);
                    handleLocationError(error);
                },
                standardOptions
            );
        }

        function startWatchingPosition() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }

            const options = getLocationOptions();
            
            watchId = navigator.geolocation.watchPosition(
                handleLocationUpdate,
                handleLocationError,
                options
            );

            updateLocationStatus('Monitoring location changes...', 'active');
        }

        function stopLocationTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            updateLocationStatus('Location tracking stopped', 'warning');
        }

        function getLocationOptions() {
            const isHighAccuracy = document.getElementById('highAccuracyToggle')?.checked ?? true;
            
            return {
                enableHighAccuracy: isHighAccuracy,
                timeout: isHighAccuracy ? 60000 : 30000, // Extended timeout for better GPS lock
                maximumAge: 0 // Always get fresh readings for best accuracy
            };
        }

        // Enhanced location acquisition with multiple attempts and averaging
        async function getEnhancedLocation(showProgress = true) {
            const attempts = 3;
            const positions = [];
            
            if (showProgress) {
                updateLocationStatus(' Enhanced accuracy mode - taking multiple readings...', 'info');
                showMessage('Getting enhanced location accuracy (this may take 10-15 seconds)...', 'info');
            }
            
            // First reading - this will trigger permission if needed
            try {
                const firstPosition = await getCurrentPositionPromise({
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 0
                });
                positions.push(firstPosition);
                
                if (showProgress) {
                    showMessage(`Reading 1/${attempts} complete (${firstPosition.coords.accuracy.toFixed(1)}m)`, 'info');
                }
                
            } catch (error) {
                console.warn('First reading failed:', error.message);
                throw error; // If first reading fails, stop here
            }
            
            // Additional readings (only if first succeeded) - these won't trigger permission popups
            for (let i = 1; i < attempts; i++) {
                try {
                    // Wait 3 seconds between readings for GPS to stabilize
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    const position = await getCurrentPositionPromise({
                        enableHighAccuracy: true,
                        timeout: 20000, // Shorter timeout for subsequent readings
                        maximumAge: 0
                    });
                    
                    positions.push(position);
                    
                    if (showProgress) {
                        showMessage(`Reading ${i + 1}/${attempts} complete (${position.coords.accuracy.toFixed(1)}m)`, 'info');
                    }
                    
                } catch (error) {
                    console.warn(`Reading ${i + 1} failed:`, error.message);
                    // Continue with other readings even if one fails
                }
            }
            
            if (positions.length === 0) {
                throw new Error('Failed to get any location readings');
            }
            
            // Use the most accurate reading or average if similar accuracy
            const bestPosition = getBestPositionFromReadings(positions);
            
            if (showProgress) {
                showMessage(` Enhanced location complete! Best accuracy: ${bestPosition.coords.accuracy.toFixed(1)}m (from ${positions.length} readings)`, 'success');
            }
            
            return bestPosition;
        }

        function getBestPositionFromReadings(positions) {
            if (positions.length === 1) return positions[0];
            
            // Find the most accurate reading (lowest accuracy value)
            const mostAccurate = positions.reduce((best, current) => 
                current.coords.accuracy < best.coords.accuracy ? current : best
            );
            
            // If multiple readings have similar accuracy (within 20m), average them
            const similarAccuracy = positions.filter(p => 
                Math.abs(p.coords.accuracy - mostAccurate.coords.accuracy) <= 20
            );
            
            if (similarAccuracy.length > 1) {
                // Average the coordinates for better precision
                const avgLat = similarAccuracy.reduce((sum, p) => sum + p.coords.latitude, 0) / similarAccuracy.length;
                const avgLng = similarAccuracy.reduce((sum, p) => sum + p.coords.longitude, 0) / similarAccuracy.length;
                const avgAccuracy = similarAccuracy.reduce((sum, p) => sum + p.coords.accuracy, 0) / similarAccuracy.length;
                
                // Create averaged position
                return {
                    coords: {
                        latitude: avgLat,
                        longitude: avgLng,
                        accuracy: avgAccuracy,
                        altitude: mostAccurate.coords.altitude,
                        altitudeAccuracy: mostAccurate.coords.altitudeAccuracy,
                        heading: mostAccurate.coords.heading,
                        speed: mostAccurate.coords.speed
                    },
                    timestamp: Date.now()
                };
            }
            
            return mostAccurate;
        }

        function setupLocationControls() {
            // High accuracy toggle
            const highAccuracyToggle = document.getElementById('highAccuracyToggle');
            if (highAccuracyToggle) {
                highAccuracyToggle.addEventListener('change', (e) => {
                    isHighAccuracyEnabled = e.target.checked;
                    if (watchId !== null) {
                        startWatchingPosition(); // Restart with new options
                    }
                    showMessage(`High accuracy ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
                });
            }

            // Continuous tracking toggle
            const continuousToggle = document.getElementById('continuousTrackingToggle');
            if (continuousToggle) {
                continuousToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        startWatchingPosition();
                    } else {
                        stopLocationTracking();
                    }
                });
            }

            // Refresh location button
            const refreshBtn = document.getElementById('refreshLocationBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    // Add visual feedback
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('fa-spin');
                    refreshBtn.disabled = true;
                    
                    refreshLocation();
                    
                    // Remove visual feedback after 3 seconds
                    setTimeout(() => {
                        icon.classList.remove('fa-spin');
                        refreshBtn.disabled = false;
                    }, 3000);
                });
            }

            // Test accuracy button
            const testBtn = document.getElementById('testLocationBtn');
            if (testBtn) {
                testBtn.addEventListener('click', () => {
                    testLocationAccuracy();
                });
            }

            // Improve accuracy button
            const improveBtn = document.getElementById('improveAccuracyBtn');
            if (improveBtn) {
                improveBtn.addEventListener('click', async () => {
                    // Add visual feedback
                    const icon = improveBtn.querySelector('i');
                    icon.classList.add('fa-spin');
                    improveBtn.disabled = true;
                    
                    try {
                        // Show user what enhanced location does
                        if (confirm('Enhanced GPS will take multiple readings over 10-15 seconds for the best possible accuracy. Continue?')) {
                            const position = await getEnhancedLocation(true);
                            handleLocationSuccess(position);
                            showMessage(` GPS improved! New accuracy: ${position.coords.accuracy.toFixed(1)}m`, 'success');
                        }
                    } catch (error) {
                        showMessage('GPS improvement failed, try moving to a better location', 'warning');
                    }
                    
                    // Remove visual feedback
                    icon.classList.remove('fa-spin');
                    improveBtn.disabled = false;
                });
            }

            // Request permission button
            const permissionBtn = document.getElementById('requestPermissionBtn');
            if (permissionBtn) {
                permissionBtn.addEventListener('click', () => {
                    requestLocationPermission();
                });
            }

            // Auto refresh toggle
            const autoRefreshToggle = document.getElementById('autoRefreshToggle');
            if (autoRefreshToggle) {
                autoRefreshToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        startAutoRefresh();
                        showMessage('Auto refresh enabled - location will update every 15 seconds for better accuracy', 'info');
                    } else {
                        stopAutoRefresh();
                        showMessage('Auto refresh disabled', 'info');
                    }
                });
            }
        }

        function refreshLocation() {
            updateLocationStatus(' Refreshing location...', 'info');
            showMessage('Refreshing location data...', 'info');
            
            // Check permission first
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    console.log('Geolocation permission:', result.state);
                    if (result.state === 'denied') {
                        updateLocationStatus('Location permission denied', 'error');
                        showMessage('Please enable location permission in your browser settings', 'error');
                        return;
                    }
                });
            }
            
            // Use standard refresh (fast and user-friendly)
            const options = {
                ...getLocationOptions(),
                maximumAge: 0 // Force fresh location
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('Location success:', position);
                    handleLocationSuccess(position);
                    showMessage('Location refreshed!', 'success');
                },
                (error) => {
                    console.error('Location error:', error);
                    handleLocationError(error);
                },
                options
            );
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            isAutoRefreshEnabled = true;
            autoRefreshInterval = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    refreshLocation();
                }
            }, 15000); // Reduced to 15 seconds for more frequent updates
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            isAutoRefreshEnabled = false;
        }

        async function testLocationAccuracy() {
            updateLocationStatus('Testing location accuracy...', 'info');
            showMessage('Testing location accuracy - please wait up to 60 seconds...', 'info');
            
            const positions = [];
            const testCount = 3;
            
            for (let i = 0; i < testCount; i++) {
                try {
                    showMessage(`Running test ${i + 1}/${testCount} - acquiring GPS fix...`, 'info');
                    const position = await getCurrentPositionPromise({
                        enableHighAccuracy: true,
                        timeout: 20000, // Increased to 20 seconds
                        maximumAge: 0   // Force fresh reading
                    });
                    positions.push(position);
                    showMessage(`Test ${i + 1}/${testCount} completed - accuracy: ${position.coords.accuracy.toFixed(1)}m`, 'success');
                    
                    // Wait 2 seconds between tests for better GPS stabilization
                    if (i < testCount - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                } catch (error) {
                    console.error(`Test ${i + 1} error:`, error);
                    if (error.code === error.TIMEOUT) {
                        showMessage(`Test ${i + 1} timed out - GPS may need more time`, 'warning');
                    } else if (error.code === error.PERMISSION_DENIED) {
                        showMessage(`Test ${i + 1} failed - location permission denied`, 'error');
                        break; // No point continuing if permission denied
                    } else {
                        showMessage(`Test ${i + 1} failed: ${error.message}`, 'warning');
                    }
                }
            }

            if (positions.length > 1) {
                analyzeAccuracyTest(positions);
            } else if (positions.length === 1) {
                showMessage(`Test completed with 1 reading - accuracy: ${positions[0].coords.accuracy.toFixed(1)}m`, 'info');
            } else {
                showMessage('Accuracy test failed - no successful readings. Try moving to an open area.', 'error');
                updateLocationStatus('Test failed - check GPS conditions', 'error');
            }
        }

        function getCurrentPositionPromise(options) {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        function analyzeAccuracyTest(positions) {
            const accuracies = positions.map(p => p.coords.accuracy);
            const avgAccuracy = accuracies.reduce((a, b) => a + b, 0) / accuracies.length;
            const minAccuracy = Math.min(...accuracies);
            const maxAccuracy = Math.max(...accuracies);
            
            const distances = [];
            for (let i = 1; i < positions.length; i++) {
                const dist = calculateDistance(
                    positions[0].coords.latitude,
                    positions[0].coords.longitude,
                    positions[i].coords.latitude,
                    positions[i].coords.longitude
                );
                distances.push(dist);
            }
            
            const maxVariation = distances.length > 0 ? Math.max(...distances) : 0;
            
            // Determine overall quality
            let quality = 'Good';
            let statusClass = 'active';
            if (avgAccuracy <= 10 && maxVariation <= 20) {
                quality = 'Excellent';
                statusClass = 'active';
            } else if (avgAccuracy > 50 || maxVariation > 100) {
                quality = 'Poor';
                statusClass = 'warning';
            } else if (avgAccuracy > 20 || maxVariation > 50) {
                quality = 'Fair';
                statusClass = 'warning';
            }
            
            const resultMessage = 
                ` Accuracy Test Results (${positions.length} readings):\n\n` +
                ` Average accuracy: ${avgAccuracy.toFixed(1)}m\n` +
                ` Best accuracy: ${minAccuracy.toFixed(1)}m\n` +
                ` Worst accuracy: ${maxAccuracy.toFixed(1)}m\n` +
                ` Position variation: ${maxVariation.toFixed(1)}m\n\n` +
                `Overall Quality: ${quality}`;
            
            showMessage(resultMessage, quality === 'Poor' ? 'warning' : 'success');
            updateLocationStatus(`Test complete - ${quality} GPS accuracy`, statusClass);
        }

        function requestLocationPermission() {
            updateLocationStatus('Requesting location permission...', 'info');
            showMessage('Requesting location access - please allow when prompted', 'info');
            
            // Use a clean permission request with minimal options for first request
            const options = {
                enableHighAccuracy: false, // Start with basic location to avoid delays
                timeout: 15000,
                maximumAge: 0 // Always fresh permission request
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    showMessage(' Location permission granted successfully!', 'success');
                    handleLocationSuccess(position);
                    
                    // Start continuous tracking if enabled (default to enabled if element not accessible)
                    const continuousToggle = document.getElementById('continuousTrackingToggle');
                    if (!continuousToggle || continuousToggle.checked) {
                        startWatchingPosition();
                    }
                    
                    // Update button visibility - hide request button once permission is granted
                    const permissionBtn = document.getElementById('requestPermissionBtn');
                    if (permissionBtn) {
                        permissionBtn.style.display = 'none';
                    }
                },
                (error) => {
                    handleLocationError(error);
                    
                    // Provide user-friendly error messages
                    if (error.code === error.PERMISSION_DENIED) {
                        showMessage(' Location access was denied. Click "Request Permission" to try again.', 'warning');
                        updateLocationStatus('Location permission denied - click "Request Permission" to try again', 'error');
                    } else {
                        showMessage('Location request failed. Please try again.', 'error');
                    }
                },
                options
            );
        }

        async function improveLocationAccuracy() {
            const tips = getLocationImprovementTips();
            
            showMessage(' Analyzing your location environment...', 'info');
            
            // Detect environment and provide specific guidance
            const environment = await detectEnvironment();
            
            let improvementMessage = `
 **GPS Accuracy Improvement Guide**

**Current Status:**
 Environment: ${environment.type}
 Accuracy: ${currentPosition ? currentPosition.coords.accuracy.toFixed(1) + 'm' : 'Unknown'}
 Location method: ${currentPosition && currentPosition.coords.accuracy <= 50 ? 'GPS satellites' : 'Network/WiFi positioning'}

**Environment Analysis:**
${environment.description}

**Recommended Actions:**
${environment.tips.slice(0, 3).join('\n')}

**General Improvement Tips:**
${tips.join('\n')}

**Available Options:**
1. Use "Enhanced Location" for multiple GPS readings (10-15 seconds)
2. Move to better location (outdoors for GPS, near windows for indoor)
3. Enable WiFi for indoor positioning
4. Wait longer for GPS satellites to lock

**What affects accuracy:**
 GPS satellites (outdoor): 3-5m accuracy
 WiFi networks (indoor): 10-50m accuracy  
 Cell towers (backup): 100-1000m accuracy
            `;
            
            alert(improvementMessage);
        }

        async function detectEnvironment() {
            // Analyze current location characteristics to suggest improvements
            if (!currentPosition) {
                return {
                    type: "Unknown",
                    description: "No location data available",
                    tips: [" Please allow location access first"]
                };
            }
            
            const accuracy = currentPosition.coords.accuracy;
            const hasAltitude = currentPosition.coords.altitude !== null;
            const hasSpeed = currentPosition.coords.speed !== null;
            
            // Determine environment based on accuracy and available data
            if (accuracy <= 10) {
                return {
                    type: " Outdoor (Excellent GPS)",
                    description: "Strong GPS signal detected",
                    tips: [
                        " You have excellent GPS reception!",
                        " Current accuracy is optimal",
                        " Consider this your reference location"
                    ]
                };
            } else if (accuracy <= 50) {
                return {
                    type: " Outdoor (Good GPS)",
                    description: "Good GPS signal with some interference",
                    tips: [
                        " Move away from tall buildings",
                        " Avoid areas with thick tree cover",
                        " Wait longer for better satellite lock"
                    ]
                };
            } else if (accuracy <= 200) {
                return {
                    type: " Urban/Suburban",
                    description: "Mixed GPS and network positioning",
                    tips: [
                        " Try moving to open areas",
                        " Enable WiFi for better indoor accuracy",
                        " Avoid underground or enclosed areas"
                    ]
                };
            } else if (accuracy <= 1000) {
                return {
                    type: " Indoor (Network-based)",
                    description: "Primarily using WiFi and cell tower positioning",
                    tips: [
                        " Connect to known WiFi networks",
                        " Move closer to windows",
                        " Enable high accuracy mode",
                        " Consider moving outdoors for GPS"
                    ]
                };
            } else {
                return {
                    type: " Deep Indoor/Basement",
                    description: "Limited positioning accuracy",
                    tips: [
                        " Move to upper floors if possible",
                        " Go near windows or entrances",
                        " Enable all location services",
                        " Connect to WiFi networks",
                        " Consider recording attendance outdoors"
                    ]
                };
            }
        }

        function getLocationImprovementTips() {
            return [
                " Turn on WiFi (even if not connected)",
                " Enable 'High Accuracy' location mode",
                " Restart location services if needed",
                " Clear view of sky improves GPS",
                " Hold device steady for 30+ seconds",
                " Close unnecessary apps using location",
                " Ensure location permissions are granted"
            ];
        }

        function handleLocationSuccess(position) {
            currentPosition = position;
            lastKnownPosition = position;
            const { latitude, longitude, accuracy, altitude, speed, heading } = position.coords;
            const timestamp = new Date(position.timestamp);

            // Update form fields
            elements.latitude.value = latitude.toFixed(6);
            elements.longitude.value = longitude.toFixed(6);

            // Update display with comprehensive information
            updateLocationDisplay(position);
            
            // Update status
            const quality = getLocationQuality(accuracy);
            updateLocationStatus(`Location acquired (${quality.label})`, 'active');
            
            // Get address from coordinates (maps link is handled separately)
            getAddressFromCoordinates(latitude, longitude);
        }

        function handleLocationUpdate(position) {
            // Check if this is a significant position change or accuracy improvement
            if (lastKnownPosition) {
                const distance = calculateDistance(
                    lastKnownPosition.coords.latitude,
                    lastKnownPosition.coords.longitude,
                    position.coords.latitude,
                    position.coords.longitude
                );
                
                // Update if moved more than 2 meters OR accuracy improved by 5m OR new reading is much more accurate
                const accuracyImprovement = lastKnownPosition.coords.accuracy - position.coords.accuracy;
                const isMuchMoreAccurate = position.coords.accuracy < lastKnownPosition.coords.accuracy * 0.7;
                
                if (distance < 2 && accuracyImprovement < 5 && !isMuchMoreAccurate) {
                    return; // Skip minor updates
                }
            }

            handleLocationSuccess(position);
            locationUpdateCount++;
            document.getElementById('locationUpdates').textContent = locationUpdateCount;
        }

        function handleLocationError(error) {
            let message, statusClass;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied by user';
                    statusClass = 'error';
                    showMessage('Please enable location access in your browser settings', 'warning');
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable';
                    statusClass = 'warning';
                    showMessage('Unable to determine your location. Check your connection and GPS.', 'warning');
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out';
                    statusClass = 'warning';
                    showMessage('Location request took too long. Trying again...', 'info');
                    // Retry with less strict options
                    setTimeout(() => {
                        const fallbackOptions = {
                            enableHighAccuracy: false,
                            timeout: 15000,
                            maximumAge: 600000 // 10 minutes
                        };
                        navigator.geolocation.getCurrentPosition(
                            handleLocationSuccess,
                            () => showMessage('Location unavailable', 'error'),
                            fallbackOptions
                        );
                    }, 2000);
                    break;
                default:
                    message = `Location error: ${error.message}`;
                    statusClass = 'error';
                    showMessage(`Location Error: ${error.message}`, 'error');
                    break;
            }
            
            updateLocationStatus(message, statusClass);
            
            // Update permission status if needed
            if (error.code === error.PERMISSION_DENIED) {
                const permissionElement = document.getElementById('locationPermission');
                if (permissionElement) {
                    permissionElement.textContent = 'DENIED';
                    permissionElement.className = 'permission-status denied';
                }
            }
        }

        function updateLocationDisplay(position) {
            const { latitude, longitude, accuracy, altitude, speed, heading, altitudeAccuracy } = position.coords;
            const timestamp = new Date(position.timestamp);

            // Update basic coordinates
            elements.displayLatitude.textContent = latitude.toFixed(6);
            elements.displayLongitude.textContent = longitude.toFixed(6);
            elements.locationAccuracy.textContent = Math.round(accuracy);

            // Update accuracy description and icon
            updateAccuracyDisplay(accuracy);

            // Update additional data with enhanced formatting
            const altitudeElement = document.getElementById('locationAltitude');
            const altitudeAccuracyElement = document.getElementById('altitudeAccuracy');
            if (altitudeElement && altitudeAccuracyElement) {
                if (altitude !== null) {
                    altitudeElement.textContent = `${Math.round(altitude)}m`;
                    altitudeAccuracyElement.textContent = altitudeAccuracy ? `(${Math.round(altitudeAccuracy)}m)` : '';
                } else {
                    altitudeElement.textContent = 'Not available';
                    altitudeAccuracyElement.textContent = '';
                }
            }

            const speedElement = document.getElementById('locationSpeed');
            const speedUnitElement = document.getElementById('speedUnit');
            if (speedElement && speedUnitElement) {
                if (speed !== null) {
                    const kmh = (speed * 3.6).toFixed(1);
                    speedElement.textContent = kmh;
                    speedUnitElement.textContent = 'km/h';
                    
                    // Add speed category
                    if (speed > 0.5) { // Moving
                        speedUnitElement.textContent += ' ';
                    }
                } else {
                    speedElement.textContent = 'Not available';
                    speedUnitElement.textContent = '';
                }
            }

            const headingElement = document.getElementById('locationHeading');
            const compassElement = document.getElementById('compassDirection');
            if (headingElement && compassElement) {
                if (heading !== null) {
                    headingElement.textContent = `${Math.round(heading)}`;
                    const direction = getCardinalDirection(heading);
                    compassElement.textContent = `(${direction}) ${getCompassEmoji(heading)}`;
                } else {
                    headingElement.textContent = 'Not available';
                    compassElement.textContent = '';
                }
            }

            const timestampElement = document.getElementById('locationTimestamp');
            const timeAgoElement = document.getElementById('timeAgo');
            if (timestampElement && timeAgoElement) {
                timestampElement.textContent = timestamp.toLocaleTimeString();
                const now = new Date();
                const diffSeconds = Math.floor((now - timestamp) / 1000);
                timeAgoElement.textContent = getTimeAgoText(diffSeconds);
            }

            // Update quality indicator with icon and recommendation
            const qualityElement = document.getElementById('locationQuality');
            const qualityIconElement = document.getElementById('qualityIcon');
            if (qualityElement && qualityIconElement) {
                const quality = getLocationQuality(accuracy);
                qualityElement.textContent = quality.label;
                qualityElement.className = `quality-indicator ${quality.class}`;
                qualityIconElement.innerHTML = getQualityIcon(quality.class);
                
                // Show recommendation
                showLocationRecommendation(quality);
            }

            // Update map links
            updateMapLinks(latitude, longitude);

            // Update full coordinates display
            updateFullCoordinates(position);

            // Update update rate if applicable
            updateLocationRate();
        }

        function updateAccuracyDisplay(accuracy) {
            const accuracyIcon = document.getElementById('accuracyIcon');
            const accuracyDescription = document.getElementById('accuracyDescription');
            
            if (accuracyIcon && accuracyDescription) {
                let icon, description, color, tips = '';
                
                if (accuracy <= 5) {
                    icon = '';
                    description = 'Perfect - Excellent outdoor GPS (Survey grade)';
                    color = 'var(--success-color)';
                    tips = 'Optimal accuracy achieved!';
                } else if (accuracy <= 10) {
                    icon = '';
                    description = 'Excellent - Perfect outdoor GPS signal';
                    color = 'var(--success-color)';
                    tips = 'Great accuracy for all uses';
                } else if (accuracy <= 50) {
                    icon = '';
                    description = 'Very Good - Strong GPS signal';
                    color = 'var(--success-color)';
                    tips = 'Excellent for outdoor tracking';
                } else if (accuracy <= 100) {
                    icon = '';
                    description = 'Good - Reliable GPS/Network positioning';
                    color = 'var(--primary-color)';
                    tips = 'Good for most tracking needs';
                } else if (accuracy <= 200) {
                    icon = '';
                    description = 'Fair - Moderate accuracy (Urban/Suburban)';
                    color = 'var(--primary-color)';
                    tips = 'Try moving to open area for better GPS';
                } else if (accuracy <= 500) {
                    icon = '';
                    description = 'Fair - Network/WiFi positioning (Mixed environment)';
                    color = 'var(--warning-color)';
                    tips = 'Enable WiFi or move outdoors for better accuracy';
                } else if (accuracy <= 1000) {
                    icon = '';
                    description = 'Indoor/Urban - WiFi and cell tower location';
                    color = 'var(--warning-color)';
                    tips = 'Connect to WiFi networks for better indoor accuracy';
                } else if (accuracy <= 2500) {
                    icon = '';
                    description = 'Indoor Mode - WiFi/Network positioning (Perfect for office/home attendance)';
                    color = '#9b59b6';
                    tips = ' Ideal for indoor attendance tracking - Normal accuracy for buildings';
                } else if (accuracy <= 5000) {
                    icon = '';
                    description = 'Deep Indoor - Building positioning (Acceptable for attendance)';
                    color = '#e67e22';
                    tips = 'Good for attendance - Try moving near windows for better signal';
                } else {
                    icon = '';
                    description = 'Very Poor - Limited location services';
                    color = 'var(--error-color)';
                    tips = 'Check location permissions and try moving outdoors';
                }
                
                accuracyIcon.textContent = icon;
                accuracyDescription.textContent = description;
                accuracyDescription.style.color = color;
                
                // Update tooltip with improvement tips
                const accuracyElement = document.getElementById('locationAccuracy');
                if (accuracyElement) {
                    accuracyElement.title = `${accuracy.toFixed(1)}m accuracy - ${tips}`;
                }
                
                // No automatic popups - user can choose to improve GPS manually
            }
        }

        function updateMapLinks(lat, lng) {
            // Update OpenStreetMap link
            const mapLink = document.getElementById('mapLink');
            if (mapLink) {
                mapLink.href = `https://www.openstreetmap.org/#map=18/${lat}/${lng}`;
                mapLink.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }

            // Update Google Maps link
            const googleMapsLink = document.getElementById('googleMapsLink');
            if (googleMapsLink) {
                googleMapsLink.href = `https://www.google.com/maps?q=${lat},${lng}&z=18`;
            }

            // Update Apple Maps link
            const appleMapsLink = document.getElementById('appleMapsLink');
            if (appleMapsLink) {
                appleMapsLink.href = `https://maps.apple.com/?q=${lat},${lng}&z=18`;
            }
        }

        function updateFullCoordinates(position) {
            const fullCoordinatesElement = document.getElementById('fullCoordinates');
            if (fullCoordinatesElement) {
                const { latitude, longitude, accuracy, altitude, speed, heading } = position.coords;
                const timestamp = new Date(position.timestamp);
                
                // Determine location method based on accuracy
                let locationMethod = '';
                if (accuracy <= 50) {
                    locationMethod = ' (GPS)';
                } else if (accuracy <= 200) {
                    locationMethod = ' (GPS/Network)';
                } else if (accuracy <= 1000) {
                    locationMethod = ' (WiFi/Network)';
                } else {
                    locationMethod = ' (Indoor/Network)';
                }
                
                const coordString = 
                    ` Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}` +
                    ` |  Accuracy: ${Math.round(accuracy)}m${locationMethod}` +
                    (altitude !== null ? ` |  Alt: ${Math.round(altitude)}m` : '') +
                    (speed !== null ? ` |  Speed: ${(speed * 3.6).toFixed(1)}km/h` : '') +
                    (heading !== null ? ` |  Heading: ${Math.round(heading)}` : '') +
                    ` |  ${timestamp.toLocaleString()}`;
                
                fullCoordinatesElement.textContent = coordString;
            }
        }

        function updateLocationRate() {
            const updateRateElement = document.getElementById('updateRate');
            if (updateRateElement && locationUpdateCount > 1) {
                const isHighAccuracy = document.getElementById('highAccuracyToggle')?.checked;
                const expectedRate = isHighAccuracy ? '~30s' : '~60s';
                updateRateElement.textContent = `(${expectedRate} interval)`;
            }
        }

        function getTimeAgoText(seconds) {
            if (seconds < 5) return '(just now) ';
            if (seconds < 30) return `(${seconds}s ago) `;
            if (seconds < 60) return `(${seconds}s ago) `;
            if (seconds < 300) return `(${Math.floor(seconds/60)}m ago) `; // 5 minutes
            if (seconds < 3600) return `(${Math.floor(seconds/60)}m ago) `;
            return `(${Math.floor(seconds/3600)}h ago) `;
        }

        function getQualityIcon(qualityClass) {
            const icons = {
                'excellent': '<i class="fas fa-medal" style="color: var(--success-color);"></i>',
                'good': '<i class="fas fa-thumbs-up" style="color: var(--primary-color);"></i>',
                'fair': '<i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>',
                'poor': '<i class="fas fa-times-circle" style="color: var(--error-color);"></i>'
            };
            return icons[qualityClass] || '';
        }

        function getCompassEmoji(heading) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(heading / 45) % 8;
            return directions[index];
        }

        function showLocationRecommendation(quality) {
            const recommendationElement = document.getElementById('locationRecommendation');
            const recommendationText = document.getElementById('recommendationText');
            
            if (recommendationElement && recommendationText) {
                recommendationText.textContent = `${quality.icon} ${quality.recommendation}`;
                recommendationElement.className = `location-recommendation ${quality.class}`;
                recommendationElement.style.display = 'block';
                
                // Auto-hide excellent/good recommendations after 5 seconds
                if (quality.class === 'excellent' || quality.class === 'good') {
                    setTimeout(() => {
                        recommendationElement.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Copy functionality
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage(`Copied: ${text}`, 'success');
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage(`Copied: ${text}`, 'success');
            } catch (error) {
                showMessage('Copy failed - please select and copy manually', 'error');
            }
            textArea.remove();
        }

        function copyFullCoordinates() {
            const fullCoordinatesElement = document.getElementById('fullCoordinates');
            if (fullCoordinatesElement && fullCoordinatesElement.textContent !== '--') {
                copyToClipboard(fullCoordinatesElement.textContent);
            } else {
                showMessage('No coordinates available to copy', 'warning');
            }
        }

        function showPermissionHelp() {
            const helpMessage = 
                ' Location Permission Help:\n\n' +
                ' GRANTED: Location access is allowed\n' +
                ' DENIED: Location access is blocked\n' +
                ' PROMPT: Browser will ask for permission\n\n' +
                'To fix denied permission:\n' +
                '1. Click the lock icon in address bar\n' +
                '2. Set Location to "Allow"\n' +
                '3. Refresh the page\n\n' +
                'For better accuracy:\n' +
                ' Enable GPS on your device\n' +
                ' Move to an open area\n' +
                ' Wait for GPS to stabilize';
            
            showMessage(helpMessage, 'info');
        }

        function updateLocationStatus(message, statusClass) {
            const statusIndicator = document.getElementById('locationStatusIndicator');
            const statusText = document.getElementById('locationStatusText');
            const locationTips = document.getElementById('locationTips');
            
            if (statusIndicator && statusText) {
                statusText.textContent = message;
                statusIndicator.className = `status-indicator ${statusClass}`;
            }

            // Show tips for poor accuracy
            if (locationTips) {
                if (message.includes('Poor') || statusClass === 'warning' || statusClass === 'error') {
                    locationTips.style.display = 'block';
                } else if (statusClass === 'active') {
                    locationTips.style.display = 'none';
                }
            }

            // Also update the header status
            if (elements.locationStatus) {
                elements.locationStatus.textContent = message;
                elements.locationStatus.style.color = getStatusColor(statusClass);
            }
        }

        function getStatusColor(statusClass) {
            const colors = {
                'active': '#27ae60',
                'error': '#e74c3c',
                'warning': '#f39c12',
                'info': '#3498db'
            };
            return colors[statusClass] || '#6c757d';
        }

        function getLocationQuality(accuracy) {
            if (accuracy <= 10) {
                return { 
                    label: 'Excellent', 
                    class: 'excellent',
                    recommendation: 'Perfect outdoor GPS signal!',
                    icon: ''
                };
            } else if (accuracy <= 50) {
                return { 
                    label: 'Very Good', 
                    class: 'excellent',
                    recommendation: 'Strong GPS signal - great accuracy',
                    icon: ''
                };
            } else if (accuracy <= 200) {
                return { 
                    label: 'Good', 
                    class: 'good',
                    recommendation: 'Good accuracy for attendance tracking',
                    icon: ''
                };
            } else if (accuracy <= 1000) {
                return { 
                    label: 'Fair', 
                    class: 'fair',
                    recommendation: 'Network/WiFi location - suitable for indoor use',
                    icon: ''
                };
            } else if (accuracy <= 5000) {
                return { 
                    label: 'Indoor', 
                    class: 'indoor',
                    recommendation: ' Indoor Mode Active - Excellent for office/home attendance tracking',
                    icon: ''
                };
            } else {
                return { 
                    label: 'Poor', 
                    class: 'poor',
                    recommendation: 'No location services - check device settings',
                    icon: ''
                };
            }
        }

        function getCardinalDirection(heading) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 
                              'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(heading / 22.5) % 16;
            return directions[index];
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const 1 = lat1 * Math.PI/180;
            const 2 = lat2 * Math.PI/180;
            const  = (lat2-lat1) * Math.PI/180;
            const  = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(/2) * Math.sin(/2) +
                      Math.cos(1) * Math.cos(2) *
                      Math.sin(/2) * Math.sin(/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        // Address Enhancement Functions
        function refreshAddress() {
            if (!currentPosition) {
                showMessage('No location available to refresh address', 'warning');
                return;
            }
            
            const lat = currentPosition.coords.latitude;
            const lng = currentPosition.coords.longitude;
            
            elements.locationAddress.textContent = 'Refreshing address...';
            showMessage('Refreshing address information...', 'info');
            
            getAddressFromCoordinates(lat, lng);
        }

        async function getAddressFromCoordinates(lat, lng) {
            try {
                // Using a free geocoding service
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
                const data = await response.json();
                
                if (data) {
                    const formattedAddress = formatAddressData(data);
                    
                    // Add accuracy context to address display
                    const accuracy = currentPosition ? currentPosition.coords.accuracy : null;
                    let addressWithContext = formattedAddress;
                    
                    if (accuracy && accuracy > 1000) {
                        addressWithContext += `  (Indoor positioning - ${(accuracy/1000).toFixed(1)}km radius)`;
                    } else if (accuracy && accuracy > 200) {
                        addressWithContext += `  (Network positioning - ${Math.round(accuracy)}m accuracy)`;
                    }
                    
                    elements.locationAddress.textContent = addressWithContext;
                } else {
                    elements.locationAddress.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                }
            } catch (error) {
                console.warn('Geocoding failed:', error);
                elements.locationAddress.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }

        function formatAddressData(data) {
            // Extract and clean address components with priority for detailed location
            const components = {
                street: data.road || data.street || '',
                area: data.suburb || data.neighbourhood || data.quarter || '',
                district: data.city_district || data.district || '',
                city: data.city || data.locality || data.town || data.village || '',
                region: data.principality || data.state || data.region || '',
                country: cleanCountryName(data.countryName || data.country || ''),
                // Add more specific location details
                building: data.building || data.house || '',
                postcode: data.postcode || data.postal_code || '',
                landmark: data.amenity || data.leisure || data.shop || ''
            };

            // Build address parts with priority for specific details
            const addressParts = [];
            
            // Add building/house number if available
            if (components.building) {
                addressParts.push(components.building);
            }
            
            // Add street (high priority for specific location)
            if (components.street) {
                addressParts.push(components.street);
            }
            
            // Add landmark/amenity for more context
            if (components.landmark && components.landmark !== components.street) {
                addressParts.push(components.landmark);
            }
            
            // Add area/neighborhood (important for specific location)
            if (components.area && 
                components.area !== components.street && 
                components.area !== components.landmark) {
                addressParts.push(components.area);
            }
            
            // Add district if it adds value
            if (components.district && 
                components.district !== components.area && 
                components.district !== components.city &&
                !components.area.includes(components.district)) {
                addressParts.push(components.district);
            }
            
            // Add city (always important)
            if (components.city) {
                addressParts.push(components.city);
            }
            
            // Add postcode for more precision
            if (components.postcode) {
                addressParts.push(components.postcode);
            }
            
            // Add region only if it's different from city and adds value
            if (components.region && 
                components.region !== components.city && 
                !components.city.includes(components.region) &&
                components.region.length < 20) { // Avoid very long region names
                addressParts.push(components.region);
            }
            
            // Add country (but only if we have other details, otherwise show more info)
            if (addressParts.length > 0 && components.country) {
                addressParts.push(components.country);
            }
            
            // Join with commas and clean up
            let formattedAddress = addressParts.join(', ');
            
            // Remove duplicates and clean up
            formattedAddress = removeDuplicateWords(formattedAddress);
            
            // If we don't have enough specific details, try to get more from display_name
            if (!formattedAddress || formattedAddress.length < 10 || addressParts.length < 2) {
                if (data.display_name) {
                    // Use display name but clean it and prioritize first 3-4 meaningful parts
                    const cleaned = cleanDisplayName(data.display_name);
                    if (cleaned.length > formattedAddress.length) {
                        formattedAddress = cleaned;
                    }
                }
                
                // Final fallback - but try to be more specific than just city, country
                if (!formattedAddress || formattedAddress.length < 5) {
                    if (components.city && components.country) {
                        formattedAddress = `${components.city}, ${components.country}`;
                    } else {
                        return 'Location detected';
                    }
                }
            }
            
            return formattedAddress;
        }

        function cleanCountryName(country) {
            if (!country) return '';
            
            // Remove unnecessary suffixes and clean up country names
            return country
                .replace(/\s*\(the\)\s*/gi, '') // Remove "(the)"
                .replace(/\s*\(.*?\)\s*/g, '')   // Remove any other parenthetical content
                .replace(/^the\s+/gi, '')        // Remove "the" at the beginning
                .trim();
        }

        function cleanDisplayName(displayName) {
            if (!displayName) return '';
            
            // Clean up the display name by removing unnecessary elements
            let cleaned = displayName
                .replace(/\s*\(the\)\s*/gi, '') // Remove "(the)"
                .replace(/\s*\(.*?\)\s*/g, '')   // Remove parenthetical content
                .replace(/^the\s+/gi, '');       // Remove "the" at the beginning
            
            // Split by comma and take meaningful parts
            const parts = cleaned.split(',').map(part => part.trim()).filter(part => part.length > 0);
            
            // Prioritize more specific location parts (first 2-3 parts usually most specific)
            let relevantParts = [];
            
            // Take first part (usually most specific - street/building)
            if (parts.length > 0 && parts[0].length > 2) {
                relevantParts.push(parts[0]);
            }
            
            // Take second part if it's different and adds specificity
            if (parts.length > 1 && parts[1].length > 2 && 
                !parts[0].toLowerCase().includes(parts[1].toLowerCase())) {
                relevantParts.push(parts[1]);
            }
            
            // Take third part if it's a neighborhood/area (not too generic)
            if (parts.length > 2 && parts[2].length > 2 && parts[2].length < 30 &&
                !parts[2].toLowerCase().includes('emirate') && 
                !parts[2].toLowerCase().includes('country') &&
                !relevantParts.some(part => part.toLowerCase().includes(parts[2].toLowerCase()))) {
                relevantParts.push(parts[2]);
            }
            
            // Add city if we don't have enough specificity
            if (relevantParts.length < 2 && parts.length > 3) {
                const cityPart = parts.find(part => 
                    part.toLowerCase().includes('sharjah') || 
                    part.toLowerCase().includes('dubai') ||
                    part.toLowerCase().includes('abu dhabi') ||
                    (part.length > 3 && part.length < 20)
                );
                if (cityPart && !relevantParts.includes(cityPart)) {
                    relevantParts.push(cityPart);
                }
            }
            
            // Ensure we have at least 2 parts for specificity, but not more than 4
            if (relevantParts.length < 2 && parts.length > relevantParts.length) {
                relevantParts = parts.slice(0, Math.min(3, parts.length));
            }
            relevantParts = relevantParts.slice(0, 4);
            
            return relevantParts.join(', ');
        }

        function removeDuplicateWords(address) {
            const parts = address.split(',').map(part => part.trim());
            const uniqueParts = [];
            const seen = new Set();
            
            for (const part of parts) {
                // Normalize for comparison (lowercase, no extra spaces)
                const normalized = part.toLowerCase().replace(/\s+/g, ' ');
                if (!seen.has(normalized) && part.length > 0) {
                    seen.add(normalized);
                    uniqueParts.push(part);
                }
            }
            
            return uniqueParts.join(', ');
        }

        function updateCurrentTime() {
            const now = new Date();
            elements.currentDate.textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            elements.currentTime.textContent = now.toLocaleTimeString('en-US', {
                hour12: true,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function updateLocationTimestamps() {
            if (currentPosition && currentPosition.timestamp) {
                const timeAgoElement = document.getElementById('timeAgo');
                if (timeAgoElement) {
                    const now = new Date();
                    const locationTime = new Date(currentPosition.timestamp);
                    const diffSeconds = Math.floor((now - locationTime) / 1000);
                    timeAgoElement.textContent = getTimeAgoText(diffSeconds);
                    
                    // Change color based on age
                    if (diffSeconds > 300) { // 5 minutes
                        timeAgoElement.style.color = 'var(--error-color)';
                    } else if (diffSeconds > 120) { // 2 minutes
                        timeAgoElement.style.color = 'var(--warning-color)';
                    } else {
                        timeAgoElement.style.color = 'var(--success-color)';
                    }
                }
            }
        }

        function updateDateTime() {
            const now = new Date();
            const isoString = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString();
            elements.dateTime.value = isoString.slice(0, 16);
        }

        function updateNotesCounter() {
            const maxLength = 500;
            const currentLength = this.value.length;
            const remaining = maxLength - currentLength;
            
            // Find or create counter element
            let counter = document.getElementById('notes-counter');
            if (!counter) {
                counter = document.createElement('small');
                counter.id = 'notes-counter';
                counter.className = 'form-help notes-counter';
                counter.style.cssText = 'float: right; margin-top: 2px;';
                
                const helpElement = document.getElementById('notes-help');
                if (helpElement) {
                    helpElement.parentNode.insertBefore(counter, helpElement.nextSibling);
                }
            }
            
            counter.textContent = `${currentLength}/${maxLength} characters`;
            
            // Color code based on remaining characters
            if (remaining < 50) {
                counter.style.color = '#e74c3c'; // Red
            } else if (remaining < 100) {
                counter.style.color = '#f39c12'; // Orange  
            } else {
                counter.style.color = 'var(--text-secondary)'; // Normal
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            // Show loading first
            showLoading(true);
            
            // Add timeout to force reset loading state after 10 seconds max
            const timeoutId = setTimeout(() => {
                showLoading(false);
                showMessage(' Request timed out - attendance saved locally', 'warning');
            }, 10000);
            
            try {
                // Validate form
                if (!validateForm()) {
                    clearTimeout(timeoutId);
                    showLoading(false);
                    return;
                }
                
                // Create attendance record
                const record = createAttendanceRecord();
                
                // Add to data array immediately
                attendanceData.unshift(record);
                
                // Show success immediately and reset form
                const studentInfo = activeStudents[record.student];
                let successMessage;
                if (typeof studentInfo === 'object') {
                    successMessage = ` Attendance recorded for ${studentInfo.id} - ${studentInfo.name}!`;
                } else {
                    successMessage = ` Attendance recorded for ${record.studentName}!`;
                }
                
                showMessage(successMessage, 'success');
                resetForm();
                
                // Clear loading immediately after success
                clearTimeout(timeoutId);
                showLoading(false);
                
                // Save to localStorage for persistence
                let localData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                localData.unshift(record);
                localStorage.setItem('attendanceData', JSON.stringify(localData));
                
                // Update displays if records are visible
                if (elements.recordsSection.style.display !== 'none') {
                    displayRecords();
                    updateStatistics();
                }
                
            } catch (error) {
                clearTimeout(timeoutId);
                showLoading(false);
                showMessage(` Error: ${error.message}`, 'error');
            } finally {
                // Double safety - ensure loading is always cleared
                showLoading(false);
            }
        }

        function updateSubmissionTracking() {
            const now = Date.now();
            
            // Update tracking variables
            lastSubmissionTime = now;
            lastSubmittedStudent = elements.student.value;
            submissionCount++;
            hourlySubmissions.push(now);
            
            // Clean old submissions
            hourlySubmissions = hourlySubmissions.filter(time => now - time < 3600000);
            
            // Save fraud protection data to persist across page reloads
            saveFraudProtectionData();
            
            // Immediately update the UI to show new status
            cachedStatus = ''; // Clear cache to force refresh
            updateFraudProtectionUI();
        }

        function validateForm() {
            const student = elements.student.value;
            const attendanceStatus = elements.attendanceStatus.value;
            
            if (!student) {
                showMessage('Please select a student', 'warning');
                elements.student.focus();
                return false;
            }
            
            if (!attendanceStatus) {
                showMessage('Please select Present or Absent', 'warning');
                return false;
            }
            
            if (!currentPosition) {
                showMessage('Location not available. Please wait for location to be acquired.', 'warning');
                return false;
            }
            
            return true;
        }

        function createAttendanceRecord() {
            // Use the selected date/time from the input field, or current time as fallback
            let selectedDateTime;
            if (elements.dateTime.value && elements.dateTime.value.trim() !== '') {
                selectedDateTime = new Date(elements.dateTime.value);
                // Check if the date is valid
                if (isNaN(selectedDateTime.getTime())) {
                    selectedDateTime = new Date(); // Fallback to current time
                }
            } else {
                selectedDateTime = new Date(); // Fallback to current time
            }
            
            const coords = currentPosition.coords;
            
            // Get student information from activeStudents
            const selectedStudentKey = elements.student.value;
            const studentInfo = activeStudents[selectedStudentKey];
            
            let studentId, studentName;
            if (typeof studentInfo === 'string') {
                // Legacy format - use key as ID and string as name
                studentId = selectedStudentKey;
                studentName = studentInfo;
            } else {
                // New format with ID and name
                studentId = studentInfo.id;
                studentName = studentInfo.name;
            }
            
            return {
                id: generateId(),
                student: selectedStudentKey,
                studentId: studentId,
                studentName: studentName,
                attendanceStatus: elements.attendanceStatus.value,
                attendanceLabel: elements.attendanceStatus.value === 'present' ? 'Present' : 'Absent',
                dateTime: elements.dateTime.value,
                date: selectedDateTime.toLocaleDateString('en-US'),
                time: selectedDateTime.toLocaleTimeString('en-US', { hour12: true }),
                latitude: parseFloat(elements.latitude.value),
                longitude: parseFloat(elements.longitude.value),
                accuracy: coords.accuracy,
                altitude: coords.altitude,
                altitudeAccuracy: coords.altitudeAccuracy,
                speed: coords.speed,
                heading: coords.heading,
                locationQuality: getLocationQuality(coords.accuracy).label,
                address: elements.locationAddress.textContent,
                notes: elements.notes.value.trim(),
                timestamp: selectedDateTime.getTime(),
                locationTimestamp: currentPosition.timestamp,
                isHighAccuracy: document.getElementById('highAccuracyToggle')?.checked || false,
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language
                }
            };
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function resetForm() {
            elements.student.value = '';
            elements.attendanceStatus.value = '';
            elements.notes.value = '';
            elements.presentBtn.classList.remove('selected');
            elements.absentBtn.classList.remove('selected');
            
            selectedAttendanceStatus = null;
            elements.student.focus();
        }

        function toggleRecordsView() {
            const isVisible = elements.recordsSection.style.display !== 'none';
            
            if (isVisible) {
                elements.recordsSection.style.display = 'none';
                elements.viewRecordsBtn.innerHTML = '<i class="fas fa-eye"></i> View Records';
            } else {
                elements.recordsSection.style.display = 'block';
                elements.viewRecordsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Records';
                displayRecords();
                updateStatistics();
            }
        }

        function populateFilterDropdowns() {
            // Clear existing options
            elements.filterEmployee.innerHTML = '<option value="">All Students</option>';
            
            // Get unique students from attendance data or use active students
            let studentsToShow = new Map();
            
            // First, add students from attendance data
            attendanceData.forEach(record => {
                const studentKey = record.student || record.employee;
                if (studentKey && !studentsToShow.has(studentKey)) {
                    const studentInfo = activeStudents[studentKey];
                    let displayName = studentKey; // fallback
                    
                    if (typeof studentInfo === 'string') {
                        displayName = studentInfo;
                    } else if (studentInfo && studentInfo.name) {
                        displayName = studentInfo.name;
                    } else if (record.studentName) {
                        displayName = record.studentName;
                    }
                    
                    studentsToShow.set(studentKey, displayName);
                }
            });
            
            // If no attendance data, use all active students
            if (studentsToShow.size === 0) {
                Object.keys(activeStudents).forEach(studentKey => {
                    const student = activeStudents[studentKey];
                    const displayName = typeof student === 'string' ? student : (student.name || studentKey);
                    studentsToShow.set(studentKey, displayName);
                });
            }
            
            // Sort by display name and add to dropdown
            Array.from(studentsToShow.entries())
                .sort((a, b) => a[1].localeCompare(b[1]))
                .forEach(([studentKey, displayName]) => {
                    const option = document.createElement('option');
                    option.value = studentKey;
                    option.textContent = displayName;
                    elements.filterEmployee.appendChild(option);
                });
        }

        function applyFilters() {
            console.log('Apply Filters clicked');
            console.log('Filter values:', {
                date: elements.filterDate.value,
                student: elements.filterEmployee.value,
                status: elements.filterAction.value
            });
            
            const beforeCount = attendanceData.length;
            displayRecords();
            const afterCount = getFilteredRecords().length;
            
            // Show filter feedback
            if (beforeCount !== afterCount) {
                showMessage(` Filtered: Showing ${afterCount} of ${beforeCount} records`, 'info');
            } else if (beforeCount === 0) {
                showMessage(' No records to filter', 'warning');
            } else {
                showMessage(` Showing all ${beforeCount} records`, 'info');
            }
        }
        
        function clearFilters() {
            console.log('Clear Filters clicked');
            
            // Reset all filter inputs
            elements.filterDate.value = '';
            elements.filterEmployee.value = '';
            elements.filterAction.value = '';
            
            // Refresh the display
            displayRecords();
            showMessage(' Filters cleared - showing all records', 'info');
        }

        function getFilteredRecords() {
            let filtered = [...attendanceData];
            console.log('Starting with', filtered.length, 'records');
            
            // Filter by date
            if (elements.filterDate.value) {
                const filterDate = new Date(elements.filterDate.value).toLocaleDateString('en-US');
                console.log('Filtering by date:', filterDate);
                filtered = filtered.filter(record => {
                    console.log('Record date:', record.date, 'vs filter:', filterDate);
                    return record.date === filterDate;
                });
                console.log('After date filter:', filtered.length, 'records');
            }
            
            // Filter by student
            if (elements.filterEmployee.value) {
                const selectedStudent = elements.filterEmployee.value;
                console.log('Filtering by student:', selectedStudent);
                filtered = filtered.filter(record => {
                    // Check multiple student fields for better compatibility
                    const matches = (record.student === selectedStudent) || 
                                  (record.studentId === selectedStudent) ||
                                  (record.employee === selectedStudent);
                    console.log('Record student fields:', {
                        student: record.student,
                        studentId: record.studentId,
                        employee: record.employee,
                        matches: matches
                    });
                    return matches;
                });
                console.log('After student filter:', filtered.length, 'records');
            }
            
            // Filter by status - improved logic
            if (elements.filterAction.value) {
                const filterValue = elements.filterAction.value.toLowerCase();
                console.log('Filtering by status:', filterValue);
                filtered = filtered.filter(record => {
                    // Check multiple status fields with flexible matching
                    const status = (record.attendanceStatus || record.attendanceLabel || record.actionType || '').toLowerCase();
                    const matches = status.includes(filterValue) || 
                                  (filterValue === 'present' && (status === 'p' || status === '1' || status.includes('check-in'))) ||
                                  (filterValue === 'absent' && (status === 'a' || status === '0'));
                    console.log('Record status:', status, 'vs filter:', filterValue, 'matches:', matches);
                    return matches;
                });
                console.log('After status filter:', filtered.length, 'records');
            }
            
            console.log('Final filtered records:', filtered.length);
            return filtered;
        }

        function displayRecords() {
            const filteredRecords = getFilteredRecords();
            elements.recordsTableBody.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                elements.recordsTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
                            No records found
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredRecords.forEach((record, index) => {
                const row = createRecordRow(record, index);
                elements.recordsTableBody.appendChild(row);
            });
            
            // Update filter dropdowns
            populateFilterDropdowns();
        }

        function createRecordRow(record, index) {
            const row = document.createElement('tr');
            
            // Handle both new attendance status and legacy action type for backward compatibility
            let statusInfo;
            if (record.attendanceStatus) {
                // New attendance system
                statusInfo = {
                    label: record.attendanceLabel || (record.attendanceStatus === 'present' ? 'Present' : 'Absent'),
                    icon: record.attendanceStatus === 'present' ? 'fas fa-check-circle' : 'fas fa-times-circle',
                    color: record.attendanceStatus === 'present' ? '#27ae60' : '#e74c3c'
                };
            } else if (record.actionType && actionTypeMapping[record.actionType]) {
                // Legacy action type system
                statusInfo = actionTypeMapping[record.actionType];
            } else {
                // Fallback
                statusInfo = { label: 'Unknown', icon: 'fas fa-question', color: '#95a5a6' };
            }
            
            // Get student display name (check both new and legacy field names for backward compatibility)
            let studentDisplay;
            if (record.studentId && record.studentName) {
                // New format with ID and name
                studentDisplay = `${record.studentId} - ${record.studentName}`;
            } else if (record.studentName || record.employeeName) {
                // Has name but no ID
                studentDisplay = record.studentName || record.employeeName;
            } else {
                // Legacy format - lookup from activeStudents
                const studentInfo = activeStudents[record.student || record.employee];
                if (typeof studentInfo === 'object') {
                    studentDisplay = `${studentInfo.id} - ${studentInfo.name}`;
                } else {
                    studentDisplay = studentInfo || record.student || record.employee || 'Unknown Student';
                }
            }
            
            // Format location data
            const locationText = `${record.latitude.toFixed(4)}, ${record.longitude.toFixed(4)}`;
            const qualityBadge = record.locationQuality ? 
                `<span class="quality-indicator ${record.locationQuality.toLowerCase()}">${record.locationQuality}</span>` : '';
            const accuracyText = `${Math.round(record.accuracy)}m`;
            const altitudeText = record.altitude ? `${Math.round(record.altitude)}m` : 'N/A';
            const speedText = record.speed ? `${(record.speed * 3.6).toFixed(1)} km/h` : 'N/A';
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><strong>${studentDisplay}</strong></td>
                <td>
                    <span class="status-badge ${record.attendanceStatus || record.actionType}" style="background-color: ${statusInfo.color};">
                        <i class="${statusInfo.icon}"></i> ${statusInfo.label}
                    </span>
                </td>
                <td>${record.date}</td>
                <td>${record.time}</td>
                <td>
                    <div style="font-size: 0.85rem;">
                        <div><strong>${locationText}</strong></div>
                        <div style="color: #6c757d;">
                            ${accuracyText} ${qualityBadge}
                        </div>
                        <div style="color: #6c757d; font-size: 0.8rem;">
                            Alt: ${altitudeText} | Speed: ${speedText}
                        </div>
                        <div style="color: #6c757d; font-size: 0.8rem; margin-top: 3px;">
                            <em>${record.address}</em>
                        </div>
                        <div style="margin-top: 5px;">
                            <a href="https://www.openstreetmap.org/#map=18/${record.latitude}/${record.longitude}" 
                               target="_blank" style="color: #3498db; font-size: 0.8rem;">
                                <i class="fas fa-map-marker-alt"></i> View on Map
                            </a>
                        </div>
                    </div>
                </td>
                <td>${record.notes || '-'}</td>
                <td>
                    <button class="table-action-btn" onclick="deleteRecord('${record.id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;
            
            return row;
        }

        function deleteRecord(recordId) {
            if (confirm('Are you sure you want to delete this record?')) {
                deleteRecordFromStorage(recordId);
            }
        }

        function updateStatistics() {
            const today = new Date();
            const todayFormatted = today.toLocaleDateString('en-US');
            console.log('Today formatted:', todayFormatted);
            console.log('Total attendance records:', attendanceData.length);
            
            // Debug: Show all records and their dates
            if (attendanceData.length > 0) {
                console.log('Sample record dates:', attendanceData.slice(0, 3).map(r => r.date));
            }
            
            const todayRecords = attendanceData.filter(record => {
                console.log('Comparing record date:', record.date, 'with today:', todayFormatted);
                return record.date === todayFormatted;
            });
            
            console.log('Today records found:', todayRecords.length);
            
            const stats = {
                totalToday: todayRecords.length,
                present: todayRecords.filter(r => {
                    const status = (r.attendanceStatus || '').toLowerCase();
                    const label = (r.attendanceLabel || '').toLowerCase();
                    return status === 'present' || label === 'present' || r.actionType === 'check-in';
                }).length,
                absent: todayRecords.filter(r => {
                    const status = (r.attendanceStatus || '').toLowerCase();
                    const label = (r.attendanceLabel || '').toLowerCase();
                    return status === 'absent' || label === 'absent';
                }).length,
                uniqueStudents: Object.keys(activeStudents).length // Use active students count
            };
            
            console.log('Calculated stats:', stats);
            
            elements.statsGrid.innerHTML = `
                <div class="stat-card blue">
                    <div class="stat-number">${stats.totalToday}</div>
                    <div class="stat-label">Total Records Today</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number">${stats.present}</div>
                    <div class="stat-label">Present</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number">${stats.absent}</div>
                    <div class="stat-label">Absent</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-number">${stats.uniqueStudents}</div>
                    <div class="stat-label">Active Students</div>
                </div>
            `;
        }

        function showStatistics() {
            if (elements.recordsSection.style.display === 'none') {
                toggleRecordsView();
            }
            
            // Scroll to statistics section
            document.getElementById('statisticsSection').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        function downloadExcel() {
            try {
                console.log('Download Excel clicked. Current attendanceData length:', attendanceData.length);
                console.log('First 3 records:', attendanceData.slice(0, 3));
                
                if (attendanceData.length === 0) {
                    showMessage('No data to export. Please submit some attendance records first.', 'warning');
                    return;
                }
                
                showLoading(true);
                
                // Prepare data for Excel with backward compatibility
                const excelData = attendanceData.map((record, index) => {
                    // Get student ID and name for display
                    let studentId = 'N/A';
                    let studentName = 'Unknown Student';
                    
                    if (record.studentId && record.studentName) {
                        // New format
                        studentId = record.studentId;
                        studentName = record.studentName;
                    } else if (record.studentName || record.employeeName) {
                        // Has name but no ID
                        studentName = record.studentName || record.employeeName;
                    } else {
                        // Legacy format - lookup from activeStudents
                        const studentInfo = activeStudents[record.student || record.employee];
                        if (typeof studentInfo === 'object') {
                            studentId = studentInfo.id;
                            studentName = studentInfo.name;
                        } else {
                            studentName = studentInfo || record.student || record.employee || 'Unknown Student';
                        }
                    }
                    
                    // Get action/attendance status
                    let actionStatus = 'N/A';
                    if (record.attendanceLabel) {
                        actionStatus = record.attendanceLabel;
                    } else if (record.attendanceStatus) {
                        actionStatus = record.attendanceStatus === 'present' ? 'Present' : 'Absent';
                    } else if (record.actionLabel) {
                        actionStatus = record.actionLabel;
                    } else if (record.actionType) {
                        // Legacy format mapping
                        const actionTypeMapping = {
                            'check-in': 'Present',
                            'check-out': 'Absent',
                            'break': 'Break',
                            'lunch': 'Lunch',
                            'meeting': 'Meeting',
                            'sick-leave': 'Sick Leave',
                            'vacation': 'Vacation'
                        };
                        actionStatus = actionTypeMapping[record.actionType] || record.actionType;
                    }
                    
                    return {
                        'No.': index + 1,
                        'Student ID': studentId,
                        'Student Name': studentName,
                        'Action': actionStatus,
                        'Date': record.date,
                        'Time': record.time,
                        'Latitude': record.latitude,
                        'Longitude': record.longitude,
                        'Address': record.address
                    };
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Auto-resize columns
                const colWidths = [
                    {wch: 5},   // No.
                    {wch: 12},  // Student ID
                    {wch: 25},  // Student Name
                    {wch: 15},  // Action
                    {wch: 12},  // Date
                    {wch: 12},  // Time
                    {wch: 12},  // Latitude
                    {wch: 12},  // Longitude
                    {wch: 40}   // Address
                ];
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Student Attendance Records');
                
                // Generate filename with current date
                const now = new Date();
                const filename = `student_attendance_records_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, filename);
                
                showMessage(`Excel file downloaded: ${filename}`, 'success');
                
            } catch (error) {
                showMessage(`Error creating Excel file: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function exportFilteredRecordsToPdf() {
            try {
                // Get filtered records based on current filter settings
                const filteredRecords = getFilteredRecords();
                
                if (filteredRecords.length === 0) {
                    showMessage('No records to export. Please adjust your filters or add some attendance records.', 'warning');
                    return;
                }
                
                showLoading(true);
                
                // Create new PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title and header information
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text(' Attendance Records Report', 14, 22);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 32);
                doc.text(`Total Records: ${filteredRecords.length}`, 14, 40);
                
                // Get current filter values for display
                const filterDate = elements.filterDate.value;
                const filterStudent = elements.filterEmployee.value;
                const filterStatus = elements.filterAction.value;
                
                let filterInfo = 'Filters Applied: ';
                if (filterDate) filterInfo += `Date: ${filterDate} `;
                if (filterStudent) {
                    const studentInfo = activeStudents[filterStudent];
                    const studentName = typeof studentInfo === 'string' ? studentInfo : (studentInfo?.name || filterStudent);
                    filterInfo += `Student: ${studentName} `;
                }
                if (filterStatus) filterInfo += `Status: ${filterStatus} `;
                if (!filterDate && !filterStudent && !filterStatus) filterInfo += 'None (All Records)';
                
                doc.setFontSize(10);
                doc.text(filterInfo, 14, 48);
                
                // Prepare table data
                const tableData = filteredRecords.map((record, index) => {
                    // Get student name
                    let studentName = 'Unknown Student';
                    if (record.studentName) {
                        studentName = record.studentName;
                    } else if (record.student && activeStudents[record.student]) {
                        const studentInfo = activeStudents[record.student];
                        studentName = typeof studentInfo === 'string' ? studentInfo : (studentInfo.name || record.student);
                    }
                    
                    // Get status with emoji
                    const status = record.attendanceStatus || record.attendanceLabel || 'Unknown';
                    const statusDisplay = status.toLowerCase().includes('present') ? ' Present' : 
                                        status.toLowerCase().includes('absent') ? ' Absent' : status;
                    
                    // Format address (short version for table)
                    const address = record.address ? 
                        (record.address.length > 30 ? record.address.substring(0, 30) + '...' : record.address) : 
                        'N/A';
                    
                    return [
                        index + 1,
                        studentName,
                        statusDisplay,
                        record.date || 'N/A',
                        record.time || 'N/A',
                        address
                    ];
                });
                
                // Table headers
                const headers = [['#', 'Student Name', 'Status', 'Date', 'Time', 'Location']];
                
                // Add table to PDF
                doc.autoTable({
                    head: headers,
                    body: tableData,
                    startY: 55,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [52, 73, 94],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 10 },  // #
                        1: { cellWidth: 45 },                    // Student Name
                        2: { halign: 'center', cellWidth: 25 },  // Status
                        3: { halign: 'center', cellWidth: 25 },  // Date
                        4: { halign: 'center', cellWidth: 25 },  // Time
                        5: { cellWidth: 50 }                     // Location
                    },
                    styles: {
                        fontSize: 9,
                        cellPadding: 3
                    },
                    margin: { top: 55, left: 14, right: 14 }
                });
                
                // Add summary at the bottom
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Calculate statistics
                const presentCount = filteredRecords.filter(r => {
                    const status = (r.attendanceStatus || r.attendanceLabel || '').toLowerCase();
                    return status.includes('present');
                }).length;
                
                const absentCount = filteredRecords.filter(r => {
                    const status = (r.attendanceStatus || r.attendanceLabel || '').toLowerCase();
                    return status.includes('absent');
                }).length;
                
                const attendanceRate = filteredRecords.length > 0 ? 
                    Math.round((presentCount / filteredRecords.length) * 100) : 0;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(' Summary Statistics:', 14, finalY);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(` Present: ${presentCount} records`, 14, finalY + 10);
                doc.text(` Absent: ${absentCount} records`, 14, finalY + 18);
                doc.text(` Attendance Rate: ${attendanceRate}%`, 14, finalY + 26);
                
                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                    doc.text('Generated by Attendance Tracker v3.0', 14, doc.internal.pageSize.height - 10);
                }
                
                // Generate filename
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
                const timeStr = `${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}`;
                
                let filename = `attendance_report_${dateStr}_${timeStr}`;
                if (filterStudent) {
                    const studentInfo = activeStudents[filterStudent];
                    const studentName = typeof studentInfo === 'string' ? studentInfo : (studentInfo?.name || filterStudent);
                    filename += `_${studentName.replace(/\s+/g, '_')}`;
                }
                filename += '.pdf';
                
                // Save the PDF
                doc.save(filename);
                
                showMessage(` PDF exported successfully: ${filename}\n ${filteredRecords.length} records exported\n ${attendanceRate}% attendance rate`, 'success');
                
            } catch (error) {
                console.error('PDF Export Error:', error);
                showMessage(`Error creating PDF: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function sendEmailReport() {
            try {
                const emailAddress = elements.reportEmail.value.trim();
                
                if (!emailAddress) {
                    showMessage('Please enter an email address', 'warning');
                    elements.reportEmail.focus();
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(emailAddress)) {
                    showMessage('Please enter a valid email address', 'warning');
                    elements.reportEmail.focus();
                    return;
                }
                
                if (attendanceData.length === 0) {
                    showMessage('No attendance data to include in the report', 'warning');
                    return;
                }
                
                showLoading(true);
                
                // Generate comprehensive analytics
                const analytics = generateAttendanceAnalytics();
                
                // Create professional email subject and body
                const reportDate = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const emailSubject = ` Attendance Analytics Report - ${reportDate}`;
                
                let emailBody = ` ATTENDANCE TRACKING SYSTEM - ANALYTICS REPORT\n`;
                emailBody += `${'='.repeat(55)}\n\n`;
                
                emailBody += ` Report Generated: ${new Date().toLocaleString()}\n`;
                emailBody += ` Analysis Period: ${analytics.dateRange}\n`;
                emailBody += `  Last Updated: ${analytics.lastRecordTime}\n\n`;
                
                // KEY METRICS
                emailBody += ` KEY PERFORMANCE INDICATORS\n`;
                emailBody += `${'-'.repeat(35)}\n`;
                emailBody += ` Total Students Tracked: ${analytics.totalStudents}\n`;
                emailBody += ` Total Records: ${analytics.totalRecords}\n`;
                emailBody += ` Present Records: ${analytics.presentCount} (${analytics.presentPercentage}%)\n`;
                emailBody += ` Absent Records: ${analytics.absentCount} (${analytics.absentPercentage}%)\n`;
                emailBody += ` Attendance Rate: ${analytics.attendanceRate}%\n\n`;
                
                // TODAY'S SUMMARY
                emailBody += `  TODAY'S SUMMARY\n`;
                emailBody += `${'-'.repeat(20)}\n`;
                emailBody += ` Records Today: ${analytics.todayRecords}\n`;
                emailBody += ` Present Today: ${analytics.todayPresent}\n`;
                emailBody += ` Absent Today: ${analytics.todayAbsent}\n`;
                emailBody += ` Today's Rate: ${analytics.todayRate}%\n\n`;
                
                // STUDENT BREAKDOWN
                if (analytics.studentBreakdown.length > 0) {
                    emailBody += ` STUDENT ATTENDANCE BREAKDOWN\n`;
                    emailBody += `${'-'.repeat(35)}\n`;
                    analytics.studentBreakdown.forEach(student => {
                        emailBody += ` ${student.name}: ${student.presentCount}P/${student.absentCount}A (${student.rate}% rate)\n`;
                    });
                    emailBody += `\n`;
                }
                
                // RECENT ACTIVITY
                if (analytics.recentActivity.length > 0) {
                    emailBody += ` RECENT ACTIVITY (Last 5 Records)\n`;
                    emailBody += `${'-'.repeat(35)}\n`;
                    analytics.recentActivity.forEach((record, index) => {
                        emailBody += `${index + 1}. ${record.name} - ${record.status} (${record.time})\n`;
                    });
                    emailBody += `\n`;
                }
                
                // INSIGHTS & RECOMMENDATIONS
                emailBody += ` INSIGHTS & RECOMMENDATIONS\n`;
                emailBody += `${'-'.repeat(35)}\n`;
                analytics.insights.forEach(insight => {
                    emailBody += ` ${insight}\n`;
                });
                emailBody += `\n`;
                
                // FOOTER
                emailBody += `${'-'.repeat(55)}\n`;
                emailBody += ` Access full system: [Your attendance tracker URL]\n`;
                emailBody += ` Support: Contact your system administrator\n`;
                emailBody += ` Generated automatically by Attendance Tracking System\n`;
                
                // Create mailto link
                const mailtoLink = `mailto:${emailAddress}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                
                // Open email client
                window.open(mailtoLink);
                
                showMessage(` Professional analytics report prepared for: ${emailAddress}`, 'success');
                
                // Clear the email field
                elements.reportEmail.value = '';
                
            } catch (error) {
                showMessage(`Error preparing email report: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Analytics generation function
        function generateAttendanceAnalytics() {
            const today = new Date().toDateString();
            const analytics = {
                totalRecords: attendanceData.length,
                totalStudents: 0,
                presentCount: 0,
                absentCount: 0,
                presentPercentage: 0,
                absentPercentage: 0,
                attendanceRate: 0,
                todayRecords: 0,
                todayPresent: 0,
                todayAbsent: 0,
                todayRate: 0,
                dateRange: '',
                lastRecordTime: '',
                studentBreakdown: [],
                recentActivity: [],
                insights: []
            };
            
            if (attendanceData.length === 0) return analytics;
            
            // Calculate basic metrics
            const studentStats = {};
            let earliestDate = null;
            let latestDate = null;
            
            attendanceData.forEach(record => {
                // Get student info
                const studentId = record.student || record.studentId || 'Unknown';
                const studentInfo = activeStudents[studentId];
                const studentName = studentInfo ? 
                    (studentInfo.name || `${studentInfo.firstName} ${studentInfo.lastName}`) : 
                    studentId;
                
                // Initialize student stats
                if (!studentStats[studentId]) {
                    studentStats[studentId] = {
                        name: studentName,
                        presentCount: 0,
                        absentCount: 0,
                        totalCount: 0
                    };
                }
                
                // Count attendance
                const status = record.status || record.attendanceStatus;
                if (status === 'present') {
                    analytics.presentCount++;
                    studentStats[studentId].presentCount++;
                } else {
                    analytics.absentCount++;
                    studentStats[studentId].absentCount++;
                }
                studentStats[studentId].totalCount++;
                
                // Today's stats
                const recordDate = new Date(record.date).toDateString();
                if (recordDate === today) {
                    analytics.todayRecords++;
                    if (status === 'present') {
                        analytics.todayPresent++;
                    } else {
                        analytics.todayAbsent++;
                    }
                }
                
                // Date range
                const recordDateObj = new Date(record.date);
                if (!earliestDate || recordDateObj < earliestDate) earliestDate = recordDateObj;
                if (!latestDate || recordDateObj > latestDate) latestDate = recordDateObj;
            });
            
            // Calculate percentages
            analytics.totalStudents = Object.keys(studentStats).length;
            analytics.presentPercentage = Math.round((analytics.presentCount / analytics.totalRecords) * 100) || 0;
            analytics.absentPercentage = Math.round((analytics.absentCount / analytics.totalRecords) * 100) || 0;
            analytics.attendanceRate = analytics.presentPercentage;
            analytics.todayRate = analytics.todayRecords > 0 ? 
                Math.round((analytics.todayPresent / analytics.todayRecords) * 100) : 0;
            
            // Date range
            if (earliestDate && latestDate) {
                analytics.dateRange = earliestDate.toDateString() === latestDate.toDateString() ? 
                    earliestDate.toLocaleDateString() : 
                    `${earliestDate.toLocaleDateString()} - ${latestDate.toLocaleDateString()}`;
            }
            
            // Last record time
            if (attendanceData.length > 0) {
                const lastRecord = attendanceData[0]; // Most recent (array is newest first)
                analytics.lastRecordTime = `${lastRecord.date} at ${lastRecord.time}`;
            }
            
            // Student breakdown
            analytics.studentBreakdown = Object.values(studentStats).map(student => ({
                ...student,
                rate: student.totalCount > 0 ? Math.round((student.presentCount / student.totalCount) * 100) : 0
            })).sort((a, b) => b.rate - a.rate);
            
            // Recent activity (last 5 records)
            analytics.recentActivity = attendanceData.slice(0, 5).map(record => {
                const studentId = record.student || record.studentId || 'Unknown';
                const studentInfo = activeStudents[studentId];
                const studentName = studentInfo ? 
                    (studentInfo.name || `${studentInfo.firstName} ${studentInfo.lastName}`) : 
                    studentId;
                const status = record.status || record.attendanceStatus;
                
                return {
                    name: studentName,
                    status: status === 'present' ? ' Present' : ' Absent',
                    time: `${record.date} ${record.time}`
                };
            });
            
            // Generate insights
            if (analytics.attendanceRate >= 90) {
                analytics.insights.push(' Excellent attendance rate! Keep up the great work.');
            } else if (analytics.attendanceRate >= 75) {
                analytics.insights.push(' Good attendance rate, but room for improvement.');
            } else {
                analytics.insights.push(' Low attendance rate requires attention and intervention.');
            }
            
            if (analytics.todayRecords > 0) {
                if (analytics.todayRate > analytics.attendanceRate) {
                    analytics.insights.push(' Today\'s attendance is above average - positive trend!');
                } else if (analytics.todayRate < analytics.attendanceRate) {
                    analytics.insights.push(' Today\'s attendance is below average - monitor closely.');
                }
            }
            
            if (analytics.totalStudents > 0) {
                const lowAttendanceStudents = analytics.studentBreakdown.filter(s => s.rate < 50).length;
                if (lowAttendanceStudents > 0) {
                    analytics.insights.push(` ${lowAttendanceStudents} student(s) have attendance below 50% - consider intervention.`);
                }
            }
            
            return analytics;
        }

        // Test functions for debugging
        function testEmailForm() {
            console.log(' TESTING EMAIL FORM FUNCTIONALITY...');
            console.log('attendanceData length:', attendanceData.length);
            console.log('activeStudents count:', Object.keys(activeStudents).length);
            
            if (attendanceData.length === 0) {
                // Add comprehensive test data
                const testStudents = ['STU001', 'STU002', 'STU003', 'STU004', 'STU005'];
                const statuses = ['present', 'absent'];
                
                testStudents.forEach((studentId, index) => {
                    // Add student to activeStudents if not exists
                    if (!activeStudents[studentId]) {
                        activeStudents[studentId] = {
                            firstName: `Test Student ${index + 1}`,
                            lastName: `LastName${index + 1}`,
                            id: studentId
                        };
                    }
                    
                    // Add multiple attendance records per student
                    for (let i = 0; i < 5; i++) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const status = i < 2 ? 'present' : (Math.random() > 0.7 ? 'absent' : 'present');
                        
                        attendanceData.push({
                            student: studentId,
                            status: status,
                            date: date.toLocaleDateString(),
                            time: `${8 + i}:00 AM`,
                            latitude: '25.316557',
                            longitude: '55.374643',
                            address: `Test Location ${index + 1}`
                        });
                    }
                });
                
                console.log(' Added comprehensive test data');
                console.log('Total records:', attendanceData.length);
                console.log('Students:', Object.keys(activeStudents));
            }
            
            // Test analytics generation
            const analytics = generateAdvancedAnalytics('weekly');
            console.log(' Generated analytics:', analytics);
            
            // Test checkbox functionality
            const checkboxes = getSelectedCheckboxes();
            console.log(' Default checkboxes:', checkboxes);
            
            // Test report content generation
            const reportContent = generateReportContent(analytics, 'weekly');
            console.log(' Generated report content length:', reportContent.length);
            console.log(' Report preview (first 500 chars):', reportContent.substring(0, 500));
            
            // Open the email form
            openEmailForm();
            
            console.log(' Email form test complete - check the modal!');
        }
        
        function testCompleteEmailWorkflow() {
            console.log(' TESTING COMPLETE EMAIL WORKFLOW...');
            
            // First ensure we have test data
            testEmailForm();
            
            // Wait a moment for the modal to open, then simulate form filling
            setTimeout(() => {
                try {
                    // Fill out the form with test data
                    const recipientEmail = document.getElementById('recipientEmail');
                    const recipientName = document.getElementById('recipientName');
                    const reportTypeSelect = document.getElementById('reportType');
                    
                    if (recipientEmail) recipientEmail.value = 'test@example.com';
                    if (recipientName) recipientName.value = 'Test Manager';
                    if (reportTypeSelect) reportTypeSelect.value = 'weekly';
                    
                    // Check all content options
                    const checkboxes = [
                        'includeSummary', 'includeStatistics', 'includeAbsentees',
                        'includePerfectAttendance', 'includeTrends', 'includeAlerts',
                        'includeCharts', 'includeDetails'
                    ];
                    
                    checkboxes.forEach(checkboxId => {
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) {
                            checkbox.checked = true;
                            console.log(` Checked ${checkboxId}`);
                        }
                    });
                    
                    console.log(' Form filled with test data - now test the Generate Email button!');
                    console.log(' Click "Generate Email" to see the full customized report.');
                    
                } catch (error) {
                    console.error(' Error in test workflow:', error);
                }
            }, 1000);
        }
        
        function testClearData() {
            console.log('Testing clear data...');
            clearAllData();
        }

        // Simple Email Functions
        function openEmailForm() {
            console.log('Opening simple email form...');
            
            if (elements.emailFormModal) {
                elements.emailFormModal.style.display = 'flex';
                elements.emailFormModal.style.alignItems = 'center';
                elements.emailFormModal.style.justifyContent = 'center';
                elements.emailFormModal.style.position = 'fixed';
                elements.emailFormModal.style.top = '0';
                elements.emailFormModal.style.left = '0';
                elements.emailFormModal.style.width = '100%';
                elements.emailFormModal.style.height = '100%';
                elements.emailFormModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                elements.emailFormModal.style.zIndex = '1000';
            }
        }

        function closeEmailForm() {
            if (elements.emailFormModal) {
                elements.emailFormModal.style.display = 'none';
            }
        }
        
        function sendSimpleEmail() {
            const recipientEmail = document.getElementById('recipientEmail').value;
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            
            if (!recipientEmail) {
                alert('Please enter an email address.');
                return;
            }
            
            // Get ALL records instead of just today's records
            let recordsToInclude = attendanceData.slice(); // Copy all records
            
            // Sort records by date and time (newest first)
            recordsToInclude.sort((a, b) => {
                const dateA = new Date(a.dateTime || `${a.date} ${a.time}`);
                const dateB = new Date(b.dateTime || `${b.date} ${b.time}`);
                return dateB - dateA; // Newest first
            });
            
            // Calculate analytics for beautiful insights
            const analytics = calculateEmailAnalytics(recordsToInclude);
            
            // Create beautiful email content
            let emailContent = `
 ATTENDANCE ANALYSIS REPORT


 Report Period: ${analytics.dateRange}
 Total Records: ${recordsToInclude.length}
 Active Students: ${Object.keys(activeStudents).length}
 Overall Attendance Rate: ${analytics.attendanceRate}%

${analytics.quickInsights}

`;

            // Show records based on selection with beautiful formatting
            if (reportType === 'present') {
                emailContent += generatePresentStudentsReport(recordsToInclude, analytics);
            }
            else if (reportType === 'absent') {
                emailContent += generateAbsentStudentsReport(recordsToInclude, analytics);
            }
            else { // both
                emailContent += generateCompleteAttendanceReport(recordsToInclude, analytics);
            }

            emailContent += `

 Generated: ${new Date().toLocaleString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}
 System: Attendance Tracker v3.0
`;
            
            // Open email with beautiful subject
            const subject = ` Attendance Report (${analytics.periodSummary}) - ${analytics.attendanceRate}% Rate`;
            const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailContent)}`;
            window.location.href = mailtoLink;
            
            alert(` Beautiful email report ready!\n ${recordsToInclude.length} records analyzed\n ${analytics.attendanceRate}% attendance rate`);
            closeEmailForm();
        }
        
        // Helper function to calculate email analytics
        function calculateEmailAnalytics(records) {
            if (records.length === 0) {
                return {
                    attendanceRate: 0,
                    dateRange: 'No records',
                    periodSummary: 'Empty',
                    quickInsights: ' No attendance data available.'
                };
            }
            
            const presentCount = records.filter(r => {
                const status = (r.attendanceStatus || r.attendanceLabel || '').toString().toLowerCase();
                return status.includes('present') || status === 'p' || status === '1';
            }).length;
            
            const absentCount = records.filter(r => {
                const status = (r.attendanceStatus || r.attendanceLabel || '').toString().toLowerCase();
                return status.includes('absent') || status === 'a' || status === '0';
            }).length;
            
            const attendanceRate = records.length > 0 ? Math.round((presentCount / records.length) * 100) : 0;
            
            // Get date range
            const dates = records.map(r => new Date(r.dateTime || `${r.date} ${r.time}`));
            const oldestDate = new Date(Math.min(...dates));
            const newestDate = new Date(Math.max(...dates));
            
            const dateRange = oldestDate.toDateString() === newestDate.toDateString() 
                ? oldestDate.toLocaleDateString('en-US')
                : `${oldestDate.toLocaleDateString('en-US')}  ${newestDate.toLocaleDateString('en-US')}`;
            
            const daysDifference = Math.ceil((newestDate - oldestDate) / (1000 * 60 * 60 * 24)) + 1;
            const periodSummary = daysDifference === 1 ? 'Today' : `${daysDifference} Days`;
            
            // Generate insights
            let insights = '';
            if (attendanceRate >= 90) {
                insights = ' EXCELLENT: Outstanding attendance performance!';
            } else if (attendanceRate >= 75) {
                insights = ' GOOD: Solid attendance with room for improvement.';
            } else if (attendanceRate >= 50) {
                insights = '  NEEDS ATTENTION: Below average attendance detected.';
            } else {
                insights = ' CRITICAL: Poor attendance requires immediate action.';
            }
            
            const quickInsights = `
 QUICK INSIGHTS:
${insights}
 Present: ${presentCount} records (${attendanceRate}%)
 Absent: ${absentCount} records (${100-attendanceRate}%)
 Tracking Period: ${daysDifference} day(s)
`;
            
            return {
                attendanceRate,
                dateRange,
                periodSummary,
                quickInsights,
                presentCount,
                absentCount
            };
        }
        
        // Helper function for present students report
        function generatePresentStudentsReport(records, analytics) {
            let content = `
 PRESENT STUDENTS REPORT


 SUCCESS RATE: ${analytics.presentCount}/${records.length} (${analytics.attendanceRate}%)

`;
            
            let count = 0;
            let currentDate = '';
            
            records.forEach(record => {
                const status = (record.attendanceStatus || record.attendanceLabel || '').toString().toLowerCase();
                if (status.includes('present') || status === 'p' || status === '1') {
                    count++;
                    const student = activeStudents[record.student];
                    const name = student ? student.name : (record.studentName || record.student);
                    
                    // Group by date for better visualization
                    if (currentDate !== record.date) {
                        currentDate = record.date;
                        content += `\n ${currentDate}\n${''.repeat(30)}\n`;
                    }
                    
                    content += `${count.toString().padStart(2, '0')}.  ${name.padEnd(20)}  ${record.time}\n`;
                }
            });
            
            if (count === 0) {
                content += ` No present students found in the selected period.\n`;
            }
            
            return content;
        }
        
        // Helper function for absent students report  
        function generateAbsentStudentsReport(records, analytics) {
            let content = `
 ABSENT STUDENTS REPORT


 ABSENCE RATE: ${analytics.absentCount}/${records.length} (${100-analytics.attendanceRate}%)

`;
            
            let count = 0;
            let currentDate = '';
            
            records.forEach(record => {
                const status = (record.attendanceStatus || record.attendanceLabel || '').toString().toLowerCase();
                if (status.includes('absent') || status === 'a' || status === '0') {
                    count++;
                    const student = activeStudents[record.student];
                    const name = student ? student.name : (record.studentName || record.student);
                    
                    // Group by date for better visualization
                    if (currentDate !== record.date) {
                        currentDate = record.date;
                        content += `\n ${currentDate}\n${''.repeat(30)}\n`;
                    }
                    
                    content += `${count.toString().padStart(2, '0')}.  ${name.padEnd(20)}  ${record.time}\n`;
                }
            });
            
            if (count === 0) {
                content += ` No absent students found - Perfect attendance!\n`;
            }
            
            return content;
        }
        
        // Helper function for complete attendance report
        function generateCompleteAttendanceReport(records, analytics) {
            let content = `
 COMPLETE ATTENDANCE OVERVIEW


 PERFORMANCE BREAKDOWN:
 Present: ${analytics.presentCount} (${analytics.attendanceRate}%)
 Absent:  ${analytics.absentCount} (${100-analytics.attendanceRate}%)

 DETAILED RECORDS:
`;
            
            let currentDate = '';
            
            records.forEach((record, index) => {
                const student = activeStudents[record.student];
                const name = student ? student.name : (record.studentName || record.student);
                const status = record.attendanceStatus || record.attendanceLabel || 'Unknown';
                const statusIcon = status.toLowerCase().includes('present') ? '' : '';
                
                // Group by date for better visualization
                if (currentDate !== record.date) {
                    currentDate = record.date;
                    content += `\n ${currentDate}\n${''.repeat(50)}\n`;
                }
                
                content += `${statusIcon} ${name.padEnd(20)}  ${status.padEnd(8)}  ${record.time}\n`;
            });
            
            return content;
        }

        function closeEmailPreview() {
            if (elements.emailPreviewModal) {
                elements.emailPreviewModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function handleReportTypeChange() {
            const reportType = elements.reportType.value;
            const dateRangeSection = elements.dateRangeSection;
            
            if (dateRangeSection) {
                dateRangeSection.style.display = reportType === 'custom' ? 'flex' : 'none';
            }
            
            // Update subject line based on report type
            if (elements.emailSubject) {
                const reportTypes = {
                    'daily': 'Daily Attendance Report - {date}',
                    'weekly': 'Weekly Attendance Summary - {date}',
                    'monthly': 'Monthly Attendance Report - {date}',
                    'custom': 'Custom Attendance Report - {date}',
                    'alerts': 'Attendance Alert Report - {date}',
                    'comprehensive': 'Comprehensive Attendance Analysis - {date}'
                };
                
                elements.emailSubject.value = reportTypes[reportType] || 'Attendance Report - {date}';
            }
        }

        // Test functions for debugging
        function testEmailForm() {
            console.log(' TESTING SIMPLE EMAIL FORM...');
            console.log('attendanceData length:', attendanceData.length);
            console.log('activeStudents count:', Object.keys(activeStudents).length);
            
            // Don't add test data if real data exists
            if (attendanceData.length > 0) {
                console.log(' Using existing real data');
                
                // Debug current data
                const today = new Date();
                const todayFormatted = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
                const todayRecords = attendanceData.filter(record => record.date === todayFormatted);
                const presentToday = todayRecords.filter(r => r.status === 'present');
                const absentToday = todayRecords.filter(r => r.status === 'absent');
                
                console.log(' Current data summary:');
                console.log('- Total records:', attendanceData.length);
                console.log('- Today records:', todayRecords.length);
                console.log('- Present today:', presentToday.length);
                console.log('- Absent today:', absentToday.length);
                console.log('- Date being used:', todayFormatted);
                console.log('- Sample dates in data:', attendanceData.slice(0, 5).map(r => r.date));
                
                openEmailForm();
                return;
            }
            
            // Only add test data if no real data exists
            if (attendanceData.length === 0) {
                // Add simple test data
                const today = new Date();
                const todayFormatted = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
                console.log('Creating test data for date:', todayFormatted);
                
                // Add some test students
                activeStudents['STU001'] = { firstName: 'John', lastName: 'Doe', id: 'STU001' };
                activeStudents['STU002'] = { firstName: 'Jane', lastName: 'Smith', id: 'STU002' };
                activeStudents['STU003'] = { firstName: 'Mike', lastName: 'Johnson', id: 'STU003' };
                activeStudents['STU004'] = { firstName: 'Sarah', lastName: 'Wilson', id: 'STU004' };
                activeStudents['STU005'] = { firstName: 'Tom', lastName: 'Brown', id: 'STU005' };
                
                // Add attendance records for today - Mix of present and absent
                attendanceData.push(
                    { student: 'STU001', status: 'present', date: todayFormatted, time: '8:00 AM', latitude: '25.316557', longitude: '55.374643', address: 'School Location' },
                    { student: 'STU002', status: 'absent', date: todayFormatted, time: '8:00 AM', latitude: '', longitude: '', address: '' },
                    { student: 'STU003', status: 'present', date: todayFormatted, time: '8:15 AM', latitude: '25.316557', longitude: '55.374643', address: 'School Location' },
                    { student: 'STU004', status: 'absent', date: todayFormatted, time: '8:00 AM', latitude: '', longitude: '', address: '' },
                    { student: 'STU005', status: 'present', date: todayFormatted, time: '8:10 AM', latitude: '25.316557', longitude: '55.374643', address: 'School Location' }
                );
                
                console.log(' Added test data for today:', todayFormatted);
                console.log('Total records:', attendanceData.length);
                console.log('Sample record:', attendanceData[0]);
                updateDisplay();
            }
            
            openEmailForm();
        }
        
        // Quick test function to debug your real data
        function debugRealData() {
            console.log(' DEBUGGING REAL DATA...');
            console.log('Total attendance records:', attendanceData.length);
            
            if (attendanceData.length > 0) {
                console.log('First 10 records with exact status values:');
                attendanceData.slice(0, 10).forEach((record, index) => {
                    console.log(`${index + 1}. Student: ${record.student}, Status: "${record.status}" (type: ${typeof record.status}), Date: "${record.date}", Time: ${record.time}`);
                });
                
                // Check today's records
                const today = new Date();
                const todayFormatted = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
                const todayRecords = attendanceData.filter(record => record.date === todayFormatted);
                
                console.log(`\nToday's date: "${todayFormatted}"`);
                console.log(`Today's records: ${todayRecords.length}`);
                
                if (todayRecords.length > 0) {
                    console.log('Today\'s records with exact status values:');
                    todayRecords.forEach((record, index) => {
                        const student = activeStudents[record.student];
                        const name = student ? `${student.firstName} ${student.lastName}` : 'Unknown';
                        console.log(`${index + 1}. ${name} (${record.student}) - Status: "${record.status}" (${typeof record.status}) - Time: ${record.time}`);
                    });
                    
                    // Show all unique status values
                    const statusValues = todayRecords.map(r => r.status);
                    const uniqueStatuses = [...new Set(statusValues)];
                    console.log('\nUnique status values found today:', uniqueStatuses);
                    console.log('Status value details:', uniqueStatuses.map(s => `"${s}" (type: ${typeof s}, length: ${s ? s.length : 'null'})`));
                }
            } else {
                console.log('No attendance data found!');
            }
        }
        
        function generateAdvancedAnalytics(reportType) {
            const today = new Date().toDateString();
            const analytics = {
                totalRecords: attendanceData.length,
                totalStudents: Object.keys(activeStudents).length,
                presentCount: attendanceData.filter(r => r.status === 'present').length,
                absentCount: attendanceData.filter(r => r.status === 'absent').length,
                todayRecords: attendanceData.filter(r => new Date(r.date).toDateString() === today).length,
                todayPresent: attendanceData.filter(r => new Date(r.date).toDateString() === today && r.status === 'present').length,
                todayAbsent: attendanceData.filter(r => new Date(r.date).toDateString() === today && r.status === 'absent').length,
                dateRange: getDateRange(reportType),
                absentStudents: [],
                perfectAttendance: [],
                consecutiveAbsences: 0,
                weeklyAverage: 85,
                monthlyAverage: 82,
                previousRate: 78,
                peakDay: 'Monday'
            };
            
            // Calculate percentages
            analytics.attendanceRate = analytics.totalRecords > 0 ? 
                Math.round((analytics.presentCount / analytics.totalRecords) * 100) : 0;
            analytics.absentPercentage = 100 - analytics.attendanceRate;
            
            analytics.todayPresentRate = analytics.todayRecords > 0 ? 
                Math.round((analytics.todayPresent / analytics.todayRecords) * 100) : 0;
            analytics.todayAbsentRate = 100 - analytics.todayPresentRate;
            
            // Generate absentee analysis
            const studentAbsenceAnalysis = {};
            Object.keys(activeStudents).forEach(studentId => {
                const studentRecords = attendanceData.filter(r => r.student === studentId);
                const absentRecords = studentRecords.filter(r => r.status === 'absent');
                const presentRecords = studentRecords.filter(r => r.status === 'present');
                
                if (studentRecords.length > 0) {
                    const absenceRate = Math.round((absentRecords.length / studentRecords.length) * 100);
                    const lastPresent = presentRecords.length > 0 ? 
                        presentRecords[presentRecords.length - 1].date : 'Never';
                    
                    // Calculate consecutive absences (simplified)
                    let consecutiveAbsences = 0;
                    const recentRecords = studentRecords.slice(-5); // Last 5 records
                    for (let i = recentRecords.length - 1; i >= 0; i--) {
                        if (recentRecords[i].status === 'absent') {
                            consecutiveAbsences++;
                        } else {
                            break;
                        }
                    }
                    
                    studentAbsenceAnalysis[studentId] = {
                        name: `${activeStudents[studentId].firstName} ${activeStudents[studentId].lastName}`,
                        id: studentId,
                        absenceRate: absenceRate,
                        lastSeen: lastPresent,
                        consecutiveAbsences: consecutiveAbsences,
                        totalAbsences: absentRecords.length,
                        attendanceRate: 100 - absenceRate
                    };
                }
            });
            
            // Identify students requiring attention (high absence rates or consecutive absences)
            analytics.absentStudents = Object.values(studentAbsenceAnalysis)
                .filter(student => student.absenceRate > 25 || student.consecutiveAbsences >= 2)
                .sort((a, b) => b.absenceRate - a.absenceRate)
                .slice(0, 10); // Top 10 concerning students
            
            // Identify perfect/excellent attendance students
            analytics.perfectAttendance = Object.values(studentAbsenceAnalysis)
                .filter(student => student.attendanceRate >= 95 && student.totalAbsences <= 1)
                .sort((a, b) => b.attendanceRate - a.attendanceRate)
                .slice(0, 15) // Top 15 excellent students
                .map(student => ({
                    name: student.name,
                    id: student.id,
                    days: attendanceData.filter(r => r.student === student.id && r.status === 'present').length,
                    rate: student.attendanceRate
                }));
            
            return analytics;
        }

        function getDateRange(reportType) {
            const today = new Date();
            
            switch (reportType) {
                case 'daily':
                    return today.toLocaleDateString();
                case 'weekly':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    return `${weekStart.toLocaleDateString()} - ${today.toLocaleDateString()}`;
                case 'monthly':
                    return today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                case 'custom':
                    const startDate = elements.startDate?.value;
                    const endDate = elements.endDate?.value;
                    if (startDate && endDate) {
                        return `${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`;
                    }
                    return 'Custom Range';
                default:
                    return 'All Available Data';
            }
        }

        function getReportTypeIntro(reportType) {
            const intros = {
                'daily': 'Please find below the daily attendance summary for today:\n\n',
                'weekly': 'Please find below the weekly attendance summary:\n\n',
                'monthly': 'Please find below the monthly attendance performance report:\n\n',
                'custom': 'Please find below the custom attendance report for the selected period:\n\n',
                'alerts': 'This report highlights attendance concerns that require your attention:\n\n',
                'comprehensive': 'Please find below the comprehensive attendance analysis with detailed insights:\n\n'
            };
            
            return intros[reportType] || 'Please find below the attendance report:\n\n';
        }

        function generateReportContent(analytics, reportType) {
            const checkboxes = getSelectedCheckboxes();
            console.log('Selected checkboxes:', checkboxes);
            let content = '';
            
            // Executive Summary
            if (checkboxes.includeSummary) {
                content += ` EXECUTIVE SUMMARY\n`;
                content += `${'='.repeat(50)}\n`;
                content += ` Overall Attendance Rate: ${analytics.attendanceRate}%\n`;
                content += ` Total Active Students: ${analytics.totalStudents}\n`;
                content += ` Records Analyzed: ${analytics.totalRecords}\n`;
                content += ` Report Period: ${analytics.dateRange}\n`;
                
                if (analytics.attendanceRate >= 90) {
                    content += ` Status:  EXCELLENT attendance performance\n`;
                } else if (analytics.attendanceRate >= 75) {
                    content += ` Status:  GOOD attendance with room for improvement\n`;
                } else {
                    content += ` Status:  ATTENTION REQUIRED - Low attendance\n`;
                }
                content += `\n`;
            }
            
            // Key Statistics
            if (checkboxes.includeStatistics) {
                content += ` KEY PERFORMANCE INDICATORS\n`;
                content += `${'='.repeat(50)}\n`;
                content += `Present Today: ${analytics.todayPresent} students (${analytics.todayPresentRate}%)\n`;
                content += `Absent Today: ${analytics.todayAbsent} students (${analytics.todayAbsentRate}%)\n`;
                content += `Overall Present: ${analytics.presentCount} records\n`;
                content += `Overall Absent: ${analytics.absentCount} records\n`;
                content += `Peak Attendance Day: ${analytics.peakDay || 'Monday'}\n`;
                content += `Weekly Average: ${analytics.weeklyAverage || 85}%\n`;
                content += `Monthly Average: ${analytics.monthlyAverage || 82}%\n`;
                content += `\n`;
            }
            
            // Absentee List
            if (checkboxes.includeAbsentees) {
                content += ` STUDENTS REQUIRING ATTENTION\n`;
                content += `${'='.repeat(50)}\n`;
                
                if (analytics.absentStudents && analytics.absentStudents.length > 0) {
                    analytics.absentStudents.forEach((student, index) => {
                        content += `${index + 1}. ${student.name} (${student.id})\n`;
                        content += `   Last Seen: ${student.lastSeen}\n`;
                        content += `   Absence Rate: ${student.absenceRate}%\n`;
                        content += `   Status: ${student.consecutiveAbsences >= 3 ? ' HIGH RISK' : ' Monitor'}\n\n`;
                    });
                } else {
                    content += ` No students requiring immediate attention.\n`;
                    content += `All students maintain acceptable attendance rates.\n\n`;
                }
            }
            
            // Perfect Attendance
            if (checkboxes.includePerfectAttendance) {
                content += ` PERFECT ATTENDANCE RECOGNITION\n`;
                content += `${'='.repeat(50)}\n`;
                
                if (analytics.perfectAttendance && analytics.perfectAttendance.length > 0) {
                    analytics.perfectAttendance.forEach((student, index) => {
                        content += `${index + 1}. ${student.name} (${student.id}) - ${student.days} days perfect attendance\n`;
                    });
                } else {
                    // Generate based on actual data
                    const excellentStudents = [];
                    Object.keys(activeStudents).forEach(studentId => {
                        const studentRecords = attendanceData.filter(r => r.student === studentId);
                        const presentCount = studentRecords.filter(r => r.status === 'present').length;
                        const rate = studentRecords.length > 0 ? (presentCount / studentRecords.length) * 100 : 0;
                        
                        if (rate >= 95 && studentRecords.length >= 3) {
                            const student = activeStudents[studentId];
                            excellentStudents.push({
                                name: `${student.firstName} ${student.lastName}`,
                                id: studentId,
                                rate: Math.round(rate),
                                days: studentRecords.length
                            });
                        }
                    });
                    
                    if (excellentStudents.length > 0) {
                        excellentStudents.forEach((student, index) => {
                            content += `${index + 1}. ${student.name} (${student.id}) - ${student.rate}% attendance (${student.days} records)\n`;
                        });
                    } else {
                        content += `No students currently qualify for perfect attendance recognition.\n`;
                        content += `Encourage students to maintain consistent attendance.\n`;
                    }
                }
                content += `\n`;
            }
            
            // Attendance Trends
            if (checkboxes.includeTrends) {
                content += ` ATTENDANCE TRENDS & ANALYSIS\n`;
                content += `${'='.repeat(50)}\n`;
                
                const currentRate = analytics.attendanceRate;
                const previousRate = analytics.previousRate || 78;
                
                if (currentRate > previousRate) {
                    content += ` Trend: IMPROVING (+${(currentRate - previousRate).toFixed(1)}%)\n`;
                    content += `   Positive momentum - maintain current strategies\n`;
                } else if (currentRate < previousRate) {
                    content += ` Trend: DECLINING (${(currentRate - previousRate).toFixed(1)}%)\n`;
                    content += `   Requires attention - consider intervention strategies\n`;
                } else {
                    content += ` Trend: STABLE (no significant change)\n`;
                    content += `   Consistent performance - monitor for improvements\n`;
                }
                
                content += `Daily Average: ${currentRate}%\n`;
                content += `Weekly Target: 85%\n`;
                content += `Monthly Goal: 90%\n`;
                content += `Best Day: Monday (estimated)\n`;
                content += `Improvement Areas: ${currentRate < 80 ? 'Overall attendance' : 'Consistency'}\n`;
                content += `\n`;
            }
            
            // Alert Recommendations
            if (checkboxes.includeAlerts) {
                content += ` ALERTS & ACTIONABLE RECOMMENDATIONS\n`;
                content += `${'='.repeat(50)}\n`;
                
                let alertCount = 0;
                
                if (analytics.attendanceRate < 75) {
                    alertCount++;
                    content += ` CRITICAL ALERT: Overall attendance below 75%\n`;
                    content += `    Immediate Action: Schedule management review meeting\n`;
                    content += `    Contact parents/guardians of frequent absentees\n`;
                    content += `    Review attendance policies and incentives\n\n`;
                }
                
                if (analytics.todayAbsent > analytics.todayPresent) {
                    alertCount++;
                    content += ` TODAY'S ALERT: More absences than attendance today\n`;
                    content += `    Follow up with absent students\n`;
                    content += `    Check for external factors (weather, events, etc.)\n\n`;
                }
                
                const consecutiveAbsents = analytics.absentStudents ? analytics.absentStudents.filter(s => s.consecutiveAbsences >= 3).length : 0;
                if (consecutiveAbsents > 0) {
                    alertCount++;
                    content += ` FOLLOW-UP REQUIRED: ${consecutiveAbsents} students with 3+ consecutive absences\n`;
                    content += `    Personal contact recommended\n`;
                    content += `    Documentation required\n\n`;
                }
                
                if (alertCount === 0) {
                    content += ` NO CRITICAL ALERTS\n`;
                    content += `Current attendance levels are within acceptable parameters.\n`;
                    content += `Continue monitoring and maintain current strategies.\n`;
                }
                content += `\n`;
            }
            
            // Visual Charts (Text-based)
            if (checkboxes.includeCharts) {
                content += ` VISUAL ATTENDANCE ANALYSIS\n`;
                content += `${'='.repeat(50)}\n`;
                
                // Attendance Rate Bar Chart
                const presentBars = Math.round(analytics.attendanceRate / 5);
                const absentBars = 20 - presentBars;
                content += `ATTENDANCE RATE VISUALIZATION:\n`;
                content += `Present : ${''.repeat(presentBars)}${''.repeat(absentBars)} ${analytics.attendanceRate}%\n`;
                content += `Absent  : ${''.repeat(Math.round(analytics.absentPercentage / 5))}${''.repeat(20 - Math.round(analytics.absentPercentage / 5))} ${analytics.absentPercentage}%\n`;
                content += `          ${'-'.repeat(20)}\n`;
                content += `          0%    25%    50%    75%   100%\n\n`;
                
                // Weekly Trend (simulated)
                content += `WEEKLY TREND (Last 7 Days):\n`;
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const rates = [88, 92, 85, 90, 87, 75, 80]; // Sample data
                days.forEach((day, index) => {
                    const bars = Math.round(rates[index] / 10);
                    content += `${day}: ${''.repeat(bars)}${''.repeat(10 - bars)} ${rates[index]}%\n`;
                });
                content += `\n`;
            }
            
            // Detailed Records
            if (checkboxes.includeDetails) {
                content += ` DETAILED ATTENDANCE RECORDS\n`;
                content += `${'='.repeat(50)}\n`;
                content += `Date       | Student ID | Name                | Status  | Time     | Location\n`;
                content += `${'-'.repeat(85)}\n`;
                
                const recordsToShow = Math.min(attendanceData.length, 25);
                attendanceData.slice(0, recordsToShow).forEach(record => {
                    const studentInfo = activeStudents[record.student] || {};
                    const name = `${studentInfo.firstName || ''} ${studentInfo.lastName || ''}`.trim() || record.student;
                    const status = record.status === 'present' ? 'Present' : 'Absent ';
                    const location = record.address ? record.address.substring(0, 20) : 'N/A';
                    
                    content += `${record.date.padEnd(10)} | ${record.student.padEnd(10)} | ${name.padEnd(19)} | ${status} | ${record.time.padEnd(8)} | ${location}\n`;
                });
                
                if (attendanceData.length > 25) {
                    content += `... and ${attendanceData.length - 25} more records (showing most recent 25)\n`;
                }
                
                if (attendanceData.length === 0) {
                    content += `No attendance records found.\n`;
                    content += `Please ensure students are marking attendance.\n`;
                }
                content += `\n`;
            }
            
            console.log('Generated content length:', content.length);
            return content;
        }

        function getSelectedCheckboxes() {
            return {
                includeSummary: document.getElementById('includeSummary')?.checked || false,
                includeStatistics: document.getElementById('includeStatistics')?.checked || false,
                includeAbsentees: document.getElementById('includeAbsentees')?.checked || false,
                includePerfectAttendance: document.getElementById('includePerfectAttendance')?.checked || false,
                includeTrends: document.getElementById('includeTrends')?.checked || false,
                includeAlerts: document.getElementById('includeAlerts')?.checked || false,
                includeCharts: document.getElementById('includeCharts')?.checked || false,
                includeDetails: document.getElementById('includeDetails')?.checked || false,
            };
        }

        function getReportFooter(senderName) {
            return `\n${'='.repeat(60)}\n` +
                   ` REPORT DETAILS\n` +
                   `Generated: ${new Date().toLocaleString()}\n` +
                   `System: Professional Attendance Tracking System\n` +
                   `Prepared by: ${senderName}\n` +
                   `Total Records Analyzed: ${attendanceData.length}\n\n` +
                   ` For questions or assistance, please contact the system administrator.\n` +
                   ` This report was generated automatically with real-time data.\n\n` +
                   `Best regards,\n${senderName}\nAttendance Management Team`;
        }

        function clearAllData() {
            if (attendanceData.length === 0) {
                showMessage('No data to clear', 'warning');
                return;
            }
            
            // Create custom confirmation dialog for data clearing
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirmation-overlay';
            confirmDialog.innerHTML = `
                <div class="confirmation-modal">
                    <div class="confirmation-header" style="background: #e74c3c;">
                        <h3><i class="fas fa-exclamation-triangle"></i> Clear All Data</h3>
                    </div>
                    <div class="confirmation-body">
                        <p><strong>Are you sure you want to delete all ${attendanceData.length} attendance records?</strong></p>
                        <p style="color: #e74c3c; margin-top: 15px;"><i class="fas fa-warning"></i> This action cannot be undone!</p>
                    </div>
                    <div class="confirmation-actions">
                        <button class="confirm-btn cancel-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="confirm-btn" style="background: #e74c3c;">
                            <i class="fas fa-trash"></i> Yes, Delete All
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            const cancelBtn = confirmDialog.querySelector('.cancel-btn');
            const confirmBtn = confirmDialog.querySelector('.confirm-btn:not(.cancel-btn)');
            
            const closeDialog = () => {
                document.body.removeChild(confirmDialog);
            };
            
            cancelBtn.addEventListener('click', closeDialog);
            
            confirmBtn.addEventListener('click', () => {
                closeDialog();
                clearAllData();
            });
            
            confirmDialog.addEventListener('click', (e) => {
                if (e.target === confirmDialog) {
                    closeDialog();
                }
            });
            
            setTimeout(() => confirmBtn.focus(), 100);
        }
        
        // Local Storage Data Management Functions
        function loadDataFromStorage() {
            try {
                const saved = localStorage.getItem('attendanceData');
                if (saved) {
                    attendanceData = JSON.parse(saved);
                    displayRecords();
                    updateStatistics();
                    populateFilterDropdowns();
                    showMessage(' Data loaded from local storage', 'info');
                } else {
                    showMessage(' Ready to start recording attendance!', 'info');
                }
            } catch (error) {
                console.error('Error loading local data:', error);
                showMessage(' Ready to start recording attendance!', 'info');
            }
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                console.log('Data saved to local storage');
            } catch (error) {
                console.error('Error saving to local storage:', error);
                showMessage('Error saving data locally', 'error');
            }
        }

        function deleteRecordFromStorage(recordId) {
            try {
                showLoading(true);
                showMessage('Deleting record...', 'info');
                
                // Remove from local array
                attendanceData = attendanceData.filter(r => r.id !== recordId);
                
                // Save updated array to localStorage
                saveDataToStorage();
                
                // Update displays
                displayRecords();
                updateStatistics();
                
                showMessage('Record deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting record: ', error);
                showMessage('Error deleting record: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function clearAllData() {
            try {
                showLoading(true);
                showMessage('Clearing all data...', 'info');
                
                // Clear local data
                attendanceData = [];
                localStorage.removeItem('attendanceData');
                
                // Update displays
                displayRecords();
                updateStatistics();
                populateFilterDropdowns();
                
                showMessage('All data cleared successfully', 'success');
            } catch (error) {
                console.error('Error clearing data: ', error);
                showMessage('Error clearing data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.setAttribute('role', 'alert');
            messageEl.setAttribute('aria-live', 'polite');
            
            const icon = getMessageIcon(type);
            messageEl.innerHTML = `
                <i class="${icon}" aria-hidden="true"></i>
                <span>${message}</span>
                <button class="message-close" aria-label="Close message" onclick="this.parentElement.remove()">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            `;
            
            elements.messageContainer.appendChild(messageEl);
            
            // Remove message after 5 seconds (except errors which stay longer)
            const timeout = type === 'error' ? 10000 : 5000;
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.style.opacity = '0';
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.parentNode.removeChild(messageEl);
                        }
                    }, 300);
                }
            }, timeout);
            
            // Remove on click
            messageEl.addEventListener('click', (e) => {
                if (!e.target.closest('.message-close')) {
                    messageEl.remove();
                }
            });
        }

        function getMessageIcon(type) {
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            return icons[type] || icons.info;
        }

        function toggleLocationSettings() {
            const content = document.getElementById('locationSettingsContent');
            const toggleBtn = document.querySelector('#toggleLocationSettings i');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleBtn.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                toggleBtn.className = 'fas fa-chevron-down';
            }
        }

        function enableLocationAccess() {
            updateLocationStatus(' Requesting location permission...', 'info');
            showMessage('Please allow location access when prompted by your browser', 'info');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('Location permission granted:', position);
                    handleLocationSuccess(position);
                    showMessage('Location access enabled successfully!', 'success');
                    
                    // Hide the enable button since permission is now granted
                    const enableBtn = document.getElementById('enableLocationBtn');
                    if (enableBtn) {
                        enableBtn.style.display = 'none';
                    }
                    
                    // Start continuous tracking
                    const continuousToggle = document.getElementById('continuousTrackingToggle');
                    if (!continuousToggle || continuousToggle.checked) {
                        startWatchingPosition();
                    }
                },
                (error) => {
                    console.error('Location permission error:', error);
                    let errorMessage = 'Unable to access location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Permission denied. Please enable location in browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                        default:
                            errorMessage += 'Unknown error occurred.';
                            break;
                    }
                    updateLocationStatus(errorMessage, 'error');
                    showMessage(errorMessage, 'error');
                },
                options
            );
        }

        function showLoading(show) {
            elements.loadingOverlay.style.display = show ? 'flex' : 'none';
            
            // Disable/enable the attendance buttons during processing
            if (elements.presentBtn) {
                elements.presentBtn.disabled = show;
            }
            if (elements.absentBtn) {
                elements.absentBtn.disabled = show;
            }
        }

        // Collapsible Section Functionality
        function toggleSection(contentId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(contentId + '-icon');
            
            if (content.classList.contains('collapsed')) {
                // Expand
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                icon.classList.add('rotated');
            } else {
                // Collapse
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                icon.classList.remove('rotated');
            }
        }

        // Initialize collapsible sections on page load
        function initializeCollapsibleSections() {
            // Set all sections to collapsed by default except Record Attendance
            const collapsibleSections = [
                'actions-content',
                'location-content', 
                'location-controls-content'
            ];
            
            collapsibleSections.forEach(sectionId => {
                const content = document.getElementById(sectionId);
                const icon = document.getElementById(sectionId + '-icon');
                
                if (content && icon) {
                    // All sections start collapsed except Record Attendance
                    content.classList.add('collapsed');
                    icon.classList.remove('rotated');
                }
            });
        }

        // Export functions for global access
        window.deleteRecord = deleteRecord;
        window.removeStudent = removeStudent;
        window.restoreDefaultStudents = restoreDefaultStudents;
        window.closeStudentManagementPanel = closeStudentManagementPanel;
        window.toggleSection = toggleSection;
        window.openEmailForm = openEmailForm;
        window.closeEmailForm = closeEmailForm;
        window.closeEmailPreview = closeEmailPreview;
        window.previewEmailReport = previewEmailReport;
        window.sendFinalEmail = sendFinalEmail;
        window.testEmailForm = testEmailForm;
        window.testClearData = testClearData;
        window.addNewStudent = addNewStudent;
        window.exportFilteredRecordsToPdf = exportFilteredRecordsToPdf;
        
        // Test function for debugging
        window.testAddStudent = function() {
            console.log(' Testing Add Student function...');
            console.log(' Elements:', {
                addStudentBtn: elements.addStudentBtn,
                newStudentId: elements.newStudentId,
                newStudentName: elements.newStudentName
            });
            console.log(' Active Students:', activeStudents);
            addNewStudent();
        };
    </script>
</body>
</html>